# TG-AIæ™ºæ§ç‹ é–‹ç™¼è¦ç¯„

## èªè¨€èˆ‡å›æ‡‰
- å§‹çµ‚ä½¿ç”¨**ç¹é«”ä¸­æ–‡**å›è¦†
- ä»£ç¢¼è¨»é‡‹å¯ç”¨ç°¡é«”ä¸­æ–‡æˆ–è‹±æ–‡

## æŠ€è¡“æ£§
- **å‰ç«¯**: Angular 21 + TypeScript (Standalone Components)
- **å¾Œç«¯**: Python 3.11+ / FastAPI + Pyrogram (Telegram API)
- **æ¡Œé¢**: Electron 28
- **è³‡æ–™åº«**: SQLite (ä¸‰æ•¸æ“šåº«æ¶æ§‹)
- **é€šè¨Š**: Electron IPC (stdin/stdout JSON)

---

## ğŸ”´ æ•¸æ“šåº«æ¶æ§‹è¦ç¯„ï¼ˆåš´æ ¼éµå®ˆï¼‰

### ä¸‰æ•¸æ“šåº«è¨­è¨ˆ

| æ•¸æ“šåº« | è·¯å¾‘ | ç”¨é€” | ç®¡ç†æ¨¡å¡Š |
|--------|------|------|----------|
| `tgmatrix.db` | `backend/data/` | å¸³è™Ÿç®¡ç† | `database.py` |
| `tgai_server.db` | `backend/data/` | æ¥­å‹™æ•¸æ“š | `database.py` |
| `search_history.db` | `backend/data/` | æœç´¢æ­·å² | `search_history_service.py` |

### ğŸš« åš´ç¦äº‹é …
1. **ç¦æ­¢åœ¨å…¶ä»–æ–‡ä»¶å‰µå»ºæ•¸æ“šåº«é€£æ¥** - å¿…é ˆé€šéæŒ‡å®šæ¨¡å¡Š
2. **ç¦æ­¢ç¡¬ç·¨ç¢¼æ•¸æ“šåº«è·¯å¾‘** - å¿…é ˆå¾ `config.py` ç²å–
3. **ç¦æ­¢é‡è¤‡å®šç¾©è¡¨çµæ§‹** - è¡¨å®šç¾©å”¯ä¸€ä¾†æºè¦‹ä¸‹æ–¹
4. **ç¦æ­¢è·¨æ•¸æ“šåº«æŸ¥è©¢** - æ¯å€‹è¡¨åªå­˜åœ¨æ–¼ä¸€å€‹æ•¸æ“šåº«

### è¡¨æ­¸å±¬æ˜ å°„ï¼ˆå”¯ä¸€ä¾†æºï¼‰

#### tgmatrix.dbï¼ˆå¸³è™Ÿå°ˆç”¨ï¼‰
| è¡¨å | å®šç¾©ä½ç½® | èªªæ˜ |
|------|----------|------|
| `accounts` | `database.py:_init_db()` | Telegram å¸³è™Ÿ |

#### tgai_server.dbï¼ˆæ¥­å‹™æ•¸æ“šï¼‰
| è¡¨å | å®šç¾©ä½ç½® | èªªæ˜ |
|------|----------|------|
| `monitored_groups` | `database.py:_init_db()` | ç›£æ§ç¾¤çµ„ |
| `keyword_sets` | `database.py:_init_db()` | é—œéµè©é›† |
| `trigger_rules` | `database.py:_init_db()` | è§¸ç™¼è¦å‰‡ |
| `chat_templates` | `database.py:_init_db()` | èŠå¤©æ¨¡æ¿ |
| `extracted_members` | `database.py:_init_db()` | æå–æˆå“¡ |
| `unified_contacts` | `database.py:_init_db()` | çµ±ä¸€è¯ç¹«äºº |
| `message_queue` | `database.py:_init_db()` | æ¶ˆæ¯éšŠåˆ— |
| `chat_history` | `database.py:_init_db()` | èŠå¤©è¨˜éŒ„ |
| `leads` | `database.py:_init_db()` | æ½›åœ¨å®¢æˆ¶ |
| `collected_users` | `database.py:_init_db()` | æ”¶é›†ç”¨æˆ¶ |
| `logs` | `database.py:_init_db()` | ç³»çµ±æ—¥èªŒ |
| `settings` | `database.py:_init_db()` | ç³»çµ±è¨­ç½® |

#### search_history.dbï¼ˆæœç´¢å°ˆç”¨ï¼‰
| è¡¨å | å®šç¾©ä½ç½® | èªªæ˜ |
|------|----------|------|
| `discovered_resources` | `search_history_service.py` | ç™¼ç¾çš„è³‡æº |
| `search_history` | `search_history_service.py` | æœç´¢æ­·å² |
| `search_result_items` | `search_history_service.py` | æœç´¢çµæœ |

### æ•¸æ“šæµå‘åœ–
```
[æœç´¢ç™¼ç¾] â”€â”€â–º search_history.db:discovered_resources
                         â”‚
                    [åŠ å…¥ç¾¤çµ„]
                         â–¼
              tgai_server.db:monitored_groups
                         â”‚
                    [æˆå“¡æå–]
                         â–¼
              tgai_server.db:extracted_members
                         â”‚
                    [åŒæ­¥æ•´åˆ]
                         â–¼
              tgai_server.db:unified_contacts â—„â”€â”€ leads
                         â”‚
                    [æ‰¹é‡ç™¼é€]
                         â–¼
              tgai_server.db:message_queue
                         â”‚
                         â–¼
              tgai_server.db:chat_history
```

### æ•¸æ“šåº«è¨ªå•è¦ç¯„

```python
# âœ… æ­£ç¢ºï¼šé€šé database.py è¨ªå•
from database import db
await db.fetch_all("SELECT * FROM monitored_groups")

# âœ… æ­£ç¢ºï¼šé€šéå°ˆç”¨æœå‹™è¨ªå•
from search_history_service import get_search_history_service
service = get_search_history_service()
resources = service.get_discovered_resources()

# âŒ éŒ¯èª¤ï¼šç›´æ¥å‰µå»ºé€£æ¥
conn = sqlite3.connect("backend/data/tgai_server.db")

# âŒ éŒ¯èª¤ï¼šç¡¬ç·¨ç¢¼è·¯å¾‘
db_path = "D:/tgkz2026/backend/data/tgai_server.db"
```

### è¡¨çµæ§‹ä¿®æ”¹æµç¨‹
1. **åƒ…ä¿®æ”¹** `database.py` çš„ `_init_db()` æˆ– `_migrate_db()`
2. æ·»åŠ æ–°æ¬„ä½ä½¿ç”¨ `ALTER TABLE ADD COLUMN`
3. ä¿®æ”¹å¾Œæ¸¬è©¦ç¾æœ‰æ•¸æ“šé·ç§»
4. æ›´æ–°æœ¬æ–‡æª”çš„è¡¨æ­¸å±¬æ˜ å°„

---

## é—œéµæ–‡ä»¶è¦ç¯„

### ç¦æ­¢éš¨æ„ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | è·è²¬ | ä¿®æ”¹é¢¨éšª |
|------|------|----------|
| `backend/config.py` | æ‰€æœ‰é…ç½®é …ä¾†æº | ğŸ”´ æ¥µé«˜ |
| `backend/database.py` | æ•¸æ“šåº«é€£æ¥å’Œè¡¨å®šç¾© | ğŸ”´ æ¥µé«˜ |
| `backend/search_history_service.py` | æœç´¢æ­·å²æ•¸æ“šåº« | ğŸ”´ æ¥µé«˜ |
| `electron.js` | IPC é€šè¨Šå’Œé€²ç¨‹ç®¡ç† | ğŸ”´ æ¥µé«˜ |

### ä¿®æ”¹é€™äº›æ–‡ä»¶å‰å¿…é ˆ
1. ç†è§£ç¾æœ‰é‚è¼¯
2. ç¢ºèªä¿®æ”¹ä¸æœƒç ´å£ç¾æœ‰åŠŸèƒ½
3. æ¸¬è©¦æ‰€æœ‰ç›¸é—œåŠŸèƒ½
4. åœ¨ commit message ä¸­èªªæ˜åŸå› 

---

## æ ¸å¿ƒè¡¨é—œä¿‚åœ–

```
tgmatrix.db                    tgai_server.db
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  accounts   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ monitored_groups â”‚
â”‚  (3 records)â”‚               â”‚   (é—œè¯å¸³è™Ÿ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ keyword_sets    â”‚
                              â”‚ trigger_rules   â”‚
                              â”‚ chat_templates  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚extracted_membersâ”‚
                              â”‚   (14 records)  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚unified_contacts â”‚
                              â”‚(åŒæ­¥æ•´åˆè¦–åœ–)    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

search_history.db
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚discovered_resourcesâ”‚
â”‚   (367 records)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä»£ç¢¼é¢¨æ ¼
- Python: `snake_case`ï¼Œé¡å `PascalCase`
- TypeScript: `camelCase`ï¼Œé¡å/çµ„ä»¶ `PascalCase`
- è³‡æ–™åº«æ¬„ä½: `snake_case`

## API è¦ç¯„
å¾Œç«¯æ‰€æœ‰éŸ¿æ‡‰å¿…é ˆéµå¾ªçµ±ä¸€æ ¼å¼ï¼š
```python
{"success": True/False, "data": ..., "error": "éŒ¯èª¤è¨Šæ¯"}
```

## è³‡æ–™åº«æ“ä½œæ³¨æ„äº‹é …
- **N+1 å•é¡Œ**: åˆ—è¡¨æŸ¥è©¢å¿…é ˆä½¿ç”¨ JOIN æˆ–æ‰¹é‡ç²å–
- **äº‹å‹™**: å¤šè¡¨æ›´æ–°å¿…é ˆä½¿ç”¨äº‹å‹™åŒ…è£¹
- **ç´¢å¼•**: æ–°å¢æŸ¥è©¢æ¢ä»¶æ¬„ä½æ™‚è€ƒæ…®æ˜¯å¦éœ€è¦ç´¢å¼•
- **åˆ†é **: è¿”å›å¤§é‡æ•¸æ“šæ™‚å¿…é ˆæ”¯æŒ `limit/offset`
- **NOT NULL**: è¬¹æ…ä½¿ç”¨ï¼Œé¿å… INSERT å¤±æ•—
- **è§¸ç™¼å™¨**: ç¦æ­¢å‰µå»ºï¼Œæ›¾å°è‡´åš´é‡å•é¡Œ

## Telegram/Pyrogram ç‰¹åˆ¥æ³¨æ„
- **FloodWait**: æ‰€æœ‰ API èª¿ç”¨å¿…é ˆé€šé `safe_telegram_call()` åŒ…è£¹
- **Session æ–‡ä»¶**: æ“ä½œå‰æª¢æŸ¥é–å®šç‹€æ…‹ï¼Œä½¿ç”¨ `try-finally` é‡‹æ”¾
- **API_ID/API_HASH**: ç¦æ­¢ç¡¬ç·¨ç¢¼ï¼Œå¿…é ˆå¾ config è®€å–
- **å¸³è™Ÿç‹€æ…‹**: æ“ä½œå‰é©—è­‰ `client.is_connected()`

## å‰ç«¯ UI è¦ç¯„
- æ‰€æœ‰æ“ä½œéœ€æä¾› Loading ç‹€æ…‹åé¥‹
- åˆ—è¡¨ç‚ºç©ºæ™‚é¡¯ç¤ºç©ºç‹€æ…‹æç¤º
- éŒ¯èª¤ä½¿ç”¨ Toast é€šçŸ¥ç”¨æˆ¶
- `@for` å¾ªç’°å¿…é ˆä½¿ç”¨å”¯ä¸€çš„ `track` è¡¨é”å¼

## éŒ¯èª¤è™•ç†
- å¾Œç«¯: ä½¿ç”¨ `handle_error()` çµ±ä¸€è™•ç†
- å‰ç«¯: æ•ç²æ‰€æœ‰ API éŒ¯èª¤ï¼Œä¸è®“éŒ¯èª¤éœé»˜å¤±æ•—
- æ—¥èªŒ: é—œéµæ“ä½œè¨˜éŒ„ INFOï¼Œç•°å¸¸è¨˜éŒ„ ERROR + å †æ£§

## å®‰å…¨ç´…ç·š
- ä¸åœ¨å‰ç«¯å­˜å„²æ•æ„Ÿæ†‘è­‰
- æ‰€æœ‰ç”¨æˆ¶è¼¸å…¥å¿…é ˆé©—è­‰
- å¸³è™Ÿæ“ä½œéœ€é©—è­‰ç”¨æˆ¶æ¬Šé™å’Œé…é¡

## å·²çŸ¥å•é¡Œå€åŸŸï¼ˆä¿®æ”¹æ™‚ç‰¹åˆ¥å°å¿ƒï¼‰
- `telegram_client.py`: Session ç®¡ç†ã€é€£ç·šç‹€æ…‹
- `message_queue.py`: ä¸¦ç™¼æ§åˆ¶ã€éšŠåˆ—ç‹€æ…‹
- `search-discovery.component.ts`: è³‡æºåˆ—è¡¨æ¸²æŸ“
- `database.py`: é·ç§»å…¼å®¹æ€§ã€è¡¨å®šç¾©
- `unified_contacts.py`: è·¨è¡¨åŒæ­¥é‚è¼¯

## æ¸¬è©¦å»ºè­°
ä¿®æ”¹åŠŸèƒ½å¾Œï¼Œç°¡è¿°å¦‚ä½•æ‰‹å‹•æ¸¬è©¦ï¼š
1. æ­£å¸¸æµç¨‹
2. é‚Šç•Œæƒ…æ³ï¼ˆç©ºå€¼ã€è¶…é•·æ–‡æœ¬ã€ä¸¦ç™¼ï¼‰
3. éŒ¯èª¤æ¢å¾©ï¼ˆæ–·ç¶²ã€API å¤±æ•—ï¼‰
4. **æ•¸æ“šåº«æŒä¹…åŒ–**ï¼ˆé‡å•Ÿå¾Œæ•¸æ“šæ˜¯å¦é‚„åœ¨ï¼‰

---

## ğŸ–¥ï¸ æœå‹™å™¨éƒ¨ç½²ä¿¡æ¯

### ç”Ÿç”¢æœå‹™å™¨
| é …ç›® | å€¼ |
|------|---|
| **ä¸»æ©Ÿ** | `165.154.210.154` |
| **ç”¨æˆ¶å** | `ubuntu` |
| **åŸŸå** | `tgw.usdt2026.cc` |
| **éƒ¨ç½²è·¯å¾‘** | `/opt/tg-matrix` |

### SSH é€£æ¥å‘½ä»¤
```bash
ssh ubuntu@165.154.210.154
```

### å¸¸ç”¨é‹ç¶­å‘½ä»¤
```bash
# é€²å…¥é …ç›®ç›®éŒ„
cd /opt/tg-matrix

# æŸ¥çœ‹é‹è¡Œç‹€æ…‹
sudo docker compose ps

# é‡å•Ÿ API å®¹å™¨
sudo docker compose restart api

# é‡å»ºä¸¦é‡å•Ÿ APIï¼ˆæ‹‰å–æœ€æ–°ä»£ç¢¼å¾Œï¼‰
sudo git fetch origin && sudo git reset --hard origin/main
sudo docker compose up -d --build api

# æŸ¥çœ‹ API æ—¥èªŒ
sudo docker compose logs -f --tail=100 api

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨æ—¥èªŒ
sudo docker compose logs -f --tail=50
```

**æ³¨æ„**ï¼šæœå‹™å™¨ä½¿ç”¨ Docker Compose V2 (`docker compose`)ï¼Œä¸æ˜¯ V1 (`docker-compose`)

---

## ä¸Šå‚³ä¸¦éƒ¨ç½²ï¼ˆGit + GitHub Actionsï¼‰

ç•¶ç”¨æˆ¶èªªã€Œä¸Šå‚³ä¸¦éƒ¨ç½²ã€ã€Œå¹«æˆ‘ä¸Šå‚³ä¸¦å¸ƒç½²ã€ã€Œæäº¤ä¸¦éƒ¨ç½²ã€ç­‰æ™‚ï¼š
1. åª stage æºä»£ç¢¼è®Šæ›´ï¼ˆ`git add` å¾Œç«¯/å‰ç«¯æºæ–‡ä»¶ï¼‰ï¼Œ**ä¸è¦**åŠ å…¥ `dist/` æ§‹å»ºç”¢ç‰©ã€‚
2. åŸ·è¡Œ `git commit -m "ç°¡çŸ­æè¿°"` èˆ‡ `git push origin main`ã€‚
3. æ¨é€å¾Œ GitHub Actions æœƒè‡ªå‹•åŸ·è¡Œ Deploy to Productionï¼ˆæ§‹å»ºå‰ç«¯ã€åŒæ­¥æœå‹™å™¨ã€é‡å•Ÿå®¹å™¨ï¼‰ã€‚
4. å¯ç°¡çŸ­å›è¦†ï¼šå·²æäº¤ä¸¦æ¨é€ï¼ŒActions æœƒè‡ªå‹•éƒ¨ç½²ã€‚
