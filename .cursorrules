# TG-AIæ™ºæ§ç‹ é–‹ç™¼è¦ç¯„

## èªè¨€èˆ‡å›æ‡‰
- å§‹çµ‚ä½¿ç”¨**ç¹é«”ä¸­æ–‡**å›è¦†
- ä»£ç¢¼è¨»é‡‹å¯ç”¨ç°¡é«”ä¸­æ–‡æˆ–è‹±æ–‡

## æŠ€è¡“æ£§
- **å‰ç«¯**: Angular 21 + TypeScript (Standalone Components)
- **å¾Œç«¯**: Python 3.11+ / FastAPI + Pyrogram (Telegram API)
- **æ¡Œé¢**: Electron 28
- **è³‡æ–™åº«**: SQLite (ä¸‰æ•¸æ“šåº«æ¶æ§‹)
- **é€šè¨Š**: Electron IPC (stdin/stdout JSON)

---

## ğŸ”´ æ•¸æ“šåº«æ¶æ§‹è¦ç¯„ï¼ˆåš´æ ¼éµå®ˆï¼‰

### ä¸‰æ•¸æ“šåº«è¨­è¨ˆ

| æ•¸æ“šåº« | è·¯å¾‘ | ç”¨é€” | ç®¡ç†æ¨¡å¡Š |
|--------|------|------|----------|
| `tgmatrix.db` | `backend/data/` | å¸³è™Ÿç®¡ç† | `database.py` |
| `tgai_server.db` | `backend/data/` | æ¥­å‹™æ•¸æ“š | `database.py` |
| `search_history.db` | `backend/data/` | æœç´¢æ­·å² | `search_history_service.py` |

### ğŸš« åš´ç¦äº‹é …
1. **ç¦æ­¢åœ¨å…¶ä»–æ–‡ä»¶å‰µå»ºæ•¸æ“šåº«é€£æ¥** - å¿…é ˆé€šéæŒ‡å®šæ¨¡å¡Š
2. **ç¦æ­¢ç¡¬ç·¨ç¢¼æ•¸æ“šåº«è·¯å¾‘** - å¿…é ˆå¾ `config.py` ç²å–
3. **ç¦æ­¢é‡è¤‡å®šç¾©è¡¨çµæ§‹** - è¡¨å®šç¾©å”¯ä¸€ä¾†æºè¦‹ä¸‹æ–¹
4. **ç¦æ­¢è·¨æ•¸æ“šåº«æŸ¥è©¢** - æ¯å€‹è¡¨åªå­˜åœ¨æ–¼ä¸€å€‹æ•¸æ“šåº«

### è¡¨æ­¸å±¬æ˜ å°„ï¼ˆå”¯ä¸€ä¾†æºï¼‰

#### tgmatrix.dbï¼ˆå¸³è™Ÿå°ˆç”¨ï¼‰
| è¡¨å | å®šç¾©ä½ç½® | èªªæ˜ |
|------|----------|------|
| `accounts` | `database.py:_init_db()` | Telegram å¸³è™Ÿ |

#### tgai_server.dbï¼ˆæ¥­å‹™æ•¸æ“šï¼‰
| è¡¨å | å®šç¾©ä½ç½® | èªªæ˜ |
|------|----------|------|
| `monitored_groups` | `database.py:_init_db()` | ç›£æ§ç¾¤çµ„ |
| `keyword_sets` | `database.py:_init_db()` | é—œéµè©é›† |
| `trigger_rules` | `database.py:_init_db()` | è§¸ç™¼è¦å‰‡ |
| `chat_templates` | `database.py:_init_db()` | èŠå¤©æ¨¡æ¿ |
| `extracted_members` | `database.py:_init_db()` | æå–æˆå“¡ |
| `unified_contacts` | `database.py:_init_db()` | çµ±ä¸€è¯ç¹«äºº |
| `message_queue` | `database.py:_init_db()` | æ¶ˆæ¯éšŠåˆ— |
| `chat_history` | `database.py:_init_db()` | èŠå¤©è¨˜éŒ„ |
| `leads` | `database.py:_init_db()` | æ½›åœ¨å®¢æˆ¶ |
| `collected_users` | `database.py:_init_db()` | æ”¶é›†ç”¨æˆ¶ |
| `logs` | `database.py:_init_db()` | ç³»çµ±æ—¥èªŒ |
| `settings` | `database.py:_init_db()` | ç³»çµ±è¨­ç½® |

#### search_history.dbï¼ˆæœç´¢å°ˆç”¨ï¼‰
| è¡¨å | å®šç¾©ä½ç½® | èªªæ˜ |
|------|----------|------|
| `discovered_resources` | `search_history_service.py` | ç™¼ç¾çš„è³‡æº |
| `search_history` | `search_history_service.py` | æœç´¢æ­·å² |
| `search_result_items` | `search_history_service.py` | æœç´¢çµæœ |

### æ•¸æ“šæµå‘åœ–
```
[æœç´¢ç™¼ç¾] â”€â”€â–º search_history.db:discovered_resources
                         â”‚
                    [åŠ å…¥ç¾¤çµ„]
                         â–¼
              tgai_server.db:monitored_groups
                         â”‚
                    [æˆå“¡æå–]
                         â–¼
              tgai_server.db:extracted_members
                         â”‚
                    [åŒæ­¥æ•´åˆ]
                         â–¼
              tgai_server.db:unified_contacts â—„â”€â”€ leads
                         â”‚
                    [æ‰¹é‡ç™¼é€]
                         â–¼
              tgai_server.db:message_queue
                         â”‚
                         â–¼
              tgai_server.db:chat_history
```

### æ•¸æ“šåº«è¨ªå•è¦ç¯„

```python
# âœ… æ­£ç¢ºï¼šé€šé database.py è¨ªå•
from database import db
await db.fetch_all("SELECT * FROM monitored_groups")

# âœ… æ­£ç¢ºï¼šé€šéå°ˆç”¨æœå‹™è¨ªå•
from search_history_service import get_search_history_service
service = get_search_history_service()
resources = service.get_discovered_resources()

# âŒ éŒ¯èª¤ï¼šç›´æ¥å‰µå»ºé€£æ¥
conn = sqlite3.connect("backend/data/tgai_server.db")

# âŒ éŒ¯èª¤ï¼šç¡¬ç·¨ç¢¼è·¯å¾‘
db_path = "D:/tgkz2026/backend/data/tgai_server.db"
```

### è¡¨çµæ§‹ä¿®æ”¹æµç¨‹
1. **åƒ…ä¿®æ”¹** `database.py` çš„ `_init_db()` æˆ– `_migrate_db()`
2. æ·»åŠ æ–°æ¬„ä½ä½¿ç”¨ `ALTER TABLE ADD COLUMN`
3. ä¿®æ”¹å¾Œæ¸¬è©¦ç¾æœ‰æ•¸æ“šé·ç§»
4. æ›´æ–°æœ¬æ–‡æª”çš„è¡¨æ­¸å±¬æ˜ å°„

---

## é—œéµæ–‡ä»¶è¦ç¯„

### ç¦æ­¢éš¨æ„ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | è·è²¬ | ä¿®æ”¹é¢¨éšª |
|------|------|----------|
| `backend/config.py` | æ‰€æœ‰é…ç½®é …ä¾†æº | ğŸ”´ æ¥µé«˜ |
| `backend/database.py` | æ•¸æ“šåº«é€£æ¥å’Œè¡¨å®šç¾© | ğŸ”´ æ¥µé«˜ |
| `backend/search_history_service.py` | æœç´¢æ­·å²æ•¸æ“šåº« | ğŸ”´ æ¥µé«˜ |
| `electron.js` | IPC é€šè¨Šå’Œé€²ç¨‹ç®¡ç† | ğŸ”´ æ¥µé«˜ |

### ä¿®æ”¹é€™äº›æ–‡ä»¶å‰å¿…é ˆ
1. ç†è§£ç¾æœ‰é‚è¼¯
2. ç¢ºèªä¿®æ”¹ä¸æœƒç ´å£ç¾æœ‰åŠŸèƒ½
3. æ¸¬è©¦æ‰€æœ‰ç›¸é—œåŠŸèƒ½
4. åœ¨ commit message ä¸­èªªæ˜åŸå› 

---

## æ ¸å¿ƒè¡¨é—œä¿‚åœ–

```
tgmatrix.db                    tgai_server.db
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  accounts   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ monitored_groups â”‚
â”‚  (3 records)â”‚               â”‚   (é—œè¯å¸³è™Ÿ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ keyword_sets    â”‚
                              â”‚ trigger_rules   â”‚
                              â”‚ chat_templates  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚extracted_membersâ”‚
                              â”‚   (14 records)  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚unified_contacts â”‚
                              â”‚(åŒæ­¥æ•´åˆè¦–åœ–)    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

search_history.db
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚discovered_resourcesâ”‚
â”‚   (367 records)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä»£ç¢¼é¢¨æ ¼
- Python: `snake_case`ï¼Œé¡å `PascalCase`
- TypeScript: `camelCase`ï¼Œé¡å/çµ„ä»¶ `PascalCase`
- è³‡æ–™åº«æ¬„ä½: `snake_case`

## API è¦ç¯„
å¾Œç«¯æ‰€æœ‰éŸ¿æ‡‰å¿…é ˆéµå¾ªçµ±ä¸€æ ¼å¼ï¼š
```python
{"success": True/False, "data": ..., "error": "éŒ¯èª¤è¨Šæ¯"}
```

## è³‡æ–™åº«æ“ä½œæ³¨æ„äº‹é …
- **N+1 å•é¡Œ**: åˆ—è¡¨æŸ¥è©¢å¿…é ˆä½¿ç”¨ JOIN æˆ–æ‰¹é‡ç²å–
- **äº‹å‹™**: å¤šè¡¨æ›´æ–°å¿…é ˆä½¿ç”¨äº‹å‹™åŒ…è£¹
- **ç´¢å¼•**: æ–°å¢æŸ¥è©¢æ¢ä»¶æ¬„ä½æ™‚è€ƒæ…®æ˜¯å¦éœ€è¦ç´¢å¼•
- **åˆ†é **: è¿”å›å¤§é‡æ•¸æ“šæ™‚å¿…é ˆæ”¯æŒ `limit/offset`
- **NOT NULL**: è¬¹æ…ä½¿ç”¨ï¼Œé¿å… INSERT å¤±æ•—
- **è§¸ç™¼å™¨**: ç¦æ­¢å‰µå»ºï¼Œæ›¾å°è‡´åš´é‡å•é¡Œ

## Telegram/Pyrogram ç‰¹åˆ¥æ³¨æ„
- **FloodWait**: æ‰€æœ‰ API èª¿ç”¨å¿…é ˆé€šé `safe_telegram_call()` åŒ…è£¹
- **Session æ–‡ä»¶**: æ“ä½œå‰æª¢æŸ¥é–å®šç‹€æ…‹ï¼Œä½¿ç”¨ `try-finally` é‡‹æ”¾
- **API_ID/API_HASH**: ç¦æ­¢ç¡¬ç·¨ç¢¼ï¼Œå¿…é ˆå¾ config è®€å–
- **å¸³è™Ÿç‹€æ…‹**: æ“ä½œå‰é©—è­‰ `client.is_connected()`

## å‰ç«¯ UI è¦ç¯„
- æ‰€æœ‰æ“ä½œéœ€æä¾› Loading ç‹€æ…‹åé¥‹
- åˆ—è¡¨ç‚ºç©ºæ™‚é¡¯ç¤ºç©ºç‹€æ…‹æç¤º
- éŒ¯èª¤ä½¿ç”¨ Toast é€šçŸ¥ç”¨æˆ¶
- `@for` å¾ªç’°å¿…é ˆä½¿ç”¨å”¯ä¸€çš„ `track` è¡¨é”å¼

## éŒ¯èª¤è™•ç†
- å¾Œç«¯: ä½¿ç”¨ `handle_error()` çµ±ä¸€è™•ç†
- å‰ç«¯: æ•ç²æ‰€æœ‰ API éŒ¯èª¤ï¼Œä¸è®“éŒ¯èª¤éœé»˜å¤±æ•—
- æ—¥èªŒ: é—œéµæ“ä½œè¨˜éŒ„ INFOï¼Œç•°å¸¸è¨˜éŒ„ ERROR + å †æ£§

## å®‰å…¨ç´…ç·š
- ä¸åœ¨å‰ç«¯å­˜å„²æ•æ„Ÿæ†‘è­‰
- æ‰€æœ‰ç”¨æˆ¶è¼¸å…¥å¿…é ˆé©—è­‰
- å¸³è™Ÿæ“ä½œéœ€é©—è­‰ç”¨æˆ¶æ¬Šé™å’Œé…é¡

## å·²çŸ¥å•é¡Œå€åŸŸï¼ˆä¿®æ”¹æ™‚ç‰¹åˆ¥å°å¿ƒï¼‰
- `telegram_client.py`: Session ç®¡ç†ã€é€£ç·šç‹€æ…‹
- `message_queue.py`: ä¸¦ç™¼æ§åˆ¶ã€éšŠåˆ—ç‹€æ…‹
- `search-discovery.component.ts`: è³‡æºåˆ—è¡¨æ¸²æŸ“
- `database.py`: é·ç§»å…¼å®¹æ€§ã€è¡¨å®šç¾©
- `unified_contacts.py`: è·¨è¡¨åŒæ­¥é‚è¼¯

---

## ğŸ”´ èªè­‰èˆ‡æœƒè©±ç®¡ç†è¦ç¯„ï¼ˆåš´æ ¼éµå®ˆï¼‰

### Token é©—è­‰è¦å‰‡
1. **æ°¸é ä¸è¦åªé  `token.length` åˆ¤æ–·èªè­‰ç‹€æ…‹** â€” å¿…é ˆè§£æ JWT payload æª¢æŸ¥ `exp` éæœŸæ™‚é–“
2. **å‰ç«¯åˆ¤æ–· Token æœ‰æ•ˆæ€§çš„æ¨™æº–æ–¹æ³•**ï¼š
   ```typescript
   // âœ… æ­£ç¢ºï¼šè§£æ JWT æª¢æŸ¥éæœŸ
   function isTokenAlive(token: string | null): boolean {
     if (!token || token.length < 20) return false;
     const parts = token.split('.');
     if (parts.length !== 3) return false;
     try {
       let base64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
       while (base64.length % 4) base64 += '=';
       const payload = JSON.parse(atob(base64));
       return !(payload.exp && Date.now() >= payload.exp * 1000);
     } catch { return false; }
   }
   
   // âŒ éŒ¯èª¤ï¼šåªæª¢æŸ¥é•·åº¦
   if (token && token.length > 10) { /* å·²èªè­‰ */ }
   ```
3. **Guard èªè­‰é‚è¼¯ä¸‰æ­¥é©Ÿ**ï¼š
   - Access Token æœ‰æ•ˆ â†’ æ”¾è¡Œ
   - Access Token éæœŸ + Refresh Token æœ‰æ•ˆ â†’ æ”¾è¡Œï¼ˆèƒŒæ™¯åˆ·æ–°ï¼‰
   - å…©å€‹éƒ½éæœŸ â†’ æ¸…é™¤ localStorage + é‡å®šå‘ç™»å…¥é 
4. **`restoreSession()` æ¢å¾©æ™‚**ï¼šå¿…é ˆæª¢æŸ¥ Token éæœŸï¼ŒéæœŸçš„ Token ä¸è¦è¨­å…¥ Signal
5. **App å•Ÿå‹•å¾Œå¿…é ˆèª¿ç”¨ `fetchCurrentUser()`** å‘å¾Œç«¯é©—è­‰ Tokenï¼Œå¦‚æœè¿”å› null/401ï¼Œæ¸…é™¤æœƒè©±ä¸¦è·³è½‰ç™»å…¥é 

### ğŸš« èªè­‰åš´ç¦äº‹é …
1. **ç¦æ­¢åœ¨ localStorage å­˜æ”¾å¯†ç¢¼æˆ–å¯†é‘°** â€” åªå­˜ JWT Token
2. **ç¦æ­¢ç¡¬ç·¨ç¢¼ JWT Secret** â€” å¿…é ˆå¾ç’°å¢ƒè®Šé‡ `JWT_SECRET` è®€å–
3. **ç¦æ­¢åœ¨ AuthGuard ä¸­åªæª¢æŸ¥ token.length** â€” å¿…é ˆç”¨ `isTokenAlive()` è§£æéæœŸ
4. **ç¦æ­¢åœ¨ 401 è™•ç†ä¸­æ·»åŠ éé•·çš„å¯¬é™æœŸ** â€” æœ€å¤š 5 ç§’
5. **ç¦æ­¢ç¹éèªè­‰çš„å¾Œé–€ä»£ç¢¼** â€” Electron æ¨¡å¼ä¾‹å¤–éœ€è¦åŒæ™‚æ»¿è¶³ `apiMode === 'ipc' && isElectron`

### å¤šç§Ÿæˆ¶ï¼ˆSaaSï¼‰æ•¸æ“šéš”é›¢è¦å‰‡
1. **å¸³è™ŸæŸ¥è©¢å¿…é ˆå¸¶ `owner_user_id` éæ¿¾** â€” SaaS æ¨¡å¼ä¸‹æ¯å€‹ç”¨æˆ¶åªèƒ½çœ‹åˆ°è‡ªå·±çš„å¸³è™Ÿ
2. **æ·»åŠ å¸³è™Ÿæ™‚å¿…é ˆè¨­ç½® `owner_user_id`** â€” ç¶å®šåˆ°ç•¶å‰ç™»å…¥ç”¨æˆ¶
3. **å…¼å®¹æ­·å²æ•¸æ“š** â€” æŸ¥è©¢æ™‚åŒ…å« `owner_user_id IS NULL OR owner_user_id = 'local_user'`
4. **æ¸¬è©¦å¤šç§Ÿæˆ¶æ™‚** â€” ä½¿ç”¨ä¸åŒç”¨æˆ¶ç™»å…¥ï¼Œç¢ºèªæ•¸æ“šéš”é›¢æ­£ç¢º

---

## ğŸ”´ æ•¸æ“šåº«æŒä¹…åŒ–é˜²è­·è¦ç¯„

### é˜²æ­¢æ•¸æ“šä¸Ÿå¤±çš„æª¢æŸ¥æ¸…å–®
1. **éƒ¨ç½²å¾Œæª¢æŸ¥æ•¸æ“šåº«è·¯å¾‘** â€” `docker exec` é€²å®¹å™¨ç¢ºèª `/app/data/tgmatrix.db` å­˜åœ¨
2. **Docker Volume å¿…é ˆæ›è¼‰** â€” `docker-compose.yml` ä¸­ `./data:/app/data` ä¸å¯åˆªé™¤
3. **æ•¸æ“šåº«æ“ä½œå¿…é ˆç”¨äº‹å‹™** â€” å¤šæ­¥é©Ÿæ›´æ–°ä½¿ç”¨ `BEGIN/COMMIT`
4. **WAL æ¨¡å¼ä¿æŒé–‹å•Ÿ** â€” `PRAGMA journal_mode=WAL` é˜²æ­¢ä¸¦ç™¼å¯«å…¥è¡çª
5. **é‡å•Ÿå‰æª¢æŸ¥ WAL æ–‡ä»¶** â€” ç¢ºä¿ `-wal` æ–‡ä»¶å·² checkpoint

### æ•¸æ“šåº«è·¯å¾‘è§£æå„ªå…ˆç´š
| ç’°å¢ƒ | è·¯å¾‘ | æ³¨æ„äº‹é … |
|------|------|----------|
| é–‹ç™¼ | `backend/data/tgmatrix.db` | æœ¬åœ°ç›´æ¥è¨ªå• |
| Docker | `/app/data/tgmatrix.db` | å¿…é ˆæ›è¼‰ Volume |
| Electron | `{userData}/backend-data/tgmatrix.db` | ç”± Electron å‚³éè·¯å¾‘ |

---

## ğŸ”´ ç™»éŒ„ Token èˆ‡æƒç¢¼å¾Œç«¯çµ±ä¸€è¦ç¯„ï¼ˆåš´æ ¼éµå®ˆï¼‰

### åŸå‰‡ï¼šåªæ‡‰æœ‰ä¸€å€‹ã€Œç”Ÿæˆä¸¦é©—è­‰ login tokenã€çš„å¾Œç«¯

æƒç¢¼ç™»éŒ„æµç¨‹ï¼š**ç¶²é /å®¢æˆ¶ç«¯** è«‹æ±‚ `POST /api/v1/auth/login-token` åœ¨**è©²å¾Œç«¯**ç”Ÿæˆ token ä¸¦å¯«å…¥**è©²å¾Œç«¯**çš„æ•¸æ“šåº« â†’ ç”¨æˆ¶åœ¨ Telegram æƒç¢¼ â†’ **Bot** èª¿ç”¨ `INTERNAL_API_URL` å°æ‡‰çš„å¾Œç«¯æŸ¥è©¢/ç¢ºèª tokenã€‚è‹¥ Bot èª¿ç”¨çš„å¾Œç«¯èˆ‡ç”Ÿæˆ token çš„å¾Œç«¯**ä¸æ˜¯åŒä¸€å€‹**ï¼ˆæˆ–ä¸æ˜¯åŒä¸€ä»½æ•¸æ“šåº«ï¼‰ï¼Œæœƒå‡ºç¾ã€ŒToken ä¸å­˜åœ¨ã€ç™»éŒ„å¤±æ•—ã€‚

### ä¸‰ç«¯èˆ‡å¾Œç«¯å°é½Šè¦å‰‡

| ç«¯ | å»ºè­°è¡Œç‚º | èªªæ˜ |
|----|----------|------|
| **ç¶²é ç«¯**ï¼ˆå¦‚ https://tgw.usdt2026.ccï¼‰ | ä¸è¨­ç½® api_serverï¼Œç”¨åŒæº | ç™»éŒ„é è«‹æ±‚åŒæº APIï¼Œtoken å¯«åœ¨è©²æœå‹™å™¨ DBï¼›Bot å¿…é ˆèˆ‡è©² API åŒæ©ŸåŒåº«ã€‚ |
| **æœ¬åœ°é–‹ç™¼**ï¼ˆnpm run start + æƒç¢¼ï¼‰ | è‹¥éœ€æƒç¢¼æˆåŠŸï¼Œå°‡ã€Œä½¿ç”¨æœå‹™å™¨ç™»éŒ„ã€è¨­ç‚º**ç”Ÿç”¢åœ°å€**ï¼ˆå¦‚ https://tgw.usdt2026.ccï¼‰ä¸¦ä¿å­˜ | å¦å‰‡ token åœ¨æœ¬åœ° 8000 çš„ DBï¼Œæœå‹™å™¨ä¸Šçš„ Bot æŸ¥ä¸åˆ°ã€‚ |
| **å®‰è£ç‰ˆï¼ˆElectronï¼‰** | åŒä¸Šï¼Œæƒç¢¼ç™»éŒ„æ™‚ api_server æ‡‰æŒ‡å‘**èˆ‡ Bot åŒä¸€å¾Œç«¯**ï¼ˆé€šå¸¸ç‚ºç”Ÿç”¢åœ°å€ï¼‰ | èˆ‡ç®¡ç†å¾Œå°ã€ç¶²é ç‰ˆå…±ç”¨åŒä¸€å¥—æ•¸æ“šèˆ‡ token åº«ã€‚ |

### å¾Œç«¯èˆ‡ Bot éƒ¨ç½²è¦æ±‚

1. **åªéƒ¨ç½²ä¸€å€‹å°å¤–æä¾›ç™»éŒ„é  + login-token API çš„å¾Œç«¯å¯¦ä¾‹**ï¼ˆåŒä¸€ `DATABASE_PATH`ï¼‰ï¼Œé¿å…å¤šå¯¦ä¾‹ã€å¤šåº«å°è‡´ token ä¸ä¸€è‡´ã€‚
2. **Telegram Bot çš„ `INTERNAL_API_URL`** å¿…é ˆæŒ‡å‘**è©²åŒä¸€å¾Œç«¯**ï¼ˆæˆ–åŒæ©ŸåŒåº«çš„ APIï¼‰ï¼š
   - ç”Ÿç”¢ï¼šBot èˆ‡ API åŒæ©Ÿæ™‚è¨­ `INTERNAL_API_URL=http://127.0.0.1:8000`ï¼ˆæˆ–è©² API çš„å…§ç¶²åœ°å€ï¼‰ï¼Œä¸”è©² 8000 é€²ç¨‹å³å°å¤–æä¾›ç™»éŒ„çš„å¾Œç«¯ã€‚
   - ç¦æ­¢ï¼šBot æŒ‡å‘ A æ©Ÿã€ç™»éŒ„é è«‹æ±‚ B æ©Ÿï¼Œæˆ– Bot èˆ‡ API ä½¿ç”¨ä¸åŒ `DATABASE_PATH`ã€‚
3. **ç’°å¢ƒè®Šé‡**ï¼šè©²å¾Œç«¯é ˆé…ç½® `TELEGRAM_BOT_USERNAME`ã€`TELEGRAM_BOT_TOKEN`ï¼ˆèˆ‡ Bot ä¸€è‡´ï¼‰ï¼Œä»¥ä¾¿ç”Ÿæˆæ­£ç¢ºçš„äºŒç¶­ç¢¼é€£çµã€‚

### ä»£ç¢¼èˆ‡é…ç½®è¦é»

- å‰ç«¯ï¼šç™»éŒ„/æƒç¢¼æ™‚ API åŸºåœ°å€ç”± `localStorage['api_server']` æˆ–åŒæºæ±ºå®šï¼ˆ`getApiBaseForFetch()`ï¼‰ã€‚
- å¾Œç«¯ï¼šBot åœ¨ `backend/telegram/bot_handler.py` ä½¿ç”¨ `os.environ.get('INTERNAL_API_URL', 'http://localhost:8000')`ï¼›éƒ¨ç½²æ™‚å¿…é ˆåœ¨é‹è¡Œ Bot çš„ç’°å¢ƒä¸­è¨­ç½® `INTERNAL_API_URL` ç‚ºä¸Šè¿°ã€Œå”¯ä¸€å¾Œç«¯ã€çš„åœ°å€ã€‚
- æ–°å¢æˆ–ä¿®æ”¹ç™»éŒ„/æƒç¢¼ç›¸é—œé‚è¼¯æ™‚ï¼Œä¸å¾—å¼•å…¥ã€Œå¤šå€‹å¾Œç«¯ç”Ÿæˆ tokenã€Bot åªå•å…¶ä¸­ä¸€å€‹ã€çš„é…ç½®ï¼Œå¿…é ˆä¿æŒã€Œä¸€å€‹å¾Œç«¯ + ä¸€å€‹ DB + Bot æŒ‡å‘è©²å¾Œç«¯ã€ã€‚

---

## æ¸¬è©¦å»ºè­°
ä¿®æ”¹åŠŸèƒ½å¾Œï¼Œç°¡è¿°å¦‚ä½•æ‰‹å‹•æ¸¬è©¦ï¼š
1. æ­£å¸¸æµç¨‹
2. é‚Šç•Œæƒ…æ³ï¼ˆç©ºå€¼ã€è¶…é•·æ–‡æœ¬ã€ä¸¦ç™¼ï¼‰
3. éŒ¯èª¤æ¢å¾©ï¼ˆæ–·ç¶²ã€API å¤±æ•—ï¼‰
4. **æ•¸æ“šåº«æŒä¹…åŒ–**ï¼ˆé‡å•Ÿå¾Œæ•¸æ“šæ˜¯å¦é‚„åœ¨ï¼‰
5. **èªè­‰æœ‰æ•ˆæ€§**ï¼ˆToken éæœŸå¾Œæ˜¯å¦æ­£ç¢ºè·³è½‰ç™»å…¥é ï¼Œè€Œéé¡¯ç¤ºç©ºç•Œé¢ï¼‰
6. **å¤šç§Ÿæˆ¶éš”é›¢**ï¼ˆä¸åŒç”¨æˆ¶ç™»å…¥å¾Œï¼Œæ•¸æ“šæ˜¯å¦æ­£ç¢ºéš”é›¢ï¼‰

---

## ğŸ–¥ï¸ æœå‹™å™¨éƒ¨ç½²ä¿¡æ¯

### ç”Ÿç”¢æœå‹™å™¨
| é …ç›® | å€¼ |
|------|---|
| **ä¸»æ©Ÿ** | `165.154.210.154` |
| **ç”¨æˆ¶å** | `ubuntu` |
| **åŸŸå** | `tgw.usdt2026.cc` |
| **éƒ¨ç½²è·¯å¾‘** | `/opt/tg-matrix` |

### SSH é€£æ¥å‘½ä»¤
```bash
ssh ubuntu@165.154.210.154
```

### å¸¸ç”¨é‹ç¶­å‘½ä»¤
```bash
# é€²å…¥é …ç›®ç›®éŒ„
cd /opt/tg-matrix

# æŸ¥çœ‹é‹è¡Œç‹€æ…‹
sudo docker compose ps

# é‡å•Ÿ API å®¹å™¨
sudo docker compose restart api

# é‡å»ºä¸¦é‡å•Ÿ APIï¼ˆæ‹‰å–æœ€æ–°ä»£ç¢¼å¾Œï¼‰
sudo git fetch origin && sudo git reset --hard origin/main
sudo docker compose up -d --build api

# æŸ¥çœ‹ API æ—¥èªŒ
sudo docker compose logs -f --tail=100 api

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨æ—¥èªŒ
sudo docker compose logs -f --tail=50
```

**æ³¨æ„**ï¼šæœå‹™å™¨ä½¿ç”¨ Docker Compose V2 (`docker compose`)ï¼Œä¸æ˜¯ V1 (`docker-compose`)

---

## ä¸Šå‚³ä¸¦éƒ¨ç½²ï¼ˆGit + GitHub Actionsï¼‰

ç•¶ç”¨æˆ¶èªªã€Œä¸Šå‚³ä¸¦éƒ¨ç½²ã€ã€Œå¹«æˆ‘ä¸Šå‚³ä¸¦å¸ƒç½²ã€ã€Œæäº¤ä¸¦éƒ¨ç½²ã€ç­‰æ™‚ï¼š
1. åª stage æºä»£ç¢¼è®Šæ›´ï¼ˆ`git add` å¾Œç«¯/å‰ç«¯æºæ–‡ä»¶ï¼‰ï¼Œ**ä¸è¦**åŠ å…¥ `dist/` æ§‹å»ºç”¢ç‰©ã€‚
2. åŸ·è¡Œ `git commit -m "ç°¡çŸ­æè¿°"` èˆ‡ `git push origin main`ã€‚
3. æ¨é€å¾Œ GitHub Actions æœƒè‡ªå‹•åŸ·è¡Œ Deploy to Productionï¼ˆæ§‹å»ºå‰ç«¯ã€åŒæ­¥æœå‹™å™¨ã€é‡å•Ÿå®¹å™¨ï¼‰ã€‚
4. å¯ç°¡çŸ­å›è¦†ï¼šå·²æäº¤ä¸¦æ¨é€ï¼ŒActions æœƒè‡ªå‹•éƒ¨ç½²ã€‚
