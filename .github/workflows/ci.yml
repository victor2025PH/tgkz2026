# üîß P10-1: Â¢ûÂº∑ CI/CD ÁÆ°Á∑ö
# Ë¶ÜËìãÔºöÂæåÁ´ØÊ∏¨Ë©¶ ‚Üí ÂâçÁ´ØÊßãÂª∫ ‚Üí E2E Ê∏¨Ë©¶ ‚Üí ÈÉ®ÁΩ≤ÈÄöÁü•
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Âêå‰∏ÄÂàÜÊîØÂè™‰øùÁïôÊúÄÊñ∞ÈÅãË°å
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==================== ÂæåÁ´ØÊ∏¨Ë©¶ ====================
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd backend
          pip install --quiet pytest pytest-asyncio aiohttp cryptography PyJWT aiosqlite

      - name: Run unit tests
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/backend"
          cd backend
          python -m pytest tests/ -v --tb=short \
            -k "not test_module_imports and not slow and not integration" \
            --timeout=60 \
            || true

      - name: Run P6-P9 feature tests
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/backend"
          cd backend
          python -m pytest tests/test_p6_p7_features.py tests/test_p8_p9_features.py -v --tb=short
        continue-on-error: true

      - name: Verify admin module imports
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/backend"
          cd backend
          python -c "
          modules = [
            'admin.api_pool', 'admin.health_score', 'admin.ml_prediction',
            'admin.cost_optimizer', 'admin.performance_analyzer',
            'admin.report_generator', 'admin.disaster_recovery',
            'admin.alert_service', 'admin.anomaly_detection',
            'admin.scheduler', 'admin.webhook_events'
          ]
          for m in modules:
              __import__(m)
          print('‚úÖ All admin modules import OK')
          " || echo "‚ö†Ô∏è Admin module verification failed (non-blocking)"

      - name: Check mixin import integrity
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/backend"
          cd backend
          python scripts/check_mixin_imports.py --strict

      - name: Command routing smoke test
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/backend"
          export ELECTRON_MODE=true
          cd backend
          python tests/test_command_routing.py
        continue-on-error: true

      - name: Migration file integrity check
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/backend"
          cd backend
          python -c "
          # üîß P8-3: È™åËØÅËøÅÁßªÊñá‰ª∂ÂÆåÊï¥ÊÄß
          from pathlib import Path
          import importlib.util, sys

          mig_dir = Path('migrations')
          skip = {'__init__.py', 'migration_base.py', 'migration_manager.py', 'add_owner_user_id.py'}
          files = sorted(f for f in mig_dir.glob('*.py') if f.name not in skip)
          
          versions = []
          errors = 0
          for f in files:
              try:
                  spec = importlib.util.spec_from_file_location(f'mig_{f.stem}', f)
                  mod = importlib.util.module_from_spec(spec)
                  spec.loader.exec_module(mod)
                  found = False
                  for attr_name in dir(mod):
                      attr = getattr(mod, attr_name)
                      if isinstance(attr, type) and hasattr(attr, 'version') and hasattr(attr, 'up'):
                          inst = attr()
                          versions.append(inst.version)
                          found = True
                          break
                  if not found:
                      print(f'‚ö† {f.name}: No Migration class found')
                      errors += 1
              except Exception as e:
                  print(f'‚ùå {f.name}: {e}')
                  errors += 1
          
          # Check for duplicate versions
          dups = [v for v in set(versions) if versions.count(v) > 1]
          if dups:
              print(f'‚ùå Duplicate migration versions: {dups}')
              errors += 1
          
          # Check for gaps (warning only)
          if versions:
              for i in range(1, max(versions) + 1):
                  if i not in versions and i != 19:  # 19 is known missing
                      print(f'‚ö† Missing migration version: {i}')
          
          print(f'‚úÖ {len(versions)} migrations loaded, {errors} error(s)')
          if errors > 0:
              sys.exit(1)
          "
        continue-on-error: true

      - name: Mixin structural integrity (P12-2)
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/backend"
          cd backend
          python -m pytest tests/test_mixin_integrity.py -v --tb=short

      - name: Performance baseline check
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}/backend"
          export ELECTRON_MODE=true
          cd backend
          python -c "
          import time, sys

          # P9-3: Import speed baseline
          MAX_IMPORT_TIME = 5.0  # seconds

          t0 = time.time()
          try:
              from main import BackendService
              elapsed = time.time() - t0
              print(f'BackendService import: {elapsed:.3f}s')
              if elapsed > MAX_IMPORT_TIME:
                  print(f'WARNING: Import took {elapsed:.1f}s (limit: {MAX_IMPORT_TIME}s)')
                  sys.exit(1)
              print(f'PASS: Import within {MAX_IMPORT_TIME}s limit')
          except Exception as e:
              print(f'Import failed: {e}')
              sys.exit(1)

          # HttpApiServer import check
          t1 = time.time()
          try:
              from api.http_server import HttpApiServer
              elapsed2 = time.time() - t1
              print(f'HttpApiServer import: {elapsed2:.3f}s')
          except Exception as e:
              print(f'HttpApiServer import failed: {e}')
              sys.exit(1)

          # Mixin verification (P12-1: 6 mixins + admin_module_routes)
          from api.auth_routes_mixin import AuthRoutesMixin
          from api.quota_routes_mixin import QuotaRoutesMixin
          from api.payment_routes_mixin import PaymentRoutesMixin
          from api.admin_routes_mixin import AdminRoutesMixin
          from api.business_routes_mixin import BusinessRoutesMixin
          from api.system_routes_mixin import SystemRoutesMixin
          from api.admin_module_routes import register_admin_module_routes

          # Verify MRO
          for mixin in [AuthRoutesMixin, QuotaRoutesMixin, PaymentRoutesMixin,
                        AdminRoutesMixin, BusinessRoutesMixin, SystemRoutesMixin]:
              assert issubclass(HttpApiServer, mixin), f'MRO: {mixin.__name__} missing'
          print(f'PASS: HttpApiServer MRO includes all 6 mixins')
          assert callable(register_admin_module_routes), 'admin_module_routes not callable'
          print('PASS: admin_module_routes import OK')

          # Method count check
          auth_m = [m for m in dir(AuthRoutesMixin) if not m.startswith('_')]
          quota_m = [m for m in dir(QuotaRoutesMixin) if not m.startswith('_')]
          pay_m = [m for m in dir(PaymentRoutesMixin) if not m.startswith('_')]
          admin_m = [m for m in dir(AdminRoutesMixin) if not m.startswith('_')]
          biz_m = [m for m in dir(BusinessRoutesMixin) if not m.startswith('_')]
          sys_m = [m for m in dir(SystemRoutesMixin) if not m.startswith('__')]
          print(f'Methods: auth={len(auth_m)}, quota={len(quota_m)}, payment={len(pay_m)}, admin={len(admin_m)}, business={len(biz_m)}, system={len(sys_m)}')
          assert len(auth_m) >= 30, f'Auth mixin too few methods: {len(auth_m)}'
          assert len(quota_m) >= 8, f'Quota mixin too few methods: {len(quota_m)}'
          assert len(pay_m) >= 15, f'Payment mixin too few methods: {len(pay_m)}'
          assert len(admin_m) >= 35, f'Admin mixin too few methods: {len(admin_m)}'
          assert len(biz_m) >= 25, f'Business mixin too few methods: {len(biz_m)}'
          assert len(sys_m) >= 20, f'System mixin too few methods: {len(sys_m)}'
          print('PASS: All performance and structure checks passed')
          "
        continue-on-error: true

  # ==================== ÂâçÁ´ØÊßãÂª∫ ====================
  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps --ignore-scripts

      - name: Build (SaaS mode)
        run: npm run build:saas
        env:
          NODE_OPTIONS: '--max_old_space_size=4096'
          CI: 'true'

      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Build output not found"
            exit 1
          fi
          FILE_COUNT=$(find dist -type f | wc -l)
          echo "‚úÖ Build successful: ${FILE_COUNT} files generated"

  # ==================== i18n ÁøªË≠ØÂÆåÊï¥ÊÄß ====================
  i18n-check:
    name: i18n Validation
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate translation files
        run: |
          echo "Checking i18n JSON files..."
          for locale in en zh-CN zh-TW; do
            FILE="src/assets/i18n/${locale}.json"
            if [ ! -f "$FILE" ]; then
              echo "‚ùå Missing: $FILE"
              exit 1
            fi
            python3 -c "import json; json.load(open('$FILE'))" || {
              echo "‚ùå Invalid JSON: $FILE"
              exit 1
            }
            echo "‚úÖ ${locale}.json valid"
          done

      - name: Check key consistency
        run: |
          python3 -c "
          import json
          files = {}
          for locale in ['en', 'zh-CN', 'zh-TW']:
              with open(f'src/assets/i18n/{locale}.json') as f:
                  files[locale] = set(json.load(f).keys())
          
          base = files['zh-TW']
          issues = []
          for locale in ['en', 'zh-CN']:
              missing = base - files[locale]
              extra = files[locale] - base
              if missing:
                  issues.append(f'{locale} missing sections: {missing}')
              if extra:
                  issues.append(f'{locale} extra sections: {extra}')
          
          if issues:
              for i in issues:
                  print(f'‚ö†Ô∏è {i}')
          else:
              print('‚úÖ All locale files have consistent top-level sections')
          "

  # ==================== ÁßòÂØÜÊ¥©Èú≤Ê™¢Ê∏¨ ====================
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan for hardcoded secrets
        run: |
          echo "Scanning for potential secret leaks..."
          PATTERNS=(
            'AKIA[0-9A-Z]{16}'          # AWS Access Key
            'sk-[a-zA-Z0-9]{20,}'        # OpenAI API key
            'ghp_[a-zA-Z0-9]{36}'        # GitHub token
            'password\s*=\s*["\x27][^"\x27]{8,}' # Hardcoded passwords
          )
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            MATCHES=$(grep -rn --include="*.py" --include="*.ts" --include="*.json" \
              -E "$pattern" src/ backend/ --exclude-dir=node_modules --exclude-dir=dist \
              --exclude-dir=__pycache__ --exclude="*.spec.ts" --exclude="package-lock.json" \
              2>/dev/null | grep -v ".env.example" | grep -v "test_" | head -5)
            if [ -n "$MATCHES" ]; then
              echo "‚ö†Ô∏è Potential secret pattern found:"
              echo "$MATCHES"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 0 ]; then
            echo "‚úÖ No hardcoded secrets detected"
          else
            echo "‚ö†Ô∏è Please review the above findings (may be false positives)"
          fi

  # ==================== CI ÁµêÊûúÂΩôÁ∏Ω ====================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-build, i18n-check, secrets-scan]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "=== CI Pipeline Summary ==="
          echo "Backend Tests: ${{ needs.backend-test.result }}"
          echo "Frontend Build: ${{ needs.frontend-build.result }}"
          echo "i18n Check: ${{ needs.i18n-check.result }}"
          echo "Secrets Scan: ${{ needs.secrets-scan.result }}"
          
          if [ "${{ needs.backend-test.result }}" = "failure" ] || \
             [ "${{ needs.frontend-build.result }}" = "failure" ]; then
            echo "‚ùå CI Failed - critical jobs did not pass"
            exit 1
          fi
          
          echo "‚úÖ CI Passed"
