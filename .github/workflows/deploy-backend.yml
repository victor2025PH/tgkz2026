name: Deploy Backend Only

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'docker-compose.yml'
      - 'nginx.conf'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  SERVER_HOST: 165.154.210.154
  SERVER_USER: ubuntu
  DEPLOY_PATH: /opt/tg-matrix

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # é…ç½® SSH é€£æ¥åƒæ•¸
          cat >> ~/.ssh/config << EOF
          Host deploy-server
            HostName ${{ env.SERVER_HOST }}
            User ${{ env.SERVER_USER }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ServerAliveInterval 30
            ServerAliveCountMax 5
            ConnectTimeout 30
            ConnectionAttempts 3
          EOF
          chmod 600 ~/.ssh/config
      
      - name: Test SSH connection
        run: |
          for i in 1 2 3 4 5; do
            echo "SSH connection attempt $i..."
            if ssh -o ConnectTimeout=10 deploy-server "echo 'SSH connection successful'" 2>/dev/null; then
              echo "âœ… SSH connected on attempt $i"
              exit 0
            fi
            echo "Attempt $i failed, waiting 10s..."
            sleep 10
          done
          echo "âŒ All SSH attempts failed"
          exit 1
      
      - name: Deploy backend files
        run: |
          # åªåŒæ­¥å¾Œç«¯å’Œé…ç½®æ–‡ä»¶ï¼ˆå¸¶é‡è©¦ï¼‰
          for i in 1 2 3; do
            if rsync -avz --delete \
              --timeout=60 \
              --exclude '__pycache__' \
              --exclude '*.pyc' \
              --exclude 'venv' \
              --exclude '.env' \
              -e "ssh -o ConnectTimeout=30" \
              backend/ deploy-server:${{ env.DEPLOY_PATH }}/backend/; then
              echo "âœ… Backend files synced"
              break
            fi
            echo "Rsync attempt $i failed, retrying..."
            sleep 5
          done
          
          # åŒæ­¥é…ç½®æ–‡ä»¶
          rsync -avz --timeout=60 \
            -e "ssh -o ConnectTimeout=30" \
            docker-compose.yml nginx.conf \
            deploy-server:${{ env.DEPLOY_PATH }}/
      
      - name: Ensure INTERNAL_API_URL on server (æƒç¢¼ç™»éŒ„ Bot èˆ‡ API åŒæº)
        run: |
          ssh -o ConnectTimeout=30 -o ServerAliveInterval=15 deploy-server << 'ENDSSH'
            cd /opt/tg-matrix
            ENV_FILE=".env"
            URL="https://tgw.usdt2026.cc"
            if [ -f "$ENV_FILE" ]; then
              if grep -q '^INTERNAL_API_URL=' "$ENV_FILE" 2>/dev/null; then
                sed -i.bak "s|^INTERNAL_API_URL=.*|INTERNAL_API_URL=$URL|" "$ENV_FILE"
                echo "Updated INTERNAL_API_URL=$URL in $ENV_FILE"
              else
                echo "INTERNAL_API_URL=$URL" >> "$ENV_FILE"
                echo "Appended INTERNAL_API_URL=$URL to $ENV_FILE"
              fi
            else
              echo "INTERNAL_API_URL=$URL" > "$ENV_FILE"
              echo "Created $ENV_FILE with INTERNAL_API_URL=$URL"
            fi
          ENDSSH
      
      - name: Build and deploy container
        run: |
          ssh -o ConnectTimeout=30 -o ServerAliveInterval=15 deploy-server << 'ENDSSH'
          set -x
          cd /opt/tg-matrix

          # é‡å»º API å®¹å™¨ï¼ˆç¡®ä¿ä½¿ç”¨æ–°ä»£ç ï¼›Bot ä¼šè¯»å– INTERNAL_API_URLï¼‰
          echo "ğŸ”¨ Building API container..."
          sudo docker compose build --no-cache api

          # åœæ­¢æ—§å®¹å™¨
          echo "ğŸ”„ Stopping old container..."
          sudo docker compose down --remove-orphans api 2>/dev/null || true
          sudo docker rm -f $(sudo docker ps -aq --filter "name=tg-matrix-api") 2>/dev/null || true

          # å¯åŠ¨æ–°å®¹å™¨
          echo "ğŸš€ Starting new container..."
          sudo docker compose up -d api

          # ç­‰å¾…å¯åŠ¨
          sleep 15

          # é‡è½½ nginx é…ç½®
          sudo docker compose exec -T web nginx -s reload || true

          # æ˜¾ç¤ºçŠ¶æ€
          sudo docker compose ps
          sudo docker compose logs --tail=30 api 2>&1 || true
          echo "âœ… Backend deployment completed at $(date)"
          ENDSSH
      
      - name: Verify deployed code (login-token idempotent fix)
        run: |
          echo "ğŸ” Verifying bot/login-token fix is in container..."
          if ssh -o ConnectTimeout=30 deploy-server "sudo docker compose -f ${{ env.DEPLOY_PATH }}/docker-compose.yml exec -T api grep -q 'already confirmed (idempotent)' /app/auth/login_token.py 2>/dev/null"; then
            echo "âœ… Container has login-token idempotent fix"
          else
            echo "âš ï¸ WARNING: /app/auth/login_token.py in container may not contain idempotent fix â€” deploy may be stale"
          fi
      
      - name: Health check with migration verification
        run: |
          echo "ğŸ”§ P8-3: Health check with migration status verification"
          sleep 10
          for i in 1 2 3 4 5 6; do
            RESPONSE=$(curl -sf http://${{ env.SERVER_HOST }}/api/health 2>/dev/null || echo '{}')
            echo "Attempt $i: $RESPONSE"
            
            # Check basic health
            STATUS=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('status',''))" 2>/dev/null || echo "")
            
            # Check migration status
            MIG_STATE=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); m=d.get('migration',{}); print(m.get('state','') if m else 'unknown')" 2>/dev/null || echo "unknown")
            
            echo "  Status: $STATUS, Migration: $MIG_STATE"
            
            if [ "$STATUS" = "ok" ] && [ "$MIG_STATE" != "running" ]; then
              echo "âœ… Health check passed (migration: $MIG_STATE)"
              exit 0
            fi
            
            echo "  Waiting 5s..."
            sleep 5
          done
          echo "âš ï¸ Health check timeout â€” fetching container logs for diagnosis..."
          ssh -o ConnectTimeout=30 deploy-server "sudo docker compose -f /opt/tg-matrix/docker-compose.yml logs --tail=80 api 2>&1" || echo "(failed to get logs)"
