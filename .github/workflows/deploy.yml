name: ðŸš€ Auto Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  deploy:
    name: ðŸ”„ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: ðŸš€ Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # æ·»åŠ æœå‹™å™¨åˆ°å·²çŸ¥ä¸»æ©Ÿ
          mkdir -p ~/.ssh
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null
          
          # åŸ·è¡Œéƒ¨ç½²å‘½ä»¤
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            echo "ðŸ”„ é–‹å§‹è‡ªå‹•éƒ¨ç½²..."
            
            # é€²å…¥é …ç›®ç›®éŒ„
            cd /opt/tg-matrix-server
            
            # æ‹‰å–æœ€æ–°ä»£ç¢¼
            echo "ðŸ“¥ æ‹‰å–æœ€æ–°ä»£ç¢¼..."
            git pull origin main
            
            # å®‰è£/æ›´æ–° Python ä¾è³´ï¼ˆå¦‚æžœéœ€è¦ï¼‰
            if [ -f backend/requirements.txt ]; then
              echo "ðŸ“¦ æª¢æŸ¥ Python ä¾è³´..."
              source venv/bin/activate
              pip install -q -r backend/requirements.txt 2>/dev/null || true
              deactivate
            fi
            
            # é‡å•Ÿæœå‹™
            echo "ðŸ”„ é‡å•Ÿæœå‹™..."
            sudo systemctl restart tg-matrix-license
            
            # ç­‰å¾…æœå‹™å•Ÿå‹•
            sleep 3
            
            # æª¢æŸ¥æœå‹™ç‹€æ…‹
            if sudo systemctl is-active --quiet tg-matrix-license; then
              echo "âœ… æœå‹™å•Ÿå‹•æˆåŠŸï¼"
            else
              echo "âŒ æœå‹™å•Ÿå‹•å¤±æ•—"
              sudo systemctl status tg-matrix-license
              exit 1
            fi
            
            echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼"
          ENDSSH
      
      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
