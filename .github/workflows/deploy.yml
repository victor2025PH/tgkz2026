name: Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - '*.md'
      - '.gitignore'
      - '.cursorrules'
      # åƒ…å¾Œç«¯è®Šæ›´æ™‚ä¸è§¸ç™¼æœ¬å·¥ä½œæµï¼Œç”± Deploy Backend Only è² è²¬ï¼Œé¿å…ä¸¦ç™¼è¡çª
      - 'backend/**'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  SERVER_HOST: 165.154.210.154
  SERVER_USER: ubuntu
  DEPLOY_PATH: /opt/tg-matrix

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Verify Angular compiler-cli
        run: |
          ls -la node_modules/@angular/compiler-cli/package.json 2>/dev/null && echo "âœ… compiler-cli present" || (echo "âŒ compiler-cli missing"; ls node_modules/@angular/ 2>/dev/null || true)
      
      - name: Build frontend (SaaS mode)
        shell: bash
        run: |
          set -o pipefail
          echo "Node $(node -v) | npm $(npm -v)"
          npx ng build --configuration saas 2>&1 | tee build.log
          BUILD_EXIT=$?
          if [ $BUILD_EXIT -ne 0 ]; then
            echo ""
            echo "========== COPY THE LINES BELOW FOR DEBUGGING =========="
            tail -80 build.log
            echo "========== END (copy above) =========="
          fi
          exit $BUILD_EXIT
        env:
          NODE_OPTIONS: '--max_old_space_size=8192'

      - name: Show build log on failure
        if: failure()
        run: |
          echo "========== Last 300 lines of build output =========="
          tail -300 build.log 2>/dev/null || true
          echo "========== node_modules/@angular (first 30) =========="
          ls node_modules/@angular 2>/dev/null | head -30 || true
          if [ -f build.log ]; then
            echo "## Deploy Build Error (last 120 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -120 build.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload build log on failure
        if: failure() && hashFiles('build.log') != ''
        uses: actions/upload-artifact@v4
        with:
          name: deploy-build-log
          path: build.log
          retention-days: 5

      - name: Verify build output
        if: success()
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist 2>/dev/null)" ]; then
            echo "âŒ Build failed: dist/ missing or empty"
            exit 1
          fi
          echo "âœ… Build output OK ($(find dist -type f | wc -l) files)"
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # é…ç½® SSH é€£æ¥åƒæ•¸ï¼ˆå¢å¼·ç©©å®šæ€§ï¼‰
          cat >> ~/.ssh/config << EOF
          Host deploy-server
            HostName ${{ env.SERVER_HOST }}
            User ${{ env.SERVER_USER }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ServerAliveInterval 30
            ServerAliveCountMax 5
            ConnectTimeout 30
            ConnectionAttempts 3
          EOF
          chmod 600 ~/.ssh/config
      
      - name: Test SSH connection
        run: |
          for i in 1 2 3 4 5; do
            echo "SSH connection attempt $i..."
            if ssh -o ConnectTimeout=10 deploy-server "echo 'SSH connection successful'" 2>/dev/null; then
              echo "âœ… SSH connected on attempt $i"
              exit 0
            fi
            echo "Attempt $i failed, waiting 10s..."
            sleep 10
          done
          echo "âŒ All SSH attempts failed"
          exit 1
      
      - name: Deploy to server
        run: |
          # åŒæ­¥æ–‡ä»¶åˆ°æœå‹™å™¨ï¼ˆå¸¶é‡è©¦å’Œè¶…æ™‚ï¼‰
          for i in 1 2 3; do
            echo "Rsync attempt $i..."
            if rsync -avz --delete \
              --timeout=120 \
              --exclude '.git' \
              --exclude 'node_modules' \
              --exclude '__pycache__' \
              --exclude '*.pyc' \
              --exclude 'venv' \
              --exclude '.env' \
              --exclude 'data/' \
              --exclude 'certbot/' \
              --exclude 'playwright-report/' \
              --exclude 'e2e/' \
              --exclude 'build-scripts/' \
              --exclude 'scripts/' \
              -e "ssh -o ConnectTimeout=30 -o ServerAliveInterval=15" \
              ./ deploy-server:${{ env.DEPLOY_PATH }}/; then
              echo "âœ… Files synced successfully"
              break
            fi
            echo "Attempt $i failed, waiting 10s..."
            sleep 10
          done
      
      - name: Ensure INTERNAL_API_URL on server (æƒç¢¼ç™»éŒ„ Bot èˆ‡ API åŒæº)
        run: |
          ssh -o ConnectTimeout=30 -o ServerAliveInterval=15 deploy-server << 'ENDSSH'
            cd /opt/tg-matrix
            ENV_FILE=".env"
            URL="https://tgw.usdt2026.cc"
            if [ -f "$ENV_FILE" ]; then
              if grep -q '^INTERNAL_API_URL=' "$ENV_FILE" 2>/dev/null; then
                sed -i.bak "s|^INTERNAL_API_URL=.*|INTERNAL_API_URL=$URL|" "$ENV_FILE"
                echo "Updated INTERNAL_API_URL=$URL in $ENV_FILE"
              else
                echo "INTERNAL_API_URL=$URL" >> "$ENV_FILE"
                echo "Appended INTERNAL_API_URL=$URL to $ENV_FILE"
              fi
            else
              echo "INTERNAL_API_URL=$URL" > "$ENV_FILE"
              echo "Created $ENV_FILE with INTERNAL_API_URL=$URL"
            fi
          ENDSSH
      
      - name: Restart services
        run: |
          ssh -o ConnectTimeout=30 -o ServerAliveInterval=15 deploy-server << 'ENDSSH'
            cd /opt/tg-matrix
            export INTERNAL_API_URL="https://tgw.usdt2026.cc"
            
            # ğŸ”§ æ¸…ç†å­¤å„¿å®¹å™¨é˜²æ­¢åç§°å†²çªï¼ˆæ— å®¹å™¨æ—¶ docker rm å¯èƒ½è¿”å› 1ï¼Œå¿½ç•¥ï¼‰
            sudo docker compose down --remove-orphans 2>/dev/null || true
            sudo docker ps -aq --filter "name=tg-matrix" 2>/dev/null | xargs -r sudo docker rm -f 2>/dev/null || true
            
            # é‡æ–°å‰µå»º nginx å®¹å™¨ï¼ˆç¢ºä¿æ–°çš„ volume æ›è¼‰ç”Ÿæ•ˆï¼‰
            sudo docker compose up -d web
            
            # é‡å»ºä¸¦é‡å•Ÿ APIï¼ˆ--force-recreate ç¢ºä¿è®€å–æœ€æ–° .envï¼›Bot é ˆæœ‰ INTERNAL_API_URL æ‰èƒ½æƒç¢¼æˆåŠŸï¼‰
            sudo docker compose build --no-cache api
            sudo -E docker compose up -d --force-recreate api
            
            # ç­‰å¾…æœå‹™å•Ÿå‹•
            sleep 15
            
            # é¡¯ç¤ºç‹€æ…‹
            sudo docker compose ps
            echo "âœ… Deployment completed at $(date)"
          ENDSSH
      
      - name: Health check
        run: |
          sleep 15
          for i in 1 2 3 4 5 6 7 8; do
            if curl -sf --connect-timeout 10 http://${{ env.SERVER_HOST }}/api/health > /dev/null; then
              echo "âœ… Health check passed"
              exit 0
            fi
            echo "Health check attempt $i failed, waiting 10s..."
            sleep 10
          done
          echo "âš ï¸ Health check timeout (service may still be starting)"
        continue-on-error: true
      
      - name: Notify result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸš€ Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
