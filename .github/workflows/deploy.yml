name: ğŸš€ Auto Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  deploy:
    name: ğŸ”„ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass
      
      - name: ğŸš€ Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          # ä½¿ç”¨å¯†ç¢¼èªè­‰éƒ¨ç½²
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            echo "ğŸ”„ é–‹å§‹è‡ªå‹•éƒ¨ç½²..."
            
            # é€²å…¥é …ç›®ç›®éŒ„
            cd /opt/tg-matrix-server
            
            # æ‹‰å–æœ€æ–°ä»£ç¢¼
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç¢¼..."
            git pull origin main
            
            # å®‰è£/æ›´æ–° Python ä¾è³´ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if [ -f backend/requirements.txt ]; then
              echo "ğŸ“¦ æª¢æŸ¥ Python ä¾è³´..."
              source venv/bin/activate
              pip install -q -r backend/requirements.txt 2>/dev/null || true
              deactivate
            fi
            
            # é‡å•Ÿæœå‹™ï¼ˆä½¿ç”¨ NOPASSWD é…ç½®æˆ– echo passwordï¼‰
            echo "ğŸ”„ é‡å•Ÿæœå‹™..."
            echo "$SERVER_PASSWORD" | sudo -S systemctl restart tg-matrix-license 2>/dev/null || sudo systemctl restart tg-matrix-license
            
            # ç­‰å¾…æœå‹™å•Ÿå‹•
            sleep 3
            
            # æª¢æŸ¥æœå‹™ç‹€æ…‹
            if sudo systemctl is-active --quiet tg-matrix-license; then
              echo "âœ… æœå‹™å•Ÿå‹•æˆåŠŸï¼"
            else
              echo "âŒ æœå‹™å•Ÿå‹•å¤±æ•—"
              sudo systemctl status tg-matrix-license
              exit 1
            fi
            
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          ENDSSH
      
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "## ğŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
