TG-Matrix 后端集成指南
1. 概述
本文档概述了 TG-Matrix 应用程序 Python 后端的通信协议和 API 接口。前端是一个独立的 Angular 应用程序，托管在 Electron shell 中。Python 脚本将作为 Electron 管理的长期子进程运行。两个进程之间的所有通信均通过标准输入进行。标准输入）和标准输出（标准输出）。
建筑学：
code
代码
[Angular Frontend] <---(IPC)---> [Electron Main Process (electron.js)] <---(stdin/stdout)---> [Python Backend (main.py)]
2. 通信协议
流程管理： 这electron.js该文件将生成主 Python 脚本（例如，后端/主程序）作为应用程序启动时的子进程。
数据传输所有沟通均以文字形式进行。
信息框架：每条消息，无论是否已发送到Python 或从Python，必须是一行完整的 JSON 文本，以换行符结尾（\n）这是确保消息解析可靠性的最关键规则。
3. 数据格式
所有消息均采用简单的JSON结构。
发送到后端的消息（命令）
Python 脚本将接收来自 Electron 的命令。标准输入。
code
JSON
{
  "command": "string",
  "payload": {}
}
命令要执行的操作的名称（例如，“开始监控”）。
有效载荷：包含该命令所需数据的 JSON 对象。
来自后端（事件）的消息
Python 脚本将通过写入其地址向 Electron 发送事件。标准输出。
code
JSON
{
  "event": "string",
  "payload": {}
}
事件：所发生事件的名称（例如，“新线索获取”）。
有效载荷：一个包含与事件关联的数据的 JSON 对象。前端依靠这些事件来实时更新用户界面。
4. 后端生命周期
创业公司Python 脚本由 Electron 启动。它应该立即初始化其组件（数据库连接等），并开始监听命令。标准输入陷入无限循环。
手术该脚本处理来自以下位置的命令：标准输入并向标准输出异步操作完成后。
关闭当用户关闭 Electron 应用程序时，Python 进程将被终止。脚本应该能够优雅地处理这种情况（例如，使用 `returns` 语句）。终于试过了……阻止关闭数据库连接）。
5. 要发出的事件（Python）标准输出）
Python后端必须发出以下事件以更新前端 UI。有效负载结构必须与 TypeScript 中定义的接口匹配。src/models.ts。
初始状态
描述： 发送一次对此的回应获取初始状态此命令会在启动时填充整个用户界面。所有数据都应来自数据库的最新数据。
有效载荷：
code
JSON
{
  "accounts": [/* Array of TelegramAccount objects */],
  "keywordSets": [/* Array of KeywordSet objects */],
  "monitoredGroups": [/* Array of MonitoredGroup objects */],
  "campaigns": [/* Array of AutomationCampaign objects */],
  "messageTemplates": [/* Array of MessageTemplate objects */],
  "leads": [/* Array of CapturedLead objects */],
  "logs": [/* Array of LogEntry objects (limit to last 100) */]
}
（注：见）src/models.ts针对每种对象类型的具体结构，请提供时间戳。时间戳应采用 ISO 8601 格式，例如：YYYY-MM-DDTHH:mm:ss.sssZ）
日志条目
描述：每当后端发生新的可记录操作时发送。
有效载荷（日志条目界面）：
code
JSON
{
  "id": 1678886400000,
  "timestamp": "2023-10-27T12:00:00.000Z",
  "message": "Monitoring started successfully.",
  "type": "info" // 'info' | 'success' | 'warning' | 'error'
}
账户已更新
描述：每当帐户列表发生更改（添加、删除、状态更新、角色更改等）时发送。有效负载应包含以下内容：完整列表从数据库中获取所有账户。前端将用这个新列表替换现有的列表。
有效载荷：
code
JSON
[
  { /* TelegramAccount object */ },
  { /* TelegramAccount object */ },
  ...
]
新线索获取
描述当监听器帐户检测到符合营销活动条件的新潜在客户时发送。
有效载荷（捕获线索界面）：
code
JSON
{
  "id": 123,
  "userId": "543210987",
  "username": "someuser",
  "sourceGroup": "Crypto Enthusiasts",
  "triggeredKeyword": "bitcoin",
  "timestamp": "2023-10-27T12:05:10.000Z",
  "status": "New",
  "onlineStatus": "Online", // 'Online' | 'Offline' | 'Recently' | 'Unknown'
  "campaignId": 5,
  // ... other fields from models.ts
}
监控状态已更改
描述当全局监控状态发生变化时发送。
有效载荷：真的（如果已开始监控）错误的（如果监测停止）。
6. 要处理的命令（Python）标准输入）
Python后端必须监听并处理以下命令。
（注：对于许多此类命令，其主要职责是更新数据库。如果数据更改影响到用户界面，则必须发出第 5 节中列出的相应事件。例如，在处理完以下操作后添加帐户你必须发出一个账户已更新（包含新的完整账户列表的活动。）
命令名称	有效载荷描述	预期后端操作
获取初始状态	无效的	查询数据库以获取所有状态数据并发出初始状态事件。
添加帐户	{ 电话、代理、apiId、... }	向数据库添加新帐户。发出账户已更新。
登录帐户	账户 ID（例如，123）	启动指定账户的 Pyrogram 登录。发射账户已更新状态发生变化（“正在登录...”、“在线”、“代理错误”）。发出日志条目。
检查账户状态	账户 ID（例如，123）	检查帐户的连接状态。发送账户已更新。
启动监控	无效的	启动所有“监听器”帐户。发出监控状态已更改和真的发射日志条目。
停止监控	无效的	停止所有“监听器”帐户。发送监控状态已更改和错误的发射日志条目。
清除日志	无效的	从数据库中删除所有日志条目。无需任何事件处理，用户界面会自动清除。
更新帐户数据	{ id: 123, updates: { role: '发件人' } }	更新数据库中特定帐户的数据。发出账户已更新。
批量分配角色	{ accountIds: [1,2,3], role: '监听器' }	更新多个帐户的角色。发出账户已更新。
批量分配组	{ accountIds: [1,2,3], group: 'A组' }	更新多个帐户的组。发出账户已更新。
批量删除账户	{ accountIds: [1,2,3] }	删除多个帐户及其会话文件。账户已更新。
添加关键字集	{ name: '我的设置' }	创建一个新的关键字集。后续事件将包含完整状态，并更新用户界面。
添加关键字	{ setId: 1, keyword: 'crypto', isRegex: false }	将关键字添加到集合中。
删除关键字	{ setId: 1, keywordId: 5 }	从集合中移除一个关键字。
添加组	{ url: 't.me/group', keywordSetIds: [1, 2] }	添加受监控组。
添加模板	{ name: '模板 A', prompt: '你好...' }	添加新的消息模板。
添加活动	{ 名称，触发器：{...}，操作：{...} }	添加一个新的自动化营销活动。
发送消息	{ 线索 ID、消息、附件 }	使用“发件人”帐户发送私信。更新数据库中潜在客户的状态和互动历史记录。发出日志条目。
更新销售线索状态	{ leadId, newStatus }	更新数据库中潜在客户的状态。
添加到DNC	{ userId: '12345' }	将用户 ID 添加到数据库的“请勿联系”列表中。
从 Excel 加载帐户	{ filePath: 'C:/path/to/file.xlsx' }	读取指定的 Excel 文件，解析账户，并在数据库中添加/更新账户信息。账户已更新。
导出销售线索到 Excel	{ leads: [...], filePath: 'C:/path/to/save.xlsx' }	将提供的潜在客户数据写入指定路径的 Excel 文件。
删除帐户，删除关键字集，移除组，移除模板，移除活动	{ id: 123 }	从数据库中删除指定项。前端需要后续的状态更新事件来刷新用户界面。
切换模板状态，切换竞选状态	{ id: 123 }	切换isActive指定项的布尔值。前端需要状态更新。