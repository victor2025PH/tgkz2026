"""
Extracted handler implementations: api_credentials
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


# ==================== API Credential Pool Handlers ====================

async def handle_get_api_credentials(self, payload: Dict[str, Any]):
    """ç²å– API æ†‘æ“šæ± ä¿¡æ¯"""
    import sys
    print("[Backend] handle_get_api_credentials called", file=sys.stderr)
    try:
        from api_credential_pool import get_api_credential_pool
        data_dir = str(Path(config.DATA_PATH))
        print(f"[Backend] API pool data_dir: {data_dir}", file=sys.stderr)
        pool = get_api_credential_pool(data_dir)
        print(f"[Backend] API pool loaded, credentials count: {len(pool.credentials)}", file=sys.stderr)

        # ğŸ†• ç²å–ç•¶å‰ç”¨æˆ¶ IDï¼ˆå¤šç§Ÿæˆ¶éš”é›¢ï¼‰
        owner_user_id = None
        try:
            from core.tenant_context import get_current_tenant
            tenant = get_current_tenant()
            if tenant and tenant.user_id:
                owner_user_id = tenant.user_id
                print(f"[Backend] API credentials filter by user: {owner_user_id}", file=sys.stderr)
        except ImportError:
            pass

        # æ¯æ¬¡ç²å–æ™‚åŒæ­¥ä½¿ç”¨è¨ˆæ•¸ï¼Œç¢ºä¿æº–ç¢ºæ€§
        accounts = await db.get_all_accounts()
        print(f"[Backend] Got {len(accounts)} accounts for API sync", file=sys.stderr)
        pool.sync_usage_counts(accounts)

        statistics = pool.get_statistics()
        print(f"[Backend] API statistics: {statistics}", file=sys.stderr)
        # ğŸ†• å‚³é owner_user_id é€²è¡Œå¤šç§Ÿæˆ¶éæ¿¾
        credentials = pool.list_credentials(include_hash=True, accounts=accounts, owner_user_id=owner_user_id)
        print(f"[Backend] Sending {len(credentials)} API credentials to frontend (filtered by user)", file=sys.stderr)

        response = {
            "success": True,
            "statistics": statistics,
            "credentials": credentials
        }
        self.send_event("api-credentials-updated", response)
        print("[Backend] api-credentials-updated event sent", file=sys.stderr)
        return response
        
    except Exception as e:
        print(f"[Backend] Error getting API credentials: {e}", file=sys.stderr)
        response = {
            "success": False,
            "error": str(e),
            "statistics": None,
            "credentials": []
        }
        self.send_event("api-credentials-updated", response)
        return response


async def handle_add_api_credential(self, payload: Dict[str, Any]):
    """æ·»åŠ  API æ†‘æ“š"""
    try:
        from api_credential_pool import get_api_credential_pool
        data_dir = str(Path(config.DATA_PATH))
        pool = get_api_credential_pool(data_dir)
        
        api_id = payload.get("api_id", "").strip()
        api_hash = payload.get("api_hash", "").strip()
        name = payload.get("name", "").strip()
        source = payload.get("source", "").strip()
        max_accounts = payload.get("max_accounts", 5)
        
        if not api_id or not api_hash:
            self.send_event("api-credential-added", {
                "success": False,
                "error": "API ID å’Œ API Hash ç‚ºå¿…å¡«é …"
            })
            return
        
        # é©—è­‰æ ¼å¼
        if not api_id.isdigit():
            self.send_event("api-credential-added", {
                "success": False,
                "error": "API ID å¿…é ˆæ˜¯ç´”æ•¸å­—"
            })
            return
        
        import re
        if not re.match(r'^[a-f0-9]{32}$', api_hash, re.IGNORECASE):
            self.send_event("api-credential-added", {
                "success": False,
                "error": "API Hash æ ¼å¼ä¸æ­£ç¢ºï¼ˆæ‡‰ç‚º32ä½åå…­é€²åˆ¶å­—ç¬¦ä¸²ï¼‰"
            })
            return
        
        # ğŸ†• ç²å–ç•¶å‰ç”¨æˆ¶ IDï¼ˆå¤šç§Ÿæˆ¶éš”é›¢ï¼‰
        owner_user_id = ""
        try:
            from core.tenant_context import get_current_tenant
            tenant = get_current_tenant()
            if tenant and tenant.user_id:
                owner_user_id = tenant.user_id
        except ImportError:
            pass
        
        success = pool.add_credential(
            api_id=api_id,
            api_hash=api_hash,
            name=name or f"API_{api_id[-4:]}",
            source=source,
            max_accounts=max_accounts,
            owner_user_id=owner_user_id  # ğŸ†• å¤šç§Ÿæˆ¶éš”é›¢
        )
        
        if success:
            self.send_event("api-credential-added", {"success": True})
            self.send_log(f"âœ… å·²æ·»åŠ  API æ†‘æ“šï¼š{api_id}", "success")
            # åˆ·æ–°åˆ—è¡¨
            await self.handle_get_api_credentials({})
        else:
            self.send_event("api-credential-added", {
                "success": False,
                "error": "æ·»åŠ å¤±æ•—ï¼Œå¯èƒ½è©² API ID å·²å­˜åœ¨"
            })
        
    except Exception as e:
        print(f"[Backend] Error adding API credential: {e}", file=sys.stderr)
        self.send_event("api-credential-added", {
            "success": False,
            "error": str(e)
        })


async def handle_remove_api_credential(self, payload: Dict[str, Any]):
    """ç§»é™¤ API æ†‘æ“š"""
    try:
        from api_credential_pool import get_api_credential_pool
        data_dir = str(Path(config.DATA_PATH))
        pool = get_api_credential_pool(data_dir)
        
        api_id = payload.get("api_id", "").strip()
        
        if not api_id:
            self.send_event("api-credential-removed", {
                "success": False,
                "error": "è«‹æŒ‡å®šè¦åˆªé™¤çš„ API ID"
            })
            return
        
        # ğŸ†• ç²å–ç•¶å‰ç”¨æˆ¶ IDï¼ˆå¤šç§Ÿæˆ¶éš”é›¢ï¼‰
        owner_user_id = None
        try:
            from core.tenant_context import get_current_tenant
            tenant = get_current_tenant()
            if tenant and tenant.user_id:
                owner_user_id = tenant.user_id
        except ImportError:
            pass
        
        success = pool.remove_credential(api_id, owner_user_id=owner_user_id)
        
        if success:
            self.send_event("api-credential-removed", {"success": True})
            self.send_log(f"ğŸ—‘ï¸ å·²åˆªé™¤ API æ†‘æ“šï¼š{api_id}", "info")
            # åˆ·æ–°åˆ—è¡¨
            await self.handle_get_api_credentials({})
        else:
            self.send_event("api-credential-removed", {
                "success": False,
                "error": "åˆªé™¤å¤±æ•—ï¼Œæœªæ‰¾åˆ°è©² API ID"
            })
        
    except Exception as e:
        print(f"[Backend] Error removing API credential: {e}", file=sys.stderr)
        self.send_event("api-credential-removed", {
            "success": False,
            "error": str(e)
        })


async def handle_toggle_api_credential(self, payload: Dict[str, Any]):
    """åˆ‡æ› API æ†‘æ“šå•Ÿç”¨ç‹€æ…‹"""
    try:
        from api_credential_pool import get_api_credential_pool
        data_dir = str(Path(config.DATA_PATH))
        pool = get_api_credential_pool(data_dir)
        
        api_id = payload.get("api_id", "").strip()
        is_active = payload.get("is_active", True)
        
        cred = pool.get_credential(api_id)
        if cred:
            cred.is_active = is_active
            pool.save()
            self.send_event("api-credential-toggled", {"success": True})
            self.send_log(f"{'â–¶ï¸ å·²å•Ÿç”¨' if is_active else 'â¸ï¸ å·²åœç”¨'} API æ†‘æ“šï¼š{api_id}", "info")
            # åˆ·æ–°åˆ—è¡¨
            await self.handle_get_api_credentials({})
        else:
            self.send_event("api-credential-toggled", {
                "success": False,
                "error": "æœªæ‰¾åˆ°è©² API ID"
            })
        
    except Exception as e:
        print(f"[Backend] Error toggling API credential: {e}", file=sys.stderr)
        self.send_event("api-credential-toggled", {
            "success": False,
            "error": str(e)
        })


async def handle_bulk_import_api_credentials(self, payload: Dict[str, Any]):
    """æ‰¹é‡å°å…¥ API æ†‘æ“š"""
    try:
        from api_credential_pool import get_api_credential_pool
        data_dir = str(Path(config.DATA_PATH))
        pool = get_api_credential_pool(data_dir)
        
        credentials = payload.get("credentials", [])
        
        if not credentials:
            self.send_event("api-credentials-imported", {
                "success": False,
                "error": "æ²’æœ‰æä¾›æ†‘æ“š"
            })
            return
        
        success_count = 0
        fail_count = 0
        
        for cred in credentials:
            api_id = cred.get("api_id", "").strip()
            api_hash = cred.get("api_hash", "").strip()
            name = cred.get("name", "").strip()
            
            if api_id and api_hash:
                if pool.add_credential(api_id, api_hash, name):
                    success_count += 1
                else:
                    fail_count += 1
            else:
                fail_count += 1
        
        self.send_event("api-credentials-imported", {
            "success": True,
            "success_count": success_count,
            "fail_count": fail_count
        })
        self.send_log(f"ğŸ“¥ æ‰¹é‡å°å…¥å®Œæˆï¼šæˆåŠŸ {success_count} å€‹ï¼Œå¤±æ•— {fail_count} å€‹", "info")
        
        # åˆ·æ–°åˆ—è¡¨
        await self.handle_get_api_credentials({})
        
    except Exception as e:
        print(f"[Backend] Error bulk importing API credentials: {e}", file=sys.stderr)
        self.send_event("api-credentials-imported", {
            "success": False,
            "error": str(e)
        })


async def handle_get_api_recommendation(self, payload: Dict[str, Any]):
    """ç²å– API æ†‘æ“šå»ºè­°"""
    try:
        from api_credential_pool import get_api_credential_pool
        data_dir = str(Path(config.DATA_PATH))
        pool = get_api_credential_pool(data_dir)
        
        account_count = payload.get("account_count", 50)
        recommendation = pool.get_recommendation(account_count)
        
        self.send_event("api-recommendation", {
            "success": True,
            **recommendation
        })
        
    except Exception as e:
        print(f"[Backend] Error getting API recommendation: {e}", file=sys.stderr)
        self.send_event("api-recommendation", {
            "success": False,
            "error": str(e)
        })


# ==================== Platform API Pool Handlers ====================

async def handle_get_platform_api_usage(self, payload: Dict[str, Any]):
    """ç²å–ç”¨æˆ¶çš„å¹³å° API ä½¿ç”¨æƒ…æ³"""
    try:
        from platform_api_pool import get_platform_api_pool
        
        user_id = payload.get("userId", "default_user")
        membership_level = payload.get("membershipLevel", "bronze")

        data_dir = str(Path(config.DATA_PATH))
        pool = get_platform_api_pool(data_dir)
        quota_info = pool.check_user_quota(user_id, membership_level)
        
        self.send_event("platform-api-usage", quota_info)
        
    except Exception as e:
        print(f"[Backend] Error getting platform API usage: {e}", file=sys.stderr)
        self.send_event("platform-api-usage", {
            "success": False,
            "error": str(e)
        })


async def handle_allocate_platform_api(self, payload: Dict[str, Any]):
    """ç‚ºç”¨æˆ¶åˆ†é…å¹³å° API"""
    try:
        from platform_api_pool import get_platform_api_pool
        
        user_id = payload.get("userId", "default_user")
        phone = payload.get("phone", "")
        membership_level = payload.get("membershipLevel", "bronze")
        
        if not phone:
            self.send_event("platform-api-allocated", {
                "success": False,
                "error": "è«‹æä¾›æ‰‹æ©Ÿè™Ÿ"
            })
            return
        
        data_dir = str(Path(config.DATA_PATH))
        pool = get_platform_api_pool(data_dir)
        result = pool.allocate_api_for_user(user_id, phone, membership_level)
        
        self.send_event("platform-api-allocated", result)
        
        if result.get("success"):
            self.send_log(f"âœ… å·²ç‚º {phone} åˆ†é…å¹³å° API", "info")
        
    except Exception as e:
        print(f"[Backend] Error allocating platform API: {e}", file=sys.stderr)
        import traceback
        traceback.print_exc(file=sys.stderr)
        self.send_event("platform-api-allocated", {
            "success": False,
            "error": str(e)
        })


async def handle_release_platform_api(self, payload: Dict[str, Any]):
    """é‡‹æ”¾ç”¨æˆ¶çš„å¹³å° API åˆ†é…"""
    try:
        from platform_api_pool import get_platform_api_pool
        
        phone = payload.get("phone", "")
        
        if not phone:
            self.send_event("platform-api-released", {
                "success": False,
                "error": "è«‹æä¾›æ‰‹æ©Ÿè™Ÿ"
            })
            return
        
        data_dir = str(Path(config.DATA_PATH))
        pool = get_platform_api_pool(data_dir)
        success, message = pool.release_allocation(phone)
        
        self.send_event("platform-api-released", {
            "success": success,
            "message": message
        })
        
    except Exception as e:
        print(f"[Backend] Error releasing platform API: {e}", file=sys.stderr)
        self.send_event("platform-api-released", {
            "success": False,
            "error": str(e)
        })


async def handle_admin_add_platform_api(self, payload: Dict[str, Any]):
    """ç®¡ç†å“¡æ·»åŠ å¹³å° API"""
    try:
        from platform_api_pool import get_platform_api_pool
        
        api_id = payload.get("apiId", "")
        api_hash = payload.get("apiHash", "")
        name = payload.get("name", "")
        max_accounts = payload.get("maxAccounts", 3)
        
        if not api_id or not api_hash:
            self.send_event("admin-platform-api-added", {
                "success": False,
                "error": "è«‹æä¾›å®Œæ•´çš„ API æ†‘æ“š"
            })
            return
        
        data_dir = str(Path(config.DATA_PATH))
        pool = get_platform_api_pool(data_dir)
        success, message = pool.add_platform_api(api_id, api_hash, name, max_accounts)
        
        self.send_event("admin-platform-api-added", {
            "success": success,
            "message": message
        })
        
        if success:
            self.send_log(f"âœ… ç®¡ç†å“¡æ·»åŠ å¹³å° API: {name}", "info")
        
    except Exception as e:
        print(f"[Backend] Error adding platform API: {e}", file=sys.stderr)
        self.send_event("admin-platform-api-added", {
            "success": False,
            "error": str(e)
        })


async def handle_admin_list_platform_apis(self, payload: Dict[str, Any]):
    """ç®¡ç†å“¡åˆ—å‡ºæ‰€æœ‰å¹³å° API"""
    try:
        from platform_api_pool import get_platform_api_pool
        
        data_dir = str(Path(config.DATA_PATH))
        pool = get_platform_api_pool(data_dir)
        apis = pool.list_platform_apis()
        stats = pool.get_pool_statistics()
        
        self.send_event("admin-platform-apis-list", {
            "success": True,
            "apis": apis,
            "statistics": stats
        })
        
    except Exception as e:
        print(f"[Backend] Error listing platform APIs: {e}", file=sys.stderr)
        self.send_event("admin-platform-apis-list", {
            "success": False,
            "error": str(e)
        })

