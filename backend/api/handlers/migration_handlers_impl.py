"""
Extracted handler implementations: migration
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

from error_handler import handle_error, AppError, ErrorType
# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


async def handle_migration_status(self, payload: Dict[str, Any]):
    """Handle migration-status command"""
    try:
        from migrations.migration_manager import get_migration_manager
        migration_manager = get_migration_manager()
        
        if not migration_manager:
            self.send_log("Migration manager not initialized", "warning")
            self.send_event("migration-status", {
                "error": "Migration manager not initialized"
            })
            return
        
        status = await migration_manager.status()
        self.send_event("migration-status", status)
    except Exception as e:
        handle_error(e, {"command": "migration-status", "payload": payload})
        self.send_log(f"Error getting migration status: {str(e)}", "error")
        self.send_event("migration-status", {"error": str(e)})


async def handle_migrate(self, payload: Dict[str, Any]):
    """Handle migrate command"""
    try:
        from migrations.migration_manager import get_migration_manager
        migration_manager = get_migration_manager()
        
        if not migration_manager:
            self.send_log("Migration manager not initialized", "error")
            return
        
        target_version = payload.get('targetVersion')  # Optional
        
        success = await migration_manager.migrate(target_version)
        if success:
            status = await migration_manager.status()
            self.send_log("Migration completed successfully", "success")
            self.send_event("migration-completed", {
                "message": "Migration completed successfully",
                "status": status
            })
        else:
            self.send_log("Migration failed", "error")
            self.send_event("migration-completed", {
                "error": "Migration failed"
            })
    except Exception as e:
        handle_error(e, {"command": "migrate", "payload": payload})
        self.send_log(f"Error running migration: {str(e)}", "error")
        self.send_event("migration-completed", {"error": str(e)})


async def handle_rollback_migration(self, payload: Dict[str, Any]):
    """Handle rollback-migration command"""
    try:
        from migrations.migration_manager import get_migration_manager
        migration_manager = get_migration_manager()
        
        if not migration_manager:
            self.send_log("Migration manager not initialized", "error")
            return
        
        target_version = payload.get('targetVersion')
        if target_version is None:
            self.send_log("Missing targetVersion", "error")
            return
        
        success = await migration_manager.rollback(target_version)
        if success:
            status = await migration_manager.status()
            self.send_log(f"Rollback to version {target_version} completed successfully", "success")
            self.send_event("migration-rollback-completed", {
                "message": f"Rollback to version {target_version} completed successfully",
                "status": status
            })
        else:
            self.send_log("Rollback failed", "error")
            self.send_event("migration-rollback-completed", {
                "error": "Rollback failed"
            })
    except Exception as e:
        handle_error(e, {"command": "rollback-migration", "payload": payload})
        self.send_log(f"Error rolling back migration: {str(e)}", "error")
        self.send_event("migration-rollback-completed", {"error": str(e)})

