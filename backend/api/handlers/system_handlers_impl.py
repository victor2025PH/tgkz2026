"""
Extracted handler implementations: system
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context
from database import db
from config import config

from service_locator import member_extraction_service, get_script_engine, get_init_search_engine
# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


# ==================== Database Management ====================

async def handle_rebuild_database(self):
    """é‡å»ºæ•¸æ“šåº«ï¼ˆæœƒåˆªé™¤æ‰€æœ‰æ•¸æ“šï¼‰"""
    import shutil
    from pathlib import Path
    
    try:
        db_path = Path(config.DATABASE_URL)
        db_dir = db_path.parent
        
        self.send_log("é–‹å§‹é‡å»ºæ•¸æ“šåº«...", "info")
        
        # æ­¥é©Ÿ 1: å‚™ä»½ç¾æœ‰æ•¸æ“šåº«
        if db_path.exists():
            backup_path = db_dir / f"tgmatrix_backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.db"
            try:
                shutil.copy2(db_path, backup_path)
                self.send_log(f"æ•¸æ“šåº«å·²å‚™ä»½åˆ°: {backup_path.name}", "success")
            except Exception as e:
                self.send_log(f"å‚™ä»½å¤±æ•—: {str(e)}", "warning")
        
        # æ­¥é©Ÿ 2: é—œé–‰ç•¶å‰æ•¸æ“šåº«é€£æ¥
        try:
            await db.close()
        except:
            pass
        
        # æ­¥é©Ÿ 3: åˆªé™¤èˆŠæ•¸æ“šåº«æ–‡ä»¶
        try:
            if db_path.exists():
                db_path.unlink()
            # åˆªé™¤ WAL å’Œ SHM æ–‡ä»¶
            wal_path = Path(str(db_path) + "-wal")
            shm_path = Path(str(db_path) + "-shm")
            if wal_path.exists():
                wal_path.unlink()
            if shm_path.exists():
                shm_path.unlink()
            self.send_log("èˆŠæ•¸æ“šåº«æ–‡ä»¶å·²åˆªé™¤", "info")
        except Exception as e:
            self.send_log(f"åˆªé™¤èˆŠæ•¸æ“šåº«å¤±æ•—: {str(e)}", "error")
            self.send_event("database-rebuild-result", {
                "success": False,
                "error": f"åˆªé™¤èˆŠæ•¸æ“šåº«å¤±æ•—: {str(e)}"
            })
            return
        
        # æ­¥é©Ÿ 4: é‡æ–°åˆå§‹åŒ–æ•¸æ“šåº«
        try:
            await db.initialize()
            await db.connect()
            
            # é©—è­‰æ•¸æ“šåº«å®Œæ•´æ€§
            cursor = await db._connection.execute("PRAGMA integrity_check")
            result = await cursor.fetchone()
            if result and result[0] == 'ok':
                self.send_log("æ•¸æ“šåº«é‡å»ºæˆåŠŸï¼Œå®Œæ•´æ€§æª¢æŸ¥é€šé", "success")
            else:
                self.send_log(f"æ•¸æ“šåº«é‡å»ºå®Œæˆï¼Œä½†å®Œæ•´æ€§æª¢æŸ¥è­¦å‘Š: {result[0] if result else 'Unknown'}", "warning")
            
            # é‡æ–°åˆå§‹åŒ–å…¨æ–‡æœç´¢ç´¢å¼•
            try:
                from config import DATABASE_PATH
                search_engine = await get_init_search_engine()(str(DATABASE_PATH))
                self.send_log("å…¨æ–‡æœç´¢ç´¢å¼•å·²é‡å»º", "success")
            except Exception as e:
                self.send_log(f"å…¨æ–‡æœç´¢ç´¢å¼•é‡å»ºå¤±æ•—ï¼ˆå¯é¸ï¼‰: {str(e)}", "warning")
            
            self.send_event("database-rebuild-result", {
                "success": True,
                "message": "æ•¸æ“šåº«é‡å»ºæˆåŠŸ"
            })
            
            # ç™¼é€åˆå§‹ç‹€æ…‹äº‹ä»¶ï¼Œè®“å‰ç«¯åˆ·æ–°
            await self.handle_get_initial_state()
            
        except Exception as e:
            import traceback
            error_details = traceback.format_exc()
            print(f"[Backend] Database rebuild error: {error_details}", file=sys.stderr)
            self.send_log(f"æ•¸æ“šåº«é‡å»ºå¤±æ•—: {str(e)}", "error")
            self.send_event("database-rebuild-result", {
                "success": False,
                "error": str(e)
            })
            
    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        print(f"[Backend] Database rebuild error: {error_details}", file=sys.stderr)
        self.send_event("database-rebuild-result", {
            "success": False,
            "error": str(e)
        })


async def handle_get_active_executions(self, payload: Dict[str, Any]):
    """ç²å–æ´»èºåŸ·è¡Œ"""
    try:
        script_engine = get_script_engine()
        if not script_engine:
            self.send_event("active-executions", {"success": False, "error": "åŠ‡æœ¬å¼•æ“æœªåˆå§‹åŒ–"})
            return
        
        result = await script_engine.get_active_executions()
        self.send_event("active-executions", result)
        
    except Exception as e:
        self.send_event("active-executions", {"success": False, "error": str(e)})


async def handle_get_execution_stats(self, payload: Dict[str, Any]):
    """ç²å–åŸ·è¡Œçµ±è¨ˆ"""
    try:
        script_engine = get_script_engine()
        if not script_engine:
            self.send_event("execution-stats", {"success": False, "error": "åŠ‡æœ¬å¼•æ“æœªåˆå§‹åŒ–"})
            return
        
        result = await script_engine.get_execution_stats()
        self.send_event("execution-stats", result)
        
    except Exception as e:
        self.send_event("execution-stats", {"success": False, "error": str(e)})


async def handle_get_background_tasks(self, payload: Dict[str, Any]):
    """ç²å–èƒŒæ™¯ä»»å‹™åˆ—è¡¨"""
    try:
        tasks = member_extraction_service.get_all_background_tasks()
        
        self.send_event("background-tasks", {
            "success": True,
            "tasks": tasks
        })
        
    except Exception as e:
        self.send_event("background-tasks", {
            "success": False,
            "error": str(e),
            "tasks": []
        })


async def handle_get_db_performance(self, payload: Dict[str, Any]):
    """ğŸ”§ Phase6-1: ç²å–æ•¸æ“šåº«æ€§èƒ½çµ±è¨ˆï¼ˆæ…¢æŸ¥è©¢ + è¡¨çµ±è¨ˆï¼‰"""
    try:
        from core.db_operations import get_slow_query_log, get_query_stats
        
        slow_queries = get_slow_query_log()
        stats = get_query_stats()
        
        # æ’åºï¼šæŒ‰æ…¢æŸ¥è©¢æ•¸é‡é™åº
        sorted_stats = sorted(
            stats.items(),
            key=lambda x: x[1].get("slow_count", 0),
            reverse=True
        )
        
        self.send_event("db-performance-result", {
            "success": True,
            "slowQueries": slow_queries[-50:],  # æœ€è¿‘ 50 æ¢æ…¢æŸ¥è©¢
            "tableStats": [
                {"table": t, **s} for t, s in sorted_stats
            ],
            "totalSlowQueries": len(slow_queries),
            "thresholdMs": 100
        })
        
    except Exception as e:
        self.send_event("db-performance-result", {
            "success": False,
            "error": str(e)
        })


async def handle_recalculate_scores(self, payload: Dict[str, Any]):
    """é‡æ–°è¨ˆç®—æˆå“¡è©•åˆ†"""
    try:
        chat_id = payload.get('chatId')
        
        count = await member_extraction_service.recalculate_member_scores(chat_id)
        
        self.send_log(f"âœ… é‡æ–°è¨ˆç®—è©•åˆ†å®Œæˆ: {count} å€‹æˆå“¡", "success")
        self.send_event("scores-recalculated", {
            "success": True,
            "count": count
        })
        
    except Exception as e:
        self.send_event("scores-recalculated", {
            "success": False,
            "error": str(e)
        })

