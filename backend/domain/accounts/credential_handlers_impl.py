"""
Extracted handler implementations: credentials
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


# ===================== End IP Binding Handlers =====================

# ===================== Credential Scraper Handlers (Phase 2) =====================

async def handle_credential_start_scrape(self, payload: Dict[str, Any]):
    """Handle credential-start-scrape command - Start API credential scraping"""
    try:
        if not self.credential_scraper:
            self.send_event("credential-scrape-error", {"error": "Credential Scraper 未初始化"})
            return
        
        account_id = payload.get("accountId")
        phone = payload.get("phone")
        proxy = payload.get("proxy")
        headless = payload.get("headless", True)
        
        if not account_id or not phone:
            self.send_event("credential-scrape-error", {"error": "缺少必要參數"})
            return
        
        # Get Telethon client if available for code reception
        telegram_client = None
        # Note: In production, you would get the client from qr_auth_manager or session
        
        result = await self.credential_scraper.start_scrape(
            account_id=account_id,
            phone=phone,
            telegram_client=telegram_client,
            proxy=proxy,
            headless=headless
        )
        
        self.send_event("credential-scrape-started", {
            "accountId": account_id,
            "phone": phone,
            "result": result
        })
        
        if result.get("success"):
            self.send_log(f"帳號 {phone} 開始獲取 API 憑據", "info")
        else:
            self.send_log(f"帳號 {phone} 獲取 API 憑據失敗: {result.get('message')}", "warning")
            
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_credential_start_scrape: {e}", file=sys.stderr)
        self.send_event("credential-scrape-error", {"error": str(e)})


async def handle_credential_submit_code(self, payload: Dict[str, Any]):
    """Handle credential-submit-code command - Submit verification code for scraping"""
    try:
        if not self.credential_scraper:
            return
        
        phone = payload.get("phone")
        code = payload.get("code")
        
        if not phone or not code:
            self.send_event("credential-code-error", {"error": "缺少必要參數"})
            return
        
        success = self.credential_scraper.submit_code(phone, code)
        
        self.send_event("credential-code-submitted", {
            "phone": phone,
            "success": success
        })
        
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_credential_submit_code: {e}", file=sys.stderr)


async def handle_credential_get_status(self, payload: Dict[str, Any]):
    """Handle credential-get-status command - Get scraping status"""
    try:
        if not self.credential_scraper:
            return
        
        phone = payload.get("phone")
        status = self.credential_scraper.get_scrape_status(phone)
        
        self.send_event("credential-status", {
            "phone": phone,
            "status": status
        })
        
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_credential_get_status: {e}", file=sys.stderr)


async def handle_credential_get_all(self, payload: Dict[str, Any]):
    """Handle credential-get-all command - Get all credentials"""
    try:
        if not self.credential_scraper:
            self.send_event("credentials-list", {"credentials": []})
            return
        
        credentials = self.credential_scraper.get_all_credentials()
        self.send_event("credentials-list", {"credentials": credentials})
        
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_credential_get_all: {e}", file=sys.stderr)


async def handle_credential_cancel_scrape(self, payload: Dict[str, Any]):
    """Handle credential-cancel-scrape command - Cancel scraping"""
    try:
        if not self.credential_scraper:
            return
        
        phone = payload.get("phone")
        success = await self.credential_scraper.cancel_scrape(phone)
        
        self.send_event("credential-scrape-cancelled", {
            "phone": phone,
            "success": success
        })
        
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_credential_cancel_scrape: {e}", file=sys.stderr)

