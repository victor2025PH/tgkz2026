"""
Extracted handler implementations: ip_binding
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context
from database import db

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


# ===================== End QR Code Login Handlers =====================

# ===================== IP Binding Handlers (Phase 2) =====================

async def handle_ip_bind(self, payload: Dict[str, Any]):
    """Handle ip-bind command - Bind IP to account"""
    try:
        if not self.ip_binding_manager:
            self.send_event("ip-binding-error", {"error": "IP Binding Manager 未初始化"})
            return
        
        account_id = payload.get("accountId")
        phone = payload.get("phone")
        proxy = payload.get("proxy")
        proxy_country = payload.get("proxyCountry")
        proxy_type = payload.get("proxyType", "residential")
        reason = payload.get("reason", "manual")
        
        if not account_id or not phone or not proxy:
            self.send_event("ip-binding-error", {"error": "缺少必要參數"})
            return
        
        binding = await self.ip_binding_manager.bind_ip(
            account_id=account_id,
            phone=phone,
            proxy=proxy,
            proxy_country=proxy_country,
            proxy_type=proxy_type,
            reason=reason
        )
        
        # Update account in database
        from dataclasses import asdict
        await db.update_account(account_id, {
            "proxy": proxy,
            "ip_binding_id": binding.proxy_ip,
            "ip_bound_at": binding.bound_at,
            "proxy_country": binding.proxy_country,
            "proxy_type": binding.proxy_type,
            "ip_is_sticky": 1
        })
        
        self.send_event("ip-binding-success", {
            "accountId": account_id,
            "phone": phone,
            "binding": asdict(binding)
        })
        self.send_log(f"帳號 {phone} 已綁定 IP: {binding.proxy_ip}", "success")
        
        # Refresh accounts list
        await self._send_accounts_updated()
        
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_ip_bind: {e}", file=sys.stderr)
        self.send_event("ip-binding-error", {"error": str(e)})


async def handle_ip_unbind(self, payload: Dict[str, Any]):
    """Handle ip-unbind command - Remove IP binding from account"""
    try:
        if not self.ip_binding_manager:
            return
        
        account_id = payload.get("accountId")
        
        # Just update the database to remove binding info
        await db.update_account(account_id, {
            "ip_binding_id": None,
            "ip_bound_at": None,
            "ip_is_sticky": 0
        })
        
        self.send_event("ip-unbinding-success", {"accountId": account_id})
        
        # Refresh accounts list
        await self._send_accounts_updated()
        
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_ip_unbind: {e}", file=sys.stderr)


async def handle_ip_get_binding(self, payload: Dict[str, Any]):
    """Handle ip-get-binding command - Get IP binding for account"""
    try:
        if not self.ip_binding_manager:
            return
        
        account_id = payload.get("accountId")
        binding = self.ip_binding_manager.get_binding(account_id)
        
        if binding:
            from dataclasses import asdict
            self.send_event("ip-binding-info", {
                "accountId": account_id,
                "binding": asdict(binding)
            })
        else:
            self.send_event("ip-binding-info", {
                "accountId": account_id,
                "binding": None
            })
            
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_ip_get_binding: {e}", file=sys.stderr)


async def handle_ip_get_all_bindings(self, payload: Dict[str, Any]):
    """Handle ip-get-all-bindings command - Get all IP bindings"""
    try:
        if not self.ip_binding_manager:
            self.send_event("ip-all-bindings", {"bindings": []})
            return
        
        bindings = self.ip_binding_manager.get_all_bindings()
        self.send_event("ip-all-bindings", {"bindings": bindings})
        
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_ip_get_all_bindings: {e}", file=sys.stderr)


async def handle_ip_get_statistics(self, payload: Dict[str, Any]):
    """Handle ip-get-statistics command - Get IP binding statistics"""
    try:
        if not self.ip_binding_manager:
            return
        
        stats = self.ip_binding_manager.get_statistics()
        self.send_event("ip-binding-statistics", stats)
        
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_ip_get_statistics: {e}", file=sys.stderr)


async def handle_ip_verify_binding(self, payload: Dict[str, Any]):
    """Handle ip-verify-binding command - Verify IP binding health"""
    try:
        if not self.ip_binding_manager:
            return
        
        account_id = payload.get("accountId")
        is_valid, error = await self.ip_binding_manager.verify_binding(account_id)
        
        self.send_event("ip-binding-verified", {
            "accountId": account_id,
            "isValid": is_valid,
            "error": error
        })
        
        if not is_valid:
            self.send_log(f"帳號 {account_id} 的 IP 綁定驗證失敗: {error}", "warning")
        
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_ip_verify_binding: {e}", file=sys.stderr)

