"""
Extracted handler implementations: qr_login
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


# ===================== QR Code Login Handlers =====================

async def handle_qr_login_create(self, payload: Dict[str, Any]):
    """Handle qr-login-create command - Create a new QR login session"""
    try:
        import sys
        print(f"[Backend] handle_qr_login_create called with payload: {payload}", file=sys.stderr)
        
        if not self.qr_auth_manager:
            # 提供更詳細的錯誤信息
            from qr_auth_manager import HAS_TELETHON, HAS_QRCODE
            missing_libs = []
            if not HAS_TELETHON:
                missing_libs.append("telethon")
            if not HAS_QRCODE:
                missing_libs.append("qrcode")
            
            if missing_libs:
                error_msg = f"QR 登入功能未啟用，缺少依賴庫: {', '.join(missing_libs)}。請運行: pip install telethon qrcode[pil]"
            else:
                error_msg = "QR 登入功能初始化失敗，請查看後端日誌了解詳情"
            
            print(f"[Backend] {error_msg} (HAS_TELETHON={HAS_TELETHON}, HAS_QRCODE={HAS_QRCODE})", file=sys.stderr)
            self.send_event("qr-login-error", {"error": error_msg})
            self.send_log(error_msg, "error")
            return
        
        proxy = payload.get("proxy") if isinstance(payload, dict) else None
        device_type = payload.get("deviceType") if isinstance(payload, dict) else None
        two_factor_password = payload.get("twoFactorPassword") if isinstance(payload, dict) else None
        
        # 獲取自定義 API 憑據（防封推薦）
        custom_api_id = payload.get("customApiId") if isinstance(payload, dict) else None
        custom_api_hash = payload.get("customApiHash") if isinstance(payload, dict) else None
        
        if custom_api_id and custom_api_hash:
            print(f"[Backend] Using CUSTOM API credentials (api_id={custom_api_id}) - Recommended for anti-ban", file=sys.stderr)
        else:
            print(f"[Backend] ⚠️ WARNING: No custom API credentials provided - Using PUBLIC API (HIGH BAN RISK!)", file=sys.stderr)
        
        print(f"[Backend] Calling qr_auth_manager.create_qr_login with proxy={proxy}, device_type={device_type}", file=sys.stderr)
        
        # 添加超時保護（60秒）
        try:
            result = await asyncio.wait_for(
                self.qr_auth_manager.create_qr_login(
                    proxy=proxy,
                    device_type=device_type,
                    two_factor_password=two_factor_password,
                    custom_api_id=custom_api_id,
                    custom_api_hash=custom_api_hash
                ),
                timeout=60.0
            )
        except asyncio.TimeoutError:
            error_msg = "創建 QR 登入超時（60秒），請檢查網絡連接或代理設置"
            print(f"[Backend] {error_msg}", file=sys.stderr)
            self.send_event("qr-login-error", {"error": error_msg})
            self.send_log(error_msg, "error")
            return
        
        print(f"[Backend] create_qr_login result: success={result.get('success')}, error={result.get('error', 'None')}", file=sys.stderr)
        
        if result.get("success"):
            print(f"[Backend] Sending qr-login-created event with sessionId={result.get('sessionId')}", file=sys.stderr)
            self.send_event("qr-login-created", result)
            self.send_log(f"QR 登入會話已創建，請掃描二維碼", "info")
        else:
            error_msg = result.get("error", "創建 QR 登入失敗")
            print(f"[Backend] QR login failed: {error_msg}", file=sys.stderr)
            self.send_event("qr-login-error", {"error": error_msg})
            self.send_log(f"創建 QR 登入失敗: {error_msg}", "error")
            
    except Exception as e:
        import sys
        import traceback
        error_msg = f"創建 QR 登入時發生錯誤: {str(e)}"
        print(f"[Backend] Error in handle_qr_login_create: {e}", file=sys.stderr)
        traceback.print_exc(file=sys.stderr)
        self.send_event("qr-login-error", {"error": error_msg})
        self.send_log(error_msg, "error")


async def handle_qr_login_status(self, payload: Dict[str, Any]):
    """Handle qr-login-status command - Get QR login session status"""
    try:
        if not self.qr_auth_manager:
            self.send_event("qr-login-status-result", {
                "success": False,
                "error": "QR 登入功能未啟用"
            })
            return
        
        session_id = payload.get("sessionId") if isinstance(payload, dict) else payload
        result = self.qr_auth_manager.get_session_status(session_id)
        self.send_event("qr-login-status-result", result)
        
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_qr_login_status: {e}", file=sys.stderr)
        self.send_event("qr-login-status-result", {"success": False, "error": str(e)})


async def handle_qr_login_refresh(self, payload: Dict[str, Any]):
    """Handle qr-login-refresh command - Refresh QR code"""
    try:
        if not self.qr_auth_manager:
            self.send_event("qr-login-error", {"error": "QR 登入功能未啟用"})
            return
        
        session_id = payload.get("sessionId") if isinstance(payload, dict) else payload
        result = await self.qr_auth_manager.refresh_qr_code(session_id)
        
        if result.get("success"):
            self.send_event("qr-login-refreshed", result)
        else:
            self.send_event("qr-login-error", {
                "sessionId": session_id,
                "error": result.get("error", "刷新 QR 碼失敗")
            })
            
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_qr_login_refresh: {e}", file=sys.stderr)
        self.send_event("qr-login-error", {"error": str(e)})


async def handle_qr_login_submit_2fa(self, payload: Dict[str, Any]):
    """Handle qr-login-submit-2fa command - Submit 2FA password"""
    try:
        if not self.qr_auth_manager:
            self.send_event("qr-login-error", {"error": "QR 登入功能未啟用"})
            return
        
        session_id = payload.get("sessionId")
        password = payload.get("password")
        
        if not session_id or not password:
            self.send_event("qr-login-error", {
                "sessionId": session_id,
                "error": "缺少會話 ID 或密碼"
            })
            return
        
        result = await self.qr_auth_manager.submit_2fa_password(session_id, password)
        
        if result.get("success"):
            self.send_event("qr-login-2fa-success", {
                "sessionId": session_id,
                "message": "二步驗證成功"
            })
        else:
            self.send_event("qr-login-error", {
                "sessionId": session_id,
                "error": result.get("error", "二步驗證失敗")
            })
            
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_qr_login_submit_2fa: {e}", file=sys.stderr)
        self.send_event("qr-login-error", {"error": str(e)})


async def handle_qr_login_cancel(self, payload: Dict[str, Any]):
    """Handle qr-login-cancel command - Cancel QR login session"""
    try:
        if not self.qr_auth_manager:
            return
        
        session_id = payload.get("sessionId") if isinstance(payload, dict) else payload
        result = await self.qr_auth_manager.cancel_session(session_id)
        
        self.send_event("qr-login-cancelled", {
            "sessionId": session_id,
            "message": "QR 登入已取消"
        })
        
    except Exception as e:
        import sys
        print(f"[Backend] Error in handle_qr_login_cancel: {e}", file=sys.stderr)

