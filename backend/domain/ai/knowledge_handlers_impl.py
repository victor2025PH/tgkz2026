"""
Extracted handler implementations: knowledge
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context
from database import db

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


# ==================== çŸ¥è­˜å­¸ç¿’åŠŸèƒ½ ====================

async def handle_learn_from_history(self, payload: Dict[str, Any]):
    """å¾æ­·å²å°è©±ä¸­å­¸ç¿’çŸ¥è­˜"""
    try:
        from knowledge_learner import knowledge_learner
        
        # åˆå§‹åŒ– - ğŸ”§ Phase 1 å„ªåŒ–ï¼šé»˜èªç¦ç”¨ç¥ç¶“ç¶²çµ¡åµŒå…¥
        await knowledge_learner.initialize(use_neural=False)
        
        user_id = payload.get('user_id')
        limit = payload.get('limit', 100)
        
        self.send_log("ğŸ“ é–‹å§‹å¾æ­·å²å°è©±å­¸ç¿’çŸ¥è­˜...", "info")
        
        total_learned = 0
        
        if user_id:
            # å­¸ç¿’ç‰¹å®šç”¨æˆ¶çš„å°è©±
            cursor = await db._connection.execute("""
                SELECT role, content, timestamp 
                FROM chat_history 
                WHERE user_id = ? 
                ORDER BY timestamp ASC
            """, (user_id,))
            rows = await cursor.fetchall()
            
            if rows:
                messages = [{'role': r['role'], 'content': r['content']} for r in rows]
                profile = await db.get_user_profile(user_id)
                outcome = profile.get('funnel_stage', 'new') if profile else 'new'
                
                result = await knowledge_learner.learn_from_conversation(
                    user_id=user_id,
                    messages=messages,
                    outcome=outcome
                )
                total_learned = result.get('total_knowledge', 0)
        else:
            # å­¸ç¿’æ‰€æœ‰æˆåŠŸå°è©±
            cursor = await db._connection.execute("""
                SELECT DISTINCT user_id, funnel_stage 
                FROM user_profiles 
                WHERE funnel_stage IN ('converted', 'interested', 'negotiating')
                LIMIT ?
            """, (limit,))
            users = await cursor.fetchall()
            
            for user in users:
                uid = user['user_id']
                outcome = user['funnel_stage']
                
                # ç²å–å°è©±æ­·å²
                msg_cursor = await db._connection.execute("""
                    SELECT role, content, timestamp 
                    FROM chat_history 
                    WHERE user_id = ? 
                    ORDER BY timestamp ASC
                    LIMIT 50
                """, (uid,))
                rows = await msg_cursor.fetchall()
                
                if rows:
                    messages = [{'role': r['role'], 'content': r['content']} for r in rows]
                    result = await knowledge_learner.learn_from_conversation(
                        user_id=uid,
                        messages=messages,
                        outcome=outcome
                    )
                    total_learned += result.get('total_knowledge', 0)
        
        self.send_log(f"âœ“ å­¸ç¿’å®Œæˆï¼Œå…±æå– {total_learned} æ¢çŸ¥è­˜", "success")
        self.send_event("learn-from-history-result", {
            'success': True,
            'total_learned': total_learned
        })
        
    except Exception as e:
        self.send_log(f"å­¸ç¿’å¤±æ•—: {e}", "error")
        self.send_event("learn-from-history-result", {
            'success': False,
            'error': str(e)
        })


async def handle_get_knowledge_stats(self):
    """ç²å–çŸ¥è­˜åº«çµ±è¨ˆ"""
    try:
        from knowledge_learner import knowledge_learner
        await knowledge_learner.initialize(use_neural=False)
        
        stats = await knowledge_learner.get_statistics()
        self.send_event("knowledge-stats", stats)
        
    except Exception as e:
        self.send_event("knowledge-stats", {'error': str(e)})


async def handle_search_knowledge(self, payload: Dict[str, Any]):
    """æœç´¢çŸ¥è­˜åº«"""
    try:
        from knowledge_learner import knowledge_learner
        await knowledge_learner.initialize(use_neural=False)
        
        query = payload.get('query', '')
        limit = payload.get('limit', 5)
        
        results = await knowledge_learner.search_knowledge(query, limit)
        
        self.send_event("knowledge-search-result", {
            'success': True,
            'query': query,
            'results': results
        })
        
    except Exception as e:
        self.send_event("knowledge-search-result", {
            'success': False,
            'error': str(e)
        })


async def handle_get_knowledge_gaps(self, payload: Dict[str, Any]):
    """ğŸ†• ç²å–çŸ¥è­˜ç¼ºå£"""
    status = payload.get('status', 'pending')
    
    try:
        from knowledge_learning import get_learning_service
        service = get_learning_service()
        
        gaps = await service.get_knowledge_gaps(status)
        
        self.send_event("knowledge-gaps", {
            "success": True,
            "gaps": gaps
        })
    except Exception as e:
        print(f"[Backend] Error getting knowledge gaps: {e}", file=sys.stderr)
        self.send_event("knowledge-gaps", {
            "success": False,
            "error": str(e)
        })


# ==================== Knowledge Base Handlers ====================

async def handle_init_knowledge_base(self):
    """Initialize knowledge base"""
    try:
        await search_engine.initialize()
        stats = await search_engine.get_stats()
        
        self.send_event("knowledge-base-initialized", {
            "success": True,
            "stats": stats
        })
        self.send_log("çŸ¥è­˜åº«åˆå§‹åŒ–æˆåŠŸ", "success")
    except Exception as e:
        self.send_event("knowledge-base-initialized", {
            "success": False,
            "error": str(e)
        })
        self.send_log(f"çŸ¥è­˜åº«åˆå§‹åŒ–å¤±æ•—: {str(e)}", "error")


async def handle_get_knowledge_stats(self):
    """Get knowledge base statistics"""
    try:
        stats = await search_engine.get_stats()
        self.send_event("knowledge-stats", {
            "success": True,
            "stats": stats
        })
    except Exception as e:
        self.send_event("knowledge-stats", {
            "success": False,
            "error": str(e)
        })


async def handle_add_document(self, payload: Dict[str, Any]):
    """Add a document to knowledge base"""
    try:
        file_path = payload.get('filePath')
        title = payload.get('title')
        category = payload.get('category', 'general')
        tags = payload.get('tags', [])
        content = payload.get('content')  # For direct text input
        
        if content and title:
            result = await document_manager.add_document_from_text(
                title=title,
                content=content,
                category=category,
                tags=tags
            )
        elif file_path:
            result = await document_manager.add_document(
                file_path=file_path,
                title=title,
                category=category,
                tags=tags
            )
        else:
            result = {"success": False, "error": "No file or content provided"}
        
        self.send_event("document-added", result)
        if result.get('success'):
            self.send_log(f"æ–‡æª”å·²æ·»åŠ : {result.get('title')}", "success")
    except Exception as e:
        self.send_event("document-added", {
            "success": False,
            "error": str(e)
        })


async def handle_add_knowledge_base(self, payload: Dict[str, Any]):
    """ğŸ†• æ·»åŠ çŸ¥è­˜åº«"""
    import sys
    print(f"[Backend] handle_add_knowledge_base called with: {payload}", file=sys.stderr)
    
    try:
        # ğŸ”§ FIX: ä¿ç•™å‰ç«¯å‚³å…¥çš„ ID
        frontend_id = payload.get('id', '')
        name = payload.get('name', '')
        description = payload.get('description', '')
        category = payload.get('category', 'general')
        
        if not name:
            self.send_event("knowledge-base-added", {
                "success": False,
                "error": "çŸ¥è­˜åº«åç¨±ä¸èƒ½ç‚ºç©º"
            })
            return
        
        # ğŸ”§ ç¢ºä¿çŸ¥è­˜åº«è¡¨å­˜åœ¨
        await db._ensure_knowledge_tables()
        
        # æ·»åŠ åˆ°æ•¸æ“šåº«
        print(f"[Backend] Adding knowledge item: {name}", file=sys.stderr)
        db_id = await db.add_knowledge_item(
            title=f"[çŸ¥è­˜åº«] {name}",
            content=description or f"çŸ¥è­˜åº«ï¼š{name}",
            category=category,
            priority=1
        )
        
        print(f"[Backend] Knowledge item added with db_id: {db_id}, frontend_id: {frontend_id}", file=sys.stderr)
        
        # ğŸ”§ FIX: è¿”å›å‰ç«¯å‚³å…¥çš„ IDï¼Œä¿æŒä¸€è‡´æ€§
        self.send_event("knowledge-base-added", {
            "success": True,
            "id": frontend_id or f"kb_{db_id}",
            "dbId": db_id,
            "name": name
        })
        self.send_log(f"âœ“ çŸ¥è­˜åº«ã€Œ{name}ã€å·²å‰µå»º", "success")
        
    except Exception as e:
        import traceback
        print(f"[Backend] Error in handle_add_knowledge_base: {e}", file=sys.stderr)
        traceback.print_exc(file=sys.stderr)
        self.send_event("knowledge-base-added", {
            "success": False,
            "error": str(e)
        })


async def handle_add_knowledge_item(self, payload: Dict[str, Any]):
    """ğŸ†• æ·»åŠ çŸ¥è­˜åº«æ¢ç›®"""
    try:
        title = payload.get('title', '')
        content = payload.get('content', '')
        category = payload.get('category', 'general')
        keywords = payload.get('keywords', '')
        priority = payload.get('priority', 1)
        
        if not title or not content:
            self.send_event("knowledge-item-added", {
                "success": False,
                "error": "æ¨™é¡Œå’Œå…§å®¹ä¸èƒ½ç‚ºç©º"
            })
            return
        
        item_id = await db.add_knowledge_item(
            title=title,
            content=content,
            category=category,
            keywords=keywords,
            priority=priority
        )
        
        self.send_event("knowledge-item-added", {
            "success": True,
            "id": item_id,
            "title": title
        })
        self.send_log(f"âœ“ çŸ¥è­˜æ¢ç›®ã€Œ{title}ã€å·²æ·»åŠ ", "success")
        
    except Exception as e:
        import traceback
        traceback.print_exc(file=sys.stderr)
        self.send_event("knowledge-item-added", {
            "success": False,
            "error": str(e)
        })


async def handle_get_knowledge_items(self, payload: Dict[str, Any]):
    """ğŸ†• ç²å–çŸ¥è­˜åº«æ¢ç›®åˆ—è¡¨"""
    try:
        category = payload.get('category')
        active_only = payload.get('activeOnly', True)
        
        items = await db.get_knowledge_items(category=category, active_only=active_only)
        
        self.send_event("knowledge-items", {
            "success": True,
            "items": items
        })
        
    except Exception as e:
        import traceback
        traceback.print_exc(file=sys.stderr)
        self.send_event("knowledge-items", {
            "success": False,
            "items": [],
            "error": str(e)
        })


async def handle_ai_generate_knowledge(self, payload: Dict[str, Any]):
    """ğŸ†• AI è‡ªå‹•ç”ŸæˆçŸ¥è­˜åº«å…§å®¹"""
    import sys
    print(f"[Backend] handle_ai_generate_knowledge called with: {payload}", file=sys.stderr)
    
    try:
        kb_id = payload.get('kbId', '')
        business_desc = payload.get('businessDescription', '')
        
        if not business_desc:
            self.send_event("ai-knowledge-generated", {
                "success": False,
                "error": "è«‹æä¾›æ¥­å‹™æè¿°"
            })
            return
        
        # æ§‹å»ºç”ŸæˆçŸ¥è­˜çš„ prompt
        prompt = f"""è«‹æ ¹æ“šä»¥ä¸‹æ¥­å‹™æè¿°ï¼Œç”Ÿæˆçµæ§‹åŒ–çš„çŸ¥è­˜åº«å…§å®¹ã€‚

æ¥­å‹™æè¿°ï¼š{business_desc}

è«‹ç”Ÿæˆä»¥ä¸‹é¡åˆ¥çš„çŸ¥è­˜ï¼ˆæ¯å€‹é¡åˆ¥ 3-5 æ¢ï¼‰ï¼š

1. ã€ç”¢å“çŸ¥è­˜ã€‘- é—œæ–¼ç”¢å“/æœå‹™çš„è©³ç´°ä¿¡æ¯
2. ã€å¸¸è¦‹å•ç­”ã€‘- å®¢æˆ¶å¸¸å•çš„å•é¡Œå’Œæ¨™æº–ç­”æ¡ˆï¼ˆQ: å•é¡Œ A: ç­”æ¡ˆ æ ¼å¼ï¼‰
3. ã€éŠ·å”®è©±è¡“ã€‘- æ¨éŠ·å’Œèªªæœå®¢æˆ¶çš„è©±è¡“
4. ã€ç•°è­°è™•ç†ã€‘- è™•ç†å®¢æˆ¶ç–‘æ…®å’Œç•°è­°çš„å›æ‡‰

è«‹ä»¥ JSON æ ¼å¼è¿”å›ï¼Œçµæ§‹å¦‚ä¸‹ï¼š
{{
  "items": [
{{"category": "product", "title": "æ¨™é¡Œ", "content": "è©³ç´°å…§å®¹"}},
{{"category": "faq", "title": "Q: å•é¡Œ", "content": "A: ç­”æ¡ˆ"}},
{{"category": "sales", "title": "è©±è¡“æ¨™é¡Œ", "content": "è©±è¡“å…§å®¹"}},
{{"category": "objection", "title": "ç•°è­°é¡å‹", "content": "è™•ç†æ–¹å¼"}}
  ]
}}

åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚"""
        
        # ä½¿ç”¨ AI ç”Ÿæˆ
        if ai_auto_chat and hasattr(ai_auto_chat, '_generate_response_with_prompt'):
            response = await ai_auto_chat._generate_response_with_prompt(
                user_id="system",
                user_message=prompt,
                custom_prompt="ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ¥­å‹™çŸ¥è­˜ç”ŸæˆåŠ©æ‰‹ï¼Œæ“…é•·ç‚ºå„é¡æ¥­å‹™ç”Ÿæˆçµæ§‹åŒ–çš„çŸ¥è­˜åº«å…§å®¹ã€‚è«‹åªè¿”å› JSON æ ¼å¼çš„çµæœã€‚",
                usage_type="knowledge"
            )
        else:
            # Fallback: ä½¿ç”¨é»˜èªçš„çŸ¥è­˜æ¨¡æ¿
            response = self._generate_default_knowledge(business_desc)
        
        # è§£æ AI éŸ¿æ‡‰
        items = self._parse_ai_knowledge_response(response)
        
        if items:
            # ä¿å­˜åˆ°æ•¸æ“šåº«
            for item in items:
                await db.add_knowledge_item(
                    title=item.get('title', ''),
                    content=item.get('content', ''),
                    category=item.get('category', 'custom'),
                    priority=1
                )
            
            print(f"[Backend] AI generated {len(items)} knowledge items", file=sys.stderr)
            
            self.send_event("ai-knowledge-generated", {
                "success": True,
                "kbId": kb_id,
                "items": items,
                "count": len(items)
            })
            self.send_log(f"âœ¨ AI å·²ç”Ÿæˆ {len(items)} æ¢çŸ¥è­˜", "success")
        else:
            self.send_event("ai-knowledge-generated", {
                "success": False,
                "error": "AI ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦"
            })
            
    except Exception as e:
        import traceback
        print(f"[Backend] Error in handle_ai_generate_knowledge: {e}", file=sys.stderr)
        traceback.print_exc(file=sys.stderr)
        self.send_event("ai-knowledge-generated", {
            "success": False,
            "error": str(e)
        })


async def handle_apply_industry_template(self, payload: Dict[str, Any]):
    """ğŸ†• æ‡‰ç”¨è¡Œæ¥­æ¨¡æ¿"""
    import sys
    print(f"[Backend] handle_apply_industry_template called with: {payload}", file=sys.stderr)
    
    try:
        kb_id = payload.get('kbId', '')
        template_id = payload.get('templateId', '')
        
        # è¡Œæ¥­æ¨¡æ¿å®šç¾©
        templates = {
            'payment': {
                'name': 'è·¨å¢ƒæ”¯ä»˜',
                'items': [
                    {'category': 'product', 'title': 'Uå…Œæ›æœå‹™', 'content': 'æˆ‘å€‘æä¾› USDT å…Œæ›äººæ°‘å¹£æœå‹™ï¼ŒåŒ¯ç‡å¯¦æ™‚æ›´æ–°ï¼Œåˆ°è³¬å¿«é€Ÿå®‰å…¨ã€‚'},
                    {'category': 'product', 'title': 'ä»£æ”¶ä»£ä»˜', 'content': 'æ”¯æŒå¾®ä¿¡ã€æ”¯ä»˜å¯¶ã€éŠ€è¡Œå¡å¤šç¨®æ”¶ä»˜æ¬¾æ–¹å¼ï¼Œæ‰‹çºŒè²»ä½å»‰ã€‚'},
                    {'category': 'product', 'title': 'æœå‹™æ™‚é–“', 'content': 'æˆ‘å€‘æä¾› 24 å°æ™‚åœ¨ç·šå®¢æœï¼Œéš¨æ™‚ç‚ºæ‚¨è§£ç­”å•é¡Œã€‚'},
                    {'category': 'faq', 'title': 'Q: å¤šä¹…åˆ°è³¬ï¼Ÿ', 'content': 'A: é€šå¸¸ 5-30 åˆ†é˜å…§åˆ°è³¬ï¼Œå¤§é¡å¯èƒ½éœ€è¦ 1-2 å°æ™‚ã€‚'},
                    {'category': 'faq', 'title': 'Q: æœ€ä½å…Œæ›é‡‘é¡ï¼Ÿ', 'content': 'A: æœ€ä½ 100 USDT èµ·å…Œï¼Œæœ€é«˜ä¸é™ã€‚'},
                    {'category': 'faq', 'title': 'Q: åŒ¯ç‡æ€éº¼ç®—ï¼Ÿ', 'content': 'A: å¯¦æ™‚åŒ¯ç‡ï¼Œä»¥äº¤æ˜“ç¢ºèªæ™‚çš„åƒ¹æ ¼ç‚ºæº–ã€‚'},
                    {'category': 'sales', 'title': 'å„ªå‹¢ä»‹ç´¹', 'content': 'æˆ‘å€‘çš„åŒ¯ç‡æ¯”å¸‚å ´å¹³å‡é«˜ 0.3-0.5%ï¼Œè€Œä¸”åˆ°è³¬é€Ÿåº¦å¿«ï¼Œå·²æœå‹™è¶…é 10 è¬å®¢æˆ¶ã€‚'},
                    {'category': 'sales', 'title': 'å¼•å°ä¸‹å–®', 'content': 'ç¾åœ¨ä¸‹å–®é‚„æœ‰å„ªæƒ å“¦ï¼Œæ‚¨è¦å…Œæ›å¤šå°‘ï¼Ÿæˆ‘å¹«æ‚¨è¨ˆç®—ä¸€ä¸‹ã€‚'},
                    {'category': 'objection', 'title': 'æ“”å¿ƒå®‰å…¨', 'content': 'æˆ‘å€‘å·²ç¶“é‹ç‡Ÿ 3 å¹´å¤šï¼Œå¾æœªå‡ºç¾éè³‡é‡‘å•é¡Œï¼Œæ‚¨å¯ä»¥å…ˆå°é¡é«”é©—ã€‚'},
                    {'category': 'objection', 'title': 'è¦ºå¾—è²´', 'content': 'æˆ‘å€‘çš„åƒ¹æ ¼å·²ç¶“å¾ˆå„ªæƒ äº†ï¼Œè€Œä¸”ä¿è­‰è³‡é‡‘å®‰å…¨å’Œåˆ°è³¬é€Ÿåº¦ã€‚'}
                ]
            },
            'ecommerce': {
                'name': 'é›»å•†é›¶å”®',
                'items': [
                    {'category': 'product', 'title': 'å•†å“å“è³ª', 'content': 'æ‰€æœ‰å•†å“å‡ç‚ºæ­£å“ä¿è­‰ï¼Œæ”¯æŒä¸ƒå¤©ç„¡ç†ç”±é€€æ›ã€‚'},
                    {'category': 'product', 'title': 'é…é€æœå‹™', 'content': 'å…¨åœ‹åŒ…éƒµï¼Œä¸€èˆ¬ 3-5 å¤©é€é”ï¼Œéƒ¨åˆ†åœ°å€å¯æ¬¡æ—¥é”ã€‚'},
                    {'category': 'faq', 'title': 'Q: å¦‚ä½•ä¸‹å–®ï¼Ÿ', 'content': 'A: é¸æ“‡å•†å“å¾Œç›´æ¥ä¸‹å–®ï¼Œæ”¯æŒå¾®ä¿¡ã€æ”¯ä»˜å¯¶ä»˜æ¬¾ã€‚'},
                    {'category': 'faq', 'title': 'Q: å¯ä»¥é€€è²¨å—ï¼Ÿ', 'content': 'A: æ”¯æŒä¸ƒå¤©ç„¡ç†ç”±é€€æ›ï¼Œé‹è²»æˆ‘å€‘æ‰¿æ“”ã€‚'},
                    {'category': 'sales', 'title': 'ä¿ƒéŠ·æ´»å‹•', 'content': 'ç¾åœ¨ä¸‹å–®æ»¿ 199 æ¸› 20ï¼Œé‚„æœ‰æ›´å¤šå„ªæƒ ç­‰æ‚¨ç™¼ç¾ï¼'},
                    {'category': 'objection', 'title': 'åƒ¹æ ¼ç•°è­°', 'content': 'æˆ‘å€‘æ˜¯å» å®¶ç›´éŠ·ï¼Œåƒ¹æ ¼å·²ç¶“å¾ˆå„ªæƒ äº†ï¼Œå“è³ªæœ‰ä¿éšœã€‚'}
                ]
            },
            'education': {
                'name': 'åœ¨ç·šæ•™è‚²',
                'items': [
                    {'category': 'product', 'title': 'èª²ç¨‹ä»‹ç´¹', 'content': 'æˆ‘å€‘æä¾›å°ˆæ¥­çš„åœ¨ç·šèª²ç¨‹ï¼Œç”±è³‡æ·±è¬›å¸«æˆèª²ï¼Œéš¨æ™‚éš¨åœ°å­¸ç¿’ã€‚'},
                    {'category': 'product', 'title': 'å­¸ç¿’æ”¯æŒ', 'content': 'é…å‚™å°ˆå±¬å­¸ç¿’é¡§å•ï¼Œèª²å¾Œç­”ç–‘ï¼Œç¢ºä¿å­¸ç¿’æ•ˆæœã€‚'},
                    {'category': 'faq', 'title': 'Q: èª²ç¨‹æœ‰æ•ˆæœŸï¼Ÿ', 'content': 'A: è³¼è²·å¾Œæ°¸ä¹…æœ‰æ•ˆï¼Œå¯åè¦†è§€çœ‹å­¸ç¿’ã€‚'},
                    {'category': 'faq', 'title': 'Q: å¯ä»¥è©¦è½å—ï¼Ÿ', 'content': 'A: å¯ä»¥ï¼Œæˆ‘å€‘æä¾›å…è²»è©¦è½èª²ç¨‹ï¼Œæ»¿æ„å¾Œå†è³¼è²·ã€‚'},
                    {'category': 'sales', 'title': 'èª²ç¨‹æ¨è–¦', 'content': 'é€™é–€èª²ç¨‹æ˜¯æˆ‘å€‘çš„æ˜æ˜Ÿèª²ç¨‹ï¼Œå·²å¹«åŠ©æ•¸è¬å­¸å“¡æå‡æŠ€èƒ½ã€‚'},
                    {'category': 'objection', 'title': 'æ²’æ™‚é–“å­¸', 'content': 'æˆ‘å€‘çš„èª²ç¨‹æ”¯æŒç¢ç‰‡åŒ–å­¸ç¿’ï¼Œæ¯å¤© 15 åˆ†é˜å°±èƒ½æœ‰æ”¶ç©«ã€‚'}
                ]
            },
            'realestate': {
                'name': 'æˆ¿ç”¢ä¸­ä»‹',
                'items': [
                    {'category': 'product', 'title': 'æˆ¿æºä»‹ç´¹', 'content': 'æˆ‘å€‘æœ‰è±å¯Œçš„æˆ¿æºè³‡æºï¼Œæ¶µè“‹æ–°æˆ¿ã€äºŒæ‰‹æˆ¿ã€ç§Ÿæˆ¿ç­‰ã€‚'},
                    {'category': 'faq', 'title': 'Q: çœ‹æˆ¿éœ€è¦è²»ç”¨å—ï¼Ÿ', 'content': 'A: çœ‹æˆ¿å®Œå…¨å…è²»ï¼Œæˆäº¤å¾Œæ‰æ”¶å–æœå‹™è²»ã€‚'},
                    {'category': 'sales', 'title': 'æ¨è–¦æˆ¿æº', 'content': 'æ ¹æ“šæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘æ¨è–¦é€™å¥—æˆ¿å­ï¼Œä½ç½®å¥½ã€åƒ¹æ ¼åˆé©ã€‚'},
                    {'category': 'objection', 'title': 'åƒ¹æ ¼å¤ªé«˜', 'content': 'é€™å€‹åƒ¹æ ¼åœ¨é€™å€‹åœ°æ®µå·²ç¶“å¾ˆå„ªæƒ äº†ï¼Œè€Œä¸”é‚„æœ‰è«‡åƒ¹ç©ºé–“ã€‚'}
                ]
            },
            'finance': {
                'name': 'é‡‘èç†è²¡',
                'items': [
                    {'category': 'product', 'title': 'ç†è²¡ç”¢å“', 'content': 'æˆ‘å€‘æä¾›å¤šç¨®ç†è²¡ç”¢å“ï¼Œæ”¶ç›Šç©©å¥ï¼Œé¢¨éšªå¯æ§ã€‚'},
                    {'category': 'faq', 'title': 'Q: æ”¶ç›Šç‡å¤šå°‘ï¼Ÿ', 'content': 'A: æ ¹æ“šç”¢å“ä¸åŒï¼Œå¹´åŒ–æ”¶ç›Š 3%-8% ä¸ç­‰ã€‚'},
                    {'category': 'sales', 'title': 'ç”¢å“æ¨è–¦', 'content': 'æ¨è–¦é€™æ¬¾ç©©å¥å‹ç†è²¡ï¼Œé©åˆæ‚¨çš„é¢¨éšªåå¥½ã€‚'},
                    {'category': 'objection', 'title': 'æ“”å¿ƒé¢¨éšª', 'content': 'é€™æ¬¾ç”¢å“é¢¨éšªç­‰ç´šè¼ƒä½ï¼Œæœ¬é‡‘æœ‰ä¿éšœã€‚'}
                ]
            },
            'healthcare': {
                'name': 'é†«ç™‚å¥åº·',
                'items': [
                    {'category': 'product', 'title': 'æœå‹™ä»‹ç´¹', 'content': 'æˆ‘å€‘æä¾›å°ˆæ¥­çš„å¥åº·è«®è©¢å’Œé ç´„æ›è™Ÿæœå‹™ã€‚'},
                    {'category': 'faq', 'title': 'Q: å¦‚ä½•é ç´„ï¼Ÿ', 'content': 'A: æ‚¨å¯ä»¥ç›´æ¥å‘Šè¨´æˆ‘éœ€è¦çš„ç§‘å®¤å’Œæ™‚é–“ï¼Œæˆ‘å¹«æ‚¨é ç´„ã€‚'},
                    {'category': 'sales', 'title': 'æœå‹™æ¨è–¦', 'content': 'å»ºè­°æ‚¨åšä¸€å€‹å…¨é¢é«”æª¢ï¼Œæ—©ç™¼ç¾æ—©æ²»ç™‚ã€‚'}
                ]
            },
            'travel': {
                'name': 'æ—…éŠæœå‹™',
                'items': [
                    {'category': 'product', 'title': 'æœå‹™å…§å®¹', 'content': 'æˆ‘å€‘æä¾›æ©Ÿç¥¨ã€é…’åº—ã€è¡Œç¨‹è¦åŠƒä¸€ç«™å¼æœå‹™ã€‚'},
                    {'category': 'faq', 'title': 'Q: å¯ä»¥å®šåˆ¶è¡Œç¨‹å—ï¼Ÿ', 'content': 'A: å¯ä»¥ï¼Œæˆ‘å€‘æä¾›å€‹æ€§åŒ–å®šåˆ¶æœå‹™ã€‚'},
                    {'category': 'sales', 'title': 'ç·šè·¯æ¨è–¦', 'content': 'é€™æ¢ç·šè·¯å¾ˆå—æ­¡è¿ï¼Œé¢¨æ™¯å„ªç¾ï¼Œåƒ¹æ ¼å¯¦æƒ ã€‚'}
                ]
            },
            'legal': {
                'name': 'æ³•å¾‹è«®è©¢',
                'items': [
                    {'category': 'product', 'title': 'æœå‹™ç¯„åœ', 'content': 'æˆ‘å€‘æä¾›æ°‘äº‹ã€å•†äº‹ã€åˆ‘äº‹ç­‰å„é¡æ³•å¾‹è«®è©¢æœå‹™ã€‚'},
                    {'category': 'faq', 'title': 'Q: è«®è©¢æ”¶è²»å—ï¼Ÿ', 'content': 'A: åˆæ¬¡è«®è©¢å…è²»ï¼Œå¾ŒçºŒæœå‹™æ ¹æ“šæ¡ˆä»¶è¤‡é›œç¨‹åº¦å ±åƒ¹ã€‚'},
                    {'category': 'sales', 'title': 'æœå‹™æ¨è–¦', 'content': 'å»ºè­°æ‚¨å…ˆæè¿°ä¸€ä¸‹æƒ…æ³ï¼Œæˆ‘å€‘çš„å¾‹å¸«æœƒçµ¦æ‚¨å°ˆæ¥­å»ºè­°ã€‚'}
                ]
            }
        }
        
        template = templates.get(template_id)
        if not template:
            self.send_event("industry-template-applied", {
                "success": False,
                "error": f"æœªæ‰¾åˆ°æ¨¡æ¿: {template_id}"
            })
            return
        
        # ä¿å­˜åˆ°æ•¸æ“šåº«
        for item in template['items']:
            await db.add_knowledge_item(
                title=item['title'],
                content=item['content'],
                category=item['category'],
                priority=1
            )
        
        self.send_event("industry-template-applied", {
            "success": True,
            "kbId": kb_id,
            "templateId": template_id,
            "templateName": template['name'],
            "items": template['items']
        })
        self.send_log(f"ğŸ“š å·²æ‡‰ç”¨ã€Œ{template['name']}ã€æ¨¡æ¿", "success")
        
    except Exception as e:
        import traceback
        traceback.print_exc(file=sys.stderr)
        self.send_event("industry-template-applied", {
            "success": False,
            "error": str(e)
        })


async def handle_learn_from_chat_history(self, payload: Dict[str, Any]):
    """ğŸ†• å¾èŠå¤©è¨˜éŒ„å­¸ç¿’"""
    import sys
    print(f"[Backend] handle_learn_from_chat_history called with: {payload}", file=sys.stderr)
    
    try:
        kb_id = payload.get('kbId', '')
        days = payload.get('days', 7)
        
        # å¾æ•¸æ“šåº«ç²å–èŠå¤©è¨˜éŒ„
        from datetime import datetime, timedelta
        start_date = datetime.now() - timedelta(days=days)
        
        # ç²å–æœ€è¿‘çš„å„ªè³ªå›è¦†
        effective_responses = await db.get_effective_responses(
            min_score=0.7,
            limit=20
        ) if hasattr(db, 'get_effective_responses') else []
        
        if not effective_responses:
            self.send_event("chat-learning-complete", {
                "success": True,
                "kbId": kb_id,
                "items": [],
                "message": "æœªç™¼ç¾å¯å­¸ç¿’çš„å„ªè³ªå›è¦†"
            })
            return
        
        # è½‰æ›ç‚ºçŸ¥è­˜æ¢ç›®
        items = []
        for resp in effective_responses[:10]:  # æœ€å¤šå– 10 æ¢
            items.append({
                'category': 'custom',
                'title': f"å„ªè³ªå›è¦† - {resp.get('context', '')[:20]}...",
                'content': resp.get('response', '')
            })
            
            # ä¿å­˜åˆ°æ•¸æ“šåº«
            await db.add_knowledge_item(
                title=items[-1]['title'],
                content=items[-1]['content'],
                category='custom',
                priority=2  # å­¸ç¿’çš„çŸ¥è­˜å„ªå…ˆç´šç¨é«˜
            )
        
        self.send_event("chat-learning-complete", {
            "success": True,
            "kbId": kb_id,
            "items": items,
            "count": len(items)
        })
        self.send_log(f"ğŸ’¬ å¾èŠå¤©è¨˜éŒ„å­¸ç¿’äº† {len(items)} æ¢çŸ¥è­˜", "success")
        
    except Exception as e:
        import traceback
        traceback.print_exc(file=sys.stderr)
        self.send_event("chat-learning-complete", {
            "success": False,
            "error": str(e)
        })


async def handle_get_documents(self, payload: Dict[str, Any]):
    """Get all documents"""
    try:
        category = payload.get('category')
        documents = await document_manager.get_all_documents(category)
        
        self.send_event("documents-list", {
            "success": True,
            "documents": documents
        })
    except Exception as e:
        self.send_event("documents-list", {
            "success": False,
            "error": str(e)
        })


async def handle_delete_document(self, payload: Dict[str, Any]):
    """Delete a document"""
    try:
        doc_id = payload.get('id')
        await document_manager.delete_document(doc_id)
        
        self.send_event("document-deleted", {"success": True, "id": doc_id})
        self.send_log("æ–‡æª”å·²åˆªé™¤", "success")
    except Exception as e:
        self.send_event("document-deleted", {
            "success": False,
            "error": str(e)
        })


async def handle_search_knowledge(self, payload: Dict[str, Any]):
    """Search knowledge base"""
    try:
        query = payload.get('query', '')
        include_docs = payload.get('includeDocs', True)
        include_images = payload.get('includeImages', True)
        include_videos = payload.get('includeVideos', True)
        limit = payload.get('limit', 10)
        
        results = await search_engine.search(
            query=query,
            include_docs=include_docs,
            include_images=include_images,
            include_videos=include_videos,
            limit=limit
        )
        
        self.send_event("knowledge-search-results", {
            "success": True,
            "query": query,
            "results": results
        })
    except Exception as e:
        self.send_event("knowledge-search-results", {
            "success": False,
            "error": str(e)
        })

