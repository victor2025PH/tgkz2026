"""
Extracted handler implementations: memory
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


# ==================== Vector Memory Handlers ====================

async def handle_add_vector_memory(self, payload: Dict[str, Any]):
    """添加向量記憶"""
    try:
        user_id = payload.get('userId', '')
        content = payload.get('content', '')
        memory_type = payload.get('type', 'conversation')
        importance = payload.get('importance', 0.5)
        
        memory_id = await vector_memory.add_memory(
            user_id=user_id,
            content=content,
            memory_type=memory_type,
            importance=importance
        )
        
        self.send_event("memory-added", {
            "success": True,
            "memoryId": memory_id
        })
    except Exception as e:
        self.send_event("memory-added", {
            "success": False,
            "error": str(e)
        })


async def handle_search_vector_memories(self, payload: Dict[str, Any]):
    """搜索向量記憶"""
    try:
        user_id = payload.get('userId', '')
        query = payload.get('query', '')
        limit = payload.get('limit', 5)
        memory_type = payload.get('type')
        
        memories = await vector_memory.search_memories(
            user_id=user_id,
            query=query,
            limit=limit,
            memory_type=memory_type
        )
        
        self.send_event("memories-searched", {
            "success": True,
            "memories": memories
        })
    except Exception as e:
        self.send_event("memories-searched", {
            "success": False,
            "error": str(e)
        })


async def handle_get_memory_context(self, payload: Dict[str, Any]):
    """獲取記憶上下文"""
    try:
        user_id = payload.get('userId', '')
        message = payload.get('message', '')
        max_tokens = payload.get('maxTokens', 1500)
        
        context = await vector_memory.build_context_from_memory(
            user_id=user_id,
            current_message=message,
            max_tokens=max_tokens
        )
        
        self.send_event("memory-context", {
            "success": True,
            "context": context
        })
    except Exception as e:
        self.send_event("memory-context", {
            "success": False,
            "error": str(e)
        })


async def handle_get_memory_stats(self, payload: Dict[str, Any]):
    """獲取記憶統計"""
    try:
        user_id = payload.get('userId', '')
        stats = await vector_memory.get_user_memory_stats(user_id)
        
        self.send_event("memory-stats", {
            "success": True,
            "userId": user_id,
            **stats
        })
    except Exception as e:
        self.send_event("memory-stats", {
            "success": False,
            "error": str(e)
        })

