"""
Extracted handler implementations: campaigns
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


async def handle_add_campaign(self, payload: Dict[str, Any]):
    """Handle add-campaign command"""
    try:
        # Validate campaign data
        is_valid, errors = validate_campaign(payload)
        if not is_valid:
            error_message = "Validation failed: " + "; ".join(errors)
            self.send_log(error_message, "error")
            self.send_event("campaign-validation-error", {
                "errors": errors,
                "campaign_data": payload
            })
            handle_error(
                AppError(ErrorType.VALIDATION_ERROR, error_message, {"errors": errors}),
                {"command": "add-campaign", "payload": payload}
            )
            return
        
        # 檢查活動是否已存在
        campaign_name = payload.get('name', '').strip()
        existing_campaigns = await db.get_all_campaigns()
        existing = next((c for c in existing_campaigns if c.get('name') == campaign_name), None)
        
        if existing:
            # 活動已存在，發送警告事件
            self.send_log(f"Campaign '{campaign_name}' already exists (ID: {existing.get('id')})", "warning")
            self.send_event("campaign-already-exists", {
                "campaignId": existing.get('id'),
                "name": campaign_name,
                "message": f"活動 '{campaign_name}' 已存在，未創建重複活動"
            })
            # 仍然發送更新事件以確保前端狀態同步
            await self.send_campaigns_update()
            return
        
        campaign_id = await db.add_campaign(payload)
        await db.add_log(f"Campaign '{campaign_name}' added", "success")
        await self.send_campaigns_update()
    
    except ValidationError as e:
        self.send_log(f"Validation error: {e.message}", "error")
        self.send_event("campaign-validation-error", {
            "errors": [e.message],
            "field": e.field
        })
    except Exception as e:
        self.send_log(f"Error adding campaign: {str(e)}", "error")
        handle_error(e, {"command": "add-campaign", "payload": payload})
        # 即使出錯，也發送更新事件以確保前端狀態同步
        try:
            await self.send_campaigns_update()
        except:
            pass


async def handle_remove_campaign(self, payload: Dict[str, Any]):
    """Handle remove-campaign command"""
    try:
        campaign_id = payload.get('id')
        await db.remove_campaign(campaign_id)
        await db.add_log(f"Campaign {campaign_id} removed", "success")
        await self.send_campaigns_update()
    
    except Exception as e:
        self.send_log(f"Error removing campaign: {str(e)}", "error")


async def handle_toggle_campaign_status(self, payload: Dict[str, Any]):
    """Handle toggle-campaign-status command"""
    try:
        campaign_id = payload.get('id')
        await db.toggle_campaign_status(campaign_id)
        await db.add_log(f"Campaign {campaign_id} status toggled", "success")
        await self.send_campaigns_update()
    
    except Exception as e:
        self.send_log(f"Error toggling campaign status: {str(e)}", "error")


async def handle_get_campaign_performance_stats(self, payload: Dict[str, Any]):
    """Handle get-campaign-performance-stats command"""
    try:
        days = payload.get('days', 7)
        
        stats = await db.get_campaign_performance_stats(days)
        self.send_event("campaign-performance-stats", {"stats": stats, "days": days})
    except Exception as e:
        handle_error(e, {"command": "get-campaign-performance-stats", "payload": payload})
        self.send_log(f"Error getting campaign performance stats: {str(e)}", "error")


async def handle_get_campaigns(self, payload: Dict[str, Any]):
    """獲取營銷活動列表"""
    try:
        orchestrator = get_campaign_orchestrator()
        if not orchestrator:
            self.send_event("campaigns", {"success": False, "error": "營銷活動系統未初始化"})
            return
        
        result = await orchestrator.get_all_campaigns(
            status=payload.get('status'),
            limit=payload.get('limit', 50),
            offset=payload.get('offset', 0)
        )
        
        self.send_event("campaigns", result)
        
    except Exception as e:
        self.send_event("campaigns", {"success": False, "error": str(e)})


async def handle_get_campaign(self, payload: Dict[str, Any]):
    """獲取單個營銷活動"""
    try:
        orchestrator = get_campaign_orchestrator()
        if not orchestrator:
            self.send_event("campaign", {"success": False, "error": "營銷活動系統未初始化"})
            return
        
        campaign = await orchestrator.get_campaign(payload.get('campaignId'))
        
        if campaign:
            self.send_event("campaign", {"success": True, "campaign": campaign.to_dict()})
        else:
            self.send_event("campaign", {"success": False, "error": "活動不存在"})
        
    except Exception as e:
        self.send_event("campaign", {"success": False, "error": str(e)})


async def handle_get_campaign_logs(self, payload: Dict[str, Any]):
    """獲取營銷活動日誌"""
    try:
        orchestrator = get_campaign_orchestrator()
        if not orchestrator:
            self.send_event("campaign-logs", {"success": False, "error": "營銷活動系統未初始化"})
            return
        
        result = await orchestrator.get_campaign_logs(
            campaign_id=payload.get('campaignId'),
            limit=payload.get('limit', 50)
        )
        
        self.send_event("campaign-logs", result)
        
    except Exception as e:
        self.send_event("campaign-logs", {"success": False, "error": str(e)})

