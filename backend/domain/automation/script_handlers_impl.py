"""
Extracted handler implementations: scripts
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

from service_locator import get_script_engine
# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


async def handle_get_script_templates(self, payload: Dict[str, Any]):
    """獲取劇本模板"""
    try:
        script_engine = get_script_engine()
        if not script_engine:
            self.send_event("script-templates", {"success": False, "error": "劇本引擎未初始化"})
            return
        
        result = await script_engine.get_all_templates(
            scenario=payload.get('scenario'),
            active_only=payload.get('activeOnly', True)
        )
        
        self.send_event("script-templates", result)
        
    except Exception as e:
        self.send_event("script-templates", {"success": False, "error": str(e)})


async def handle_create_script_template(self, payload: Dict[str, Any]):
    """創建劇本模板"""
    try:
        script_engine = get_script_engine()
        if not script_engine:
            self.send_event("script-template-created", {"success": False, "error": "劇本引擎未初始化"})
            return
        
        result = await script_engine.create_template(
            name=payload.get('name'),
            description=payload.get('description', ''),
            scenario=payload.get('scenario', 'custom'),
            stages=payload.get('stages', []),
            required_roles=payload.get('requiredRoles', []),
            min_roles=payload.get('minRoles', 2),
            duration_minutes=payload.get('durationMinutes', 10)
        )
        
        self.send_event("script-template-created", result)
        
    except Exception as e:
        self.send_event("script-template-created", {"success": False, "error": str(e)})


async def handle_delete_script_template(self, payload: Dict[str, Any]):
    """刪除劇本模板"""
    try:
        script_engine = get_script_engine()
        if not script_engine:
            self.send_event("script-template-deleted", {"success": False, "error": "劇本引擎未初始化"})
            return
        
        result = await script_engine.delete_template(payload.get('templateId'))
        self.send_event("script-template-deleted", result)
        
    except Exception as e:
        self.send_event("script-template-deleted", {"success": False, "error": str(e)})


async def handle_start_script_execution(self, payload: Dict[str, Any]):
    """啟動劇本執行"""
    try:
        script_engine = get_script_engine()
        if not script_engine:
            self.send_event("script-execution-created", {"success": False, "error": "劇本引擎未初始化"})
            return
        
        result = await script_engine.start_execution(
            template_id=payload.get('templateId'),
            group_id=payload.get('groupId'),
            target_user_id=payload.get('targetUserId'),
            target_username=payload.get('targetUsername'),
            assigned_roles=payload.get('assignedRoles', {})
        )
        
        self.send_event("script-execution-created", result)
        
    except Exception as e:
        self.send_event("script-execution-created", {"success": False, "error": str(e)})


async def handle_run_script_execution(self, payload: Dict[str, Any]):
    """運行劇本執行"""
    try:
        script_engine = get_script_engine()
        if not script_engine:
            self.send_event("script-execution-started", {"success": False, "error": "劇本引擎未初始化"})
            return
        
        result = await script_engine.run_execution(payload.get('executionId'))
        # Event sent by engine
        
    except Exception as e:
        self.send_event("script-execution-started", {"success": False, "error": str(e)})


async def handle_stop_script_execution(self, payload: Dict[str, Any]):
    """停止劇本執行"""
    try:
        script_engine = get_script_engine()
        if not script_engine:
            self.send_event("script-execution-stopped", {"success": False, "error": "劇本引擎未初始化"})
            return
        
        result = await script_engine.stop_execution(
            execution_id=payload.get('executionId'),
            outcome=payload.get('outcome', 'stopped')
        )
        
    except Exception as e:
        self.send_event("script-execution-stopped", {"success": False, "error": str(e)})


async def handle_workflow_get_executions(self, payload: Dict[str, Any]):
    """獲取工作流執行列表"""
    import sys
    
    try:
        from automation_workflow import get_automation_workflow_service
        
        service = get_automation_workflow_service()
        executions = service.get_all_executions()
        
        self.send_event("workflow:executions", {"success": True, "executions": executions})
        
    except Exception as e:
        print(f"[AutomationWorkflow] 獲取執行列表錯誤: {e}", file=sys.stderr)
        self.send_event("workflow:executions", {"success": False, "error": str(e)})

