"""
Extracted handler implementations: templates
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


# ==================== Chat Template Handlers ====================

async def handle_get_chat_templates(self):
    """ç²å–èŠå¤©æ¨¡æ¿åˆ—è¡¨"""
    import sys
    print("[Backend] handle_get_chat_templates called", file=sys.stderr)
    try:
        templates = await db.get_chat_templates()
        print(f"[Backend] Loaded {len(templates)} chat templates", file=sys.stderr)
        self.send_event("get-chat-templates-result", {
            "templates": templates,
            "success": True  # ğŸ”§ FIX: æ·»åŠ  success æ¨™èªŒ
        })
    except Exception as e:
        import traceback
        print(f"[Backend] âŒ Error getting chat templates: {e}", file=sys.stderr)
        traceback.print_exc(file=sys.stderr)
        self.send_log(f"âŒ ç²å–èŠå¤©æ¨¡æ¿å¤±æ•—: {e}", "error")
        self.send_event("get-chat-templates-result", {
            "templates": [],
            "success": False,
            "error": str(e)
        })


async def handle_save_chat_template(self, payload: Dict[str, Any]):
    """ä¿å­˜èŠå¤©æ¨¡æ¿"""
    try:
        template_id = payload.get('id')
        name = payload.get('name', '')
        category = payload.get('category', 'custom')
        content = payload.get('content', '')
        variables = payload.get('variables', [])
        is_active = payload.get('isActive', True)
        
        if not name or not content:
            self.send_event("save-chat-template-result", {
                "success": False,
                "error": "æ¨¡æ¿åç¨±å’Œå…§å®¹ä¸èƒ½ç‚ºç©º"
            })
            return
        
        result = await db.save_chat_template(
            template_id=template_id,
            name=name,
            category=category,
            content=content,
            variables=variables,
            is_active=is_active
        )
        
        self.send_event("save-chat-template-result", result)
        
        if result.get('success'):
            self.send_log(f"âœ… å·²ä¿å­˜èŠå¤©æ¨¡æ¿: {name}", "success")
            # åˆ·æ–°æ¨¡æ¿åˆ—è¡¨
            await self.handle_get_chat_templates()
            
    except Exception as e:
        self.send_log(f"âŒ ä¿å­˜èŠå¤©æ¨¡æ¿å¤±æ•—: {e}", "error")
        self.send_event("save-chat-template-result", {
            "success": False,
            "error": str(e)
        })


async def handle_delete_chat_template(self, payload: Dict[str, Any]):
    """åˆªé™¤èŠå¤©æ¨¡æ¿"""
    try:
        template_id = payload.get('id')
        
        if not template_id:
            self.send_event("delete-chat-template-result", {
                "success": False,
                "error": "ç¼ºå°‘æ¨¡æ¿ ID"
            })
            return
        
        success = await db.delete_chat_template(template_id)
        
        self.send_event("delete-chat-template-result", {"success": success})
        
        if success:
            self.send_log(f"ğŸ—‘ï¸ å·²åˆªé™¤èŠå¤©æ¨¡æ¿ ID: {template_id}", "success")
            # åˆ·æ–°æ¨¡æ¿åˆ—è¡¨
            await self.handle_get_chat_templates()
            
    except Exception as e:
        self.send_log(f"âŒ åˆªé™¤èŠå¤©æ¨¡æ¿å¤±æ•—: {e}", "error")
        self.send_event("delete-chat-template-result", {
            "success": False,
            "error": str(e)
        })

