"""
Extracted handler implementations: tags
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


async def handle_batch_add_tag(self, payload: Dict[str, Any]):
    """批量添加標籤"""
    try:
        lead_ids = payload.get('leadIds', [])
        tag = payload.get('tag')
        
        if not lead_ids:
            self.send_event("batch-operation-result", {
                "success": False,
                "error": "未選擇任何 Lead"
            })
            return
        
        if not tag:
            self.send_event("batch-operation-result", {
                "success": False,
                "error": "未指定標籤"
            })
            return
        
        batch_ops = get_batch_ops()
        if not batch_ops:
            self.send_event("batch-operation-result", {
                "success": False,
                "error": "批量操作系統未初始化"
            })
            return
        
        result = await batch_ops.batch_add_tag(lead_ids, tag)
        
        if result.get('success'):
            self.send_log(f"批量添加標籤完成: {result.get('successCount')}/{len(lead_ids)} 成功", "success")
        else:
            self.send_log(f"批量添加標籤失敗: {result.get('error')}", "error")
        
        self.send_event("batch-operation-result", result)
        
    except Exception as e:
        self.send_log(f"批量添加標籤失敗: {str(e)}", "error")
        self.send_event("batch-operation-result", {
            "success": False,
            "error": str(e)
        })


async def handle_batch_remove_tag(self, payload: Dict[str, Any]):
    """批量移除標籤"""
    try:
        lead_ids = payload.get('leadIds', [])
        tag = payload.get('tag')
        
        if not lead_ids:
            self.send_event("batch-operation-result", {
                "success": False,
                "error": "未選擇任何 Lead"
            })
            return
        
        if not tag:
            self.send_event("batch-operation-result", {
                "success": False,
                "error": "未指定標籤"
            })
            return
        
        batch_ops = get_batch_ops()
        if not batch_ops:
            self.send_event("batch-operation-result", {
                "success": False,
                "error": "批量操作系統未初始化"
            })
            return
        
        result = await batch_ops.batch_remove_tag(lead_ids, tag)
        
        if result.get('success'):
            self.send_log(f"批量移除標籤完成: {result.get('successCount')}/{len(lead_ids)} 成功", "success")
        else:
            self.send_log(f"批量移除標籤失敗: {result.get('error')}", "error")
        
        self.send_event("batch-operation-result", result)
        
    except Exception as e:
        self.send_log(f"批量移除標籤失敗: {str(e)}", "error")
        self.send_event("batch-operation-result", {
            "success": False,
            "error": str(e)
        })


async def handle_get_all_tags(self):
    """獲取所有標籤"""
    try:
        batch_ops = get_batch_ops()
        if not batch_ops:
            self.send_event("all-tags", {
                "success": False,
                "error": "批量操作系統未初始化"
            })
            return
        
        result = await batch_ops.get_all_tags()
        
        self.send_event("all-tags", result)
        
    except Exception as e:
        self.send_log(f"獲取標籤列表失敗: {str(e)}", "error")
        self.send_event("all-tags", {
            "success": False,
            "error": str(e)
        })


async def handle_create_tag(self, payload: Dict[str, Any]):
    """創建新標籤"""
    try:
        name = payload.get('name')
        color = payload.get('color', '#3B82F6')
        
        if not name:
            self.send_event("tag-created", {
                "success": False,
                "error": "標籤名稱不能為空"
            })
            return
        
        batch_ops = get_batch_ops()
        if not batch_ops:
            self.send_event("tag-created", {
                "success": False,
                "error": "批量操作系統未初始化"
            })
            return
        
        result = await batch_ops.create_tag(name, color)
        
        if result.get('success'):
            self.send_log(f"創建標籤成功: {name}", "success")
        else:
            self.send_log(f"創建標籤失敗: {result.get('error')}", "error")
        
        self.send_event("tag-created", result)
        
    except Exception as e:
        self.send_log(f"創建標籤失敗: {str(e)}", "error")
        self.send_event("tag-created", {
            "success": False,
            "error": str(e)
        })


async def handle_delete_tag(self, payload: Dict[str, Any]):
    """刪除標籤"""
    try:
        name = payload.get('name')
        
        if not name:
            self.send_event("tag-deleted", {
                "success": False,
                "error": "標籤名稱不能為空"
            })
            return
        
        batch_ops = get_batch_ops()
        if not batch_ops:
            self.send_event("tag-deleted", {
                "success": False,
                "error": "批量操作系統未初始化"
            })
            return
        
        result = await batch_ops.delete_tag(name)
        
        if result.get('success'):
            self.send_log(f"刪除標籤成功: {name}", "success")
        else:
            self.send_log(f"刪除標籤失敗: {result.get('error')}", "error")
        
        self.send_event("tag-deleted", result)
        
    except Exception as e:
        self.send_log(f"刪除標籤失敗: {str(e)}", "error")
        self.send_event("tag-deleted", {
            "success": False,
            "error": str(e)
        })


async def handle_get_lead_tags(self, payload: Dict[str, Any]):
    """獲取 Lead 的標籤"""
    try:
        lead_id = payload.get('leadId')
        
        if not lead_id:
            self.send_event("lead-tags", {
                "success": False,
                "error": "Lead ID 不能為空"
            })
            return
        
        batch_ops = get_batch_ops()
        if not batch_ops:
            self.send_event("lead-tags", {
                "success": False,
                "error": "批量操作系統未初始化"
            })
            return
        
        result = await batch_ops.get_lead_tags(lead_id)
        result['leadId'] = lead_id
        
        self.send_event("lead-tags", result)
        
    except Exception as e:
        self.send_log(f"獲取 Lead 標籤失敗: {str(e)}", "error")
        self.send_event("lead-tags", {
            "success": False,
            "error": str(e)
        })


async def handle_get_auto_tags(self, payload: Dict[str, Any]):
    """獲取自動標籤"""
    try:
        from auto_tagger import auto_tag_lead
        
        message = payload.get("message", "")
        intent_score = payload.get("intentScore", 0)
        source_url = payload.get("sourceUrl", "")
        has_replied = payload.get("hasReplied", False)
        inquiry_count = payload.get("inquiryCount", 0)
        
        result = await auto_tag_lead(
            message=message,
            intent_score=intent_score,
            source_url=source_url,
            has_replied=has_replied,
            inquiry_count=inquiry_count
        )
        
        self.send_event("auto-tags-result", {
            "success": True,
            **result
        })
    except Exception as e:
        print(f"[Backend] Error auto-tagging: {e}", file=sys.stderr)
        self.send_event("auto-tags-result", {
            "success": False,
            "error": str(e)
        })


async def handle_batch_tag_members(self, payload: Dict[str, Any]):
    """批量標籤成員"""
    try:
        user_ids = payload.get('userIds', [])
        tag = payload.get('tag', '')
        action = payload.get('action', 'add')  # add 或 remove
        
        if not user_ids or not tag:
            raise ValueError("用戶 ID 列表和標籤不能為空")
        
        if action == 'remove':
            count = await member_extraction_service.batch_remove_tag(user_ids, tag)
        else:
            count = await member_extraction_service.batch_add_tag(user_ids, tag)
        
        self.send_log(f"✅ 批量標籤完成: {count} 個成員", "success")
        self.send_event("members-tagged", {
            "success": True,
            "count": count,
            "tag": tag,
            "action": action
        })
        
    except Exception as e:
        self.send_event("members-tagged", {
            "success": False,
            "error": str(e)
        })


async def handle_get_all_tags(self, payload: Dict[str, Any]):
    """獲取所有標籤"""
    try:
        tags = await member_extraction_service.get_all_tags()
        
        self.send_event("all-tags", {
            "success": True,
            "tags": tags
        })
        
    except Exception as e:
        self.send_event("all-tags", {
            "success": False,
            "error": str(e),
            "tags": []
        })

