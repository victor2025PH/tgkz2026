"""
Extracted handler implementations: tracking
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


async def handle_analyze_user_message(self, payload: Dict[str, Any]):
    """åˆ†æç”¨æˆ¶æ¶ˆæ¯ä¸¦ç¢ºå®šæ¼æ–—éšæ®µ"""
    try:
        user_id = payload.get('userId', '')
        message = payload.get('message', '')
        is_from_user = payload.get('isFromUser', True)
        
        result = await auto_funnel.analyze_message(user_id, message, is_from_user)
        
        self.send_event("message-analyzed", {
            "success": True,
            **result
        })
    except Exception as e:
        self.send_event("message-analyzed", {
            "success": False,
            "error": str(e)
        })


async def handle_get_user_journey(self, payload: Dict[str, Any]):
    """ç²å–ç”¨æˆ¶æ¼æ–—æ—…ç¨‹"""
    try:
        user_id = payload.get('userId', '')
        journey = await auto_funnel.get_user_journey(user_id)
        
        self.send_event("user-journey", {
            "success": True,
            "userId": user_id,
            "journey": journey
        })
    except Exception as e:
        self.send_event("user-journey", {
            "success": False,
            "error": str(e)
        })


# ==================== User CRM Handlers ====================

async def handle_get_user_profile_full(self, payload: Dict[str, Any]):
    """ç²å–å®Œæ•´ç”¨æˆ¶è³‡æ–™"""
    try:
        user_id = payload.get('userId', '')
        
        # Get user profile
        profile = await db.get_user_profile(user_id)
        
        # Get user CRM data
        cursor = await db._connection.execute(
            "SELECT * FROM user_crm WHERE user_id = ?", (user_id,)
        )
        crm_row = await cursor.fetchone()
        crm_data = dict(crm_row) if crm_row else {}
        
        # Get user tags
        cursor = await db._connection.execute(
            "SELECT tag, tag_type, confidence FROM user_tags WHERE user_id = ?",
            (user_id,)
        )
        tags = await cursor.fetchall()
        tags_list = [dict(t) for t in tags]
        
        # Get funnel history
        history = await db.get_funnel_history(user_id, limit=10)
        
        # Get memory stats
        stats = await vector_memory.get_user_memory_stats(user_id)
        
        self.send_event("user-profile-full", {
            "success": True,
            "userId": user_id,
            "profile": profile,
            "crm": crm_data,
            "tags": tags_list,
            "funnelHistory": history,
            "memoryStats": stats
        })
    except Exception as e:
        self.send_event("user-profile-full", {
            "success": False,
            "error": str(e)
        })


async def handle_update_user_crm(self, payload: Dict[str, Any]):
    """æ›´æ–°ç”¨æˆ¶ CRM è³‡æ–™"""
    try:
        user_id = payload.get('userId', '')
        data = payload.get('data', {})
        
        # Build update query
        fields = ['company', 'industry', 'job_title', 'phone', 'email', 
                  'website', 'location', 'budget_range', 'pain_points', 'goals']
        
        updates = []
        values = []
        
        for field in fields:
            if field in data:
                updates.append(f"{field} = ?")
                values.append(data[field])
        
        if updates:
            values.append(user_id)
            
            # Check if record exists
            cursor = await db._connection.execute(
                "SELECT 1 FROM user_crm WHERE user_id = ?", (user_id,)
            )
            exists = await cursor.fetchone()
            
            if exists:
                await db._connection.execute(f"""
                    UPDATE user_crm SET {', '.join(updates)}, updated_at = CURRENT_TIMESTAMP
                    WHERE user_id = ?
                """, values)
            else:
                # Insert new record
                insert_fields = [f for f in fields if f in data]
                insert_values = [data[f] for f in insert_fields]
                placeholders = ', '.join(['?' for _ in insert_fields])
                
                await db._connection.execute(f"""
                    INSERT INTO user_crm (user_id, {', '.join(insert_fields)})
                    VALUES (?, {placeholders})
                """, [user_id] + insert_values)
            
            await db._connection.commit()
        
        self.send_event("crm-updated", {
            "success": True,
            "userId": user_id
        })
    except Exception as e:
        self.send_event("crm-updated", {
            "success": False,
            "error": str(e)
        })


async def handle_analyze_user_journey(self, payload: Dict[str, Any]):
    """åˆ†æç”¨æˆ¶æ—…ç¨‹"""
    try:
        from analytics_engine import AnalyticsEngine
        
        user_id = payload.get('userId', '')
        if not user_id:
            self.send_event("user-journey-analysis", {
                "success": False,
                "error": "ç”¨æˆ¶IDä¸èƒ½ç‚ºç©º"
            })
            return
        
        engine = AnalyticsEngine(db)
        result = await engine.analyze_user_journey(user_id)
        
        self.send_event("user-journey-analysis", {
            "success": True,
            **result
        })
    except Exception as e:
        self.send_event("user-journey-analysis", {
            "success": False,
            "error": str(e)
        })


# ==================== User Management Handlers ====================

async def handle_get_users_with_profiles(self, payload: Dict[str, Any]):
    """ç²å–ç”¨æˆ¶åˆ—è¡¨ï¼ˆå«ç•«åƒï¼‰ï¼Œæ”¯æŒç¯©é¸"""
    try:
        result = await db.get_users_with_profiles(
            stage=payload.get('stage'),
            tags=payload.get('tags'),
            interest_min=payload.get('interestMin'),
            interest_max=payload.get('interestMax'),
            search=payload.get('search'),
            limit=payload.get('limit', 50),
            offset=payload.get('offset', 0)
        )
        
        self.send_event("users-with-profiles", result)
        
    except Exception as e:
        import traceback
        traceback.print_exc(file=sys.stderr)
        self.send_event("users-with-profiles", {
            "users": [],
            "total": 0,
            "error": str(e)
        })


async def handle_update_user_profile(self, payload: Dict[str, Any]):
    """æ›´æ–°å–®å€‹ç”¨æˆ¶ç•«åƒ"""
    try:
        user_id = payload.get('userId')
        data = payload.get('data', {})
        
        if not user_id:
            raise ValueError("ç”¨æˆ¶ ID ä¸èƒ½ç‚ºç©º")
        
        await db.update_user_profile(user_id, data)
        
        # å¦‚æœæœ‰éšæ®µæ›´æ–°ï¼Œä½¿ç”¨å°ˆé–€çš„æ–¹æ³•
        if 'funnel_stage' in data:
            await db.set_user_funnel_stage(user_id, data['funnel_stage'])
        
        self.send_log(f"å·²æ›´æ–°ç”¨æˆ¶ {user_id} çš„ç•«åƒ", "success")
        self.send_event("user-profile-updated", {
            "success": True,
            "userId": user_id
        })
        
    except Exception as e:
        self.send_log(f"æ›´æ–°ç”¨æˆ¶ç•«åƒå¤±æ•—: {str(e)}", "error")
        self.send_event("user-profile-updated", {
            "success": False,
            "error": str(e)
        })


# ==================== User Tracking Handlers (ç”¨æˆ¶è¿½è¹¤ç³»çµ±) ====================

async def handle_add_user_to_track(self, payload: Dict[str, Any]):
    """æ·»åŠ ç”¨æˆ¶åˆ°è¿½è¹¤åˆ—è¡¨"""
    try:
        tracker = get_user_tracker()
        if not tracker:
            self.send_event("user-added-to-track", {"success": False, "error": "ç”¨æˆ¶è¿½è¹¤ç³»çµ±æœªåˆå§‹åŒ–"})
            return
        
        result = await tracker.add_user_to_track(
            user_id=payload.get('userId'),
            username=payload.get('username'),
            first_name=payload.get('firstName'),
            last_name=payload.get('lastName'),
            source=payload.get('source', 'manual'),
            source_group_id=payload.get('sourceGroupId'),
            notes=payload.get('notes')
        )
        
        if result.get('success'):
            self.send_log(f"ç”¨æˆ¶å·²æ·»åŠ åˆ°è¿½è¹¤åˆ—è¡¨", "success")
        
        self.send_event("user-added-to-track", result)
        
    except Exception as e:
        self.send_event("user-added-to-track", {"success": False, "error": str(e)})


async def handle_add_user_from_lead(self, payload: Dict[str, Any]):
    """å¾ Lead æ·»åŠ ç”¨æˆ¶åˆ°è¿½è¹¤"""
    try:
        tracker = get_user_tracker()
        if not tracker:
            self.send_event("user-added-from-lead", {"success": False, "error": "ç”¨æˆ¶è¿½è¹¤ç³»çµ±æœªåˆå§‹åŒ–"})
            return
        
        lead_id = payload.get('leadId')
        result = await tracker.add_user_from_lead(lead_id)
        
        self.send_event("user-added-from-lead", result)
        
    except Exception as e:
        self.send_event("user-added-from-lead", {"success": False, "error": str(e)})


async def handle_remove_tracked_user(self, payload: Dict[str, Any]):
    """ç§»é™¤è¿½è¹¤ç”¨æˆ¶"""
    try:
        tracker = get_user_tracker()
        if not tracker:
            self.send_event("user-removed", {"success": False, "error": "ç”¨æˆ¶è¿½è¹¤ç³»çµ±æœªåˆå§‹åŒ–"})
            return
        
        user_id = payload.get('userId')
        result = await tracker.remove_user(user_id)
        
        if result.get('success'):
            self.send_log(f"ç”¨æˆ¶å·²å¾è¿½è¹¤åˆ—è¡¨ç§»é™¤", "info")
        
        self.send_event("user-removed", result)
        
    except Exception as e:
        self.send_event("user-removed", {"success": False, "error": str(e)})


async def handle_get_tracked_users(self, payload: Dict[str, Any]):
    """ç²å–è¿½è¹¤ç”¨æˆ¶åˆ—è¡¨"""
    try:
        tracker = get_user_tracker()
        if not tracker:
            self.send_event("tracked-users", {"success": False, "error": "ç”¨æˆ¶è¿½è¹¤ç³»çµ±æœªåˆå§‹åŒ–"})
            return
        
        result = await tracker.get_all_tracked_users(
            value_level=payload.get('valueLevel'),
            status=payload.get('status'),
            limit=payload.get('limit', 100),
            offset=payload.get('offset', 0)
        )
        
        self.send_event("tracked-users", result)
        
    except Exception as e:
        self.send_event("tracked-users", {"success": False, "error": str(e)})


async def handle_update_user_value_level(self, payload: Dict[str, Any]):
    """æ›´æ–°ç”¨æˆ¶åƒ¹å€¼ç­‰ç´š"""
    try:
        tracker = get_user_tracker()
        if not tracker:
            self.send_event("user-value-updated", {"success": False, "error": "ç”¨æˆ¶è¿½è¹¤ç³»çµ±æœªåˆå§‹åŒ–"})
            return
        
        result = await tracker.update_user_value_level(
            user_id=payload.get('userId'),
            value_level=payload.get('valueLevel')
        )
        
        self.send_event("user-value-updated", result)
        
    except Exception as e:
        self.send_event("user-value-updated", {"success": False, "error": str(e)})


async def handle_track_user_groups(self, payload: Dict[str, Any]):
    """è¿½è¹¤ç”¨æˆ¶ç¾¤çµ„"""
    try:
        tracker = get_user_tracker()
        if not tracker:
            self.send_event("user-tracking-completed", {"success": False, "error": "ç”¨æˆ¶è¿½è¹¤ç³»çµ±æœªåˆå§‹åŒ–"})
            return
        
        result = await tracker.track_user_groups(
            user_id=payload.get('userId'),
            account_phone=payload.get('accountPhone')
        )
        
        # Event is sent by tracker
        
    except Exception as e:
        self.send_event("user-tracking-failed", {"success": False, "error": str(e)})


async def handle_batch_track_users(self, payload: Dict[str, Any]):
    """æ‰¹é‡è¿½è¹¤ç”¨æˆ¶"""
    try:
        tracker = get_user_tracker()
        if not tracker:
            self.send_event("batch-tracking-completed", {"success": False, "error": "ç”¨æˆ¶è¿½è¹¤ç³»çµ±æœªåˆå§‹åŒ–"})
            return
        
        result = await tracker.batch_track_users(
            user_ids=payload.get('userIds', []),
            account_phone=payload.get('accountPhone')
        )
        
        # Event is sent by tracker
        
    except Exception as e:
        self.send_event("batch-tracking-completed", {"success": False, "error": str(e)})


async def handle_get_user_groups(self, payload: Dict[str, Any]):
    """ç²å–ç”¨æˆ¶ç¾¤çµ„"""
    try:
        tracker = get_user_tracker()
        if not tracker:
            self.send_event("user-groups", {"success": False, "error": "ç”¨æˆ¶è¿½è¹¤ç³»çµ±æœªåˆå§‹åŒ–"})
            return
        
        result = await tracker.get_user_groups(payload.get('userId'))
        
        self.send_event("user-groups", result)
        
    except Exception as e:
        self.send_event("user-groups", {"success": False, "error": str(e)})


async def handle_get_tracking_stats(self, payload: Dict[str, Any]):
    """ç²å–è¿½è¹¤çµ±è¨ˆ"""
    try:
        tracker = get_user_tracker()
        if not tracker:
            self.send_event("tracking-stats", {"success": False, "error": "ç”¨æˆ¶è¿½è¹¤ç³»çµ±æœªåˆå§‹åŒ–"})
            return
        
        result = await tracker.get_tracking_stats()
        
        self.send_event("tracking-stats", result)
        
    except Exception as e:
        self.send_event("tracking-stats", {"success": False, "error": str(e)})


async def handle_get_tracking_logs(self, payload: Dict[str, Any]):
    """ç²å–è¿½è¹¤æ—¥èªŒ"""
    try:
        tracker = get_user_tracker()
        if not tracker:
            self.send_event("tracking-logs", {"success": False, "error": "ç”¨æˆ¶è¿½è¹¤ç³»çµ±æœªåˆå§‹åŒ–"})
            return
        
        result = await tracker.get_tracking_logs(
            user_id=payload.get('userId'),
            limit=payload.get('limit', 50),
            offset=payload.get('offset', 0)
        )
        
        self.send_event("tracking-logs", result)
        
    except Exception as e:
        self.send_event("tracking-logs", {"success": False, "error": str(e)})


async def handle_get_user_value_distribution(self, payload: Dict[str, Any]):
    """ç²å–ç”¨æˆ¶åƒ¹å€¼åˆ†ä½ˆ"""
    try:
        analytics = get_user_analytics()
        if not analytics:
            self.send_event("user-value-distribution", {"success": False, "error": "ç”¨æˆ¶åˆ†ææœªåˆå§‹åŒ–"})
            return
        
        result = await analytics.get_user_value_distribution()
        
        self.send_event("user-value-distribution", result)
        
    except Exception as e:
        self.send_event("user-value-distribution", {"success": False, "error": str(e)})


async def handle_get_tracking_effectiveness(self, payload: Dict[str, Any]):
    """ç²å–è¿½è¹¤æ•ˆç‡"""
    try:
        analytics = get_user_analytics()
        if not analytics:
            self.send_event("tracking-effectiveness", {"success": False, "error": "ç”¨æˆ¶åˆ†ææœªåˆå§‹åŒ–"})
            return
        
        result = await analytics.get_tracking_effectiveness()
        
        self.send_event("tracking-effectiveness", result)
        
    except Exception as e:
        self.send_event("tracking-effectiveness", {"success": False, "error": str(e)})


async def handle_sync_resource_status_to_leads(self, payload: Dict[str, Any]):
    """
    ğŸ†• å¾è³‡æºä¸­å¿ƒåŒæ­¥ç‹€æ…‹åˆ°ç™¼é€æ§åˆ¶å° (leads è¡¨)
    ç•¶ç”¨æˆ¶åœ¨è³‡æºä¸­å¿ƒä¿®æ”¹è¯ç¹«äººç‹€æ…‹æ™‚èª¿ç”¨
    """
    import sys
    from unified_contacts import CONTACT_STATUS_TO_LEAD
    
    try:
        telegram_ids = payload.get('telegramIds', [])
        lead_status = payload.get('status')  # å·²ç¶“æ˜¯ Lead ç‹€æ…‹æ ¼å¼
        
        if not telegram_ids or not lead_status:
            self.send_event("sync-resource-status-to-leads-result", {
                "success": False,
                "error": "Missing telegramIds or status"
            })
            return
        
        print(f"[Backend] Syncing resource status to leads: {len(telegram_ids)} contacts -> {lead_status}", file=sys.stderr)
        
        updated = 0
        for tid in telegram_ids:
            try:
                # æ›´æ–° leads è¡¨ä¸­å°æ‡‰çš„è¨˜éŒ„
                await db._connection.execute('''
                    UPDATE leads SET status = ? 
                    WHERE userId = ? OR CAST(userId AS TEXT) = ?
                ''', (lead_status, tid, tid))
                updated += 1
            except Exception as e:
                print(f"[Backend] Error updating lead {tid}: {e}", file=sys.stderr)
        
        await db._connection.commit()
        
        self.send_event("sync-resource-status-to-leads-result", {
            "success": True,
            "updated": updated
        })
        
        # åˆ·æ–°å‰ç«¯çš„ leads åˆ—è¡¨
        if updated > 0:
            await self.send_leads_update()
            self.send_log(f"âœ… å·²åŒæ­¥ {updated} å€‹è¯ç¹«äººç‹€æ…‹åˆ°ç™¼é€æ§åˆ¶å°", "info")
        
    except Exception as e:
        print(f"[Backend] Sync resource status to leads error: {e}", file=sys.stderr)
        self.send_event("sync-resource-status-to-leads-result", {
            "success": False,
            "error": str(e)
        })

