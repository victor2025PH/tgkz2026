"""
Extracted handler implementations: ads
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

from service_locator import (
    get_ad_analytics,
    get_ad_broadcaster,
    get_ad_manager,
    get_ad_scheduler,
    get_ad_template_manager,
    scheduler
)
# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx

# ==================== Ad System Handlers (廣告發送系統) ====================

async def handle_create_ad_template(self, payload: Dict[str, Any]):
    """創建廣告模板"""
    try:
        template_manager = get_ad_template_manager()
        if not template_manager:
            self.send_event("ad-template-created", {"success": False, "error": "廣告系統未初始化"})
            return
        
        result = await template_manager.create_template(
            name=payload.get('name', ''),
            content=payload.get('content', ''),
            media_type=payload.get('mediaType', 'text'),
            media_file_id=payload.get('mediaFileId'),
            media_path=payload.get('mediaPath')
        )
        
        if result.get('success'):
            self.send_log(f"廣告模板已創建: {result.get('name')}", "success")
        
        self.send_event("ad-template-created", result)
        
    except Exception as e:
        self.send_event("ad-template-created", {"success": False, "error": str(e)})

async def handle_update_ad_template(self, payload: Dict[str, Any]):
    """更新廣告模板"""
    try:
        template_manager = get_ad_template_manager()
        if not template_manager:
            self.send_event("ad-template-updated", {"success": False, "error": "廣告系統未初始化"})
            return
        
        template_id = payload.get('templateId')
        updates = payload.get('updates', {})
        
        result = await template_manager.update_template(template_id, updates)
        
        self.send_event("ad-template-updated", result)
        
    except Exception as e:
        self.send_event("ad-template-updated", {"success": False, "error": str(e)})

async def handle_delete_ad_template(self, payload: Dict[str, Any]):
    """刪除廣告模板"""
    try:
        template_manager = get_ad_template_manager()
        if not template_manager:
            self.send_event("ad-template-deleted", {"success": False, "error": "廣告系統未初始化"})
            return
        
        template_id = payload.get('templateId')
        result = await template_manager.delete_template(template_id)
        
        if result.get('success'):
            self.send_log(f"廣告模板已刪除: ID {template_id}", "info")
        
        self.send_event("ad-template-deleted", result)
        
    except Exception as e:
        self.send_event("ad-template-deleted", {"success": False, "error": str(e)})

async def handle_get_ad_templates(self, payload: Dict[str, Any]):
    """獲取廣告模板列表"""
    try:
        template_manager = get_ad_template_manager()
        if not template_manager:
            self.send_event("ad-templates", {"success": False, "error": "廣告系統未初始化"})
            return
        
        active_only = payload.get('activeOnly', False)
        templates = await template_manager.get_all_templates(active_only)
        
        self.send_event("ad-templates", {
            "success": True,
            "templates": [t.to_dict() for t in templates]
        })
        
    except Exception as e:
        self.send_event("ad-templates", {"success": False, "error": str(e)})

async def handle_toggle_ad_template_status(self, payload: Dict[str, Any]):
    """切換廣告模板狀態"""
    try:
        template_manager = get_ad_template_manager()
        if not template_manager:
            self.send_event("ad-template-toggled", {"success": False, "error": "廣告系統未初始化"})
            return
        
        template_id = payload.get('templateId')
        result = await template_manager.toggle_template_status(template_id)
        
        self.send_event("ad-template-toggled", result)
        
    except Exception as e:
        self.send_event("ad-template-toggled", {"success": False, "error": str(e)})

async def handle_preview_ad_template(self, payload: Dict[str, Any]):
    """預覽廣告模板變體"""
    try:
        template_manager = get_ad_template_manager()
        if not template_manager:
            self.send_event("ad-template-preview", {"success": False, "error": "廣告系統未初始化"})
            return
        
        template_id = payload.get('templateId')
        count = payload.get('count', 5)
        
        result = await template_manager.preview_template(template_id, count)
        
        self.send_event("ad-template-preview", result)
        
    except Exception as e:
        self.send_event("ad-template-preview", {"success": False, "error": str(e)})

async def handle_create_ad_schedule(self, payload: Dict[str, Any]):
    """創建廣告計劃"""
    try:
        ad_manager = get_ad_manager()
        if not ad_manager:
            self.send_event("ad-schedule-created", {"success": False, "error": "廣告系統未初始化"})
            return
        
        result = await ad_manager.create_schedule(
            template_id=payload.get('templateId'),
            name=payload.get('name', ''),
            target_groups=payload.get('targetGroups', []),
            send_mode=payload.get('sendMode', 'scheduled'),
            schedule_type=payload.get('scheduleType', 'once'),
            assigned_accounts=payload.get('assignedAccounts', []),
            schedule_time=payload.get('scheduleTime'),
            interval_minutes=payload.get('intervalMinutes', 60),
            trigger_keywords=payload.get('triggerKeywords', []),
            account_strategy=payload.get('accountStrategy', 'single')
        )
        
        if result.get('success'):
            self.send_log(f"廣告計劃已創建: {result.get('name')}", "success")
            # Reload triggers if needed
            scheduler = get_ad_scheduler()
            if scheduler:
                await scheduler.reload_triggers()
        
        self.send_event("ad-schedule-created", result)
        
    except Exception as e:
        self.send_event("ad-schedule-created", {"success": False, "error": str(e)})

async def handle_update_ad_schedule(self, payload: Dict[str, Any]):
    """更新廣告計劃"""
    try:
        ad_manager = get_ad_manager()
        if not ad_manager:
            self.send_event("ad-schedule-updated", {"success": False, "error": "廣告系統未初始化"})
            return
        
        schedule_id = payload.get('scheduleId')
        updates = payload.get('updates', {})
        
        result = await ad_manager.update_schedule(schedule_id, updates)
        
        if result.get('success'):
            scheduler = get_ad_scheduler()
            if scheduler:
                await scheduler.reload_triggers()
        
        self.send_event("ad-schedule-updated", result)
        
    except Exception as e:
        self.send_event("ad-schedule-updated", {"success": False, "error": str(e)})

async def handle_delete_ad_schedule(self, payload: Dict[str, Any]):
    """刪除廣告計劃"""
    try:
        ad_manager = get_ad_manager()
        if not ad_manager:
            self.send_event("ad-schedule-deleted", {"success": False, "error": "廣告系統未初始化"})
            return
        
        schedule_id = payload.get('scheduleId')
        result = await ad_manager.delete_schedule(schedule_id)
        
        if result.get('success'):
            self.send_log(f"廣告計劃已刪除: ID {schedule_id}", "info")
            scheduler = get_ad_scheduler()
            if scheduler:
                await scheduler.reload_triggers()
        
        self.send_event("ad-schedule-deleted", result)
        
    except Exception as e:
        self.send_event("ad-schedule-deleted", {"success": False, "error": str(e)})

async def handle_get_ad_schedules(self, payload: Dict[str, Any]):
    """獲取廣告計劃列表"""
    try:
        ad_manager = get_ad_manager()
        if not ad_manager:
            self.send_event("ad-schedules", {"success": False, "error": "廣告系統未初始化"})
            return
        
        active_only = payload.get('activeOnly', False)
        schedules = await ad_manager.get_all_schedules(active_only)
        
        self.send_event("ad-schedules", {
            "success": True,
            "schedules": [s.to_dict() for s in schedules]
        })
        
    except Exception as e:
        self.send_event("ad-schedules", {"success": False, "error": str(e)})

async def handle_toggle_ad_schedule_status(self, payload: Dict[str, Any]):
    """切換廣告計劃狀態"""
    try:
        ad_manager = get_ad_manager()
        if not ad_manager:
            self.send_event("ad-schedule-toggled", {"success": False, "error": "廣告系統未初始化"})
            return
        
        schedule_id = payload.get('scheduleId')
        result = await ad_manager.toggle_schedule_status(schedule_id)
        
        if result.get('success'):
            scheduler = get_ad_scheduler()
            if scheduler:
                await scheduler.reload_triggers()
        
        self.send_event("ad-schedule-toggled", result)
        
    except Exception as e:
        self.send_event("ad-schedule-toggled", {"success": False, "error": str(e)})

async def handle_run_ad_schedule_now(self, payload: Dict[str, Any]):
    """立即執行廣告計劃"""
    try:
        scheduler = get_ad_scheduler()
        if not scheduler:
            self.send_event("ad-schedule-run-result", {"success": False, "error": "廣告排程器未初始化"})
            return
        
        schedule_id = payload.get('scheduleId')
        result = await scheduler.run_schedule_now(schedule_id)
        
        self.send_event("ad-schedule-run-result", result)
        
    except Exception as e:
        self.send_event("ad-schedule-run-result", {"success": False, "error": str(e)})

async def handle_send_ad_now(self, payload: Dict[str, Any]):
    """立即發送廣告"""
    try:
        broadcaster = get_ad_broadcaster()
        if not broadcaster:
            self.send_event("ad-send-result", {"success": False, "error": "廣告發送器未初始化"})
            return
        
        result = await broadcaster.send_now(
            template_id=payload.get('templateId'),
            target_groups=payload.get('targetGroups', []),
            account_phones=payload.get('accountPhones', []),
            account_strategy=payload.get('accountStrategy', 'rotate')
        )
        
        self.send_event("ad-send-result", result)
        
    except Exception as e:
        self.send_event("ad-send-result", {"success": False, "error": str(e)})

async def handle_get_ad_send_logs(self, payload: Dict[str, Any]):
    """獲取廣告發送記錄"""
    try:
        ad_manager = get_ad_manager()
        if not ad_manager:
            self.send_event("ad-send-logs", {"success": False, "error": "廣告系統未初始化"})
            return
        
        result = await ad_manager.get_send_logs(
            limit=payload.get('limit', 100),
            offset=payload.get('offset', 0),
            template_id=payload.get('templateId'),
            schedule_id=payload.get('scheduleId'),
            status=payload.get('status')
        )
        
        self.send_event("ad-send-logs", result)
        
    except Exception as e:
        self.send_event("ad-send-logs", {"success": False, "error": str(e)})

async def handle_get_ad_overview_stats(self, payload: Dict[str, Any]):
    """獲取廣告總覽統計"""
    try:
        analytics = get_ad_analytics()
        if not analytics:
            self.send_event("ad-overview-stats", {"success": False, "error": "廣告分析未初始化"})
            return
        
        days = payload.get('days', 7)
        result = await analytics.get_overview_stats(days)
        
        self.send_event("ad-overview-stats", result)
        
    except Exception as e:
        self.send_event("ad-overview-stats", {"success": False, "error": str(e)})

async def handle_get_ad_template_stats(self, payload: Dict[str, Any]):
    """獲取模板統計"""
    try:
        analytics = get_ad_analytics()
        if not analytics:
            self.send_event("ad-template-stats", {"success": False, "error": "廣告分析未初始化"})
            return
        
        template_id = payload.get('templateId')
        result = await analytics.get_template_stats(template_id)
        
        self.send_event("ad-template-stats", result)
        
    except Exception as e:
        self.send_event("ad-template-stats", {"success": False, "error": str(e)})

async def handle_get_ad_schedule_stats(self, payload: Dict[str, Any]):
    """獲取計劃統計"""
    try:
        analytics = get_ad_analytics()
        if not analytics:
            self.send_event("ad-schedule-stats", {"success": False, "error": "廣告分析未初始化"})
            return
        
        schedule_id = payload.get('scheduleId')
        result = await analytics.get_schedule_stats(schedule_id)
        
        self.send_event("ad-schedule-stats", result)
        
    except Exception as e:
        self.send_event("ad-schedule-stats", {"success": False, "error": str(e)})

async def handle_get_ad_account_stats(self, payload: Dict[str, Any]):
    """獲取帳號統計"""
    try:
        analytics = get_ad_analytics()
        if not analytics:
            self.send_event("ad-account-stats", {"success": False, "error": "廣告分析未初始化"})
            return
        
        days = payload.get('days', 7)
        result = await analytics.get_account_stats(days)
        
        self.send_event("ad-account-stats", result)
        
    except Exception as e:
        self.send_event("ad-account-stats", {"success": False, "error": str(e)})

async def handle_get_ad_group_stats(self, payload: Dict[str, Any]):
    """獲取群組統計"""
    try:
        analytics = get_ad_analytics()
        if not analytics:
            self.send_event("ad-group-stats", {"success": False, "error": "廣告分析未初始化"})
            return
        
        days = payload.get('days', 7)
        result = await analytics.get_group_stats(days)
        
        self.send_event("ad-group-stats", result)
        
    except Exception as e:
        self.send_event("ad-group-stats", {"success": False, "error": str(e)})

async def handle_get_ad_daily_stats(self, payload: Dict[str, Any]):
    """獲取每日統計"""
    try:
        analytics = get_ad_analytics()
        if not analytics:
            self.send_event("ad-daily-stats", {"success": False, "error": "廣告分析未初始化"})
            return
        
        days = payload.get('days', 30)
        result = await analytics.get_daily_stats(days)
        
        self.send_event("ad-daily-stats", result)
        
    except Exception as e:
        self.send_event("ad-daily-stats", {"success": False, "error": str(e)})

