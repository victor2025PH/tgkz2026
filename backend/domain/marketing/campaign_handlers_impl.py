"""
Extracted handler implementations: marketing_campaigns
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


# ==================== Campaign Handlers (營銷活動協調器) ====================

async def handle_create_campaign(self, payload: Dict[str, Any]):
    """創建營銷活動"""
    try:
        orchestrator = get_campaign_orchestrator()
        if not orchestrator:
            self.send_event("campaign-created", {"success": False, "error": "營銷活動系統未初始化"})
            return
        
        result = await orchestrator.create_campaign(
            name=payload.get('name', ''),
            description=payload.get('description', ''),
            phases=payload.get('phases'),
            target_groups=payload.get('targetGroups', []),
            assigned_accounts=payload.get('assignedAccounts', []),
            keywords=payload.get('keywords', []),
            ad_template_id=payload.get('adTemplateId'),
            settings=payload.get('settings', {})
        )
        
        if result.get('success'):
            self.send_log(f"營銷活動已創建: {result.get('name')}", "success")
        
        self.send_event("campaign-created", result)
        
    except Exception as e:
        self.send_event("campaign-created", {"success": False, "error": str(e)})


async def handle_update_campaign(self, payload: Dict[str, Any]):
    """更新營銷活動"""
    try:
        orchestrator = get_campaign_orchestrator()
        if not orchestrator:
            self.send_event("campaign-updated", {"success": False, "error": "營銷活動系統未初始化"})
            return
        
        result = await orchestrator.update_campaign(
            campaign_id=payload.get('campaignId'),
            updates=payload.get('updates', {})
        )
        
        self.send_event("campaign-updated", result)
        
    except Exception as e:
        self.send_event("campaign-updated", {"success": False, "error": str(e)})


async def handle_delete_campaign(self, payload: Dict[str, Any]):
    """刪除營銷活動"""
    try:
        orchestrator = get_campaign_orchestrator()
        if not orchestrator:
            self.send_event("campaign-deleted", {"success": False, "error": "營銷活動系統未初始化"})
            return
        
        result = await orchestrator.delete_campaign(payload.get('campaignId'))
        
        if result.get('success'):
            self.send_log("營銷活動已刪除", "info")
        
        self.send_event("campaign-deleted", result)
        
    except Exception as e:
        self.send_event("campaign-deleted", {"success": False, "error": str(e)})


async def handle_start_campaign(self, payload: Dict[str, Any]):
    """啟動營銷活動"""
    try:
        orchestrator = get_campaign_orchestrator()
        if not orchestrator:
            self.send_event("campaign-started", {"success": False, "error": "營銷活動系統未初始化"})
            return
        
        result = await orchestrator.start_campaign(payload.get('campaignId'))
        
        # Event is sent by orchestrator
        
    except Exception as e:
        self.send_event("campaign-started", {"success": False, "error": str(e)})


async def handle_pause_campaign(self, payload: Dict[str, Any]):
    """暫停營銷活動"""
    try:
        orchestrator = get_campaign_orchestrator()
        if not orchestrator:
            self.send_event("campaign-paused", {"success": False, "error": "營銷活動系統未初始化"})
            return
        
        result = await orchestrator.pause_campaign(payload.get('campaignId'))
        
        self.send_event("campaign-paused", result)
        
    except Exception as e:
        self.send_event("campaign-paused", {"success": False, "error": str(e)})


async def handle_resume_campaign(self, payload: Dict[str, Any]):
    """恢復營銷活動"""
    try:
        orchestrator = get_campaign_orchestrator()
        if not orchestrator:
            self.send_event("campaign-resumed", {"success": False, "error": "營銷活動系統未初始化"})
            return
        
        result = await orchestrator.resume_campaign(payload.get('campaignId'))
        
        # Event is sent by start_campaign
        
    except Exception as e:
        self.send_event("campaign-resumed", {"success": False, "error": str(e)})


async def handle_stop_campaign(self, payload: Dict[str, Any]):
    """停止營銷活動"""
    try:
        orchestrator = get_campaign_orchestrator()
        if not orchestrator:
            self.send_event("campaign-stopped", {"success": False, "error": "營銷活動系統未初始化"})
            return
        
        result = await orchestrator.stop_campaign(payload.get('campaignId'))
        
        # Event is sent by orchestrator
        
    except Exception as e:
        self.send_event("campaign-stopped", {"success": False, "error": str(e)})

