"""
Extracted handler implementations: marketing_tasks
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

from service_locator import marketing_outreach_service, get_marketing_task_service
# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


# ==================== ğŸ†• P1-1: Marketing Task Handlers ====================

async def handle_get_marketing_tasks(self, payload: Dict[str, Any]):
    """ç²å–ç‡ŸéŠ·ä»»å‹™åˆ—è¡¨"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-tasks-loaded", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        result = await service.get_all_tasks(
            status=payload.get('status'),
            goal_type=payload.get('goalType'),
            limit=payload.get('limit', 100)
        )
        self.send_event("marketing-tasks-loaded", result)
        
    except Exception as e:
        self.send_event("marketing-tasks-loaded", {"success": False, "error": str(e)})


async def handle_create_marketing_task(self, payload: Dict[str, Any]):
    """å‰µå»ºç‡ŸéŠ·ä»»å‹™"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-created", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        result = await service.create_task(
            name=payload.get('name'),
            goal_type=payload.get('goalType', 'conversion'),
            execution_mode=payload.get('executionMode', 'hybrid'),
            description=payload.get('description'),
            target_criteria=payload.get('targetCriteria'),
            role_config=payload.get('roleConfig'),
            schedule_config=payload.get('scheduleConfig'),
            created_by=payload.get('createdBy')
        )
        # Event is sent by the service
        
    except Exception as e:
        self.send_event("marketing-task-created", {"success": False, "error": str(e)})


async def handle_update_marketing_task(self, payload: Dict[str, Any]):
    """æ›´æ–°ç‡ŸéŠ·ä»»å‹™"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-updated", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        task_id = payload.get('id')
        if not task_id:
            self.send_event("marketing-task-updated", {"success": False, "error": "ç¼ºå°‘ä»»å‹™ID"})
            return
        
        # Remove 'id' from updates
        updates = {k: v for k, v in payload.items() if k != 'id'}
        result = await service.update_task(int(task_id), updates)
        # Event is sent by the service
        
    except Exception as e:
        self.send_event("marketing-task-updated", {"success": False, "error": str(e)})


async def handle_delete_marketing_task(self, payload: Dict[str, Any]):
    """åˆªé™¤ç‡ŸéŠ·ä»»å‹™"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-deleted", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        task_id = payload.get('id')
        if not task_id:
            self.send_event("marketing-task-deleted", {"success": False, "error": "ç¼ºå°‘ä»»å‹™ID"})
            return
        
        result = await service.delete_task(int(task_id))
        # Event is sent by the service
        
    except Exception as e:
        self.send_event("marketing-task-deleted", {"success": False, "error": str(e)})


async def handle_start_marketing_task(self, payload: Dict[str, Any]):
    """å•Ÿå‹•ç‡ŸéŠ·ä»»å‹™"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-started", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        task_id = payload.get('id')
        if not task_id:
            self.send_event("marketing-task-started", {"success": False, "error": "ç¼ºå°‘ä»»å‹™ID"})
            return
        
        result = await service.start_task(int(task_id))
        self.send_event("marketing-task-started", result)
        
    except Exception as e:
        self.send_event("marketing-task-started", {"success": False, "error": str(e)})


async def handle_pause_marketing_task(self, payload: Dict[str, Any]):
    """æš«åœç‡ŸéŠ·ä»»å‹™"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-paused", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        task_id = payload.get('id')
        if not task_id:
            self.send_event("marketing-task-paused", {"success": False, "error": "ç¼ºå°‘ä»»å‹™ID"})
            return
        
        result = await service.pause_task(int(task_id))
        self.send_event("marketing-task-paused", result)
        
    except Exception as e:
        self.send_event("marketing-task-paused", {"success": False, "error": str(e)})


async def handle_resume_marketing_task(self, payload: Dict[str, Any]):
    """æ¢å¾©ç‡ŸéŠ·ä»»å‹™"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-resumed", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        task_id = payload.get('id')
        if not task_id:
            self.send_event("marketing-task-resumed", {"success": False, "error": "ç¼ºå°‘ä»»å‹™ID"})
            return
        
        result = await service.resume_task(int(task_id))
        self.send_event("marketing-task-resumed", result)
        
    except Exception as e:
        self.send_event("marketing-task-resumed", {"success": False, "error": str(e)})


async def handle_complete_marketing_task(self, payload: Dict[str, Any]):
    """å®Œæˆç‡ŸéŠ·ä»»å‹™"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-completed", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        task_id = payload.get('id')
        if not task_id:
            self.send_event("marketing-task-completed", {"success": False, "error": "ç¼ºå°‘ä»»å‹™ID"})
            return
        
        result = await service.complete_task(int(task_id))
        self.send_event("marketing-task-completed", result)
        
    except Exception as e:
        self.send_event("marketing-task-completed", {"success": False, "error": str(e)})


async def handle_add_marketing_task_targets(self, payload: Dict[str, Any]):
    """æ·»åŠ ä»»å‹™ç›®æ¨™ç”¨æˆ¶"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-targets-added", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        task_id = payload.get('taskId')
        targets = payload.get('targets', [])
        if not task_id:
            self.send_event("marketing-task-targets-added", {"success": False, "error": "ç¼ºå°‘ä»»å‹™ID"})
            return
        
        result = await service.add_targets(int(task_id), targets)
        # Event is sent by the service
        
    except Exception as e:
        self.send_event("marketing-task-targets-added", {"success": False, "error": str(e)})


async def handle_get_marketing_task_targets(self, payload: Dict[str, Any]):
    """ç²å–ä»»å‹™ç›®æ¨™ç”¨æˆ¶"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-targets-loaded", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        task_id = payload.get('taskId')
        if not task_id:
            self.send_event("marketing-task-targets-loaded", {"success": False, "error": "ç¼ºå°‘ä»»å‹™ID"})
            return
        
        result = await service.get_task_targets(
            int(task_id),
            status=payload.get('status'),
            limit=payload.get('limit', 100)
        )
        self.send_event("marketing-task-targets-loaded", result)
        
    except Exception as e:
        self.send_event("marketing-task-targets-loaded", {"success": False, "error": str(e)})


async def handle_update_marketing_task_target(self, payload: Dict[str, Any]):
    """æ›´æ–°ç›®æ¨™ç‹€æ…‹"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-target-updated", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        task_id = payload.get('taskId')
        target_id = payload.get('targetId')
        status = payload.get('status')
        
        if not task_id or not target_id:
            self.send_event("marketing-task-target-updated", {"success": False, "error": "ç¼ºå°‘åƒæ•¸"})
            return
        
        result = await service.update_target_status(
            int(task_id), 
            int(target_id), 
            status,
            outcome=payload.get('outcome')
        )
        self.send_event("marketing-task-target-updated", result)
        
    except Exception as e:
        self.send_event("marketing-task-target-updated", {"success": False, "error": str(e)})


async def handle_assign_marketing_task_role(self, payload: Dict[str, Any]):
    """åˆ†é…ä»»å‹™è§’è‰²"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-role-assigned", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        task_id = payload.get('taskId')
        if not task_id:
            self.send_event("marketing-task-role-assigned", {"success": False, "error": "ç¼ºå°‘ä»»å‹™ID"})
            return
        
        result = await service.assign_role(
            int(task_id),
            role_type=payload.get('roleType'),
            role_name=payload.get('roleName'),
            account_id=payload.get('accountId'),
            account_phone=payload.get('accountPhone'),
            persona_prompt=payload.get('personaPrompt')
        )
        self.send_event("marketing-task-role-assigned", result)
        
    except Exception as e:
        self.send_event("marketing-task-role-assigned", {"success": False, "error": str(e)})


async def handle_auto_assign_marketing_task_roles(self, payload: Dict[str, Any]):
    """è‡ªå‹•åˆ†é…ä»»å‹™è§’è‰²"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-roles-assigned", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        task_id = payload.get('taskId')
        if not task_id:
            self.send_event("marketing-task-roles-assigned", {"success": False, "error": "ç¼ºå°‘ä»»å‹™ID"})
            return
        
        # TODO: Implement auto-assign logic
        self.send_event("marketing-task-roles-assigned", {"success": True, "assignedCount": 0})
        
    except Exception as e:
        self.send_event("marketing-task-roles-assigned", {"success": False, "error": str(e)})


async def handle_get_marketing_task_stats(self, payload: Dict[str, Any]):
    """ç²å–ä»»å‹™çµ±è¨ˆ"""
    try:
        service = get_marketing_task_service()
        if not service:
            self.send_event("marketing-task-stats-loaded", {"success": False, "error": "ç‡ŸéŠ·ä»»å‹™æœå‹™æœªåˆå§‹åŒ–"})
            return
        
        task_id = payload.get('taskId')
        if task_id:
            result = await service.get_task_stats(int(task_id))
        else:
            result = await service.get_overall_stats()
        
        self.send_event("marketing-task-stats-loaded", result)
        
    except Exception as e:
        self.send_event("marketing-task-stats-loaded", {"success": False, "error": str(e)})


async def handle_create_marketing_campaign(self, payload: Dict[str, Any]):
    """å‰µå»ºç‡ŸéŠ·æ´»å‹•"""
    try:
        name = payload.get('name', '')
        campaign_type = payload.get('type', 'pm')
        target_users = payload.get('targetUsers', [])
        target_group = payload.get('targetGroup')
        message_template = payload.get('messageTemplate')
        
        if not name:
            raise ValueError("æ´»å‹•åç¨±ä¸èƒ½ç‚ºç©º")
        
        campaign_id = await marketing_outreach_service.create_campaign(
            name=name,
            campaign_type=campaign_type,
            target_users=target_users,
            target_group=target_group,
            message_template=message_template
        )
        
        self.send_log(f"ğŸ“¢ å‰µå»ºç‡ŸéŠ·æ´»å‹•æˆåŠŸ: {name} (ID: {campaign_id})", "success")
        self.send_event("campaign-created", {
            "success": True,
            "campaignId": campaign_id,
            "name": name
        })
        
    except Exception as e:
        self.send_log(f"âŒ å‰µå»ºç‡ŸéŠ·æ´»å‹•å¤±æ•—: {e}", "error")
        self.send_event("campaign-created", {
            "success": False,
            "error": str(e)
        })


async def handle_start_marketing_campaign(self, payload: Dict[str, Any]):
    """å•Ÿå‹•ç‡ŸéŠ·æ´»å‹•"""
    try:
        campaign_id = payload.get('campaignId')
        
        if not campaign_id:
            raise ValueError("æ´»å‹• ID ä¸èƒ½ç‚ºç©º")
        
        # è¨­ç½®å®¢æˆ¶ç«¯
        marketing_outreach_service.set_clients(self.telegram_manager.clients)
        marketing_outreach_service.set_event_callback(self.send_event)
        
        self.send_log(f"ğŸš€ å•Ÿå‹•ç‡ŸéŠ·æ´»å‹•: {campaign_id}", "info")
        
        # åœ¨å¾Œå°åŸ·è¡Œ
        async def campaign_task():
            result = await marketing_outreach_service.start_campaign(campaign_id)
            self.send_event("campaign-complete", {
                "campaignId": campaign_id,
                **result
            })
        
        asyncio.create_task(campaign_task())
        
        self.send_event("campaign-started", {
            "success": True,
            "campaignId": campaign_id
        })
        
    except Exception as e:
        self.send_log(f"âŒ å•Ÿå‹•ç‡ŸéŠ·æ´»å‹•å¤±æ•—: {e}", "error")
        self.send_event("campaign-complete", {
            "success": False,
            "error": str(e)
        })


async def handle_get_marketing_stats(self, payload: Dict[str, Any]):
    """ç²å–ç‡ŸéŠ·çµ±è¨ˆ"""
    try:
        campaign_id = payload.get('campaignId')
        
        stats = await marketing_outreach_service.get_campaign_stats(campaign_id)
        
        self.send_event("marketing-stats", {
            "success": True,
            "stats": stats
        })
        
    except Exception as e:
        self.send_log(f"âŒ ç²å–ç‡ŸéŠ·çµ±è¨ˆå¤±æ•—: {e}", "error")
        self.send_event("marketing-stats", {
            "success": False,
            "error": str(e)
        })

