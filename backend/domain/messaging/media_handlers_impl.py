"""
Extracted handler implementations: media
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


async def handle_add_media(self, payload: Dict[str, Any]):
    """Add image or video to media library"""
    try:
        media_type = payload.get('mediaType', 'image')
        file_path = payload.get('filePath')
        base64_data = payload.get('base64Data')
        name = payload.get('name')
        category = payload.get('category', 'general')
        tags = payload.get('tags', [])
        description = payload.get('description')
        
        if media_type == 'image':
            result = await media_manager.add_image(
                file_path=file_path,
                base64_data=base64_data,
                name=name,
                category=category,
                tags=tags,
                description=description
            )
        else:
            result = await media_manager.add_video(
                file_path=file_path,
                base64_data=base64_data,
                name=name,
                category=category,
                tags=tags,
                description=description
            )
        
        self.send_event("media-added", result)
        if result.get('success'):
            self.send_log(f"媒體已添加: {result.get('name')}", "success")
    except Exception as e:
        self.send_event("media-added", {
            "success": False,
            "error": str(e)
        })


async def handle_get_media(self, payload: Dict[str, Any]):
    """Get media resources"""
    try:
        media_type = payload.get('mediaType')
        category = payload.get('category')
        
        media = await media_manager.get_all_media(media_type, category)
        
        self.send_event("media-list", {
            "success": True,
            "media": media
        })
    except Exception as e:
        self.send_event("media-list", {
            "success": False,
            "error": str(e)
        })


async def handle_delete_media(self, payload: Dict[str, Any]):
    """Delete a media resource"""
    try:
        media_id = payload.get('id')
        await media_manager.delete_media(media_id)
        
        self.send_event("media-deleted", {"success": True, "id": media_id})
        self.send_log("媒體已刪除", "success")
    except Exception as e:
        self.send_event("media-deleted", {
            "success": False,
            "error": str(e)
        })

