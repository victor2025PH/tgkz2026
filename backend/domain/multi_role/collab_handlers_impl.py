"""
Extracted handler implementations: collab
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context
from database import db

from service_locator import get_collaboration_coordinator
# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


async def handle_invite_lead_to_collab_group(self, payload: Dict[str, Any]):
    """é‚€è«‹ Lead é€²å…¥å”ä½œç¾¤çµ„"""
    try:
        lead_id = payload.get('leadId')
        user_id = payload.get('userId')
        username = payload.get('username')
        group_id = payload.get('groupId')
        
        if not user_id or not group_id:
            self.send_event("invite-result", {
                "success": False,
                "error": "ç¼ºå°‘ç”¨æˆ¶ ID æˆ–ç¾¤çµ„ ID"
            })
            return
        
        self.send_log(f"ğŸ”— æ­£åœ¨é‚€è«‹ @{username or user_id} é€²å…¥å”ä½œç¾¤çµ„ {group_id}", "info")
        
        # ç²å–å”ä½œç¾¤çµ„ä¿¡æ¯
        collab_group = await db.fetch_one(
            'SELECT * FROM collab_groups WHERE id = ?',
            (group_id,)
        )
        
        if not collab_group:
            self.send_event("invite-result", {
                "success": False,
                "error": "å”ä½œç¾¤çµ„ä¸å­˜åœ¨"
            })
            return
        
        # ç²å–ç™¼é€å¸³è™Ÿï¼ˆç”¨æ–¼é‚€è«‹ï¼‰
        sender_accounts = [a for a in self.telegram_manager.active_clients.keys()]
        if not sender_accounts:
            self.send_event("invite-result", {
                "success": False,
                "error": "æ²’æœ‰å¯ç”¨çš„ç™¼é€å¸³è™Ÿ"
            })
            return
        
        # ä½¿ç”¨ç¬¬ä¸€å€‹å¯ç”¨çš„å¸³è™Ÿç™¼é€é‚€è«‹
        sender_phone = sender_accounts[0]
        client = self.telegram_manager.get_client(sender_phone)
        
        if client and client.is_connected():
            try:
                # å˜—è©¦é‚€è«‹ç”¨æˆ¶
                from telethon.tl.functions.channels import InviteToChannelRequest
                from telethon.tl.functions.messages import AddChatUserRequest
                
                # ç²å–ç›®æ¨™ç”¨æˆ¶å¯¦é«”
                target_user = await client.get_entity(int(user_id))
                
                # ç²å–ç¾¤çµ„å¯¦é«”
                group_chat_id = collab_group.get('chat_id')
                if group_chat_id:
                    group_entity = await client.get_entity(int(group_chat_id))
                    
                    # é‚€è«‹ç”¨æˆ¶
                    await client(InviteToChannelRequest(
                        channel=group_entity,
                        users=[target_user]
                    ))
                    
                    self.send_log(f"âœ“ å·²æˆåŠŸé‚€è«‹ @{username or user_id} é€²å…¥ç¾¤çµ„", "success")
                    self.send_event("invite-result", {
                        "success": True,
                        "userId": user_id,
                        "groupId": group_id
                    })
                    
                    # æ›´æ–° lead ç‹€æ…‹
                    await db.execute(
                        'UPDATE extracted_members SET invited = 1, invited_at = CURRENT_TIMESTAMP WHERE user_id = ?',
                        (str(user_id),)
                    )
                else:
                    self.send_event("invite-result", {
                        "success": False,
                        "error": "å”ä½œç¾¤çµ„æœªå‰µå»º Telegram ç¾¤"
                    })
                    
            except Exception as e:
                self.send_log(f"é‚€è«‹å¤±æ•—: {str(e)}", "error")
                self.send_event("invite-result", {
                    "success": False,
                    "error": str(e)
                })
        else:
            self.send_event("invite-result", {
                "success": False,
                "error": "ç™¼é€å¸³è™Ÿæœªé€£æ¥"
            })
            
    except Exception as e:
        self.send_log(f"é‚€è«‹ Lead é€²ç¾¤å¤±æ•—: {str(e)}", "error")
        import traceback
        traceback.print_exc()
        self.send_event("invite-result", {"success": False, "error": str(e)})


async def handle_create_collab_group_for_lead(self, payload: Dict[str, Any]):
    """ç‚ºé«˜æ„å‘å®¢æˆ¶è‡ªå‹•å‰µå»ºå”ä½œç¾¤çµ„"""
    try:
        lead_id = payload.get('leadId')
        user_id = payload.get('userId')
        username = payload.get('username')
        script_id = payload.get('scriptId')  # ä½¿ç”¨çš„åŠ‡æœ¬ ID
        
        if not user_id:
            self.send_event("create-collab-group-result", {
                "success": False,
                "error": "ç¼ºå°‘ç”¨æˆ¶ ID"
            })
            return
        
        self.send_log(f"ğŸ­ æ­£åœ¨ç‚º @{username or user_id} å‰µå»ºå¤šè§’è‰²å”ä½œç¾¤çµ„", "info")
        
        # å‰µå»ºå”ä½œç¾¤çµ„è¨˜éŒ„
        group_name = f"VIP-{username or user_id[:8]}"
        
        await db.execute('''
            INSERT INTO collab_groups (name, target_user_id, script_id, status, created_at)
            VALUES (?, ?, ?, 'pending', CURRENT_TIMESTAMP)
        ''', (group_name, str(user_id), script_id))
        
        # ç²å–å‰µå»ºçš„ç¾¤çµ„ ID
        result = await db.fetch_one(
            'SELECT id FROM collab_groups WHERE target_user_id = ? ORDER BY created_at DESC LIMIT 1',
            (str(user_id),)
        )
        
        if result:
            self.send_log(f"âœ“ å”ä½œç¾¤çµ„ '{group_name}' å‰µå»ºæˆåŠŸ", "success")
            self.send_event("create-collab-group-result", {
                "success": True,
                "groupId": result['id'],
                "groupName": group_name
            })
            
            # æ›´æ–° lead ç‹€æ…‹
            await db.execute(
                'UPDATE extracted_members SET notes = notes || ? WHERE user_id = ?',
                (f'\nğŸ­ å·²å‰µå»ºå”ä½œç¾¤çµ„: {group_name}', str(user_id))
            )
        else:
            self.send_event("create-collab-group-result", {
                "success": False,
                "error": "å‰µå»ºç¾¤çµ„è¨˜éŒ„å¤±æ•—"
            })
            
    except Exception as e:
        self.send_log(f"å‰µå»ºå”ä½œç¾¤çµ„å¤±æ•—: {str(e)}", "error")
        import traceback
        traceback.print_exc()
        self.send_event("create-collab-group-result", {"success": False, "error": str(e)})


async def handle_create_collab_group(self, payload: Dict[str, Any]):
    """å‰µå»ºå”ä½œç¾¤çµ„"""
    try:
        coordinator = get_collaboration_coordinator()
        if not coordinator:
            self.send_event("collab-group-created", {"success": False, "error": "å”ä½œå”èª¿å™¨æœªåˆå§‹åŒ–"})
            return
        
        result = await coordinator.create_collab_group(
            group_title=payload.get('groupTitle'),
            creator_phone=payload.get('creatorPhone'),
            purpose=payload.get('purpose', 'conversion'),
            target_user_id=payload.get('targetUserId'),
            target_username=payload.get('targetUsername')
        )
        
    except Exception as e:
        self.send_event("collab-group-created", {"success": False, "error": str(e)})


async def handle_add_collab_member(self, payload: Dict[str, Any]):
    """æ·»åŠ å”ä½œæˆå“¡"""
    try:
        coordinator = get_collaboration_coordinator()
        if not coordinator:
            self.send_event("collab-member-added", {"success": False, "error": "å”ä½œå”èª¿å™¨æœªåˆå§‹åŒ–"})
            return
        
        result = await coordinator.add_member(
            collab_id=payload.get('collabId'),
            account_phone=payload.get('accountPhone'),
            role_type=payload.get('roleType')
        )
        
    except Exception as e:
        self.send_event("collab-member-added", {"success": False, "error": str(e)})


async def handle_get_collab_groups(self, payload: Dict[str, Any]):
    """ç²å–å”ä½œç¾¤çµ„"""
    try:
        coordinator = get_collaboration_coordinator()
        if not coordinator:
            self.send_event("collab-groups", {"success": False, "error": "å”ä½œå”èª¿å™¨æœªåˆå§‹åŒ–"})
            return
        
        result = await coordinator.get_all_collab_groups(
            status=payload.get('status'),
            purpose=payload.get('purpose'),
            limit=payload.get('limit', 50)
        )
        
        self.send_event("collab-groups", result)
        
    except Exception as e:
        self.send_event("collab-groups", {"success": False, "error": str(e)})


async def handle_update_collab_status(self, payload: Dict[str, Any]):
    """æ›´æ–°å”ä½œç‹€æ…‹"""
    try:
        coordinator = get_collaboration_coordinator()
        if not coordinator:
            self.send_event("collab-group-updated", {"success": False, "error": "å”ä½œå”èª¿å™¨æœªåˆå§‹åŒ–"})
            return
        
        result = await coordinator.update_group_status(
            collab_id=payload.get('collabId'),
            status=payload.get('status'),
            outcome=payload.get('outcome')
        )
        
    except Exception as e:
        self.send_event("collab-group-updated", {"success": False, "error": str(e)})


async def handle_get_collab_stats(self, payload: Dict[str, Any]):
    """ç²å–å”ä½œçµ±è¨ˆ"""
    try:
        coordinator = get_collaboration_coordinator()
        if not coordinator:
            self.send_event("collab-stats", {"success": False, "error": "å”ä½œå”èª¿å™¨æœªåˆå§‹åŒ–"})
            return
        
        result = await coordinator.get_collab_stats()
        self.send_event("collab-stats", result)
        
    except Exception as e:
        self.send_event("collab-stats", {"success": False, "error": str(e)})

