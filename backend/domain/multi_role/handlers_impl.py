"""
Extracted handler implementations: multi_role
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

from service_locator import get_multi_role_manager
# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


# ========== å¤šè§’è‰²å”ä½œè™•ç†å™¨ ==========

async def handle_multi_role_add_role(self, payload: Dict[str, Any]):
    """æ·»åŠ è§’è‰²"""
    try:
        manager = get_multi_role_manager()
        result = await manager.add_role(payload)
        
        self.send_event("multi-role-role-added", result)
        
        if result.get("success"):
            self.send_log(f"ğŸ­ æ·»åŠ è§’è‰²: {payload.get('name', '')}", "success")
    except Exception as e:
        self.send_log(f"âŒ æ·»åŠ è§’è‰²å¤±æ•—: {e}", "error")
        self.send_event("multi-role-role-added", {"success": False, "error": str(e)})


async def handle_multi_role_update_role(self, payload: Dict[str, Any]):
    """æ›´æ–°è§’è‰²"""
    try:
        manager = get_multi_role_manager()
        role_id = payload.get("id")
        result = await manager.update_role(role_id, payload)
        
        self.send_event("multi-role-role-updated", result)
        
        if result.get("success"):
            self.send_log(f"ğŸ­ æ›´æ–°è§’è‰²: {role_id}", "success")
    except Exception as e:
        self.send_log(f"âŒ æ›´æ–°è§’è‰²å¤±æ•—: {e}", "error")
        self.send_event("multi-role-role-updated", {"success": False, "error": str(e)})


async def handle_multi_role_delete_role(self, payload: Dict[str, Any]):
    """åˆªé™¤è§’è‰²"""
    try:
        manager = get_multi_role_manager()
        role_id = payload.get("id")
        result = await manager.delete_role(role_id)
        
        self.send_event("multi-role-role-deleted", result)
        
        if result.get("success"):
            self.send_log(f"ğŸ—‘ï¸ åˆªé™¤è§’è‰²: {role_id}", "success")
    except Exception as e:
        self.send_log(f"âŒ åˆªé™¤è§’è‰²å¤±æ•—: {e}", "error")
        self.send_event("multi-role-role-deleted", {"success": False, "error": str(e)})


async def handle_multi_role_get_roles(self):
    """ç²å–æ‰€æœ‰è§’è‰²"""
    try:
        manager = get_multi_role_manager()
        roles = await manager.get_all_roles()
        
        self.send_event("multi-role-roles", {"success": True, "roles": roles})
    except Exception as e:
        self.send_log(f"âŒ ç²å–è§’è‰²å¤±æ•—: {e}", "error")
        self.send_event("multi-role-roles", {"success": False, "error": str(e)})


async def handle_multi_role_add_script(self, payload: Dict[str, Any]):
    """æ·»åŠ åŠ‡æœ¬"""
    try:
        manager = get_multi_role_manager()
        result = await manager.add_script(payload)
        
        self.send_event("multi-role-script-added", result)
        
        if result.get("success"):
            self.send_log(f"ğŸ“œ æ·»åŠ åŠ‡æœ¬: {payload.get('name', '')}", "success")
    except Exception as e:
        self.send_log(f"âŒ æ·»åŠ åŠ‡æœ¬å¤±æ•—: {e}", "error")
        self.send_event("multi-role-script-added", {"success": False, "error": str(e)})


async def handle_multi_role_update_script(self, payload: Dict[str, Any]):
    """æ›´æ–°åŠ‡æœ¬"""
    try:
        manager = get_multi_role_manager()
        script_id = payload.get("id")
        result = await manager.update_script(script_id, payload)
        
        self.send_event("multi-role-script-updated", result)
        
        if result.get("success"):
            self.send_log(f"ğŸ“œ æ›´æ–°åŠ‡æœ¬: {script_id}", "success")
    except Exception as e:
        self.send_log(f"âŒ æ›´æ–°åŠ‡æœ¬å¤±æ•—: {e}", "error")
        self.send_event("multi-role-script-updated", {"success": False, "error": str(e)})


async def handle_multi_role_delete_script(self, payload: Dict[str, Any]):
    """åˆªé™¤åŠ‡æœ¬"""
    try:
        manager = get_multi_role_manager()
        script_id = payload.get("id")
        result = await manager.delete_script(script_id)
        
        self.send_event("multi-role-script-deleted", result)
        
        if result.get("success"):
            self.send_log(f"ğŸ—‘ï¸ åˆªé™¤åŠ‡æœ¬: {script_id}", "success")
    except Exception as e:
        self.send_log(f"âŒ åˆªé™¤åŠ‡æœ¬å¤±æ•—: {e}", "error")
        self.send_event("multi-role-script-deleted", {"success": False, "error": str(e)})


async def handle_multi_role_get_scripts(self):
    """ç²å–æ‰€æœ‰åŠ‡æœ¬"""
    try:
        manager = get_multi_role_manager()
        scripts = await manager.get_all_scripts()
        
        self.send_event("multi-role-scripts", {"success": True, "scripts": scripts})
    except Exception as e:
        self.send_log(f"âŒ ç²å–åŠ‡æœ¬å¤±æ•—: {e}", "error")
        self.send_event("multi-role-scripts", {"success": False, "error": str(e)})


async def handle_multi_role_create_group(self, payload: Dict[str, Any]):
    """å‰µå»ºå”ä½œç¾¤çµ„"""
    try:
        manager = get_multi_role_manager()
        result = await manager.create_group(payload)
        
        self.send_event("multi-role-group-created", result)
        
        if result.get("success"):
            self.send_log(f"ğŸ‘¥ å‰µå»ºå”ä½œç¾¤çµ„: {payload.get('groupTitle', '')}", "success")
    except Exception as e:
        self.send_log(f"âŒ å‰µå»ºç¾¤çµ„å¤±æ•—: {e}", "error")
        self.send_event("multi-role-group-created", {"success": False, "error": str(e)})


async def handle_multi_role_update_group(self, payload: Dict[str, Any]):
    """æ›´æ–°ç¾¤çµ„"""
    try:
        manager = get_multi_role_manager()
        group_id = payload.get("id")
        result = await manager.update_group(group_id, payload)
        
        self.send_event("multi-role-group-updated", result)
    except Exception as e:
        self.send_log(f"âŒ æ›´æ–°ç¾¤çµ„å¤±æ•—: {e}", "error")
        self.send_event("multi-role-group-updated", {"success": False, "error": str(e)})


async def handle_multi_role_get_groups(self, payload: Dict[str, Any]):
    """ç²å–ç¾¤çµ„åˆ—è¡¨"""
    try:
        manager = get_multi_role_manager()
        status = payload.get("status") if payload else None
        groups = await manager.get_all_groups(status)
        
        self.send_event("multi-role-groups", {"success": True, "groups": groups})
    except Exception as e:
        self.send_log(f"âŒ ç²å–ç¾¤çµ„å¤±æ•—: {e}", "error")
        self.send_event("multi-role-groups", {"success": False, "error": str(e)})


async def handle_multi_role_get_stats(self):
    """ç²å–çµ±è¨ˆæ•¸æ“š"""
    try:
        manager = get_multi_role_manager()
        stats = await manager.get_stats()
        
        self.send_event("multi-role-stats", {"success": True, "stats": stats})
    except Exception as e:
        self.send_log(f"âŒ ç²å–çµ±è¨ˆå¤±æ•—: {e}", "error")
        self.send_event("multi-role-stats", {"success": False, "error": str(e)})


async def handle_multi_role_export_data(self):
    """å°å‡ºæ•¸æ“š"""
    try:
        manager = get_multi_role_manager()
        data = await manager.export_data()
        
        self.send_event("multi-role-data-exported", {"success": True, "data": data})
        self.send_log("ğŸ“¦ å¤šè§’è‰²æ•¸æ“šå°å‡ºå®Œæˆ", "success")
    except Exception as e:
        self.send_log(f"âŒ å°å‡ºæ•¸æ“šå¤±æ•—: {e}", "error")
        self.send_event("multi-role-data-exported", {"success": False, "error": str(e)})


async def handle_multi_role_import_data(self, payload: Dict[str, Any]):
    """å°å…¥æ•¸æ“š"""
    try:
        manager = get_multi_role_manager()
        result = await manager.import_data(payload.get("data", {}))
        
        self.send_event("multi-role-data-imported", result)
        
        if result.get("success"):
            self.send_log(f"ğŸ“¥ å¤šè§’è‰²æ•¸æ“šå°å…¥å®Œæˆ", "success")
    except Exception as e:
        self.send_log(f"âŒ å°å…¥æ•¸æ“šå¤±æ•—: {e}", "error")
        self.send_event("multi-role-data-imported", {"success": False, "error": str(e)})
        
    except Exception as e:
        self.send_log(f"âŒ ç²å–è¨è«–çµ„æ¶ˆæ¯å¤±æ•—: {e}", "error")
        self.send_event("discussion-messages", {
            "success": False,
            "error": str(e)
        })


# ==================== Multi-Role Group Handlers ====================

async def handle_create_multi_role_group(self, payload: Dict[str, Any]):
    """å‰µå»ºå¤šè§’è‰²å”ä½œç¾¤çµ„"""
    import sys
    
    try:
        group_name = payload.get('groupName', 'VIPå°ˆå±¬æœå‹™ç¾¤')
        target_user_id = payload.get('targetUserId')
        target_username = payload.get('targetUsername')
        role_accounts = payload.get('roleAccounts', [])
        invite_message = payload.get('inviteMessage', 'æ‚¨å¥½ï¼Œæˆ‘å€‘ç‚ºæ‚¨å‰µå»ºäº†å°ˆå±¬æœå‹™ç¾¤çµ„ï¼')
        
        print(f"[Backend] Creating multi-role group: {group_name} for {target_user_id}", file=sys.stderr)
        
        if not role_accounts:
            self.send_event("multi-role-group-created", {
                "success": False,
                "error": "æœªé…ç½®è§’è‰²å¸³è™Ÿ",
                "request": payload
            })
            return
        
        # ä½¿ç”¨ç¬¬ä¸€å€‹è§’è‰²å¸³è™Ÿå‰µå»ºç¾¤çµ„
        first_account_id = role_accounts[0].get('accountId')
        
        # ç²å– Telegram å®¢æˆ¶ç«¯
        client = self.telegram_manager.get_client(first_account_id)
        if not client:
            self.send_event("multi-role-group-created", {
                "success": False,
                "error": f"å¸³è™Ÿ {first_account_id} æœªé€£æ¥",
                "request": payload
            })
            return
        
        # æº–å‚™è¦é‚€è«‹çš„ç”¨æˆ¶åˆ—è¡¨
        users_to_invite = []
        
        # æ·»åŠ ç›®æ¨™ç”¨æˆ¶
        if target_username:
            users_to_invite.append(target_username)
        elif target_user_id:
            users_to_invite.append(int(target_user_id) if str(target_user_id).isdigit() else target_user_id)
        
        # æ·»åŠ å…¶ä»–è§’è‰²å¸³è™Ÿï¼ˆå¦‚æœæ˜¯ä¸åŒçš„å¸³è™Ÿï¼‰
        # å¯¦éš›æƒ…æ³ä¸­ï¼Œå¤šå€‹è§’è‰²å¯èƒ½ä½¿ç”¨åŒä¸€å€‹å¸³è™Ÿæˆ–ä¸åŒå¸³è™Ÿ
        # é€™è£¡ç°¡åŒ–è™•ç†
        
        # å‰µå»ºç¾¤çµ„
        try:
            from pyrogram.raw import functions, types
            
            # å‰µå»ºè¶…ç´šç¾¤çµ„
            result = await client.invoke(
                functions.channels.CreateChannel(
                    title=group_name,
                    about=f"å°ˆå±¬æœå‹™ç¾¤çµ„ - {target_username or target_user_id}",
                    megagroup=True
                )
            )
            
            # ç²å–å‰µå»ºçš„ç¾¤çµ„
            if hasattr(result, 'chats') and result.chats:
                telegram_group = result.chats[0]
                telegram_group_id = telegram_group.id
                
                # é‚€è«‹ç›®æ¨™ç”¨æˆ¶
                if users_to_invite:
                    try:
                        await client.add_chat_members(
                            -1000000000000 - telegram_group_id,  # è¶…ç´šç¾¤çµ„ ID æ ¼å¼
                            users_to_invite
                        )
                    except Exception as invite_err:
                        print(f"[Backend] Failed to invite users: {invite_err}", file=sys.stderr)
                
                # ç²å–é‚€è«‹é€£çµ
                invite_link = None
                try:
                    link = await client.export_chat_invite_link(-1000000000000 - telegram_group_id)
                    invite_link = link
                except:
                    pass
                
                # ç™¼é€æ­¡è¿æ¶ˆæ¯
                if invite_message:
                    try:
                        await client.send_message(
                            -1000000000000 - telegram_group_id,
                            invite_message
                        )
                    except:
                        pass
                
                # ç”Ÿæˆç¾¤çµ„ ID
                group_id = f"mrg_{telegram_group_id}_{int(time.time())}"
                
                self.send_event("multi-role-group-created", {
                    "success": True,
                    "groupId": group_id,
                    "telegramGroupId": str(telegram_group_id),
                    "inviteLink": invite_link,
                    "request": payload
                })
                
                self.send_log(f"âœ… å¤šè§’è‰²ç¾¤çµ„å‰µå»ºæˆåŠŸ: {group_name}", "info")
            else:
                self.send_event("multi-role-group-created", {
                    "success": False,
                    "error": "å‰µå»ºç¾¤çµ„å¤±æ•—",
                    "request": payload
                })
                
        except Exception as create_err:
            print(f"[Backend] Create group error: {create_err}", file=sys.stderr)
            self.send_event("multi-role-group-created", {
                "success": False,
                "error": str(create_err),
                "request": payload
            })
            
    except Exception as e:
        print(f"[Backend] Multi-role group creation error: {e}", file=sys.stderr)
        self.send_event("multi-role-group-created", {
            "success": False,
            "error": str(e),
            "request": payload
        })


async def handle_multi_role_start_script(self, payload: Dict[str, Any]):
    """é–‹å§‹åŸ·è¡Œå¤šè§’è‰²åŠ‡æœ¬"""
    import sys
    
    try:
        group_id = payload.get('groupId')
        script_id = payload.get('scriptId')
        
        print(f"[Backend] Starting script {script_id} for group {group_id}", file=sys.stderr)
        
        # TODO: å¾æ•¸æ“šåº«è¼‰å…¥åŠ‡æœ¬ä¸¦é–‹å§‹åŸ·è¡Œ
        # é€™è£¡éœ€è¦èˆ‡ script_engine æ•´åˆ
        
        self.send_log(f"ğŸ“ åŠ‡æœ¬ {script_id} å·²é–‹å§‹åŸ·è¡Œ", "info")
        
    except Exception as e:
        print(f"[Backend] Start script error: {e}", file=sys.stderr)


async def handle_multi_role_send_message(self, payload: Dict[str, Any]):
    """ç™¼é€å¤šè§’è‰²æ¶ˆæ¯"""
    import sys
    
    try:
        group_id = payload.get('groupId')
        telegram_group_id = payload.get('telegramGroupId')
        account_id = payload.get('accountId')
        content = payload.get('content')
        
        print(f"[Backend] Sending message to group {telegram_group_id} from account {account_id}", file=sys.stderr)
        
        client = self.telegram_manager.get_client(account_id)
        if not client:
            return
        
        try:
            # ç™¼é€æ¶ˆæ¯åˆ°ç¾¤çµ„
            chat_id = int(telegram_group_id)
            if chat_id > 0:
                chat_id = -1000000000000 - chat_id
            
            await client.send_message(chat_id, content)
            
            self.send_event("multi-role-group-message", {
                "groupId": group_id,
                "senderId": str(account_id),
                "senderName": "Role",  # TODO: å¾è§’è‰²é…ç½®ç²å–
                "content": content,
                "isFromTarget": False
            })
            
        except Exception as send_err:
            print(f"[Backend] Send message error: {send_err}", file=sys.stderr)
            
    except Exception as e:
        print(f"[Backend] Multi-role send message error: {e}", file=sys.stderr)


async def handle_multi_role_ai_reply(self, payload: Dict[str, Any]):
    """AI ç”Ÿæˆå›è¦†"""
    import sys
    
    try:
        group_id = payload.get('groupId')
        message = payload.get('message')
        customer_id = payload.get('customerId')
        
        print(f"[Backend] Generating AI reply for group {group_id}", file=sys.stderr)
        
        # TODO: ä½¿ç”¨ AI ç”Ÿæˆå›è¦†
        # é€™è£¡éœ€è¦èˆ‡ ai_auto_chat æ•´åˆ
        
        # æ¨¡æ“¬ AI å›è¦†
        ai_reply = f"æ„Ÿè¬æ‚¨çš„å›è¦†ï¼æˆ‘å€‘æœƒç›¡å¿«ç‚ºæ‚¨è™•ç†ã€‚"
        
        # ç™¼é€å›è¦†ï¼ˆéœ€è¦ç²å–ç¾¤çµ„çš„å¸³è™Ÿé…ç½®ï¼‰
        # TODO: å¯¦ç¾å®Œæ•´çš„ AI å›è¦†é‚è¼¯
        
    except Exception as e:
        print(f"[Backend] AI reply error: {e}", file=sys.stderr)


async def handle_multi_role_advance_stage(self, payload: Dict[str, Any]):
    """æ¨é€²åŠ‡æœ¬éšæ®µ"""
    import sys
    
    try:
        group_id = payload.get('groupId')
        next_stage_order = payload.get('nextStageOrder')
        
        print(f"[Backend] Advancing to stage {next_stage_order} for group {group_id}", file=sys.stderr)
        
        # TODO: åŸ·è¡Œä¸‹ä¸€éšæ®µçš„åŠ‡æœ¬
        # é€™è£¡éœ€è¦èˆ‡ script_engine æ•´åˆ
        
    except Exception as e:
        print(f"[Backend] Advance stage error: {e}", file=sys.stderr)


# ============ ğŸ†• Phase3: å…¨éˆè·¯è‡ªå‹•åŒ–å·¥ä½œæµ ============

async def handle_multi_role_ai_plan(self, payload: Dict[str, Any]):
    """è™•ç† AI æ™ºèƒ½ç­–åŠƒè«‹æ±‚"""
    import sys
    
    try:
        from automation_workflow import get_automation_workflow_service
        
        service = get_automation_workflow_service()
        result = await service.handle_ai_plan(payload)
        
        self.send_event("multi-role:ai-plan-result", result)
        print(f"[AutomationWorkflow] AI ç­–åŠƒå®Œæˆ: success={result.get('success')}", file=sys.stderr)
        
    except Exception as e:
        print(f"[AutomationWorkflow] AI ç­–åŠƒéŒ¯èª¤: {e}", file=sys.stderr)
        self.send_event("multi-role:ai-plan-result", {"success": False, "error": str(e)})


async def handle_multi_role_start_private_collaboration(self, payload: Dict[str, Any]):
    """é–‹å§‹ç§èŠå”ä½œ"""
    import sys
    
    try:
        from automation_workflow import get_automation_workflow_service
        
        service = get_automation_workflow_service()
        result = await service.handle_start_private_collaboration(payload)
        
        self.send_event("multi-role:private-collaboration-started", result)
        print(f"[AutomationWorkflow] ç§èŠå”ä½œå·²é–‹å§‹: {result.get('executionId')}", file=sys.stderr)
        
    except Exception as e:
        print(f"[AutomationWorkflow] é–‹å§‹ç§èŠå¤±æ•—: {e}", file=sys.stderr)
        self.send_event("multi-role:private-collaboration-started", {"success": False, "error": str(e)})


async def handle_multi_role_auto_create_group(self, payload: Dict[str, Any]):
    """è‡ªå‹•å‰µå»ºç¾¤çµ„"""
    import sys
    
    try:
        from automation_workflow import get_automation_workflow_service
        
        service = get_automation_workflow_service()
        result = await service.handle_auto_create_group(payload)
        
        self.send_event("multi-role:group-created", result)
        print(f"[AutomationWorkflow] å»ºç¾¤çµæœ: success={result.get('success')}", file=sys.stderr)
        
    except Exception as e:
        print(f"[AutomationWorkflow] å»ºç¾¤éŒ¯èª¤: {e}", file=sys.stderr)
        self.send_event("multi-role:group-created", {"success": False, "error": str(e)})


async def handle_multi_role_start_group_collaboration(self, payload: Dict[str, Any]):
    """é–‹å§‹çµ„ç¾¤ç‡ŸéŠ·"""
    import sys
    
    try:
        from automation_workflow import get_automation_workflow_service
        
        service = get_automation_workflow_service()
        result = await service.handle_start_group_collaboration(payload)
        
        self.send_event("multi-role:group-collaboration-started", result)
        print(f"[AutomationWorkflow] çµ„ç¾¤ç‡ŸéŠ·å·²é–‹å§‹: group={payload.get('groupId')}", file=sys.stderr)
        
    except Exception as e:
        print(f"[AutomationWorkflow] çµ„ç¾¤ç‡ŸéŠ·éŒ¯èª¤: {e}", file=sys.stderr)
        self.send_event("multi-role:group-collaboration-started", {"success": False, "error": str(e)})

