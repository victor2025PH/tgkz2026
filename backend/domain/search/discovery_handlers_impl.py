"""
Extracted handler implementations: discovery
Auto-generated by refactor_main.py
"""
import json
import sys
import time
import asyncio
import traceback
from datetime import datetime, timedelta
from typing import Any, Dict, List, Optional

from service_context import get_service_context

# All handlers receive (self, payload) where self is BackendService instance.
# They are called via: await handler_impl(self, payload)
# Inside, use self.db, self.send_event(), self.telegram_manager, etc.
# This is a transitional pattern - later, replace self.xxx with ctx.xxx


async def handle_get_discovery_keywords(self):
    """ç²å–æœç´¢é—œéµè©åˆ—è¡¨"""
    try:
        keywords = await resource_discovery.get_search_keywords()
        
        self.send_event("discovery-keywords", {
            "success": True,
            "keywords": keywords
        })
        
    except Exception as e:
        self.send_log(f"âŒ ç²å–é—œéµè©å¤±æ•—: {e}", "error")
        self.send_event("discovery-keywords", {
            "success": False,
            "error": str(e)
        })


async def handle_add_discovery_keyword(self, payload: Dict[str, Any]):
    """æ·»åŠ æœç´¢é—œéµè©"""
    try:
        keyword = payload.get('keyword', '').strip()
        category = payload.get('category', 'general')
        priority = payload.get('priority', 5)
        
        if not keyword:
            raise ValueError("é—œéµè©ä¸èƒ½ç‚ºç©º")
        
        keyword_id = await resource_discovery.add_search_keyword(keyword, category, priority)
        
        self.send_log(f"â• æ·»åŠ æœç´¢é—œéµè©: {keyword}", "success")
        self.send_event("discovery-keyword-added", {
            "success": True,
            "keywordId": keyword_id,
            "keyword": keyword
        })
        
    except Exception as e:
        self.send_log(f"âŒ æ·»åŠ é—œéµè©å¤±æ•—: {e}", "error")
        self.send_event("discovery-keyword-added", {
            "success": False,
            "error": str(e)
        })


async def handle_get_discovery_logs(self, payload: Dict[str, Any]):
    """ç²å–æœç´¢æ—¥èªŒ"""
    try:
        limit = payload.get('limit', 50)
        logs = await resource_discovery.get_discovery_logs(limit=limit)
        
        self.send_event("discovery-logs", {
            "success": True,
            "logs": logs
        })
        
    except Exception as e:
        self.send_log(f"âŒ ç²å–æœç´¢æ—¥èªŒå¤±æ•—: {e}", "error")
        self.send_event("discovery-logs", {
            "success": False,
            "error": str(e)
        })


# ==================== Discussion Watcher Handlers ====================

async def handle_init_discussion_watcher(self):
    """åˆå§‹åŒ–è¨è«–çµ„ç›£æ§æœå‹™"""
    try:
        await discussion_watcher.initialize()
        discussion_watcher.set_clients(self.telegram_manager.clients)
        discussion_watcher.set_event_callback(self.send_event)
        
        # è¨­ç½®é—œéµè©åŒ¹é…å™¨
        from keyword_matcher import keyword_matcher
        discussion_watcher.set_keyword_matcher(keyword_matcher)
        
        self.send_log("âœ… è¨è«–çµ„ç›£æ§æœå‹™åˆå§‹åŒ–å®Œæˆ", "success")
        self.send_event("discussion-watcher-initialized", {"success": True})
        
    except Exception as e:
        self.send_log(f"âŒ è¨è«–çµ„ç›£æ§æœå‹™åˆå§‹åŒ–å¤±æ•—: {e}", "error")
        self.send_event("discussion-watcher-initialized", {
            "success": False,
            "error": str(e)
        })


async def handle_discover_discussion(self, payload: Dict[str, Any]):
    """ç™¼ç¾é »é“çš„è¨è«–çµ„"""
    try:
        channel_id = payload.get('channelId', '')
        phone = payload.get('phone')
        
        if not channel_id:
            raise ValueError("é »é“ ID ä¸èƒ½ç‚ºç©º")
        
        discussion_watcher.set_clients(self.telegram_manager.clients)
        discussion = await discussion_watcher.discover_discussion(channel_id, phone)
        
        if discussion:
            self.send_log(f"âœ… ç™¼ç¾è¨è«–çµ„: {discussion.discussion_title}", "success")
            self.send_event("discussion-discovered", {
                "success": True,
                "discussion": {
                    "id": discussion.id,
                    "channel_id": discussion.channel_id,
                    "channel_title": discussion.channel_title,
                    "discussion_id": discussion.discussion_id,
                    "discussion_title": discussion.discussion_title
                }
            })
        else:
            self.send_event("discussion-discovered", {
                "success": False,
                "error": "æœªæ‰¾åˆ°è¨è«–çµ„æˆ–é »é“ç„¡è¨è«–å€"
            })
        
    except Exception as e:
        self.send_log(f"âŒ ç™¼ç¾è¨è«–çµ„å¤±æ•—: {e}", "error")
        self.send_event("discussion-discovered", {
            "success": False,
            "error": str(e)
        })


async def handle_discover_discussions_from_resources(self):
    """å¾å·²ç™¼ç¾çš„è³‡æºä¸­ç™¼ç¾è¨è«–çµ„"""
    try:
        discussion_watcher.set_clients(self.telegram_manager.clients)
        discussions = await discussion_watcher.discover_from_resources()
        
        self.send_log(f"âœ… å¾è³‡æºç™¼ç¾äº† {len(discussions)} å€‹è¨è«–çµ„", "success")
        self.send_event("discussions-batch-discovered", {
            "success": True,
            "count": len(discussions),
            "discussions": [
                {
                    "id": d.id,
                    "channel_title": d.channel_title,
                    "discussion_title": d.discussion_title
                } for d in discussions
            ]
        })
        
    except Exception as e:
        self.send_log(f"âŒ æ‰¹é‡ç™¼ç¾è¨è«–çµ„å¤±æ•—: {e}", "error")
        self.send_event("discussions-batch-discovered", {
            "success": False,
            "error": str(e)
        })


async def handle_get_channel_discussions(self, payload: Dict[str, Any]):
    """ç²å–é »é“-è¨è«–çµ„åˆ—è¡¨"""
    try:
        active_only = payload.get('activeOnly', True)
        discussions = await discussion_watcher.list_channel_discussions(active_only)
        
        self.send_event("channel-discussions-list", {
            "success": True,
            "discussions": discussions
        })
        
    except Exception as e:
        self.send_log(f"âŒ ç²å–è¨è«–çµ„åˆ—è¡¨å¤±æ•—: {e}", "error")
        self.send_event("channel-discussions-list", {
            "success": False,
            "error": str(e)
        })


async def handle_start_discussion_monitoring(self, payload: Dict[str, Any]):
    """é–‹å§‹ç›£æ§è¨è«–çµ„"""
    try:
        discussion_id = payload.get('discussionId', '')
        phone = payload.get('phone')
        
        if not discussion_id:
            raise ValueError("è¨è«–çµ„ ID ä¸èƒ½ç‚ºç©º")
        
        discussion_watcher.set_clients(self.telegram_manager.clients)
        success = await discussion_watcher.start_monitoring(discussion_id, phone)
        
        if success:
            self.send_log(f"ğŸŸ¢ é–‹å§‹ç›£æ§è¨è«–çµ„: {discussion_id}", "success")
        
        self.send_event("discussion-monitoring-status", {
            "success": success,
            "discussion_id": discussion_id,
            "status": "monitoring" if success else "error"
        })
        
    except Exception as e:
        self.send_log(f"âŒ å•Ÿå‹•ç›£æ§å¤±æ•—: {e}", "error")
        self.send_event("discussion-monitoring-status", {
            "success": False,
            "error": str(e)
        })


async def handle_stop_discussion_monitoring(self, payload: Dict[str, Any]):
    """åœæ­¢ç›£æ§è¨è«–çµ„"""
    try:
        discussion_id = payload.get('discussionId', '')
        
        if not discussion_id:
            raise ValueError("è¨è«–çµ„ ID ä¸èƒ½ç‚ºç©º")
        
        success = await discussion_watcher.stop_monitoring(discussion_id)
        
        if success:
            self.send_log(f"ğŸ”´ åœæ­¢ç›£æ§è¨è«–çµ„: {discussion_id}", "success")
        
        self.send_event("discussion-monitoring-status", {
            "success": success,
            "discussion_id": discussion_id,
            "status": "stopped"
        })
        
    except Exception as e:
        self.send_log(f"âŒ åœæ­¢ç›£æ§å¤±æ•—: {e}", "error")
        self.send_event("discussion-monitoring-status", {
            "success": False,
            "error": str(e)
        })


async def handle_get_discussion_messages(self, payload: Dict[str, Any]):
    """ç²å–è¨è«–çµ„æ¶ˆæ¯"""
    try:
        discussion_id = payload.get('discussionId', '')
        limit = payload.get('limit', 50)
        matched_only = payload.get('matchedOnly', False)
        
        if not discussion_id:
            raise ValueError("è¨è«–çµ„ ID ä¸èƒ½ç‚ºç©º")
        
        messages = await discussion_watcher.get_discussion_messages(
            discussion_id, limit, matched_only
        )
        
        self.send_event("discussion-messages", {
            "success": True,
            "discussion_id": discussion_id,
            "messages": messages
        })
        
    except Exception as e:
        self.send_log(f"âŒ ç²å–æ¶ˆæ¯å¤±æ•—: {e}", "error")
        self.send_event("discussion-messages", {
            "success": False,
            "error": str(e)
        })


async def handle_reply_to_discussion(self, payload: Dict[str, Any]):
    """å›å¾©è¨è«–çµ„æ¶ˆæ¯"""
    try:
        discussion_id = payload.get('discussionId', '')
        message_id = payload.get('messageId')
        reply_text = payload.get('replyText', '')
        phone = payload.get('phone')
        
        if not discussion_id or not message_id or not reply_text:
            raise ValueError("è¨è«–çµ„ IDã€æ¶ˆæ¯ ID å’Œå›å¾©å…§å®¹ä¸èƒ½ç‚ºç©º")
        
        discussion_watcher.set_clients(self.telegram_manager.clients)
        result = await discussion_watcher.reply_to_message(
            discussion_id, message_id, reply_text, phone
        )
        
        if result['success']:
            self.send_log(f"âœ… å·²å›å¾©æ¶ˆæ¯ {message_id}", "success")
        
        self.send_event("discussion-reply-result", result)
        
    except Exception as e:
        self.send_log(f"âŒ å›å¾©å¤±æ•—: {e}", "error")
        self.send_event("discussion-reply-result", {
            "success": False,
            "error": str(e)
        })


async def handle_get_discussion_stats(self):
    """ç²å–è¨è«–çµ„ç›£æ§çµ±è¨ˆ"""
    try:
        stats = await discussion_watcher.get_statistics()
        
        self.send_event("discussion-stats", {
            "success": True,
            **stats
        })
        
    except Exception as e:
        self.send_log(f"âŒ ç²å–çµ±è¨ˆå¤±æ•—: {e}", "error")
        self.send_event("discussion-stats", {
            "success": False,
            "error": str(e)
        })

