import{b as k}from"./chunk-7LTHB4NI.js";import{a as y}from"./chunk-5HHK7KPZ.js";import{M as f,R as m,Zb as d,a as i,b as a,ga as l}from"./chunk-PDD6YQ47.js";var b={conversion:{icon:"\u{1F4B0}",label:"\u4FC3\u9032\u9996\u55AE",description:"\u628A\u7336\u8C6B\u4E0D\u6C7A\u7684\u6F5B\u5728\u5BA2\u6236\u8F49\u5316\u70BA\u4ED8\u8CBB\u7528\u6236",suggestedRoles:["expert","satisfied_customer","sales"],suggestedMode:"hybrid"},retention:{icon:"\u{1F49D}",label:"\u633D\u56DE\u6D41\u5931",description:"\u633D\u56DE\u5DF2\u6D41\u5931\u7684\u8001\u5BA2\u6236\uFF0C\u8B93\u4ED6\u5011\u91CD\u65B0\u8CFC\u8CB7",suggestedRoles:["callback","support","manager"],suggestedMode:"hybrid"},engagement:{icon:"\u{1F389}",label:"\u793E\u7FA4\u6D3B\u8E8D",description:"\u8B93\u793E\u7FA4\u66F4\u6D3B\u8E8D\uFF0C\u589E\u52A0\u7528\u6236\u4E92\u52D5\u548C\u7C98\u6027",suggestedRoles:["newbie","satisfied_customer","expert"],suggestedMode:"scriptless"},support:{icon:"\u{1F527}",label:"\u552E\u5F8C\u670D\u52D9",description:"\u9AD8\u6548\u8655\u7406\u5BA2\u6236\u552E\u5F8C\u554F\u984C\uFF0C\u63D0\u5347\u6EFF\u610F\u5EA6",suggestedRoles:["support","expert","manager"],suggestedMode:"scripted"}};function I(g="conversion"){let e=b[g];return{goalType:g,executionMode:e.suggestedMode,status:"draft",targetCount:0,stats:{totalContacts:0,contacted:0,replied:0,converted:0,messagesSent:0,aiCost:0,contactRate:0,replyRate:0,conversionRate:0}}}var S=class g{constructor(){this.ipc=m(y);this.toast=m(k);this._tasks=l([]);this.tasks=this._tasks.asReadonly();this._currentTask=l(null);this.currentTask=this._currentTask.asReadonly();this._isLoading=l(!1);this.isLoading=this._isLoading.asReadonly();this.activeTasks=d(()=>this._tasks().filter(e=>e.status==="running"||e.status==="scheduled"));this.todayStats=d(()=>{let e=new Date().toISOString().split("T")[0],t=this._tasks().filter(s=>s.createdAt.startsWith(e)||s.startedAt?.startsWith(e));return{totalTasks:t.length,contacted:t.reduce((s,n)=>s+n.stats.contacted,0),converted:t.reduce((s,n)=>s+n.stats.converted,0),messagesSent:t.reduce((s,n)=>s+n.stats.messagesSent,0),aiCost:t.reduce((s,n)=>s+n.stats.aiCost,0)}});this.tasksByGoal=d(()=>{let e={conversion:[],retention:[],engagement:[],support:[]};return this._tasks().forEach(t=>{e[t.goalType]?.push(t)}),e});this.overallConversionRate=d(()=>{let e=this._tasks().filter(n=>n.stats.contacted>0);if(e.length===0)return 0;let t=e.reduce((n,o)=>n+o.stats.contacted,0),s=e.reduce((n,o)=>n+o.stats.converted,0);return t>0?Math.round(s/t*100):0});this.setupIpcListeners(),this.loadTasks()}setupIpcListeners(){this.ipc.on("marketing-tasks-loaded",e=>{e.success&&e.tasks&&this._tasks.set(e.tasks.map(this.normalizeTask)),this._isLoading.set(!1)}),this.ipc.on("marketing-task-created",e=>{e.success&&e.task?(this._tasks.update(t=>[...t,this.normalizeTask(e.task)]),this.toast.success(`\u4EFB\u52D9\u300C${e.task.name}\u300D\u5275\u5EFA\u6210\u529F`)):this.toast.error(`\u5275\u5EFA\u5931\u6557: ${e.error}`)}),this.ipc.on("marketing-task-updated",e=>{e.success&&e.task&&this._tasks.update(t=>t.map(s=>s.id===e.task.id?this.normalizeTask(e.task):s))}),this.ipc.on("marketing-task-stats",e=>{e.taskId&&e.stats&&this._tasks.update(t=>t.map(s=>s.id===e.taskId?a(i({},s),{stats:i(i({},s.stats),e.stats)}):s))}),this.ipc.on("marketing-task-deleted",e=>{e.success&&e.taskId&&(this._tasks.update(t=>t.filter(s=>s.id!==e.taskId)),this.toast.success("\u4EFB\u52D9\u5DF2\u522A\u9664"))})}loadTasks(){this._isLoading.set(!0),this.ipc.send("get-marketing-tasks",{})}async createTask(e){let t=a(i(i({},I(e.goalType)),e),{createdAt:new Date().toISOString()});return new Promise(s=>{let n=this.ipc.on("marketing-task-created",o=>{n(),s(o.success?o.task?.id:null)});this.ipc.send("create-marketing-task",t),setTimeout(()=>{n(),s(null)},1e4)})}async quickCreate(e,t){let s=b[e];return this.createTask({name:`${s.label} - ${new Date().toLocaleDateString()}`,goalType:e,executionMode:s.suggestedMode,description:s.description,roleConfig:s.suggestedRoles.map(n=>({roleType:n,roleName:n}))})}updateTask(e,t){this.ipc.send("update-marketing-task",i({id:e},t))}deleteTask(e){this.ipc.send("delete-marketing-task",{id:e})}startTask(e){this.updateTask(e,{status:"running",startedAt:new Date().toISOString()}),this.ipc.send("start-marketing-task",{id:e})}pauseTask(e){this.updateTask(e,{status:"paused"}),this.ipc.send("pause-marketing-task",{id:e})}resumeTask(e){this.updateTask(e,{status:"running"}),this.ipc.send("resume-marketing-task",{id:e})}completeTask(e){this.updateTask(e,{status:"completed",completedAt:new Date().toISOString()}),this.ipc.send("complete-marketing-task",{id:e})}batchStartTasks(e){e.forEach(t=>this.startTask(t))}batchPauseTasks(e){e.forEach(t=>this.pauseTask(t))}batchResumeTasks(e){e.forEach(t=>this.resumeTask(t))}batchCompleteTasks(e){e.forEach(t=>this.completeTask(t))}batchDeleteTasks(e){e.forEach(t=>this.deleteTask(t))}async batchDuplicateTasks(e){let t=[];for(let s of e){let n=this._tasks().find(r=>r.id===s);if(!n)continue;let o=await this.createTask({name:`${n.name} (\u8907\u88FD)`,description:n.description,goalType:n.goalType,executionMode:n.executionMode,roleConfig:n.roleConfig,targetCriteria:n.targetCriteria,scheduleConfig:n.scheduleConfig});o&&t.push(o)}return t}getBatchOperationTasks(e){return e?this._tasks().filter(t=>t.status===e):this._tasks()}addTargets(e,t){this.ipc.send("add-marketing-task-targets",{taskId:e,targets:t})}updateTargetStatus(e,t,s,n){this.ipc.send("update-marketing-task-target",{taskId:e,targetId:t,status:s,outcome:n})}async getTaskTargets(e){return new Promise(t=>{let s=this.ipc.on("marketing-task-targets-loaded",n=>{s(),t(n.success?n.targets:[])});this.ipc.send("get-marketing-task-targets",{taskId:e}),setTimeout(()=>{s(),t([])},5e3)})}assignRole(e,t){this.ipc.send("assign-marketing-task-role",i({taskId:e},t))}async autoAssignRoles(e){return new Promise(t=>{let s=this.ipc.on("marketing-task-roles-assigned",n=>{s(),n.success&&this.toast.success(`\u5DF2\u81EA\u52D5\u5206\u914D ${n.assignedCount} \u500B\u89D2\u8272`),t(n.success)});this.ipc.send("auto-assign-marketing-task-roles",{taskId:e}),setTimeout(()=>{s(),t(!1)},1e4)})}async getTaskStats(e){return new Promise(t=>{let s=this.ipc.on("marketing-task-stats-loaded",n=>{s(),t(n.success?n.stats:null)});this.ipc.send("get-marketing-task-stats",{taskId:e}),setTimeout(()=>{s(),t(null)},5e3)})}getOverallStats(){let e=this._tasks();return{totalTasks:e.length,activeTasks:this.activeTasks().length,totalContacted:e.reduce((t,s)=>t+s.stats.contacted,0),totalConverted:e.reduce((t,s)=>t+s.stats.converted,0),conversionRate:this.overallConversionRate(),totalMessagesSent:e.reduce((t,s)=>t+s.stats.messagesSent,0),totalAiCost:e.reduce((t,s)=>t+s.stats.aiCost,0)}}normalizeTask(e){return{id:String(e.id),name:e.name||"\u672A\u547D\u540D\u4EFB\u52D9",description:e.description,goalType:e.goal_type||e.goalType||"conversion",aiConfigId:e.ai_config_id||e.aiConfigId,executionMode:e.execution_mode||e.executionMode||"hybrid",status:e.status||"draft",currentStage:e.current_stage||e.currentStage,targetCount:e.target_count||e.targetCount||0,targetCriteria:e.target_criteria?JSON.parse(e.target_criteria):e.targetCriteria,roleConfig:e.role_config?JSON.parse(e.role_config):e.roleConfig,scriptId:e.script_id||e.scriptId,scheduleConfig:e.schedule_config?JSON.parse(e.schedule_config):e.scheduleConfig,triggerConditions:e.trigger_conditions?JSON.parse(e.trigger_conditions):e.triggerConditions,stats:{totalContacts:e.stats_total_contacts||e.stats?.totalContacts||0,contacted:e.stats_contacted||e.stats?.contacted||0,replied:e.stats_replied||e.stats?.replied||0,converted:e.stats_converted||e.stats?.converted||0,messagesSent:e.stats_messages_sent||e.stats?.messagesSent||0,aiCost:e.stats_ai_cost||e.stats?.aiCost||0,contactRate:0,replyRate:0,conversionRate:0},createdAt:e.created_at||e.createdAt||new Date().toISOString(),startedAt:e.started_at||e.startedAt,completedAt:e.completed_at||e.completedAt,updatedAt:e.updated_at||e.updatedAt||new Date().toISOString(),createdBy:e.created_by||e.createdBy}}setCurrentTask(e){this._currentTask.set(e)}getTaskById(e){return this._tasks().find(t=>t.id===e)}static{this.\u0275fac=function(t){return new(t||g)}}static{this.\u0275prov=f({token:g,factory:g.\u0275fac,providedIn:"root"})}};var C={models:[],defaultModelId:"",modelUsage:{intentRecognition:"",dailyChat:"",multiRoleScript:""},conversationStrategy:{style:"friendly",responseLength:"medium",useEmoji:!0,emojiFrequency:"low",language:"zh-TW"},knowledgeBases:[],activeKnowledgeBaseId:"",smartRules:[],settings:{autoLearnFromConversations:!1,maxDailyBudget:50,fallbackToHuman:!0,fallbackTimeout:300,debugMode:!1}};var T=class g{constructor(){this.ipcService=m(y);this.toastService=m(k);this.config=l(C);this._isLoading=l(!1);this.isLoading=this._isLoading.asReadonly();this.usageStats=l({today:{conversations:0,messages:0,intentsRecognized:0,conversions:0,cost:0,avgResponseTime:0},weekly:{conversations:0,messages:0,intentsRecognized:0,conversions:0,cost:0,conversionRate:0},byModel:[]});this.models=d(()=>this.config().models);this.defaultModel=d(()=>this.config().models.find(e=>e.id===this.config().defaultModelId));this.knowledgeBases=d(()=>this.config().knowledgeBases);this.activeKnowledgeBaseId=d(()=>this.config().activeKnowledgeBaseId);this.activeKnowledgeBase=d(()=>this.config().knowledgeBases.find(e=>e.id===this.config().activeKnowledgeBaseId));this.activeRules=d(()=>this.config().smartRules.filter(e=>e.isActive));this.stats=d(()=>this.usageStats());this.strategy=d(()=>this.config().conversationStrategy);this.settings=d(()=>this.config().settings);this.isConnected=d(()=>this.config().models.some(e=>e.isConnected));this._testingModelIds=l(new Set);this.testingModelIds=d(()=>this._testingModelIds());this.localModels=d(()=>this.config().models.filter(e=>e.isLocal));this.cloudModels=d(()=>this.config().models.filter(e=>!e.isLocal));this.modelUsage=d(()=>this.config().modelUsage);this.setupIpcListeners(),setTimeout(()=>{this.loadModelsFromBackend(),this.loadModelUsageFromBackend()},100)}setupIpcListeners(){this.ipcService.on("ai-models-list",e=>{if(e.success&&e.models){let t=e.models.map(s=>({id:String(s.id),provider:s.provider,modelName:s.modelName,apiKey:s.apiKey||"",apiEndpoint:s.apiEndpoint,isConnected:s.isConnected,lastTestedAt:s.lastTestedAt,usageToday:0,costToday:0,isLocal:s.isLocal,displayName:s.displayName}));this.config.update(s=>a(i({},s),{models:t,defaultModelId:t.find(n=>n.isDefault)?.id||s.defaultModelId})),this._isLoading.set(!1)}}),this.ipcService.on("ai-model-saved",e=>{e.success?this.toastService.success(`AI \u6A21\u578B\u5DF2\u4FDD\u5B58: ${e.modelName||e.provider}`):this.toastService.error(`\u4FDD\u5B58\u5931\u6557: ${e.error}`)}),this.ipcService.on("ai-model-tested",e=>{if(console.log("[AI] \u6E2C\u8A66\u7D50\u679C:",e),e.modelId&&this._testingModelIds.update(t=>{let s=new Set(t);return s.delete(String(e.modelId)),s}),e.isConnected){let t=e.latencyMs?`\u5EF6\u9072: ${e.latencyMs}ms`:"",s=e.responsePreview?`
\u56DE\u8986: "${e.responsePreview.substring(0,50)}${e.responsePreview.length>50?"...":""}"`:"",n=e.availableModels?.length>0?`
\u53EF\u7528\u6A21\u578B: ${e.availableModels.slice(0,3).join(", ")}${e.availableModels.length>3?"...":""}`:"";this.toastService.success(`\u2713 AI \u6A21\u578B ${e.modelName||""} \u9023\u63A5\u6210\u529F\uFF01
${t}${s}${n}`)}else this.toastService.error(`\u9023\u63A5\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`);e.modelId&&this.updateModel(String(e.modelId),{isConnected:e.isConnected,lastTestedAt:new Date().toISOString()})}),this.ipcService.on("model-usage-loaded",e=>{console.log("[AI] \u6A21\u578B\u7528\u9014\u5206\u914D\u5DF2\u52A0\u8F09:",e),e.success&&e.usage&&this.config.update(t=>a(i({},t),{modelUsage:{intentRecognition:e.usage.intentRecognition||"",dailyChat:e.usage.dailyChat||"",multiRoleScript:e.usage.multiRoleScript||""}}))}),this.ipcService.on("model-usage-saved",e=>{e.success?console.log("[AI] \u6A21\u578B\u7528\u9014\u5206\u914D\u5DF2\u4FDD\u5B58"):this.toastService.error(`\u4FDD\u5B58\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}),this.ipcService.on("knowledge-base-added",e=>{console.log("[AI] \u77E5\u8B58\u5EAB\u5275\u5EFA\u7D50\u679C:",e),e.success?this.toastService.success(`\u77E5\u8B58\u5EAB\u300C${e.name}\u300D\u5275\u5EFA\u6210\u529F`):this.toastService.error(`\u5275\u5EFA\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}),this.ipcService.on("knowledge-item-added",e=>{console.log("[AI] \u77E5\u8B58\u689D\u76EE\u6DFB\u52A0\u7D50\u679C:",e),e.success?this.toastService.success(`\u77E5\u8B58\u689D\u76EE\u300C${e.title}\u300D\u5DF2\u6DFB\u52A0`):this.toastService.error(`\u6DFB\u52A0\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}),this.ipcService.on("ai-knowledge-generated",e=>{console.log("[AI] AI \u751F\u6210\u77E5\u8B58\u5EAB\u7D50\u679C:",e),e.success&&e.items?(this.handleGeneratedKnowledge(e.kbId,e.items),this.toastService.success(`\u2728 AI \u5DF2\u751F\u6210 ${e.items.length} \u689D\u77E5\u8B58`)):this.toastService.error(`\u751F\u6210\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}),this.ipcService.on("industry-template-applied",e=>{console.log("[AI] \u884C\u696D\u6A21\u677F\u61C9\u7528\u7D50\u679C:",e),e.success&&e.items?(this.handleGeneratedKnowledge(e.kbId,e.items),this.toastService.success(`\u{1F4DA} \u5DF2\u61C9\u7528\u300C${e.templateName}\u300D\u6A21\u677F\uFF0C\u6DFB\u52A0 ${e.items.length} \u689D\u77E5\u8B58`)):this.toastService.error(`\u61C9\u7528\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}),this.ipcService.on("chat-learning-complete",e=>{console.log("[AI] \u804A\u5929\u5B78\u7FD2\u7D50\u679C:",e),e.success&&e.items?(this.handleGeneratedKnowledge(e.kbId,e.items),this.toastService.success(`\u{1F4AC} \u5F9E\u804A\u5929\u8A18\u9304\u5B78\u7FD2\u4E86 ${e.items.length} \u689D\u77E5\u8B58`)):e.success&&(!e.items||e.items.length===0)?this.toastService.info("\u672A\u767C\u73FE\u53EF\u5B78\u7FD2\u7684\u512A\u8CEA\u56DE\u8986"):this.toastService.error(`\u5B78\u7FD2\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)})}loadModelsFromBackend(){this._isLoading.set(!0),this.ipcService.send("get-ai-models",{})}addModel(e){let t=`model_${Date.now()}`,s=a(i({},e),{id:t,isConnected:!1,usageToday:0,costToday:0});return this.config.update(n=>a(i({},n),{models:[...n.models,s]})),this.ipcService.send("save-ai-model",{provider:e.provider,modelName:e.modelName,displayName:e.displayName||e.modelName,apiKey:e.apiKey,apiEndpoint:e.apiEndpoint,isLocal:e.isLocal||!1,isDefault:e.isDefault||!1}),t}addLocalModel(e){return this.addModel({provider:"custom",modelName:e.modelName,displayName:e.displayName||e.modelName,apiKey:"",apiEndpoint:e.apiEndpoint,isLocal:!0,isDefault:e.isDefault})}updateModel(e,t){this.config.update(s=>a(i({},s),{models:s.models.map(n=>n.id===e?i(i({},n),t):n)})),isNaN(Number(e))||this.ipcService.send("update-ai-model",i({id:Number(e)},t))}removeModel(e){this.config.update(t=>a(i({},t),{models:t.models.filter(s=>s.id!==e),defaultModelId:t.defaultModelId===e?"":t.defaultModelId})),isNaN(Number(e))||this.ipcService.send("delete-ai-model",{id:Number(e)})}setDefaultModel(e){this.config.update(t=>a(i({},t),{defaultModelId:e})),isNaN(Number(e))||this.ipcService.send("set-default-ai-model",{id:Number(e)})}updateModelUsage(e){this.config.update(t=>a(i({},t),{modelUsage:i(i({},t.modelUsage),e)}))}async saveModelUsageToBackend(){let e=this.config().modelUsage;console.log("[AI] \u4FDD\u5B58\u6A21\u578B\u7528\u9014\u5206\u914D:",e),this.ipcService.send("save-model-usage",e)}loadModelUsageFromBackend(){console.log("[AI] \u52A0\u8F09\u6A21\u578B\u7528\u9014\u5206\u914D..."),this.ipcService.send("get-model-usage",{})}async testModelConnection(e){let t=this.config().models.find(n=>n.id===e);if(!t)return!1;if(this._testingModelIds().has(e))return console.log("[AI] \u6A21\u578B\u5DF2\u5728\u6E2C\u8A66\u4E2D\uFF0C\u8DF3\u904E:",e),!1;this._testingModelIds.update(n=>{let o=new Set(n);return o.add(e),o});let s=t;return this.ipcService.send("test-ai-model",{id:isNaN(Number(e))?void 0:Number(e),provider:t.provider,modelName:t.modelName,apiKey:t.apiKey,apiEndpoint:t.apiEndpoint,isLocal:s.isLocal}),setTimeout(()=>{this._testingModelIds.update(n=>{let o=new Set(n);return o.delete(e),o})},6e4),!0}async testLocalAIConnection(e,t){return this.ipcService.send("test-ai-model",{provider:"ollama",modelName:t,apiEndpoint:e,isLocal:!0}),!0}addKnowledgeBase(e,t=""){let s=`kb_${Date.now()}`,n={id:s,name:e,description:t,items:[],isDefault:this.config().knowledgeBases.length===0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return this.config.update(o=>a(i({},o),{knowledgeBases:[...o.knowledgeBases,n],activeKnowledgeBaseId:o.activeKnowledgeBaseId||s})),this.ipcService.send("add-knowledge-base",{id:s,name:e,description:t,category:"general"}),s}updateKnowledgeBase(e,t){this.config.update(s=>a(i({},s),{knowledgeBases:s.knowledgeBases.map(n=>n.id===e?a(i(i({},n),t),{updatedAt:new Date().toISOString()}):n)}))}deleteKnowledgeBase(e){this.config.update(t=>a(i({},t),{knowledgeBases:t.knowledgeBases.filter(s=>s.id!==e),activeKnowledgeBaseId:t.activeKnowledgeBaseId===e?t.knowledgeBases.find(s=>s.id!==e)?.id||"":t.activeKnowledgeBaseId}))}setActiveKnowledgeBase(e){this.config.update(t=>a(i({},t),{activeKnowledgeBaseId:e}))}addKnowledgeItem(e,t){let s=`item_${Date.now()}`,n=new Date().toISOString(),o={id:s,title:t.title,content:t.content,category:t.category||"custom",keywords:[],priority:1,isActive:!0,createdAt:n,updatedAt:n};return this.config.update(r=>a(i({},r),{knowledgeBases:r.knowledgeBases.map(c=>c.id===e?a(i({},c),{items:[...c.items,o],updatedAt:new Date().toISOString()}):c)})),this.ipcService.send("add-knowledge-item",{kbId:e,id:s,title:t.title,content:t.content,category:t.category||"general"}),s}deleteKnowledgeItem(e,t){this.config.update(s=>a(i({},s),{knowledgeBases:s.knowledgeBases.map(n=>n.id===e?a(i({},n),{items:n.items.filter(o=>o.id!==t),updatedAt:new Date().toISOString()}):n)})),this.ipcService.send("delete-knowledge-item",{kbId:e,itemId:t})}generateKnowledgeBase(e,t){this.ipcService.send("ai-generate-knowledge",{kbId:e,businessDescription:t})}handleGeneratedKnowledge(e,t){let s=new Date().toISOString(),n=t.map((o,r)=>({id:`item_${Date.now()}_${r}`,title:o.title,content:o.content,category:o.category||"custom",keywords:[],priority:1,isActive:!0,createdAt:s,updatedAt:s}));this.config.update(o=>a(i({},o),{knowledgeBases:o.knowledgeBases.map(r=>r.id===e?a(i({},r),{items:[...r.items,...n],updatedAt:s}):r)}))}applyIndustryTemplate(e,t){this.ipcService.send("apply-industry-template",{kbId:e,templateId:t})}learnFromChatHistory(e){this.ipcService.send("learn-from-chat-history",{kbId:e,days:7})}addSmartRule(e){let t=`rule_${Date.now()}`,s=a(i({},e),{id:t});return this.config.update(n=>a(i({},n),{smartRules:[...n.smartRules,s]})),t}updateSmartRule(e,t){this.config.update(s=>a(i({},s),{smartRules:s.smartRules.map(n=>n.id===e?i(i({},n),t):n)}))}deleteSmartRule(e){this.config.update(t=>a(i({},t),{smartRules:t.smartRules.filter(s=>s.id!==e)}))}toggleSmartRule(e){this.config.update(t=>a(i({},t),{smartRules:t.smartRules.map(s=>s.id===e?a(i({},s),{isActive:!s.isActive}):s)}))}updateConversationStrategy(e){this.config.update(t=>a(i({},t),{conversationStrategy:i(i({},t.conversationStrategy),e)}))}async saveConversationStrategyToBackend(e){console.log("[AI] \u4FDD\u5B58\u5C0D\u8A71\u7B56\u7565:",e),this.ipcService.send("save-conversation-strategy",e),this.updateConversationStrategy({style:e.style,responseLength:e.responseLength,useEmoji:e.useEmoji,customPromptPrefix:e.customPersona}),this.toastService.success("\u5C0D\u8A71\u7B56\u7565\u5DF2\u4FDD\u5B58")}loadConversationStrategyFromBackend(){console.log("[AI] \u8F09\u5165\u5C0D\u8A71\u7B56\u7565..."),this.ipcService.send("get-conversation-strategy",{})}updateSettings(e){this.config.update(t=>a(i({},t),{settings:i(i({},t.settings),e)}))}async recognizeIntent(e,t){let s=this.extractKeywords(e),n="general_chat",o=.5;return e.includes("\u50F9\u683C")||e.includes("\u591A\u5C11\u9322")||e.includes("\u8CBB\u7528")?(n="price_inquiry",o=.9):e.includes("\u8CFC\u8CB7")||e.includes("\u4E0B\u55AE")||e.includes("\u600E\u9EBC\u8CB7")?(n="purchase_intent",o=.95):(e.includes("?")||e.includes("\uFF1F")||e.includes("\u4EC0\u9EBC"))&&(n="product_question",o=.7),this.usageStats.update(r=>a(i({},r),{today:a(i({},r.today),{intentsRecognized:r.today.intentsRecognized+1})})),{intent:n,confidence:o,keywords:s}}async generateReply(e,t=[],s){let n=this.config().conversationStrategy,o=this.activeKnowledgeBase(),r="\u611F\u8B1D\u60A8\u7684\u8A0A\u606F\uFF01";return s?.rolePrompt&&(r=`[${s.rolePrompt}] ${r}`),n.useEmoji&&(r+=" \u{1F60A}"),this.usageStats.update(c=>a(i({},c),{today:a(i({},c.today),{messages:c.today.messages+1,cost:c.today.cost+.01})})),r}async checkAndExecuteRules(e,t,s){let n=this.activeRules().sort((o,r)=>r.priority-o.priority);for(let o of n){if(o.triggerIntent!==e)continue;let r=o.triggerConditions;if(!(r.intentScore&&t<r.intentScore)&&!(r.conversationRounds&&s<r.conversationRounds))return o}return null}extractKeywords(e){return e.split(/[\s,，。！？!?]+/).filter(s=>s.length>1).slice(0,5)}exportConfig(){return JSON.stringify(this.config(),null,2)}importConfig(e){try{let t=JSON.parse(e);return this.config.set(t),!0}catch{return!1}}resetToDefault(){this.config.set(C)}static{this.\u0275fac=function(t){return new(t||g)}}static{this.\u0275prov=f({token:g,factory:g.\u0275fac,providedIn:"root"})}};var _=class g{constructor(){this.taskService=m(S);this.aiService=m(T);this.ipc=m(y);this._aiHostingEnabled=l(!1);this.aiHostingEnabled=this._aiHostingEnabled.asReadonly();this._isProcessing=l(!1);this.isProcessing=this._isProcessing.asReadonly();this._lastSyncTime=l(new Date().toISOString());this.lastSyncTime=this._lastSyncTime.asReadonly();this._intentThreshold=l(70);this.intentThreshold=this._intentThreshold.asReadonly();this._maxConcurrentTasks=l(5);this.maxConcurrentTasks=this._maxConcurrentTasks.asReadonly();this._preferredExecutionMode=l("hybrid");this.preferredExecutionMode=this._preferredExecutionMode.asReadonly();this.unifiedState=d(()=>{let e=this.taskService.getOverallStats(),t=this.aiService.stats(),s=this.taskService.todayStats();return{activeTasks:e.activeTasks,totalTasks:e.totalTasks,todayContacted:s.contacted,todayConverted:s.converted,aiConnected:this.aiService.isConnected(),aiHostingEnabled:this._aiHostingEnabled(),todayAiCost:t.today.cost,todayConversations:t.today.conversations,activeCollaborations:e.activeTasks,collaborationSuccessRate:e.conversionRate,isProcessing:this._isProcessing(),lastSyncTime:this._lastSyncTime()}});this.aggregatedStats=d(()=>{let e=this.taskService.getOverallStats(),t=this.taskService.tasksByGoal(),s=this.taskService.tasks(),n={};Object.entries(t).forEach(([r,c])=>{n[r]={count:c.length,contacted:c.reduce((h,p)=>h+p.stats.contacted,0),converted:c.reduce((h,p)=>h+p.stats.converted,0)}});let o=[];for(let r=6;r>=0;r--){let c=new Date;c.setDate(c.getDate()-r);let h=c.toISOString().split("T")[0],p=s.filter(u=>u.createdAt.startsWith(h)||u.startedAt?.startsWith(h));o.push({date:h,contacted:p.reduce((u,v)=>u+v.stats.contacted,0),converted:p.reduce((u,v)=>u+v.stats.converted,0),messages:p.reduce((u,v)=>u+v.stats.messagesSent,0),cost:p.reduce((u,v)=>u+v.stats.aiCost,0)})}return{totalContacted:e.totalContacted,totalConverted:e.totalConverted,totalMessagesSent:e.totalMessagesSent,totalAiCost:e.totalAiCost,overallConversionRate:e.conversionRate,daily:o,byGoalType:n}});this.hasActiveTasks=d(()=>this.taskService.activeTasks().length>0);this.todaySummary=d(()=>{let e=this.taskService.todayStats(),t=this.aiService.stats().today;return{contacted:e.contacted,converted:e.converted,messagesSent:e.messagesSent,conversations:t.conversations,aiCost:t.cost,conversionRate:e.contacted>0?Math.round(e.converted/e.contacted*100):0}});this.cleanups=[];this.initialize()}initialize(){this.loadPersistedState(),this.cleanups.push(this.ipc.on("ai-hosting-changed",e=>{this._aiHostingEnabled.set(e.enabled)})),this.cleanups.push(this.ipc.on("marketing-task-started",()=>{this._isProcessing.set(!0),this._lastSyncTime.set(new Date().toISOString())})),this.cleanups.push(this.ipc.on("marketing-task-completed",()=>{this._isProcessing.set(!1),this._lastSyncTime.set(new Date().toISOString())})),this.cleanups.push(this.ipc.on("marketing-task-paused",()=>{this._isProcessing.set(!1)}))}loadPersistedState(){let e=localStorage.getItem("ai_hosting_enabled");e!==null&&this._aiHostingEnabled.set(e==="true");let t=localStorage.getItem("intent_threshold");t&&this._intentThreshold.set(parseInt(t));let s=localStorage.getItem("max_concurrent_tasks");s&&this._maxConcurrentTasks.set(parseInt(s));let n=localStorage.getItem("preferred_execution_mode");n&&["scripted","hybrid","scriptless"].includes(n)&&this._preferredExecutionMode.set(n)}ngOnDestroy(){this.cleanups.forEach(e=>e())}setAiHostingEnabled(e){this._aiHostingEnabled.set(e),localStorage.setItem("ai_hosting_enabled",String(e)),this.ipc.send("set-ai-hosting",{enabled:e})}setIntentThreshold(e){this._intentThreshold.set(e),localStorage.setItem("intent_threshold",String(e))}setMaxConcurrentTasks(e){this._maxConcurrentTasks.set(e),localStorage.setItem("max_concurrent_tasks",String(e))}setPreferredExecutionMode(e){this._preferredExecutionMode.set(e),localStorage.setItem("preferred_execution_mode",e)}saveSettingsToBackend(){this.ipc.send("save-marketing-settings",{intentThreshold:this._intentThreshold(),maxConcurrentTasks:this._maxConcurrentTasks(),preferredExecutionMode:this._preferredExecutionMode(),aiHostingEnabled:this._aiHostingEnabled()})}syncState(){this.taskService.loadTasks(),this._lastSyncTime.set(new Date().toISOString())}getSnapshot(){return this.unifiedState()}async quickStartTask(e){return this.taskService.quickCreate(e)}canStartNewTask(){let e=parseInt(localStorage.getItem("max_concurrent_tasks")||"5");return this.taskService.activeTasks().length<e}getRecommendedAction(){let e=this.unifiedState();return e.aiConnected?e.activeTasks===0?{type:"start",description:"\u5275\u5EFA\u60A8\u7684\u7B2C\u4E00\u500B\u71DF\u92B7\u4EFB\u52D9",action:()=>this.ipc.send("navigate-to",{path:"/smart-marketing"})}:e.collaborationSuccessRate<10&&e.totalTasks>5?{type:"optimize",description:"\u8F49\u5316\u7387\u504F\u4F4E\uFF0C\u5EFA\u8B70\u512A\u5316 AI \u4EBA\u683C\u8A2D\u7F6E",action:()=>this.ipc.send("navigate-to",{path:"/ai-center",query:{tab:"persona"}})}:null:{type:"setup",description:"\u8ACB\u5148\u914D\u7F6E AI \u6A21\u578B",action:()=>this.ipc.send("navigate-to",{path:"/ai-center"})}}static{this.\u0275fac=function(t){return new(t||g)}}static{this.\u0275prov=f({token:g,factory:g.\u0275fac,providedIn:"root"})}};export{b as a,S as b,T as c,_ as d};
