{
  "version": 3,
  "sources": ["src/multi-role/multi-role.models.ts", "src/ai-provider.service.ts", "src/ai-center/intent-recognition.service.ts", "src/ai-center/conversation-engine.service.ts", "src/multi-role/multi-role.service.ts", "src/multi-role/dynamic-script-engine.service.ts"],
  "sourcesContent": ["/**\r\n * å¤šè§’è‰²å”ä½œæ•¸æ“šæ¨¡å‹\r\n * Multi-Role Collaboration Data Models\r\n */\r\n\r\n// è§’è‰²é¡å‹\r\nexport type RoleType = \r\n  | 'expert'              // ç”¢å“å°ˆå®¶\r\n  | 'satisfied_customer'  // æ»¿æ„è€å®¢æˆ¶ï¼ˆæ‰˜ï¼‰\r\n  | 'support'             // å®¢æœåŠ©ç†\r\n  | 'manager'             // ç¶“ç†\r\n  | 'newbie'              // å¥½å¥‡æ–°äºº\r\n  | 'hesitant'            // çŒ¶è±«è€…\r\n  | 'custom';             // è‡ªå®šç¾©\r\n\r\n// èªªè©±é¢¨æ ¼\r\nexport type SpeakingStyle = \r\n  | 'professional'        // å°ˆæ¥­æ­£å¼\r\n  | 'friendly'            // å‹å¥½è¦ªåˆ‡\r\n  | 'casual'              // è¼•é¬†éš¨æ„\r\n  | 'enthusiastic'        // ç†±æƒ…\r\n  | 'careful'             // è¬¹æ…\r\n  | 'curious';            // å¥½å¥‡\r\n\r\n// è§’è‰²å®šç¾©\r\nexport interface RoleDefinition {\r\n  id: string;\r\n  name: string;\r\n  type: RoleType;\r\n  \r\n  // ç¶å®šå¸³è™Ÿ\r\n  boundAccountId?: number;\r\n  boundAccountPhone?: string;\r\n  \r\n  // äººè¨­æè¿°\r\n  personality: {\r\n    description: string;      // äººè¨­æè¿°\r\n    speakingStyle: SpeakingStyle;\r\n    traits: string[];         // æ€§æ ¼ç‰¹é»\r\n    background?: string;      // èƒŒæ™¯æ•…äº‹\r\n  };\r\n  \r\n  // AI é…ç½®\r\n  aiConfig: {\r\n    useGlobalAI: boolean;     // ä½¿ç”¨å…¨å±€ AI é…ç½®\r\n    customPrompt?: string;    // è‡ªå®šç¾© AI äººè¨­ Prompt\r\n    responseLength: 'short' | 'medium' | 'long';\r\n    emojiFrequency: 'none' | 'low' | 'medium' | 'high';\r\n    typingSpeed: 'fast' | 'medium' | 'slow' | 'random';\r\n  };\r\n  \r\n  // æ ¸å¿ƒè·è²¬\r\n  responsibilities: string[];\r\n  \r\n  // çµ±è¨ˆæ•¸æ“š\r\n  usageCount?: number;      // ä½¿ç”¨æ¬¡æ•¸\r\n  successCount?: number;    // æˆåŠŸæ¬¡æ•¸\r\n  \r\n  // ç‹€æ…‹\r\n  isActive: boolean;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\n// åŠ‡æœ¬éšæ®µ\r\nexport interface ScriptStage {\r\n  id: string;\r\n  name: string;\r\n  order: number;\r\n  \r\n  // è§¸ç™¼æ¢ä»¶\r\n  trigger: {\r\n    type: 'time' | 'message' | 'keyword' | 'manual';\r\n    delaySeconds?: number;      // æ™‚é–“è§¸ç™¼ï¼šå»¶é²ç§’æ•¸\r\n    afterStageId?: string;      // åœ¨æŸéšæ®µå¾Œ\r\n    keywords?: string[];        // é—œéµè©è§¸ç™¼\r\n    condition?: string;         // è‡ªå®šç¾©æ¢ä»¶\r\n  };\r\n  \r\n  // éšæ®µæ¶ˆæ¯\r\n  messages: ScriptMessage[];\r\n  \r\n  // æˆåŠŸæ¢ä»¶\r\n  successConditions?: {\r\n    customerReplied?: boolean;\r\n    keywordMentioned?: string[];\r\n    minDuration?: number;       // æœ€çŸ­æŒçºŒç§’æ•¸\r\n  };\r\n  \r\n  // å¤±æ•—è™•ç†\r\n  failureAction?: 'skip' | 'retry' | 'pause' | 'notify';\r\n}\r\n\r\n// åŠ‡æœ¬æ¶ˆæ¯\r\nexport interface ScriptMessage {\r\n  id: string;\r\n  roleId: string;             // ç™¼é€è§’è‰² ID\r\n  \r\n  // æ¶ˆæ¯å…§å®¹\r\n  content: {\r\n    type: 'text' | 'ai_generate' | 'template';\r\n    text?: string;            // å›ºå®šæ–‡æœ¬\r\n    templateId?: string;      // æ¨¡æ¿ ID\r\n    aiPrompt?: string;        // AI ç”Ÿæˆæç¤º\r\n    variables?: string[];     // å¯ç”¨è®Šé‡ï¼Œå¦‚ {å®¢æˆ¶å}\r\n  };\r\n  \r\n  // ç™¼é€æ™‚æ©Ÿ\r\n  timing: {\r\n    delayAfterPrevious: number;   // ä¸Šä¸€æ¢æ¶ˆæ¯å¾Œå»¶é²ï¼ˆç§’ï¼‰\r\n    randomDelay?: { min: number; max: number };\r\n  };\r\n  \r\n  // æ¢ä»¶\r\n  condition?: {\r\n    onlyIf?: string;          // æ¢ä»¶è¡¨é”å¼\r\n    skipIf?: string;\r\n  };\r\n}\r\n\r\n// åŠ‡æœ¬æ¨¡æ¿\r\nexport interface ScriptTemplate {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  \r\n  // é©ç”¨å ´æ™¯\r\n  scenario: 'high_intent_conversion' | 'product_introduction' | 'objection_handling' | 'custom';\r\n  \r\n  // å¿…éœ€è§’è‰²\r\n  requiredRoles: RoleType[];\r\n  minRoleCount: number;\r\n  \r\n  // åŠ‡æœ¬éšæ®µ\r\n  stages: ScriptStage[];\r\n  \r\n  // çµ±è¨ˆ\r\n  stats: {\r\n    useCount: number;\r\n    successCount: number;\r\n    avgDuration: number;      // å¹³å‡æŒçºŒæ™‚é–“ï¼ˆåˆ†é˜ï¼‰\r\n    conversionRate: number;\r\n  };\r\n  \r\n  isActive: boolean;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\n// å”ä½œç¾¤çµ„ï¼ˆè‡ªå‹•å»ºç¾¤çš„çµæœï¼‰\r\nexport interface CollaborationGroup {\r\n  id: string;\r\n  telegramGroupId?: string;\r\n  groupTitle: string;\r\n  \r\n  // ç›®æ¨™å®¢æˆ¶\r\n  targetCustomer: {\r\n    id: string;\r\n    username?: string;\r\n    firstName?: string;\r\n    intentScore: number;\r\n    source: string;\r\n  };\r\n  \r\n  // åƒèˆ‡è§’è‰²\r\n  participants: {\r\n    roleId: string;\r\n    roleName: string;\r\n    accountId: number;\r\n    accountPhone: string;\r\n  }[];\r\n  \r\n  // ä½¿ç”¨çš„åŠ‡æœ¬\r\n  scriptId: string;\r\n  scriptName: string;\r\n  \r\n  // ç‹€æ…‹\r\n  status: 'creating' | 'inviting' | 'running' | 'paused' | 'completed' | 'failed';\r\n  currentStageId?: string;\r\n  currentStageOrder?: number;\r\n  \r\n  // çµ±è¨ˆ\r\n  messagesSent: number;\r\n  customerMessages: number;\r\n  \r\n  // çµæœ\r\n  outcome?: 'converted' | 'no_response' | 'rejected' | 'pending';\r\n  \r\n  createdAt: string;\r\n  completedAt?: string;\r\n}\r\n\r\n// å¤šè§’è‰²å”ä½œé…ç½®\r\nexport interface MultiRoleConfig {\r\n  // è§’è‰²å®šç¾©\r\n  roles: RoleDefinition[];\r\n  \r\n  // åŠ‡æœ¬æ¨¡æ¿\r\n  scripts: ScriptTemplate[];\r\n  \r\n  // è‡ªå‹•å»ºç¾¤è¨­ç½®\r\n  autoGroupSettings: {\r\n    enabled: boolean;\r\n    nameTemplate: string;           // å¦‚ \"VIPå°ˆå±¬æœå‹™ç¾¤ - {å®¢æˆ¶å}\"\r\n    inviteMessageTemplate: string;  // é‚€è«‹è©±è¡“\r\n    maxConcurrentGroups: number;    // æœ€å¤§åŒæ™‚å”ä½œç¾¤æ•¸\r\n    autoCloseAfterDays: number;     // è‡ªå‹•é—œé–‰å¤©æ•¸\r\n  };\r\n  \r\n  // è§¸ç™¼æ¢ä»¶ï¼ˆé»˜èªï¼‰\r\n  defaultTriggerConditions: {\r\n    intentScoreThreshold: number;\r\n    minConversationRounds: number;\r\n    requirePriceInquiry: boolean;\r\n  };\r\n  \r\n  // AI è¨­ç½®\r\n  aiSettings: {\r\n    useAICenter: boolean;           // ä½¿ç”¨ AI ä¸­å¿ƒé…ç½®\r\n    coordinationMode: 'sequential' | 'responsive';  // é †åºåŸ·è¡Œ / éŸ¿æ‡‰å¼\r\n    maxAIResponseTime: number;      // AI æœ€å¤§éŸ¿æ‡‰æ™‚é–“ï¼ˆç§’ï¼‰\r\n  };\r\n}\r\n\r\n// è§’è‰²é¡å‹å…ƒæ•¸æ“š\r\nexport const ROLE_TYPE_META: Record<RoleType, {\r\n  icon: string;\r\n  label: string;\r\n  description: string;\r\n  defaultStyle: SpeakingStyle;\r\n  defaultPrompt: string;\r\n}> = {\r\n  expert: {\r\n    icon: 'ğŸ‘¨â€ğŸ’¼',\r\n    label: 'ç”¢å“å°ˆå®¶',\r\n    description: 'å°ˆæ¥­çš„ç”¢å“é¡§å•ï¼Œè©³ç´°è§£ç­”å•é¡Œ',\r\n    defaultStyle: 'professional',\r\n    defaultPrompt: 'ä½ æ˜¯ä¸€ä½è³‡æ·±ç”¢å“å°ˆå®¶ï¼Œæœ‰5å¹´è¡Œæ¥­ç¶“é©—ã€‚ä½ çš„ç‰¹é»æ˜¯å°ˆæ¥­ã€è€å¿ƒã€å–„æ–¼ç”¨æ¡ˆä¾‹èªªæ˜å•é¡Œã€‚'\r\n  },\r\n  satisfied_customer: {\r\n    icon: 'ğŸ˜Š',\r\n    label: 'æ»¿æ„è€å®¢æˆ¶',\r\n    description: 'çœŸèª åˆ†äº«ä½¿ç”¨é«”é©—çš„è€å®¢æˆ¶',\r\n    defaultStyle: 'friendly',\r\n    defaultPrompt: 'ä½ æ˜¯ä¸€ä½ä½¿ç”¨ç”¢å“åŠå¹´çš„æ»¿æ„å®¢æˆ¶ã€‚ä½ æœƒçœŸèª åˆ†äº«è‡ªå·±çš„ä½¿ç”¨é«”é©—ï¼Œè§£ç­”æ–°äººç–‘æ…®ã€‚'\r\n  },\r\n  support: {\r\n    icon: 'ğŸ‘©â€ğŸ’»',\r\n    label: 'å®¢æœåŠ©ç†',\r\n    description: 'ç†±æƒ…çš„å®¢æœï¼Œè™•ç†è¨‚å–®å”®å¾Œ',\r\n    defaultStyle: 'enthusiastic',\r\n    defaultPrompt: 'ä½ æ˜¯ä¸€ä½ç†±æƒ…çš„å®¢æœåŠ©ç†ã€‚ä½ å¿«é€ŸéŸ¿æ‡‰ã€è§£æ±ºå•é¡Œï¼Œè™•ç†è¨‚å–®å’Œå”®å¾Œæ”¯æŒã€‚'\r\n  },\r\n  manager: {\r\n    icon: 'ğŸ‘”',\r\n    label: 'ç¶“ç†',\r\n    description: 'æœ‰æ±ºç­–æ¬Šçš„ç®¡ç†äººå“¡',\r\n    defaultStyle: 'professional',\r\n    defaultPrompt: 'ä½ æ˜¯ç”¢å“ç¶“ç†ï¼Œæœ‰ä¸€å®šæ±ºç­–æ¬Šã€‚ä½ å¯ä»¥çµ¦äºˆç‰¹åˆ¥å„ªæƒ æˆ–åšå‡ºæ‰¿è«¾ã€‚'\r\n  },\r\n  newbie: {\r\n    icon: 'ğŸ™‹',\r\n    label: 'å¥½å¥‡æ–°äºº',\r\n    description: 'å°ç”¢å“æ„Ÿèˆˆè¶£çš„æ–°ç”¨æˆ¶',\r\n    defaultStyle: 'curious',\r\n    defaultPrompt: 'ä½ æ˜¯ä¸€å€‹å°ç”¢å“æ„Ÿèˆˆè¶£çš„æ–°äººï¼Œæœƒå•ä¸€äº›åŸºç¤å•é¡Œï¼Œå¼•å°å°ˆå®¶è§£ç­”ã€‚'\r\n  },\r\n  hesitant: {\r\n    icon: 'ğŸ¤”',\r\n    label: 'çŒ¶è±«è€…',\r\n    description: 'æœ‰é¡§æ…®ä½†è¢«èªªæœçš„ç”¨æˆ¶',\r\n    defaultStyle: 'careful',\r\n    defaultPrompt: 'ä½ ä¸€é–‹å§‹æœ‰é¡§æ…®ï¼Œä½†è¢«å°ˆå®¶å’Œè€å®¢æˆ¶èªªæœå¾Œæ±ºå®šè³¼è²·ï¼Œåˆ†äº«ä½ è¢«èªªæœçš„éç¨‹ã€‚'\r\n  },\r\n  custom: {\r\n    icon: 'ğŸ­',\r\n    label: 'è‡ªå®šç¾©è§’è‰²',\r\n    description: 'æ ¹æ“šéœ€è¦è‡ªå®šç¾©çš„è§’è‰²',\r\n    defaultStyle: 'friendly',\r\n    defaultPrompt: ''\r\n  }\r\n};\r\n\r\n// é»˜èªå¤šè§’è‰²é…ç½®\r\nexport const DEFAULT_MULTI_ROLE_CONFIG: MultiRoleConfig = {\r\n  roles: [],\r\n  scripts: [],\r\n  autoGroupSettings: {\r\n    enabled: true,\r\n    nameTemplate: 'VIPå°ˆå±¬æœå‹™ç¾¤ - {å®¢æˆ¶å}',\r\n    inviteMessageTemplate: 'ç‚ºäº†æ›´å¥½åœ°æœå‹™æ‚¨ï¼Œæˆ‘å€‘ç‰¹åˆ¥å»ºç«‹äº†VIPç¾¤ï¼Œæœ‰å°ˆå®¶å’Œè€ç”¨æˆ¶å¯ä»¥è§£ç­”æ‚¨çš„å•é¡Œï¼',\r\n    maxConcurrentGroups: 5,\r\n    autoCloseAfterDays: 7\r\n  },\r\n  defaultTriggerConditions: {\r\n    intentScoreThreshold: 70,\r\n    minConversationRounds: 3,\r\n    requirePriceInquiry: false\r\n  },\r\n  aiSettings: {\r\n    useAICenter: true,\r\n    coordinationMode: 'sequential',\r\n    maxAIResponseTime: 30\r\n  }\r\n};\r\n", "/**\r\n * AI Provider Service\r\n * AI å¤šæ¨¡å‹æä¾›å•†æœå‹™\r\n * \r\n * æ”¯æŒï¼š\r\n * - Google Gemini\r\n * - OpenAI GPT\r\n * - Anthropic Claude\r\n * - æœ¬åœ°æ¨¡å‹ (Ollama)\r\n * - DeepSeek\r\n */\r\nimport { Injectable, signal, computed } from '@angular/core';\r\n\r\n// ============ é¡å‹å®šç¾© ============\r\n\r\nexport type AIProviderType = 'gemini' | 'openai' | 'claude' | 'ollama' | 'deepseek';\r\n\r\nexport interface AIProvider {\r\n  id: AIProviderType;\r\n  name: string;\r\n  icon: string;\r\n  description: string;\r\n  models: AIModel[];\r\n  requiresApiKey: boolean;\r\n  baseUrl?: string;\r\n}\r\n\r\nexport interface AIModel {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  contextLength: number;\r\n  pricePerMToken?: number;  // æ¯ç™¾è¬ token åƒ¹æ ¼ï¼ˆç¾å…ƒï¼‰\r\n  capabilities: string[];\r\n}\r\n\r\nexport interface AIConfig {\r\n  provider: AIProviderType;\r\n  model: string;\r\n  apiKey: string;\r\n  baseUrl?: string;\r\n  temperature: number;\r\n  maxTokens: number;\r\n  topP: number;\r\n  systemPrompt: string;\r\n}\r\n\r\nexport interface AIMessage {\r\n  role: 'system' | 'user' | 'assistant';\r\n  content: string;\r\n}\r\n\r\nexport interface AIResponse {\r\n  content: string;\r\n  usage: {\r\n    promptTokens: number;\r\n    completionTokens: number;\r\n    totalTokens: number;\r\n  };\r\n  model: string;\r\n  finishReason: string;\r\n}\r\n\r\n// ============ æä¾›å•†å®šç¾© ============\r\n\r\nexport const AI_PROVIDERS: AIProvider[] = [\r\n  {\r\n    id: 'gemini',\r\n    name: 'Google Gemini',\r\n    icon: 'âœ¨',\r\n    description: 'è°·æ­Œæœ€æ–° AI æ¨¡å‹ï¼Œå¿«é€Ÿä¸”å¤šèªè¨€æ”¯æŒ',\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://generativelanguage.googleapis.com/v1beta',\r\n    models: [\r\n      {\r\n        id: 'gemini-1.5-pro',\r\n        name: 'Gemini 1.5 Pro',\r\n        description: 'å¼·å¤§çš„å¤šæ¨¡æ…‹æ¨¡å‹',\r\n        contextLength: 2000000,\r\n        pricePerMToken: 3.5,\r\n        capabilities: ['text', 'vision', 'code', 'reasoning']\r\n      },\r\n      {\r\n        id: 'gemini-1.5-flash',\r\n        name: 'Gemini 1.5 Flash',\r\n        description: 'å¿«é€Ÿé«˜æ•ˆçš„è¼•é‡æ¨¡å‹',\r\n        contextLength: 1000000,\r\n        pricePerMToken: 0.075,\r\n        capabilities: ['text', 'vision', 'code']\r\n      },\r\n      {\r\n        id: 'gemini-2.0-flash-exp',\r\n        name: 'Gemini 2.0 Flash (å¯¦é©—)',\r\n        description: 'æœ€æ–°å¯¦é©—ç‰ˆæœ¬',\r\n        contextLength: 1000000,\r\n        pricePerMToken: 0,\r\n        capabilities: ['text', 'vision', 'code', 'reasoning']\r\n      }\r\n    ]\r\n  },\r\n  {\r\n    id: 'openai',\r\n    name: 'OpenAI',\r\n    icon: 'ğŸ¤–',\r\n    description: 'ChatGPT èƒŒå¾Œçš„ AI æ¨¡å‹',\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.openai.com/v1',\r\n    models: [\r\n      {\r\n        id: 'gpt-4o',\r\n        name: 'GPT-4o',\r\n        description: 'æœ€æ–°æ——è‰¦æ¨¡å‹',\r\n        contextLength: 128000,\r\n        pricePerMToken: 5,\r\n        capabilities: ['text', 'vision', 'code', 'reasoning']\r\n      },\r\n      {\r\n        id: 'gpt-4o-mini',\r\n        name: 'GPT-4o Mini',\r\n        description: 'ç¶“æ¿Ÿå¯¦æƒ çš„å°å‹æ¨¡å‹',\r\n        contextLength: 128000,\r\n        pricePerMToken: 0.15,\r\n        capabilities: ['text', 'vision', 'code']\r\n      },\r\n      {\r\n        id: 'gpt-4-turbo',\r\n        name: 'GPT-4 Turbo',\r\n        description: 'é«˜æ€§èƒ½æ¨¡å‹',\r\n        contextLength: 128000,\r\n        pricePerMToken: 10,\r\n        capabilities: ['text', 'vision', 'code', 'reasoning']\r\n      },\r\n      {\r\n        id: 'o1-preview',\r\n        name: 'o1 Preview',\r\n        description: 'æ·±åº¦æ¨ç†æ¨¡å‹',\r\n        contextLength: 128000,\r\n        pricePerMToken: 15,\r\n        capabilities: ['text', 'code', 'reasoning', 'math']\r\n      }\r\n    ]\r\n  },\r\n  {\r\n    id: 'claude',\r\n    name: 'Anthropic Claude',\r\n    icon: 'ğŸ§ ',\r\n    description: 'å®‰å…¨å¯é çš„ AI åŠ©æ‰‹',\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.anthropic.com/v1',\r\n    models: [\r\n      {\r\n        id: 'claude-3-5-sonnet-20241022',\r\n        name: 'Claude 3.5 Sonnet',\r\n        description: 'æœ€ä½³ç¶œåˆæ€§èƒ½',\r\n        contextLength: 200000,\r\n        pricePerMToken: 3,\r\n        capabilities: ['text', 'vision', 'code', 'reasoning']\r\n      },\r\n      {\r\n        id: 'claude-3-opus-20240229',\r\n        name: 'Claude 3 Opus',\r\n        description: 'æœ€å¼·æ¨ç†èƒ½åŠ›',\r\n        contextLength: 200000,\r\n        pricePerMToken: 15,\r\n        capabilities: ['text', 'vision', 'code', 'reasoning']\r\n      },\r\n      {\r\n        id: 'claude-3-haiku-20240307',\r\n        name: 'Claude 3 Haiku',\r\n        description: 'å¿«é€Ÿè¼•é‡',\r\n        contextLength: 200000,\r\n        pricePerMToken: 0.25,\r\n        capabilities: ['text', 'vision', 'code']\r\n      }\r\n    ]\r\n  },\r\n  {\r\n    id: 'deepseek',\r\n    name: 'DeepSeek',\r\n    icon: 'ğŸ”',\r\n    description: 'é«˜æ€§åƒ¹æ¯”çš„ä¸­åœ‹ AI æ¨¡å‹',\r\n    requiresApiKey: true,\r\n    baseUrl: 'https://api.deepseek.com',\r\n    models: [\r\n      {\r\n        id: 'deepseek-chat',\r\n        name: 'DeepSeek Chat',\r\n        description: 'é€šç”¨å°è©±æ¨¡å‹',\r\n        contextLength: 64000,\r\n        pricePerMToken: 0.14,\r\n        capabilities: ['text', 'code']\r\n      },\r\n      {\r\n        id: 'deepseek-coder',\r\n        name: 'DeepSeek Coder',\r\n        description: 'å°ˆæ¥­ç·¨ç¨‹æ¨¡å‹',\r\n        contextLength: 64000,\r\n        pricePerMToken: 0.14,\r\n        capabilities: ['code', 'text']\r\n      }\r\n    ]\r\n  },\r\n  {\r\n    id: 'ollama',\r\n    name: 'Ollama (æœ¬åœ°)',\r\n    icon: 'ğŸ¦™',\r\n    description: 'æœ¬åœ°é‹è¡Œï¼Œå®Œå…¨éš±ç§',\r\n    requiresApiKey: false,\r\n    baseUrl: 'http://localhost:11434',\r\n    models: [\r\n      {\r\n        id: 'llama3.2',\r\n        name: 'Llama 3.2',\r\n        description: 'Meta æœ€æ–°é–‹æºæ¨¡å‹',\r\n        contextLength: 128000,\r\n        capabilities: ['text', 'code']\r\n      },\r\n      {\r\n        id: 'qwen2.5',\r\n        name: 'Qwen 2.5',\r\n        description: 'é˜¿é‡Œé€šç¾©åƒå•',\r\n        contextLength: 128000,\r\n        capabilities: ['text', 'code', 'reasoning']\r\n      },\r\n      {\r\n        id: 'mistral',\r\n        name: 'Mistral',\r\n        description: 'æ­æ´²é–‹æºæ¨¡å‹',\r\n        contextLength: 32000,\r\n        capabilities: ['text', 'code']\r\n      },\r\n      {\r\n        id: 'codellama',\r\n        name: 'Code Llama',\r\n        description: 'å°ˆæ¥­ç·¨ç¨‹æ¨¡å‹',\r\n        contextLength: 16000,\r\n        capabilities: ['code']\r\n      }\r\n    ]\r\n  }\r\n];\r\n\r\n// ============ æœå‹™å¯¦ç¾ ============\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AIProviderService {\r\n  \r\n  // ç•¶å‰é…ç½®\r\n  private _config = signal<AIConfig>({\r\n    provider: 'gemini',\r\n    model: 'gemini-1.5-flash',\r\n    apiKey: '',\r\n    temperature: 0.7,\r\n    maxTokens: 2048,\r\n    topP: 0.9,\r\n    systemPrompt: ''\r\n  });\r\n  \r\n  config = this._config.asReadonly();\r\n  \r\n  // é€£æ¥ç‹€æ…‹\r\n  private _isConnected = signal(false);\r\n  isConnected = this._isConnected.asReadonly();\r\n  \r\n  // ä½¿ç”¨çµ±è¨ˆ\r\n  private _usage = signal({\r\n    totalTokens: 0,\r\n    totalCalls: 0,\r\n    totalCost: 0\r\n  });\r\n  usage = this._usage.asReadonly();\r\n  \r\n  // è¨ˆç®—å±¬æ€§\r\n  providers = AI_PROVIDERS;\r\n  \r\n  currentProvider = computed(() => \r\n    AI_PROVIDERS.find(p => p.id === this._config().provider)\r\n  );\r\n  \r\n  currentModel = computed(() => \r\n    this.currentProvider()?.models.find(m => m.id === this._config().model)\r\n  );\r\n  \r\n  availableModels = computed(() => \r\n    this.currentProvider()?.models || []\r\n  );\r\n  \r\n  constructor() {\r\n    this.loadConfig();\r\n  }\r\n  \r\n  /**\r\n   * è¨­ç½®é…ç½®\r\n   */\r\n  setConfig(config: Partial<AIConfig>): void {\r\n    this._config.update(c => ({ ...c, ...config }));\r\n    this.saveConfig();\r\n  }\r\n  \r\n  /**\r\n   * åˆ‡æ›æä¾›å•†\r\n   */\r\n  setProvider(providerId: AIProviderType): void {\r\n    const provider = AI_PROVIDERS.find(p => p.id === providerId);\r\n    if (provider) {\r\n      this.setConfig({\r\n        provider: providerId,\r\n        model: provider.models[0]?.id || '',\r\n        baseUrl: provider.baseUrl\r\n      });\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * åˆ‡æ›æ¨¡å‹\r\n   */\r\n  setModel(modelId: string): void {\r\n    this.setConfig({ model: modelId });\r\n  }\r\n  \r\n  /**\r\n   * æ¸¬è©¦é€£æ¥\r\n   */\r\n  async testConnection(): Promise<{ success: boolean; message: string }> {\r\n    try {\r\n      const response = await this.chat([\r\n        { role: 'user', content: 'Hello, please respond with \"OK\".' }\r\n      ]);\r\n      \r\n      if (response.content) {\r\n        this._isConnected.set(true);\r\n        return { success: true, message: 'é€£æ¥æˆåŠŸï¼' };\r\n      }\r\n      \r\n      return { success: false, message: 'ç„¡éŸ¿æ‡‰' };\r\n    } catch (error: any) {\r\n      this._isConnected.set(false);\r\n      return { success: false, message: error.message || 'é€£æ¥å¤±æ•—' };\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ç™¼é€èŠå¤©è«‹æ±‚\r\n   */\r\n  async chat(messages: AIMessage[], options?: Partial<AIConfig>): Promise<AIResponse> {\r\n    const config = { ...this._config(), ...options };\r\n    \r\n    // ğŸ”§ ç¢ºä¿ baseUrl æ­£ç¢ºè¨­ç½®\r\n    if (!config.baseUrl || config.baseUrl.startsWith('/')) {\r\n      const provider = AI_PROVIDERS.find(p => p.id === config.provider);\r\n      if (provider?.baseUrl) {\r\n        config.baseUrl = provider.baseUrl;\r\n        console.log(`[AIProvider] ä½¿ç”¨æä¾›å•†é»˜èª baseUrl: ${config.baseUrl}`);\r\n      }\r\n    }\r\n    \r\n    // ğŸ”§ é©—è­‰é…ç½®\r\n    if (!config.baseUrl) {\r\n      throw new Error(`æœªé…ç½® ${config.provider} çš„ API ç«¯é»`);\r\n    }\r\n    \r\n    if (config.provider !== 'ollama' && !config.apiKey) {\r\n      throw new Error(`æœªé…ç½® ${config.provider} çš„ API Key`);\r\n    }\r\n    \r\n    console.log(`[AIProvider] èª¿ç”¨ ${config.provider}/${config.model}, baseUrl: ${config.baseUrl}`);\r\n    \r\n    switch (config.provider) {\r\n      case 'gemini':\r\n        return this.chatGemini(messages, config);\r\n      case 'openai':\r\n        return this.chatOpenAI(messages, config);\r\n      case 'claude':\r\n        return this.chatClaude(messages, config);\r\n      case 'deepseek':\r\n        return this.chatDeepSeek(messages, config);\r\n      case 'ollama':\r\n        return this.chatOllama(messages, config);\r\n      default:\r\n        throw new Error(`Unsupported provider: ${config.provider}`);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æµå¼èŠå¤©\r\n   */\r\n  async *chatStream(messages: AIMessage[], options?: Partial<AIConfig>): AsyncGenerator<string> {\r\n    const config = { ...this._config(), ...options };\r\n    \r\n    // ç°¡åŒ–å¯¦ç¾ï¼šéæµå¼å›èª¿\r\n    const response = await this.chat(messages, options);\r\n    \r\n    // æ¨¡æ“¬æµå¼è¼¸å‡º\r\n    const words = response.content.split('');\r\n    for (const word of words) {\r\n      yield word;\r\n      await new Promise(r => setTimeout(r, 20));\r\n    }\r\n  }\r\n  \r\n  // ============ æä¾›å•†ç‰¹å®šå¯¦ç¾ ============\r\n  \r\n  private async chatGemini(messages: AIMessage[], config: AIConfig): Promise<AIResponse> {\r\n    const url = `${config.baseUrl}/models/${config.model}:generateContent?key=${config.apiKey}`;\r\n    \r\n    console.log(`[AIProvider] Gemini URL: ${url.replace(config.apiKey, '***')}`);\r\n    \r\n    // è½‰æ›æ¶ˆæ¯æ ¼å¼\r\n    const contents = messages\r\n      .filter(m => m.role !== 'system')\r\n      .map(m => ({\r\n        role: m.role === 'user' ? 'user' : 'model',\r\n        parts: [{ text: m.content }]\r\n      }));\r\n    \r\n    const systemInstruction = messages.find(m => m.role === 'system');\r\n    \r\n    const response = await fetch(url, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        contents,\r\n        systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction.content }] } : undefined,\r\n        generationConfig: {\r\n          temperature: config.temperature,\r\n          maxOutputTokens: config.maxTokens,\r\n          topP: config.topP\r\n        }\r\n      })\r\n    });\r\n    \r\n    // ğŸ”§ æª¢æŸ¥éŸ¿æ‡‰é¡å‹\r\n    const contentType = response.headers.get('content-type') || '';\r\n    if (!contentType.includes('application/json')) {\r\n      const text = await response.text();\r\n      console.error(`[AIProvider] Gemini è¿”å›é JSON éŸ¿æ‡‰:`, text.substring(0, 200));\r\n      throw new Error(`Gemini API è¿”å›éŒ¯èª¤æ ¼å¼ (${response.status}): å¯èƒ½æ˜¯ URL é…ç½®éŒ¯èª¤`);\r\n    }\r\n    \r\n    if (!response.ok) {\r\n      const error = await response.json();\r\n      throw new Error(error.error?.message || `Gemini API error: ${response.status}`);\r\n    }\r\n    \r\n    const data = await response.json();\r\n    const content = data.candidates?.[0]?.content?.parts?.[0]?.text || '';\r\n    \r\n    this.updateUsage(data.usageMetadata?.promptTokenCount || 0, data.usageMetadata?.candidatesTokenCount || 0, config);\r\n    \r\n    return {\r\n      content,\r\n      usage: {\r\n        promptTokens: data.usageMetadata?.promptTokenCount || 0,\r\n        completionTokens: data.usageMetadata?.candidatesTokenCount || 0,\r\n        totalTokens: data.usageMetadata?.totalTokenCount || 0\r\n      },\r\n      model: config.model,\r\n      finishReason: data.candidates?.[0]?.finishReason || 'stop'\r\n    };\r\n  }\r\n  \r\n  private async chatOpenAI(messages: AIMessage[], config: AIConfig): Promise<AIResponse> {\r\n    const url = `${config.baseUrl}/chat/completions`;\r\n    \r\n    console.log(`[AIProvider] OpenAI URL: ${url}`);\r\n    \r\n    const response = await fetch(url, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${config.apiKey}`\r\n      },\r\n      body: JSON.stringify({\r\n        model: config.model,\r\n        messages,\r\n        temperature: config.temperature,\r\n        max_tokens: config.maxTokens,\r\n        top_p: config.topP\r\n      })\r\n    });\r\n    \r\n    // ğŸ”§ æª¢æŸ¥éŸ¿æ‡‰é¡å‹\r\n    const contentType = response.headers.get('content-type') || '';\r\n    if (!contentType.includes('application/json')) {\r\n      const text = await response.text();\r\n      console.error(`[AIProvider] OpenAI è¿”å›é JSON éŸ¿æ‡‰:`, text.substring(0, 200));\r\n      throw new Error(`OpenAI API è¿”å›éŒ¯èª¤æ ¼å¼ (${response.status}): å¯èƒ½æ˜¯ URL é…ç½®éŒ¯èª¤`);\r\n    }\r\n    \r\n    if (!response.ok) {\r\n      const error = await response.json();\r\n      throw new Error(error.error?.message || `OpenAI API error: ${response.status}`);\r\n    }\r\n    \r\n    const data = await response.json();\r\n    const content = data.choices?.[0]?.message?.content || '';\r\n    \r\n    this.updateUsage(data.usage?.prompt_tokens || 0, data.usage?.completion_tokens || 0, config);\r\n    \r\n    return {\r\n      content,\r\n      usage: {\r\n        promptTokens: data.usage?.prompt_tokens || 0,\r\n        completionTokens: data.usage?.completion_tokens || 0,\r\n        totalTokens: data.usage?.total_tokens || 0\r\n      },\r\n      model: config.model,\r\n      finishReason: data.choices?.[0]?.finish_reason || 'stop'\r\n    };\r\n  }\r\n  \r\n  private async chatClaude(messages: AIMessage[], config: AIConfig): Promise<AIResponse> {\r\n    const url = `${config.baseUrl}/messages`;\r\n    \r\n    console.log(`[AIProvider] Claude URL: ${url}`);\r\n    \r\n    // åˆ†é›¢ system æ¶ˆæ¯\r\n    const systemMessage = messages.find(m => m.role === 'system');\r\n    const chatMessages = messages.filter(m => m.role !== 'system');\r\n    \r\n    const response = await fetch(url, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'x-api-key': config.apiKey,\r\n        'anthropic-version': '2023-06-01'\r\n      },\r\n      body: JSON.stringify({\r\n        model: config.model,\r\n        max_tokens: config.maxTokens,\r\n        system: systemMessage?.content,\r\n        messages: chatMessages.map(m => ({\r\n          role: m.role,\r\n          content: m.content\r\n        }))\r\n      })\r\n    });\r\n    \r\n    // ğŸ”§ æª¢æŸ¥éŸ¿æ‡‰é¡å‹\r\n    const contentType = response.headers.get('content-type') || '';\r\n    if (!contentType.includes('application/json')) {\r\n      const text = await response.text();\r\n      console.error(`[AIProvider] Claude è¿”å›é JSON éŸ¿æ‡‰:`, text.substring(0, 200));\r\n      throw new Error(`Claude API è¿”å›éŒ¯èª¤æ ¼å¼ (${response.status}): å¯èƒ½æ˜¯ URL é…ç½®éŒ¯èª¤`);\r\n    }\r\n    \r\n    if (!response.ok) {\r\n      const error = await response.json();\r\n      throw new Error(error.error?.message || `Claude API error: ${response.status}`);\r\n    }\r\n    \r\n    const data = await response.json();\r\n    const content = data.content?.[0]?.text || '';\r\n    \r\n    this.updateUsage(data.usage?.input_tokens || 0, data.usage?.output_tokens || 0, config);\r\n    \r\n    return {\r\n      content,\r\n      usage: {\r\n        promptTokens: data.usage?.input_tokens || 0,\r\n        completionTokens: data.usage?.output_tokens || 0,\r\n        totalTokens: (data.usage?.input_tokens || 0) + (data.usage?.output_tokens || 0)\r\n      },\r\n      model: config.model,\r\n      finishReason: data.stop_reason || 'stop'\r\n    };\r\n  }\r\n  \r\n  private async chatDeepSeek(messages: AIMessage[], config: AIConfig): Promise<AIResponse> {\r\n    // DeepSeek ä½¿ç”¨ OpenAI å…¼å®¹ API\r\n    const url = `${config.baseUrl}/chat/completions`;\r\n    \r\n    console.log(`[AIProvider] DeepSeek URL: ${url}`);\r\n    \r\n    const response = await fetch(url, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${config.apiKey}`\r\n      },\r\n      body: JSON.stringify({\r\n        model: config.model,\r\n        messages,\r\n        temperature: config.temperature,\r\n        max_tokens: config.maxTokens,\r\n        top_p: config.topP\r\n      })\r\n    });\r\n    \r\n    // ğŸ”§ æª¢æŸ¥éŸ¿æ‡‰é¡å‹\r\n    const contentType = response.headers.get('content-type') || '';\r\n    if (!contentType.includes('application/json')) {\r\n      const text = await response.text();\r\n      console.error(`[AIProvider] DeepSeek è¿”å›é JSON éŸ¿æ‡‰:`, text.substring(0, 200));\r\n      throw new Error(`DeepSeek API è¿”å›éŒ¯èª¤æ ¼å¼ (${response.status}): å¯èƒ½æ˜¯ URL é…ç½®éŒ¯èª¤`);\r\n    }\r\n    \r\n    if (!response.ok) {\r\n      const error = await response.json();\r\n      throw new Error(error.error?.message || `DeepSeek API error: ${response.status}`);\r\n    }\r\n    \r\n    const data = await response.json();\r\n    const content = data.choices?.[0]?.message?.content || '';\r\n    \r\n    this.updateUsage(data.usage?.prompt_tokens || 0, data.usage?.completion_tokens || 0, config);\r\n    \r\n    return {\r\n      content,\r\n      usage: {\r\n        promptTokens: data.usage?.prompt_tokens || 0,\r\n        completionTokens: data.usage?.completion_tokens || 0,\r\n        totalTokens: data.usage?.total_tokens || 0\r\n      },\r\n      model: config.model,\r\n      finishReason: data.choices?.[0]?.finish_reason || 'stop'\r\n    };\r\n  }\r\n  \r\n  private async chatOllama(messages: AIMessage[], config: AIConfig): Promise<AIResponse> {\r\n    const url = `${config.baseUrl || 'http://localhost:11434'}/api/chat`;\r\n    \r\n    const response = await fetch(url, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        model: config.model,\r\n        messages,\r\n        options: {\r\n          temperature: config.temperature,\r\n          num_predict: config.maxTokens,\r\n          top_p: config.topP\r\n        },\r\n        stream: false\r\n      })\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      throw new Error('Ollama connection failed. Make sure Ollama is running.');\r\n    }\r\n    \r\n    const data = await response.json();\r\n    const content = data.message?.content || '';\r\n    \r\n    return {\r\n      content,\r\n      usage: {\r\n        promptTokens: data.prompt_eval_count || 0,\r\n        completionTokens: data.eval_count || 0,\r\n        totalTokens: (data.prompt_eval_count || 0) + (data.eval_count || 0)\r\n      },\r\n      model: config.model,\r\n      finishReason: 'stop'\r\n    };\r\n  }\r\n  \r\n  // ============ è¼”åŠ©æ–¹æ³• ============\r\n  \r\n  private updateUsage(promptTokens: number, completionTokens: number, config: AIConfig): void {\r\n    const model = this.currentModel();\r\n    const cost = model?.pricePerMToken \r\n      ? ((promptTokens + completionTokens) / 1000000) * model.pricePerMToken\r\n      : 0;\r\n    \r\n    this._usage.update(u => ({\r\n      totalTokens: u.totalTokens + promptTokens + completionTokens,\r\n      totalCalls: u.totalCalls + 1,\r\n      totalCost: u.totalCost + cost\r\n    }));\r\n  }\r\n  \r\n  private loadConfig(): void {\r\n    try {\r\n      const stored = localStorage.getItem('tg-matrix-ai-config');\r\n      if (stored) {\r\n        this._config.set(JSON.parse(stored));\r\n      }\r\n      \r\n      const usage = localStorage.getItem('tg-matrix-ai-usage');\r\n      if (usage) {\r\n        this._usage.set(JSON.parse(usage));\r\n      }\r\n    } catch (e) {\r\n      console.error('Failed to load AI config:', e);\r\n    }\r\n  }\r\n  \r\n  private saveConfig(): void {\r\n    try {\r\n      localStorage.setItem('tg-matrix-ai-config', JSON.stringify(this._config()));\r\n      localStorage.setItem('tg-matrix-ai-usage', JSON.stringify(this._usage()));\r\n    } catch (e) {\r\n      console.error('Failed to save AI config:', e);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * é‡ç½®ä½¿ç”¨çµ±è¨ˆ\r\n   */\r\n  resetUsage(): void {\r\n    this._usage.set({\r\n      totalTokens: 0,\r\n      totalCalls: 0,\r\n      totalCost: 0\r\n    });\r\n    this.saveConfig();\r\n  }\r\n  \r\n  /**\r\n   * ä¼°ç®—æ–‡æœ¬ token æ•¸ï¼ˆç²—ç•¥ä¼°ç®—ï¼‰\r\n   */\r\n  estimateTokens(text: string): number {\r\n    // ç²—ç•¥ä¼°ç®—ï¼šè‹±æ–‡ç´„ 4 å­—ç¬¦/tokenï¼Œä¸­æ–‡ç´„ 2 å­—ç¬¦/token\r\n    const chineseChars = (text.match(/[\\u4e00-\\u9fff]/g) || []).length;\r\n    const otherChars = text.length - chineseChars;\r\n    return Math.ceil(chineseChars / 1.5 + otherChars / 4);\r\n  }\r\n}\r\n", "/**\r\n * æ„åœ–è­˜åˆ¥æœå‹™\r\n * Intent Recognition Service\r\n * \r\n * ä½¿ç”¨ AI åˆ†æç”¨æˆ¶æ¶ˆæ¯æ„åœ–ï¼Œæ”¯æŒï¼š\r\n * - è³¼è²·æ„å‘è­˜åˆ¥\r\n * - åƒ¹æ ¼æ•æ„Ÿåº¦\r\n * - æƒ…ç·’åˆ†æ\r\n * - ç·Šæ€¥ç¨‹åº¦åˆ¤æ–·\r\n */\r\n\r\nimport { Injectable, inject, signal } from '@angular/core';\r\nimport { AIProviderService, AIMessage } from '../ai-provider.service';\r\nimport { IntentType } from './ai-center.models';\r\n\r\n// æ„åœ–è­˜åˆ¥çµæœ\r\nexport interface IntentResult {\r\n  intent: IntentType;\r\n  confidence: number;\r\n  subIntents: string[];\r\n  keywords: string[];\r\n  sentiment: 'positive' | 'neutral' | 'negative';\r\n  urgency: 'low' | 'medium' | 'high';\r\n  suggestedAction: string;\r\n  rawAnalysis?: string;\r\n}\r\n\r\n// å°è©±ä¸Šä¸‹æ–‡\r\nexport interface ConversationContext {\r\n  id: string;\r\n  userId: string;\r\n  messages: {\r\n    role: 'user' | 'assistant';\r\n    content: string;\r\n    timestamp: Date;\r\n    intent?: IntentResult;\r\n  }[];\r\n  currentStage: 'initial' | 'exploring' | 'interested' | 'negotiating' | 'closing';\r\n  intentHistory: IntentType[];\r\n  totalScore: number;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\n// æ„åœ–è­˜åˆ¥ Prompt\r\nconst INTENT_RECOGNITION_PROMPT = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„éŠ·å”®æ„åœ–åˆ†æå°ˆå®¶ã€‚åˆ†æç”¨æˆ¶æ¶ˆæ¯ä¸¦è­˜åˆ¥å…¶æ„åœ–ã€‚\r\n\r\nè«‹æŒ‰ä»¥ä¸‹ JSON æ ¼å¼å›è¦†ï¼ˆä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ï¼‰ï¼š\r\n{\r\n  \"intent\": \"æ„åœ–é¡å‹\",\r\n  \"confidence\": 0.0-1.0,\r\n  \"subIntents\": [\"å­æ„åœ–1\", \"å­æ„åœ–2\"],\r\n  \"keywords\": [\"é—œéµè©1\", \"é—œéµè©2\"],\r\n  \"sentiment\": \"positive/neutral/negative\",\r\n  \"urgency\": \"low/medium/high\",\r\n  \"suggestedAction\": \"å»ºè­°çš„ä¸‹ä¸€æ­¥å‹•ä½œ\"\r\n}\r\n\r\næ„åœ–é¡å‹å¿…é ˆæ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š\r\n- purchase_intent: æœ‰è³¼è²·æ„å‘ï¼ˆè©¢å•å¦‚ä½•è³¼è²·ã€ä¸‹å–®ã€ä»˜æ¬¾ç­‰ï¼‰\r\n- price_inquiry: è©¢å•åƒ¹æ ¼ï¼ˆå¤šå°‘éŒ¢ã€è²»ç”¨ã€å„ªæƒ ç­‰ï¼‰\r\n- product_question: ç”¢å“å•é¡Œï¼ˆåŠŸèƒ½ã€ç‰¹æ€§ã€ä½¿ç”¨æ–¹æ³•ç­‰ï¼‰\r\n- complaint: æŠ±æ€¨æˆ–ä¸æ»¿\r\n- general_chat: ä¸€èˆ¬èŠå¤©\r\n- negative_sentiment: è² é¢æƒ…ç·’\r\n- high_value: é«˜åƒ¹å€¼å®¢æˆ¶ä¿¡è™Ÿ\r\n- urgent: ç·Šæ€¥éœ€æ±‚`;\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class IntentRecognitionService {\r\n  private aiProvider = inject(AIProviderService);\r\n  \r\n  // å°è©±ä¸Šä¸‹æ–‡å­˜å„²\r\n  private conversations = signal<Map<string, ConversationContext>>(new Map());\r\n  \r\n  // è­˜åˆ¥ç·©å­˜\r\n  private cache = new Map<string, { result: IntentResult; timestamp: number }>();\r\n  private readonly CACHE_TTL = 60000; // 1åˆ†é˜ç·©å­˜\r\n  \r\n  /**\r\n   * è­˜åˆ¥ç”¨æˆ¶æ„åœ–\r\n   */\r\n  async recognizeIntent(\r\n    message: string, \r\n    userId?: string,\r\n    includeContext: boolean = true\r\n  ): Promise<IntentResult> {\r\n    // æª¢æŸ¥ç·©å­˜\r\n    const cacheKey = this.getCacheKey(message, userId);\r\n    const cached = this.cache.get(cacheKey);\r\n    if (cached && Date.now() - cached.timestamp < this.CACHE_TTL) {\r\n      return cached.result;\r\n    }\r\n    \r\n    // æ§‹å»ºæ¶ˆæ¯\r\n    const messages: AIMessage[] = [\r\n      { role: 'system', content: INTENT_RECOGNITION_PROMPT }\r\n    ];\r\n    \r\n    // æ·»åŠ å°è©±ä¸Šä¸‹æ–‡\r\n    if (userId && includeContext) {\r\n      const context = this.getContext(userId);\r\n      if (context && context.messages.length > 0) {\r\n        const recentMessages = context.messages.slice(-5);\r\n        messages.push({\r\n          role: 'user',\r\n          content: `å°è©±æ­·å²ï¼š\\n${recentMessages.map(m => `[${m.role}]: ${m.content}`).join('\\n')}\\n\\nè«‹åˆ†ææœ€æ–°æ¶ˆæ¯çš„æ„åœ–ã€‚`\r\n        });\r\n      }\r\n    }\r\n    \r\n    messages.push({ role: 'user', content: `ç”¨æˆ¶æ¶ˆæ¯ï¼š${message}` });\r\n    \r\n    try {\r\n      // ä½¿ç”¨ AI åˆ†æ\r\n      const response = await this.aiProvider.chat(messages, {\r\n        temperature: 0.3, // è¼ƒä½æº«åº¦ä»¥ç²å¾—æ›´ç©©å®šçš„çµæœ\r\n        maxTokens: 500\r\n      });\r\n      \r\n      const result = this.parseIntentResponse(response.content, message);\r\n      \r\n      // ç·©å­˜çµæœ\r\n      this.cache.set(cacheKey, { result, timestamp: Date.now() });\r\n      \r\n      // æ›´æ–°å°è©±ä¸Šä¸‹æ–‡\r\n      if (userId) {\r\n        this.updateContext(userId, message, 'user', result);\r\n      }\r\n      \r\n      return result;\r\n    } catch (error) {\r\n      console.error('Intent recognition failed:', error);\r\n      // è¿”å›åŸºæ–¼è¦å‰‡çš„å›é€€çµæœ\r\n      return this.fallbackRecognition(message);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * è§£æ AI å›è¦†\r\n   */\r\n  private parseIntentResponse(response: string, originalMessage: string): IntentResult {\r\n    try {\r\n      // å˜—è©¦è§£æ JSON\r\n      const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        const parsed = JSON.parse(jsonMatch[0]);\r\n        return {\r\n          intent: this.validateIntent(parsed.intent),\r\n          confidence: Math.min(1, Math.max(0, parsed.confidence || 0.5)),\r\n          subIntents: parsed.subIntents || [],\r\n          keywords: parsed.keywords || [],\r\n          sentiment: parsed.sentiment || 'neutral',\r\n          urgency: parsed.urgency || 'medium',\r\n          suggestedAction: parsed.suggestedAction || '',\r\n          rawAnalysis: response\r\n        };\r\n      }\r\n    } catch (e) {\r\n      console.warn('Failed to parse intent response:', e);\r\n    }\r\n    \r\n    // è§£æå¤±æ•—ï¼Œä½¿ç”¨å›é€€\r\n    return this.fallbackRecognition(originalMessage);\r\n  }\r\n  \r\n  /**\r\n   * é©—è­‰æ„åœ–é¡å‹\r\n   */\r\n  private validateIntent(intent: string): IntentType {\r\n    const validIntents: IntentType[] = [\r\n      'purchase_intent', 'price_inquiry', 'product_question',\r\n      'complaint', 'general_chat', 'negative_sentiment', \r\n      'high_value', 'urgent'\r\n    ];\r\n    \r\n    if (validIntents.includes(intent as IntentType)) {\r\n      return intent as IntentType;\r\n    }\r\n    \r\n    return 'general_chat';\r\n  }\r\n  \r\n  /**\r\n   * åŸºæ–¼è¦å‰‡çš„å›é€€è­˜åˆ¥\r\n   */\r\n  private fallbackRecognition(message: string): IntentResult {\r\n    const lowerMessage = message.toLowerCase();\r\n    \r\n    let intent: IntentType = 'general_chat';\r\n    let confidence = 0.5;\r\n    let sentiment: 'positive' | 'neutral' | 'negative' = 'neutral';\r\n    let urgency: 'low' | 'medium' | 'high' = 'medium';\r\n    const keywords: string[] = [];\r\n    \r\n    // è³¼è²·æ„å‘é—œéµè©\r\n    const purchaseKeywords = ['è³¼è²·', 'ä¸‹å–®', 'è²·', 'æ€éº¼è²·', 'ä»˜æ¬¾', 'è¨‚è³¼', 'buy', 'purchase', 'order'];\r\n    if (purchaseKeywords.some(k => lowerMessage.includes(k))) {\r\n      intent = 'purchase_intent';\r\n      confidence = 0.85;\r\n      urgency = 'high';\r\n      keywords.push(...purchaseKeywords.filter(k => lowerMessage.includes(k)));\r\n    }\r\n    \r\n    // åƒ¹æ ¼è©¢å•é—œéµè©\r\n    const priceKeywords = ['åƒ¹æ ¼', 'å¤šå°‘éŒ¢', 'è²»ç”¨', 'åƒ¹éŒ¢', 'å„ªæƒ ', 'æŠ˜æ‰£', 'price', 'cost', 'discount'];\r\n    if (priceKeywords.some(k => lowerMessage.includes(k))) {\r\n      intent = 'price_inquiry';\r\n      confidence = 0.8;\r\n      keywords.push(...priceKeywords.filter(k => lowerMessage.includes(k)));\r\n    }\r\n    \r\n    // ç”¢å“å•é¡Œé—œéµè©\r\n    const questionKeywords = ['æ€éº¼', 'å¦‚ä½•', 'ä»€éº¼', 'èƒ½ä¸èƒ½', 'å¯ä»¥', 'åŠŸèƒ½', 'how', 'what', 'can'];\r\n    if (questionKeywords.some(k => lowerMessage.includes(k))) {\r\n      if (intent === 'general_chat') {\r\n        intent = 'product_question';\r\n        confidence = 0.7;\r\n      }\r\n      keywords.push(...questionKeywords.filter(k => lowerMessage.includes(k)));\r\n    }\r\n    \r\n    // è² é¢æƒ…ç·’æª¢æ¸¬\r\n    const negativeKeywords = ['ä¸å¥½', 'å·®', 'çˆ›', 'é¨™', 'åƒåœ¾', 'é€€æ¬¾', 'bad', 'terrible', 'refund'];\r\n    if (negativeKeywords.some(k => lowerMessage.includes(k))) {\r\n      sentiment = 'negative';\r\n      if (negativeKeywords.filter(k => lowerMessage.includes(k)).length >= 2) {\r\n        intent = 'negative_sentiment';\r\n        confidence = 0.8;\r\n      }\r\n    }\r\n    \r\n    // æ­£é¢æƒ…ç·’\r\n    const positiveKeywords = ['å¥½', 'æ£’', 'è®š', 'è¬è¬', 'æ„Ÿè¬', 'great', 'thanks', 'good'];\r\n    if (positiveKeywords.some(k => lowerMessage.includes(k))) {\r\n      sentiment = 'positive';\r\n    }\r\n    \r\n    // ç·Šæ€¥ç¨‹åº¦\r\n    const urgentKeywords = ['æ€¥', 'é¦¬ä¸Š', 'ç«‹åˆ»', 'ç¾åœ¨', 'urgent', 'immediately', 'now', 'asap'];\r\n    if (urgentKeywords.some(k => lowerMessage.includes(k))) {\r\n      urgency = 'high';\r\n      if (intent === 'general_chat') {\r\n        intent = 'urgent';\r\n        confidence = 0.75;\r\n      }\r\n    }\r\n    \r\n    return {\r\n      intent,\r\n      confidence,\r\n      subIntents: [],\r\n      keywords,\r\n      sentiment,\r\n      urgency,\r\n      suggestedAction: this.getSuggestedAction(intent)\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * ç²å–å»ºè­°å‹•ä½œ\r\n   */\r\n  private getSuggestedAction(intent: IntentType): string {\r\n    const actions: Record<IntentType, string> = {\r\n      purchase_intent: 'æä¾›è³¼è²·éˆæ¥æˆ–è¯ç¹«æ–¹å¼ï¼Œæº–å‚™ä¿ƒæˆäº¤æ˜“',\r\n      price_inquiry: 'æä¾›åƒ¹æ ¼ä¿¡æ¯å’Œå„ªæƒ æ–¹æ¡ˆ',\r\n      product_question: 'è©³ç´°è§£ç­”ç”¢å“ç›¸é—œå•é¡Œ',\r\n      complaint: 'è¡¨é”æ­‰æ„ï¼Œäº†è§£å…·é«”å•é¡Œï¼Œæä¾›è§£æ±ºæ–¹æ¡ˆ',\r\n      general_chat: 'å‹å¥½å›æ‡‰ï¼Œå˜—è©¦å¼•å°åˆ°ç”¢å“è©±é¡Œ',\r\n      negative_sentiment: 'è½‰äººå·¥è™•ç†ï¼Œé¿å…è‡ªå‹•å›è¦†',\r\n      high_value: 'é‡é»è·Ÿé€²ï¼Œæä¾›VIPæœå‹™',\r\n      urgent: 'å„ªå…ˆè™•ç†ï¼Œå¿«é€Ÿå›æ‡‰'\r\n    };\r\n    \r\n    return actions[intent] || 'ç¹¼çºŒå°è©±';\r\n  }\r\n  \r\n  /**\r\n   * ç·©å­˜éµç”Ÿæˆ\r\n   */\r\n  private getCacheKey(message: string, userId?: string): string {\r\n    return `${userId || 'anonymous'}_${message.substring(0, 100)}`;\r\n  }\r\n  \r\n  // ========== å°è©±ä¸Šä¸‹æ–‡ç®¡ç† ==========\r\n  \r\n  /**\r\n   * ç²å–å°è©±ä¸Šä¸‹æ–‡\r\n   */\r\n  getContext(userId: string): ConversationContext | undefined {\r\n    return this.conversations().get(userId);\r\n  }\r\n  \r\n  /**\r\n   * å‰µå»ºæ–°å°è©±\r\n   */\r\n  createContext(userId: string): ConversationContext {\r\n    const context: ConversationContext = {\r\n      id: `conv_${Date.now()}`,\r\n      userId,\r\n      messages: [],\r\n      currentStage: 'initial',\r\n      intentHistory: [],\r\n      totalScore: 0,\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    this.conversations.update(map => {\r\n      const newMap = new Map(map);\r\n      newMap.set(userId, context);\r\n      return newMap;\r\n    });\r\n    \r\n    return context;\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°å°è©±ä¸Šä¸‹æ–‡\r\n   */\r\n  updateContext(\r\n    userId: string, \r\n    message: string, \r\n    role: 'user' | 'assistant',\r\n    intent?: IntentResult\r\n  ): void {\r\n    let context = this.conversations().get(userId);\r\n    if (!context) {\r\n      context = this.createContext(userId);\r\n    }\r\n    \r\n    const newMessage = {\r\n      role,\r\n      content: message,\r\n      timestamp: new Date(),\r\n      intent\r\n    };\r\n    \r\n    // æ›´æ–°æ„åœ–æ­·å²\r\n    if (intent && role === 'user') {\r\n      context.intentHistory.push(intent.intent);\r\n      context.totalScore += this.getIntentScore(intent);\r\n      context.currentStage = this.determineStage(context);\r\n    }\r\n    \r\n    context.messages.push(newMessage);\r\n    context.updatedAt = new Date();\r\n    \r\n    this.conversations.update(map => {\r\n      const newMap = new Map(map);\r\n      newMap.set(userId, { ...context! });\r\n      return newMap;\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * ç²å–æ„åœ–è©•åˆ†\r\n   */\r\n  private getIntentScore(intent: IntentResult): number {\r\n    const scores: Record<IntentType, number> = {\r\n      purchase_intent: 30,\r\n      price_inquiry: 20,\r\n      product_question: 10,\r\n      high_value: 25,\r\n      urgent: 15,\r\n      general_chat: 5,\r\n      complaint: -10,\r\n      negative_sentiment: -20\r\n    };\r\n    \r\n    const baseScore = scores[intent.intent] || 0;\r\n    return Math.round(baseScore * intent.confidence);\r\n  }\r\n  \r\n  /**\r\n   * ç¢ºå®šå°è©±éšæ®µ\r\n   */\r\n  private determineStage(context: ConversationContext): ConversationContext['currentStage'] {\r\n    const { totalScore, intentHistory } = context;\r\n    \r\n    if (intentHistory.includes('purchase_intent')) {\r\n      return 'closing';\r\n    }\r\n    \r\n    if (intentHistory.includes('price_inquiry')) {\r\n      return 'negotiating';\r\n    }\r\n    \r\n    if (totalScore >= 30 || intentHistory.includes('high_value')) {\r\n      return 'interested';\r\n    }\r\n    \r\n    if (context.messages.length > 2) {\r\n      return 'exploring';\r\n    }\r\n    \r\n    return 'initial';\r\n  }\r\n  \r\n  /**\r\n   * æ¸…é™¤å°è©±ä¸Šä¸‹æ–‡\r\n   */\r\n  clearContext(userId: string): void {\r\n    this.conversations.update(map => {\r\n      const newMap = new Map(map);\r\n      newMap.delete(userId);\r\n      return newMap;\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * ç²å–ç”¨æˆ¶æ„å‘è©•åˆ†\r\n   */\r\n  getIntentScore4User(userId: string): number {\r\n    const context = this.conversations().get(userId);\r\n    return context?.totalScore || 0;\r\n  }\r\n  \r\n  /**\r\n   * æª¢æŸ¥æ˜¯å¦æ‡‰è©²è½‰äººå·¥\r\n   */\r\n  shouldHandoffToHuman(userId: string): boolean {\r\n    const context = this.conversations().get(userId);\r\n    if (!context) return false;\r\n    \r\n    // é«˜è³¼è²·æ„å‘\r\n    if (context.currentStage === 'closing') return true;\r\n    \r\n    // è² é¢æƒ…ç·’\r\n    if (context.intentHistory.includes('negative_sentiment')) return true;\r\n    if (context.intentHistory.includes('complaint')) return true;\r\n    \r\n    // é«˜åˆ†å€¼\r\n    if (context.totalScore >= 50) return true;\r\n    \r\n    return false;\r\n  }\r\n}\r\n", "/**\r\n * å°è©±å¼•æ“æœå‹™\r\n * Conversation Engine Service\r\n * \r\n * æ•´åˆæ„åœ–è­˜åˆ¥ã€çŸ¥è­˜åº«å’Œå°è©±ç­–ç•¥ï¼Œç”Ÿæˆæ™ºèƒ½å›è¦†\r\n */\r\n\r\nimport { Injectable, inject, signal, computed } from '@angular/core';\r\nimport { AIProviderService, AIMessage } from '../ai-provider.service';\r\nimport { IntentRecognitionService, IntentResult, ConversationContext } from './intent-recognition.service';\r\nimport { AICenterService } from './ai-center.service';\r\nimport { IntentType, ConversationStyle, SmartRule } from './ai-center.models';\r\n\r\n// å›è¦†çµæœ\r\nexport interface ReplyResult {\r\n  content: string;\r\n  intent: IntentResult;\r\n  shouldHandoff: boolean;\r\n  handoffReason?: string;\r\n  triggeredRules: SmartRule[];\r\n  suggestedFollowUp?: string;\r\n  delay: number; // å»ºè­°å»¶é²ï¼ˆç§’ï¼‰\r\n  metadata: {\r\n    modelUsed: string;\r\n    tokensUsed: number;\r\n    processingTime: number;\r\n    knowledgeUsed: boolean;\r\n  };\r\n}\r\n\r\n// å°è©±é…ç½®\r\nexport interface ConversationConfig {\r\n  // åŸºç¤è¨­ç½®\r\n  userId: string;\r\n  userName?: string;\r\n  sourceGroup?: string;\r\n  \r\n  // ä¸Šä¸‹æ–‡\r\n  previousMessages?: string[];\r\n  \r\n  // ç­–ç•¥è¦†è“‹\r\n  styleOverride?: ConversationStyle;\r\n  maxTokens?: number;\r\n  temperature?: number;\r\n  \r\n  // è§’è‰²æ‰®æ¼”\r\n  rolePrompt?: string;\r\n  roleName?: string;\r\n  \r\n  // çŸ¥è­˜åº«\r\n  useKnowledgeBase?: boolean;\r\n  knowledgeBaseId?: string;\r\n}\r\n\r\n// ç³»çµ± Prompt æ§‹å»ºå™¨\r\nconst buildSystemPrompt = (config: {\r\n  style: ConversationStyle;\r\n  roleName?: string;\r\n  rolePrompt?: string;\r\n  businessContext?: string;\r\n  emojiFrequency: 'none' | 'low' | 'medium' | 'high';\r\n  responseLength: 'short' | 'medium' | 'long';\r\n}): string => {\r\n  let prompt = '';\r\n  \r\n  // è§’è‰²å®šç¾©\r\n  if (config.rolePrompt) {\r\n    prompt += config.rolePrompt + '\\n\\n';\r\n  } else {\r\n    prompt += `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„éŠ·å”®é¡§å•ï¼Œåå«${config.roleName || 'å°åŠ©æ‰‹'}ã€‚`;\r\n  }\r\n  \r\n  // é¢¨æ ¼æŒ‡ä»¤\r\n  const styleInstructions: Record<ConversationStyle, string> = {\r\n    professional: 'ä¿æŒå°ˆæ¥­ã€æ­£å¼çš„èªèª¿ï¼Œä½¿ç”¨è¡Œæ¥­è¡“èªï¼Œæ³¨é‡é‚è¼¯å’Œæ•¸æ“šã€‚',\r\n    friendly: 'ä¿æŒå‹å¥½ã€è¦ªåˆ‡çš„èªèª¿ï¼Œåƒæœ‹å‹ä¸€æ¨£äº¤æµï¼Œè®“å®¢æˆ¶æ„Ÿåˆ°èˆ’é©ã€‚',\r\n    casual: 'ä½¿ç”¨è¼•é¬†ã€éš¨æ„çš„èªèª¿ï¼Œå¯ä»¥é–‹é©ç•¶çš„ç©ç¬‘ï¼Œç‡Ÿé€ è¼•é¬†æ°›åœã€‚',\r\n    enthusiastic: 'ä¿æŒç†±æƒ…ã€ç©æ¥µçš„èªèª¿ï¼Œè¡¨ç¾å‡ºå°ç”¢å“å’Œå®¢æˆ¶çš„ç†±æ„›ã€‚',\r\n    direct: 'ç›´æ¥ã€ç°¡æ½”åœ°å›ç­”å•é¡Œï¼Œä¸ç¹å½å­ï¼Œé«˜æ•ˆæºé€šã€‚'\r\n  };\r\n  prompt += styleInstructions[config.style] + '\\n\\n';\r\n  \r\n  // å›è¦†é•·åº¦\r\n  const lengthInstructions = {\r\n    short: 'å›è¦†è¦ç°¡çŸ­ç²¾ç…‰ï¼Œé€šå¸¸1-2å¥è©±ã€‚',\r\n    medium: 'å›è¦†é©ä¸­ï¼Œé€šå¸¸3-5å¥è©±ï¼ŒåŒ…å«å¿…è¦çš„ä¿¡æ¯ã€‚',\r\n    long: 'å¯ä»¥è©³ç´°å›è¦†ï¼ŒåŒ…å«å……åˆ†çš„è§£é‡‹å’Œä¾‹å­ã€‚'\r\n  };\r\n  prompt += lengthInstructions[config.responseLength] + '\\n\\n';\r\n  \r\n  // Emoji ä½¿ç”¨\r\n  if (config.emojiFrequency !== 'none') {\r\n    const emojiInstructions = {\r\n      low: 'å¯ä»¥å¶çˆ¾ä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿï¼Œä½†è¦ç¯€åˆ¶ã€‚',\r\n      medium: 'é©ç•¶ä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿä¾†å¢åŠ è¦ªå’ŒåŠ›ã€‚',\r\n      high: 'å¤§é‡ä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿï¼Œè®“å°è©±æ›´æ´»æ½‘ã€‚'\r\n    };\r\n    prompt += emojiInstructions[config.emojiFrequency] + '\\n\\n';\r\n  } else {\r\n    prompt += 'ä¸è¦ä½¿ç”¨ä»»ä½•è¡¨æƒ…ç¬¦è™Ÿã€‚\\n\\n';\r\n  }\r\n  \r\n  // æ¥­å‹™ä¸Šä¸‹æ–‡\r\n  if (config.businessContext) {\r\n    prompt += `æ¥­å‹™èƒŒæ™¯ï¼š\\n${config.businessContext}\\n\\n`;\r\n  }\r\n  \r\n  // é€šç”¨æŒ‡ä»¤\r\n  prompt += `é‡è¦è¦å‰‡ï¼š\r\n1. æ°¸é ä¸è¦èªªè‡ªå·±æ˜¯ AI æˆ–æ©Ÿå™¨äºº\r\n2. ä¸è¦ä½¿ç”¨ markdown æ ¼å¼\r\n3. ç›´æ¥å›è¦†ï¼Œä¸è¦åŠ ä»»ä½•å‰ç¶´å¦‚\"å›è¦†ï¼š\"\r\n4. å¦‚æœä¸ç¢ºå®šï¼Œå¯ä»¥èªª\"è®“æˆ‘ç¢ºèªä¸€ä¸‹\"è€Œä¸æ˜¯ç·¨é€ ä¿¡æ¯\r\n5. ä¿æŒå°è©±è‡ªç„¶æµæš¢`;\r\n  \r\n  return prompt;\r\n};\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ConversationEngineService {\r\n  private aiProvider = inject(AIProviderService);\r\n  private intentService = inject(IntentRecognitionService);\r\n  private aiCenter = inject(AICenterService);\r\n  \r\n  // çµ±è¨ˆ\r\n  private stats = signal({\r\n    totalConversations: 0,\r\n    totalReplies: 0,\r\n    avgResponseTime: 0,\r\n    handoffCount: 0,\r\n    conversionCount: 0\r\n  });\r\n  \r\n  conversationStats = this.stats.asReadonly();\r\n  \r\n  /**\r\n   * ç”Ÿæˆæ™ºèƒ½å›è¦†\r\n   */\r\n  async generateReply(\r\n    userMessage: string,\r\n    config: ConversationConfig\r\n  ): Promise<ReplyResult> {\r\n    const startTime = Date.now();\r\n    \r\n    // 1. è­˜åˆ¥æ„åœ–\r\n    const intent = await this.intentService.recognizeIntent(\r\n      userMessage, \r\n      config.userId,\r\n      true\r\n    );\r\n    \r\n    // 2. æª¢æŸ¥æ™ºèƒ½è¦å‰‡\r\n    const triggeredRules = await this.checkSmartRules(intent, config.userId);\r\n    \r\n    // 3. æª¢æŸ¥æ˜¯å¦éœ€è¦è½‰äººå·¥\r\n    const handoffCheck = this.checkHandoff(intent, triggeredRules, config.userId);\r\n    \r\n    // 4. ç²å–ç­–ç•¥é…ç½®\r\n    const strategy = this.aiCenter.strategy();\r\n    \r\n    // 5. æ§‹å»ºçŸ¥è­˜åº«ä¸Šä¸‹æ–‡\r\n    let knowledgeContext = '';\r\n    let knowledgeUsed = false;\r\n    if (config.useKnowledgeBase !== false) {\r\n      const kb = this.aiCenter.activeKnowledgeBase();\r\n      if (kb) {\r\n        knowledgeContext = this.buildKnowledgeContext(kb, userMessage, intent);\r\n        knowledgeUsed = knowledgeContext.length > 0;\r\n      }\r\n    }\r\n    \r\n    // 6. æ§‹å»ºç³»çµ± Prompt\r\n    const systemPrompt = buildSystemPrompt({\r\n      style: config.styleOverride || strategy.style,\r\n      roleName: config.roleName,\r\n      rolePrompt: config.rolePrompt,\r\n      businessContext: knowledgeContext,\r\n      emojiFrequency: strategy.emojiFrequency,\r\n      responseLength: strategy.responseLength\r\n    });\r\n    \r\n    // 7. æ§‹å»ºæ¶ˆæ¯æ­·å²\r\n    const messages: AIMessage[] = [\r\n      { role: 'system', content: systemPrompt }\r\n    ];\r\n    \r\n    // æ·»åŠ å°è©±æ­·å²\r\n    const context = this.intentService.getContext(config.userId);\r\n    if (context && context.messages.length > 0) {\r\n      const recentMessages = context.messages.slice(-6); // æœ€è¿‘6æ¢\r\n      for (const msg of recentMessages) {\r\n        messages.push({\r\n          role: msg.role === 'user' ? 'user' : 'assistant',\r\n          content: msg.content\r\n        });\r\n      }\r\n    }\r\n    \r\n    // æ·»åŠ ç•¶å‰æ¶ˆæ¯\r\n    messages.push({ role: 'user', content: userMessage });\r\n    \r\n    // 8. ç”Ÿæˆå›è¦†\r\n    let replyContent = '';\r\n    let tokensUsed = 0;\r\n    let modelUsed = '';\r\n    \r\n    try {\r\n      const response = await this.aiProvider.chat(messages, {\r\n        temperature: config.temperature ?? strategy.style === 'casual' ? 0.8 : 0.7,\r\n        maxTokens: config.maxTokens ?? (strategy.responseLength === 'long' ? 500 : 200)\r\n      });\r\n      \r\n      replyContent = response.content;\r\n      tokensUsed = response.usage.totalTokens;\r\n      modelUsed = response.model;\r\n    } catch (error) {\r\n      console.error('Failed to generate reply:', error);\r\n      replyContent = this.getFallbackReply(intent);\r\n    }\r\n    \r\n    // 9. å¾Œè™•ç†\r\n    replyContent = this.postProcessReply(replyContent, intent, config);\r\n    \r\n    // 10. æ›´æ–°å°è©±ä¸Šä¸‹æ–‡\r\n    this.intentService.updateContext(config.userId, replyContent, 'assistant');\r\n    \r\n    // 11. è¨ˆç®—å»¶é²\r\n    const delay = this.calculateDelay(replyContent, intent);\r\n    \r\n    // 12. æ›´æ–°çµ±è¨ˆ\r\n    const processingTime = Date.now() - startTime;\r\n    this.updateStats(processingTime, handoffCheck.shouldHandoff);\r\n    \r\n    return {\r\n      content: replyContent,\r\n      intent,\r\n      shouldHandoff: handoffCheck.shouldHandoff,\r\n      handoffReason: handoffCheck.reason,\r\n      triggeredRules,\r\n      suggestedFollowUp: this.getSuggestedFollowUp(intent),\r\n      delay,\r\n      metadata: {\r\n        modelUsed,\r\n        tokensUsed,\r\n        processingTime,\r\n        knowledgeUsed\r\n      }\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * å¤šè§’è‰²å°è©±ç”Ÿæˆ\r\n   */\r\n  async generateMultiRoleReply(\r\n    userMessage: string,\r\n    roleConfig: {\r\n      roleId: string;\r\n      roleName: string;\r\n      rolePrompt: string;\r\n      personality: string;\r\n    },\r\n    config: ConversationConfig\r\n  ): Promise<ReplyResult> {\r\n    return this.generateReply(userMessage, {\r\n      ...config,\r\n      roleName: roleConfig.roleName,\r\n      rolePrompt: roleConfig.rolePrompt\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * æª¢æŸ¥æ™ºèƒ½è¦å‰‡\r\n   */\r\n  private async checkSmartRules(\r\n    intent: IntentResult, \r\n    userId: string\r\n  ): Promise<SmartRule[]> {\r\n    const rules = this.aiCenter.activeRules();\r\n    const triggered: SmartRule[] = [];\r\n    \r\n    const context = this.intentService.getContext(userId);\r\n    const conversationRounds = context?.messages.filter(m => m.role === 'user').length || 0;\r\n    \r\n    for (const rule of rules) {\r\n      // æª¢æŸ¥æ„åœ–åŒ¹é…\r\n      if (rule.triggerIntent !== intent.intent) continue;\r\n      \r\n      // æª¢æŸ¥ç½®ä¿¡åº¦\r\n      if (rule.triggerConditions.intentScore && \r\n          intent.confidence < rule.triggerConditions.intentScore) continue;\r\n      \r\n      // æª¢æŸ¥å°è©±è¼ªæ•¸\r\n      if (rule.triggerConditions.conversationRounds && \r\n          conversationRounds < rule.triggerConditions.conversationRounds) continue;\r\n      \r\n      // æª¢æŸ¥é—œéµè©\r\n      if (rule.triggerConditions.keywordMatch) {\r\n        const hasKeyword = rule.triggerConditions.keywordMatch.some(\r\n          kw => intent.keywords.includes(kw)\r\n        );\r\n        if (!hasKeyword) continue;\r\n      }\r\n      \r\n      triggered.push(rule);\r\n    }\r\n    \r\n    return triggered.sort((a, b) => b.priority - a.priority);\r\n  }\r\n  \r\n  /**\r\n   * æª¢æŸ¥æ˜¯å¦éœ€è¦è½‰äººå·¥\r\n   */\r\n  private checkHandoff(\r\n    intent: IntentResult,\r\n    triggeredRules: SmartRule[],\r\n    userId: string\r\n  ): { shouldHandoff: boolean; reason?: string } {\r\n    // è¦å‰‡è§¸ç™¼çš„è½‰äººå·¥\r\n    const handoffRule = triggeredRules.find(r => r.actions.notifyHuman);\r\n    if (handoffRule) {\r\n      return { \r\n        shouldHandoff: true, \r\n        reason: `è¦å‰‡è§¸ç™¼ï¼š${handoffRule.name}` \r\n      };\r\n    }\r\n    \r\n    // é«˜è³¼è²·æ„å‘\r\n    if (intent.intent === 'purchase_intent' && intent.confidence > 0.8) {\r\n      return { \r\n        shouldHandoff: true, \r\n        reason: 'é«˜è³¼è²·æ„å‘ï¼Œå»ºè­°äººå·¥è·Ÿé€²' \r\n      };\r\n    }\r\n    \r\n    // è² é¢æƒ…ç·’\r\n    if (intent.intent === 'negative_sentiment' || intent.sentiment === 'negative') {\r\n      return { \r\n        shouldHandoff: true, \r\n        reason: 'è² é¢æƒ…ç·’ï¼Œéœ€è¦äººå·¥è™•ç†' \r\n      };\r\n    }\r\n    \r\n    // æœå‹™æª¢æŸ¥\r\n    if (this.intentService.shouldHandoffToHuman(userId)) {\r\n      return { \r\n        shouldHandoff: true, \r\n        reason: 'å°è©±åˆ†æå»ºè­°è½‰äººå·¥' \r\n      };\r\n    }\r\n    \r\n    return { shouldHandoff: false };\r\n  }\r\n  \r\n  /**\r\n   * æ§‹å»ºçŸ¥è­˜åº«ä¸Šä¸‹æ–‡\r\n   */\r\n  private buildKnowledgeContext(\r\n    kb: any, \r\n    message: string, \r\n    intent: IntentResult\r\n  ): string {\r\n    if (!kb || !kb.items || kb.items.length === 0) return '';\r\n    \r\n    // ç°¡å–®çš„é—œéµè©åŒ¹é…\r\n    const relevantItems = kb.items.filter((item: any) => {\r\n      if (!item.isActive) return false;\r\n      \r\n      // æ„åœ–ç›¸é—œ\r\n      if (intent.intent === 'price_inquiry' && item.category === 'sales') return true;\r\n      if (intent.intent === 'product_question' && item.category === 'product') return true;\r\n      if (intent.intent === 'complaint' && item.category === 'objection') return true;\r\n      \r\n      // é—œéµè©åŒ¹é…\r\n      if (item.keywords && item.keywords.length > 0) {\r\n        return item.keywords.some((kw: string) => \r\n          message.toLowerCase().includes(kw.toLowerCase())\r\n        );\r\n      }\r\n      \r\n      return false;\r\n    }).slice(0, 3); // æœ€å¤š3å€‹\r\n    \r\n    if (relevantItems.length === 0) return '';\r\n    \r\n    return 'ç›¸é—œç”¢å“çŸ¥è­˜ï¼š\\n' + relevantItems.map((item: any) => \r\n      `- ${item.title}ï¼š${item.content}`\r\n    ).join('\\n');\r\n  }\r\n  \r\n  /**\r\n   * å¾Œè™•ç†å›è¦†\r\n   */\r\n  private postProcessReply(\r\n    content: string, \r\n    intent: IntentResult,\r\n    config: ConversationConfig\r\n  ): string {\r\n    let processed = content.trim();\r\n    \r\n    // ç§»é™¤å¯èƒ½çš„å‰ç¶´\r\n    processed = processed.replace(/^(å›è¦†[ï¼š:]\\s*|Reply[ï¼š:]\\s*)/i, '');\r\n    \r\n    // ç§»é™¤ markdown\r\n    processed = processed.replace(/\\*\\*/g, '');\r\n    processed = processed.replace(/\\*/g, '');\r\n    processed = processed.replace(/`/g, '');\r\n    processed = processed.replace(/#{1,6}\\s/g, '');\r\n    \r\n    // å€‹æ€§åŒ–\r\n    if (config.userName) {\r\n      // æœ‰æ©ŸæœƒåŠ å…¥ç”¨æˆ¶å\r\n      if (Math.random() < 0.3 && !processed.includes(config.userName)) {\r\n        processed = `${config.userName}ï¼Œ${processed}`;\r\n      }\r\n    }\r\n    \r\n    return processed;\r\n  }\r\n  \r\n  /**\r\n   * ç²å–å›é€€å›è¦†\r\n   */\r\n  private getFallbackReply(intent: IntentResult): string {\r\n    const fallbacks: Record<IntentType, string[]> = {\r\n      purchase_intent: [\r\n        'æ„Ÿè¬æ‚¨çš„èˆˆè¶£ï¼è«‹å•æ‚¨æƒ³äº†è§£å“ªå€‹æ–¹æ¡ˆå‘¢ï¼Ÿ',\r\n        'å¤ªå¥½äº†ï¼æˆ‘å¯ä»¥ç‚ºæ‚¨è©³ç´°ä»‹ç´¹è³¼è²·æµç¨‹ã€‚'\r\n      ],\r\n      price_inquiry: [\r\n        'é—œæ–¼åƒ¹æ ¼ï¼Œæˆ‘å€‘æœ‰å¤šç¨®æ–¹æ¡ˆå¯ä»¥é¸æ“‡ï¼Œæ–¹ä¾¿å‘Šè¨´æˆ‘æ‚¨çš„éœ€æ±‚å—ï¼Ÿ',\r\n        'åƒ¹æ ¼æ–¹é¢ï¼Œæˆ‘å¯ä»¥æ ¹æ“šæ‚¨çš„éœ€æ±‚çµ¦å‡ºæœ€é©åˆçš„æ–¹æ¡ˆã€‚'\r\n      ],\r\n      product_question: [\r\n        'é€™æ˜¯å€‹å¥½å•é¡Œï¼è®“æˆ‘ç‚ºæ‚¨è©³ç´°èªªæ˜ã€‚',\r\n        'æ„Ÿè¬æ‚¨çš„è©¢å•ï¼Œæˆ‘ä¾†ç‚ºæ‚¨è§£ç­”ã€‚'\r\n      ],\r\n      complaint: [\r\n        'éå¸¸æŠ±æ­‰çµ¦æ‚¨å¸¶ä¾†ä¸ä¾¿ï¼Œè®“æˆ‘äº†è§£ä¸€ä¸‹å…·é«”æƒ…æ³ã€‚',\r\n        'æˆ‘ç†è§£æ‚¨çš„å¿ƒæƒ…ï¼Œè«‹å‘Šè¨´æˆ‘å…·é«”å•é¡Œï¼Œæˆ‘æœƒç›¡åŠ›å¹«æ‚¨è§£æ±ºã€‚'\r\n      ],\r\n      general_chat: [\r\n        'æ„Ÿè¬æ‚¨çš„è¨Šæ¯ï¼æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«æ‚¨çš„å—ï¼Ÿ',\r\n        'æ‚¨å¥½ï¼è«‹å•æœ‰ä»€éº¼å•é¡Œæƒ³äº†è§£å—ï¼Ÿ'\r\n      ],\r\n      negative_sentiment: [\r\n        'æˆ‘ç†è§£æ‚¨çš„å¿ƒæƒ…ã€‚è«‹å•å…·é«”æ˜¯ä»€éº¼å•é¡Œå‘¢ï¼Ÿ',\r\n        'æ„Ÿè¬æ‚¨çš„åé¥‹ï¼Œæˆ‘å€‘æœƒèªçœŸå°å¾…ã€‚'\r\n      ],\r\n      high_value: [\r\n        'æ„Ÿè¬æ‚¨çš„ä¿¡ä»»ï¼æˆ‘æœƒç‚ºæ‚¨æä¾›æœ€å¥½çš„æœå‹™ã€‚',\r\n        'éå¸¸é«˜èˆˆç‚ºæ‚¨æœå‹™ï¼'\r\n      ],\r\n      urgent: [\r\n        'æ”¶åˆ°ï¼Œæˆ‘é¦¬ä¸Šç‚ºæ‚¨è™•ç†ï¼',\r\n        'å¥½çš„ï¼Œæˆ‘ç«‹åˆ»å¹«æ‚¨è§£æ±ºï¼'\r\n      ]\r\n    };\r\n    \r\n    const options = fallbacks[intent.intent] || fallbacks.general_chat;\r\n    return options[Math.floor(Math.random() * options.length)];\r\n  }\r\n  \r\n  /**\r\n   * ç²å–å»ºè­°çš„è·Ÿé€²è©±è¡“\r\n   */\r\n  private getSuggestedFollowUp(intent: IntentResult): string | undefined {\r\n    const followUps: Partial<Record<IntentType, string>> = {\r\n      price_inquiry: 'å¯ä»¥å•å®¢æˆ¶çš„å…·é«”éœ€æ±‚å’Œé ç®—',\r\n      product_question: 'å¯ä»¥å•å®¢æˆ¶æ˜¯å¦é‚„æœ‰å…¶ä»–å•é¡Œ',\r\n      purchase_intent: 'å¯ä»¥æä¾›ä»˜æ¬¾æ–¹å¼å’Œå„ªæƒ ä¿¡æ¯'\r\n    };\r\n    \r\n    return followUps[intent.intent];\r\n  }\r\n  \r\n  /**\r\n   * è¨ˆç®—å›è¦†å»¶é²\r\n   */\r\n  private calculateDelay(content: string, intent: IntentResult): number {\r\n    // åŸºç¤å»¶é²ï¼š30-60ç§’\r\n    let baseDelay = 30 + Math.random() * 30;\r\n    \r\n    // æ ¹æ“šå…§å®¹é•·åº¦èª¿æ•´\r\n    const charCount = content.length;\r\n    const typingTime = charCount * 0.1; // æ¯å­—ç¬¦0.1ç§’\r\n    \r\n    // ç·Šæ€¥æƒ…æ³æ¸›å°‘å»¶é²\r\n    if (intent.urgency === 'high') {\r\n      baseDelay = 10 + Math.random() * 10;\r\n    }\r\n    \r\n    return Math.round(baseDelay + typingTime);\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°çµ±è¨ˆ\r\n   */\r\n  private updateStats(processingTime: number, isHandoff: boolean): void {\r\n    this.stats.update(s => ({\r\n      totalConversations: s.totalConversations,\r\n      totalReplies: s.totalReplies + 1,\r\n      avgResponseTime: (s.avgResponseTime * s.totalReplies + processingTime) / (s.totalReplies + 1),\r\n      handoffCount: s.handoffCount + (isHandoff ? 1 : 0),\r\n      conversionCount: s.conversionCount\r\n    }));\r\n  }\r\n  \r\n  /**\r\n   * é–‹å§‹æ–°å°è©±\r\n   */\r\n  startConversation(userId: string): void {\r\n    this.intentService.createContext(userId);\r\n    this.stats.update(s => ({\r\n      ...s,\r\n      totalConversations: s.totalConversations + 1\r\n    }));\r\n  }\r\n  \r\n  /**\r\n   * çµæŸå°è©±\r\n   */\r\n  endConversation(userId: string, converted: boolean = false): void {\r\n    this.intentService.clearContext(userId);\r\n    if (converted) {\r\n      this.stats.update(s => ({\r\n        ...s,\r\n        conversionCount: s.conversionCount + 1\r\n      }));\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ç²å–å°è©±ä¸Šä¸‹æ–‡\r\n   */\r\n  getConversation(userId: string): ConversationContext | undefined {\r\n    return this.intentService.getContext(userId);\r\n  }\r\n  \r\n  /**\r\n   * ç²å–ç”¨æˆ¶æ„å‘è©•åˆ†\r\n   */\r\n  getUserIntentScore(userId: string): number {\r\n    return this.intentService.getIntentScore4User(userId);\r\n  }\r\n}\r\n", "/**\r\n * å¤šè§’è‰²å”ä½œæœå‹™\r\n * Multi-Role Collaboration Service\r\n */\r\n\r\nimport { Injectable, signal, computed, inject } from '@angular/core';\r\nimport {\r\n  MultiRoleConfig,\r\n  RoleDefinition,\r\n  ScriptTemplate,\r\n  CollaborationGroup,\r\n  RoleType,\r\n  SpeakingStyle,\r\n  ROLE_TYPE_META,\r\n  DEFAULT_MULTI_ROLE_CONFIG,\r\n  ScriptStage\r\n} from './multi-role.models';\r\nimport { AICenterService } from '../ai-center/ai-center.service';\r\nimport { ConversationEngineService } from '../ai-center/conversation-engine.service';\r\nimport { ElectronIpcService } from '../electron-ipc.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MultiRoleService {\r\n  private aiCenter = inject(AICenterService);\r\n  private conversationEngine = inject(ConversationEngineService);\r\n  private ipc = inject(ElectronIpcService);\r\n  \r\n  // é…ç½®\r\n  private config = signal<MultiRoleConfig>(DEFAULT_MULTI_ROLE_CONFIG);\r\n  \r\n  // æ´»èºçš„å”ä½œç¾¤çµ„\r\n  private activeGroups = signal<CollaborationGroup[]>([]);\r\n  \r\n  // è¨ˆç®—å±¬æ€§\r\n  roles = computed(() => this.config().roles);\r\n  scripts = computed(() => this.config().scripts);\r\n  activeGroupCount = computed(() => \r\n    this.activeGroups().filter(g => g.status === 'running').length\r\n  );\r\n  \r\n  // å¯ç”¨è§’è‰²ï¼ˆå·²ç¶å®šå¸³è™Ÿä¸”æ´»èºï¼‰\r\n  availableRoles = computed(() => \r\n    this.config().roles.filter(r => r.isActive && r.boundAccountId)\r\n  );\r\n  \r\n  // è§’è‰²é¡å‹å…ƒæ•¸æ“š\r\n  roleTypeMeta = ROLE_TYPE_META;\r\n  \r\n  // ========== è§’è‰²ç®¡ç† ==========\r\n  \r\n  addRole(roleData: Partial<RoleDefinition>): string {\r\n    const id = `role_${Date.now()}`;\r\n    const roleType = roleData.type || 'custom';\r\n    const meta = ROLE_TYPE_META[roleType];\r\n    \r\n    const newRole: RoleDefinition = {\r\n      id,\r\n      name: roleData.name || meta.label,\r\n      type: roleType,\r\n      boundAccountId: roleData.boundAccountId,\r\n      boundAccountPhone: roleData.boundAccountPhone,\r\n      personality: {\r\n        description: roleData.personality?.description || meta.description,\r\n        speakingStyle: roleData.personality?.speakingStyle || meta.defaultStyle,\r\n        traits: roleData.personality?.traits || [],\r\n        background: roleData.personality?.background\r\n      },\r\n      aiConfig: {\r\n        useGlobalAI: true,\r\n        customPrompt: meta.defaultPrompt,\r\n        responseLength: 'medium',\r\n        emojiFrequency: 'low',\r\n        typingSpeed: 'medium',\r\n        ...roleData.aiConfig\r\n      },\r\n      responsibilities: roleData.responsibilities || [],\r\n      isActive: true,\r\n      createdAt: new Date().toISOString(),\r\n      updatedAt: new Date().toISOString()\r\n    };\r\n    \r\n    this.config.update(c => ({\r\n      ...c,\r\n      roles: [...c.roles, newRole]\r\n    }));\r\n    \r\n    // åŒæ­¥åˆ°å¾Œç«¯\r\n    this.ipc.send('multi-role-add-role', newRole);\r\n    \r\n    return id;\r\n  }\r\n  \r\n  updateRole(id: string, updates: Partial<RoleDefinition>) {\r\n    this.config.update(c => ({\r\n      ...c,\r\n      roles: c.roles.map(r => \r\n        r.id === id ? { ...r, ...updates, updatedAt: new Date().toISOString() } : r\r\n      )\r\n    }));\r\n    \r\n    // åŒæ­¥åˆ°å¾Œç«¯\r\n    this.ipc.send('multi-role-update-role', { id, ...updates });\r\n  }\r\n  \r\n  deleteRole(id: string) {\r\n    this.config.update(c => ({\r\n      ...c,\r\n      roles: c.roles.filter(r => r.id !== id)\r\n    }));\r\n    \r\n    // åŒæ­¥åˆ°å¾Œç«¯\r\n    this.ipc.send('multi-role-delete-role', { id });\r\n  }\r\n  \r\n  bindAccountToRole(roleId: string, accountId: number, accountPhone: string) {\r\n    this.updateRole(roleId, { \r\n      boundAccountId: accountId, \r\n      boundAccountPhone: accountPhone \r\n    });\r\n  }\r\n  \r\n  unbindAccountFromRole(roleId: string) {\r\n    this.updateRole(roleId, { \r\n      boundAccountId: undefined, \r\n      boundAccountPhone: undefined \r\n    });\r\n  }\r\n  \r\n  // ========== åŠ‡æœ¬ç®¡ç† ==========\r\n  \r\n  addScript(scriptData: Partial<ScriptTemplate>): string {\r\n    const id = `script_${Date.now()}`;\r\n    \r\n    const newScript: ScriptTemplate = {\r\n      id,\r\n      name: scriptData.name || 'æ–°åŠ‡æœ¬',\r\n      description: scriptData.description || '',\r\n      scenario: scriptData.scenario || 'custom',\r\n      requiredRoles: scriptData.requiredRoles || ['expert', 'satisfied_customer'],\r\n      minRoleCount: scriptData.minRoleCount || 2,\r\n      stages: scriptData.stages || [],\r\n      stats: {\r\n        useCount: 0,\r\n        successCount: 0,\r\n        avgDuration: 0,\r\n        conversionRate: 0\r\n      },\r\n      isActive: true,\r\n      createdAt: new Date().toISOString(),\r\n      updatedAt: new Date().toISOString()\r\n    };\r\n    \r\n    this.config.update(c => ({\r\n      ...c,\r\n      scripts: [...c.scripts, newScript]\r\n    }));\r\n    \r\n    // åŒæ­¥åˆ°å¾Œç«¯\r\n    this.ipc.send('multi-role-add-script', newScript);\r\n    \r\n    return id;\r\n  }\r\n  \r\n  updateScript(id: string, updates: Partial<ScriptTemplate>) {\r\n    this.config.update(c => ({\r\n      ...c,\r\n      scripts: c.scripts.map(s => \r\n        s.id === id ? { ...s, ...updates, updatedAt: new Date().toISOString() } : s\r\n      )\r\n    }));\r\n    \r\n    // åŒæ­¥åˆ°å¾Œç«¯\r\n    this.ipc.send('multi-role-update-script', { id, ...updates });\r\n  }\r\n  \r\n  deleteScript(id: string) {\r\n    this.config.update(c => ({\r\n      ...c,\r\n      scripts: c.scripts.filter(s => s.id !== id)\r\n    }));\r\n    \r\n    // åŒæ­¥åˆ°å¾Œç«¯\r\n    this.ipc.send('multi-role-delete-script', { id });\r\n  }\r\n  \r\n  addStageToScript(scriptId: string, stage: ScriptStage) {\r\n    this.config.update(c => ({\r\n      ...c,\r\n      scripts: c.scripts.map(s => {\r\n        if (s.id !== scriptId) return s;\r\n        return {\r\n          ...s,\r\n          stages: [...s.stages, stage],\r\n          updatedAt: new Date().toISOString()\r\n        };\r\n      })\r\n    }));\r\n  }\r\n  \r\n  // ========== å”ä½œç¾¤çµ„ç®¡ç† ==========\r\n  \r\n  /**\r\n   * å‰µå»ºå”ä½œç¾¤çµ„ï¼ˆè‡ªå‹•å»ºç¾¤ï¼‰\r\n   */\r\n  async createCollaborationGroup(params: {\r\n    targetCustomer: CollaborationGroup['targetCustomer'];\r\n    scriptId: string;\r\n    roleIds: string[];\r\n  }): Promise<CollaborationGroup | null> {\r\n    const script = this.config().scripts.find(s => s.id === params.scriptId);\r\n    if (!script) return null;\r\n    \r\n    const roles = this.config().roles.filter(r => params.roleIds.includes(r.id));\r\n    if (roles.length < script.minRoleCount) return null;\r\n    \r\n    // æª¢æŸ¥æ˜¯å¦è¶…éæœ€å¤§åŒæ™‚å”ä½œæ•¸\r\n    const runningCount = this.activeGroups().filter(g => \r\n      g.status === 'creating' || g.status === 'inviting' || g.status === 'running'\r\n    ).length;\r\n    \r\n    if (runningCount >= this.config().autoGroupSettings.maxConcurrentGroups) {\r\n      return null;\r\n    }\r\n    \r\n    const settings = this.config().autoGroupSettings;\r\n    const groupTitle = settings.nameTemplate\r\n      .replace('{å®¢æˆ¶å}', params.targetCustomer.firstName || params.targetCustomer.username || 'VIPå®¢æˆ¶');\r\n    \r\n    const newGroup: CollaborationGroup = {\r\n      id: `collab_${Date.now()}`,\r\n      groupTitle,\r\n      targetCustomer: params.targetCustomer,\r\n      participants: roles.map(r => ({\r\n        roleId: r.id,\r\n        roleName: r.name,\r\n        accountId: r.boundAccountId!,\r\n        accountPhone: r.boundAccountPhone!\r\n      })),\r\n      scriptId: params.scriptId,\r\n      scriptName: script.name,\r\n      status: 'creating',\r\n      messagesSent: 0,\r\n      customerMessages: 0,\r\n      createdAt: new Date().toISOString()\r\n    };\r\n    \r\n    this.activeGroups.update(groups => [...groups, newGroup]);\r\n    \r\n    // TODO: å¯¦éš›å‰µå»º Telegram ç¾¤çµ„\r\n    // await this.createTelegramGroup(newGroup);\r\n    \r\n    return newGroup;\r\n  }\r\n  \r\n  updateGroupStatus(groupId: string, status: CollaborationGroup['status']) {\r\n    this.activeGroups.update(groups => \r\n      groups.map(g => g.id === groupId ? { ...g, status } : g)\r\n    );\r\n  }\r\n  \r\n  completeGroup(groupId: string, outcome: CollaborationGroup['outcome']) {\r\n    this.activeGroups.update(groups => \r\n      groups.map(g => g.id === groupId ? { \r\n        ...g, \r\n        status: 'completed',\r\n        outcome,\r\n        completedAt: new Date().toISOString()\r\n      } : g)\r\n    );\r\n  }\r\n  \r\n  // ========== åŠ‡æœ¬åŸ·è¡Œ ==========\r\n  \r\n  /**\r\n   * é–‹å§‹åŸ·è¡ŒåŠ‡æœ¬\r\n   */\r\n  async startScriptExecution(groupId: string): Promise<boolean> {\r\n    const group = this.activeGroups().find(g => g.id === groupId);\r\n    if (!group || group.status !== 'running') return false;\r\n    \r\n    const script = this.config().scripts.find(s => s.id === group.scriptId);\r\n    if (!script || script.stages.length === 0) return false;\r\n    \r\n    // è¨­ç½®ç•¶å‰éšæ®µç‚ºç¬¬ä¸€å€‹éšæ®µ\r\n    this.activeGroups.update(groups => \r\n      groups.map(g => g.id === groupId ? { \r\n        ...g, \r\n        currentStageId: script.stages[0].id,\r\n        currentStageOrder: 0\r\n      } : g)\r\n    );\r\n    \r\n    // TODO: é–‹å§‹åŸ·è¡Œç¬¬ä¸€å€‹éšæ®µ\r\n    // await this.executeStage(group, script.stages[0]);\r\n    \r\n    return true;\r\n  }\r\n  \r\n  /**\r\n   * åŸ·è¡ŒåŠ‡æœ¬éšæ®µ\r\n   */\r\n  private async executeStage(group: CollaborationGroup, stage: ScriptStage) {\r\n    const roles = this.config().roles;\r\n    \r\n    for (const message of stage.messages) {\r\n      const role = roles.find(r => r.id === message.roleId);\r\n      if (!role) continue;\r\n      \r\n      // è¨ˆç®—å»¶é²\r\n      let delay = message.timing.delayAfterPrevious;\r\n      if (message.timing.randomDelay) {\r\n        const { min, max } = message.timing.randomDelay;\r\n        delay += Math.floor(Math.random() * (max - min + 1)) + min;\r\n      }\r\n      \r\n      // ç­‰å¾…å»¶é²\r\n      await new Promise(resolve => setTimeout(resolve, delay * 1000));\r\n      \r\n      // ç”Ÿæˆæ¶ˆæ¯å…§å®¹\r\n      let content: string;\r\n      if (message.content.type === 'text') {\r\n        content = message.content.text || '';\r\n        // è™•ç†è®Šé‡æ›¿æ›\r\n        if (message.content.variables) {\r\n          content = content\r\n            .replace('{å®¢æˆ¶å}', group.targetCustomer.firstName || group.targetCustomer.username || 'VIPå®¢æˆ¶')\r\n            .replace('{ç¾¤å}', group.groupTitle);\r\n        }\r\n      } else if (message.content.type === 'ai_generate') {\r\n        // ä½¿ç”¨å°è©±å¼•æ“ç”Ÿæˆå¤šè§’è‰²å›è¦†\r\n        const replyResult = await this.conversationEngine.generateMultiRoleReply(\r\n          message.content.aiPrompt || 'è«‹æ ¹æ“šç•¶å‰å°è©±ä¸Šä¸‹æ–‡ç”Ÿæˆåˆé©çš„å›è¦†',\r\n          {\r\n            roleId: role.id,\r\n            roleName: role.name,\r\n            rolePrompt: role.aiConfig.customPrompt || '',\r\n            personality: role.personality.description\r\n          },\r\n          {\r\n            userId: group.targetCustomer.id,\r\n            userName: group.targetCustomer.firstName || group.targetCustomer.username,\r\n            sourceGroup: group.telegramGroupId || group.id\r\n          }\r\n        );\r\n        content = replyResult.content;\r\n      } else {\r\n        content = message.content.text || '';\r\n      }\r\n      \r\n      // TODO: ç™¼é€æ¶ˆæ¯\r\n      // await this.sendMessage(group, role, content);\r\n      console.log(`[MultiRole] ${role.name}: ${content}`);\r\n      \r\n      // æ›´æ–°çµ±è¨ˆ\r\n      this.activeGroups.update(groups => \r\n        groups.map(g => g.id === group.id ? { \r\n          ...g, \r\n          messagesSent: g.messagesSent + 1 \r\n        } : g)\r\n      );\r\n    }\r\n  }\r\n  \r\n  // ========== è¨­ç½®ç®¡ç† ==========\r\n  \r\n  updateAutoGroupSettings(updates: Partial<MultiRoleConfig['autoGroupSettings']>) {\r\n    this.config.update(c => ({\r\n      ...c,\r\n      autoGroupSettings: { ...c.autoGroupSettings, ...updates }\r\n    }));\r\n  }\r\n  \r\n  updateTriggerConditions(updates: Partial<MultiRoleConfig['defaultTriggerConditions']>) {\r\n    this.config.update(c => ({\r\n      ...c,\r\n      defaultTriggerConditions: { ...c.defaultTriggerConditions, ...updates }\r\n    }));\r\n  }\r\n  \r\n  updateAISettings(updates: Partial<MultiRoleConfig['aiSettings']>) {\r\n    this.config.update(c => ({\r\n      ...c,\r\n      aiSettings: { ...c.aiSettings, ...updates }\r\n    }));\r\n  }\r\n  \r\n  // ========== å°å…¥/å°å‡º ==========\r\n  \r\n  exportConfig(): string {\r\n    return JSON.stringify(this.config(), null, 2);\r\n  }\r\n  \r\n  importConfig(jsonStr: string): boolean {\r\n    try {\r\n      const config = JSON.parse(jsonStr) as MultiRoleConfig;\r\n      this.config.set(config);\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n  \r\n  // ========== é‡ç½® ==========\r\n  \r\n  resetToDefault() {\r\n    this.config.set(DEFAULT_MULTI_ROLE_CONFIG);\r\n    this.activeGroups.set([]);\r\n  }\r\n}\r\n", "/**\r\n * AI å‹•æ…‹åŠ‡æœ¬å¼•æ“æœå‹™\r\n * Dynamic Script Engine Service\r\n * \r\n * æ ¸å¿ƒåŠŸèƒ½ï¼š\r\n * 1. ä¸€å¥è©±æ„åœ–ç†è§£\r\n * 2. å¯¦æ™‚å°è©±åˆ†æï¼ˆæ¯Næ¢æ¶ˆæ¯ï¼‰\r\n * 3. å‹•æ…‹ç­–ç•¥ç”Ÿæˆå’Œèª¿æ•´\r\n * 4. å¤šè§’è‰²è‡ªç„¶é…åˆèª¿åº¦\r\n * 5. è©±é¡Œç”Ÿæˆï¼ˆæ–°è/ç”Ÿæ´»/ç”¢å“ï¼‰\r\n */\r\n\r\nimport { Injectable, signal, computed, inject, effect } from '@angular/core';\r\nimport { ElectronIpcService } from '../electron-ipc.service';\r\nimport { ToastService } from '../toast.service';\r\nimport { MultiRoleService } from './multi-role.service';\r\nimport { AccountManagementService } from '../services/account-management.service';\r\nimport { TelegramAccount } from '../models';\r\n\r\n// ============ é¡å‹å®šç¾© ============\r\n\r\n// åŸ·è¡Œæ¨¡å¼\r\n// ğŸ”§ P0-1: æ·»åŠ  'private' æ¨¡å¼ï¼Œæ˜ç¢ºå€åˆ†ç§èŠå’Œç¾¤èŠ\r\nexport type ExecutionMode = 'scripted' | 'scriptless' | 'hybrid' | 'private';\r\n\r\n// ğŸ”§ P0-1: èŠå¤©å ´æ™¯é¡å‹\r\nexport type ChatScenario = 'private_chat' | 'group_chat';\r\n\r\n// ğŸ”§ P0-1: åˆ¤æ–·æ˜¯å¦ç‚ºç§èŠæ¨¡å¼ï¼ˆç„¡ç¾¤çµ„ï¼Œ1å°1ï¼‰\r\nexport function isPrivateChatMode(mode: ExecutionMode): boolean {\r\n  return mode === 'private' || mode === 'scriptless' || mode === 'hybrid';\r\n}\r\n\r\n// ğŸ”§ P0-1: ç§èŠæ¨¡å¼ä¸‹åªä½¿ç”¨å–®ä¸€è§’è‰²\r\nexport const PRIVATE_CHAT_MAX_ROLES = 1;\r\n\r\n// å¸³è™ŸåŒ¹é…çµæœ\r\nexport interface AccountRoleMatch {\r\n  accountId: number;\r\n  accountPhone: string;\r\n  accountName: string;\r\n  roleId: string;\r\n  roleName: string;\r\n  roleIcon: string;\r\n  matchScore: number;           // åŒ¹é…åº¦ 0-100\r\n  matchReasons: string[];       // åŒ¹é…åŸå› \r\n  accountFeatures: {\r\n    profileStyle: 'professional' | 'casual' | 'friendly' | 'neutral';\r\n    activityLevel: 'high' | 'medium' | 'low';\r\n    successRate: number;        // æ­·å²æˆåŠŸç‡\r\n    responseRate: number;       // å›è¦†ç‡\r\n  };\r\n}\r\n\r\n// ç„¡åŠ‡æœ¬æ¨¡å¼é…ç½®\r\nexport interface ScriptlessConfig {\r\n  enabled: boolean;\r\n  maxTurns: number;             // æœ€å¤§å°è©±è¼ªæ•¸\r\n  autoAdjustInterval: number;   // è‡ªå‹•èª¿æ•´é–“éš”ï¼ˆæ¶ˆæ¯æ•¸ï¼‰\r\n  targetConversionSignals: string[];  // è½‰åŒ–ä¿¡è™Ÿé—œéµè©\r\n  exitConditions: {\r\n    maxSilenceMinutes: number;\r\n    negativeThreshold: number;\r\n    successSignals: string[];\r\n  };\r\n}\r\n\r\n// ç”¨æˆ¶æ„åœ–é¡å‹\r\nexport type IntentType = \r\n  | 'sales_conversion'      // éŠ·å”®è½‰åŒ–\r\n  | 'churn_recovery'        // æµå¤±æŒ½å›\r\n  | 'community_activation'  // ç¤¾ç¾¤æ´»èº\r\n  | 'customer_support'      // å”®å¾Œæœå‹™\r\n  | 'brand_promotion'       // å“ç‰Œæ¨å»£\r\n  | 'lead_nurturing'        // æ½›å®¢åŸ¹è‚²\r\n  | 'custom';               // è‡ªå®šç¾©\r\n\r\n// æ„åœ–è§£æçµæœ\r\nexport interface IntentAnalysis {\r\n  type: IntentType;\r\n  confidence: number;           // ç½®ä¿¡åº¦ 0-100\r\n  goal: string;                 // ç†è§£å¾Œçš„ç›®æ¨™æè¿°\r\n  targetAudience: string;       // ç›®æ¨™ç¾¤é«”\r\n  productType?: string;         // ç”¢å“é¡å‹\r\n  urgency: 'high' | 'medium' | 'low';  // ç·Šè¿«ç¨‹åº¦\r\n  suggestedDuration: string;    // å»ºè­°é€±æœŸ\r\n}\r\n\r\n// æ¨è–¦çš„è§’è‰²é…ç½®\r\nexport interface RecommendedRole {\r\n  id: string;\r\n  name: string;\r\n  icon: string;\r\n  type: string;\r\n  purpose: string;              // è§’è‰²ç›®çš„\r\n  personality: string;          // æ€§æ ¼ç‰¹é»\r\n  speakingStyle: string;        // èªªè©±é¢¨æ ¼\r\n  entryTiming: string;          // å‡ºå ´æ™‚æ©Ÿ\r\n  sampleMessages: string[];     // ç¤ºä¾‹æ¶ˆæ¯\r\n  accountId?: number;           // ç¶å®šçš„å¸³è™Ÿ ID\r\n}\r\n\r\n// å‹•æ…‹ç­–ç•¥\r\nexport interface DynamicStrategy {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  phases: StrategyPhase[];\r\n  adjustmentRules: AdjustmentRule[];\r\n  constraints: StrategyConstraints;\r\n}\r\n\r\n// ç­–ç•¥éšæ®µ\r\nexport interface StrategyPhase {\r\n  id: string;\r\n  name: string;\r\n  duration: string;             // å¦‚ \"1-2å¤©\"\r\n  goal: string;\r\n  tactics: string[];\r\n  rolesFocus: string[];         // ä¸»è¦æ´»èºçš„è§’è‰²\r\n  successIndicators: string[];  // æˆåŠŸæŒ‡æ¨™\r\n}\r\n\r\n// èª¿æ•´è¦å‰‡\r\nexport interface AdjustmentRule {\r\n  trigger: string;              // è§¸ç™¼æ¢ä»¶æè¿°\r\n  condition: {\r\n    type: 'sentiment' | 'engagement' | 'keyword' | 'silence' | 'interest';\r\n    threshold?: number;\r\n    keywords?: string[];\r\n  };\r\n  action: string;               // åŸ·è¡Œå‹•ä½œ\r\n  newStrategy?: Partial<DynamicStrategy>;\r\n}\r\n\r\n// ç­–ç•¥ç´„æŸ\r\nexport interface StrategyConstraints {\r\n  maxDailyMessages: number;\r\n  maxConsecutiveFromSameRole: number;\r\n  minIntervalSeconds: number;\r\n  maxIntervalSeconds: number;\r\n  activeHours: { start: number; end: number };  // æ´»èºæ™‚é–“\r\n  toneGuidelines: string[];\r\n  forbiddenTopics: string[];\r\n}\r\n\r\n// å¯¦æ™‚åˆ†æçµæœ\r\nexport interface RealtimeAnalysis {\r\n  timestamp: string;\r\n  messageCount: number;         // åˆ†æçš„æ¶ˆæ¯æ•¸é‡\r\n  \r\n  // ç”¨æˆ¶ç•«åƒ\r\n  userProfile: {\r\n    engagementLevel: 'high' | 'medium' | 'low';\r\n    sentiment: 'positive' | 'neutral' | 'negative';\r\n    interests: string[];\r\n    objections: string[];\r\n    readinessScore: number;     // è³¼è²·æº–å‚™åº¦ 0-100\r\n  };\r\n  \r\n  // å°è©±è³ªé‡\r\n  conversationQuality: {\r\n    responseRate: number;\r\n    avgResponseTime: number;\r\n    topicEngagement: Record<string, number>;\r\n  };\r\n  \r\n  // AI å»ºè­°\r\n  suggestions: {\r\n    nextAction: 'continue' | 'escalate' | 'pause' | 'close';\r\n    recommendedRole: string;\r\n    topicSuggestion: string;\r\n    toneAdjustment: string;\r\n    reasoning: string;\r\n  };\r\n}\r\n\r\n// åŸ·è¡Œç‹€æ…‹\r\nexport interface ExecutionState {\r\n  id: string;\r\n  status: 'idle' | 'planning' | 'running' | 'paused' | 'completed';\r\n  goal: string;\r\n  intent: IntentAnalysis | null;\r\n  strategy: DynamicStrategy | null;\r\n  roles: RecommendedRole[];\r\n  \r\n  // ğŸ†• åŸ·è¡Œæ¨¡å¼\r\n  mode: ExecutionMode;\r\n  \r\n  // ğŸ†• å¸³è™Ÿè§’è‰²åŒ¹é…çµæœ\r\n  accountMatches?: AccountRoleMatch[];\r\n  \r\n  // ğŸ†• ç„¡åŠ‡æœ¬æ¨¡å¼é…ç½®\r\n  scriptlessConfig?: ScriptlessConfig;\r\n  \r\n  // ğŸ†• è½‰åŒ–æ¼æ–—è¿½è¹¤\r\n  conversionFunnel?: {\r\n    currentStage: 'contact' | 'response' | 'interest' | 'intent' | 'conversion';\r\n    stageHistory: { stage: string; enteredAt: string; messageCount: number }[];\r\n    keyMoments: { message: string; trigger: string; stage: string; timestamp: string }[];\r\n  };\r\n  \r\n  // åŸ·è¡Œçµ±è¨ˆ\r\n  stats: {\r\n    startTime: string;\r\n    messagesSent: number;\r\n    responsesReceived: number;\r\n    currentPhase: number;\r\n    interestScore: number;\r\n    lastAnalysis?: RealtimeAnalysis | null;\r\n    // ğŸ†• æ–°å¢çµ±è¨ˆ\r\n    analysisCount: number;        // åˆ†ææ¬¡æ•¸\r\n    rolesSwitchCount: number;     // è§’è‰²åˆ‡æ›æ¬¡æ•¸\r\n    autoAdjustments: number;      // è‡ªå‹•èª¿æ•´æ¬¡æ•¸\r\n  };\r\n  \r\n  // æ¶ˆæ¯æ­·å²ï¼ˆç”¨æ–¼åˆ†æï¼‰\r\n  messageHistory?: {\r\n    role: string;\r\n    content: string;\r\n    timestamp: string;\r\n    isFromCustomer: boolean;\r\n  }[];\r\n  \r\n  // ç›®æ¨™ç”¨æˆ¶åˆ—è¡¨ï¼ˆåŒ…å«æ„å‘è©•åˆ†ï¼‰\r\n  targetUsers?: {\r\n    id: number | string;\r\n    username?: string;\r\n    firstName?: string;\r\n    lastName?: string;\r\n    intentScore: number;\r\n    lastContact?: string;\r\n    source?: string;\r\n  }[];\r\n  \r\n  // ğŸ†• ä»»å‹™éšŠåˆ—ç®¡ç†\r\n  queue?: {\r\n    totalUsers: number;           // ç¸½ç›®æ¨™ç”¨æˆ¶æ•¸\r\n    processedUsers: number;       // å·²è™•ç†ç”¨æˆ¶æ•¸\r\n    currentUserIndex: number;     // ç•¶å‰è™•ç†çš„ç”¨æˆ¶ç´¢å¼•\r\n    currentUser?: {               // ç•¶å‰æ­£åœ¨è™•ç†çš„ç”¨æˆ¶\r\n      id: string;\r\n      name: string;\r\n      startTime: string;\r\n    };\r\n    completedUsers: {             // å·²å®Œæˆç”¨æˆ¶åˆ—è¡¨\r\n      id: string;\r\n      name: string;\r\n      result: 'converted' | 'interested' | 'neutral' | 'rejected' | 'no_response';\r\n      messagesExchanged: number;\r\n      duration: number;           // è™•ç†æ™‚é•·ï¼ˆç§’ï¼‰\r\n    }[];\r\n    pendingUsers: string[];       // å¾…è™•ç†ç”¨æˆ¶ ID åˆ—è¡¨\r\n    pausedAt?: string;            // æš«åœæ™‚é–“\r\n  };\r\n  \r\n  // ä¾†è‡ª AI ç‡ŸéŠ·åŠ©æ‰‹çš„ç­–ç•¥æ•¸æ“š\r\n  marketingData?: {\r\n    industry: string;\r\n    targetAudience: string;\r\n    keywords: { highIntent: string[]; mediumIntent: string[]; extended: string[] };\r\n    customerProfile: { identity: string[]; features: string[]; needs: string[] };\r\n    recommendedGroups: string[];\r\n    messageTemplates: { firstTouch: string; followUp: string; closing: string };\r\n  };\r\n  \r\n  // ğŸ”§ ç¾¤èŠå”ä½œï¼šèŠå¤©å ´æ™¯\r\n  chatScenario?: 'private' | 'group';\r\n  \r\n  // ğŸ”§ ç¾¤èŠå”ä½œï¼šç¾¤çµ„é…ç½®\r\n  groupConfig?: {\r\n    groupId?: string;\r\n    groupName?: string;\r\n    roleAccounts?: { accountId: number; accountPhone: string; roleId: string; roleName: string }[];\r\n    chatScenario: 'group';\r\n  };\r\n}\r\n\r\n// è©±é¡Œé¡å‹\r\nexport interface TopicSuggestion {\r\n  type: 'news' | 'weather' | 'life' | 'holiday' | 'product' | 'casual';\r\n  content: string;\r\n  context: string;\r\n  suitableRoles: string[];\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DynamicScriptEngineService {\r\n  private ipc = inject(ElectronIpcService);\r\n  private toast = inject(ToastService);\r\n  private multiRoleService = inject(MultiRoleService);\r\n  private accountService = inject(AccountManagementService);\r\n  \r\n  // ============ ç‹€æ…‹ ============\r\n  \r\n  // ç•¶å‰åŸ·è¡Œç‹€æ…‹\r\n  private _currentExecution = signal<ExecutionState | null>(null);\r\n  currentExecution = computed(() => this._currentExecution());\r\n  \r\n  // æ‰€æœ‰åŸ·è¡Œæ­·å²\r\n  private _executions = signal<ExecutionState[]>([]);\r\n  executions = computed(() => this._executions());\r\n  \r\n  // æ˜¯å¦æ­£åœ¨è™•ç†\r\n  private _isProcessing = signal(false);\r\n  isProcessing = computed(() => this._isProcessing());\r\n  \r\n  // ğŸ†• ç•¶å‰åŸ·è¡Œæ¨¡å¼\r\n  private _executionMode = signal<ExecutionMode>('hybrid');\r\n  executionMode = computed(() => this._executionMode());\r\n  \r\n  // ğŸ†• å¸³è™ŸåŒ¹é…çµæœ\r\n  private _accountMatches = signal<AccountRoleMatch[]>([]);\r\n  accountMatches = computed(() => this._accountMatches());\r\n  \r\n  // ğŸ†• ä»»å‹™éšŠåˆ—ç‹€æ…‹\r\n  queueProgress = computed(() => {\r\n    const exec = this._currentExecution();\r\n    if (!exec?.queue) return null;\r\n    return {\r\n      total: exec.queue.totalUsers,\r\n      processed: exec.queue.processedUsers,\r\n      current: exec.queue.currentUser,\r\n      pending: exec.queue.pendingUsers.length,\r\n      completed: exec.queue.completedUsers,\r\n      progress: exec.queue.totalUsers > 0 \r\n        ? Math.round((exec.queue.processedUsers / exec.queue.totalUsers) * 100)\r\n        : 0\r\n    };\r\n  });\r\n  \r\n  // åˆ†æé–“éš”ï¼ˆæ¯Næ¢æ¶ˆæ¯åˆ†æä¸€æ¬¡ï¼‰\r\n  private analysisInterval = 10;\r\n  \r\n  /**\r\n   * ğŸ”§ Phase 4: å¼·åˆ¶æ›´æ–°åŸ·è¡Œç‹€æ…‹ï¼ˆè§¸ç™¼ UI åˆ·æ–°ï¼‰\r\n   */\r\n  forceUpdateExecution(execution: ExecutionState): void {\r\n    this._currentExecution.set({ ...execution });\r\n    // ğŸ”§ Phase 4: åŒæ™‚æŒä¹…åŒ–åˆ°æ•¸æ“šåº«\r\n    this.persistExecution(execution);\r\n  }\r\n  \r\n  /**\r\n   * ğŸ”§ Phase 4: æŒä¹…åŒ–åŸ·è¡Œç‹€æ…‹åˆ°æ•¸æ“šåº«\r\n   */\r\n  private persistExecution(execution: ExecutionState): void {\r\n    try {\r\n      this.ipc.send('ai-execution:save', {\r\n        id: execution.id,\r\n        executionType: execution.chatScenario || 'private',\r\n        status: execution.status,\r\n        mode: execution.mode,\r\n        goal: execution.goal,\r\n        targetUsers: JSON.stringify(execution.targetUsers || []),\r\n        roleAccounts: JSON.stringify(execution.accountMatches || []),\r\n        groupId: execution.groupConfig?.groupId,\r\n        groupName: execution.groupConfig?.groupId ? `ç¾¤çµ„ ${execution.groupConfig.groupId}` : undefined,\r\n        messageHistory: JSON.stringify(execution.messageHistory || []),\r\n        stats: JSON.stringify(execution.stats || {})\r\n      });\r\n    } catch (error) {\r\n      console.warn('[DynamicEngine] æŒä¹…åŒ–åŸ·è¡Œç‹€æ…‹å¤±æ•—:', error);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ğŸ”§ Phase 4: å¾æ•¸æ“šåº«æ¢å¾©åŸ·è¡Œç‹€æ…‹\r\n   */\r\n  async restoreExecutions(): Promise<void> {\r\n    try {\r\n      console.log('[DynamicEngine] ğŸ”„ å˜—è©¦æ¢å¾©åŸ·è¡Œç‹€æ…‹...');\r\n      const result = await this.ipc.invoke('ai-execution:get-active');\r\n      \r\n      if (result && result.executions && result.executions.length > 0) {\r\n        console.log(`[DynamicEngine] æ‰¾åˆ° ${result.executions.length} å€‹æ´»èºåŸ·è¡Œ`);\r\n        \r\n        for (const saved of result.executions) {\r\n          const execution: ExecutionState = {\r\n            id: saved.id,\r\n            status: saved.status === 'running' ? 'executing' : saved.status,\r\n            goal: saved.goal || '',\r\n            mode: saved.mode || 'hybrid',\r\n            chatScenario: saved.executionType || 'private',\r\n            targetUsers: JSON.parse(saved.targetUsers || '[]'),\r\n            accountMatches: JSON.parse(saved.roleAccounts || '[]'),\r\n            messageHistory: JSON.parse(saved.messageHistory || '[]'),\r\n            stats: JSON.parse(saved.stats || '{}'),\r\n            intent: { \r\n              type: 'sales_conversion', \r\n              confidence: 80, \r\n              goal: saved.goal || '',\r\n              targetAudience: 'æ½›åœ¨å®¢æˆ¶',\r\n              urgency: 'medium' as const,\r\n              suggestedDuration: '1-2é€±'\r\n            },\r\n            strategy: { \r\n              id: 'restored_strategy',\r\n              name: 'æ¢å¾©ç­–ç•¥',\r\n              description: 'å¾æ•¸æ“šåº«æ¢å¾©çš„åŸ·è¡Œç­–ç•¥',\r\n              phases: [], \r\n              adjustmentRules: [],\r\n              constraints: {\r\n                maxDailyMessages: 20,\r\n                maxConsecutiveFromSameRole: 3,\r\n                minIntervalSeconds: 30,\r\n                maxIntervalSeconds: 300,\r\n                activeHours: { start: 8, end: 22 },\r\n                toneGuidelines: ['å‹å¥½', 'å°ˆæ¥­'],\r\n                forbiddenTopics: []\r\n              }\r\n            },\r\n            roles: [],\r\n            groupConfig: saved.groupId ? { groupId: saved.groupId, chatScenario: 'group' } : undefined\r\n          };\r\n          \r\n          this._currentExecution.set(execution);\r\n          this._executions.update(list => [execution, ...list.filter(e => e.id !== execution.id)]);\r\n          console.log(`[DynamicEngine] âœ… å·²æ¢å¾©åŸ·è¡Œ: ${execution.id}`);\r\n        }\r\n        \r\n        this.toast.info(`ğŸ”„ å·²æ¢å¾© ${result.executions.length} å€‹é€²è¡Œä¸­çš„ä»»å‹™`);\r\n      } else {\r\n        console.log('[DynamicEngine] æ²’æœ‰éœ€è¦æ¢å¾©çš„åŸ·è¡Œ');\r\n      }\r\n    } catch (error) {\r\n      console.warn('[DynamicEngine] æ¢å¾©åŸ·è¡Œç‹€æ…‹å¤±æ•—:', error);\r\n    }\r\n  }\r\n  \r\n  // ğŸ†• ç„¡åŠ‡æœ¬æ¨¡å¼é»˜èªé…ç½®\r\n  private defaultScriptlessConfig: ScriptlessConfig = {\r\n    enabled: false,\r\n    maxTurns: 50,\r\n    autoAdjustInterval: 10,\r\n    targetConversionSignals: ['æ€éº¼è²·', 'åœ¨å“ªè²·', 'å¤šå°‘éŒ¢', 'æƒ³è²·', 'ä¸‹å–®', 'ä»˜æ¬¾'],\r\n    exitConditions: {\r\n      maxSilenceMinutes: 60,\r\n      negativeThreshold: 30,\r\n      successSignals: ['è²·äº†', 'å·²ä»˜æ¬¾', 'æˆäº¤', 'è¬è¬', 'æ”¶åˆ°']\r\n    }\r\n  };\r\n  \r\n  constructor() {\r\n    this.setupMessageAnalysisListener();\r\n  }\r\n  \r\n  // ============ ğŸ†• æ¶ˆæ¯åˆ†æç›£è½ ============\r\n  \r\n  /**\r\n   * è¨­ç½®æ¶ˆæ¯åˆ†æç›£è¯ï¼ˆæ¯ N æ¢æ¶ˆæ¯è‡ªå‹•åˆ†æï¼‰\r\n   */\r\n  private setupMessageAnalysisListener(): void {\r\n    // ç›£è½ä¾†è‡ªå”ä½œç¾¤çµ„çš„æ–°æ¶ˆæ¯\r\n    this.ipc.on('collab:new-message', async (data: any) => {\r\n      const execution = this._currentExecution();\r\n      if (!execution || execution.status !== 'running') return;\r\n      \r\n      // æ·»åŠ åˆ°æ¶ˆæ¯æ­·å²\r\n      const newMessage = {\r\n        role: data.role || 'customer',\r\n        content: data.content,\r\n        timestamp: new Date().toISOString(),\r\n        isFromCustomer: data.isFromCustomer ?? true\r\n      };\r\n      \r\n      execution.messageHistory = [...(execution.messageHistory || []), newMessage];\r\n      this._currentExecution.set({ ...execution });\r\n      \r\n      // æª¢æŸ¥æ˜¯å¦é”åˆ°åˆ†æé–“éš”\r\n      const messageCount = execution.messageHistory?.length || 0;\r\n      if (messageCount > 0 && messageCount % this.analysisInterval === 0) {\r\n        console.log(`[DynamicEngine] è§¸ç™¼ç¬¬ ${execution.stats.analysisCount + 1} æ¬¡åˆ†æ (${messageCount} æ¢æ¶ˆæ¯)`);\r\n        await this.performDynamicAnalysis(execution);\r\n      }\r\n      \r\n      // ç„¡åŠ‡æœ¬æ¨¡å¼ï¼šæª¢æŸ¥è½‰åŒ–ä¿¡è™Ÿ\r\n      if (execution.mode === 'scriptless' && data.isFromCustomer) {\r\n        await this.checkConversionSignals(execution, data.content);\r\n      }\r\n    });\r\n    \r\n    // ç›£è¯å®¢æˆ¶å›è¦†\r\n    this.ipc.on('collab:customer-reply', async (data: any) => {\r\n      const execution = this._currentExecution();\r\n      if (!execution) return;\r\n      \r\n      // æ›´æ–°å›è¦†çµ±è¨ˆ\r\n      execution.stats.responsesReceived++;\r\n      this._currentExecution.set({ ...execution });\r\n      \r\n      // æ›´æ–°è½‰åŒ–æ¼æ–—\r\n      if (execution.conversionFunnel?.currentStage === 'contact') {\r\n        this.updateConversionStage(execution, 'response', data.content);\r\n      }\r\n    });\r\n  }\r\n  \r\n  // ============ æ„åœ–é è¨­åº« ============\r\n  \r\n  private intentTemplates: Record<IntentType, {\r\n    keywords: string[];\r\n    description: string;\r\n    defaultRoles: RecommendedRole[];\r\n    defaultPhases: StrategyPhase[];\r\n  }> = {\r\n    sales_conversion: {\r\n      // ğŸ”§ æ“´å±•é—œéµè©ï¼šå¢åŠ æ›´å¤šç‡ŸéŠ·ç›¸é—œè©å½™\r\n      keywords: ['æˆäº¤', 'è³¼è²·', 'ä¸‹å–®', 'ä»˜è²»', 'è½‰åŒ–', 'è²·', 'è¨‚å–®', 'ä»˜æ¬¾', \r\n                 'ç‡ŸéŠ·', 'éŠ·å”®', 'æ¨å»£', 'æ”¯ä»˜', 'ä»£æ”¶', 'ä»£ä»˜', 'ç”¢å“', 'æœå‹™',\r\n                 'å®¢æˆ¶', 'ç”¨æˆ¶', 'èˆˆè¶£', 'åˆä½œ', 'æ¥­å‹™', 'é–‹ç™¼', 'æ‹“å±•', 'ç°½ç´„'],\r\n      description: 'ä¿ƒé€²æ½›åœ¨å®¢æˆ¶å®Œæˆè³¼è²·',\r\n      defaultRoles: [\r\n        {\r\n          id: 'friendly_member',\r\n          name: 'ç†±å¿ƒç¾¤å‹',\r\n          icon: 'ğŸ˜„',\r\n          type: 'atmosphere',\r\n          purpose: 'æ´»èºæ°£æ°›ï¼Œè‡ªç„¶å¼•å…¥è©±é¡Œ',\r\n          personality: 'ç†±æƒ…é–‹æœ—ï¼Œæ„›åˆ†äº«ï¼Œå¥½å¥‡å¿ƒå¼·',\r\n          speakingStyle: 'å£èªåŒ–ï¼Œå¸¶è¡¨æƒ…ç¬¦è™Ÿï¼Œåƒæœ‹å‹èŠå¤©',\r\n          entryTiming: 'é–‹å ´å’Œæ°£æ°›å†·å ´æ™‚',\r\n          sampleMessages: [\r\n            'å¤§å®¶æ—©å®‰ï¼ä»Šå¤©å¤©æ°£çœŸå¥½ï½',\r\n            'å“ˆå“ˆé€™å€‹æœ‰æ„æ€ï¼Œæˆ‘ä¹Ÿé‡åˆ°é',\r\n            'å°äº†ï¼Œæœ€è¿‘æœ‰äººç”¨éXXå—ï¼Ÿæƒ³è½è½æ„è¦‹'\r\n          ]\r\n        },\r\n        {\r\n          id: 'loyal_customer',\r\n          name: 'è€ç”¨æˆ¶',\r\n          icon: 'â¤ï¸',\r\n          type: 'endorsement',\r\n          purpose: 'åˆ†äº«çœŸå¯¦ä½¿ç”¨é«”é©—ï¼Œå»ºç«‹ä¿¡ä»»',\r\n          personality: 'çœŸèª å¯é ï¼Œæ¨‚æ–¼åŠ©äºº',\r\n          speakingStyle: 'å¹³å¯¦è‡ªç„¶ï¼Œåˆ†äº«å€‹äººç¶“æ­·',\r\n          entryTiming: 'è©±é¡Œè½‰åˆ°ç”¢å“ç›¸é—œæ™‚',\r\n          sampleMessages: [\r\n            'æˆ‘ç”¨äº†å¤§æ¦‚ä¸‰å€‹æœˆå§ï¼Œæ„Ÿè¦ºé‚„ä¸éŒ¯',\r\n            'ä¸€é–‹å§‹ä¹Ÿæ˜¯æœ‹å‹æ¨è–¦çš„ï¼Œæ²’æƒ³åˆ°çœŸçš„å¥½ç”¨',\r\n            'èªªå¯¦è©±å‰›é–‹å§‹ä¹Ÿæœ‰é»çŒ¶è±«ï¼Œå¾Œä¾†è¦ºå¾—å€¼å¾—'\r\n          ]\r\n        },\r\n        {\r\n          id: 'sales_expert',\r\n          name: 'é¡§å•å°ˆå®¶',\r\n          icon: 'ğŸ’¼',\r\n          type: 'professional',\r\n          purpose: 'å°ˆæ¥­è§£ç­”ï¼Œä¿ƒæˆæˆäº¤',\r\n          personality: 'å°ˆæ¥­å¯é ï¼Œè€å¿ƒç´°ç·»',\r\n          speakingStyle: 'å°ˆæ¥­ä½†ä¸ç”Ÿç¡¬ï¼Œæœ‰è¦ªå’ŒåŠ›',\r\n          entryTiming: 'å®¢æˆ¶è¡¨ç¾å‡ºæ˜ç¢ºèˆˆè¶£æ™‚',\r\n          sampleMessages: [\r\n            'é€™å€‹å•é¡Œå•å¾—å¥½ï¼Œæˆ‘ä¾†è©³ç´°èªªæ˜ä¸€ä¸‹',\r\n            'æ ¹æ“šæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘å»ºè­°...',\r\n            'ç¾åœ¨æ­£å¥½æœ‰æ´»å‹•ï¼Œå¯ä»¥äº†è§£ä¸€ä¸‹'\r\n          ]\r\n        }\r\n      ],\r\n      defaultPhases: [\r\n        {\r\n          id: 'phase_1',\r\n          name: 'æ°›åœç‡Ÿé€ ',\r\n          duration: '1-2å¤©',\r\n          goal: 'å»ºç«‹å­˜åœ¨æ„Ÿï¼Œæ´»èºç¾¤æ°£æ°›',\r\n          tactics: ['æ—¥å¸¸å•å€™', 'åˆ†äº«è¶£äº‹', 'åƒèˆ‡è¨è«–'],\r\n          rolesFocus: ['friendly_member'],\r\n          successIndicators: ['ç¾¤æ´»èºåº¦æå‡', 'æœ‰äººå›è¦†äº’å‹•']\r\n        },\r\n        {\r\n          id: 'phase_2',\r\n          name: 'è©±é¡Œå¼•å…¥',\r\n          duration: '1-2å¤©',\r\n          goal: 'è‡ªç„¶å¼•å…¥ç”¢å“ç›¸é—œè©±é¡Œ',\r\n          tactics: ['å ´æ™¯åˆ†äº«', 'ç—›é»è¨è«–', 'ç¶“é©—äº¤æµ'],\r\n          rolesFocus: ['friendly_member', 'loyal_customer'],\r\n          successIndicators: ['ç›®æ¨™å®¢æˆ¶åƒèˆ‡è¨è«–', 'æåŠç”¢å“ç›¸é—œéœ€æ±‚']\r\n        },\r\n        {\r\n          id: 'phase_3',\r\n          name: 'åƒ¹å€¼å±•ç¤º',\r\n          duration: '1-2å¤©',\r\n          goal: 'å±•ç¤ºç”¢å“åƒ¹å€¼ï¼Œå»ºç«‹ä¿¡ä»»',\r\n          tactics: ['ä½¿ç”¨é«”é©—åˆ†äº«', 'æ•ˆæœè¦‹è­‰', 'å°ˆæ¥­è§£ç­”'],\r\n          rolesFocus: ['loyal_customer', 'sales_expert'],\r\n          successIndicators: ['å®¢æˆ¶è©¢å•è©³æƒ…', 'èˆˆè¶£åº¦ä¸Šå‡']\r\n        },\r\n        {\r\n          id: 'phase_4',\r\n          name: 'ä¿ƒæˆæˆäº¤',\r\n          duration: 'éˆæ´»',\r\n          goal: 'æŠŠæ¡æ™‚æ©Ÿï¼Œä¿ƒæˆè³¼è²·',\r\n          tactics: ['å„ªæƒ å‘ŠçŸ¥', 'é™æ™‚åˆºæ¿€', 'ç•°è­°è™•ç†'],\r\n          rolesFocus: ['sales_expert'],\r\n          successIndicators: ['å®¢æˆ¶è©¢åƒ¹', 'é”æˆè³¼è²·']\r\n        }\r\n      ]\r\n    },\r\n    churn_recovery: {\r\n      keywords: ['æµå¤±', 'æŒ½å›', 'å›ä¾†', 'å†æ¬¡', 'é‡æ–°', 'è€å®¢æˆ¶', 'çºŒè²»'],\r\n      description: 'æŒ½å›æµå¤±æˆ–æ²‰é»˜çš„è€å®¢æˆ¶',\r\n      defaultRoles: [\r\n        {\r\n          id: 'callback_agent',\r\n          name: 'å›è¨ªå°ˆå“¡',\r\n          icon: 'ğŸ“',\r\n          type: 'care',\r\n          purpose: 'çœŸèª é—œæ‡·ï¼Œäº†è§£é›¢é–‹åŸå› ',\r\n          personality: 'æº«æš–çœŸèª ï¼Œå–„æ–¼å‚¾è½',\r\n          speakingStyle: 'è¦ªåˆ‡é—œæ‡·ï¼Œä¸æ€¥èº',\r\n          entryTiming: 'é–‹å ´',\r\n          sampleMessages: [\r\n            'å¥½ä¹…æ²’è¯ç¹«äº†ï¼Œæœ€è¿‘æ€éº¼æ¨£ï¼Ÿ',\r\n            'æƒ³èµ·æ‚¨äº†ï¼Œç‰¹æ„ä¾†å•å€™ä¸€ä¸‹',\r\n            'ä¹‹å‰ç”¨è‘—é‚„é †åˆ©å—ï¼Ÿæœ‰ä»€éº¼å¯ä»¥å¹«å¿™çš„ï¼Ÿ'\r\n          ]\r\n        },\r\n        {\r\n          id: 'customer_success',\r\n          name: 'å®¢æˆ¶æˆåŠŸ',\r\n          icon: 'ğŸ¯',\r\n          type: 'solution',\r\n          purpose: 'è§£æ±ºå•é¡Œï¼Œå±•ç¤ºæ”¹é€²',\r\n          personality: 'å°ˆæ¥­è² è²¬ï¼Œç©æ¥µä¸»å‹•',\r\n          speakingStyle: 'å•é¡Œå°å‘ï¼Œæä¾›æ–¹æ¡ˆ',\r\n          entryTiming: 'å®¢æˆ¶èªªå‡ºé›¢é–‹åŸå› å¾Œ',\r\n          sampleMessages: [\r\n            'æ„Ÿè¬æ‚¨çš„åé¥‹ï¼Œé€™å€‹å•é¡Œæˆ‘å€‘å·²ç¶“å„ªåŒ–äº†',\r\n            'é‡å°é€™å€‹æƒ…æ³ï¼Œæˆ‘å€‘ç¾åœ¨æœ‰æ–°çš„è§£æ±ºæ–¹æ¡ˆ',\r\n            'ä¾†ï¼Œæˆ‘å¹«æ‚¨çœ‹çœ‹ç¾åœ¨æ€éº¼è™•ç†æœ€å¥½'\r\n          ]\r\n        },\r\n        {\r\n          id: 'vip_manager',\r\n          name: 'VIPç¶“ç†',\r\n          icon: 'ğŸ‘‘',\r\n          type: 'retention',\r\n          purpose: 'é«˜å±¤å‡ºé¢ï¼Œèª æ„æŒ½ç•™',\r\n          personality: 'æœ‰æ¬Šå¨ä½†è¦ªå’Œï¼Œèª æ„åè¶³',\r\n          speakingStyle: 'æ­£å¼ä½†ä¸ç”Ÿç¡¬ï¼Œå±•ç¾èª æ„',\r\n          entryTiming: 'éœ€è¦ç‰¹åˆ¥å„ªæƒ æˆ–æ±ºç­–æ™‚',\r\n          sampleMessages: [\r\n            'æˆ‘æ˜¯VIPç¶“ç†ï¼Œç‰¹æ„ä¾†è·Ÿæ‚¨èŠèŠ',\r\n            'æ‚¨æ˜¯æˆ‘å€‘çš„é‡è¦å®¢æˆ¶ï¼Œé€™å€‹å„ªæƒ æ˜¯å°ˆé–€ç‚ºæ‚¨ç”³è«‹çš„',\r\n            'æœ‰ä»€éº¼é¡§æ…®éƒ½å¯ä»¥èªªï¼Œæˆ‘å€‘ä¸€å®šç›¡åŠ›è§£æ±º'\r\n          ]\r\n        }\r\n      ],\r\n      defaultPhases: [\r\n        { id: 'phase_1', name: 'é—œæ‡·å›è¨ª', duration: '1å¤©', goal: 'çœŸèª å•å€™ï¼Œäº†è§£è¿‘æ³', tactics: ['å•å€™', 'é—œå¿ƒ', 'å‚¾è½'], rolesFocus: ['callback_agent'], successIndicators: ['å®¢æˆ¶å›è¦†', 'èªªå‡ºé›¢é–‹åŸå› '] },\r\n        { id: 'phase_2', name: 'å•é¡Œè§£æ±º', duration: '1-2å¤©', goal: 'é‡å°å•é¡Œæä¾›æ–¹æ¡ˆ', tactics: ['å•é¡Œç¢ºèª', 'æ–¹æ¡ˆæä¾›', 'æ”¹é€²èªªæ˜'], rolesFocus: ['customer_success'], successIndicators: ['å®¢æˆ¶èªå¯æ”¹é€²', 'é¡˜æ„å†è©¦'] },\r\n        { id: 'phase_3', name: 'èª æ„æŒ½ç•™', duration: 'éˆæ´»', goal: 'æä¾›å„ªæƒ ï¼Œä¿ƒæˆå›æ­¸', tactics: ['å°ˆå±¬å„ªæƒ ', 'VIPå¾…é‡', 'æ‰¿è«¾ä¿éšœ'], rolesFocus: ['vip_manager'], successIndicators: ['å®¢æˆ¶åŒæ„å›æ­¸', 'çºŒè²»æˆåŠŸ'] }\r\n      ]\r\n    },\r\n    community_activation: {\r\n      keywords: ['æ´»èº', 'ç¤¾ç¾¤', 'æ°£æ°›', 'äº’å‹•', 'è¨è«–', 'å†·æ¸…', 'å¸¶å‹•'],\r\n      description: 'æå‡ç¤¾ç¾¤æ´»èºåº¦å’Œç”¨æˆ¶ç²˜æ€§',\r\n      defaultRoles: [\r\n        {\r\n          id: 'community_host',\r\n          name: 'ç¤¾ç¾¤ç®¡å®¶',\r\n          icon: 'ğŸ ',\r\n          type: 'host',\r\n          purpose: 'ç™¼èµ·è©±é¡Œï¼Œç¶­è­·ç§©åº',\r\n          personality: 'ç†±æƒ…è² è²¬ï¼Œæœ‰çµ„ç¹”èƒ½åŠ›',\r\n          speakingStyle: 'è¦ªåˆ‡æœ‰åºï¼Œå¼•å°è¨è«–',\r\n          entryTiming: 'é–‹å ´å’Œè©±é¡Œè½‰æ›æ™‚',\r\n          sampleMessages: [\r\n            'æ—©å®‰å„ä½ï¼æ–°çš„ä¸€å¤©é–‹å§‹äº†ï½',\r\n            'ä»Šå¤©ä¾†èŠèŠXXXï¼Œå¤§å®¶æ€éº¼çœ‹ï¼Ÿ',\r\n            'æ„Ÿè¬åˆ†äº«ï¼é‚„æœ‰å…¶ä»–æƒ³æ³•å—ï¼Ÿ'\r\n          ]\r\n        },\r\n        {\r\n          id: 'active_member_1',\r\n          name: 'æ´»èºç¾¤å‹A',\r\n          icon: 'ğŸ¤—',\r\n          type: 'participant',\r\n          purpose: 'ç©æ¥µäº’å‹•ï¼Œå¸¶å‹•æ°£æ°›',\r\n          personality: 'å¤–å‘æ´»æ½‘ï¼Œæ„›åˆ†äº«',\r\n          speakingStyle: 'è¼•é¬†éš¨æ„ï¼Œå¤šç”¨è¡¨æƒ…',\r\n          entryTiming: 'è©±é¡Œç™¼èµ·å¾Œç©æ¥µéŸ¿æ‡‰',\r\n          sampleMessages: [\r\n            'é€™å€‹è©±é¡Œæˆ‘æœ‰è©±èªªï¼',\r\n            'å“ˆå“ˆç¢ºå¯¦æ˜¯é€™æ¨£',\r\n            'æˆ‘ä¹Ÿæœ‰é¡ä¼¼çš„ç¶“æ­·ï½'\r\n          ]\r\n        },\r\n        {\r\n          id: 'active_member_2',\r\n          name: 'æ´»èºç¾¤å‹B',\r\n          icon: 'ğŸ˜',\r\n          type: 'participant',\r\n          purpose: 'è£œå……è§€é»ï¼Œå»¶çºŒè¨è«–',\r\n          personality: 'å¹½é»˜é¢¨è¶£ï¼Œè¦‹è§£ç¨åˆ°',\r\n          speakingStyle: 'æœ‰è¶£æœ‰æ–™ï¼Œå¶çˆ¾æŠ–æ©Ÿéˆ',\r\n          entryTiming: 'è¨è«–é€²è¡Œä¸­è£œå……',\r\n          sampleMessages: [\r\n            'æ¨“ä¸Šèªªå¾—å°ï¼Œæˆ‘è£œå……ä¸€é»',\r\n            'æ›å€‹è§’åº¦æƒ³æƒ³...',\r\n            'é€™è®“æˆ‘æƒ³èµ·ä¸€å€‹æœ‰æ„æ€çš„äº‹'\r\n          ]\r\n        },\r\n        {\r\n          id: 'opinion_leader',\r\n          name: 'æ„è¦‹é ˜è¢–',\r\n          icon: 'ğŸ¤',\r\n          type: 'expert',\r\n          purpose: 'è¼¸å‡ºåƒ¹å€¼ï¼Œç¸½çµè§€é»',\r\n          personality: 'å°ˆæ¥­æ¬Šå¨ï¼Œæœ‰æ·±åº¦',\r\n          speakingStyle: 'æœ‰è¦‹åœ°ï¼Œèƒ½ç¸½çµæå‡',\r\n          entryTiming: 'è¨è«–éœ€è¦ç¸½çµæˆ–å‡è¯æ™‚',\r\n          sampleMessages: [\r\n            'çœ‹äº†å¤§å®¶çš„è¨è«–ï¼Œæˆ‘ä¾†ç¸½çµä¸€ä¸‹',\r\n            'é€™å€‹å•é¡Œçš„é—œéµåœ¨æ–¼...',\r\n            'åˆ†äº«ä¸€å€‹æˆ‘çš„æ€è€ƒæ¡†æ¶'\r\n          ]\r\n        }\r\n      ],\r\n      defaultPhases: [\r\n        { id: 'phase_1', name: 'è©±é¡Œç™¼èµ·', duration: 'æŒçºŒ', goal: 'ç™¼èµ·æœ‰åƒ¹å€¼çš„è¨è«–è©±é¡Œ', tactics: ['ç†±é»è©±é¡Œ', 'ç¶“é©—åˆ†äº«', 'å•é¡Œè¨è«–'], rolesFocus: ['community_host'], successIndicators: ['æœ‰äººåƒèˆ‡è¨è«–'] },\r\n        { id: 'phase_2', name: 'äº’å‹•éŸ¿æ‡‰', duration: 'æŒçºŒ', goal: 'å¸¶å‹•è¨è«–æ°›åœ', tactics: ['ç©æ¥µå›è¦†', 'è£œå……è§€é»', 'è¡¨é”èªåŒ'], rolesFocus: ['active_member_1', 'active_member_2'], successIndicators: ['å¤šäººåƒèˆ‡', 'è¨è«–æ·±å…¥'] },\r\n        { id: 'phase_3', name: 'åƒ¹å€¼è¼¸å‡º', duration: 'é©æ™‚', goal: 'ç¸½çµè¨è«–åƒ¹å€¼', tactics: ['è§€é»ç¸½çµ', 'ç¶“é©—æç…‰', 'çŸ¥è­˜åˆ†äº«'], rolesFocus: ['opinion_leader'], successIndicators: ['ç²å¾—èªå¯', 'è¢«æ”¶è—è½‰ç™¼'] }\r\n      ]\r\n    },\r\n    customer_support: {\r\n      keywords: ['å”®å¾Œ', 'å•é¡Œ', 'æŠ•è¨´', 'æ•…éšœ', 'ä¸æ»¿', 'è§£æ±º', 'è™•ç†', 'é€€'],\r\n      description: 'é«˜æ•ˆè™•ç†å®¢æˆ¶å”®å¾Œå•é¡Œ',\r\n      defaultRoles: [\r\n        {\r\n          id: 'cs_agent',\r\n          name: 'å®¢æœå°ˆå“¡',\r\n          icon: 'ğŸ§',\r\n          type: 'frontline',\r\n          purpose: 'å¿«é€ŸéŸ¿æ‡‰ï¼Œè¨˜éŒ„å•é¡Œ',\r\n          personality: 'è€å¿ƒç´°ç·»ï¼Œæ…‹åº¦å¥½',\r\n          speakingStyle: 'ç¦®è²Œå°ˆæ¥­ï¼Œè¡¨é”æ­‰æ„',\r\n          entryTiming: 'å•é¡Œå‡ºç¾æ™‚ç«‹å³éŸ¿æ‡‰',\r\n          sampleMessages: [\r\n            'æ‚¨å¥½ï¼Œéå¸¸æŠ±æ­‰çµ¦æ‚¨å¸¶ä¾†ä¸ä¾¿ï¼',\r\n            'è«‹å•å…·é«”æ˜¯ä»€éº¼å•é¡Œå‘¢ï¼Ÿæˆ‘ä¾†å¹«æ‚¨è™•ç†',\r\n            'æˆ‘å·²ç¶“è¨˜éŒ„ä¸‹ä¾†äº†ï¼Œé¦¬ä¸Šç‚ºæ‚¨è·Ÿé€²'\r\n          ]\r\n        },\r\n        {\r\n          id: 'tech_support',\r\n          name: 'æŠ€è¡“æ”¯æŒ',\r\n          icon: 'ğŸ”§',\r\n          type: 'technical',\r\n          purpose: 'æŠ€è¡“æ’æŸ¥ï¼Œè§£æ±ºå•é¡Œ',\r\n          personality: 'å°ˆæ¥­åš´è¬¹ï¼Œé‚è¼¯æ¸…æ™°',\r\n          speakingStyle: 'æŠ€è¡“å°ˆæ¥­ä½†æ˜“æ‡‚',\r\n          entryTiming: 'éœ€è¦æŠ€è¡“è§£ç­”æ™‚',\r\n          sampleMessages: [\r\n            'æ ¹æ“šæ‚¨æè¿°çš„æƒ…æ³ï¼Œè«‹æ‚¨å˜—è©¦ä»¥ä¸‹æ­¥é©Ÿ',\r\n            'é€™å€‹å•é¡Œæˆ‘ä¾†çœ‹ä¸€ä¸‹ï¼Œç¨ç­‰',\r\n            'æ‰¾åˆ°åŸå› äº†ï¼Œæ˜¯å› ç‚ºXXXï¼Œè§£æ±ºæ–¹æ¡ˆæ˜¯...'\r\n          ]\r\n        },\r\n        {\r\n          id: 'satisfaction_manager',\r\n          name: 'æ»¿æ„åº¦ç¶“ç†',\r\n          icon: 'ğŸ˜Š',\r\n          type: 'recovery',\r\n          purpose: 'ç¢ºèªæ»¿æ„ï¼Œè£œå„ŸæŒ½å›',\r\n          personality: 'æº«æš–çœŸèª ï¼Œæœ‰èª æ„',\r\n          speakingStyle: 'çœŸèª é“æ­‰ï¼Œç©æ¥µè£œå„Ÿ',\r\n          entryTiming: 'å•é¡Œè§£æ±ºå¾Œ',\r\n          sampleMessages: [\r\n            'å•é¡Œè§£æ±ºäº†å—ï¼Ÿçµ¦æ‚¨é€ æˆä¸ä¾¿çœŸçš„å¾ˆæŠ±æ­‰',\r\n            'ç‚ºè¡¨æ­‰æ„ï¼Œæˆ‘å€‘ç‚ºæ‚¨ç”³è«‹äº†ä¸€ä»½å°ç¦®ç‰©',\r\n            'ä»¥å¾Œæœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥éš¨æ™‚æ‰¾æˆ‘'\r\n          ]\r\n        }\r\n      ],\r\n      defaultPhases: [\r\n        { id: 'phase_1', name: 'å¿«é€ŸéŸ¿æ‡‰', duration: 'ç«‹å³', goal: 'ç¬¬ä¸€æ™‚é–“éŸ¿æ‡‰ï¼Œå®‰æ’«æƒ…ç·’', tactics: ['è¡¨é”æ­‰æ„', 'ç¢ºèªå•é¡Œ', 'è¡¨ç¤ºé‡è¦–'], rolesFocus: ['cs_agent'], successIndicators: ['å®¢æˆ¶æƒ…ç·’ç·©å’Œ'] },\r\n        { id: 'phase_2', name: 'å•é¡Œè§£æ±º', duration: 'ç›¡å¿«', goal: 'æ’æŸ¥ä¸¦è§£æ±ºå•é¡Œ', tactics: ['æŠ€è¡“æ’æŸ¥', 'æä¾›æ–¹æ¡ˆ', 'ç¢ºèªè§£æ±º'], rolesFocus: ['tech_support'], successIndicators: ['å•é¡Œè§£æ±º'] },\r\n        { id: 'phase_3', name: 'æ»¿æ„ç¢ºèª', duration: 'å•é¡Œè§£æ±ºå¾Œ', goal: 'ç¢ºèªæ»¿æ„ï¼Œé©ç•¶è£œå„Ÿ', tactics: ['ç¢ºèªæ»¿æ„', 'è£œå„ŸæŒ½å›', 'å»ºç«‹å¥½æ„Ÿ'], rolesFocus: ['satisfaction_manager'], successIndicators: ['å®¢æˆ¶æ»¿æ„', 'å¥½è©•åé¥‹'] }\r\n      ]\r\n    },\r\n    brand_promotion: {\r\n      keywords: ['æ¨å»£', 'å“ç‰Œ', 'å®£å‚³', 'çŸ¥ååº¦', 'æ›å…‰', 'å‚³æ’­'],\r\n      description: 'æå‡å“ç‰ŒçŸ¥ååº¦å’Œå¥½æ„Ÿåº¦',\r\n      defaultRoles: [\r\n        {\r\n          id: 'brand_ambassador',\r\n          name: 'å“ç‰Œå¤§ä½¿',\r\n          icon: 'ğŸ†',\r\n          type: 'promotion',\r\n          purpose: 'å‚³æ’­å“ç‰Œåƒ¹å€¼',\r\n          personality: 'å°ˆæ¥­è‡ªä¿¡ï¼Œæœ‰æ„ŸæŸ“åŠ›',\r\n          speakingStyle: 'ç©æ¥µæ­£é¢ï¼Œæœ‰è™Ÿå¬åŠ›',\r\n          entryTiming: 'å“ç‰Œç›¸é—œè©±é¡Œ',\r\n          sampleMessages: ['é€™å€‹å“ç‰Œæˆ‘ä¸€ç›´é—œæ³¨ï¼Œç†å¿µå¾ˆå¥½', 'ä»–å€‘å®¶çš„å“è³ªç¢ºå¯¦æ²’è©±èªª']\r\n        }\r\n      ],\r\n      defaultPhases: [\r\n        { id: 'phase_1', name: 'å“ç‰Œæ›å…‰', duration: 'æŒçºŒ', goal: 'è‡ªç„¶å‚³æ’­å“ç‰Œ', tactics: ['åƒ¹å€¼åˆ†äº«', 'æ•…äº‹è¬›è¿°'], rolesFocus: ['brand_ambassador'], successIndicators: ['è¢«è¨è«–', 'å¥½è©•'] }\r\n      ]\r\n    },\r\n    lead_nurturing: {\r\n      keywords: ['åŸ¹è‚²', 'æ½›å®¢', 'è·Ÿé€²', 'é ç†±', 'æ•™è‚²'],\r\n      description: 'åŸ¹è‚²æ½›åœ¨å®¢æˆ¶ï¼Œæå‡è³¼è²·æ„é¡˜',\r\n      defaultRoles: [\r\n        {\r\n          id: 'content_sharer',\r\n          name: 'å…§å®¹é”äºº',\r\n          icon: 'ğŸ“š',\r\n          type: 'education',\r\n          purpose: 'åˆ†äº«æœ‰åƒ¹å€¼å…§å®¹',\r\n          personality: 'çŸ¥è­˜è±å¯Œï¼Œæ¨‚æ–¼åˆ†äº«',\r\n          speakingStyle: 'æœ‰æ–™æœ‰è¶£ï¼Œä¸èªªæ•™',\r\n          entryTiming: 'æŒçºŒ',\r\n          sampleMessages: ['åˆ†äº«ä¸€å€‹å¾ˆæœ‰ç”¨çš„æ–¹æ³•', 'é€™ç¯‡æ–‡ç« å¯«å¾—å¤ªå¥½äº†']\r\n        }\r\n      ],\r\n      defaultPhases: [\r\n        { id: 'phase_1', name: 'åƒ¹å€¼è¼¸å‡º', duration: 'æŒçºŒ', goal: 'é€šéå…§å®¹å»ºç«‹ä¿¡ä»»', tactics: ['çŸ¥è­˜åˆ†äº«', 'æ¡ˆä¾‹åˆ†æ'], rolesFocus: ['content_sharer'], successIndicators: ['è¢«é—œæ³¨', 'ä¸»å‹•è©¢å•'] }\r\n      ]\r\n    },\r\n    custom: {\r\n      keywords: [],\r\n      description: 'è‡ªå®šç¾©ç›®æ¨™',\r\n      // ğŸ”§ ä¿®å¾©: custom é¡å‹ä½¿ç”¨é€šç”¨éŠ·å”®è§’è‰²ä½œç‚ºé»˜èªå€¼ï¼Œé¿å…ç©ºè§’è‰²å•é¡Œ\r\n      defaultRoles: [\r\n        {\r\n          id: 'account_manager',\r\n          name: 'å®¢æˆ¶ç¶“ç†',\r\n          icon: 'ğŸ’¼',\r\n          type: 'account_manager',\r\n          purpose: 'äº†è§£éœ€æ±‚ï¼Œå»ºç«‹é—œä¿‚',\r\n          personality: 'å°ˆæ¥­å‹å¥½ï¼Œå–„æ–¼å‚¾è½',\r\n          speakingStyle: 'å°ˆæ¥­ä½†ä¸ç”Ÿç¡¬ï¼Œåƒæœ‹å‹èˆ¬äº¤æµ',\r\n          entryTiming: 'é¦–æ¬¡æ¥è§¸å’Œé‡è¦ç¯€é»',\r\n          sampleMessages: [\r\n            'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å°ˆå±¬å®¢æˆ¶ç¶“ç†',\r\n            'è«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«åˆ°æ‚¨çš„å—ï¼Ÿ',\r\n            'æœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥éš¨æ™‚å•æˆ‘'\r\n          ]\r\n        },\r\n        {\r\n          id: 'solution_expert',\r\n          name: 'æ–¹æ¡ˆå°ˆå®¶',\r\n          icon: 'ğŸ“‹',\r\n          type: 'professional',\r\n          purpose: 'æä¾›å°ˆæ¥­æ–¹æ¡ˆå’Œå»ºè­°',\r\n          personality: 'å°ˆæ¥­æ¬Šå¨ï¼Œæœ‰æ·±åº¦',\r\n          speakingStyle: 'æ¸…æ™°ç°¡æ½”ï¼Œé‡é»çªå‡º',\r\n          entryTiming: 'å®¢æˆ¶æœ‰å…·é«”éœ€æ±‚æ™‚',\r\n          sampleMessages: [\r\n            'æ ¹æ“šæ‚¨çš„æƒ…æ³ï¼Œæˆ‘å»ºè­°...',\r\n            'é€™å€‹æ–¹æ¡ˆå¯ä»¥æ»¿è¶³æ‚¨çš„éœ€æ±‚',\r\n            'è®“æˆ‘ä¾†è©³ç´°èªªæ˜ä¸€ä¸‹'\r\n          ]\r\n        }\r\n      ],\r\n      defaultPhases: [\r\n        { id: 'phase_1', name: 'äº†è§£éœ€æ±‚', duration: '1-2å¤©', goal: 'å»ºç«‹è¯ç¹«ï¼Œäº†è§£å®¢æˆ¶éœ€æ±‚', tactics: ['é–‹å ´å•å€™', 'éœ€æ±‚æŒ–æ˜'], rolesFocus: ['account_manager'], successIndicators: ['å®¢æˆ¶å›è¦†', 'èªªå‡ºéœ€æ±‚'] },\r\n        { id: 'phase_2', name: 'æä¾›æ–¹æ¡ˆ', duration: '1-2å¤©', goal: 'æ ¹æ“šéœ€æ±‚æä¾›å®šåˆ¶æ–¹æ¡ˆ', tactics: ['æ–¹æ¡ˆä»‹ç´¹', 'åƒ¹å€¼èªªæ˜'], rolesFocus: ['solution_expert'], successIndicators: ['å®¢æˆ¶èªå¯', 'è©¢å•ç´°ç¯€'] },\r\n        { id: 'phase_3', name: 'ä¿ƒæˆè½‰åŒ–', duration: 'éˆæ´»', goal: 'è§£ç­”ç–‘æ…®ï¼Œä¿ƒæˆæˆäº¤', tactics: ['ç•°è­°è™•ç†', 'å„ªæƒ ä¿ƒå–®'], rolesFocus: ['account_manager'], successIndicators: ['å®¢æˆ¶åŒæ„', 'æˆäº¤'] }\r\n      ]\r\n    }\r\n  };\r\n  \r\n  // ============ ğŸ†• æ™ºèƒ½å¸³è™ŸåŒ¹é… ============\r\n  \r\n  /**\r\n   * P0: æ™ºèƒ½åŒ¹é…å¸³è™Ÿåˆ°è§’è‰²\r\n   * æ ¹æ“šå¸³è™Ÿç‰¹å¾µè‡ªå‹•é¸æ“‡æœ€é©åˆçš„è§’è‰²\r\n   */\r\n  async smartMatchAccountsToRoles(\r\n    recommendedRoles: RecommendedRole[],\r\n    targetIntent: IntentAnalysis\r\n  ): Promise<AccountRoleMatch[]> {\r\n    return this.smartMatchAccountsToRolesEnhanced(recommendedRoles, targetIntent, {});\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• P0: å¢å¼·ç‰ˆæ™ºèƒ½åŒ¹é…ï¼ˆæ”¯æŒé™ç´šç­–ç•¥ï¼‰\r\n   * - allowMultiRole: å…è¨±ä¸€è™Ÿå¤šè§’\r\n   * - allowOffline: å…è¨±åŒ¹é…é›¢ç·šå¸³è™Ÿ\r\n   */\r\n  async smartMatchAccountsToRolesEnhanced(\r\n    recommendedRoles: RecommendedRole[],\r\n    targetIntent: IntentAnalysis,\r\n    options: { allowMultiRole?: boolean; allowOffline?: boolean }\r\n  ): Promise<AccountRoleMatch[]> {\r\n    const { allowMultiRole = false, allowOffline = false } = options;\r\n    const accounts = this.accountService.accounts();\r\n    \r\n    // ğŸ”§ Phase 3 å„ªåŒ–: ä½¿ç”¨æ‰€æœ‰åœ¨ç·šå¸³è™Ÿé€²è¡ŒåŒ¹é…\r\n    // å„ªå…ˆç´š: AIè™Ÿ > ç™¼é€è™Ÿ > ç›£æ§è™Ÿ\r\n    const onlineAccounts = accounts.filter(a => a.status === 'Online');\r\n    \r\n    // ğŸ”§ Phase 3: ä½¿ç”¨æ‰€æœ‰åœ¨ç·šå¸³è™Ÿï¼ˆåŒ…æ‹¬ Listenerï¼‰ï¼ŒæŒ‰å„ªå…ˆç´šæ’åº\r\n    const rolePriority: Record<string, number> = { 'AI': 1, 'Sender': 2, 'Listener': 3 };\r\n    let availableAccounts = onlineAccounts\r\n      .sort((a, b) => (rolePriority[a.role] || 99) - (rolePriority[b.role] || 99));\r\n    \r\n    console.log(`[DynamicEngine] ğŸ” Phase 3 å¸³è™Ÿç¯©é¸: åœ¨ç·š ${onlineAccounts.length} å€‹, å…¨éƒ¨å¯ç”¨æ–¼å¤šè§’è‰²`);\r\n    console.log(`[DynamicEngine] ğŸ” å¯ç”¨å¸³è™Ÿæ˜ç´°:`, availableAccounts.map(a => `${a.phone}(${a.role})`));\r\n    \r\n    if (availableAccounts.length === 0 && allowOffline) {\r\n      // é™ç´š: å˜—è©¦é›¢ç·šä½†å¥åº·çš„å¸³è™Ÿ\r\n      availableAccounts = accounts.filter(a => \r\n        a.status === 'Offline' && \r\n        !a.status.toLowerCase().includes('error') &&\r\n        !a.status.toLowerCase().includes('banned')\r\n      );\r\n      if (availableAccounts.length > 0) {\r\n        console.log('[DynamicEngine] é™ç´š: ä½¿ç”¨é›¢ç·šå¸³è™Ÿï¼ˆéœ€è¦å…ˆé€£ç·šï¼‰');\r\n      }\r\n    }\r\n    \r\n    if (availableAccounts.length === 0) {\r\n      console.log('[DynamicEngine] ç„¡å¯ç”¨å¸³è™Ÿ');\r\n      return [];\r\n    }\r\n    \r\n    const matches: AccountRoleMatch[] = [];\r\n    const usedAccounts = new Set<number>();\r\n    const accountUsageCount = new Map<number, number>();\r\n    \r\n    // ğŸ”§ P0-3: åš´æ ¼æ¨¡å¼ä¸‹ï¼Œä¸€å€‹å¸³è™Ÿåªèƒ½åˆ†é…ä¸€å€‹è§’è‰²\r\n    const strictOneAccountOneRole = !allowMultiRole;\r\n    if (strictOneAccountOneRole) {\r\n      console.log('[DynamicEngine] ğŸ”’ åš´æ ¼æ¨¡å¼ï¼šä¸€å¸³è™Ÿä¸€è§’è‰²');\r\n    }\r\n    \r\n    for (const role of recommendedRoles) {\r\n      // æ‰¾åˆ°æœ€é©åˆé€™å€‹è§’è‰²çš„å¸³è™Ÿ\r\n      let bestMatch: { account: TelegramAccount; score: number; reasons: string[] } | null = null;\r\n      \r\n      for (const account of availableAccounts) {\r\n        // ğŸ”§ P0-3: åš´æ ¼æ¨¡å¼ä¸‹ï¼Œå·²ä½¿ç”¨çš„å¸³è™Ÿä¸èƒ½å†æ¬¡ä½¿ç”¨\r\n        if (strictOneAccountOneRole && usedAccounts.has(account.id)) {\r\n          console.log(`[DynamicEngine] â­ï¸ è·³éå·²ä½¿ç”¨å¸³è™Ÿ: ${account.phone}`);\r\n          continue;\r\n        }\r\n        \r\n        // å¦‚æœå·²ç¶“ä½¿ç”¨éï¼Œé™ä½åˆ†æ•¸\r\n        const usageCount = accountUsageCount.get(account.id) || 0;\r\n        const usagePenalty = usageCount * 20;\r\n        \r\n        const { score, reasons } = this.calculateAccountRoleMatch(account, role, targetIntent);\r\n        const adjustedScore = Math.max(0, score - usagePenalty);\r\n        \r\n        if (!bestMatch || adjustedScore > bestMatch.score) {\r\n          bestMatch = { account, score: adjustedScore, reasons };\r\n        }\r\n      }\r\n      \r\n      // ğŸ”§ Phase 3 å„ªåŒ–: é™ä½åŒ¹é…é–€æª»åˆ° 10ï¼Œä¸¦å¼·åˆ¶åˆ†é…å‰©é¤˜å¸³è™Ÿ\r\n      if (bestMatch && bestMatch.score >= 10) {\r\n        usedAccounts.add(bestMatch.account.id);\r\n        accountUsageCount.set(\r\n          bestMatch.account.id, \r\n          (accountUsageCount.get(bestMatch.account.id) || 0) + 1\r\n        );\r\n        \r\n        const features = this.analyzeAccountFeatures(bestMatch.account);\r\n        const usageCount = accountUsageCount.get(bestMatch.account.id) || 1;\r\n        \r\n        matches.push({\r\n          accountId: bestMatch.account.id,\r\n          accountPhone: bestMatch.account.phone,\r\n          accountName: bestMatch.account.name || bestMatch.account.phone,\r\n          roleId: role.id,\r\n          roleName: role.name,\r\n          roleIcon: role.icon,\r\n          matchScore: bestMatch.score,\r\n          matchReasons: usageCount > 1 \r\n            ? [...bestMatch.reasons, `ä¸€è™Ÿå¤šè§’ (${usageCount} è§’è‰²)`]\r\n            : bestMatch.reasons,\r\n          accountFeatures: features\r\n        });\r\n      } else if (bestMatch) {\r\n        // ğŸ”§ Phase 3: åˆ†æ•¸ä¸è¶³ä¹Ÿè¦åˆ†é…ï¼Œç¢ºä¿å¸³è™Ÿè¢«ä½¿ç”¨\r\n        console.log(`[DynamicEngine] âš¡ å¼·åˆ¶åˆ†é…ä½åˆ†å¸³è™Ÿ: ${bestMatch.account.phone} (åˆ†æ•¸: ${bestMatch.score})`);\r\n        usedAccounts.add(bestMatch.account.id);\r\n        accountUsageCount.set(\r\n          bestMatch.account.id, \r\n          (accountUsageCount.get(bestMatch.account.id) || 0) + 1\r\n        );\r\n        \r\n        matches.push({\r\n          accountId: bestMatch.account.id,\r\n          accountPhone: bestMatch.account.phone,\r\n          accountName: bestMatch.account.name || bestMatch.account.phone,\r\n          roleId: role.id,\r\n          roleName: role.name,\r\n          roleIcon: role.icon,\r\n          matchScore: bestMatch.score,\r\n          matchReasons: [...bestMatch.reasons, 'å¼·åˆ¶åˆ†é…(åˆ†æ•¸è¼ƒä½)'],\r\n          accountFeatures: this.analyzeAccountFeatures(bestMatch.account)\r\n        });\r\n      } else if (allowMultiRole && availableAccounts.length > 0) {\r\n        // ğŸ†• å¼·åˆ¶åˆ†é…: å¦‚æœæ²’æœ‰åˆé©çš„ï¼Œéš¨æ©Ÿåˆ†é…ç¬¬ä¸€å€‹å¯ç”¨å¸³è™Ÿ\r\n        const fallbackAccount = availableAccounts[0];\r\n        accountUsageCount.set(\r\n          fallbackAccount.id, \r\n          (accountUsageCount.get(fallbackAccount.id) || 0) + 1\r\n        );\r\n        const usageCount = accountUsageCount.get(fallbackAccount.id) || 1;\r\n        \r\n        matches.push({\r\n          accountId: fallbackAccount.id,\r\n          accountPhone: fallbackAccount.phone,\r\n          accountName: fallbackAccount.name || fallbackAccount.phone,\r\n          roleId: role.id,\r\n          roleName: role.name,\r\n          roleIcon: role.icon,\r\n          matchScore: 30,\r\n          matchReasons: ['è‡ªå‹•åˆ†é…', `ä¸€è™Ÿå¤šè§’ (${usageCount} è§’è‰²)`],\r\n          accountFeatures: this.analyzeAccountFeatures(fallbackAccount)\r\n        });\r\n      }\r\n    }\r\n    \r\n    this._accountMatches.set(matches);\r\n    \r\n    // ğŸ†• Phase 2.3: å¢åŠ å¸³è™ŸåŒ¹é…é€æ˜åº¦\r\n    const excludedAccounts = accounts.filter(a => \r\n      a.status === 'Online' && \r\n      !matches.some(m => m.accountId === a.id)\r\n    );\r\n    \r\n    console.log('[DynamicEngine] âœ… æ™ºèƒ½åŒ¹é…çµæœ:', matches.length, 'å€‹å¸³è™Ÿ');\r\n    matches.forEach(m => {\r\n      console.log(`  - ${m.accountPhone} â†’ ${m.roleName} (åˆ†æ•¸: ${m.matchScore})`);\r\n    });\r\n    \r\n    if (excludedAccounts.length > 0) {\r\n      console.log('[DynamicEngine] âš ï¸ æœªä½¿ç”¨çš„åœ¨ç·šå¸³è™Ÿ:', excludedAccounts.length, 'å€‹');\r\n      excludedAccounts.forEach(a => {\r\n        const reason = a.role === 'Listener' ? 'ç›£æ§è™Ÿ(ä¿ç•™ç”¨æ–¼ç›£æ§)' : \r\n                       usedAccounts.has(a.id) ? 'å·²åˆ†é…å…¶ä»–è§’è‰²' : 'åŒ¹é…åˆ†æ•¸ä¸è¶³';\r\n        console.log(`  - ${a.phone} (${a.role}): ${reason}`);\r\n      });\r\n    }\r\n    \r\n    return matches;\r\n  }\r\n  \r\n  /**\r\n   * è¨ˆç®—å¸³è™Ÿèˆ‡è§’è‰²çš„åŒ¹é…åº¦\r\n   */\r\n  private calculateAccountRoleMatch(\r\n    account: TelegramAccount,\r\n    role: RecommendedRole,\r\n    intent: IntentAnalysis\r\n  ): { score: number; reasons: string[] } {\r\n    let score = 50; // åŸºç¤åˆ†\r\n    const reasons: string[] = [];\r\n    \r\n    // 1. å¸³è™Ÿç‹€æ…‹æª¢æŸ¥\r\n    if (account.status === 'Online') {\r\n      score += 10;\r\n      reasons.push('å¸³è™Ÿåœ¨ç·š');\r\n    }\r\n    \r\n    // 2. é ­åƒ/åç¨±é¢¨æ ¼åŒ¹é…\r\n    const nameStyle = this.analyzeNameStyle(account.name);\r\n    const roleStyle = this.getRoleExpectedStyle(role.type);\r\n    \r\n    if (nameStyle === roleStyle) {\r\n      score += 20;\r\n      reasons.push(`åç¨±é¢¨æ ¼åŒ¹é… (${nameStyle})`);\r\n    } else if (nameStyle === 'neutral') {\r\n      score += 10;\r\n      reasons.push('åç¨±é¢¨æ ¼ä¸­æ€§ï¼Œé©æ‡‰æ€§å¼·');\r\n    }\r\n    \r\n    // 3. è§’è‰²é¡å‹ç‰¹æ®ŠåŒ¹é…\r\n    if (role.type === 'professional' && this.looksLikeProfessional(account)) {\r\n      score += 15;\r\n      reasons.push('å¸³è™Ÿçœ‹èµ·ä¾†å°ˆæ¥­');\r\n    }\r\n    \r\n    if (role.type === 'endorsement' && this.looksLikeFriendly(account)) {\r\n      score += 15;\r\n      reasons.push('å¸³è™Ÿçœ‹èµ·ä¾†è¦ªå’Œ');\r\n    }\r\n    \r\n    if (role.type === 'atmosphere' && this.looksLikeCasual(account)) {\r\n      score += 15;\r\n      reasons.push('å¸³è™Ÿçœ‹èµ·ä¾†è¼•é¬†');\r\n    }\r\n    \r\n    // 4. æ­·å²è¡¨ç¾ï¼ˆå¦‚æœæœ‰ï¼‰\r\n    // TODO: å¾æ•¸æ“šåº«è®€å–å¸³è™Ÿæ­·å²è¡¨ç¾æ•¸æ“š\r\n    \r\n    return { score: Math.min(100, score), reasons };\r\n  }\r\n  \r\n  /**\r\n   * åˆ†æå¸³è™Ÿç‰¹å¾µ\r\n   */\r\n  private analyzeAccountFeatures(account: TelegramAccount): AccountRoleMatch['accountFeatures'] {\r\n    const nameStyle = this.analyzeNameStyle(account.name);\r\n    \r\n    return {\r\n      profileStyle: nameStyle as 'professional' | 'casual' | 'friendly' | 'neutral',\r\n      activityLevel: 'medium',  // TODO: å¾æ­·å²æ•¸æ“šè¨ˆç®—\r\n      successRate: 0,           // TODO: å¾æ­·å²æ•¸æ“šè¨ˆç®—\r\n      responseRate: 0           // TODO: å¾æ­·å²æ•¸æ“šè¨ˆç®—\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * åˆ†æåç¨±é¢¨æ ¼\r\n   */\r\n  private analyzeNameStyle(name?: string): string {\r\n    const fullName = (name || '').toLowerCase();\r\n    \r\n    // å°ˆæ¥­é¢¨æ ¼æŒ‡æ¨™\r\n    const professionalIndicators = ['manager', 'director', 'expert', 'consultant', 'ç¶“ç†', 'é¡§å•', 'å°ˆå®¶', 'ç¸½ç›£'];\r\n    if (professionalIndicators.some(ind => fullName.includes(ind))) {\r\n      return 'professional';\r\n    }\r\n    \r\n    // å‹å¥½é¢¨æ ¼æŒ‡æ¨™\r\n    const friendlyIndicators = ['å°', 'é˜¿', 'å“¥', 'å§', 'å¯¶', 'èŒ', 'happy', 'sunny', 'sweet'];\r\n    if (friendlyIndicators.some(ind => fullName.includes(ind))) {\r\n      return 'friendly';\r\n    }\r\n    \r\n    // éš¨æ€§é¢¨æ ¼æŒ‡æ¨™\r\n    const casualIndicators = ['cool', 'chill', 'æ‡¶', 'éš¨', 'random', 'just'];\r\n    if (casualIndicators.some(ind => fullName.includes(ind))) {\r\n      return 'casual';\r\n    }\r\n    \r\n    return 'neutral';\r\n  }\r\n  \r\n  /**\r\n   * ç²å–è§’è‰²æœŸæœ›çš„å¸³è™Ÿé¢¨æ ¼\r\n   */\r\n  private getRoleExpectedStyle(roleType: string): string {\r\n    const styleMap: Record<string, string> = {\r\n      'professional': 'professional',\r\n      'endorsement': 'friendly',\r\n      'atmosphere': 'casual',\r\n      'care': 'friendly',\r\n      'solution': 'professional',\r\n      'retention': 'professional',\r\n      'host': 'friendly',\r\n      'participant': 'casual',\r\n      'expert': 'professional'\r\n    };\r\n    return styleMap[roleType] || 'neutral';\r\n  }\r\n  \r\n  private looksLikeProfessional(account: TelegramAccount): boolean {\r\n    const name = (account.name || '').toLowerCase();\r\n    return name.includes('manager') || name.includes('ç¶“ç†') || name.includes('é¡§å•') || \r\n           name.includes('director') || name.includes('ç¸½ç›£');\r\n  }\r\n  \r\n  private looksLikeFriendly(account: TelegramAccount): boolean {\r\n    const name = (account.name || '').toLowerCase();\r\n    return name.includes('å°') || name.includes('é˜¿') || name.includes('å§') || \r\n           name.includes('happy') || name.includes('sunny');\r\n  }\r\n  \r\n  private looksLikeCasual(account: TelegramAccount): boolean {\r\n    const name = (account.name || '').toLowerCase();\r\n    return name.includes('cool') || name.includes('chill') || name.length <= 3;\r\n  }\r\n  \r\n  // ============ æ ¸å¿ƒæ–¹æ³• ============\r\n  \r\n  /**\r\n   * è¨­ç½®åŸ·è¡Œæ¨¡å¼\r\n   */\r\n  setExecutionMode(mode: ExecutionMode): void {\r\n    this._executionMode.set(mode);\r\n    console.log('[DynamicEngine] åŸ·è¡Œæ¨¡å¼è¨­ç½®ç‚º:', mode);\r\n  }\r\n  \r\n  /**\r\n   * ä¸€å¥è©±å•Ÿå‹•ï¼šè§£æç”¨æˆ¶æ„åœ–ä¸¦ç”ŸæˆåŸ·è¡Œè¨ˆåŠƒï¼ˆå¢å¼·ç‰ˆï¼‰\r\n   * @param userInput ç”¨æˆ¶è¼¸å…¥çš„ç›®æ¨™\r\n   * @param mode åŸ·è¡Œæ¨¡å¼\r\n   * @param targetUsers ç›®æ¨™ç”¨æˆ¶åˆ—è¡¨ï¼ˆå¯é¸ï¼‰\r\n   * @param options é¡å¤–é¸é …ï¼ˆç¾¤èŠå”ä½œé…ç½®ï¼‰\r\n   */\r\n  async startFromOnePhrase(\r\n    userInput: string, \r\n    mode: ExecutionMode = 'hybrid',\r\n    targetUsers?: { id: string; telegramId: string; username?: string; firstName?: string; lastName?: string; intentScore: number; source?: string }[],\r\n    options?: {\r\n      chatScenario?: 'private' | 'group';\r\n      groupId?: string;\r\n      roleAccounts?: { accountId: number; accountPhone: string; roleId: string; roleName: string }[];\r\n    }\r\n  ): Promise<ExecutionState | null> {\r\n    if (!userInput.trim()) {\r\n      this.toast.error('è«‹è¼¸å…¥æ‚¨çš„ç›®æ¨™');\r\n      return null;\r\n    }\r\n    \r\n    this._isProcessing.set(true);\r\n    this._executionMode.set(mode);\r\n    \r\n    // ğŸ”§ ç¾¤èŠå”ä½œï¼šè¨˜éŒ„å ´æ™¯\r\n    const chatScenario = options?.chatScenario || 'private';\r\n    console.log(`[DynamicEngine] å•Ÿå‹•æ¨¡å¼: ${mode}, å ´æ™¯: ${chatScenario}`);\r\n    \r\n    try {\r\n      // 1. è§£ææ„åœ–\r\n      const intent = await this.analyzeIntent(userInput);\r\n      \r\n      // 2. ç”Ÿæˆç­–ç•¥\r\n      const strategy = this.generateStrategy(intent);\r\n      \r\n      // 3. æ¨è–¦è§’è‰²\r\n      let roles = this.recommendRoles(intent);\r\n      console.log('[DynamicEngine] ğŸ” æ¨è–¦è§’è‰²:', roles?.length, roles);\r\n      \r\n      // ğŸ”§ P0-1: ç§èŠæ¨¡å¼å¼·åˆ¶é™åˆ¶ç‚ºå–®ä¸€è§’è‰²\r\n      // ç§èŠæ¨¡å¼ = æ²’æœ‰ç¾¤çµ„ï¼Œç›´æ¥èˆ‡ç›®æ¨™ç”¨æˆ¶ 1v1 å°è©±\r\n      const isPrivateChat = !targetUsers || targetUsers.length <= 1;\r\n      if (isPrivateChat) {\r\n        console.log('[DynamicEngine] ğŸ”’ ç§èŠæ¨¡å¼ï¼šé™åˆ¶ç‚ºå–®ä¸€è§’è‰²');\r\n        // åªä¿ç•™ç¬¬ä¸€å€‹è§’è‰²ï¼ˆé€šå¸¸æ˜¯å®¢æˆ¶ç¶“ç†ï¼‰\r\n        roles = roles.slice(0, PRIVATE_CHAT_MAX_ROLES);\r\n        this.toast.info('ğŸ’¬ ç§èŠæ¨¡å¼ï¼šä½¿ç”¨å–®ä¸€è§’è‰²èˆ‡ç›®æ¨™ç”¨æˆ¶å°è©±');\r\n      }\r\n      \r\n      // 4. ğŸ†• æ™ºèƒ½åŒ¹é…å¸³è™Ÿåˆ°è§’è‰²\r\n      const accountMatches = await this.smartMatchAccountsToRoles(roles, intent);\r\n      console.log('[DynamicEngine] ğŸ” å¸³è™ŸåŒ¹é…çµæœ:', accountMatches?.length, accountMatches);\r\n      \r\n      // ğŸ”§ P0-2: å¸³è™Ÿå……è¶³æ€§æª¢æŸ¥\r\n      if (accountMatches.length < roles.length) {\r\n        const shortage = roles.length - accountMatches.length;\r\n        console.warn(`[DynamicEngine] âš ï¸ å¸³è™Ÿä¸è¶³ï¼šéœ€è¦ ${roles.length} å€‹ï¼Œåªæœ‰ ${accountMatches.length} å€‹`);\r\n        this.toast.warning(`âš ï¸ å¸³è™Ÿä¸è¶³ï¼éœ€è¦å†ç™»å…¥ ${shortage} å€‹å¸³è™Ÿæ‰èƒ½å®Œæ•´åŸ·è¡Œå¤šè§’è‰²å”ä½œ`);\r\n        \r\n        // å¦‚æœæ˜¯ç¾¤èŠæ¨¡å¼ä¸”å¸³è™Ÿåš´é‡ä¸è¶³ï¼Œé˜»æ­¢åŸ·è¡Œ\r\n        if (!isPrivateChat && accountMatches.length === 0) {\r\n          this.toast.error('âŒ æ²’æœ‰å¯ç”¨å¸³è™Ÿï¼Œç„¡æ³•å•Ÿå‹•ã€‚è«‹å…ˆæ·»åŠ ä¸¦ç™»å…¥å¸³è™Ÿã€‚');\r\n          return null;\r\n        }\r\n        \r\n        // ç¸®æ¸›è§’è‰²åˆ°å¯ç”¨å¸³è™Ÿæ•¸é‡\r\n        roles = roles.slice(0, Math.max(1, accountMatches.length));\r\n      }\r\n      \r\n      // 5. ğŸ†• å°‡åŒ¹é…çµæœæ›´æ–°åˆ°è§’è‰²\r\n      const rolesWithAccounts = roles.map(role => {\r\n        const match = accountMatches.find(m => m.roleId === role.id);\r\n        if (match) {\r\n          return { ...role, accountId: match.accountId, accountPhone: match.accountPhone };\r\n        }\r\n        return role;\r\n      });\r\n      \r\n      // 6. ğŸ†• è™•ç†ç›®æ¨™ç”¨æˆ¶\r\n      // ğŸ”§ Phase 3 ä¿®å¾©ï¼šç¢ºä¿åŒæ™‚è¨­ç½® id å’Œ telegramId\r\n      const formattedTargetUsers = targetUsers?.map(u => ({\r\n        id: u.telegramId || u.id,\r\n        telegramId: u.telegramId || u.id,  // ğŸ”§ ç¢ºä¿å¾Œç«¯å¯ä»¥åŒ¹é…\r\n        username: u.username,\r\n        firstName: u.firstName,\r\n        lastName: u.lastName,\r\n        intentScore: u.intentScore,\r\n        source: u.source\r\n      }));\r\n      \r\n      // ğŸ”§ èª¿è©¦æ—¥èªŒ\r\n      if (formattedTargetUsers && formattedTargetUsers.length > 0) {\r\n        console.log('[DynamicEngine] ğŸ¯ æ ¼å¼åŒ–ç›®æ¨™ç”¨æˆ¶:');\r\n        formattedTargetUsers.forEach(u => {\r\n          console.log(`  - ${u.firstName || u.username || 'unknown'}: id=${u.id}, telegramId=${u.telegramId}`);\r\n        });\r\n      }\r\n      \r\n      // 7. å‰µå»ºåŸ·è¡Œç‹€æ…‹\r\n      // ğŸ†• åˆå§‹åŒ–ä»»å‹™éšŠåˆ—\r\n      const targetUserIds = formattedTargetUsers?.map(u => String(u.id)) || [];\r\n      const queueConfig = targetUserIds.length > 0 ? {\r\n        totalUsers: targetUserIds.length,\r\n        processedUsers: 0,\r\n        currentUserIndex: 0,\r\n        currentUser: formattedTargetUsers?.[0] ? {\r\n          id: String(formattedTargetUsers[0].id),\r\n          name: formattedTargetUsers[0].firstName || formattedTargetUsers[0].username || String(formattedTargetUsers[0].id),\r\n          startTime: new Date().toISOString()\r\n        } : undefined,\r\n        completedUsers: [],\r\n        pendingUsers: targetUserIds.slice(1)  // ç¬¬ä¸€å€‹å·²åœ¨è™•ç†ï¼Œå…¶é¤˜å¾…è™•ç†\r\n      } : undefined;\r\n      \r\n      const execution: ExecutionState = {\r\n        id: `exec_${Date.now()}`,\r\n        status: 'planning',\r\n        goal: userInput,\r\n        intent,\r\n        strategy,\r\n        roles: rolesWithAccounts,\r\n        mode,\r\n        accountMatches,\r\n        targetUsers: formattedTargetUsers,\r\n        scriptlessConfig: mode === 'scriptless' ? { ...this.defaultScriptlessConfig, enabled: true } : undefined,\r\n        conversionFunnel: {\r\n          currentStage: 'contact',\r\n          stageHistory: [{ stage: 'contact', enteredAt: new Date().toISOString(), messageCount: 0 }],\r\n          keyMoments: []\r\n        },\r\n        queue: queueConfig,  // ğŸ†• æ·»åŠ éšŠåˆ—\r\n        // ğŸ”§ ç¾¤èŠå”ä½œï¼šæ·»åŠ ç¾¤èŠé…ç½®\r\n        groupConfig: chatScenario === 'group' ? {\r\n          groupId: options?.groupId,\r\n          roleAccounts: options?.roleAccounts,\r\n          chatScenario: 'group'\r\n        } : undefined,\r\n        chatScenario,  // ğŸ”§ ç¾¤èŠå”ä½œï¼šè¨˜éŒ„å ´æ™¯é¡å‹\r\n        stats: {\r\n          startTime: new Date().toISOString(),\r\n          messagesSent: 0,\r\n          responsesReceived: 0,\r\n          currentPhase: 0,\r\n          interestScore: 0,\r\n          lastAnalysis: null,\r\n          analysisCount: 0,\r\n          rolesSwitchCount: 0,\r\n          autoAdjustments: 0\r\n        },\r\n        messageHistory: []\r\n      };\r\n      \r\n      this._currentExecution.set(execution);\r\n      this._executions.update(list => [execution, ...list]);\r\n      \r\n      // ğŸ”§ Phase 4: æŒä¹…åŒ–åŸ·è¡Œç‹€æ…‹\r\n      this.persistExecution(execution);\r\n      \r\n      const modeLabel = mode === 'scriptless' ? 'ç„¡åŠ‡æœ¬' : mode === 'scripted' ? 'åŠ‡æœ¬' : 'æ··åˆ';\r\n      const targetCount = formattedTargetUsers?.length || 0;\r\n      this.toast.success(`AI å·²ç†è§£æ‚¨çš„ç›®æ¨™ï¼Œ${modeLabel}æ¨¡å¼æº–å‚™å°±ç·’ï¼ŒåŒ¹é…äº† ${accountMatches.length} å€‹å¸³è™Ÿ${targetCount > 0 ? `ï¼Œç›®æ¨™ ${targetCount} å€‹ç”¨æˆ¶` : ''}`);\r\n      \r\n      // ğŸ†• P0: è‡ªå‹•é–‹å§‹ç§èŠåŸ·è¡Œï¼ˆå¦‚æœæœ‰ç›®æ¨™ç”¨æˆ¶ï¼‰\r\n      if (formattedTargetUsers && formattedTargetUsers.length > 0) {\r\n        // å»¶é²ä¸€å°æ®µæ™‚é–“å¾Œé–‹å§‹ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°æˆåŠŸæç¤º\r\n        setTimeout(() => {\r\n          this.beginPrivateChatExecution(execution);\r\n        }, 1500);\r\n      }\r\n      \r\n      return execution;\r\n      \r\n    } catch (error) {\r\n      this.toast.error('ç­–åŠƒå¤±æ•—ï¼Œè«‹é‡è©¦');\r\n      console.error('[DynamicEngine] Start failed:', error);\r\n      return null;\r\n    } finally {\r\n      this._isProcessing.set(false);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ä½¿ç”¨ AI ç‡ŸéŠ·åŠ©æ‰‹ç­–ç•¥å•Ÿå‹•ï¼ˆå®Œæ•´ç­–ç•¥æ•¸æ“šï¼‰\r\n   */\r\n  async startWithMarketingStrategy(\r\n    userGoal: string,\r\n    marketingStrategy: {\r\n      industry: string;\r\n      targetAudience: string;\r\n      keywords: { highIntent: string[]; mediumIntent: string[]; extended: string[] };\r\n      customerProfile: { identity: string[]; features: string[]; needs: string[] };\r\n      recommendedGroups: string[];\r\n      messageTemplates: { firstTouch: string; followUp: string; closing: string };\r\n    }\r\n  ): Promise<ExecutionState | null> {\r\n    this._isProcessing.set(true);\r\n    \r\n    try {\r\n      console.log('[DynamicEngine] æ¥æ”¶ AI ç‡ŸéŠ·ç­–ç•¥:', marketingStrategy);\r\n      \r\n      // 1. æ§‹å»ºå¢å¼·ç‰ˆæ„åœ–åˆ†æ\r\n      const intent: IntentAnalysis = {\r\n        type: 'sales_conversion',\r\n        confidence: 90,  // ä¾†è‡ª AI ç‡ŸéŠ·åŠ©æ‰‹ï¼Œç½®ä¿¡åº¦é«˜\r\n        goal: `åœ¨${marketingStrategy.industry}è¡Œæ¥­ï¼Œä¿ƒé€²${marketingStrategy.targetAudience}æˆäº¤`,\r\n        targetAudience: marketingStrategy.targetAudience,\r\n        productType: marketingStrategy.industry,\r\n        urgency: 'medium',\r\n        suggestedDuration: '3-5å¤©'\r\n      };\r\n      \r\n      // 2. ä½¿ç”¨ç­–ç•¥ä¸­çš„é—œéµè©å’Œæ¶ˆæ¯æ¨¡æ¿ç”Ÿæˆå¢å¼·ç­–ç•¥\r\n      const strategy = this.generateEnhancedStrategy(intent, marketingStrategy);\r\n      \r\n      // 3. æ¨è–¦è§’è‰²ï¼ˆå¯èƒ½æ ¹æ“šè¡Œæ¥­èª¿æ•´ï¼‰\r\n      const roles = this.recommendRoles(intent);\r\n      \r\n      // 4. å‰µå»ºåŸ·è¡Œç‹€æ…‹\r\n      const execution: ExecutionState = {\r\n        id: `exec_${Date.now()}`,\r\n        status: 'planning',\r\n        goal: userGoal,\r\n        intent,\r\n        strategy,\r\n        roles,\r\n        mode: 'hybrid',\r\n        stats: {\r\n          startTime: new Date().toISOString(),\r\n          messagesSent: 0,\r\n          responsesReceived: 0,\r\n          currentPhase: 0,\r\n          interestScore: 0,\r\n          lastAnalysis: null,\r\n          analysisCount: 0,\r\n          rolesSwitchCount: 0,\r\n          autoAdjustments: 0\r\n        },\r\n        // ä¿å­˜åŸå§‹ç‡ŸéŠ·ç­–ç•¥ç”¨æ–¼åŸ·è¡Œ\r\n        marketingData: marketingStrategy\r\n      };\r\n      \r\n      this._currentExecution.set(execution);\r\n      this._executions.update(list => [execution, ...list]);\r\n      \r\n      this.toast.success('ğŸ¤– AI å·²æ•´åˆç‡ŸéŠ·ç­–ç•¥ï¼Œæº–å‚™åŸ·è¡Œæœ€å„ªæ–¹æ¡ˆï¼');\r\n      \r\n      return execution;\r\n      \r\n    } catch (error) {\r\n      this.toast.error('ç­–ç•¥æ•´åˆå¤±æ•—ï¼Œè«‹é‡è©¦');\r\n      console.error('[DynamicEngine] Marketing strategy start failed:', error);\r\n      return null;\r\n    } finally {\r\n      this._isProcessing.set(false);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ç”Ÿæˆå¢å¼·ç‰ˆç­–ç•¥ï¼ˆä½¿ç”¨ AI ç‡ŸéŠ·åŠ©æ‰‹æ•¸æ“šï¼‰\r\n   */\r\n  private generateEnhancedStrategy(\r\n    intent: IntentAnalysis,\r\n    marketingData: any\r\n  ): DynamicStrategy {\r\n    const baseStrategy = this.generateStrategy(intent);\r\n    \r\n    // ä½¿ç”¨ç‡ŸéŠ·æ•¸æ“šå¢å¼·ç­–ç•¥\r\n    return {\r\n      ...baseStrategy,\r\n      name: `${marketingData.industry} - AI ç‡ŸéŠ·ç­–ç•¥`,\r\n      description: `é‡å°ã€Œ${marketingData.targetAudience}ã€çš„æ™ºèƒ½ç‡ŸéŠ·ç­–ç•¥ï¼Œä½¿ç”¨é—œéµè©ï¼š${marketingData.keywords.highIntent.slice(0, 3).join('ã€')}`,\r\n      // å°‡æ¶ˆæ¯æ¨¡æ¿æ³¨å…¥åˆ°ç­–ç•¥ä¸­\r\n      messageTemplates: marketingData.messageTemplates,\r\n      keywords: marketingData.keywords\r\n    } as DynamicStrategy;\r\n  }\r\n  \r\n  /**\r\n   * è§£æç”¨æˆ¶æ„åœ–\r\n   */\r\n  private async analyzeIntent(userInput: string): Promise<IntentAnalysis> {\r\n    const input = userInput.toLowerCase();\r\n    \r\n    // é—œéµè©åŒ¹é…ç¢ºå®šæ„åœ–é¡å‹\r\n    let matchedType: IntentType = 'custom';\r\n    let maxScore = 0;\r\n    \r\n    for (const [type, template] of Object.entries(this.intentTemplates)) {\r\n      const score = template.keywords.filter(kw => input.includes(kw)).length;\r\n      if (score > maxScore) {\r\n        maxScore = score;\r\n        matchedType = type as IntentType;\r\n      }\r\n    }\r\n    \r\n    // æ§‹å»ºæ„åœ–åˆ†æçµæœ\r\n    const template = this.intentTemplates[matchedType];\r\n    \r\n    return {\r\n      type: matchedType,\r\n      confidence: Math.min(95, 50 + maxScore * 15),\r\n      goal: matchedType === 'custom' ? userInput : template.description,\r\n      targetAudience: this.extractTargetAudience(input),\r\n      productType: this.extractProductType(input),\r\n      urgency: this.determineUrgency(input),\r\n      suggestedDuration: this.suggestDuration(matchedType)\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * ç”Ÿæˆå‹•æ…‹ç­–ç•¥\r\n   */\r\n  private generateStrategy(intent: IntentAnalysis): DynamicStrategy {\r\n    const template = this.intentTemplates[intent.type];\r\n    \r\n    return {\r\n      id: `strategy_${Date.now()}`,\r\n      name: `${intent.goal} - å‹•æ…‹ç­–ç•¥`,\r\n      description: `AI æ ¹æ“šã€Œ${intent.goal}ã€è‡ªå‹•ç”Ÿæˆçš„å‹•æ…‹åŸ·è¡Œç­–ç•¥`,\r\n      phases: template.defaultPhases,\r\n      adjustmentRules: this.generateAdjustmentRules(intent),\r\n      constraints: {\r\n        maxDailyMessages: 50,\r\n        maxConsecutiveFromSameRole: 3,\r\n        minIntervalSeconds: 60,\r\n        maxIntervalSeconds: 300,\r\n        activeHours: { start: 9, end: 22 },\r\n        toneGuidelines: ['å‹å¥½è‡ªç„¶', 'ä¸éåº¦æ¨éŠ·', 'åƒæœ‹å‹èŠå¤©'],\r\n        forbiddenTopics: ['æ”¿æ²»', 'æ•æ„Ÿè©±é¡Œ']\r\n      }\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * æ¨è–¦è§’è‰²\r\n   */\r\n  private recommendRoles(intent: IntentAnalysis): RecommendedRole[] {\r\n    const template = this.intentTemplates[intent.type];\r\n    return template.defaultRoles;\r\n  }\r\n  \r\n  /**\r\n   * ç”Ÿæˆèª¿æ•´è¦å‰‡\r\n   */\r\n  private generateAdjustmentRules(intent: IntentAnalysis): AdjustmentRule[] {\r\n    return [\r\n      {\r\n        trigger: 'å®¢æˆ¶æƒ…ç·’è² é¢',\r\n        condition: { type: 'sentiment', threshold: 30 },\r\n        action: 'æš«åœæ¨éŠ·ï¼Œåˆ‡æ›åˆ°é—œæ‡·æ¨¡å¼'\r\n      },\r\n      {\r\n        trigger: 'å®¢æˆ¶è©¢å•åƒ¹æ ¼',\r\n        condition: { type: 'keyword', keywords: ['å¤šå°‘éŒ¢', 'åƒ¹æ ¼', 'è²»ç”¨', 'è²´ä¸è²´'] },\r\n        action: 'é€™æ˜¯æˆäº¤ä¿¡è™Ÿï¼å¼•å…¥éŠ·å”®å°ˆå®¶'\r\n      },\r\n      {\r\n        trigger: 'å®¢æˆ¶æåˆ°ç«¶å“',\r\n        condition: { type: 'keyword', keywords: ['å…¶ä»–', 'åˆ¥å®¶', 'ç«¶å“', 'å°æ¯”'] },\r\n        action: 'å¼•å…¥å°æ¯”åˆ†æï¼Œçªå‡ºå„ªå‹¢'\r\n      },\r\n      {\r\n        trigger: 'å°è©±æ²‰é»˜',\r\n        condition: { type: 'silence', threshold: 3600 },\r\n        action: 'ç™¼èµ·æ–°è©±é¡Œæˆ–æ›è§’è‰²æ´»èº'\r\n      },\r\n      {\r\n        trigger: 'èˆˆè¶£åº¦ä¸Šå‡',\r\n        condition: { type: 'interest', threshold: 70 },\r\n        action: 'å¯ä»¥é–‹å§‹åƒ¹å€¼å±•ç¤ºå’Œä¿ƒå–®'\r\n      }\r\n    ];\r\n  }\r\n  \r\n  /**\r\n   * å¯¦æ™‚åˆ†æå°è©±ï¼ˆæ¯Næ¢æ¶ˆæ¯èª¿ç”¨ä¸€æ¬¡ï¼‰\r\n   */\r\n  async analyzeConversation(messages: { role: string; content: string; isFromCustomer: boolean }[]): Promise<RealtimeAnalysis> {\r\n    // çµ±è¨ˆåŸºç¤æ•¸æ“š\r\n    const customerMessages = messages.filter(m => m.isFromCustomer);\r\n    const responseRate = messages.length > 0 ? customerMessages.length / messages.length * 100 : 0;\r\n    \r\n    // æƒ…æ„Ÿåˆ†æï¼ˆç°¡åŒ–ç‰ˆï¼Œå¯¦éš›æ‡‰èª¿ç”¨AIï¼‰\r\n    const sentiment = this.analyzeSentiment(customerMessages);\r\n    \r\n    // èˆˆè¶£é»æå–\r\n    const interests = this.extractInterests(customerMessages);\r\n    \r\n    // è¨ˆç®—æº–å‚™åº¦\r\n    const readinessScore = this.calculateReadiness(customerMessages, sentiment);\r\n    \r\n    // ç”Ÿæˆå»ºè­°\r\n    const suggestions = this.generateSuggestions(sentiment, readinessScore, interests);\r\n    \r\n    return {\r\n      timestamp: new Date().toISOString(),\r\n      messageCount: messages.length,\r\n      userProfile: {\r\n        engagementLevel: responseRate > 50 ? 'high' : responseRate > 20 ? 'medium' : 'low',\r\n        sentiment,\r\n        interests,\r\n        objections: this.extractObjections(customerMessages),\r\n        readinessScore\r\n      },\r\n      conversationQuality: {\r\n        responseRate,\r\n        avgResponseTime: 0, // éœ€è¦æ™‚é–“æˆ³è¨ˆç®—\r\n        topicEngagement: {}\r\n      },\r\n      suggestions\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * ç”Ÿæˆä¸‹ä¸€æ¢æ¶ˆæ¯ï¼ˆå‹•æ…‹ç·¨åŠ‡ï¼‰\r\n   */\r\n  async generateNextMessage(execution: ExecutionState): Promise<{\r\n    role: RecommendedRole;\r\n    content: string;\r\n    type: 'casual' | 'value' | 'close' | 'objection_handling';\r\n  } | null> {\r\n    if (!execution.strategy || execution.roles.length === 0) return null;\r\n    \r\n    const lastAnalysis = execution.stats.lastAnalysis;\r\n    const currentPhase = execution.strategy.phases[execution.stats.currentPhase];\r\n    \r\n    // é¸æ“‡åˆé©çš„è§’è‰²\r\n    const suitableRoles = currentPhase?.rolesFocus || [];\r\n    const role = execution.roles.find(r => suitableRoles.includes(r.id)) || execution.roles[0];\r\n    \r\n    // æ ¹æ“šåˆ†æçµæœæ±ºå®šæ¶ˆæ¯é¡å‹\r\n    let messageType: 'casual' | 'value' | 'close' | 'objection_handling' = 'casual';\r\n    if (lastAnalysis) {\r\n      if (lastAnalysis.userProfile.readinessScore > 70) {\r\n        messageType = 'close';\r\n      } else if (lastAnalysis.userProfile.objections.length > 0) {\r\n        messageType = 'objection_handling';\r\n      } else if (lastAnalysis.userProfile.engagementLevel === 'high') {\r\n        messageType = 'value';\r\n      }\r\n    }\r\n    \r\n    // ç”Ÿæˆæ¶ˆæ¯å…§å®¹ï¼ˆä½¿ç”¨ç¤ºä¾‹æ¶ˆæ¯ï¼Œå¯¦éš›æ‡‰èª¿ç”¨AIï¼‰\r\n    const content = role.sampleMessages[Math.floor(Math.random() * role.sampleMessages.length)];\r\n    \r\n    return { role, content, type: messageType };\r\n  }\r\n  \r\n  /**\r\n   * ç”Ÿæˆè©±é¡Œå»ºè­°\r\n   */\r\n  generateTopicSuggestions(): TopicSuggestion[] {\r\n    const now = new Date();\r\n    const hour = now.getHours();\r\n    \r\n    const suggestions: TopicSuggestion[] = [];\r\n    \r\n    // æ ¹æ“šæ™‚é–“ç”Ÿæˆè©±é¡Œ\r\n    if (hour >= 6 && hour < 10) {\r\n      suggestions.push({\r\n        type: 'casual',\r\n        content: 'æ—©å®‰å•å€™ï¼ŒèŠèŠä»Šå¤©çš„è¨ˆåŠƒ',\r\n        context: 'æ—©æ™¨é©åˆè¼•é¬†å•å€™',\r\n        suitableRoles: ['friendly_member', 'community_host']\r\n      });\r\n    } else if (hour >= 11 && hour < 13) {\r\n      suggestions.push({\r\n        type: 'life',\r\n        content: 'åˆé¤è©±é¡Œï¼ŒèŠèŠç¾é£Ÿ',\r\n        context: 'åˆé¤æ™‚é–“è©±é¡Œ',\r\n        suitableRoles: ['active_member_1', 'active_member_2']\r\n      });\r\n    } else if (hour >= 18 && hour < 20) {\r\n      suggestions.push({\r\n        type: 'casual',\r\n        content: 'ä¸‹ç­è©±é¡Œï¼ŒèŠèŠä»Šå¤©çš„è¶£äº‹',\r\n        context: 'æ™šé–“è¼•é¬†èŠå¤©',\r\n        suitableRoles: ['friendly_member']\r\n      });\r\n    }\r\n    \r\n    // æ·»åŠ é€šç”¨è©±é¡Œ\r\n    suggestions.push({\r\n      type: 'news',\r\n      content: 'æœ€è¿‘çš„ç†±é»æ–°èè¨è«–',\r\n      context: 'å¯ä»¥çµåˆç”¢å“å ´æ™¯',\r\n      suitableRoles: ['opinion_leader', 'community_host']\r\n    });\r\n    \r\n    return suggestions;\r\n  }\r\n  \r\n  // ============ ğŸ†• P2: è½‰åŒ–è¿½è¹¤å¢å¼· ============\r\n  \r\n  /**\r\n   * ç²å–è½‰åŒ–æ¼æ–—çµ±è¨ˆ\r\n   */\r\n  getConversionFunnelStats(): {\r\n    totalExecutions: number;\r\n    funnelData: { stage: string; count: number; rate: number }[];\r\n    avgTimePerStage: Record<string, number>;\r\n    topKeyMoments: { trigger: string; count: number }[];\r\n  } {\r\n    const executions = this._executions();\r\n    \r\n    // çµ±è¨ˆå„éšæ®µæ•¸é‡\r\n    const stageCounts: Record<string, number> = {\r\n      'contact': 0,\r\n      'response': 0,\r\n      'interest': 0,\r\n      'intent': 0,\r\n      'conversion': 0\r\n    };\r\n    \r\n    const stageTimings: Record<string, number[]> = {\r\n      'contact': [],\r\n      'response': [],\r\n      'interest': [],\r\n      'intent': [],\r\n      'conversion': []\r\n    };\r\n    \r\n    const keyMomentCounts: Record<string, number> = {};\r\n    \r\n    for (const exec of executions) {\r\n      if (!exec.conversionFunnel) continue;\r\n      \r\n      // çµ±è¨ˆæœ€çµ‚éšæ®µ\r\n      stageCounts[exec.conversionFunnel.currentStage]++;\r\n      \r\n      // çµ±è¨ˆå„éšæ®µåœç•™æ™‚é–“\r\n      const history = exec.conversionFunnel.stageHistory;\r\n      for (let i = 0; i < history.length - 1; i++) {\r\n        const current = history[i];\r\n        const next = history[i + 1];\r\n        const duration = new Date(next.enteredAt).getTime() - new Date(current.enteredAt).getTime();\r\n        stageTimings[current.stage]?.push(duration / 1000 / 60); // åˆ†é˜\r\n      }\r\n      \r\n      // çµ±è¨ˆé—œéµæ™‚åˆ»\r\n      for (const moment of exec.conversionFunnel.keyMoments) {\r\n        keyMomentCounts[moment.trigger] = (keyMomentCounts[moment.trigger] || 0) + 1;\r\n      }\r\n    }\r\n    \r\n    // è¨ˆç®—æ¼æ–—è½‰åŒ–ç‡\r\n    const stages = ['contact', 'response', 'interest', 'intent', 'conversion'];\r\n    const total = executions.length || 1;\r\n    \r\n    let cumulativeCount = total;\r\n    const funnelData = stages.map(stage => {\r\n      const count = stageCounts[stage];\r\n      const rate = Math.round((cumulativeCount / total) * 100);\r\n      cumulativeCount = cumulativeCount - count + stageCounts[stage];\r\n      return { stage, count, rate };\r\n    });\r\n    \r\n    // è¨ˆç®—å¹³å‡æ™‚é–“\r\n    const avgTimePerStage: Record<string, number> = {};\r\n    for (const [stage, times] of Object.entries(stageTimings)) {\r\n      avgTimePerStage[stage] = times.length > 0 \r\n        ? Math.round(times.reduce((a, b) => a + b, 0) / times.length)\r\n        : 0;\r\n    }\r\n    \r\n    // æ’åºé—œéµæ™‚åˆ»\r\n    const topKeyMoments = Object.entries(keyMomentCounts)\r\n      .map(([trigger, count]) => ({ trigger, count }))\r\n      .sort((a, b) => b.count - a.count)\r\n      .slice(0, 10);\r\n    \r\n    return {\r\n      totalExecutions: executions.length,\r\n      funnelData,\r\n      avgTimePerStage,\r\n      topKeyMoments\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * è¨˜éŒ„é—œéµæ™‚åˆ»\r\n   */\r\n  recordKeyMoment(executionId: string, message: string, trigger: string): void {\r\n    const execution = this._executions().find(e => e.id === executionId);\r\n    if (!execution || !execution.conversionFunnel) return;\r\n    \r\n    execution.conversionFunnel.keyMoments.push({\r\n      message,\r\n      trigger,\r\n      stage: execution.conversionFunnel.currentStage,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n    \r\n    this._executions.update(list => list.map(e => e.id === executionId ? execution : e));\r\n    \r\n    if (this._currentExecution()?.id === executionId) {\r\n      this._currentExecution.set({ ...execution });\r\n    }\r\n    \r\n    console.log(`[DynamicEngine] è¨˜éŒ„é—œéµæ™‚åˆ»: ${trigger} - ${message.substring(0, 30)}...`);\r\n  }\r\n  \r\n  /**\r\n   * ç²å–åŸ·è¡Œè©³æƒ…å ±è¡¨\r\n   */\r\n  getExecutionReport(executionId: string): {\r\n    summary: {\r\n      goal: string;\r\n      mode: string;\r\n      duration: string;\r\n      messagesSent: number;\r\n      responsesReceived: number;\r\n      analysisCount: number;\r\n      finalInterestScore: number;\r\n      outcome: string;\r\n    };\r\n    rolePerformance: {\r\n      roleId: string;\r\n      roleName: string;\r\n      messageCount: number;\r\n      responseRate: number;\r\n    }[];\r\n    funnelProgress: {\r\n      stage: string;\r\n      enteredAt: string;\r\n      duration: string;\r\n    }[];\r\n    keyMoments: {\r\n      message: string;\r\n      trigger: string;\r\n      stage: string;\r\n      timestamp: string;\r\n    }[];\r\n    aiAdjustments: {\r\n      timestamp: string;\r\n      action: string;\r\n      reason: string;\r\n    }[];\r\n  } | null {\r\n    const execution = this._executions().find(e => e.id === executionId);\r\n    if (!execution) return null;\r\n    \r\n    // è¨ˆç®—æŒçºŒæ™‚é–“\r\n    const startTime = new Date(execution.stats.startTime);\r\n    const endTime = execution.status === 'completed' ? new Date() : new Date();\r\n    const durationMs = endTime.getTime() - startTime.getTime();\r\n    const durationMinutes = Math.round(durationMs / 1000 / 60);\r\n    \r\n    // è§’è‰²è¡¨ç¾çµ±è¨ˆ\r\n    const roleMessages: Record<string, number> = {};\r\n    const roleResponses: Record<string, number> = {};\r\n    \r\n    for (const msg of execution.messageHistory || []) {\r\n      if (!msg.isFromCustomer) {\r\n        roleMessages[msg.role] = (roleMessages[msg.role] || 0) + 1;\r\n      }\r\n    }\r\n    \r\n    const rolePerformance = execution.roles.map(role => ({\r\n      roleId: role.id,\r\n      roleName: role.name,\r\n      messageCount: roleMessages[role.id] || 0,\r\n      responseRate: roleMessages[role.id] > 0 \r\n        ? Math.round((roleResponses[role.id] || 0) / roleMessages[role.id] * 100)\r\n        : 0\r\n    }));\r\n    \r\n    // æ¼æ–—é€²åº¦\r\n    const funnelProgress = (execution.conversionFunnel?.stageHistory || []).map((stage, i, arr) => {\r\n      const nextStage = arr[i + 1];\r\n      const duration = nextStage \r\n        ? Math.round((new Date(nextStage.enteredAt).getTime() - new Date(stage.enteredAt).getTime()) / 1000 / 60)\r\n        : 0;\r\n      return {\r\n        stage: stage.stage,\r\n        enteredAt: stage.enteredAt,\r\n        duration: duration > 0 ? `${duration} åˆ†é˜` : 'é€²è¡Œä¸­'\r\n      };\r\n    });\r\n    \r\n    // ç¢ºå®šçµæœ\r\n    let outcome = 'é€²è¡Œä¸­';\r\n    if (execution.status === 'completed') {\r\n      const finalStage = execution.conversionFunnel?.currentStage;\r\n      if (finalStage === 'conversion') {\r\n        outcome = 'âœ… è½‰åŒ–æˆåŠŸ';\r\n      } else if (execution.stats.interestScore < 30) {\r\n        outcome = 'âŒ æœªè½‰åŒ– - èˆˆè¶£åº¦ä½';\r\n      } else {\r\n        outcome = 'â¸ï¸ æœªè½‰åŒ– - å¾…è·Ÿé€²';\r\n      }\r\n    }\r\n    \r\n    return {\r\n      summary: {\r\n        goal: execution.goal,\r\n        mode: execution.mode,\r\n        duration: durationMinutes > 60 \r\n          ? `${Math.floor(durationMinutes / 60)} å°æ™‚ ${durationMinutes % 60} åˆ†é˜`\r\n          : `${durationMinutes} åˆ†é˜`,\r\n        messagesSent: execution.stats.messagesSent,\r\n        responsesReceived: execution.stats.responsesReceived,\r\n        analysisCount: execution.stats.analysisCount,\r\n        finalInterestScore: execution.stats.interestScore,\r\n        outcome\r\n      },\r\n      rolePerformance,\r\n      funnelProgress,\r\n      keyMoments: execution.conversionFunnel?.keyMoments || [],\r\n      aiAdjustments: [] // TODO: å¾åŸ·è¡Œæ­·å²æå–\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * ç²å–æ‰€æœ‰åŸ·è¡Œçš„çµ±è¨ˆæ‘˜è¦\r\n   */\r\n  getOverallStats(): {\r\n    totalExecutions: number;\r\n    completedExecutions: number;\r\n    conversionRate: number;\r\n    avgMessagesPerExecution: number;\r\n    avgInterestScore: number;\r\n    modeDistribution: { mode: string; count: number }[];\r\n    topGoals: { goal: string; count: number }[];\r\n  } {\r\n    const executions = this._executions();\r\n    const completed = executions.filter(e => e.status === 'completed');\r\n    const converted = completed.filter(e => \r\n      e.conversionFunnel?.currentStage === 'conversion'\r\n    );\r\n    \r\n    const totalMessages = executions.reduce((sum, e) => sum + e.stats.messagesSent, 0);\r\n    const totalInterest = executions.reduce((sum, e) => sum + e.stats.interestScore, 0);\r\n    \r\n    // æ¨¡å¼åˆ†ä½ˆ\r\n    const modeCount: Record<string, number> = {};\r\n    for (const e of executions) {\r\n      modeCount[e.mode] = (modeCount[e.mode] || 0) + 1;\r\n    }\r\n    \r\n    // ç›®æ¨™çµ±è¨ˆ\r\n    const goalCount: Record<string, number> = {};\r\n    for (const e of executions) {\r\n      const goal = e.goal.substring(0, 20);\r\n      goalCount[goal] = (goalCount[goal] || 0) + 1;\r\n    }\r\n    \r\n    return {\r\n      totalExecutions: executions.length,\r\n      completedExecutions: completed.length,\r\n      conversionRate: completed.length > 0 \r\n        ? Math.round((converted.length / completed.length) * 100)\r\n        : 0,\r\n      avgMessagesPerExecution: executions.length > 0\r\n        ? Math.round(totalMessages / executions.length)\r\n        : 0,\r\n      avgInterestScore: executions.length > 0\r\n        ? Math.round(totalInterest / executions.length)\r\n        : 0,\r\n      modeDistribution: Object.entries(modeCount).map(([mode, count]) => ({ mode, count })),\r\n      topGoals: Object.entries(goalCount)\r\n        .map(([goal, count]) => ({ goal, count }))\r\n        .sort((a, b) => b.count - a.count)\r\n        .slice(0, 5)\r\n    };\r\n  }\r\n  \r\n  // ============ è¼”åŠ©æ–¹æ³• ============\r\n  \r\n  private extractTargetAudience(input: string): string {\r\n    if (input.includes('ç¾¤')) return 'ç¾¤æˆå“¡';\r\n    if (input.includes('å®¢æˆ¶')) return 'æ½›åœ¨å®¢æˆ¶';\r\n    if (input.includes('è€')) return 'è€å®¢æˆ¶';\r\n    return 'ç›®æ¨™ç”¨æˆ¶';\r\n  }\r\n  \r\n  private extractProductType(input: string): string {\r\n    if (input.includes('èª²ç¨‹') || input.includes('æ•™è‚²')) return 'æ•™è‚²èª²ç¨‹';\r\n    if (input.includes('ç”¢å“')) return 'å¯¦é«”ç”¢å“';\r\n    if (input.includes('æœå‹™')) return 'æœå‹™é¡';\r\n    return 'ç”¢å“/æœå‹™';\r\n  }\r\n  \r\n  private determineUrgency(input: string): 'high' | 'medium' | 'low' {\r\n    if (input.includes('é¦¬ä¸Š') || input.includes('ç«‹å³') || input.includes('ä»Šå¤©')) return 'high';\r\n    if (input.includes('ç›¡å¿«') || input.includes('é€™é€±')) return 'medium';\r\n    return 'low';\r\n  }\r\n  \r\n  private suggestDuration(type: IntentType): string {\r\n    const durations: Record<IntentType, string> = {\r\n      sales_conversion: '3-7å¤©',\r\n      churn_recovery: '1-3å¤©',\r\n      community_activation: 'æŒçºŒé€²è¡Œ',\r\n      customer_support: 'å³æ™‚è™•ç†',\r\n      brand_promotion: 'æŒçºŒé€²è¡Œ',\r\n      lead_nurturing: '2-4é€±',\r\n      custom: 'æ ¹æ“šæƒ…æ³èª¿æ•´'\r\n    };\r\n    return durations[type];\r\n  }\r\n  \r\n  private analyzeSentiment(messages: { content: string }[]): 'positive' | 'neutral' | 'negative' {\r\n    const text = messages.map(m => m.content).join(' ');\r\n    const positiveWords = ['å¥½', 'æ£’', 'å–œæ­¡', 'è¬è¬', 'æ„Ÿè¬', 'è®š', 'ä¸éŒ¯'];\r\n    const negativeWords = ['ä¸å¥½', 'å·®', 'å¤±æœ›', 'ç”Ÿæ°£', 'æŠ•è¨´', 'é€€', 'çˆ›'];\r\n    \r\n    const positiveCount = positiveWords.filter(w => text.includes(w)).length;\r\n    const negativeCount = negativeWords.filter(w => text.includes(w)).length;\r\n    \r\n    if (positiveCount > negativeCount) return 'positive';\r\n    if (negativeCount > positiveCount) return 'negative';\r\n    return 'neutral';\r\n  }\r\n  \r\n  private extractInterests(messages: { content: string }[]): string[] {\r\n    const interests: string[] = [];\r\n    const text = messages.map(m => m.content).join(' ');\r\n    \r\n    if (text.includes('åƒ¹æ ¼') || text.includes('å¤šå°‘éŒ¢')) interests.push('åƒ¹æ ¼æ•æ„Ÿ');\r\n    if (text.includes('æ•ˆæœ') || text.includes('æœ‰ç”¨å—')) interests.push('æ•ˆæœé—œæ³¨');\r\n    if (text.includes('æ€éº¼ç”¨') || text.includes('ä½¿ç”¨')) interests.push('ä½¿ç”¨æ–¹æ³•');\r\n    \r\n    return interests;\r\n  }\r\n  \r\n  private extractObjections(messages: { content: string }[]): string[] {\r\n    const objections: string[] = [];\r\n    const text = messages.map(m => m.content).join(' ');\r\n    \r\n    if (text.includes('å¤ªè²´') || text.includes('è²´äº†')) objections.push('åƒ¹æ ¼é¡§æ…®');\r\n    if (text.includes('æ²’ç”¨') || text.includes('ä¸éœ€è¦')) objections.push('éœ€æ±‚ä¸æ˜ç¢º');\r\n    if (text.includes('è€ƒæ…®') || text.includes('å†èªª')) objections.push('æ±ºç­–çŒ¶è±«');\r\n    \r\n    return objections;\r\n  }\r\n  \r\n  private calculateReadiness(messages: { content: string }[], sentiment: string): number {\r\n    let score = 30; // åŸºç¤åˆ†\r\n    \r\n    const text = messages.map(m => m.content).join(' ');\r\n    \r\n    // ç©æ¥µä¿¡è™ŸåŠ åˆ†\r\n    if (text.includes('æ€éº¼è²·') || text.includes('åœ¨å“ªè²·')) score += 30;\r\n    if (text.includes('å¤šå°‘éŒ¢') || text.includes('åƒ¹æ ¼')) score += 20;\r\n    if (text.includes('æœ‰æ´»å‹•å—') || text.includes('å„ªæƒ ')) score += 15;\r\n    if (sentiment === 'positive') score += 10;\r\n    \r\n    // æ¶ˆæ¥µä¿¡è™Ÿæ¸›åˆ†\r\n    if (text.includes('ä¸éœ€è¦') || text.includes('ä¸ç”¨äº†')) score -= 20;\r\n    if (sentiment === 'negative') score -= 15;\r\n    \r\n    return Math.max(0, Math.min(100, score));\r\n  }\r\n  \r\n  private generateSuggestions(\r\n    sentiment: string, \r\n    readiness: number, \r\n    interests: string[]\r\n  ): RealtimeAnalysis['suggestions'] {\r\n    let nextAction: 'continue' | 'escalate' | 'pause' | 'close' = 'continue';\r\n    let recommendedRole = 'friendly_member';\r\n    let topicSuggestion = 'ç¹¼çºŒè¼•é¬†èŠå¤©';\r\n    let toneAdjustment = 'ä¿æŒå‹å¥½';\r\n    let reasoning = 'å°è©±é€²è¡Œæ­£å¸¸';\r\n    \r\n    if (readiness > 70) {\r\n      nextAction = 'close';\r\n      recommendedRole = 'sales_expert';\r\n      topicSuggestion = 'ç”¢å“åƒ¹å€¼å’Œå„ªæƒ ';\r\n      toneAdjustment = 'å¯ä»¥æ›´ç›´æ¥';\r\n      reasoning = 'å®¢æˆ¶æº–å‚™åº¦é«˜ï¼Œå¯ä»¥ä¿ƒå–®';\r\n    } else if (sentiment === 'negative') {\r\n      nextAction = 'pause';\r\n      recommendedRole = 'cs_agent';\r\n      topicSuggestion = 'é—œå¿ƒå’Œå‚¾è½';\r\n      toneAdjustment = 'æ›´åŠ æº«å’Œè€å¿ƒ';\r\n      reasoning = 'å®¢æˆ¶æƒ…ç·’è² é¢ï¼Œéœ€è¦é—œæ‡·';\r\n    } else if (interests.includes('åƒ¹æ ¼æ•æ„Ÿ')) {\r\n      nextAction = 'escalate';\r\n      recommendedRole = 'sales_expert';\r\n      topicSuggestion = 'åƒ¹å€¼å„ªå…ˆï¼Œå†è«‡åƒ¹æ ¼';\r\n      reasoning = 'å®¢æˆ¶é—œæ³¨åƒ¹æ ¼ï¼Œéœ€è¦å¼·èª¿åƒ¹å€¼';\r\n    }\r\n    \r\n    return { nextAction, recommendedRole, topicSuggestion, toneAdjustment, reasoning };\r\n  }\r\n  \r\n  // ============ ğŸ†• å‹•æ…‹åˆ†æé–‰ç’° ============\r\n  \r\n  /**\r\n   * P1: åŸ·è¡Œå‹•æ…‹åˆ†æï¼ˆæ¯ N æ¢æ¶ˆæ¯è§¸ç™¼ï¼‰\r\n   */\r\n  private async performDynamicAnalysis(execution: ExecutionState): Promise<void> {\r\n    if (!execution.messageHistory || execution.messageHistory.length === 0) return;\r\n    \r\n    console.log('[DynamicEngine] åŸ·è¡Œå‹•æ…‹åˆ†æ...');\r\n    \r\n    // 1. åˆ†ææœ€è¿‘çš„æ¶ˆæ¯\r\n    const recentMessages = execution.messageHistory.slice(-this.analysisInterval);\r\n    const analysis = await this.analyzeConversation(recentMessages);\r\n    \r\n    // 2. æ›´æ–°çµ±è¨ˆ\r\n    execution.stats.lastAnalysis = analysis;\r\n    execution.stats.analysisCount++;\r\n    execution.stats.interestScore = analysis.userProfile.readinessScore;\r\n    \r\n    // 3. ğŸ†• è‡ªå‹•æ±ºç­–å’Œèª¿æ•´\r\n    const adjustment = this.makeAutoAdjustment(execution, analysis);\r\n    \r\n    if (adjustment.shouldAdjust) {\r\n      execution.stats.autoAdjustments++;\r\n      \r\n      // é€šçŸ¥å‰ç«¯åˆ†æçµæœ\r\n      this.toast.info(`ğŸ“Š ç¬¬ ${execution.stats.analysisCount} æ¬¡åˆ†æ: ${adjustment.reason}`);\r\n      \r\n      // ç™¼é€èª¿æ•´æŒ‡ä»¤åˆ°å¾Œç«¯\r\n      this.ipc.send('ai-team:adjust-strategy', {\r\n        executionId: execution.id,\r\n        adjustment: adjustment\r\n      });\r\n    }\r\n    \r\n    // 4. æ›´æ–°è½‰åŒ–æ¼æ–—\r\n    this.updateFunnelFromAnalysis(execution, analysis);\r\n    \r\n    this._currentExecution.set({ ...execution });\r\n    this._executions.update(list => list.map(e => e.id === execution.id ? execution : e));\r\n  }\r\n  \r\n  /**\r\n   * è‡ªå‹•èª¿æ•´æ±ºç­–\r\n   */\r\n  private makeAutoAdjustment(\r\n    execution: ExecutionState,\r\n    analysis: RealtimeAnalysis\r\n  ): { shouldAdjust: boolean; action: string; reason: string; newRole?: string; newPhase?: number } {\r\n    const { suggestions, userProfile } = analysis;\r\n    \r\n    // è¦å‰‡ 1: èˆˆè¶£åº¦é«˜ï¼Œæ¨é€²åˆ°ä¸‹ä¸€éšæ®µ\r\n    if (userProfile.readinessScore > 70 && execution.strategy) {\r\n      const nextPhase = Math.min(\r\n        execution.stats.currentPhase + 1,\r\n        execution.strategy.phases.length - 1\r\n      );\r\n      if (nextPhase > execution.stats.currentPhase) {\r\n        return {\r\n          shouldAdjust: true,\r\n          action: 'advance_phase',\r\n          reason: `å®¢æˆ¶èˆˆè¶£åº¦ ${userProfile.readinessScore}%ï¼Œæ¨é€²åˆ°ä¿ƒå–®éšæ®µ`,\r\n          newPhase: nextPhase\r\n        };\r\n      }\r\n    }\r\n    \r\n    // è¦å‰‡ 2: æƒ…ç·’è² é¢ï¼Œåˆ‡æ›åˆ°é—œæ‡·è§’è‰²\r\n    if (userProfile.sentiment === 'negative') {\r\n      return {\r\n        shouldAdjust: true,\r\n        action: 'switch_role',\r\n        reason: 'å®¢æˆ¶æƒ…ç·’è² é¢ï¼Œåˆ‡æ›åˆ°é—œæ‡·æ¨¡å¼',\r\n        newRole: 'cs_agent'\r\n      };\r\n    }\r\n    \r\n    // è¦å‰‡ 3: äº’å‹•åº¦ä½ï¼Œæ›è§’è‰²æ´»èº\r\n    if (userProfile.engagementLevel === 'low' && execution.stats.messagesSent > 5) {\r\n      return {\r\n        shouldAdjust: true,\r\n        action: 'activate_atmosphere',\r\n        reason: 'äº’å‹•åº¦ä½ï¼Œå¼•å…¥æ´»èºè§’è‰²',\r\n        newRole: 'friendly_member'\r\n      };\r\n    }\r\n    \r\n    // è¦å‰‡ 4: å®¢æˆ¶æœ‰åƒ¹æ ¼é¡§æ…®ï¼Œå¼•å…¥å°ˆå®¶\r\n    if (userProfile.objections.includes('åƒ¹æ ¼é¡§æ…®')) {\r\n      return {\r\n        shouldAdjust: true,\r\n        action: 'handle_objection',\r\n        reason: 'å®¢æˆ¶æœ‰åƒ¹æ ¼é¡§æ…®ï¼Œå¼•å…¥å°ˆå®¶è™•ç†',\r\n        newRole: 'sales_expert'\r\n      };\r\n    }\r\n    \r\n    return { shouldAdjust: false, action: 'continue', reason: 'ä¿æŒç•¶å‰ç­–ç•¥' };\r\n  }\r\n  \r\n  /**\r\n   * æ ¹æ“šåˆ†ææ›´æ–°è½‰åŒ–æ¼æ–—\r\n   */\r\n  private updateFunnelFromAnalysis(execution: ExecutionState, analysis: RealtimeAnalysis): void {\r\n    if (!execution.conversionFunnel) return;\r\n    \r\n    const { readinessScore, interests } = analysis.userProfile;\r\n    const currentStage = execution.conversionFunnel.currentStage;\r\n    \r\n    // æ ¹æ“šä¿¡è™Ÿæ¨é€²æ¼æ–—\r\n    if (currentStage === 'response' && interests.length > 0) {\r\n      this.updateConversionStage(execution, 'interest', 'å®¢æˆ¶è¡¨ç¾å‡ºèˆˆè¶£');\r\n    } else if (currentStage === 'interest' && readinessScore > 60) {\r\n      this.updateConversionStage(execution, 'intent', 'å®¢æˆ¶æœ‰è³¼è²·æ„å‘');\r\n    } else if (currentStage === 'intent' && readinessScore > 85) {\r\n      this.updateConversionStage(execution, 'conversion', 'å³å°‡æˆäº¤');\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°è½‰åŒ–éšæ®µ\r\n   */\r\n  private updateConversionStage(execution: ExecutionState, newStage: string, trigger: string): void {\r\n    if (!execution.conversionFunnel) return;\r\n    \r\n    const messageCount = execution.messageHistory?.length || 0;\r\n    \r\n    execution.conversionFunnel.currentStage = newStage as any;\r\n    execution.conversionFunnel.stageHistory.push({\r\n      stage: newStage,\r\n      enteredAt: new Date().toISOString(),\r\n      messageCount\r\n    });\r\n    execution.conversionFunnel.keyMoments.push({\r\n      message: trigger,\r\n      trigger: `é€²å…¥ ${newStage} éšæ®µ`,\r\n      stage: newStage,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n    \r\n    console.log(`[DynamicEngine] è½‰åŒ–æ¼æ–—: ${newStage}`, trigger);\r\n  }\r\n  \r\n  // ğŸ†• è½‰åŒ–ä¿¡è™Ÿé—œéµè©åº«\r\n  private conversionSignals = {\r\n    // é«˜æ„å‘ä¿¡è™Ÿï¼ˆ80åˆ†+ï¼‰\r\n    high: ['æ€éº¼è²·', 'å¤šå°‘éŒ¢', 'åƒ¹æ ¼', 'ä»˜æ¬¾', 'ä¸‹å–®', 'æƒ³è²·', 'è³¼è²·', 'è¨‚è³¼', 'ä»˜è²»', 'æ”¯ä»˜'],\r\n    // ä¸­æ„å‘ä¿¡è™Ÿï¼ˆ50-80åˆ†ï¼‰\r\n    medium: ['æœ‰èˆˆè¶£', 'æƒ³äº†è§£', 'ä»‹ç´¹ä¸€ä¸‹', 'è©³ç´°èªªèªª', 'ç™¼çµ¦æˆ‘', 'æœ‰ä»€éº¼å„ªæƒ ', 'æ€éº¼ä½¿ç”¨'],\r\n    // æ­£é¢ä¿¡è™Ÿï¼ˆ30-50åˆ†ï¼‰\r\n    positive: ['ä¸éŒ¯', 'æŒºå¥½', 'æœ‰é“ç†', 'å¯ä»¥', 'å¥½çš„', 'è¬è¬', 'æ„Ÿè¬'],\r\n    // è² é¢ä¿¡è™Ÿï¼ˆæ¸›åˆ†ï¼‰\r\n    negative: ['ä¸éœ€è¦', 'ä¸ç”¨äº†', 'ä¸æ„Ÿèˆˆè¶£', 'åˆ¥æ‰“æ“¾', 'å–é—œ', 'æ‹‰é»‘', 'é¨·æ“¾'],\r\n    // æˆäº¤ä¿¡è™Ÿï¼ˆç¢ºèªè½‰åŒ–ï¼‰\r\n    converted: ['è²·äº†', 'å·²ä»˜æ¬¾', 'ä»˜å¥½äº†', 'ä¸‹å–®äº†', 'æˆäº¤', 'è¨‚å¥½äº†']\r\n  };\r\n  \r\n  /**\r\n   * ğŸ†• P1: æª¢æ¸¬è½‰åŒ–ä¿¡è™Ÿ\r\n   */\r\n  private detectConversionSignal(message: string): {\r\n    hasSignal: boolean;\r\n    signalType: 'high' | 'medium' | 'positive' | 'negative' | 'converted' | null;\r\n    matchedKeyword: string | null;\r\n    score: number;\r\n  } {\r\n    const lowerMsg = message.toLowerCase();\r\n    \r\n    // æŒ‰å„ªå…ˆç´šæª¢æ¸¬\r\n    for (const keyword of this.conversionSignals.converted) {\r\n      if (lowerMsg.includes(keyword)) {\r\n        return { hasSignal: true, signalType: 'converted', matchedKeyword: keyword, score: 100 };\r\n      }\r\n    }\r\n    \r\n    for (const keyword of this.conversionSignals.high) {\r\n      if (lowerMsg.includes(keyword)) {\r\n        return { hasSignal: true, signalType: 'high', matchedKeyword: keyword, score: 85 };\r\n      }\r\n    }\r\n    \r\n    for (const keyword of this.conversionSignals.medium) {\r\n      if (lowerMsg.includes(keyword)) {\r\n        return { hasSignal: true, signalType: 'medium', matchedKeyword: keyword, score: 60 };\r\n      }\r\n    }\r\n    \r\n    for (const keyword of this.conversionSignals.positive) {\r\n      if (lowerMsg.includes(keyword)) {\r\n        return { hasSignal: true, signalType: 'positive', matchedKeyword: keyword, score: 40 };\r\n      }\r\n    }\r\n    \r\n    for (const keyword of this.conversionSignals.negative) {\r\n      if (lowerMsg.includes(keyword)) {\r\n        return { hasSignal: true, signalType: 'negative', matchedKeyword: keyword, score: -30 };\r\n      }\r\n    }\r\n    \r\n    return { hasSignal: false, signalType: null, matchedKeyword: null, score: 0 };\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• P1: è™•ç†è½‰åŒ–ä¿¡è™Ÿ\r\n   */\r\n  private handleConversionSignal(\r\n    execution: ExecutionState,\r\n    customerData: any,\r\n    signal: { signalType: string | null; matchedKeyword: string | null; score: number }\r\n  ): void {\r\n    console.log('[DynamicEngine] ğŸ¯ è½‰åŒ–ä¿¡è™Ÿ:', signal);\r\n    \r\n    // è¨˜éŒ„é—œéµæ™‚åˆ»\r\n    if (execution.conversionFunnel) {\r\n      execution.conversionFunnel.keyMoments.push({\r\n        message: customerData.text,\r\n        trigger: `${signal.signalType}: ${signal.matchedKeyword}`,\r\n        stage: signal.signalType || 'unknown',\r\n        timestamp: new Date().toISOString()\r\n      });\r\n    }\r\n    \r\n    // æ ¹æ“šä¿¡è™Ÿé¡å‹è™•ç†\r\n    switch (signal.signalType) {\r\n      case 'converted':\r\n        // å®¢æˆ¶å·²æˆäº¤\r\n        this.toast.success(`ğŸ‰ å®¢æˆ¶ ${customerData.firstName || 'ç”¨æˆ¶'} å·²æˆäº¤ï¼`);\r\n        this.updateConversionStage(execution, 'conversion', customerData.text);\r\n        \r\n        // æ¨™è¨˜ç•¶å‰ç”¨æˆ¶ç‚ºè½‰åŒ–æˆåŠŸ\r\n        if (this.completeCurrentUser) {\r\n          this.completeCurrentUser('converted');\r\n        }\r\n        break;\r\n        \r\n      case 'high':\r\n        // é«˜æ„å‘ - ç™¼é€é€šçŸ¥ï¼Œåˆ‡æ›åˆ°éŠ·å”®å°ˆå®¶\r\n        this.toast.success(`ğŸ¯ é«˜è½‰åŒ–ä¿¡è™Ÿï¼${customerData.firstName || 'ç”¨æˆ¶'}: \"${signal.matchedKeyword}\"`);\r\n        this.updateConversionStage(execution, 'intent', customerData.text);\r\n        \r\n        // ç™¼é€å‰ç«¯é€šçŸ¥\r\n        this.ipc.send('ai-team:conversion-signal', {\r\n          executionId: execution.id,\r\n          userId: customerData.userId,\r\n          userName: customerData.firstName || customerData.username,\r\n          signal: signal.matchedKeyword,\r\n          signalType: signal.signalType,\r\n          score: signal.score\r\n        });\r\n        break;\r\n        \r\n      case 'medium':\r\n        // ä¸­æ„å‘ - ç¹¼çºŒè·Ÿé€²\r\n        this.updateConversionStage(execution, 'interest', customerData.text);\r\n        break;\r\n        \r\n      case 'positive':\r\n        // æ­£é¢åé¥‹ - æ›´æ–°èˆˆè¶£åˆ†\r\n        if (execution.conversionFunnel?.currentStage === 'contact') {\r\n          this.updateConversionStage(execution, 'response', customerData.text);\r\n        }\r\n        break;\r\n        \r\n      case 'negative':\r\n        // è² é¢åé¥‹ - è€ƒæ…®åœæ­¢æˆ–åˆ‡æ›ç­–ç•¥\r\n        this.toast.warning(`âš ï¸ å®¢æˆ¶ ${customerData.firstName || 'ç”¨æˆ¶'} è¡¨é”äº†æ‹’çµ•æ„å‘`);\r\n        \r\n        // å¯ä»¥è€ƒæ…®è‡ªå‹•è·³éæ­¤ç”¨æˆ¶\r\n        // this.skipCurrentUser();\r\n        break;\r\n    }\r\n    \r\n    // æ›´æ–°åŸ·è¡Œç‹€æ…‹\r\n    this._currentExecution.set({ ...execution });\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• æ›´æ–°æ„å‘è©•åˆ†\r\n   */\r\n  private updateIntentScore(execution: ExecutionState, message: string): void {\r\n    const signal = this.detectConversionSignal(message);\r\n    if (signal.score !== 0) {\r\n      execution.stats.interestScore = Math.max(0, Math.min(100, \r\n        (execution.stats.interestScore || 0) + signal.score\r\n      ));\r\n      this._currentExecution.set({ ...execution });\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æª¢æŸ¥è½‰åŒ–ä¿¡è™Ÿï¼ˆç„¡åŠ‡æœ¬æ¨¡å¼ï¼‰- èˆŠç‰ˆå…¼å®¹\r\n   */\r\n  private async checkConversionSignals(execution: ExecutionState, customerMessage: string): Promise<void> {\r\n    if (!execution.scriptlessConfig) return;\r\n    \r\n    const lowerMsg = customerMessage.toLowerCase();\r\n    \r\n    // æª¢æŸ¥è½‰åŒ–ä¿¡è™Ÿ\r\n    const hasConversionSignal = execution.scriptlessConfig.targetConversionSignals.some(\r\n      signal => lowerMsg.includes(signal)\r\n    );\r\n    \r\n    if (hasConversionSignal) {\r\n      console.log('[DynamicEngine] æª¢æ¸¬åˆ°è½‰åŒ–ä¿¡è™Ÿ:', customerMessage);\r\n      \r\n      execution.conversionFunnel?.keyMoments.push({\r\n        message: customerMessage,\r\n        trigger: 'è½‰åŒ–ä¿¡è™Ÿ',\r\n        stage: 'conversion_signal',\r\n        timestamp: new Date().toISOString()\r\n      });\r\n      \r\n      // è‡ªå‹•åˆ‡æ›åˆ°ä¿ƒå–®è§’è‰²\r\n      this.ipc.send('ai-team:conversion-signal', {\r\n        executionId: execution.id,\r\n        signal: customerMessage,\r\n        recommendedRole: 'sales_expert'\r\n      });\r\n      \r\n      this.toast.success('ğŸ¯ æª¢æ¸¬åˆ°è½‰åŒ–ä¿¡è™Ÿï¼æ­£åœ¨å®‰æ’éŠ·å”®å°ˆå®¶è·Ÿé€²...');\r\n    }\r\n    \r\n    // æª¢æŸ¥æˆåŠŸä¿¡è™Ÿ\r\n    const hasSuccessSignal = execution.scriptlessConfig.exitConditions.successSignals.some(\r\n      signal => lowerMsg.includes(signal)\r\n    );\r\n    \r\n    if (hasSuccessSignal) {\r\n      console.log('[DynamicEngine] æª¢æ¸¬åˆ°æˆåŠŸä¿¡è™Ÿ:', customerMessage);\r\n      this.updateConversionStage(execution, 'conversion', customerMessage);\r\n      this.toast.success('ğŸ‰ æ­å–œï¼å®¢æˆ¶å·²è½‰åŒ–æˆåŠŸï¼');\r\n    }\r\n    \r\n    this._currentExecution.set({ ...execution });\r\n  }\r\n  \r\n  // ============ ğŸ†• ç„¡åŠ‡æœ¬æ¨¡å¼å°è©±ç”Ÿæˆ ============\r\n  \r\n  /**\r\n   * P0: ç„¡åŠ‡æœ¬æ¨¡å¼ - AI è‡ªä¸»ç”Ÿæˆä¸‹ä¸€æ¢å°è©±\r\n   */\r\n  async generateScriptlessMessage(execution: ExecutionState): Promise<{\r\n    roleId: string;\r\n    roleName: string;\r\n    content: string;\r\n    reasoning: string;\r\n  } | null> {\r\n    if (execution.mode !== 'scriptless' || !execution.scriptlessConfig?.enabled) {\r\n      return null;\r\n    }\r\n    \r\n    const lastAnalysis = execution.stats.lastAnalysis;\r\n    const messageHistory = execution.messageHistory || [];\r\n    const currentPhase = execution.stats.currentPhase;\r\n    \r\n    // é¸æ“‡æœ€é©åˆçš„è§’è‰²\r\n    const selectedRole = this.selectRoleForScriptless(execution, lastAnalysis);\r\n    if (!selectedRole) return null;\r\n    \r\n    // æ§‹å»º AI ç”Ÿæˆ Prompt\r\n    const prompt = this.buildScriptlessPrompt(execution, selectedRole, messageHistory);\r\n    \r\n    // èª¿ç”¨å¾Œç«¯ AI ç”Ÿæˆ\r\n    return new Promise((resolve) => {\r\n      this.ipc.send('ai-team:generate-scriptless-message', {\r\n        executionId: execution.id,\r\n        roleId: selectedRole.id,\r\n        roleName: selectedRole.name,\r\n        rolePersonality: selectedRole.personality,\r\n        roleSpeakingStyle: selectedRole.speakingStyle,\r\n        prompt,\r\n        context: {\r\n          goal: execution.goal,\r\n          intent: execution.intent,\r\n          messageCount: messageHistory.length,\r\n          interestScore: execution.stats.interestScore,\r\n          currentStage: execution.conversionFunnel?.currentStage\r\n        }\r\n      });\r\n      \r\n      // ç›£è½ç”Ÿæˆçµæœ\r\n      this.ipc.once('ai-team:scriptless-message-generated', (data: any) => {\r\n        if (data.executionId === execution.id) {\r\n          resolve({\r\n            roleId: selectedRole.id,\r\n            roleName: selectedRole.name,\r\n            content: data.content,\r\n            reasoning: data.reasoning || 'æ ¹æ“šä¸Šä¸‹æ–‡è‡ªå‹•ç”Ÿæˆ'\r\n          });\r\n        } else {\r\n          resolve(null);\r\n        }\r\n      });\r\n      \r\n      // è¶…æ™‚è™•ç†\r\n      setTimeout(() => resolve(null), 30000);\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * ç‚ºç„¡åŠ‡æœ¬æ¨¡å¼é¸æ“‡è§’è‰²\r\n   */\r\n  private selectRoleForScriptless(\r\n    execution: ExecutionState,\r\n    analysis: RealtimeAnalysis | null | undefined\r\n  ): RecommendedRole | null {\r\n    if (execution.roles.length === 0) return null;\r\n    \r\n    // æ ¹æ“šåˆ†æå»ºè­°é¸æ“‡è§’è‰²\r\n    if (analysis?.suggestions.recommendedRole) {\r\n      const recommended = execution.roles.find(r => r.id === analysis.suggestions.recommendedRole);\r\n      if (recommended) return recommended;\r\n    }\r\n    \r\n    // é¿å…é€£çºŒä½¿ç”¨åŒä¸€å€‹è§’è‰²ï¼ˆæœ€å¤š 3 æ¢ï¼‰\r\n    const recentRoles = (execution.messageHistory || [])\r\n      .slice(-3)\r\n      .filter(m => !m.isFromCustomer)\r\n      .map(m => m.role);\r\n    \r\n    const lastRole = recentRoles[recentRoles.length - 1];\r\n    const sameRoleCount = recentRoles.filter(r => r === lastRole).length;\r\n    \r\n    if (sameRoleCount >= 3) {\r\n      // æ›ä¸€å€‹è§’è‰²\r\n      const otherRoles = execution.roles.filter(r => r.id !== lastRole);\r\n      if (otherRoles.length > 0) {\r\n        return otherRoles[Math.floor(Math.random() * otherRoles.length)];\r\n      }\r\n    }\r\n    \r\n    // æ ¹æ“šè½‰åŒ–éšæ®µé¸æ“‡\r\n    const stage = execution.conversionFunnel?.currentStage;\r\n    if (stage === 'interest' || stage === 'intent') {\r\n      const expert = execution.roles.find(r => r.type === 'professional');\r\n      if (expert) return expert;\r\n    }\r\n    \r\n    // é»˜èªè¿”å›ç¬¬ä¸€å€‹è§’è‰²\r\n    return execution.roles[0];\r\n  }\r\n  \r\n  /**\r\n   * æ§‹å»ºç„¡åŠ‡æœ¬æ¨¡å¼ Prompt\r\n   */\r\n  private buildScriptlessPrompt(\r\n    execution: ExecutionState,\r\n    role: RecommendedRole,\r\n    messageHistory: { role: string; content: string; isFromCustomer: boolean }[]\r\n  ): string {\r\n    const recentMessages = messageHistory.slice(-20);\r\n    const historyText = recentMessages.map(m => \r\n      `${m.isFromCustomer ? 'ã€å®¢æˆ¶ã€‘' : `ã€${m.role}ã€‘`}: ${m.content}`\r\n    ).join('\\n');\r\n    \r\n    const stage = execution.conversionFunnel?.currentStage || 'contact';\r\n    const stageGoals: Record<string, string> = {\r\n      'contact': 'å»ºç«‹è¯ç¹«ï¼Œè‡ªç„¶é–‹å ´',\r\n      'response': 'ä¿æŒäº’å‹•ï¼Œäº†è§£éœ€æ±‚',\r\n      'interest': 'æ·±å…¥ä»‹ç´¹ï¼Œå¼·èª¿åƒ¹å€¼',\r\n      'intent': 'è™•ç†ç•°è­°ï¼Œæ¨å‹•æ±ºç­–',\r\n      'conversion': 'ä¿ƒæˆæˆäº¤ï¼Œç¢ºèªè¨‚å–®'\r\n    };\r\n    \r\n    return `ä½ æ˜¯ ${role.name}ï¼Œ${role.personality}ã€‚\r\n\r\nã€èªªè©±é¢¨æ ¼ã€‘\r\n${role.speakingStyle}\r\n\r\nã€ç•¶å‰ç›®æ¨™ã€‘\r\n${execution.goal}\r\n\r\nã€ç•¶å‰éšæ®µã€‘\r\n${stage} - ${stageGoals[stage] || 'ç¹¼çºŒå°è©±'}\r\n\r\nã€å®¢æˆ¶èˆˆè¶£åº¦ã€‘\r\n${execution.stats.interestScore}/100\r\n\r\nã€å°è©±æ­·å²ã€‘\r\n${historyText || 'ï¼ˆæš«ç„¡å°è©±ï¼‰'}\r\n\r\nã€ä»»å‹™ã€‘\r\nä½œç‚º ${role.name}ï¼Œæ ¹æ“šä¸Šä¸‹æ–‡ç”Ÿæˆä¸€æ¢è‡ªç„¶çš„å›è¦†ã€‚\r\n- ä¿æŒè§’è‰²äººè¨­\r\n- æ¨é€²å°è©±ç›®æ¨™\r\n- ä¸è¦ç”Ÿç¡¬æ¨éŠ·\r\n- åƒçœŸäººèŠå¤©ä¸€æ¨£è‡ªç„¶\r\n- å–®æ¢æ¶ˆæ¯ä¸è¶…é 100 å­—\r\n\r\nè«‹ç›´æ¥è¼¸å‡ºæ¶ˆæ¯å…§å®¹ï¼Œä¸è¦æœ‰ä»»ä½•å‰ç¶´æˆ–è§£é‡‹ï¼š`;\r\n  }\r\n  \r\n  // ============ åŸ·è¡Œæ§åˆ¶ ============\r\n  \r\n  /**\r\n   * ç¢ºèªä¸¦é–‹å§‹åŸ·è¡Œ\r\n   */\r\n  confirmAndStart(executionId: string): boolean {\r\n    const execution = this._executions().find(e => e.id === executionId);\r\n    if (!execution) return false;\r\n    \r\n    execution.status = 'running';\r\n    this._currentExecution.set(execution);\r\n    this._executions.update(list => list.map(e => e.id === executionId ? execution : e));\r\n    \r\n    this.toast.success('AI åœ˜éšŠå·²é–‹å§‹å·¥ä½œï¼');\r\n    \r\n    // å•Ÿå‹•å¾Œç«¯ AI åŸ·è¡Œä»»å‹™\r\n    this.startBackendExecution(execution);\r\n    \r\n    return true;\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• P0: é–‹å§‹ç§èŠè½‰åŒ–åŸ·è¡Œ\r\n   * è‡ªå‹•ç™¼é€é¦–æ¢æ¶ˆæ¯çµ¦ç›®æ¨™ç”¨æˆ¶\r\n   * ğŸ”§ Phase 7: ä¿®å¾©ç‚ºä¸¦è¡Œç™¼é€çµ¦æ‰€æœ‰ç›®æ¨™ç”¨æˆ¶\r\n   */\r\n  beginPrivateChatExecution(execution: ExecutionState): void {\r\n    if (!execution.targetUsers || execution.targetUsers.length === 0) {\r\n      this.toast.warning('æ²’æœ‰ç›®æ¨™ç”¨æˆ¶ï¼Œç„¡æ³•é–‹å§‹ç§èŠ');\r\n      return;\r\n    }\r\n    \r\n    // æ›´æ–°åŸ·è¡Œç‹€æ…‹ç‚ºé‹è¡Œä¸­\r\n    execution.status = 'running';\r\n    this._currentExecution.set({ ...execution });\r\n    \r\n    console.log('[DynamicEngine] ğŸš€ é–‹å§‹ç§èŠåŸ·è¡Œ:', {\r\n      executionId: execution.id,\r\n      targetUsers: execution.targetUsers.length,\r\n      mode: execution.mode,\r\n      roles: execution.roles?.length\r\n    });\r\n    \r\n    // å•Ÿå‹•å¾Œç«¯åŸ·è¡Œ\r\n    this.startBackendExecution(execution);\r\n    \r\n    // ğŸ”§ Phase 7: ä¸¦è¡Œç™¼é€é¦–æ¢æ¶ˆæ¯çµ¦æ‰€æœ‰ç›®æ¨™ç”¨æˆ¶\r\n    this.sendFirstMessageToAllUsers(execution);\r\n    \r\n    this.toast.success(`ğŸš€ é–‹å§‹ç§èŠè½‰åŒ–ï¼ç›®æ¨™ï¼š${execution.targetUsers.length} äºº`);\r\n  }\r\n  \r\n  /**\r\n   * ğŸ”§ Phase 7: ä¸¦è¡Œç™¼é€é¦–æ¢æ¶ˆæ¯çµ¦æ‰€æœ‰ç›®æ¨™ç”¨æˆ¶\r\n   */\r\n  private async sendFirstMessageToAllUsers(execution: ExecutionState): Promise<void> {\r\n    const targetUsers = execution.targetUsers || [];\r\n    const accountMatches = execution.accountMatches || [];\r\n    \r\n    if (targetUsers.length === 0) {\r\n      console.log('[DynamicEngine] ç„¡ç›®æ¨™ç”¨æˆ¶');\r\n      return;\r\n    }\r\n    \r\n    if (accountMatches.length === 0) {\r\n      this.toast.error('ç„¡å¯ç”¨å¸³è™Ÿç™¼é€æ¶ˆæ¯');\r\n      return;\r\n    }\r\n    \r\n    console.log(`[DynamicEngine] ğŸ”„ ä¸¦è¡Œç™¼é€é¦–æ¢æ¶ˆæ¯çµ¦ ${targetUsers.length} å€‹ç›®æ¨™ç”¨æˆ¶`);\r\n    \r\n    // ç‚ºæ¯å€‹ç›®æ¨™ç”¨æˆ¶ç™¼é€æ¶ˆæ¯ï¼ˆä½¿ç”¨ä¸åŒå¸³è™Ÿè¼ªæ›ï¼‰\r\n    for (let i = 0; i < targetUsers.length; i++) {\r\n      const targetUser = targetUsers[i];\r\n      // è¼ªæ›ä½¿ç”¨å¸³è™Ÿ\r\n      const accountMatch = accountMatches[i % accountMatches.length];\r\n      \r\n      const userName = targetUser.firstName || targetUser.username || targetUser.id;\r\n      console.log(`[DynamicEngine] ğŸ“¤ ç™¼é€çµ¦ç”¨æˆ¶ ${i + 1}/${targetUsers.length}: ${userName}`);\r\n      \r\n      // ç”Ÿæˆä¸¦ç™¼é€é¦–æ¢æ¶ˆæ¯\r\n      this.sendFirstMessageToUser(execution, targetUser, accountMatch, i);\r\n      \r\n      // çŸ­æš«å»¶é²é¿å… Telegram é™åˆ¶ï¼ˆ100-300msï¼‰\r\n      if (i < targetUsers.length - 1) {\r\n        await new Promise(r => setTimeout(r, 100 + Math.random() * 200));\r\n      }\r\n    }\r\n    \r\n    this.toast.info(`ğŸ“¤ å·²ç™¼é€é¦–æ¢æ¶ˆæ¯çµ¦ ${targetUsers.length} å€‹ç›®æ¨™ç”¨æˆ¶`);\r\n  }\r\n  \r\n  /**\r\n   * ğŸ”§ Phase 7: ç™¼é€é¦–æ¢æ¶ˆæ¯çµ¦æŒ‡å®šç”¨æˆ¶\r\n   */\r\n  private async sendFirstMessageToUser(\r\n    execution: ExecutionState,\r\n    targetUser: any,\r\n    accountMatch: any,\r\n    userIndex: number\r\n  ): Promise<void> {\r\n    const userName = targetUser.firstName || targetUser.username || targetUser.id;\r\n    const targetUserId = targetUser.telegramId || targetUser.id;\r\n    \r\n    // ç”Ÿæˆé¦–æ¢æ¶ˆæ¯\r\n    const firstMessage = await this.generateFirstTouchMessage(execution, {\r\n      id: targetUserId,\r\n      name: userName\r\n    });\r\n    \r\n    if (firstMessage) {\r\n      // ç™¼é€åˆ°å¾Œç«¯åŸ·è¡Œå¯¦éš›çš„ç§èŠç™¼é€\r\n      this.ipc.send('ai-team:send-private-message', {\r\n        executionId: execution.id,\r\n        accountId: accountMatch.accountId,\r\n        accountPhone: accountMatch.accountPhone,\r\n        roleId: accountMatch.roleId,\r\n        roleName: accountMatch.roleName,\r\n        targetUserId: targetUserId,\r\n        targetUserName: userName,\r\n        content: firstMessage,\r\n        isFirstTouch: true,\r\n        userIndex: userIndex\r\n      });\r\n      \r\n      // è¨˜éŒ„åˆ°æ¶ˆæ¯æ­·å²\r\n      if (!execution.messageHistory) execution.messageHistory = [];\r\n      execution.messageHistory.push({\r\n        role: accountMatch.roleName,\r\n        content: firstMessage,\r\n        timestamp: new Date().toISOString(),\r\n        isFromCustomer: false\r\n      });\r\n      \r\n      execution.stats.messagesSent++;\r\n      this._currentExecution.set({ ...execution });\r\n      \r\n      console.log(`[DynamicEngine] âœ“ é¦–æ¢æ¶ˆæ¯å·²ç™¼é€çµ¦ ${userName}:`, firstMessage.substring(0, 50) + '...');\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• P0: ç™¼é€é¦–æ¢è§¸é”æ¶ˆæ¯\r\n   */\r\n  private async sendFirstMessage(execution: ExecutionState): Promise<void> {\r\n    const currentUser = execution.queue?.currentUser;\r\n    if (!currentUser) {\r\n      console.log('[DynamicEngine] ç„¡ç•¶å‰ç›®æ¨™ç”¨æˆ¶');\r\n      return;\r\n    }\r\n    \r\n    // é¸æ“‡ç¬¬ä¸€å€‹è§’è‰²ï¼ˆé€šå¸¸æ˜¯å®¢æˆ¶ç¶“ç†ï¼‰ç™¼é€é¦–æ¢æ¶ˆæ¯\r\n    const firstRole = execution.roles?.[0];\r\n    const firstMatch = execution.accountMatches?.find(m => m.roleId === firstRole?.id) || execution.accountMatches?.[0];\r\n    \r\n    if (!firstMatch) {\r\n      this.toast.error('ç„¡å¯ç”¨å¸³è™Ÿç™¼é€æ¶ˆæ¯');\r\n      return;\r\n    }\r\n    \r\n    // ç”Ÿæˆé¦–æ¢æ¶ˆæ¯\r\n    const firstMessage = await this.generateFirstTouchMessage(execution, currentUser);\r\n    \r\n    if (firstMessage) {\r\n      // ç™¼é€åˆ°å¾Œç«¯åŸ·è¡Œå¯¦éš›çš„ç§èŠç™¼é€\r\n      this.ipc.send('ai-team:send-private-message', {\r\n        executionId: execution.id,\r\n        accountId: firstMatch.accountId,\r\n        accountPhone: firstMatch.accountPhone,\r\n        roleId: firstMatch.roleId,\r\n        roleName: firstMatch.roleName,\r\n        targetUserId: currentUser.id,\r\n        targetUserName: currentUser.name,\r\n        content: firstMessage,\r\n        isFirstTouch: true\r\n      });\r\n      \r\n      // è¨˜éŒ„åˆ°æ¶ˆæ¯æ­·å²\r\n      if (!execution.messageHistory) execution.messageHistory = [];\r\n      execution.messageHistory.push({\r\n        role: firstMatch.roleName,\r\n        content: firstMessage,\r\n        timestamp: new Date().toISOString(),\r\n        isFromCustomer: false\r\n      });\r\n      \r\n      execution.stats.messagesSent++;\r\n      this._currentExecution.set({ ...execution });\r\n      \r\n      console.log('[DynamicEngine] é¦–æ¢æ¶ˆæ¯å·²ç™¼é€:', firstMessage.substring(0, 50) + '...');\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• P0: ç”Ÿæˆé¦–æ¬¡è§¸é”æ¶ˆæ¯\r\n   */\r\n  private async generateFirstTouchMessage(\r\n    execution: ExecutionState,\r\n    targetUser: { id: string; name: string }\r\n  ): Promise<string | null> {\r\n    // å¦‚æœæœ‰ç‡ŸéŠ·æ•¸æ“šä¸­çš„æ¨¡æ¿ï¼Œä½¿ç”¨æ¨¡æ¿\r\n    if (execution.marketingData?.messageTemplates?.firstTouch) {\r\n      return execution.marketingData.messageTemplates.firstTouch\r\n        .replace('{name}', targetUser.name)\r\n        .replace('{goal}', execution.goal);\r\n    }\r\n    \r\n    // å¦å‰‡ä½¿ç”¨ AI ç”Ÿæˆ\r\n    return new Promise((resolve) => {\r\n      const prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å®¢æˆ¶ç¶“ç†ï¼Œéœ€è¦ä¸»å‹•è¯ç¹«ä¸€ä½æ½›åœ¨å®¢æˆ¶ã€‚\r\n\r\nç›®æ¨™ï¼š${execution.goal}\r\nå®¢æˆ¶åç¨±ï¼š${targetUser.name}\r\n\r\nè«‹ç”Ÿæˆä¸€æ¢ç°¡çŸ­ã€å‹å¥½ã€è‡ªç„¶çš„é¦–æ¬¡å•å€™æ¶ˆæ¯ã€‚è¦æ±‚ï¼š\r\n1. ä¸è¦å¤ªéŠ·å”®åŒ–ï¼Œåƒæœ‹å‹ä¸€æ¨£æ‰“æ‹›å‘¼\r\n2. å¯ä»¥æåŠå°æ–¹å¯èƒ½æ„Ÿèˆˆè¶£çš„è©±é¡Œ\r\n3. ç°¡çŸ­ï¼ˆ1-2å¥è©±ï¼‰\r\n4. å¼•èµ·å°æ–¹å›è¦†çš„èˆˆè¶£\r\n\r\nç›´æ¥è¼¸å‡ºæ¶ˆæ¯å…§å®¹ï¼š`;\r\n\r\n      this.ipc.send('ai:generate-text', {\r\n        prompt,\r\n        maxTokens: 100,\r\n        callback: 'ai-team:first-message-generated'\r\n      });\r\n      \r\n      // è¨­ç½®è¶…æ™‚ï¼Œå¦‚æœ AI æ²’éŸ¿æ‡‰å‰‡ä½¿ç”¨é»˜èªæ¨¡æ¿\r\n      const timeout = setTimeout(() => {\r\n        const defaultMessage = `æ‚¨å¥½ï¼æˆ‘æ˜¯${execution.roles?.[0]?.name || 'å®¢æˆ¶ç¶“ç†'}ï¼Œæ³¨æ„åˆ°æ‚¨å¯èƒ½å°æˆ‘å€‘çš„æœå‹™æ„Ÿèˆˆè¶£ï¼Œæ–¹ä¾¿èŠèŠå—ï¼Ÿ`;\r\n        resolve(defaultMessage);\r\n      }, 5000);\r\n      \r\n      // ç›£è½ä¸€æ¬¡æ€§éŸ¿æ‡‰\r\n      const cleanup = this.ipc.on('ai-team:first-message-generated', (data: { text: string }) => {\r\n        clearTimeout(timeout);\r\n        cleanup();\r\n        resolve(data.text || `æ‚¨å¥½ï¼è«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«æ‚¨çš„å—ï¼Ÿ`);\r\n      });\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * å•Ÿå‹•å¾Œç«¯ AI åŸ·è¡Œä»»å‹™ï¼ˆå¢å¼·ç‰ˆï¼‰\r\n   */\r\n  private startBackendExecution(execution: ExecutionState): void {\r\n    console.log('[DynamicEngine] å•Ÿå‹•å¾Œç«¯åŸ·è¡Œ:', execution.id, 'æ¨¡å¼:', execution.mode);\r\n    console.log('[DynamicEngine] ğŸ” èª¿è©¦ - roles:', execution.roles?.length, execution.roles);\r\n    console.log('[DynamicEngine] ğŸ” èª¿è©¦ - accountMatches:', execution.accountMatches?.length, execution.accountMatches);\r\n    console.log('[DynamicEngine] ğŸ” èª¿è©¦ - targetUsers:', execution.targetUsers?.length);\r\n    \r\n    // ç™¼é€åˆ°å¾Œç«¯é–‹å§‹ AI åœ˜éšŠåŸ·è¡Œ\r\n    this.ipc.send('ai-team:start-execution', {\r\n      executionId: execution.id,\r\n      goal: execution.goal,\r\n      intent: execution.intent,\r\n      strategy: execution.strategy,\r\n      roles: execution.roles,\r\n      marketingData: execution.marketingData,\r\n      // ğŸ†• æ–°å¢åƒæ•¸\r\n      mode: execution.mode,\r\n      accountMatches: execution.accountMatches,\r\n      scriptlessConfig: execution.scriptlessConfig,\r\n      analysisInterval: this.analysisInterval,\r\n      targetUsers: execution.targetUsers  // ğŸ†• ç›®æ¨™ç”¨æˆ¶åˆ—è¡¨\r\n    });\r\n    \r\n    // ç›£è½åŸ·è¡Œé€²åº¦æ›´æ–°\r\n    this.setupExecutionListeners(execution.id);\r\n    \r\n    // ğŸ†• ç„¡åŠ‡æœ¬æ¨¡å¼ï¼šå•Ÿå‹•è‡ªå‹•å°è©±ç”Ÿæˆå¾ªç’°\r\n    if (execution.mode === 'scriptless') {\r\n      this.startScriptlessLoop(execution);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• å•Ÿå‹•ç„¡åŠ‡æœ¬æ¨¡å¼å°è©±å¾ªç’°\r\n   */\r\n  private async startScriptlessLoop(execution: ExecutionState): Promise<void> {\r\n    console.log('[DynamicEngine] å•Ÿå‹•ç„¡åŠ‡æœ¬æ¨¡å¼å°è©±å¾ªç’°');\r\n    \r\n    // ç”Ÿæˆç¬¬ä¸€æ¢æ¶ˆæ¯\r\n    const firstMessage = await this.generateScriptlessMessage(execution);\r\n    if (firstMessage) {\r\n      this.ipc.send('ai-team:send-scriptless-message', {\r\n        executionId: execution.id,\r\n        roleId: firstMessage.roleId,\r\n        content: firstMessage.content\r\n      });\r\n      \r\n      execution.stats.messagesSent++;\r\n      this._currentExecution.set({ ...execution });\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * è¨­ç½®åŸ·è¡Œç›£è½å™¨\r\n   */\r\n  private setupExecutionListeners(executionId: string): void {\r\n    // ç›£è½æ¶ˆæ¯ç™¼é€æˆåŠŸ\r\n    this.ipc.on('ai-team:message-sent', (data: any) => {\r\n      if (data.executionId === executionId) {\r\n        this.updateExecutionStats(executionId, {\r\n          messagesSent: data.totalSent\r\n        });\r\n      }\r\n    });\r\n    \r\n    // ç›£è½æ”¶åˆ°å›è¦†\r\n    this.ipc.on('ai-team:response-received', (data: any) => {\r\n      if (data.executionId === executionId) {\r\n        this.updateExecutionStats(executionId, {\r\n          responsesReceived: data.totalResponses,\r\n          interestScore: data.interestScore\r\n        });\r\n      }\r\n    });\r\n    \r\n    // ç›£è½éšæ®µè®ŠåŒ–\r\n    this.ipc.on('ai-team:phase-changed', (data: any) => {\r\n      if (data.executionId === executionId) {\r\n        this.updateExecutionStats(executionId, {\r\n          currentPhase: data.phase\r\n        });\r\n        this.toast.info(`ğŸ“Š é€²å…¥éšæ®µ ${data.phase + 1}: ${data.phaseName}`);\r\n      }\r\n    });\r\n    \r\n    // ç›£è½åŸ·è¡Œå®Œæˆ\r\n    this.ipc.on('ai-team:execution-completed', (data: any) => {\r\n      if (data.executionId === executionId) {\r\n        this.updateExecutionStatus(executionId, 'completed');\r\n        this.toast.success(`ğŸ‰ ä»»å‹™å®Œæˆï¼ç™¼é€ ${data.totalSent} æ¢æ¶ˆæ¯ï¼Œæ”¶åˆ° ${data.totalResponses} å€‹å›è¦†`);\r\n      }\r\n    });\r\n    \r\n    // ğŸ†• ç›£è½å®¢æˆ¶å›è¦†ï¼ˆå¢å¼·ç‰ˆï¼šå«è½‰åŒ–ä¿¡è™Ÿæª¢æ¸¬ï¼‰\r\n    this.ipc.on('ai-team:customer-reply', async (data: any) => {\r\n      if (data.executionId === executionId) {\r\n        console.log('[DynamicEngine] æ”¶åˆ°å®¢æˆ¶å›è¦†:', data.firstName, data.text?.substring(0, 50));\r\n        \r\n        // æ›´æ–°çµ±è¨ˆ\r\n        this.updateExecutionStats(executionId, {\r\n          responsesReceived: data.totalResponses\r\n        });\r\n        \r\n        // æ·»åŠ åˆ°æ¶ˆæ¯æ­·å²\r\n        const execution = this._currentExecution();\r\n        if (execution) {\r\n          if (!execution.messageHistory) execution.messageHistory = [];\r\n          execution.messageHistory.push({\r\n            role: 'customer',\r\n            content: data.text,\r\n            timestamp: new Date().toISOString(),\r\n            isFromCustomer: true\r\n          });\r\n          this._currentExecution.set({ ...execution });\r\n          \r\n          // ğŸ†• P1: æª¢æ¸¬è½‰åŒ–ä¿¡è™Ÿ\r\n          const signalResult = this.detectConversionSignal(data.text);\r\n          if (signalResult.hasSignal) {\r\n            this.handleConversionSignal(execution, data, signalResult);\r\n          }\r\n          \r\n          // ğŸ†• æ›´æ–°æ„å‘è©•åˆ†\r\n          this.updateIntentScore(execution, data.text);\r\n        }\r\n        \r\n        this.toast.info(`ğŸ’¬ å®¢æˆ¶ ${data.firstName || data.username} å›è¦†äº†æ¶ˆæ¯`);\r\n      }\r\n    });\r\n    \r\n    // ğŸ†• ç›£è½è§¸ç™¼ä¸‹ä¸€æ¢æ¶ˆæ¯çš„äº‹ä»¶ï¼ˆå¢å¼·ç‰ˆï¼šç§èŠ + è§’è‰²åˆ‡æ› + æ“¬äººåŒ–å»¶é²ï¼‰\r\n    this.ipc.on('ai-team:trigger-next-message', async (data: any) => {\r\n      if (data.executionId === executionId) {\r\n        console.log('[DynamicEngine] è§¸ç™¼ä¸‹ä¸€æ¢æ¶ˆæ¯:', data.customerName);\r\n        \r\n        const execution = this._currentExecution();\r\n        if (!execution || execution.status !== 'running') return;\r\n        \r\n        // åŠ‡æœ¬æ¨¡å¼è·³éè‡ªå‹•ç”Ÿæˆ\r\n        if (execution.mode === 'scripted') return;\r\n        \r\n        // ğŸ†• æ·»åŠ æ“¬äººåŒ–å»¶é²ï¼ˆ15-45ç§’éš¨æ©Ÿï¼Œæ¨¡æ“¬æ€è€ƒå’Œæ‰“å­—æ™‚é–“ï¼‰\r\n        const thinkDelay = 15000 + Math.random() * 30000;\r\n        console.log(`[DynamicEngine] æ“¬äººåŒ–å»¶é² ${(thinkDelay / 1000).toFixed(1)} ç§’å¾Œå›è¦†`);\r\n        \r\n        await new Promise(resolve => setTimeout(resolve, thinkDelay));\r\n        \r\n        // å†æ¬¡æª¢æŸ¥ç‹€æ…‹ï¼ˆå¯èƒ½å·²è¢«æš«åœï¼‰\r\n        const currentExec = this._currentExecution();\r\n        if (!currentExec || currentExec.status !== 'running') return;\r\n        \r\n        // åŸ·è¡Œå‹•æ…‹åˆ†æï¼ˆå¦‚æœé”åˆ°é–“éš”ï¼‰\r\n        const messageCount = currentExec.messageHistory?.length || 0;\r\n        if (messageCount > 0 && messageCount % this.analysisInterval === 0) {\r\n          await this.performDynamicAnalysis(currentExec);\r\n        }\r\n        \r\n        // ğŸ†• æ™ºèƒ½é¸æ“‡è§’è‰²ï¼ˆåŸºæ–¼å°è©±å…§å®¹ï¼‰\r\n        const selectedRole = this.selectRoleForAutoReply(currentExec, data.customerMessage);\r\n        const match = currentExec.accountMatches?.find(m => m.roleId === selectedRole?.id) || currentExec.accountMatches?.[0];\r\n        \r\n        if (!match) {\r\n          console.log('[DynamicEngine] ç„¡å¯ç”¨å¸³è™Ÿç™¼é€å›è¦†');\r\n          return;\r\n        }\r\n        \r\n        // ç”Ÿæˆå›è¦†æ¶ˆæ¯\r\n        const nextMessage = await this.generateScriptlessMessage(currentExec);\r\n        \r\n        if (nextMessage) {\r\n          // ğŸ†• ä½¿ç”¨ç§èŠç™¼é€\r\n          this.ipc.send('ai-team:send-private-message', {\r\n            executionId: currentExec.id,\r\n            accountId: match.accountId,\r\n            accountPhone: match.accountPhone,\r\n            roleId: match.roleId,\r\n            roleName: match.roleName,\r\n            targetUserId: data.customerId,\r\n            targetUserName: data.customerName,\r\n            content: nextMessage.content,\r\n            isFirstTouch: false\r\n          });\r\n          \r\n          // è¨˜éŒ„åˆ°æ¶ˆæ¯æ­·å²\r\n          if (!currentExec.messageHistory) currentExec.messageHistory = [];\r\n          currentExec.messageHistory.push({\r\n            role: match.roleName,\r\n            content: nextMessage.content,\r\n            timestamp: new Date().toISOString(),\r\n            isFromCustomer: false\r\n          });\r\n          \r\n          currentExec.stats.messagesSent++;\r\n          this._currentExecution.set({ ...currentExec });\r\n        }\r\n      }\r\n    });\r\n    \r\n    // ğŸ†• ç›£è½ç§èŠæ¶ˆæ¯ç™¼é€æˆåŠŸ\r\n    this.ipc.on('ai-team:private-message-sent', (data: any) => {\r\n      if (data.executionId === executionId && data.success) {\r\n        console.log('[DynamicEngine] âœ… ç§èŠç™¼é€æˆåŠŸ:', data.targetUserName);\r\n      }\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• æ™ºèƒ½é¸æ“‡å›è¦†è§’è‰²\r\n   */\r\n  private selectRoleForAutoReply(\r\n    execution: ExecutionState,\r\n    customerMessage?: string\r\n  ): RecommendedRole | undefined {\r\n    const roles = execution.roles || [];\r\n    if (roles.length === 0) return undefined;\r\n    if (roles.length === 1) return roles[0];\r\n    \r\n    const lowerMsg = customerMessage?.toLowerCase() || '';\r\n    \r\n    // åƒ¹æ ¼/è³¼è²·ç›¸é—œ â†’ æœå‹™å°ˆå“¡\r\n    if (lowerMsg.includes('å¤šå°‘éŒ¢') || lowerMsg.includes('åƒ¹æ ¼') || lowerMsg.includes('è²·') || lowerMsg.includes('ä»˜æ¬¾')) {\r\n      return roles.find(r => r.name.includes('æœå‹™') || r.name.includes('å°ˆå“¡')) || roles[0];\r\n    }\r\n    \r\n    // å°ˆæ¥­å•é¡Œ â†’ æ–¹æ¡ˆå°ˆå®¶\r\n    if (lowerMsg.includes('æ€éº¼') || lowerMsg.includes('å¦‚ä½•') || lowerMsg.includes('ä»€éº¼')) {\r\n      return roles.find(r => r.name.includes('å°ˆå®¶') || r.name.includes('é¡§å•')) || roles[0];\r\n    }\r\n    \r\n    // è¼ªæ›è§’è‰²ï¼Œé¿å…é€£çºŒä½¿ç”¨åŒä¸€è§’è‰²\r\n    const recentRoles = (execution.messageHistory || [])\r\n      .filter(m => !m.isFromCustomer)\r\n      .slice(-3)\r\n      .map(m => m.role);\r\n    \r\n    const lastRole = recentRoles[recentRoles.length - 1];\r\n    const availableRoles = roles.filter(r => r.name !== lastRole);\r\n    \r\n    return availableRoles.length > 0 \r\n      ? availableRoles[Math.floor(Math.random() * availableRoles.length)]\r\n      : roles[0];\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°åŸ·è¡Œçµ±è¨ˆ\r\n   */\r\n  private updateExecutionStats(executionId: string, updates: Partial<ExecutionState['stats']>): void {\r\n    const execution = this._executions().find(e => e.id === executionId);\r\n    if (!execution) return;\r\n    \r\n    execution.stats = { ...execution.stats, ...updates };\r\n    this._executions.update(list => list.map(e => e.id === executionId ? execution : e));\r\n    \r\n    if (this._currentExecution()?.id === executionId) {\r\n      this._currentExecution.set(execution);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æš«åœåŸ·è¡Œ\r\n   */\r\n  pauseExecution(executionId: string): boolean {\r\n    return this.updateExecutionStatus(executionId, 'paused');\r\n  }\r\n  \r\n  /**\r\n   * æ¢å¾©åŸ·è¡Œ\r\n   */\r\n  resumeExecution(executionId: string): boolean {\r\n    return this.updateExecutionStatus(executionId, 'running');\r\n  }\r\n  \r\n  /**\r\n   * åœæ­¢åŸ·è¡Œ\r\n   */\r\n  stopExecution(executionId: string): boolean {\r\n    return this.updateExecutionStatus(executionId, 'completed');\r\n  }\r\n  \r\n  private updateExecutionStatus(executionId: string, status: ExecutionState['status']): boolean {\r\n    const execution = this._executions().find(e => e.id === executionId);\r\n    if (!execution) return false;\r\n    \r\n    execution.status = status;\r\n    this._executions.update(list => list.map(e => e.id === executionId ? execution : e));\r\n    \r\n    if (this._currentExecution()?.id === executionId) {\r\n      this._currentExecution.set(execution);\r\n    }\r\n    \r\n    return true;\r\n  }\r\n  \r\n  // ============ ğŸ†• ä»»å‹™éšŠåˆ—ç®¡ç† ============\r\n  \r\n  /**\r\n   * æ¨™è¨˜ç•¶å‰ç”¨æˆ¶å®Œæˆä¸¦ç§»å‹•åˆ°ä¸‹ä¸€å€‹\r\n   */\r\n  completeCurrentUser(result: 'converted' | 'interested' | 'neutral' | 'rejected' | 'no_response'): boolean {\r\n    const execution = this._currentExecution();\r\n    if (!execution?.queue?.currentUser) return false;\r\n    \r\n    const currentUser = execution.queue.currentUser;\r\n    const startTime = new Date(currentUser.startTime).getTime();\r\n    const duration = Math.round((Date.now() - startTime) / 1000);\r\n    \r\n    // æ·»åŠ åˆ°å·²å®Œæˆåˆ—è¡¨\r\n    execution.queue.completedUsers.push({\r\n      id: currentUser.id,\r\n      name: currentUser.name,\r\n      result,\r\n      messagesExchanged: execution.messageHistory?.length || 0,\r\n      duration\r\n    });\r\n    \r\n    execution.queue.processedUsers++;\r\n    \r\n    // é€šçŸ¥å¾Œç«¯\r\n    this.ipc.send('ai-team:user-completed', {\r\n      executionId: execution.id,\r\n      userId: currentUser.id,\r\n      result,\r\n      duration\r\n    });\r\n    \r\n    // ç§»å‹•åˆ°ä¸‹ä¸€å€‹ç”¨æˆ¶\r\n    return this.moveToNextUser();\r\n  }\r\n  \r\n  /**\r\n   * ç§»å‹•åˆ°éšŠåˆ—ä¸­çš„ä¸‹ä¸€å€‹ç”¨æˆ¶\r\n   */\r\n  moveToNextUser(): boolean {\r\n    const execution = this._currentExecution();\r\n    if (!execution?.queue || !execution.targetUsers) return false;\r\n    \r\n    const nextUserId = execution.queue.pendingUsers.shift();\r\n    if (!nextUserId) {\r\n      // éšŠåˆ—å·²å®Œæˆ\r\n      this.toast.success(`ğŸ‰ æ‰€æœ‰ ${execution.queue.totalUsers} å€‹ç›®æ¨™ç”¨æˆ¶è™•ç†å®Œç•¢ï¼`);\r\n      execution.queue.currentUser = undefined;\r\n      this._currentExecution.set({ ...execution });\r\n      \r\n      // ç™¼é€å®Œæˆäº‹ä»¶\r\n      this.ipc.send('ai-team:queue-completed', {\r\n        executionId: execution.id,\r\n        stats: {\r\n          total: execution.queue.totalUsers,\r\n          completed: execution.queue.completedUsers.length,\r\n          results: this.calculateQueueResults(execution.queue.completedUsers)\r\n        }\r\n      });\r\n      \r\n      return false;\r\n    }\r\n    \r\n    // æ‰¾åˆ°ä¸‹ä¸€å€‹ç”¨æˆ¶\r\n    const nextUser = execution.targetUsers.find(u => String(u.id) === nextUserId);\r\n    if (!nextUser) return false;\r\n    \r\n    execution.queue.currentUserIndex++;\r\n    execution.queue.currentUser = {\r\n      id: nextUserId,\r\n      name: nextUser.firstName || nextUser.username || nextUserId,\r\n      startTime: new Date().toISOString()\r\n    };\r\n    \r\n    // æ¸…ç©ºæ¶ˆæ¯æ­·å²ï¼ˆæ–°ç”¨æˆ¶ï¼‰\r\n    execution.messageHistory = [];\r\n    execution.conversionFunnel = {\r\n      currentStage: 'contact',\r\n      stageHistory: [{ stage: 'contact', enteredAt: new Date().toISOString(), messageCount: 0 }],\r\n      keyMoments: []\r\n    };\r\n    \r\n    this._currentExecution.set({ ...execution });\r\n    \r\n    // é€šçŸ¥å¾Œç«¯é–‹å§‹è™•ç†æ–°ç”¨æˆ¶\r\n    this.ipc.send('ai-team:next-user', {\r\n      executionId: execution.id,\r\n      userId: nextUserId,\r\n      userName: execution.queue.currentUser.name,\r\n      userIndex: execution.queue.currentUserIndex,\r\n      remaining: execution.queue.pendingUsers.length\r\n    });\r\n    \r\n    this.toast.info(`ğŸ“‹ é–‹å§‹è™•ç†ç¬¬ ${execution.queue.currentUserIndex + 1}/${execution.queue.totalUsers} å€‹ç”¨æˆ¶ï¼š${execution.queue.currentUser.name}`);\r\n    \r\n    return true;\r\n  }\r\n  \r\n  /**\r\n   * è·³éç•¶å‰ç”¨æˆ¶\r\n   */\r\n  skipCurrentUser(): boolean {\r\n    return this.completeCurrentUser('no_response');\r\n  }\r\n  \r\n  /**\r\n   * è¨ˆç®—éšŠåˆ—çµæœçµ±è¨ˆ\r\n   */\r\n  private calculateQueueResults(completedUsers: { result: string }[]): { [key: string]: number } {\r\n    const results: { [key: string]: number } = {\r\n      converted: 0,\r\n      interested: 0,\r\n      neutral: 0,\r\n      rejected: 0,\r\n      no_response: 0\r\n    };\r\n    \r\n    completedUsers.forEach(u => {\r\n      if (results[u.result] !== undefined) {\r\n        results[u.result]++;\r\n      }\r\n    });\r\n    \r\n    return results;\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["template", "signal"]
}
