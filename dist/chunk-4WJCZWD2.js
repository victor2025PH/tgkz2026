import{a as E}from"./chunk-I2LH4V4V.js";import{e as x,g as w}from"./chunk-FF535MQ4.js";import{o as y}from"./chunk-35776WZA.js";import{La as p,O as l,T as g,U as u,Ya as h,Za as f,da as m,gb as o,hb as i,ib as _,jb as b,ob as C,pb as d,xa as c,xb as s,yb as v}from"./chunk-MB4RORS3.js";function T(a,t){a&1&&(o(0,"div",1),_(1,"div",3),o(2,"p"),s(3,"\u6B63\u5728\u8655\u7406 Telegram \u767B\u5165..."),i()())}function M(a,t){if(a&1){let n=b();o(0,"div",2)(1,"span",4),s(2,"\u26A0\uFE0F"),i(),o(3,"h3"),s(4,"\u767B\u5165\u5931\u6557"),i(),o(5,"p"),s(6),i(),o(7,"button",5),C("click",function(){g(n);let r=d();return u(r.goToLogin())}),s(8,"\u8FD4\u56DE\u767B\u5165"),i()()}if(a&2){let n=d();c(6),v(n.error())}}var k=class a{constructor(){this.authService=l(E);this.router=l(w);this.route=l(x);this.isLoading=m(!0);this.error=m(null)}async ngOnInit(){try{let t=null,n=window.location.hash;if(n&&n.includes("tgAuthResult=")){let e=n.match(/tgAuthResult=([^&]+)/);if(e&&e[1])try{let r=atob(e[1]);t=JSON.parse(r),console.log("Telegram auth data from tgAuthResult:",t)}catch(r){console.error("Failed to parse tgAuthResult:",r)}}if(!t){let e=this.route.snapshot.queryParams;e.id&&e.hash&&(t={id:e.id,first_name:e.first_name,last_name:e.last_name,username:e.username,photo_url:e.photo_url,auth_date:e.auth_date,hash:e.hash})}if(!t){let e=this.route.snapshot.fragment;if(e&&e.includes("id=")){let r=new URLSearchParams(e);t={id:r.get("id"),first_name:r.get("first_name"),last_name:r.get("last_name"),username:r.get("username"),photo_url:r.get("photo_url"),auth_date:r.get("auth_date"),hash:r.get("hash")}}}if(!t||!t.id)throw new Error("\u7F3A\u5C11 Telegram \u8A8D\u8B49\u6578\u64DA");await this.processTelegramAuth(t)}catch(t){console.error("Telegram callback error:",t),this.error.set(t.message||"Telegram \u767B\u5165\u5931\u6557")}finally{this.isLoading.set(!1)}}async processTelegramAuth(t){if(!t.id||!t.hash)throw new Error("\u7121\u6548\u7684 Telegram \u8A8D\u8B49\u6578\u64DA");let n=await this.authService.telegramLogin(t);if(n.success){let e=sessionStorage.getItem("auth_return_url")||"/";sessionStorage.removeItem("auth_return_url"),window.opener?(window.opener.postMessage({type:"telegram_auth",auth:t},window.location.origin),window.close()):this.router.navigateByUrl(e)}else throw new Error(n.error||"Telegram \u767B\u5165\u5931\u6557")}goToLogin(){this.router.navigate(["/auth/login"])}static{this.\u0275fac=function(n){return new(n||a)}}static{this.\u0275cmp=p({type:a,selectors:[["app-telegram-callback"]],decls:3,vars:1,consts:[[1,"callback-page"],[1,"loading"],[1,"error"],[1,"spinner"],[1,"error-icon"],[1,"back-btn",3,"click"]],template:function(n,e){n&1&&(o(0,"div",0),h(1,T,4,0,"div",1)(2,M,9,1,"div",2),i()),n&2&&(c(),f(e.isLoading()?1:e.error()?2:-1))},dependencies:[y],styles:[".callback-page[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg-primary, #0a0a0a);color:var(--text-primary, #fff)}.loading[_ngcontent-%COMP%]{text-align:center}.spinner[_ngcontent-%COMP%]{width:48px;height:48px;border:3px solid rgba(255,255,255,.1);border-top-color:var(--primary, #3b82f6);border-radius:50%;animation:_ngcontent-%COMP%_spin 1s linear infinite;margin:0 auto 1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.error[_ngcontent-%COMP%]{text-align:center;padding:2rem;background:var(--bg-secondary, #1a1a1a);border-radius:12px;max-width:400px}.error-icon[_ngcontent-%COMP%]{font-size:3rem;display:block;margin-bottom:1rem}.error[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin-bottom:.5rem;color:#f87171}.error[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--text-secondary, #888);margin-bottom:1.5rem}.back-btn[_ngcontent-%COMP%]{padding:.75rem 1.5rem;background:var(--primary, #3b82f6);border:none;border-radius:8px;color:#fff;font-size:1rem;cursor:pointer;transition:opacity .2s}.back-btn[_ngcontent-%COMP%]:hover{opacity:.9}"],changeDetection:0})}};export{k as TelegramCallbackComponent};
