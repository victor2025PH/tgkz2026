import{a as p}from"./chunk-TMNXXRHZ.js";import{M as c,R as m,Zb as y,a as o,b as d,ga as s}from"./chunk-PDD6YQ47.js";var g=class l{constructor(){this.api=m(p);this._summary=s(null);this.summary=this._summary.asReadonly();this._leadSources=s([]);this.leadSources=this._leadSources.asReadonly();this._templatePerf=s([]);this.templatePerf=this._templatePerf.asReadonly();this._dailyTrends=s([]);this.dailyTrends=this._dailyTrends.asReadonly();this._funnelData=s([]);this.funnelData=this._funnelData.asReadonly();this._abTests=s([]);this.abTests=this._abTests.asReadonly();this._retryInfo=s(null);this.retryInfo=this._retryInfo.asReadonly();this._dedupStats=s(null);this.dedupStats=this._dedupStats.asReadonly();this._duplicateGroups=s([]);this.duplicateGroups=this._duplicateGroups.asReadonly();this._loading=s({});this.loading=this._loading.asReadonly();this._lastError=s("");this.lastError=this._lastError.asReadonly();this.isAnyLoading=y(()=>Object.values(this._loading()).some(t=>t));this._scoreResults=s([]);this.scoreResults=this._scoreResults.asReadonly()}setLoading(t,e){this._loading.update(a=>d(o({},a),{[t]:e}))}async loadSummary(t){this.setLoading("summary",!0);try{let e=t?`?user_id=${t}`:"",a=await this.api.get(`/api/v1/analytics/summary${e}`,{cache:!0,ttl:6e4});return a.success&&a.data?.data?(this._summary.set(a.data.data),a.data.data):a.success&&a.data?(this._summary.set(a.data),a.data):null}catch(e){return this._lastError.set(e.message||"Failed to load summary"),null}finally{this.setLoading("summary",!1)}}async loadLeadSources(t=30){this.setLoading("sources",!0);try{let e=await this.api.get(`/api/v1/analytics/sources?days=${t}`,{cache:!0,ttl:6e4}),a=e.data?.data||e.data||[];return this._leadSources.set(Array.isArray(a)?a:[]),this._leadSources()}catch{return[]}finally{this.setLoading("sources",!1)}}async loadTemplatePerformance(t=30){this.setLoading("templates",!0);try{let e=await this.api.get(`/api/v1/analytics/templates?days=${t}`,{cache:!0,ttl:6e4}),a=e.data?.data||e.data||[];return this._templatePerf.set(Array.isArray(a)?a:[]),this._templatePerf()}catch{return[]}finally{this.setLoading("templates",!1)}}async loadDailyTrends(t=30){this.setLoading("trends",!0);try{let e=await this.api.get(`/api/v1/analytics/trends?days=${t}`,{cache:!0,ttl:6e4}),a=e.data?.data||e.data||[];return this._dailyTrends.set(Array.isArray(a)?a:[]),this._dailyTrends()}catch{return[]}finally{this.setLoading("trends",!1)}}async loadFunnel(t){this.setLoading("funnel",!0);try{let e=t?`?user_id=${t}`:"",a=await this.api.get(`/api/v1/analytics/funnel${e}`,{cache:!0,ttl:6e4}),n=a.data?.data||a.data||[];return this._funnelData.set(Array.isArray(n)?n:[]),this._funnelData()}catch{return[]}finally{this.setLoading("funnel",!1)}}async loadAllAnalytics(t=30){await Promise.all([this.loadSummary(),this.loadLeadSources(t),this.loadTemplatePerformance(t),this.loadDailyTrends(t),this.loadFunnel()])}async scoreLeads(t){this.setLoading("scoring",!0);try{let e=await this.api.post("/api/v1/leads/score",{lead_ids:t||[]}),a=e.data?.data?.results||e.data?.results||[];return this._scoreResults.set(a),a.length>0&&this.syncScoresToLocal(a),a}catch{return[]}finally{this.setLoading("scoring",!1)}}syncScoresToLocal(t){try{let e=localStorage.getItem("tg_leads_data");if(!e)return;let a=JSON.parse(e),n=new Map;t.forEach(r=>n.set(r.id,r));let u=!1;for(let r of a){let i=n.get(r.id);i&&(r.lead_score=i.lead_score,r.intent_level=i.intent_level,r.value_level=i.value_level,r.intent_score=i.intent_score,r.quality_score=i.quality_score,r.activity_score=i.activity_score,u=!0)}u&&localStorage.setItem("tg_leads_data",JSON.stringify(a))}catch(e){console.warn("[BusinessApi] Score sync to localStorage failed:",e)}}async pullScoredLeads(t=200){try{let e=await this.api.get("/api/v1/analytics/summary",{cache:!1});return this._scoreResults()}catch{return[]}}async scanDuplicates(t=50){this.setLoading("dedup",!0);try{let e=await this.api.get(`/api/v1/leads/dedup/scan?limit=${t}`);if(e.success){let a=e.data?.data||e.data||{};this._duplicateGroups.set(a.duplicate_groups||[]),this._dedupStats.set(a.stats||null)}}catch(e){this._lastError.set(e.message||"Failed to scan duplicates")}finally{this.setLoading("dedup",!1)}}async mergeDuplicates(t,e){this.setLoading("merge",!0);try{return(await this.api.post("/api/v1/leads/dedup/merge",{primary_id:t,duplicate_ids:e})).success?(await this.scanDuplicates(),!0):!1}catch{return!1}finally{this.setLoading("merge",!1)}}async loadRetrySchedule(){this.setLoading("retry",!0);try{let t=await this.api.get("/api/v1/retry/schedule",{cache:!0,ttl:3e5}),e=t.data?.data||t.data;return e?(this._retryInfo.set(e),e):null}catch{return null}finally{this.setLoading("retry",!1)}}async loadABTests(){this.setLoading("abTests",!0);try{let t=await this.api.get("/api/v1/ab-tests"),e=t.data?.data||t.data||[];return this._abTests.set(Array.isArray(e)?e:[]),this._abTests()}catch{return[]}finally{this.setLoading("abTests",!1)}}async createABTest(t,e,a){this.setLoading("abCreate",!0);try{let n=await this.api.post("/api/v1/ab-tests",{name:t,template_ids:e,template_names:a});return n.success?(await this.loadABTests(),n.data?.data||n.data):null}catch{return null}finally{this.setLoading("abCreate",!1)}}async getABTest(t){try{let e=await this.api.get(`/api/v1/ab-tests/${t}`);return e.data?.data||e.data||null}catch{return null}}async completeABTest(t){this.setLoading("abComplete",!0);try{let e=await this.api.post(`/api/v1/ab-tests/${t}/complete`,{});return e.success?(await this.loadABTests(),e.data?.data||e.data):null}catch{return null}finally{this.setLoading("abComplete",!1)}}static{this.\u0275fac=function(e){return new(e||l)}}static{this.\u0275prov=c({token:l,factory:l.\u0275fac,providedIn:"root"})}};export{g as a};
