import{a as Z}from"./chunk-VSSEQNUC.js";import{e as W,g as G,h as z,j as B}from"./chunk-IOZ6RGE3.js";import{a as $,b as H,c as K,d as j,e as q,f as Y,g as X,p as V,t as J}from"./chunk-3FNGYHNZ.js";import{b as Q}from"./chunk-ET36GW2V.js";import{o as F}from"./chunk-HDSZBSQ2.js";import{Eb as P,Fb as S,Gb as E,J as N,La as U,O as f,Vb as m,Ya as C,Za as w,a as I,b as R,cb as _,da as d,db as o,eb as a,fb as O,nb as x,pb as k,xa as r,xb as c,yb as g,zb as L}from"./chunk-XBIFDY2N.js";var A={COOKIE_NAME:"csrf_token",HEADER_NAME:"X-CSRF-Token",STORAGE_KEY:"tgm_csrf_token"},p={MAX_ATTEMPTS:5,LOCKOUT_DURATION:300,ATTEMPT_WINDOW:900,STORAGE_KEY:"tgm_login_attempts"},T=class l{constructor(){this._csrfToken=d("");this.csrfToken=m(()=>this._csrfToken());this._isLocked=d(!1);this._lockoutRemaining=d(0);this._attemptCount=d(0);this.isLocked=m(()=>this._isLocked());this.lockoutRemaining=m(()=>this._lockoutRemaining());this.attemptCount=m(()=>this._attemptCount());this.attemptsLeft=m(()=>Math.max(0,p.MAX_ATTEMPTS-this._attemptCount()));this.refreshCsrfToken()}refreshCsrfToken(){let e=this.getCookie(A.COOKIE_NAME);e&&this._csrfToken.set(e)}getCsrfToken(){return this._csrfToken()}getCsrfHeaders(){let e=this.getCsrfToken();return e?{[A.HEADER_NAME]:e}:{}}async secureFetch(e,n={}){let t=new Headers(n.headers),i=this.getCsrfToken();i&&t.set(A.HEADER_NAME,i),t.has("Content-Type")||t.set("Content-Type","application/json");let s=await fetch(e,R(I({},n),{headers:t,credentials:"include"}));return this.refreshCsrfToken(),s}canAttemptLogin(){let e=this.getLockoutData(),n=Date.now();if(e.lockedUntil>n){let i=Math.ceil((e.lockedUntil-n)/1e3);return this._isLocked.set(!0),this._lockoutRemaining.set(i),{allowed:!1,message:`\u767B\u5165\u5617\u8A66\u6B21\u6578\u904E\u591A\uFF0C\u8ACB ${this.formatDuration(i)} \u5F8C\u518D\u8A66`,waitSeconds:i}}this._isLocked.set(!1),this._lockoutRemaining.set(0);let t=this.getRecentAttempts(e.attempts);if(this._attemptCount.set(t.length),t.length>=p.MAX_ATTEMPTS){let i=n+p.LOCKOUT_DURATION*1e3;this.setLockout(i,e.attempts);let s=p.LOCKOUT_DURATION;return this._isLocked.set(!0),this._lockoutRemaining.set(s),{allowed:!1,message:`\u767B\u5165\u5617\u8A66\u6B21\u6578\u904E\u591A\uFF0C\u8ACB ${this.formatDuration(s)} \u5F8C\u518D\u8A66`,waitSeconds:s}}return{allowed:!0}}recordLoginAttempt(e,n){let t=this.getLockoutData();t.attempts.push({timestamp:Date.now(),success:e,email:n}),t.attempts=this.getRecentAttempts(t.attempts),e&&(t.lockedUntil=0,t.attempts=[]),this.saveLockoutData(t),this._attemptCount.set(t.attempts.filter(i=>!i.success).length)}clearLoginLimit(){localStorage.removeItem(p.STORAGE_KEY),this._isLocked.set(!1),this._lockoutRemaining.set(0),this._attemptCount.set(0)}getRecentAttempts(e){let n=Date.now()-p.ATTEMPT_WINDOW*1e3;return e.filter(t=>t.timestamp>n&&!t.success)}getLockoutData(){try{let e=localStorage.getItem(p.STORAGE_KEY);if(e)return JSON.parse(e)}catch(e){console.error("Failed to parse lockout data:",e)}return{lockedUntil:0,attempts:[]}}saveLockoutData(e){localStorage.setItem(p.STORAGE_KEY,JSON.stringify(e))}setLockout(e,n){this.saveLockoutData({lockedUntil:e,attempts:n})}sanitizeHtml(e){let n=document.createElement("div");return n.textContent=e,n.innerHTML}isUrlSafe(e){return!e||e.toLowerCase().startsWith("javascript:")||e.toLowerCase().startsWith("data:")&&!e.toLowerCase().startsWith("data:image/")?!1:!!(e.startsWith("/")||e.startsWith("http://")||e.startsWith("https://"))}escapeHtml(e){let n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,t=>n[t])}getCookie(e){let n=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return n?decodeURIComponent(n[2]):null}formatDuration(e){return e<60?`${e} \u79D2`:`${Math.ceil(e/60)} \u5206\u9418`}startLockoutCountdown(e){let n=setInterval(()=>{let t=this._lockoutRemaining();if(t<=0){clearInterval(n),this._isLocked.set(!1),e?.(0);return}this._lockoutRemaining.update(i=>i-1),e?.(t-1)},1e3);return()=>clearInterval(n)}static{this.\u0275fac=function(n){return new(n||l)}}static{this.\u0275prov=N({token:l,factory:l.\u0275fac,providedIn:"root"})}};function ne(l,e){if(l&1&&(o(0,"div",3)(1,"span",27),c(2,"\u{1F512}"),a(),o(3,"div",28)(4,"span",29),c(5,"\u5E33\u865F\u66AB\u6642\u9396\u5B9A"),a(),o(6,"span",30),c(7),a()()()),l&2){let n=k();r(7),L("\u8ACB\u7B49\u5F85 ",n.lockoutRemaining()," \u79D2\u5F8C\u91CD\u8A66")}}function oe(l,e){if(l&1&&(o(0,"div",4)(1,"span",31),c(2,"\u26A0\uFE0F"),a(),o(3,"span"),c(4),a()()),l&2){let n=k();r(4),g(n.error())}}function ie(l,e){if(l&1&&(O(0,"span",32),o(1,"span"),c(2),a()),l&2){let n=k();r(2),g(n.t("auth.loggingIn"))}}function re(l,e){if(l&1&&(o(0,"span"),c(1),a()),l&2){let n=k();r(),g(n.t("auth.login"))}}function ae(l,e){l&1&&O(0,"span",22)}function se(l,e){l&1&&(o(0,"span",23),c(1,"\u2708\uFE0F"),a())}var ee=class l{constructor(){this.authService=f(Z);this.router=f(G);this.route=f(W);this.i18n=f(Q);this.security=f(T);this.email="";this.password="";this.rememberMe=!1;this.showPassword=d(!1);this.isLoading=d(!1);this.telegramLoading=d(!1);this.error=d(null);this.isLocked=m(()=>this.security.isLocked());this.lockoutRemaining=m(()=>this.security.lockoutRemaining());this.attemptsLeft=m(()=>this.security.attemptsLeft());this.telegramBotUsername="";this.lockoutCleanup=null}ngOnInit(){this.checkLoginLimit()}ngOnDestroy(){this.lockoutCleanup?.()}checkLoginLimit(){let e=this.security.canAttemptLogin();e.allowed||(this.error.set(e.message||""),this.lockoutCleanup=this.security.startLockoutCountdown(n=>{n<=0&&this.error.set(null)}))}t(e){return this.i18n.t(e)}async onSubmit(){if(!this.email||!this.password)return;let e=this.security.canAttemptLogin();if(!e.allowed){this.error.set(e.message||"");return}this.isLoading.set(!0),this.error.set(null);try{let n=await this.authService.login({email:this.email,password:this.password,remember:this.rememberMe});if(n.success){this.security.recordLoginAttempt(!0,this.email);let t=this.route.snapshot.queryParams.returnUrl||"/";this.router.navigateByUrl(t)}else{this.security.recordLoginAttempt(!1,this.email);let t=this.security.attemptsLeft(),i=n.error||this.t("auth.loginFailed");t>0&&t<=3&&(i+=` (\u5269\u9918 ${t} \u6B21\u5617\u8A66\u6A5F\u6703)`),this.error.set(i),this.checkLoginLimit()}}catch(n){this.security.recordLoginAttempt(!1,this.email),this.error.set(n.message||this.t("auth.loginFailed")),this.checkLoginLimit()}finally{this.isLoading.set(!1)}}async socialLogin(e){e==="telegram"?await this.telegramLogin():e==="google"&&await this.googleLogin()}async googleLogin(){this.isLoading.set(!0),this.error.set(null);try{let n=await(await fetch("/api/v1/oauth/google/config")).json();if(!n.success||!n.data?.enabled){this.error.set(this.t("auth.googleNotAvailable"));return}this.openGoogleLoginPopup()}catch(e){console.error("Google login error:",e),this.error.set(this.t("auth.googleNotAvailable"))}finally{this.isLoading.set(!1)}}openGoogleLoginPopup(){let n=`${window.location.origin}/api/v1/oauth/google/callback`,t=`/api/v1/oauth/google/authorize?callback=${encodeURIComponent(n)}`,i=550,s=600,y=window.screenX+(window.outerWidth-i)/2,D=window.screenY+(window.outerHeight-s)/2,b=window.open(t,"GoogleAuth",`width=${i},height=${s},left=${y},top=${D},toolbar=no,menubar=no,scrollbars=yes`),h=async u=>{u.data&&u.data.type==="google_auth"?(window.removeEventListener("message",h),b?.close(),await this.handleGoogleAuth(u.data.auth)):u.data&&u.data.type==="google_auth_error"&&(window.removeEventListener("message",h),b?.close(),this.error.set(u.data.error||"Google \u767B\u5165\u5931\u6557"),this.isLoading.set(!1))};window.addEventListener("message",h);let v=setInterval(()=>{b?.closed&&(clearInterval(v),window.removeEventListener("message",h),this.isLoading.set(!1))},500)}async handleGoogleAuth(e){this.isLoading.set(!0);try{if(e.access_token&&e.user){localStorage.setItem("tgm_access_token",e.access_token),e.refresh_token&&localStorage.setItem("tgm_refresh_token",e.refresh_token),localStorage.setItem("tgm_user",JSON.stringify(e.user));let n=this.route.snapshot.queryParams.returnUrl||"/";window.location.href=n}else this.error.set("Google \u767B\u5165\u5931\u6557\uFF1A\u7121\u6548\u7684\u8A8D\u8B49\u6578\u64DA")}catch(n){this.error.set(n.message||"Google \u767B\u5165\u5931\u6557")}finally{this.isLoading.set(!1)}}async telegramLogin(){this.telegramLoading.set(!0),this.error.set(null);try{let e=await this.authService.getTelegramConfig();if(!e.enabled||!e.bot_username){this.error.set(this.t("auth.telegramNotConfigured"));return}this.telegramBotUsername=e.bot_username,this.openTelegramLoginPopup()}catch(e){console.error("Telegram login error:",e),this.error.set(e.message||"Telegram \u767B\u5165\u5931\u6557")}finally{this.telegramLoading.set(!1)}}openTelegramLoginPopup(){let e=this.telegramBotUsername,n=window.location.origin,t=`${n}/auth/telegram-callback`,i=`https://oauth.telegram.org/auth?bot_id=${e}&origin=${encodeURIComponent(n)}&request_access=write&return_to=${encodeURIComponent(t)}`,s=550,y=470,D=window.screenX+(window.outerWidth-s)/2,b=window.screenY+(window.outerHeight-y)/2,h=window.open(i,"TelegramAuth",`width=${s},height=${y},left=${D},top=${b},toolbar=no,menubar=no,scrollbars=no`),v=async M=>{M.origin===window.location.origin&&M.data&&M.data.type==="telegram_auth"&&(window.removeEventListener("message",v),h?.close(),await this.handleTelegramAuth(M.data.auth))};window.addEventListener("message",v);let u=setInterval(()=>{h?.closed&&(clearInterval(u),window.removeEventListener("message",v),this.telegramLoading.set(!1))},500)}async handleTelegramAuth(e){this.telegramLoading.set(!0);try{let n=await this.authService.telegramLogin(e);if(n.success){let t=this.route.snapshot.queryParams.returnUrl||"/";this.router.navigateByUrl(t)}else this.error.set(n.error||"Telegram \u767B\u5165\u5931\u6557")}catch(n){this.error.set(n.message||"Telegram \u767B\u5165\u5931\u6557")}finally{this.telegramLoading.set(!1)}}static{this.\u0275fac=function(n){return new(n||l)}}static{this.\u0275cmp=U({type:l,selectors:[["app-login"]],decls:48,vars:25,consts:[[1,"login-page"],[1,"page-title"],[1,"page-subtitle"],[1,"lockout-alert"],[1,"error-alert"],[1,"login-form",3,"ngSubmit"],[1,"form-group"],["for","email"],[1,"input-wrapper"],[1,"input-icon"],["type","email","id","email","name","email","required","","autocomplete","email",3,"ngModelChange","ngModel","placeholder","disabled"],["for","password"],["id","password","name","password","required","","autocomplete","current-password",3,"ngModelChange","type","ngModel","placeholder","disabled"],["type","button",1,"toggle-password",3,"click"],[1,"form-options"],[1,"checkbox-label"],["type","checkbox","name","rememberMe",3,"ngModelChange","ngModel"],["routerLink","/auth/forgot-password",1,"forgot-link"],["type","submit",1,"submit-btn",3,"disabled"],[1,"divider"],[1,"social-login"],[1,"social-btn","telegram","full-width",3,"click","disabled"],[1,"loading-spinner","small"],[1,"social-icon"],["id","telegram-login-widget",2,"display","none"],[1,"register-link"],["routerLink","/auth/register"],[1,"lockout-icon"],[1,"lockout-content"],[1,"lockout-title"],[1,"lockout-time"],[1,"error-icon"],[1,"loading-spinner"]],template:function(n,t){n&1&&(o(0,"div",0)(1,"h2",1),c(2),a(),o(3,"p",2),c(4),a(),C(5,ne,8,1,"div",3),C(6,oe,5,1,"div",4),o(7,"form",5),x("ngSubmit",function(){return t.onSubmit()}),o(8,"div",6)(9,"label",7),c(10),a(),o(11,"div",8)(12,"span",9),c(13,"\u{1F4E7}"),a(),o(14,"input",10),E("ngModelChange",function(s){return S(t.email,s)||(t.email=s),s}),a()()(),o(15,"div",6)(16,"label",11),c(17),a(),o(18,"div",8)(19,"span",9),c(20,"\u{1F512}"),a(),o(21,"input",12),E("ngModelChange",function(s){return S(t.password,s)||(t.password=s),s}),a(),o(22,"button",13),x("click",function(){return t.showPassword.set(!t.showPassword())}),c(23),a()()(),o(24,"div",14)(25,"label",15)(26,"input",16),E("ngModelChange",function(s){return S(t.rememberMe,s)||(t.rememberMe=s),s}),a(),o(27,"span"),c(28),a()(),o(29,"a",17),c(30),a()(),o(31,"button",18),C(32,ie,3,1)(33,re,2,1,"span"),a()(),o(34,"div",19)(35,"span"),c(36),a()(),o(37,"div",20)(38,"button",21),x("click",function(){return t.socialLogin("telegram")}),C(39,ae,1,0,"span",22)(40,se,2,0,"span",23),o(41,"span"),c(42),a()()(),O(43,"div",24),o(44,"p",25),c(45),o(46,"a",26),c(47),a()()()),n&2&&(r(2),g(t.t("auth.welcomeBack")),r(2),g(t.t("auth.loginSubtitle")),r(),w(t.isLocked()?5:-1),r(),w(t.error()&&!t.isLocked()?6:-1),r(4),g(t.t("auth.email")),r(4),P("ngModel",t.email),_("placeholder",t.t("auth.emailPlaceholder"))("disabled",t.isLoading()),r(3),g(t.t("auth.password")),r(4),_("type",t.showPassword()?"text":"password"),P("ngModel",t.password),_("placeholder",t.t("auth.passwordPlaceholder"))("disabled",t.isLoading()),r(2),L(" ",t.showPassword()?"\u{1F648}":"\u{1F441}\uFE0F"," "),r(3),P("ngModel",t.rememberMe),r(2),g(t.t("auth.rememberMe")),r(2),L(" ",t.t("auth.forgotPassword")," "),r(),_("disabled",t.isLoading()||!t.email||!t.password||t.isLocked()),r(),w(t.isLoading()?32:33),r(4),g(t.t("auth.or")),r(2),_("disabled",t.telegramLoading()),r(),w(t.telegramLoading()?39:40),r(3),g(t.t("auth.loginWithTelegram")),r(3),L(" ",t.t("auth.noAccount")," "),r(2),g(t.t("auth.registerNow")))},dependencies:[F,J,X,H,$,K,j,V,Y,q,B,z],styles:['.login-page[_ngcontent-%COMP%]{color:var(--text-primary, #fff)}.page-title[_ngcontent-%COMP%]{font-size:1.75rem;font-weight:700;margin-bottom:.5rem}.page-subtitle[_ngcontent-%COMP%]{color:var(--text-secondary, #888);margin-bottom:2rem}.error-alert[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;padding:.875rem 1rem;background:#ef44441a;border:1px solid rgba(239,68,68,.3);border-radius:8px;color:#f87171;margin-bottom:1.5rem;font-size:.875rem}.lockout-alert[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:1rem 1.25rem;background:#fb923c1a;border:1px solid rgba(251,146,60,.3);border-radius:8px;color:#fb923c;margin-bottom:1.5rem}.lockout-icon[_ngcontent-%COMP%]{font-size:1.5rem}.lockout-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.lockout-title[_ngcontent-%COMP%]{font-weight:600;font-size:.9rem}.lockout-time[_ngcontent-%COMP%]{font-size:.8rem;opacity:.8}.login-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.25rem}.form-group[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-size:.875rem;font-weight:500;color:var(--text-secondary, #aaa)}.input-wrapper[_ngcontent-%COMP%]{position:relative;display:flex;align-items:center}.input-icon[_ngcontent-%COMP%]{position:absolute;left:1rem;font-size:1rem;opacity:.5}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;padding:.875rem 1rem .875rem 2.75rem;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:8px;color:var(--text-primary, #fff);font-size:1rem;transition:all .2s ease}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--primary, #3b82f6);box-shadow:0 0 0 3px #3b82f61a}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]::placeholder{color:var(--text-muted, #666)}.toggle-password[_ngcontent-%COMP%]{position:absolute;right:1rem;background:none;border:none;cursor:pointer;font-size:1rem;opacity:.5;transition:opacity .2s}.toggle-password[_ngcontent-%COMP%]:hover{opacity:1}.form-options[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;font-size:.875rem}.checkbox-label[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;cursor:pointer;color:var(--text-secondary, #aaa)}.checkbox-label[_ngcontent-%COMP%]   input[type=checkbox][_ngcontent-%COMP%]{width:16px;height:16px;accent-color:var(--primary, #3b82f6)}.forgot-link[_ngcontent-%COMP%]{color:var(--primary, #3b82f6);text-decoration:none;transition:color .2s}.forgot-link[_ngcontent-%COMP%]:hover{color:var(--primary-hover, #60a5fa);text-decoration:underline}.submit-btn[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:.5rem;padding:.875rem 1.5rem;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border:none;border-radius:8px;color:#fff;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s ease;margin-top:.5rem}.submit-btn[_ngcontent-%COMP%]:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px #3b82f64d}.submit-btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.loading-spinner[_ngcontent-%COMP%]{width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.divider[_ngcontent-%COMP%]{display:flex;align-items:center;margin:1.5rem 0;color:var(--text-muted, #666);font-size:.875rem}.divider[_ngcontent-%COMP%]:before, .divider[_ngcontent-%COMP%]:after{content:"";flex:1;height:1px;background:var(--border-color, #333)}.divider[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{padding:0 1rem}.social-login[_ngcontent-%COMP%]{display:flex;gap:1rem}.social-btn[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1rem;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:8px;color:var(--text-primary, #fff);font-size:.875rem;cursor:pointer;transition:all .2s ease}.social-btn[_ngcontent-%COMP%]:hover{background:var(--bg-tertiary, #252525);border-color:var(--border-hover, #444)}.social-btn.google[_ngcontent-%COMP%]   .social-icon[_ngcontent-%COMP%]{color:#ea4335;font-weight:700}.social-btn.telegram[_ngcontent-%COMP%]   .social-icon[_ngcontent-%COMP%]{color:#08c}.social-btn.full-width[_ngcontent-%COMP%]{width:100%;flex:none}.social-btn.telegram[_ngcontent-%COMP%]{background:linear-gradient(135deg,#08c,#0077b5);border-color:#08c}.social-btn.telegram[_ngcontent-%COMP%]:hover{background:linear-gradient(135deg,#09d,#08c)}.loading-spinner.small[_ngcontent-%COMP%]{width:14px;height:14px;border-width:2px}.register-link[_ngcontent-%COMP%]{text-align:center;margin-top:1.5rem;color:var(--text-secondary, #888);font-size:.875rem}.register-link[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{color:var(--primary, #3b82f6);text-decoration:none;font-weight:500}.register-link[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]:hover{text-decoration:underline}'],changeDetection:0})}};export{ee as LoginComponent};
