import{a as b}from"./chunk-KD3U4L4Z.js";import{a as D}from"./chunk-6MHYDRXN.js";import{J as h,O as _,Wb as p,a as g,b as v,da as c}from"./chunk-MB4RORS3.js";var F=["\u9AD8\u610F\u5411","\u5F85\u8DDF\u9032","\u5DF2\u6210\u4EA4","\u6D41\u5931\u98A8\u96AA","VIP","\u65B0\u767C\u73FE","\u5DF2\u806F\u7E6B","\u9700\u8981\u5831\u50F9","\u6280\u8853\u8AEE\u8A62","\u6F5B\u5728\u5927\u5BA2\u6236"],w=[{value:"new",label:"\u65B0\u767C\u73FE",color:"bg-blue-500"},{value:"contacted",label:"\u5DF2\u806F\u7E6B",color:"bg-yellow-500"},{value:"interested",label:"\u6709\u610F\u5411",color:"bg-green-500"},{value:"negotiating",label:"\u6D3D\u8AC7\u4E2D",color:"bg-purple-500"},{value:"converted",label:"\u5DF2\u6210\u4EA4",color:"bg-emerald-500"},{value:"lost",label:"\u5DF2\u6D41\u5931",color:"bg-gray-500"},{value:"blocked",label:"\u5DF2\u5C01\u9396",color:"bg-red-500"},{value:"replied",label:"\u5DF2\u56DE\u8986",color:"bg-teal-500"},{value:"failed",label:"\u767C\u9001\u5931\u6557",color:"bg-rose-500"}],E=class l{constructor(){this.ipc=_(b);this._contacts=c([]);this.contacts=this._contacts.asReadonly();this._stats=c({total:0,users:0,groups:0,channels:0,by_status:{},by_source:{},recent_added:0});this.stats=this._stats.asReadonly();this._total=c(0);this.total=this._total.asReadonly();this._isLoading=c(!1);this.isLoading=this._isLoading.asReadonly();this._isSyncing=c(!1);this.isSyncing=this._isSyncing.asReadonly();this._hasImportedFromLeads=c(!1);this.hasData=p(()=>this._contacts().length>0||this._hasImportedFromLeads());this._filter=c({});this.filter=this._filter.asReadonly();this._selectedIds=c(new Set);this.selectedIds=this._selectedIds.asReadonly();this.selectedContacts=p(()=>{let e=this._selectedIds();return this._contacts().filter(t=>e.has(t.telegram_id))});this.setupIpcListeners()}setupIpcListeners(){this.ipc.on("unified-contacts:list",e=>{console.log("[UnifiedContacts] Received list:",e),this._isLoading.set(!1),e.success?(this._contacts.set(e.contacts||[]),this._total.set(e.total||0)):(console.error("[UnifiedContacts] List error:",e.error),this._contacts.set([]),this._total.set(0))}),this.ipc.on("unified-contacts:stats",e=>{console.log("[UnifiedContacts] Received stats:",e),e.success&&this._stats.set(e.stats)}),this.ipc.on("unified-contacts:sync-result",e=>{console.log("[UnifiedContacts] ========== SYNC RESULT =========="),console.log("[UnifiedContacts] Sync result:",e),this._isSyncing.set(!1),e.success?(console.log("[UnifiedContacts] Sync successful, stats:",e.stats),this.loadContacts(),this.loadStats()):console.error("[UnifiedContacts] Sync failed:",e.error)}),this.ipc.on("unified-contacts:update-result",e=>{console.log("[UnifiedContacts] Update result:",e),e.success&&this.loadContacts()}),this.ipc.on("unified-contacts:add-tags-result",e=>{console.log("[UnifiedContacts] Add tags result:",e),e.success&&this.loadContacts()}),this.ipc.on("unified-contacts:update-status-result",e=>{console.log("[UnifiedContacts] Update status result:",e),e.success&&this.loadContacts()}),this.ipc.on("unified-contacts:delete-result",e=>{if(console.log("[UnifiedContacts] Delete result:",e),e.success){let t=this._pendingDeleteIds||new Set,s=this._contacts().filter(i=>!t.has(i.telegram_id));this._contacts.set(s),this._total.set(s.length),this._selectedIds.set(new Set),this._pendingDeleteIds=void 0,this.updateLocalStats(s),console.log("[UnifiedContacts] Deleted successfully, remaining:",s.length)}})}syncFromSources(){console.log("[UnifiedContacts] ========== SYNC START =========="),console.log("[UnifiedContacts] Sending unified-contacts:sync to backend..."),this._isSyncing.set(!0);try{this.ipc.send("unified-contacts:sync",{}),console.log("[UnifiedContacts] IPC command sent successfully")}catch(e){console.error("[UnifiedContacts] Failed to send IPC command:",e),this._isSyncing.set(!1);return}setTimeout(()=>{this._isSyncing()&&(console.warn("[UnifiedContacts] Sync timeout after 60s, resetting state"),this._isSyncing.set(!1))},6e4)}forceEndSync(){console.log("[UnifiedContacts] Force ending all loading states..."),this._isSyncing.set(!1),this._isLoading.set(!1)}forceReloadContacts(e){console.log("[UnifiedContacts] Force reload contacts"),this._hasImportedFromLeads.set(!1);let t=e||this._filter();this._filter.set(t),this._isLoading.set(!0),this.ipc.send("unified-contacts:get",{contactType:t.contactType,sourceType:t.sourceType,status:t.status,tags:t.tags,search:t.search,orderBy:t.orderBy||"created_at DESC",limit:500,offset:0})}loadContacts(e){let t=e||this._filter();if(this._filter.set(t),this._hasImportedFromLeads()&&this._contacts().length>0){console.log("[UnifiedContacts] Data already imported from leads, skipping backend request"),this._isLoading.set(!1);return}console.log("[UnifiedContacts] Loading contacts with filter:",t),this._isLoading.set(!0),this.ipc.send("unified-contacts:get",{contactType:t.contactType,sourceType:t.sourceType,status:t.status,tags:t.tags,search:t.search,orderBy:t.orderBy||"created_at DESC",limit:t.limit||100,offset:t.offset||0}),setTimeout(()=>{this._isLoading()&&(console.warn("[UnifiedContacts] Load timeout, resetting state"),this._isLoading.set(!1))},15e3)}loadStats(){if(this._hasImportedFromLeads()){console.log("[UnifiedContacts] Stats already computed from leads, skipping backend request");return}console.log("[UnifiedContacts] Loading stats..."),this.ipc.send("unified-contacts:stats",{})}setFilter(e){let t=g(g({},this._filter()),e);this.loadContacts(t)}resetFilter(){this.loadContacts({})}search(e){this.setFilter({search:e,offset:0})}setPage(e,t=100){this.setFilter({offset:(e-1)*t,limit:t})}toggleSelect(e){let t=new Set(this._selectedIds());t.has(e)?t.delete(e):t.add(e),this._selectedIds.set(t)}toggleSelectAll(){let e=this._selectedIds(),t=this._contacts().map(n=>n.telegram_id);e.size===t.length?this._selectedIds.set(new Set):this._selectedIds.set(new Set(t))}clearSelection(){this._selectedIds.set(new Set)}updateContact(e,t){console.log("[UnifiedContacts] Updating contact:",e,t),this.ipc.send("unified-contacts:update",{telegramId:e,updates:t})}addTags(e,t){console.log("[UnifiedContacts] Adding tags:",e,t),this.ipc.send("unified-contacts:add-tags",{telegramIds:e,tags:t})}updateStatus(e,t){console.log("[UnifiedContacts] Updating status:",e,t),this.ipc.send("unified-contacts:update-status",{telegramIds:e,status:t})}deleteContacts(e){console.log("[UnifiedContacts] Deleting contacts:",e.length),this._pendingDeleteIds=new Set(e),this.ipc.send("unified-contacts:delete",{telegramIds:e})}updateLocalStats(e){let t={},n={};e.forEach(s=>{t[s.status]=(t[s.status]||0)+1,n[s.source_type]=(n[s.source_type]||0)+1}),this._stats.set({total:e.length,users:e.filter(s=>s.contact_type==="user").length,groups:e.filter(s=>s.contact_type==="group").length,channels:e.filter(s=>s.contact_type==="channel").length,by_status:t,by_source:n,recent_added:e.filter(s=>{let i=new Date(s.created_at),r=new Date;return r.setDate(r.getDate()-7),i>r}).length})}addTagsToSelected(e){let t=Array.from(this._selectedIds());t.length>0&&this.addTags(t,e)}updateSelectedStatus(e){let t=Array.from(this._selectedIds());t.length>0&&this.updateStatus(t,e)}deleteSelected(){let e=Array.from(this._selectedIds());e.length>0&&this.deleteContacts(e)}importFromExtraction(e,t){e.length&&(console.log("[UnifiedContacts] Importing from extraction:",e.length,"members from",t.sourceName),this.ipc.send("unified-contacts:import-members",{members:e.map(n=>({telegram_id:n.telegramId,username:n.username,first_name:n.firstName,last_name:n.lastName,display_name:n.displayName,phone:n.phone,is_bot:n.isBot,is_premium:n.isPremium,is_verified:n.isVerified,online_status:n.onlineStatus,last_seen:n.lastSeen,is_chinese:n.isChinese,activity_score:n.activityScore,value_level:n.valueLevel})),sourceType:t.sourceType,sourceName:t.sourceName,sourceId:t.sourceId}))}updateContactStatus(e,t){console.log("[UnifiedContacts] Updating single contact status:",e,t),this.updateContact(e,{status:t})}getSendTargets(){return this._contacts().filter(e=>e.contact_type==="user"&&!e.is_bot)}markAsContacted(e){this.updateStatus(e,"contacted")}getCountBySource(e){return this._contacts().filter(t=>t.source_type===e).length}getStatusColor(e){return w.find(n=>n.value===e)?.color||"bg-gray-500"}getStatusLabel(e){return w.find(n=>n.value===e)?.label||e}mapLeadStatus(e){return{New:"new",Contacted:"contacted",Replied:"interested",Interested:"interested","Follow-up":"negotiating",Negotiating:"negotiating","Closed-Won":"converted","Closed-Lost":"lost",Unsubscribed:"blocked"}[e]||"new"}importLeadsDirectly(e){if(console.log("[UnifiedContacts] Importing leads directly:",e.length),!e||e.length===0)return;let t=e.map((i,r)=>({id:i.id||r,telegram_id:String(i.userId||i.user_id||""),username:i.username||"",display_name:i.firstName||i.username||String(i.userId||""),first_name:i.firstName||"",last_name:i.lastName||"",phone:i.phone||"",contact_type:"user",source_type:i.sourceType==="group_extract"?"member":"lead",source_id:i.sourceChatId||i.campaignId?.toString()||"",source_name:i.sourceGroup||i.sourceChatTitle||"\u767C\u9001\u63A7\u5236\u53F0",status:this.mapLeadStatus(i.status||"New"),tags:i.tags||[],ai_score:i.aiScore||.5,activity_score:i.activityScore||.5,value_level:i.valueLevel||"C",is_online:i.onlineStatus==="Online",last_seen:i.lastSeen,is_bot:!1,is_premium:i.isPremium||!1,is_verified:i.isVerified||!1,member_count:0,message_count:(i.interactionHistory||[]).length,last_contact_at:i.lastContactAt,last_message_at:i.lastMessageAt,bio:i.bio||"",notes:i.notes||"",metadata:{},created_at:i.timestamp||new Date().toISOString(),updated_at:new Date().toISOString(),synced_at:new Date().toISOString()}));this._contacts.set(t),this._total.set(t.length);let n={},s={};t.forEach(i=>{n[i.status]=(n[i.status]||0)+1,s[i.source_type]=(s[i.source_type]||0)+1}),this._stats.set({total:t.length,users:t.length,groups:0,channels:0,by_status:n,by_source:s,recent_added:t.filter(i=>{let r=new Date(i.created_at),a=new Date;return a.setDate(a.getDate()-7),r>=a}).length}),this._isLoading.set(!1),this._isSyncing.set(!1),this._hasImportedFromLeads.set(!0),console.log("[UnifiedContacts] Imported",t.length,"contacts from leads")}resetImportState(){this._hasImportedFromLeads.set(!1)}ngOnDestroy(){}static{this.\u0275fac=function(t){return new(t||l)}}static{this.\u0275prov=h({token:l,factory:l.\u0275fac,providedIn:"root"})}};var x=[{id:"r1",action:"message_replied",name:"\u56DE\u8986\u6D88\u606F",description:"\u5BA2\u6236\u56DE\u8986\u4E86\u60A8\u7684\u6D88\u606F",points:10,enabled:!0,maxPerDay:5},{id:"r2",action:"positive_reply",name:"\u6B63\u9762\u56DE\u8986",description:"\u5BA2\u6236\u8868\u9054\u4E86\u8208\u8DA3\u6216\u7A4D\u6975\u614B\u5EA6",points:15,enabled:!0},{id:"r3",action:"question_asked",name:"\u4E3B\u52D5\u63D0\u554F",description:"\u5BA2\u6236\u4E3B\u52D5\u8A62\u554F\u7522\u54C1/\u670D\u52D9",points:20,enabled:!0},{id:"r4",action:"price_inquiry",name:"\u8A62\u554F\u50F9\u683C",description:"\u5BA2\u6236\u8A62\u554F\u50F9\u683C\uFF0C\u9AD8\u8CFC\u8CB7\u610F\u5411",points:25,enabled:!0},{id:"r5",action:"demo_requested",name:"\u8ACB\u6C42\u6F14\u793A",description:"\u5BA2\u6236\u8ACB\u6C42\u7522\u54C1\u6F14\u793A",points:30,enabled:!0},{id:"r6",action:"meeting_scheduled",name:"\u9810\u7D04\u6703\u8B70",description:"\u5BA2\u6236\u540C\u610F\u9810\u7D04\u6703\u8B70",points:40,enabled:!0},{id:"r7",action:"referral_made",name:"\u63A8\u85A6\u4ED6\u4EBA",description:"\u5BA2\u6236\u63A8\u85A6\u4E86\u5176\u4ED6\u6F5B\u5728\u5BA2\u6236",points:50,enabled:!0},{id:"r8",action:"message_sent",name:"\u767C\u9001\u6D88\u606F",description:"\u5411\u5BA2\u6236\u767C\u9001\u6D88\u606F",points:2,enabled:!0,maxPerDay:3},{id:"r9",action:"message_opened",name:"\u6253\u958B\u6D88\u606F",description:"\u5BA2\u6236\u6253\u958B\u4E86\u6D88\u606F",points:5,enabled:!0,maxPerDay:5},{id:"r10",action:"link_clicked",name:"\u9EDE\u64CA\u9023\u7D50",description:"\u5BA2\u6236\u9EDE\u64CA\u4E86\u6D88\u606F\u4E2D\u7684\u9023\u7D50",points:8,enabled:!0},{id:"r11",action:"negative_reply",name:"\u8CA0\u9762\u56DE\u8986",description:"\u5BA2\u6236\u8868\u9054\u4E0D\u611F\u8208\u8DA3",points:-10,enabled:!0},{id:"r12",action:"unsubscribed",name:"\u53D6\u6D88\u8A02\u95B1",description:"\u5BA2\u6236\u53D6\u6D88\u8A02\u95B1\u6216\u62C9\u9ED1",points:-30,enabled:!0},{id:"r13",action:"complained",name:"\u6295\u8A34",description:"\u5BA2\u6236\u6295\u8A34\u6216\u8209\u5831",points:-50,enabled:!0},{id:"r14",action:"inactive_7d",name:"7\u5929\u672A\u6D3B\u8E8D",description:"\u5BA2\u62367\u5929\u5167\u7121\u4EFB\u4F55\u4E92\u52D5",points:-5,enabled:!0},{id:"r15",action:"inactive_30d",name:"30\u5929\u672A\u6D3B\u8E8D",description:"\u5BA2\u623630\u5929\u5167\u7121\u4EFB\u4F55\u4E92\u52D5",points:-15,enabled:!0}],A=[{level:"cold",minScore:-100,maxScore:20,color:"#64748b",icon:"\u2744\uFE0F",label:"\u51B7\u6DE1"},{level:"warm",minScore:21,maxScore:50,color:"#eab308",icon:"\u{1F324}\uFE0F",label:"\u6EAB\u548C"},{level:"hot",minScore:51,maxScore:100,color:"#f97316",icon:"\u{1F525}",label:"\u71B1\u9580"},{level:"burning",minScore:101,maxScore:999,color:"#ef4444",icon:"\u{1F4A5}",label:"\u7206\u71B1"}],R=class l{constructor(){this.ipc=_(b);this.toast=_(D);this._rules=c(x);this.rules=this._rules.asReadonly();this._scores=c(new Map);this._globalHistory=c([]);this.globalHistory=this._globalHistory.asReadonly();this.stats=p(()=>{let e=Array.from(this._scores().values()),t={cold:e.filter(n=>n.heatLevel==="cold").length,warm:e.filter(n=>n.heatLevel==="warm").length,hot:e.filter(n=>n.heatLevel==="hot").length,burning:e.filter(n=>n.heatLevel==="burning").length};return{total:e.length,avgScore:e.length>0?e.reduce((n,s)=>n+s.totalScore,0)/e.length:0,byLevel:t,hotLeads:e.filter(n=>n.heatLevel==="hot"||n.heatLevel==="burning")}});this.loadData(),this.setupIpcListeners()}setupIpcListeners(){this.ipc.on("scoring:message-sent",e=>{this.recordAction(e.contactId,"message_sent")}),this.ipc.on("scoring:reply-received",e=>{e.sentiment&&e.sentiment>.3?this.recordAction(e.contactId,"positive_reply"):e.sentiment&&e.sentiment<-.3?this.recordAction(e.contactId,"negative_reply"):this.recordAction(e.contactId,"message_replied")}),this.ipc.on("scoring:price-inquiry",e=>{this.recordAction(e.contactId,"price_inquiry")})}loadData(){try{let e=localStorage.getItem("tg-matrix-scoring-rules");e&&this._rules.set(JSON.parse(e));let t=localStorage.getItem("tg-matrix-lead-scores");if(t){let s=JSON.parse(t),i=new Map;s.forEach(r=>i.set(r.contactId,r)),this._scores.set(i)}let n=localStorage.getItem("tg-matrix-scoring-history");n&&this._globalHistory.set(JSON.parse(n))}catch(e){console.error("Failed to load scoring data:",e)}}saveData(){try{localStorage.setItem("tg-matrix-scoring-rules",JSON.stringify(this._rules())),localStorage.setItem("tg-matrix-lead-scores",JSON.stringify(Array.from(this._scores().values()))),localStorage.setItem("tg-matrix-scoring-history",JSON.stringify(this._globalHistory().slice(0,1e3)))}catch(e){console.error("Failed to save scoring data:",e)}}recordAction(e,t,n){let s=this._rules().find(r=>r.action===t&&r.enabled);if(!s||s.maxPerDay&&this.getTodayActionCount(e,t)>=s.maxPerDay)return 0;if(s.cooldownMinutes){let r=this.getLastActionTime(e,t);if(r){let a=s.cooldownMinutes*60*1e3;if(Date.now()-new Date(r).getTime()<a)return 0}}let i={id:`sh_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,contactId:e,action:t,points:s.points,reason:s.name,timestamp:new Date().toISOString(),metadata:n};return this._globalHistory.update(r=>[i,...r.slice(0,999)]),this.updateScore(e,i),this.saveData(),s.points}updateScore(e,t){let n=this._scores(),s=n.get(e);s||(s=this.createNewScore(e)),s.history=[t,...s.history.slice(0,99)],s.totalScore=Math.max(-100,Math.min(999,s.totalScore+t.points)),this.updateCategoryScores(s),s.heatLevel=this.calculateHeatLevel(s.totalScore),s.lastActivity=t.timestamp,s.activityCount++,s.updatedAt=new Date().toISOString();let i=new Map(n);i.set(e,s),this._scores.set(i)}createNewScore(e){return{contactId:e,totalScore:0,heatLevel:"cold",behaviorScore:0,engagementScore:0,intentScore:0,recencyScore:0,activityCount:0,history:[],updatedAt:new Date().toISOString()}}updateCategoryScores(e){let t=e.history.slice(0,20),n=["message_replied","link_clicked","message_opened"];e.behaviorScore=t.filter(r=>n.includes(r.action)).reduce((r,a)=>r+a.points,0);let s=["positive_reply","question_asked"];e.engagementScore=t.filter(r=>s.includes(r.action)).reduce((r,a)=>r+a.points,0);let i=["price_inquiry","demo_requested","meeting_scheduled"];if(e.intentScore=t.filter(r=>i.includes(r.action)).reduce((r,a)=>r+a.points,0),e.lastActivity){let r=(Date.now()-new Date(e.lastActivity).getTime())/864e5;r<1?e.recencyScore=20:r<3?e.recencyScore=15:r<7?e.recencyScore=10:r<14?e.recencyScore=5:e.recencyScore=0}}calculateHeatLevel(e){for(let t of A)if(e>=t.minScore&&e<=t.maxScore)return t.level;return"cold"}getTodayActionCount(e,t){let n=new Date().toDateString(),s=this._scores().get(e);return s?s.history.filter(i=>i.action===t&&new Date(i.timestamp).toDateString()===n).length:0}getLastActionTime(e,t){let n=this._scores().get(e);return n&&n.history.find(i=>i.action===t)?.timestamp||null}getScore(e){return this._scores().get(e)||null}getAllScores(){return Array.from(this._scores().values())}getHotLeads(e=10){return this.getAllScores().sort((t,n)=>n.totalScore-t.totalScore).slice(0,e)}getLeadsByHeatLevel(e){return this.getAllScores().filter(t=>t.heatLevel===e)}adjustScore(e,t,n){let s={id:`sh_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,contactId:e,action:"message_sent",points:t,reason:`\u624B\u52D5\u8ABF\u6574: ${n}`,timestamp:new Date().toISOString()};this._globalHistory.update(i=>[s,...i.slice(0,999)]),this.updateScore(e,s),this.saveData(),this.toast.success(`\u8A55\u5206\u5DF2\u8ABF\u6574 ${t>0?"+":""}${t} \u5206`)}updateAIAnalysis(e,t){let n=this._scores(),s=n.get(e);if(!s)return;if(s.aiAnalysis=t,t){let r=Math.round(t.purchaseIntent*.3+t.urgency*.2);s.intentScore=Math.max(0,s.intentScore+r)}s.updatedAt=new Date().toISOString();let i=new Map(n);i.set(e,s),this._scores.set(i),this.saveData()}updateRule(e,t){this._rules.update(n=>n.map(s=>s.id===e?g(g({},s),t):s)),this.saveData()}resetRules(){this._rules.set(x),this.saveData(),this.toast.success("\u8A55\u5206\u898F\u5247\u5DF2\u91CD\u7F6E")}clearScore(e){let t=new Map(this._scores());t.delete(e),this._scores.set(t),this.saveData()}getHeatLevelConfig(e){return A.find(t=>t.level===e)||A[0]}getAllHeatLevelConfigs(){return A}checkInactiveLeads(){let e=Date.now(),t=this.getAllScores();for(let n of t){if(!n.lastActivity)continue;let s=new Date(n.lastActivity).getTime(),i=(e-s)/(1e3*60*60*24),r=n.history.some(o=>o.action==="inactive_7d"&&e-new Date(o.timestamp).getTime()<10080*60*1e3),a=n.history.some(o=>o.action==="inactive_30d"&&e-new Date(o.timestamp).getTime()<720*60*60*1e3);i>=30&&!a?this.recordAction(n.contactId,"inactive_30d"):i>=7&&!r&&this.recordAction(n.contactId,"inactive_7d")}}static{this.\u0275fac=function(t){return new(t||l)}}static{this.\u0275prov=h({token:l,factory:l.\u0275fac,providedIn:"root"})}};var y={USER_PREFERENCES:"user_preferences",THEME:"theme",LANGUAGE:"language",CURRENT_VIEW:"current_view",SIDEBAR_COLLAPSED:"sidebar_collapsed",MARKETING_ANALYTICS:"marketingAnalytics",SMART_TIMING:"smartTiming",SMART_AUTOMATION:"smartAutomation",PLANNER_DRAFT:"plannerDraft",ACCOUNTS_CACHE:"accounts_cache",SESSION_PATHS:"session_paths",SEARCH_HISTORY:"search_history",RECENT_CONTACTS:"recent_contacts",STORAGE_VERSION:"storage_version"},f=1,L={1:l=>v(g({},l),{migratedAt:Date.now()})},C=class l{constructor(){this._stats=c(null);this.stats=this._stats.asReadonly();this._available=c(!0);this.available=this._available.asReadonly();this.checkStorageAvailability(),this.runMigrations(),this.updateStats()}save(e,t,n){if(!this._available())return!1;try{let i={_meta:{key:e,version:n?.version??f,savedAt:Date.now(),expiresAt:n?.ttl?Date.now()+n.ttl:void 0},data:t};return localStorage.setItem(e,JSON.stringify(i)),this.updateStats(),!0}catch(s){if(console.error(`[StatePersistence] \u4FDD\u5B58\u5931\u6557 (${e}):`,s),s.name==="QuotaExceededError"){this.cleanup();try{return localStorage.setItem(e,JSON.stringify({data:t,_meta:{key:e,version:f,savedAt:Date.now()}})),!0}catch{return!1}}return!1}}load(e,t){if(!this._available())return t;try{let n=localStorage.getItem(e);if(!n)return t;let s=JSON.parse(n);if(s._meta){if(s._meta.expiresAt&&Date.now()>s._meta.expiresAt)return this.remove(e),t;if(s._meta.version<f){let i=this.migrate(s.data,s._meta.version);return this.save(e,i),i}return s.data}return s}catch(n){return console.error(`[StatePersistence] \u8B80\u53D6\u5931\u6557 (${e}):`,n),t}}remove(e){try{return localStorage.removeItem(e),this.updateStats(),!0}catch{return!1}}has(e){return localStorage.getItem(e)!==null}saveMultiple(e){let t=!0;for(let n of e)this.save(n.key,n.data)||(t=!1);return t}loadMultiple(e){let t={};for(let n of e)t[n]=this.load(n);return t}savePreference(e,t){let n=this.load(y.USER_PREFERENCES,{});n[e]=t,this.save(y.USER_PREFERENCES,n)}loadPreference(e,t){return this.load(y.USER_PREFERENCES,{})[e]??t}saveSession(e,t){try{return sessionStorage.setItem(e,JSON.stringify(t)),!0}catch{return!1}}loadSession(e,t){try{let n=sessionStorage.getItem(e);return n?JSON.parse(n):t}catch{return t}}clearSession(){sessionStorage.clear()}cleanup(){let e=0,t=Date.now();for(let n=0;n<localStorage.length;n++){let s=localStorage.key(n);if(s)try{let i=localStorage.getItem(s);if(!i)continue;let r=JSON.parse(i);r._meta?.expiresAt&&t>r._meta.expiresAt&&(localStorage.removeItem(s),e++,n--)}catch{}}return this.updateStats(),console.log(`[StatePersistence] \u6E05\u7406\u4E86 ${e} \u500B\u904E\u671F\u9805`),e}cleanupOld(e=720*60*60*1e3){let t=0,n=Date.now()-e;for(let s=0;s<localStorage.length;s++){let i=localStorage.key(s);if(i)try{let r=localStorage.getItem(i);if(!r)continue;let a=JSON.parse(r);a._meta?.savedAt&&a._meta.savedAt<n&&(localStorage.removeItem(i),t++,s--)}catch{}}return this.updateStats(),t}clearAll(){localStorage.clear(),this.updateStats()}exportAll(){let e={};for(let t=0;t<localStorage.length;t++){let n=localStorage.key(t);if(n)try{e[n]=JSON.parse(localStorage.getItem(n)||"null")}catch{e[n]=localStorage.getItem(n)}}return JSON.stringify({exportedAt:new Date().toISOString(),version:f,data:e},null,2)}importAll(e){try{let t=JSON.parse(e);if(!t.data)return console.error("[StatePersistence] \u7121\u6548\u7684\u5C0E\u5165\u683C\u5F0F"),!1;for(let[n,s]of Object.entries(t.data))localStorage.setItem(n,JSON.stringify(s));return this.updateStats(),!0}catch(t){return console.error("[StatePersistence] \u5C0E\u5165\u5931\u6557:",t),!1}}checkStorageAvailability(){try{let e="__storage_test__";localStorage.setItem(e,e),localStorage.removeItem(e),this._available.set(!0)}catch{this._available.set(!1),console.warn("[StatePersistence] localStorage \u4E0D\u53EF\u7528")}}runMigrations(){let e=this.load(y.STORAGE_VERSION,0);if(e!==void 0&&e<f){console.log(`[StatePersistence] \u904B\u884C\u9077\u79FB: ${e} -> ${f}`);for(let t=0;t<localStorage.length;t++){let n=localStorage.key(t);if(n)try{let s=this.load(n);if(s){let i=this.migrate(s,e);this.save(n,i)}}catch{}}this.save(y.STORAGE_VERSION,f)}}migrate(e,t){let n=e;for(let s=t+1;s<=f;s++)L[s]&&(n=L[s](n));return n}updateStats(){let e=0,t=[];for(let n=0;n<localStorage.length;n++){let s=localStorage.key(n);if(!s)continue;let i=localStorage.getItem(s),r=new Blob([i||""]).size;e+=r,t.push({key:s,size:r})}t.sort((n,s)=>s.size-n.size),this._stats.set({totalKeys:localStorage.length,totalSize:e,byKey:t})}getUsageInfo(){let e=this._stats();if(!e)return{used:"0 KB",available:"5 MB",percentage:0};let t=e.totalSize/(1024*1024),n=5,s=t/n*100;return{used:t<1?`${(e.totalSize/1024).toFixed(1)} KB`:`${t.toFixed(2)} MB`,available:`${n} MB`,percentage:Math.min(100,s)}}static{this.\u0275fac=function(t){return new(t||l)}}static{this.\u0275prov=h({token:l,factory:l.\u0275fac,providedIn:"root"})}};var M=class l{constructor(){this.persistence=_(C);this._experiments=c([]);this.experiments=this._experiments.asReadonly();this._variantStats=c(new Map);this._userAssignments=c(new Map);this.activeExperiments=p(()=>this._experiments().filter(e=>e.status==="running"));this.activeTests=this.activeExperiments;this.completedExperiments=p(()=>this._experiments().filter(e=>e.status==="completed"));this.stats=p(()=>{let e=this._experiments(),t=this.completedExperiments(),n=0,s=0;return t.forEach(i=>{let r=this.getExperimentResult(i.id);if(r?.recommendedWinner){let a=r.variantStats.find(o=>o.variantId===r.recommendedWinner);a?.uplift&&(n+=a.uplift,s++)}}),{total:e.length,running:this.activeExperiments().length,completed:t.length,draft:e.filter(i=>i.status==="draft").length,avgConversionLift:s>0?n/s:0}});this.STORAGE_KEY="abTesting";this.loadFromStorage()}createExperiment(e){let t=e.variants.reduce((i,r)=>i+r.weight,0),n=e.variants.map((i,r)=>v(g({},i),{id:`var_${Date.now()}_${r}`,weight:Math.round(i.weight/t*100)})),s={id:`exp_${Date.now()}`,name:e.name,description:e.description,status:"draft",variants:n,controlVariantId:n[0].id,primaryMetric:e.primaryMetric,secondaryMetrics:e.secondaryMetrics,createdAt:new Date,sampleSize:e.sampleSize??100,minRunDays:e.minRunDays??7,confidenceLevel:e.confidenceLevel??.95,autoSelectWinner:e.autoSelectWinner??!0};return this._experiments.update(i=>[...i,s]),this._variantStats.update(i=>{let r=new Map(i);return r.set(s.id,n.map(a=>this.createEmptyStats(a.id))),r}),this.saveToStorage(),console.log(`[ABTesting] \u5275\u5EFA\u5BE6\u9A57: ${s.name}`),s}startExperiment(e){let t=this.getExperiment(e);return!t||t.status!=="draft"?!1:(this.updateExperiment(e,{status:"running",startedAt:new Date}),console.log(`[ABTesting] \u958B\u59CB\u5BE6\u9A57: ${t.name}`),!0)}pauseExperiment(e){let t=this.getExperiment(e);return!t||t.status!=="running"?!1:(this.updateExperiment(e,{status:"paused"}),!0)}resumeExperiment(e){let t=this.getExperiment(e);return!t||t.status!=="paused"?!1:(this.updateExperiment(e,{status:"running"}),!0)}endExperiment(e,t){let n=this.getExperiment(e);return n?(this.updateExperiment(e,{status:"completed",endedAt:new Date,winner:t}),console.log(`[ABTesting] \u7D50\u675F\u5BE6\u9A57: ${n.name}, \u512A\u52DD: ${t}`),!0):!1}getExperiment(e){return this._experiments().find(t=>t.id===e)}updateExperiment(e,t){this._experiments.update(n=>n.map(s=>s.id===e?g(g({},s),t):s)),this.saveToStorage()}assignVariant(e,t){let n=this.getExperiment(e);if(!n||n.status!=="running")return null;let s=`${e}_${t}`,i=this._userAssignments().get(s);if(i)return n.variants.find(a=>a.id===i.variantId)||null;let r=this.selectVariantByWeight(n.variants);return this._userAssignments.update(a=>{let o=new Map(a);return o.set(s,{experimentId:e,variantId:r.id,assignedAt:new Date}),o}),this.saveToStorage(),r}selectVariantByWeight(e){let t=e.reduce((s,i)=>s+i.weight,0),n=Math.random()*t;for(let s of e)if(n-=s.weight,n<=0)return s;return e[e.length-1]}getUserVariant(e,t){let n=this.getExperiment(e);if(!n)return null;let s=`${e}_${t}`,i=this._userAssignments().get(s);return i&&n.variants.find(r=>r.id===i.variantId)||null}recordConversion(e,t,n){let s=this.getUserVariant(e,t);s&&(this._variantStats.update(i=>{let r=new Map(i),a=r.get(e)||[],o=a.find(d=>d.variantId===s.id);return o&&(o.sampleSize++,o.conversions++,o.conversionRate=o.conversions/o.sampleSize,o.totalRevenue+=n.revenue||0,n.interestScore!==void 0&&(o.avgInterestScore=(o.avgInterestScore*(o.sampleSize-1)+n.interestScore)/o.sampleSize),n.messageCount!==void 0&&(o.avgMessageCount=(o.avgMessageCount*(o.sampleSize-1)+n.messageCount)/o.sampleSize)),r.set(e,a),r}),this.saveToStorage(),this.checkAutoComplete(e))}recordExposure(e,t){let n=this.getUserVariant(e,t);n&&(this._variantStats.update(s=>{let i=new Map(s),r=i.get(e)||[],a=r.find(o=>o.variantId===n.id);return a&&(a.sampleSize++,a.conversionRate=a.conversions/a.sampleSize),i.set(e,r),i}),this.saveToStorage())}getExperimentResult(e){let t=this.getExperiment(e);if(!t)return null;let n=this._variantStats().get(e)||[],s=n.find(u=>u.variantId===t.controlVariantId),i=n.map(u=>{if(u.variantId===t.controlVariantId)return u;let S=s&&s.conversionRate>0?(u.conversionRate-s.conversionRate)/s.conversionRate*100:0,T=this.calculateSignificance(u,s);return g(v(g({},u),{uplift:S}),T)}),r=i.filter(u=>u.isSignificant&&(u.uplift||0)>0),a=t.startedAt?Math.floor((Date.now()-t.startedAt.getTime())/(1e3*60*60*24)):0,o=i.reduce((u,S)=>u+S.sampleSize,0),d="",m;return o<(t.sampleSize||100)?d=`\u6A23\u672C\u91CF\u4E0D\u8DB3\uFF0C\u5EFA\u8B70\u7E7C\u7E8C\u6536\u96C6\u6578\u64DA\uFF08\u7576\u524D ${o}/${t.sampleSize}\uFF09`:a<(t.minRunDays||7)?d=`\u904B\u884C\u6642\u9593\u4E0D\u8DB3\uFF0C\u5EFA\u8B70\u81F3\u5C11\u904B\u884C ${t.minRunDays} \u5929`:r.length===0?d="\u66AB\u7121\u7D71\u8A08\u986F\u8457\u7684\u512A\u52DD\u8005\uFF0C\u5EFA\u8B70\u7E7C\u7E8C\u89C0\u5BDF\u6216\u8ABF\u6574\u8B8A\u9AD4":r.length===1?(m=r[0].variantId,d=`\u5EFA\u8B70\u9078\u64C7\u8B8A\u9AD4 ${this.getVariantName(t,m)}\uFF0C\u63D0\u5347 ${r[0].uplift?.toFixed(1)}%`):(m=r.sort((S,T)=>(T.uplift||0)-(S.uplift||0))[0].variantId,d=`\u591A\u500B\u8B8A\u9AD4\u8868\u73FE\u512A\u79C0\uFF0C\u5EFA\u8B70\u9078\u64C7 ${this.getVariantName(t,m)}`),{experimentId:e,variantStats:i,overallSampleSize:o,runDays:a,hasSignificantWinner:r.length>0,recommendedWinner:m,recommendation:d}}calculateSignificance(e,t){if(!t||t.sampleSize<30||e.sampleSize<30)return{};let n=e.conversionRate,s=t.conversionRate,i=e.sampleSize,r=t.sampleSize,a=(e.conversions+t.conversions)/(i+r),o=Math.sqrt(a*(1-a)*(1/i+1/r));if(o===0)return{};let d=(n-s)/o,m=2*(1-this.normalCDF(Math.abs(d))),u=1.96*o,S=n-s;return{pValue:m,isSignificant:m<.05,confidenceInterval:[S-u,S+u]}}normalCDF(e){let t=.254829592,n=-.284496736,s=1.421413741,i=-1.453152027,r=1.061405429,a=.3275911,o=e<0?-1:1;e=Math.abs(e)/Math.sqrt(2);let d=1/(1+a*e),m=1-((((r*d+i)*d+s)*d+n)*d+t)*d*Math.exp(-e*e);return .5*(1+o*m)}checkAutoComplete(e){let t=this.getExperiment(e);if(!t||!t.autoSelectWinner)return;let n=this.getExperimentResult(e);n&&n.hasSignificantWinner&&n.overallSampleSize>=(t.sampleSize||100)&&n.runDays>=(t.minRunDays||7)&&(this.endExperiment(e,n.recommendedWinner),console.log(`[ABTesting] \u81EA\u52D5\u9078\u64C7\u512A\u52DD\u8005: ${n.recommendedWinner}`))}getVariantName(e,t){return e.variants.find(n=>n.id===t)?.name||t}createEmptyStats(e){return{variantId:e,sampleSize:0,conversions:0,conversionRate:0,totalRevenue:0,avgInterestScore:0,avgResponseTime:0,avgMessageCount:0}}saveToStorage(){let e={experiments:this._experiments(),variantStats:Array.from(this._variantStats().entries()),userAssignments:Array.from(this._userAssignments().entries()),savedAt:Date.now()};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}loadFromStorage(){try{let e=localStorage.getItem(this.STORAGE_KEY);if(!e)return;let t=JSON.parse(e);t.experiments&&this._experiments.set(t.experiments.map(n=>v(g({},n),{createdAt:new Date(n.createdAt),startedAt:n.startedAt?new Date(n.startedAt):void 0,endedAt:n.endedAt?new Date(n.endedAt):void 0}))),t.variantStats&&this._variantStats.set(new Map(t.variantStats)),t.userAssignments&&this._userAssignments.set(new Map(t.userAssignments.map(n=>[n[0],v(g({},n[1]),{assignedAt:new Date(n[1].assignedAt)})]))),console.log("[ABTesting] \u5DF2\u5F9E\u5B58\u5132\u6062\u5FA9\u6578\u64DA")}catch(e){console.error("[ABTesting] \u6062\u5FA9\u6578\u64DA\u5931\u6557:",e)}}static{this.\u0275fac=function(t){return new(t||l)}}static{this.\u0275prov=h({token:l,factory:l.\u0275fac,providedIn:"root"})}};export{F as a,w as b,E as c,R as d,M as e};
