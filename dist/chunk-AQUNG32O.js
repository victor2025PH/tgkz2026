import{a as p,b as f}from"./chunk-CCGO3GAA.js";import{J as g,O as l,a as u,aa as v,b as h,da as o}from"./chunk-XBIFDY2N.js";var S="tgai-license-secret-2026",m=class c{constructor(){this.ngZone=l(v);this._machineId=o("");this._deviceFingerprint=o("");this.tokenRefreshInterval=null;this.lastTokenRefresh=o(null);this.initializeDeviceInfo(),this.startTokenRefreshTimer()}ngOnDestroy(){this.stopTokenRefreshTimer()}initializeDeviceInfo(){this._machineId.set(this.getMachineId()),this._deviceFingerprint.set(this.generateDeviceFingerprint())}getMachineId(){let e=localStorage.getItem("tgai-machine-id");return e||(e=this.generateMachineId(),localStorage.setItem("tgai-machine-id",e)),e}generateMachineId(){let e=[navigator.userAgent,navigator.language,screen.width,screen.height,screen.colorDepth,new Date().getTimezoneOffset(),navigator.hardwareConcurrency||0,navigator.deviceMemory||0];return`M-${this.hashString(e.join("|")).substring(0,16).toUpperCase()}`}generateDeviceFingerprint(){let e=[navigator.userAgent,navigator.platform,navigator.language,screen.width+"x"+screen.height,screen.colorDepth,new Date().getTimezoneOffset(),navigator.hardwareConcurrency||0,navigator.deviceMemory||0,navigator.maxTouchPoints||0,this.getCanvasFingerprint(),this.getWebGLFingerprint()];return this.hashString(e.join("::"))}getCanvasFingerprint(){try{let e=document.createElement("canvas"),t=e.getContext("2d");return t?(t.textBaseline="top",t.font="14px Arial",t.fillStyle="#f60",t.fillRect(125,1,62,20),t.fillStyle="#069",t.fillText("TG-AI\u667A\u63A7\u738B",2,15),t.fillStyle="rgba(102, 204, 0, 0.7)",t.fillText("TG-AI\u667A\u63A7\u738B",4,17),e.toDataURL().substring(0,100)):""}catch{return""}}getWebGLFingerprint(){try{let e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return"";let r=t.getExtension("WEBGL_debug_renderer_info");if(r){let s=t.getParameter(r.UNMASKED_VENDOR_WEBGL),n=t.getParameter(r.UNMASKED_RENDERER_WEBGL);return`${s}|${n}`}return""}catch{return""}}generateRequestSignature(e,t,r){let s=`${e}:${t}:${r}:${S}`;return this.hashString(s)}generateNonce(){let e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}createSecureHeaders(){let e=Math.floor(Date.now()/1e3),t=this.generateNonce(),r=this._machineId();return{"X-Signature":this.generateRequestSignature(e,t,r),"X-Timestamp":e.toString(),"X-Nonce":t,"X-Machine-Id":r}}createSignedRequestBody(e){let t=Math.floor(Date.now()/1e3),r=this.generateNonce();return h(u({},e),{timestamp:t,nonce:r,machine_id:this._machineId(),device_fingerprint:this._deviceFingerprint()})}startTokenRefreshTimer(){this.tokenRefreshInterval=setInterval(()=>{this.ngZone.run(()=>{window.dispatchEvent(new CustomEvent("refresh-token"))})},1200*60*1e3)}stopTokenRefreshTimer(){this.tokenRefreshInterval&&(clearInterval(this.tokenRefreshInterval),this.tokenRefreshInterval=null)}shouldRefreshToken(e){return e?(e.getTime()-Date.now())/(1e3*60*60)<4:!1}hashString(e){return this.sha256(e)}sha256(e){let r=new TextEncoder().encode(e),s=0;for(let i=0;i<e.length;i++){let a=e.charCodeAt(i);s=(s<<5)-s+a,s=s&s}let n=Math.abs(s).toString(16).padStart(8,"0");return(n+n+n+n+n+n+n+n).substring(0,64)}async sha256Async(e){let t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map(n=>n.toString(16).padStart(2,"0")).join("")}get machineId(){return this._machineId()}get deviceFingerprint(){return this._deviceFingerprint()}static{this.\u0275fac=function(t){return new(t||c)}}static{this.\u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"})}};var y=class c{constructor(){this.membershipService=l(f);this.toastService=l(p);this.securityService=l(m);this.ngZone=l(v);this.serverUrl=o("");this.token=o(null);this.heartbeatInterval=null;this.tokenRefreshInterval=null;this.isOnline=o(!0);this.lastHeartbeat=o(null);this.offlineGracePeriod=10080*60*1e3;this.products=[{id:"silver_week",level:"silver",levelName:"\u767D\u9280\u7CBE\u82F1",levelIcon:"\u{1F948}",duration:"week",durationName:"\u5468\u5361",price:1.99},{id:"silver_month",level:"silver",levelName:"\u767D\u9280\u7CBE\u82F1",levelIcon:"\u{1F948}",duration:"month",durationName:"\u6708\u5361",price:4.99},{id:"silver_quarter",level:"silver",levelName:"\u767D\u9280\u7CBE\u82F1",levelIcon:"\u{1F948}",duration:"quarter",durationName:"\u5B63\u5361",price:12.99},{id:"silver_year",level:"silver",levelName:"\u767D\u9280\u7CBE\u82F1",levelIcon:"\u{1F948}",duration:"year",durationName:"\u5E74\u5361",price:49.9},{id:"gold_week",level:"gold",levelName:"\u9EC3\u91D1\u5927\u5E2B",levelIcon:"\u{1F947}",duration:"week",durationName:"\u5468\u5361",price:6.99},{id:"gold_month",level:"gold",levelName:"\u9EC3\u91D1\u5927\u5E2B",levelIcon:"\u{1F947}",duration:"month",durationName:"\u6708\u5361",price:19.9},{id:"gold_quarter",level:"gold",levelName:"\u9EC3\u91D1\u5927\u5E2B",levelIcon:"\u{1F947}",duration:"quarter",durationName:"\u5B63\u5361",price:49.9},{id:"gold_year",level:"gold",levelName:"\u9EC3\u91D1\u5927\u5E2B",levelIcon:"\u{1F947}",duration:"year",durationName:"\u5E74\u5361",price:199},{id:"diamond_week",level:"diamond",levelName:"\u947D\u77F3\u738B\u724C",levelIcon:"\u{1F48E}",duration:"week",durationName:"\u5468\u5361",price:19.9},{id:"diamond_month",level:"diamond",levelName:"\u947D\u77F3\u738B\u724C",levelIcon:"\u{1F48E}",duration:"month",durationName:"\u6708\u5361",price:59.9},{id:"diamond_quarter",level:"diamond",levelName:"\u947D\u77F3\u738B\u724C",levelIcon:"\u{1F48E}",duration:"quarter",durationName:"\u5B63\u5361",price:149},{id:"diamond_year",level:"diamond",levelName:"\u947D\u77F3\u738B\u724C",levelIcon:"\u{1F48E}",duration:"year",durationName:"\u5E74\u5361",price:599},{id:"star_week",level:"star",levelName:"\u661F\u8000\u50B3\u8AAA",levelIcon:"\u{1F31F}",duration:"week",durationName:"\u5468\u5361",price:59.9},{id:"star_month",level:"star",levelName:"\u661F\u8000\u50B3\u8AAA",levelIcon:"\u{1F31F}",duration:"month",durationName:"\u6708\u5361",price:199},{id:"star_quarter",level:"star",levelName:"\u661F\u8000\u50B3\u8AAA",levelIcon:"\u{1F31F}",duration:"quarter",durationName:"\u5B63\u5361",price:499},{id:"star_year",level:"star",levelName:"\u661F\u8000\u50B3\u8AAA",levelIcon:"\u{1F31F}",duration:"year",durationName:"\u5E74\u5361",price:1999},{id:"king_week",level:"king",levelName:"\u69AE\u8000\u738B\u8005",levelIcon:"\u{1F451}",duration:"week",durationName:"\u5468\u5361",price:199},{id:"king_month",level:"king",levelName:"\u69AE\u8000\u738B\u8005",levelIcon:"\u{1F451}",duration:"month",durationName:"\u6708\u5361",price:599},{id:"king_quarter",level:"king",levelName:"\u69AE\u8000\u738B\u8005",levelIcon:"\u{1F451}",duration:"quarter",durationName:"\u5B63\u5361",price:1499},{id:"king_year",level:"king",levelName:"\u69AE\u8000\u738B\u8005",levelIcon:"\u{1F451}",duration:"year",durationName:"\u5E74\u5361",price:5999},{id:"king_lifetime",level:"king",levelName:"\u69AE\u8000\u738B\u8005",levelIcon:"\u{1F451}",duration:"lifetime",durationName:"\u7D42\u8EAB",price:14999}];this.loadToken(),this.loadServerUrl(),this.startHeartbeat(),this.startTokenRefresh(),this.listenForTokenRefresh()}ngOnDestroy(){this.stopHeartbeat(),this.stopTokenRefresh()}loadToken(){let e=localStorage.getItem("tgai-license-token");e&&this.token.set(e)}loadServerUrl(){let e=localStorage.getItem("tgai-license-server");e&&this.serverUrl.set(e)}saveToken(e){this.token.set(e),localStorage.setItem("tgai-license-token",e)}clearToken(){this.token.set(null),localStorage.removeItem("tgai-license-token")}startTokenRefresh(){this.tokenRefreshInterval=setInterval(()=>{this.ngZone.run(()=>{this.refreshToken()})},1200*60*1e3)}stopTokenRefresh(){this.tokenRefreshInterval&&(clearInterval(this.tokenRefreshInterval),this.tokenRefreshInterval=null)}listenForTokenRefresh(){window.addEventListener("refresh-token",()=>{this.refreshToken()})}async refreshToken(){if(!this.isServerConfigured()||!this.token())return{success:!1,message:"\u672A\u914D\u7F6E\u670D\u52D9\u5668\u6216\u7121 Token"};try{let e=this.securityService.createSignedRequestBody({token:this.token(),machine_id:this.securityService.machineId,device_fingerprint:this.securityService.deviceFingerprint}),t=this.securityService.createSecureHeaders(),s=await(await fetch(`${this.serverUrl()}/api/token/refresh`,{method:"POST",headers:u({"Content-Type":"application/json"},t),body:JSON.stringify(e)})).json();return s.success&&s.data?.token?(this.saveToken(s.data.token),{success:!0,message:"Token \u5237\u65B0\u6210\u529F"}):{success:!1,message:s.message||"Token \u5237\u65B0\u5931\u6557"}}catch{return{success:!1,message:"\u7DB2\u7D61\u932F\u8AA4"}}}setServerUrl(e){this.serverUrl.set(e.replace(/\/$/,"")),localStorage.setItem("tgai-license-server",e)}getServerUrl(){return this.serverUrl()}isServerConfigured(){return!!this.serverUrl()}async validateLicense(e){if(!this.isServerConfigured())return this.localValidate(e);try{let r=await(await fetch(`${this.serverUrl()}/api/license/validate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:e})})).json();return this.isOnline.set(!0),{success:r.success,message:r.message,data:r.data}}catch{return this.isOnline.set(!1),this.localValidate(e)}}async activateLicense(e,t="",r=""){let s=this.getMachineId(),n=this.getDeviceId();if(!this.isServerConfigured()){let i=await this.membershipService.activateMembership(e,t);return{success:i.success,message:i.message}}try{let a=await(await fetch(`${this.serverUrl()}/api/license/activate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:e,machine_id:s,device_id:n,email:t,invite_code:r})})).json();if(this.isOnline.set(!0),a.success){a.data?.token&&this.saveToken(a.data.token);let k=await this.membershipService.activateMembership(e,t);if(!a.data?.level||!a.data?.expiresAt){let d=this.membershipService.membership();d&&(a.data=h(u({},a.data),{level:d.level,levelName:d.levelName,levelIcon:d.levelIcon,expiresAt:d.expiresAt?.toISOString()||"",durationDays:30}))}}return{success:a.success,message:a.message,data:a.data}}catch{this.isOnline.set(!1);let a=await this.membershipService.activateMembership(e,t);return{success:a.success,message:a.message+" (\u96E2\u7DDA\u6A21\u5F0F)"}}}async sendHeartbeat(){if(!this.isServerConfigured()||!this.token())return{success:!0,message:"\u96E2\u7DDA\u6A21\u5F0F"};try{let e=this.membershipService.usage(),r=await(await fetch(`${this.serverUrl()}/api/license/heartbeat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.token(),machine_id:this.getMachineId(),usage:e})})).json();return this.ngZone.run(()=>{this.isOnline.set(!0),this.lastHeartbeat.set(new Date),localStorage.setItem("tgai-last-online",Date.now().toString()),r.success&&r.data?.token&&this.saveToken(r.data.token),r.data?.isExpired&&this.toastService.warning("\u60A8\u7684\u6703\u54E1\u5DF2\u904E\u671F\uFF0C\u8ACB\u7E8C\u8CBB\u7E7C\u7E8C\u4F7F\u7528")}),{success:r.success,message:r.message,data:r.data}}catch{this.ngZone.run(()=>{this.isOnline.set(!1)});let t=localStorage.getItem("tgai-last-online");return t&&Date.now()-parseInt(t)>this.offlineGracePeriod?{success:!1,message:"\u96E2\u7DDA\u6642\u9593\u904E\u9577\uFF0C\u8ACB\u9023\u63A5\u7DB2\u7D61\u9A57\u8B49"}:{success:!0,message:"\u96E2\u7DDA\u6A21\u5F0F"}}}async getUserProfile(){if(!this.isServerConfigured()||!this.token())return{success:!1};try{let t=await(await fetch(`${this.serverUrl()}/api/user/profile`,{headers:{Authorization:`Bearer ${this.token()}`,"Content-Type":"application/json"}})).json();return{success:t.success,data:t.data}}catch{return{success:!1}}}async getActivationHistory(e=50,t=0){if(!this.isServerConfigured())return{success:!1};try{let r=this.getMachineId(),s=`${this.serverUrl()}/api/user/activation-history?machine_id=${r}&limit=${e}&offset=${t}`,n={"Content-Type":"application/json"};this.token()&&(n.Authorization=`Bearer ${this.token()}`);let a=await(await fetch(s,{headers:n})).json();return{success:a.success,data:a.data||[]}}catch{return{success:!1,data:[]}}}async getUserQuota(){if(!this.isServerConfigured()||!this.token())return{success:!1};try{let t=await(await fetch(`${this.serverUrl()}/api/user/quota`,{headers:{Authorization:`Bearer ${this.token()}`,"Content-Type":"application/json"}})).json();return{success:t.success,data:t.data}}catch{return{success:!1}}}async getUsageStats(){if(!this.isServerConfigured())return{success:!1};try{let e=this.getMachineId(),t=`${this.serverUrl()}/api/user/usage-stats?machine_id=${e}`,r={"Content-Type":"application/json"};this.token()&&(r.Authorization=`Bearer ${this.token()}`);let n=await(await fetch(t,{headers:r})).json();return{success:n.success,stats:n.stats}}catch{return{success:!1}}}async getInviteInfo(){if(!this.isServerConfigured()||!this.token())return{success:!1};try{let t=await(await fetch(`${this.serverUrl()}/api/invite/info`,{headers:{Authorization:`Bearer ${this.token()}`,"Content-Type":"application/json"}})).json();return{success:t.success,data:t.data}}catch{return{success:!1}}}async getInviteList(){if(!this.isServerConfigured()||!this.token())return{success:!1};try{let t=await(await fetch(`${this.serverUrl()}/api/invite/list`,{headers:{Authorization:`Bearer ${this.token()}`,"Content-Type":"application/json"}})).json();return{success:t.success,data:t.data}}catch{return{success:!1}}}async fetchProducts(){if(!this.isServerConfigured())return{success:!0,data:this.products};try{let t=await(await fetch(`${this.serverUrl()}/api/products`)).json();return{success:t.success,data:t.data}}catch{return{success:!0,data:this.products}}}async createPayment(e,t="usdt"){if(!this.isServerConfigured())return{success:!1,message:"\u8ACB\u806F\u7E6B\u5BA2\u670D\u8CFC\u8CB7\u5361\u5BC6"};try{let s=await(await fetch(`${this.serverUrl()}/api/payment/create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:e,machine_id:this.getMachineId(),payment_method:t})})).json();return s.success?{success:!0,message:"\u8A02\u55AE\u5275\u5EFA\u6210\u529F",order:s.data}:{success:!1,message:s.message}}catch{return{success:!1,message:"\u5275\u5EFA\u8A02\u55AE\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u91CD\u8A66"}}}async checkPaymentStatus(e){if(!this.isServerConfigured())return{success:!1,paid:!1,message:"\u670D\u52D9\u5668\u672A\u914D\u7F6E"};try{let r=await(await fetch(`${this.serverUrl()}/api/payment/status/${e}`)).json();return{success:r.success,paid:r.data?.status==="paid",licenseKey:r.data?.license_key,message:r.message}}catch{return{success:!1,paid:!1,message:"\u67E5\u8A62\u652F\u4ED8\u72C0\u614B\u5931\u6557"}}}startHeartbeat(){this.heartbeatInterval=setInterval(()=>{this.sendHeartbeat()},300*1e3),setTimeout(()=>this.sendHeartbeat(),5e3),window.addEventListener("online",()=>{this.isOnline.set(!0),localStorage.setItem("tgai-last-online",Date.now().toString()),this.sendHeartbeat()}),window.addEventListener("offline",()=>{this.isOnline.set(!1)})}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}getMachineId(){let e=localStorage.getItem("tgai-machine-id");return e||(e="mid-"+this.generateId(),localStorage.setItem("tgai-machine-id",e)),e}getDeviceId(){let e=localStorage.getItem("tgai-device-id");return e||(e="dev-"+this.generateId().substring(0,12),localStorage.setItem("tgai-device-id",e)),e}generateId(){return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}localValidate(e){let t=/^TGAI-([BGDSK][123YL]|EXT)-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/i;if(!e.toUpperCase().match(t)){let s=/^TGM-([BGDSK][123Y])-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/i;if(!e.toUpperCase().match(s))return{success:!1,message:"\u5361\u5BC6\u683C\u5F0F\u4E0D\u6B63\u78BA"}}return{success:!0,message:"\u5361\u5BC6\u683C\u5F0F\u6709\u6548 (\u96E2\u7DDA\u9A57\u8B49)",data:{level:"gold",levelName:"\u9EC3\u91D1\u5927\u5E2B",levelIcon:"\u{1F947}",expiresAt:"",durationDays:30}}}getProductsByLevel(){let e={bronze:[],silver:[],gold:[],diamond:[],star:[],king:[]};for(let t of this.products)e[t.level]&&e[t.level].push(t);return e}getRecommendedProducts(){return[this.products.find(e=>e.id==="gold_month"),this.products.find(e=>e.id==="diamond_month"),this.products.find(e=>e.id==="star_year")].filter(Boolean)}static{this.\u0275fac=function(t){return new(t||c)}}static{this.\u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"})}};export{y as a};
