import{a as E}from"./chunk-VSSEQNUC.js";import{e as x,g as y}from"./chunk-IOZ6RGE3.js";import{o as v}from"./chunk-HDSZBSQ2.js";import{La as u,O as m,T as g,U as d,Ya as p,Za as h,da as s,gb as r,hb as a,ib as _,jb as f,ob as b,pb as c,xa as l,xb as i,yb as C}from"./chunk-XBIFDY2N.js";function T(o,e){o&1&&(r(0,"div",1),_(1,"div",3),r(2,"p"),i(3,"\u6B63\u5728\u8655\u7406 Telegram \u767B\u5165..."),a()())}function M(o,e){if(o&1){let t=f();r(0,"div",2)(1,"span",4),i(2,"\u26A0\uFE0F"),a(),r(3,"h3"),i(4,"\u767B\u5165\u5931\u6557"),a(),r(5,"p"),i(6),a(),r(7,"button",5),b("click",function(){g(t);let k=c();return d(k.goToLogin())}),i(8,"\u8FD4\u56DE\u767B\u5165"),a()()}if(o&2){let t=c();l(6),C(t.error())}}var w=class o{constructor(){this.authService=m(E);this.router=m(y);this.route=m(x);this.isLoading=s(!0);this.error=s(null)}async ngOnInit(){try{let e=this.route.snapshot.queryParams;if(!e.id||!e.hash){let t=this.route.snapshot.fragment;if(t){let n=new URLSearchParams(t);await this.processTelegramAuth({id:n.get("id"),first_name:n.get("first_name"),last_name:n.get("last_name"),username:n.get("username"),photo_url:n.get("photo_url"),auth_date:n.get("auth_date"),hash:n.get("hash")})}else throw new Error("\u7F3A\u5C11 Telegram \u8A8D\u8B49\u6578\u64DA")}else await this.processTelegramAuth({id:e.id,first_name:e.first_name,last_name:e.last_name,username:e.username,photo_url:e.photo_url,auth_date:e.auth_date,hash:e.hash})}catch(e){console.error("Telegram callback error:",e),this.error.set(e.message||"Telegram \u767B\u5165\u5931\u6557")}finally{this.isLoading.set(!1)}}async processTelegramAuth(e){if(!e.id||!e.hash)throw new Error("\u7121\u6548\u7684 Telegram \u8A8D\u8B49\u6578\u64DA");let t=await this.authService.telegramLogin(e);if(t.success){let n=sessionStorage.getItem("auth_return_url")||"/";sessionStorage.removeItem("auth_return_url"),window.opener?(window.opener.postMessage({type:"telegram_auth",auth:e},window.location.origin),window.close()):this.router.navigateByUrl(n)}else throw new Error(t.error||"Telegram \u767B\u5165\u5931\u6557")}goToLogin(){this.router.navigate(["/auth/login"])}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275cmp=u({type:o,selectors:[["app-telegram-callback"]],decls:3,vars:1,consts:[[1,"callback-page"],[1,"loading"],[1,"error"],[1,"spinner"],[1,"error-icon"],[1,"back-btn",3,"click"]],template:function(t,n){t&1&&(r(0,"div",0),p(1,T,4,0,"div",1)(2,M,9,1,"div",2),a()),t&2&&(l(),h(n.isLoading()?1:n.error()?2:-1))},dependencies:[v],styles:[".callback-page[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg-primary, #0a0a0a);color:var(--text-primary, #fff)}.loading[_ngcontent-%COMP%]{text-align:center}.spinner[_ngcontent-%COMP%]{width:48px;height:48px;border:3px solid rgba(255,255,255,.1);border-top-color:var(--primary, #3b82f6);border-radius:50%;animation:_ngcontent-%COMP%_spin 1s linear infinite;margin:0 auto 1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.error[_ngcontent-%COMP%]{text-align:center;padding:2rem;background:var(--bg-secondary, #1a1a1a);border-radius:12px;max-width:400px}.error-icon[_ngcontent-%COMP%]{font-size:3rem;display:block;margin-bottom:1rem}.error[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin-bottom:.5rem;color:#f87171}.error[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--text-secondary, #888);margin-bottom:1.5rem}.back-btn[_ngcontent-%COMP%]{padding:.75rem 1.5rem;background:var(--primary, #3b82f6);border:none;border-radius:8px;color:#fff;font-size:1rem;cursor:pointer;transition:opacity .2s}.back-btn[_ngcontent-%COMP%]:hover{opacity:.9}"],changeDetection:0})}};export{w as TelegramCallbackComponent};
