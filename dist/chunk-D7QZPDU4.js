import{a as d}from"./chunk-KD3U4L4Z.js";import{a as h}from"./chunk-6MHYDRXN.js";import{J as l,O as u,Wb as s,a as n,b as r,da as i}from"./chunk-MB4RORS3.js";var g=[{id:"Listener",name:"\u76E3\u63A7\u865F",icon:"\u{1F441}\uFE0F",description:"\u7528\u65BC\u76E3\u63A7\u7FA4\u7D44\u6D88\u606F",color:"blue"},{id:"Sender",name:"\u767C\u9001\u865F",icon:"\u{1F4E4}",description:"\u7528\u65BC\u767C\u9001\u6D88\u606F",color:"green"},{id:"Explorer",name:"\u63A2\u7D22\u865F",icon:"\u{1F50D}",description:"\u7528\u65BC\u641C\u7D22\u548C\u767C\u73FE\u8CC7\u6E90",color:"purple"},{id:"AI",name:"AI \u865F",icon:"\u{1F916}",description:"\u7528\u65BC AI \u5C0D\u8A71",color:"cyan"},{id:"Backup",name:"\u5099\u7528\u865F",icon:"\u26A1",description:"\u5099\u7528\u5E33\u865F",color:"yellow"},{id:"Unassigned",name:"\u672A\u5206\u914D",icon:"\u2B55",description:"\u5C1A\u672A\u5206\u914D\u89D2\u8272",color:"gray"}],f=class a{constructor(){this.ipc=u(d);this.toast=u(h);this._accounts=i([]);this._selectedAccountIds=i(new Set);this._filter=i({status:"all",role:"all"});this._isLoading=i(!1);this._initialized=!1;this.accounts=this._accounts.asReadonly();this.selectedAccountIds=this._selectedAccountIds.asReadonly();this.filter=this._filter.asReadonly();this.isLoading=this._isLoading.asReadonly();this.filteredAccounts=s(()=>{let e=this._accounts(),t=this._filter();return e.filter(o=>{if(t.status&&t.status!=="all"&&o.status!==t.status||t.role&&t.role!=="all"&&o.role!==t.role)return!1;if(t.search){let c=t.search.toLowerCase(),m=o.phone?.toLowerCase().includes(c),p=o.name?.toLowerCase().includes(c);if(!m&&!p)return!1}return!0})});this.stats=s(()=>{let e=this._accounts(),t={};for(let o of g)t[o.id]=0;for(let o of e)o.role&&t[o.role]!==void 0&&t[o.role]++;return{total:e.length,online:e.filter(o=>o.status==="Online").length,offline:e.filter(o=>o.status==="Offline").length,connecting:e.filter(o=>o.status==="Connecting").length,error:e.filter(o=>o.status==="Error"||o.status==="Banned").length,byRole:t}});this.onlineAccounts=s(()=>this._accounts().filter(e=>e.status==="Online"));this.listenerAccounts=s(()=>this._accounts().filter(e=>e.role==="Listener"&&e.status==="Online"));this.senderAccounts=s(()=>this._accounts().filter(e=>e.role==="Sender"&&e.status==="Online"));this.selectedAccounts=s(()=>{let e=this._selectedAccountIds();return this._accounts().filter(t=>e.has(t.id))});this.hasSelection=s(()=>this._selectedAccountIds().size>0);this.allSelected=s(()=>{let e=this.filteredAccounts(),t=this._selectedAccountIds();return e.length>0&&e.every(o=>t.has(o.id))});this._loginState=i({accountId:null,phone:"",requiresCode:!1,requires2FA:!1,phoneCodeHash:null,isSubmittingCode:!1});this._loginCode=i("");this._login2FAPassword=i("");this.loginState=this._loginState.asReadonly();this.loginCode=this._loginCode.asReadonly();this.login2FAPassword=this._login2FAPassword.asReadonly();this.setupIpcListeners()}setupIpcListeners(){this._initialized||(this._initialized=!0,console.log("[AccountManagementService] Setting up IPC listeners"),this.ipc.on("accounts-updated",e=>{console.log("[AccountManagementService] Received accounts-updated:",e.length,"accounts"),this._accounts.set(e),this._isLoading.set(!1)}),this.ipc.on("account-deleted",e=>{e.success?(this._accounts.update(t=>t.filter(o=>o.id!==e.accountId)),this.toast.success("\u5E33\u865F\u5DF2\u522A\u9664")):this.toast.error(`\u522A\u9664\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}),this.ipc.on("login-requires-code",e=>{console.log("[AccountManagementService] Login requires code for account:",e.accountId),this.handleCodeRequired(e)}),this.ipc.on("login-requires-2fa",e=>{console.log("[AccountManagementService] Login requires 2FA for account:",e.accountId),this.handle2FARequired(e)}),this.ipc.on("login-success",e=>{console.log("[AccountManagementService] Login success for account:",e.accountId),this.handleLoginSuccess(e)}),this.ipc.on("login-failed",e=>{console.log("[AccountManagementService] Login failed for account:",e.accountId),this.handleLoginFailed(e)}),this.ipc.on("logout-result",e=>{this.handleLogoutResult(e)}),this.loadAccounts())}loadAccounts(){console.log("[AccountManagementService] Loading accounts..."),this._isLoading.set(!0),this.ipc.send("get-accounts")}setAccounts(e){this._accounts.set(e)}updateAccount(e){this._accounts.update(t=>t.map(o=>o.id===e.id?n(n({},o),e):o))}addAccount(e){this._accounts.update(t=>[...t,e])}removeAccount(e){this._accounts.update(t=>t.filter(o=>o.id!==e)),this._selectedAccountIds.update(t=>{let o=new Set(t);return o.delete(e),o})}toggleSelection(e){this._selectedAccountIds.update(t=>{let o=new Set(t);return o.has(e)?o.delete(e):o.add(e),o})}selectAll(){let e=this.filteredAccounts();this._selectedAccountIds.set(new Set(e.map(t=>t.id)))}deselectAll(){this._selectedAccountIds.set(new Set)}toggleSelectAll(){this.allSelected()?this.deselectAll():this.selectAll()}isSelected(e){return this._selectedAccountIds().has(e)}setFilter(e){this._filter.update(t=>n(n({},t),e))}clearFilter(){this._filter.set({status:"all",role:"all"})}async connectAccount(e){let t=this._accounts().find(o=>o.id===e);return t?(this.updateAccount(r(n({},t),{status:"Connecting"})),new Promise(o=>{this.ipc.send("connect-account",{accountId:e,phone:t.phone}),o(!0)})):!1}async disconnectAccount(e){let t=this._accounts().find(o=>o.id===e);return t?new Promise(o=>{this.ipc.send("disconnect-account",{accountId:e,phone:t.phone}),o(!0)}):!1}async deleteAccount(e){return new Promise(t=>{this.ipc.send("delete-account",{accountId:e}),t(!0)})}async setAccountRole(e,t){let o=this._accounts().find(c=>c.id===e);return o?(this.updateAccount(r(n({},o),{role:t})),new Promise(c=>{this.ipc.send("update-account",{accountId:e,updates:{role:t}}),c(!0)})):!1}async batchSetRole(e,t){for(let o of e)await this.setAccountRole(o,t);this.toast.success(`\u5DF2\u5C07 ${e.length} \u500B\u5E33\u865F\u8A2D\u70BA ${this.getRoleName(t)}`)}async batchConnect(e){for(let t of e)await this.connectAccount(t);this.toast.info(`\u6B63\u5728\u9023\u63A5 ${e.length} \u500B\u5E33\u865F...`)}async batchDisconnect(e){for(let t of e)await this.disconnectAccount(t);this.toast.info(`\u6B63\u5728\u65B7\u958B ${e.length} \u500B\u5E33\u865F...`)}getAccount(e){return this._accounts().find(t=>t.id===e)}getAccountByPhone(e){return this._accounts().find(t=>t.phone===e)}getRoleInfo(e){return g.find(t=>t.id===e)}getRoleName(e){return this.getRoleInfo(e)?.name||"\u672A\u77E5"}getRoleIcon(e){return this.getRoleInfo(e)?.icon||"\u2B55"}getStatusColor(e){return{Online:"text-green-400",Offline:"text-gray-400",Connecting:"text-yellow-400",Error:"text-red-400",Banned:"text-red-500",Limited:"text-orange-400"}[e]||"text-gray-400"}getStatusText(e){return{Online:"\u5728\u7DDA",Offline:"\u96E2\u7DDA",Connecting:"\u9023\u63A5\u4E2D",Error:"\u932F\u8AA4",Banned:"\u5DF2\u5C01\u7981",Limited:"\u53D7\u9650"}[e]||"\u672A\u77E5"}setLoginCode(e){this._loginCode.set(e)}setLogin2FAPassword(e){this._login2FAPassword.set(e)}loginAccount(e){let t=this._accounts().find(o=>o.id===e);if(!t){this.toast.error("\u8D26\u6237\u672A\u627E\u5230");return}this.toast.info("\u6B63\u5728\u767B\u5F55\u8D26\u6237..."),this._loginState.set({accountId:e,phone:t.phone,requiresCode:!1,requires2FA:!1,phoneCodeHash:null,isSubmittingCode:!1}),this._loginCode.set(""),this._login2FAPassword.set(""),this.ipc.send("login-account",e)}logoutAccount(e){let t=this._accounts().find(o=>o.id===e);if(!t){this.toast.error("\u8D26\u6237\u672A\u627E\u5230");return}confirm(`\u786E\u5B9A\u8981\u9000\u51FA\u8D26\u6237 ${t.phone} \u5417\uFF1F`)&&(this.toast.info("\u6B63\u5728\u9000\u51FA\u8D26\u6237..."),this.ipc.send("logout-account",e))}submitLoginCode(){let e=this._loginState();!e.accountId||!e.phoneCodeHash||!this._loginCode().trim()||(this._loginState.set({accountId:e.accountId,phone:e.phone,requiresCode:!1,requires2FA:!1,phoneCodeHash:e.phoneCodeHash,isSubmittingCode:!0}),this.toast.info("\u6B63\u5728\u9A8C\u8BC1\u9A8C\u8BC1\u7801..."),this.ipc.send("login-account",{accountId:e.accountId,phoneCode:this._loginCode().trim(),phoneCodeHash:e.phoneCodeHash}),this._loginCode.set(""))}submitLogin2FA(){let e=this._loginState();!e.accountId||!this._login2FAPassword().trim()||(this.ipc.send("login-account",{accountId:e.accountId,twoFactorPassword:this._login2FAPassword().trim()}),this._login2FAPassword.set(""))}cancelLogin(){this._loginState.set({accountId:null,phone:"",requiresCode:!1,requires2FA:!1,phoneCodeHash:null,isSubmittingCode:!1}),this._loginCode.set(""),this._login2FAPassword.set("")}resendVerificationCode(){let e=this._loginState();e.accountId&&(this._loginState.set({accountId:e.accountId,phone:e.phone,requiresCode:!1,requires2FA:!1,phoneCodeHash:null,isSubmittingCode:!1}),this._loginCode.set(""),this.toast.info("\u6B63\u5728\u91CD\u65B0\u53D1\u9001\u9A8C\u8BC1\u7801\u5230\u60A8\u7684 Telegram \u5E94\u7528...",5e3),this.ipc.send("login-account",e.accountId))}checkAccountStatus(e){this.ipc.send("check-account-status",e)}handleCodeRequired(e){this._loginState.update(t=>r(n({},t),{accountId:e.accountId,requiresCode:!0,phoneCodeHash:e.phoneCodeHash,isSubmittingCode:!1}))}handle2FARequired(e){this._loginState.update(t=>r(n({},t),{accountId:e.accountId,requiresCode:!1,requires2FA:!0,isSubmittingCode:!1}))}handleLoginSuccess(e){this._loginState.set({accountId:null,phone:"",requiresCode:!1,requires2FA:!1,phoneCodeHash:null,isSubmittingCode:!1}),this.toast.success("\u767B\u5F55\u6210\u529F")}handleLoginFailed(e){this._loginState.update(t=>r(n({},t),{isSubmittingCode:!1})),this.toast.error(`\u767B\u5F55\u5931\u8D25: ${e.error}`)}handleLogoutResult(e){if(e.success){let t=this._accounts().find(o=>o.id===e.accountId);this.toast.success(`\u8D26\u6237 ${t?.phone||""} \u5DF2\u9000\u51FA`)}else this.toast.error(`\u9000\u51FA\u5931\u8D25: ${e.error||"\u672A\u77E5\u9519\u8BEF"}`)}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275prov=l({token:a,factory:a.\u0275fac,providedIn:"root"})}};export{f as a};
