import{a as E}from"./chunk-TFMISNVG.js";import{a as I}from"./chunk-43M2OKI7.js";import{a as b}from"./chunk-YKEUYVE5.js";import{a as w}from"./chunk-B6NL44GT.js";import{M as f,R as _,Vb as S,a as d,b as p,ga as c}from"./chunk-YLSLTE5F.js";var P=["\u9AD8\u610F\u5411","\u5F85\u8DDF\u9032","\u5DF2\u6210\u4EA4","\u6D41\u5931\u98A8\u96AA","VIP","\u65B0\u767C\u73FE","\u5DF2\u806F\u7E6B","\u9700\u8981\u5831\u50F9","\u6280\u8853\u8AEE\u8A62","\u6F5B\u5728\u5927\u5BA2\u6236"],x=[{value:"new",label:"\u65B0\u767C\u73FE",color:"bg-blue-500"},{value:"contacted",label:"\u5DF2\u806F\u7E6B",color:"bg-yellow-500"},{value:"interested",label:"\u6709\u610F\u5411",color:"bg-green-500"},{value:"negotiating",label:"\u6D3D\u8AC7\u4E2D",color:"bg-purple-500"},{value:"converted",label:"\u5DF2\u6210\u4EA4",color:"bg-emerald-500"},{value:"lost",label:"\u5DF2\u6D41\u5931",color:"bg-gray-500"},{value:"blocked",label:"\u5DF2\u5C01\u9396",color:"bg-red-500"},{value:"replied",label:"\u5DF2\u56DE\u8986",color:"bg-teal-500"},{value:"failed",label:"\u767C\u9001\u5931\u6557",color:"bg-rose-500"}],R=class l{constructor(){this.ipc=_(b);this.api=_(w);this._contacts=c([]);this.contacts=this._contacts.asReadonly();this._stats=c({total:0,users:0,groups:0,channels:0,by_status:{},by_source:{},recent_added:0});this.stats=this._stats.asReadonly();this._total=c(0);this.total=this._total.asReadonly();this._isLoading=c(!1);this.isLoading=this._isLoading.asReadonly();this._isSyncing=c(!1);this.isSyncing=this._isSyncing.asReadonly();this._hasImportedFromLeads=c(!1);this.hasData=S(()=>this._contacts().length>0||this._hasImportedFromLeads());this._filter=c({});this.filter=this._filter.asReadonly();this._selectedIds=c(new Set);this.selectedIds=this._selectedIds.asReadonly();this.selectedContacts=S(()=>{let e=this._selectedIds();return this._contacts().filter(t=>e.has(t.telegram_id))});this.setupIpcListeners()}get useHttpApi(){let e=E.apiMode;return e==="http"?!0:e==="ipc"?!1:typeof window?.electron>"u"}setupIpcListeners(){this.ipc.on("unified-contacts:list",e=>{console.log("[UnifiedContacts] Received list:",e),this._isLoading.set(!1),e.success?(this._contacts.set(e.contacts||[]),this._total.set(e.total||0)):(console.error("[UnifiedContacts] List error:",e.error),this._contacts.set([]),this._total.set(0))}),this.ipc.on("unified-contacts:stats",e=>{console.log("[UnifiedContacts] Received stats:",e),e.success&&this._stats.set(e.stats)}),this.ipc.on("unified-contacts:sync-result",e=>{console.log("[UnifiedContacts] ========== SYNC RESULT =========="),console.log("[UnifiedContacts] Sync result:",e),this._isSyncing.set(!1),e.success?(console.log("[UnifiedContacts] Sync successful, stats:",e.stats),this.loadContacts(),this.loadStats()):console.error("[UnifiedContacts] Sync failed:",e.error)}),this.ipc.on("unified-contacts:update-result",e=>{console.log("[UnifiedContacts] Update result:",e),e.success&&this.loadContacts()}),this.ipc.on("unified-contacts:add-tags-result",e=>{console.log("[UnifiedContacts] Add tags result:",e),e.success&&this.loadContacts()}),this.ipc.on("unified-contacts:update-status-result",e=>{console.log("[UnifiedContacts] Update status result:",e),e.success&&this.loadContacts()}),this.ipc.on("unified-contacts:delete-result",e=>{if(console.log("[UnifiedContacts] Delete result:",e),e.success){let t=this._pendingDeleteIds||new Set,n=this._contacts().filter(i=>!t.has(i.telegram_id));this._contacts.set(n),this._total.set(n.length),this._selectedIds.set(new Set),this._pendingDeleteIds=void 0,this.updateLocalStats(n),console.log("[UnifiedContacts] Deleted successfully, remaining:",n.length)}})}syncFromSources(){console.log("[UnifiedContacts] ========== SYNC START =========="),console.log("[UnifiedContacts] Sending unified-contacts:sync to backend..."),this._isSyncing.set(!0);try{this.ipc.send("unified-contacts:sync",{}),console.log("[UnifiedContacts] IPC command sent successfully")}catch(e){console.error("[UnifiedContacts] Failed to send IPC command:",e),this._isSyncing.set(!1);return}setTimeout(()=>{this._isSyncing()&&(console.warn("[UnifiedContacts] Sync timeout after 60s, resetting state"),this._isSyncing.set(!1))},6e4)}forceEndSync(){console.log("[UnifiedContacts] Force ending all loading states..."),this._isSyncing.set(!1),this._isLoading.set(!1)}forceReloadContacts(e){console.log("[UnifiedContacts] Force reload contacts"),this._hasImportedFromLeads.set(!1);let t=e||this._filter();this._filter.set(t),this._isLoading.set(!0),this.ipc.send("unified-contacts:get",{contactType:t.contactType,sourceType:t.sourceType,status:t.status,tags:t.tags,search:t.search,orderBy:t.orderBy||"created_at DESC",limit:500,offset:0})}loadContacts(e){let t=e||this._filter();if(this._filter.set(t),this._hasImportedFromLeads()&&this._contacts().length>0){console.log("[UnifiedContacts] Data already imported from leads, skipping backend request"),this._isLoading.set(!1);return}if(console.log("[UnifiedContacts] Loading contacts with filter:",t),this._isLoading.set(!0),this.useHttpApi){this._loadContactsViaHttp(t);return}this.ipc.send("unified-contacts:get",{contactType:t.contactType,sourceType:t.sourceType,status:t.status,tags:t.tags,search:t.search,orderBy:t.orderBy||"created_at DESC",limit:t.limit||100,offset:t.offset||0}),setTimeout(()=>{this._isLoading()&&(console.warn("[UnifiedContacts] Load timeout, resetting state"),this._isLoading.set(!1))},15e3)}loadStats(){if(this._hasImportedFromLeads()){console.log("[UnifiedContacts] Stats already computed from leads, skipping backend request");return}if(this.useHttpApi){this._loadStatsViaHttp();return}console.log("[UnifiedContacts] Loading stats..."),this.ipc.send("unified-contacts:stats",{})}async _loadContactsViaHttp(e){try{let t=new URLSearchParams;e.search&&t.set("search",e.search),e.status&&t.set("status",e.status),e.sourceType&&t.set("source_type",e.sourceType),e.orderBy&&t.set("order_by",e.orderBy),t.set("limit",String(e.limit||100)),t.set("offset",String(e.offset||0));let s=await this.api.get(`/api/v1/contacts?${t.toString()}`);if(s.success&&s.data){let n=s.data.data||s.data,i=(n.contacts||[]).map(a=>p(d({},a),{tags:Array.isArray(a.tags)?a.tags:[],ai_score:a.ai_score||0,activity_score:a.activity_score||0,value_level:a.value_level||"",is_online:!1,is_bot:!1,is_premium:!1,is_verified:!1}));this._contacts.set(i),this._total.set(n.total??i.length)}}catch(t){console.error("[UnifiedContacts] HTTP load failed:",t)}finally{this._isLoading.set(!1)}}async _loadStatsViaHttp(){try{let e=await this.api.get("/api/v1/contacts/stats");if(e.success&&e.data){let t=e.data.data||e.data;this._stats.set({total:t.total||0,users:0,groups:0,channels:0,by_status:t.by_status||{},by_source:t.by_source||{},recent_added:t.recent_7d||0})}}catch(e){console.error("[UnifiedContacts] HTTP stats load failed:",e)}}setFilter(e){let t=d(d({},this._filter()),e);this.loadContacts(t)}resetFilter(){this.loadContacts({})}search(e){this.setFilter({search:e,offset:0})}setPage(e,t=100){this.setFilter({offset:(e-1)*t,limit:t})}toggleSelect(e){let t=new Set(this._selectedIds());t.has(e)?t.delete(e):t.add(e),this._selectedIds.set(t)}toggleSelectAll(){let e=this._selectedIds(),t=this._contacts().map(s=>s.telegram_id);e.size===t.length?this._selectedIds.set(new Set):this._selectedIds.set(new Set(t))}clearSelection(){this._selectedIds.set(new Set)}updateContact(e,t){console.log("[UnifiedContacts] Updating contact:",e,t),this.ipc.send("unified-contacts:update",{telegramId:e,updates:t})}addTags(e,t){console.log("[UnifiedContacts] Adding tags:",e,t),this.ipc.send("unified-contacts:add-tags",{telegramIds:e,tags:t})}updateStatus(e,t){console.log("[UnifiedContacts] Updating status:",e,t),this.ipc.send("unified-contacts:update-status",{telegramIds:e,status:t})}deleteContacts(e){console.log("[UnifiedContacts] Deleting contacts:",e.length),this._pendingDeleteIds=new Set(e),this.ipc.send("unified-contacts:delete",{telegramIds:e})}updateLocalStats(e){let t={},s={};e.forEach(n=>{t[n.status]=(t[n.status]||0)+1,s[n.source_type]=(s[n.source_type]||0)+1}),this._stats.set({total:e.length,users:e.filter(n=>n.contact_type==="user").length,groups:e.filter(n=>n.contact_type==="group").length,channels:e.filter(n=>n.contact_type==="channel").length,by_status:t,by_source:s,recent_added:e.filter(n=>{let i=new Date(n.created_at),a=new Date;return a.setDate(a.getDate()-7),i>a}).length})}addTagsToSelected(e){let t=Array.from(this._selectedIds());t.length>0&&this.addTags(t,e)}updateSelectedStatus(e){let t=Array.from(this._selectedIds());t.length>0&&this.updateStatus(t,e)}deleteSelected(){let e=Array.from(this._selectedIds());e.length>0&&this.deleteContacts(e)}importFromExtraction(e,t){e.length&&(console.log("[UnifiedContacts] Importing from extraction:",e.length,"members from",t.sourceName),this.ipc.send("unified-contacts:import-members",{members:e.map(s=>({telegram_id:s.telegramId,username:s.username,first_name:s.firstName,last_name:s.lastName,display_name:s.displayName,phone:s.phone,is_bot:s.isBot,is_premium:s.isPremium,is_verified:s.isVerified,online_status:s.onlineStatus,last_seen:s.lastSeen,is_chinese:s.isChinese,activity_score:s.activityScore,value_level:s.valueLevel})),sourceType:t.sourceType,sourceName:t.sourceName,sourceId:t.sourceId}))}updateContactStatus(e,t){console.log("[UnifiedContacts] Updating single contact status:",e,t),this.updateContact(e,{status:t})}getSendTargets(){return this._contacts().filter(e=>e.contact_type==="user"&&!e.is_bot)}markAsContacted(e){this.updateStatus(e,"contacted")}getCountBySource(e){return this._contacts().filter(t=>t.source_type===e).length}getStatusColor(e){return x.find(s=>s.value===e)?.color||"bg-gray-500"}getStatusLabel(e){return x.find(s=>s.value===e)?.label||e}mapLeadStatus(e){return{New:"new",Contacted:"contacted",Replied:"interested",Interested:"interested","Follow-up":"negotiating",Negotiating:"negotiating","Closed-Won":"converted","Closed-Lost":"lost",Unsubscribed:"blocked"}[e]||"new"}importLeadsDirectly(e){if(console.log("[UnifiedContacts] Importing leads directly:",e.length),!e||e.length===0)return;let t=e.map((i,a)=>({id:i.id||a,telegram_id:String(i.userId||i.user_id||""),username:i.username||"",display_name:i.firstName||i.username||String(i.userId||""),first_name:i.firstName||"",last_name:i.lastName||"",phone:i.phone||"",contact_type:"user",source_type:i.sourceType==="group_extract"?"member":"lead",source_id:i.sourceChatId||i.campaignId?.toString()||"",source_name:i.sourceGroup||i.sourceChatTitle||"\u767C\u9001\u63A7\u5236\u53F0",status:this.mapLeadStatus(i.status||"New"),tags:i.tags||[],ai_score:i.aiScore||.5,activity_score:i.activityScore||.5,value_level:i.valueLevel||"C",is_online:i.onlineStatus==="Online",last_seen:i.lastSeen,is_bot:!1,is_premium:i.isPremium||!1,is_verified:i.isVerified||!1,member_count:0,message_count:(i.interactionHistory||[]).length,last_contact_at:i.lastContactAt,last_message_at:i.lastMessageAt,bio:i.bio||"",notes:i.notes||"",metadata:{},created_at:i.timestamp||new Date().toISOString(),updated_at:new Date().toISOString(),synced_at:new Date().toISOString()}));this._contacts.set(t),this._total.set(t.length);let s={},n={};t.forEach(i=>{s[i.status]=(s[i.status]||0)+1,n[i.source_type]=(n[i.source_type]||0)+1}),this._stats.set({total:t.length,users:t.length,groups:0,channels:0,by_status:s,by_source:n,recent_added:t.filter(i=>{let a=new Date(i.created_at),r=new Date;return r.setDate(r.getDate()-7),a>=r}).length}),this._isLoading.set(!1),this._isSyncing.set(!1),this._hasImportedFromLeads.set(!0),console.log("[UnifiedContacts] Imported",t.length,"contacts from leads")}resetImportState(){this._hasImportedFromLeads.set(!1)}ngOnDestroy(){}static{this.\u0275fac=function(t){return new(t||l)}}static{this.\u0275prov=f({token:l,factory:l.\u0275fac,providedIn:"root"})}};var L=[{id:"r1",action:"message_replied",name:"\u56DE\u8986\u6D88\u606F",description:"\u5BA2\u6236\u56DE\u8986\u4E86\u60A8\u7684\u6D88\u606F",points:10,enabled:!0,maxPerDay:5},{id:"r2",action:"positive_reply",name:"\u6B63\u9762\u56DE\u8986",description:"\u5BA2\u6236\u8868\u9054\u4E86\u8208\u8DA3\u6216\u7A4D\u6975\u614B\u5EA6",points:15,enabled:!0},{id:"r3",action:"question_asked",name:"\u4E3B\u52D5\u63D0\u554F",description:"\u5BA2\u6236\u4E3B\u52D5\u8A62\u554F\u7522\u54C1/\u670D\u52D9",points:20,enabled:!0},{id:"r4",action:"price_inquiry",name:"\u8A62\u554F\u50F9\u683C",description:"\u5BA2\u6236\u8A62\u554F\u50F9\u683C\uFF0C\u9AD8\u8CFC\u8CB7\u610F\u5411",points:25,enabled:!0},{id:"r5",action:"demo_requested",name:"\u8ACB\u6C42\u6F14\u793A",description:"\u5BA2\u6236\u8ACB\u6C42\u7522\u54C1\u6F14\u793A",points:30,enabled:!0},{id:"r6",action:"meeting_scheduled",name:"\u9810\u7D04\u6703\u8B70",description:"\u5BA2\u6236\u540C\u610F\u9810\u7D04\u6703\u8B70",points:40,enabled:!0},{id:"r7",action:"referral_made",name:"\u63A8\u85A6\u4ED6\u4EBA",description:"\u5BA2\u6236\u63A8\u85A6\u4E86\u5176\u4ED6\u6F5B\u5728\u5BA2\u6236",points:50,enabled:!0},{id:"r8",action:"message_sent",name:"\u767C\u9001\u6D88\u606F",description:"\u5411\u5BA2\u6236\u767C\u9001\u6D88\u606F",points:2,enabled:!0,maxPerDay:3},{id:"r9",action:"message_opened",name:"\u6253\u958B\u6D88\u606F",description:"\u5BA2\u6236\u6253\u958B\u4E86\u6D88\u606F",points:5,enabled:!0,maxPerDay:5},{id:"r10",action:"link_clicked",name:"\u9EDE\u64CA\u9023\u7D50",description:"\u5BA2\u6236\u9EDE\u64CA\u4E86\u6D88\u606F\u4E2D\u7684\u9023\u7D50",points:8,enabled:!0},{id:"r11",action:"negative_reply",name:"\u8CA0\u9762\u56DE\u8986",description:"\u5BA2\u6236\u8868\u9054\u4E0D\u611F\u8208\u8DA3",points:-10,enabled:!0},{id:"r12",action:"unsubscribed",name:"\u53D6\u6D88\u8A02\u95B1",description:"\u5BA2\u6236\u53D6\u6D88\u8A02\u95B1\u6216\u62C9\u9ED1",points:-30,enabled:!0},{id:"r13",action:"complained",name:"\u6295\u8A34",description:"\u5BA2\u6236\u6295\u8A34\u6216\u8209\u5831",points:-50,enabled:!0},{id:"r14",action:"inactive_7d",name:"7\u5929\u672A\u6D3B\u8E8D",description:"\u5BA2\u62367\u5929\u5167\u7121\u4EFB\u4F55\u4E92\u52D5",points:-5,enabled:!0},{id:"r15",action:"inactive_30d",name:"30\u5929\u672A\u6D3B\u8E8D",description:"\u5BA2\u623630\u5929\u5167\u7121\u4EFB\u4F55\u4E92\u52D5",points:-15,enabled:!0}],A=[{level:"cold",minScore:-100,maxScore:20,color:"#64748b",icon:"\u2744\uFE0F",label:"\u51B7\u6DE1"},{level:"warm",minScore:21,maxScore:50,color:"#eab308",icon:"\u{1F324}\uFE0F",label:"\u6EAB\u548C"},{level:"hot",minScore:51,maxScore:100,color:"#f97316",icon:"\u{1F525}",label:"\u71B1\u9580"},{level:"burning",minScore:101,maxScore:999,color:"#ef4444",icon:"\u{1F4A5}",label:"\u7206\u71B1"}],M=class l{constructor(){this.ipc=_(b);this.toast=_(I);this._rules=c(L);this.rules=this._rules.asReadonly();this._scores=c(new Map);this._globalHistory=c([]);this.globalHistory=this._globalHistory.asReadonly();this.stats=S(()=>{let e=Array.from(this._scores().values()),t={cold:e.filter(s=>s.heatLevel==="cold").length,warm:e.filter(s=>s.heatLevel==="warm").length,hot:e.filter(s=>s.heatLevel==="hot").length,burning:e.filter(s=>s.heatLevel==="burning").length};return{total:e.length,avgScore:e.length>0?e.reduce((s,n)=>s+n.totalScore,0)/e.length:0,byLevel:t,hotLeads:e.filter(s=>s.heatLevel==="hot"||s.heatLevel==="burning")}});this.loadData(),this.setupIpcListeners()}setupIpcListeners(){this.ipc.on("scoring:message-sent",e=>{this.recordAction(e.contactId,"message_sent")}),this.ipc.on("scoring:reply-received",e=>{e.sentiment&&e.sentiment>.3?this.recordAction(e.contactId,"positive_reply"):e.sentiment&&e.sentiment<-.3?this.recordAction(e.contactId,"negative_reply"):this.recordAction(e.contactId,"message_replied")}),this.ipc.on("scoring:price-inquiry",e=>{this.recordAction(e.contactId,"price_inquiry")})}loadData(){try{let e=localStorage.getItem("tg-matrix-scoring-rules");e&&this._rules.set(JSON.parse(e));let t=localStorage.getItem("tg-matrix-lead-scores");if(t){let n=JSON.parse(t),i=new Map;n.forEach(a=>i.set(a.contactId,a)),this._scores.set(i)}let s=localStorage.getItem("tg-matrix-scoring-history");s&&this._globalHistory.set(JSON.parse(s))}catch(e){console.error("Failed to load scoring data:",e)}}saveData(){try{localStorage.setItem("tg-matrix-scoring-rules",JSON.stringify(this._rules())),localStorage.setItem("tg-matrix-lead-scores",JSON.stringify(Array.from(this._scores().values()))),localStorage.setItem("tg-matrix-scoring-history",JSON.stringify(this._globalHistory().slice(0,1e3)))}catch(e){console.error("Failed to save scoring data:",e)}}recordAction(e,t,s){let n=this._rules().find(a=>a.action===t&&a.enabled);if(!n||n.maxPerDay&&this.getTodayActionCount(e,t)>=n.maxPerDay)return 0;if(n.cooldownMinutes){let a=this.getLastActionTime(e,t);if(a){let r=n.cooldownMinutes*60*1e3;if(Date.now()-new Date(a).getTime()<r)return 0}}let i={id:`sh_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,contactId:e,action:t,points:n.points,reason:n.name,timestamp:new Date().toISOString(),metadata:s};return this._globalHistory.update(a=>[i,...a.slice(0,999)]),this.updateScore(e,i),this.saveData(),n.points}updateScore(e,t){let s=this._scores(),n=s.get(e);n||(n=this.createNewScore(e)),n.history=[t,...n.history.slice(0,99)],n.totalScore=Math.max(-100,Math.min(999,n.totalScore+t.points)),this.updateCategoryScores(n),n.heatLevel=this.calculateHeatLevel(n.totalScore),n.lastActivity=t.timestamp,n.activityCount++,n.updatedAt=new Date().toISOString();let i=new Map(s);i.set(e,n),this._scores.set(i)}createNewScore(e){return{contactId:e,totalScore:0,heatLevel:"cold",behaviorScore:0,engagementScore:0,intentScore:0,recencyScore:0,activityCount:0,history:[],updatedAt:new Date().toISOString()}}updateCategoryScores(e){let t=e.history.slice(0,20),s=["message_replied","link_clicked","message_opened"];e.behaviorScore=t.filter(a=>s.includes(a.action)).reduce((a,r)=>a+r.points,0);let n=["positive_reply","question_asked"];e.engagementScore=t.filter(a=>n.includes(a.action)).reduce((a,r)=>a+r.points,0);let i=["price_inquiry","demo_requested","meeting_scheduled"];if(e.intentScore=t.filter(a=>i.includes(a.action)).reduce((a,r)=>a+r.points,0),e.lastActivity){let a=(Date.now()-new Date(e.lastActivity).getTime())/864e5;a<1?e.recencyScore=20:a<3?e.recencyScore=15:a<7?e.recencyScore=10:a<14?e.recencyScore=5:e.recencyScore=0}}calculateHeatLevel(e){for(let t of A)if(e>=t.minScore&&e<=t.maxScore)return t.level;return"cold"}getTodayActionCount(e,t){let s=new Date().toDateString(),n=this._scores().get(e);return n?n.history.filter(i=>i.action===t&&new Date(i.timestamp).toDateString()===s).length:0}getLastActionTime(e,t){let s=this._scores().get(e);return s&&s.history.find(i=>i.action===t)?.timestamp||null}getScore(e){return this._scores().get(e)||null}getAllScores(){return Array.from(this._scores().values())}getHotLeads(e=10){return this.getAllScores().sort((t,s)=>s.totalScore-t.totalScore).slice(0,e)}getLeadsByHeatLevel(e){return this.getAllScores().filter(t=>t.heatLevel===e)}adjustScore(e,t,s){let n={id:`sh_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,contactId:e,action:"message_sent",points:t,reason:`\u624B\u52D5\u8ABF\u6574: ${s}`,timestamp:new Date().toISOString()};this._globalHistory.update(i=>[n,...i.slice(0,999)]),this.updateScore(e,n),this.saveData(),this.toast.success(`\u8A55\u5206\u5DF2\u8ABF\u6574 ${t>0?"+":""}${t} \u5206`)}updateAIAnalysis(e,t){let s=this._scores(),n=s.get(e);if(!n)return;if(n.aiAnalysis=t,t){let a=Math.round(t.purchaseIntent*.3+t.urgency*.2);n.intentScore=Math.max(0,n.intentScore+a)}n.updatedAt=new Date().toISOString();let i=new Map(s);i.set(e,n),this._scores.set(i),this.saveData()}updateRule(e,t){this._rules.update(s=>s.map(n=>n.id===e?d(d({},n),t):n)),this.saveData()}resetRules(){this._rules.set(L),this.saveData(),this.toast.success("\u8A55\u5206\u898F\u5247\u5DF2\u91CD\u7F6E")}clearScore(e){let t=new Map(this._scores());t.delete(e),this._scores.set(t),this.saveData()}getHeatLevelConfig(e){return A.find(t=>t.level===e)||A[0]}getAllHeatLevelConfigs(){return A}checkInactiveLeads(){let e=Date.now(),t=this.getAllScores();for(let s of t){if(!s.lastActivity)continue;let n=new Date(s.lastActivity).getTime(),i=(e-n)/(1e3*60*60*24),a=s.history.some(o=>o.action==="inactive_7d"&&e-new Date(o.timestamp).getTime()<10080*60*1e3),r=s.history.some(o=>o.action==="inactive_30d"&&e-new Date(o.timestamp).getTime()<720*60*60*1e3);i>=30&&!r?this.recordAction(s.contactId,"inactive_30d"):i>=7&&!a&&this.recordAction(s.contactId,"inactive_7d")}}static{this.\u0275fac=function(t){return new(t||l)}}static{this.\u0275prov=f({token:l,factory:l.\u0275fac,providedIn:"root"})}};var y={USER_PREFERENCES:"user_preferences",THEME:"theme",LANGUAGE:"language",CURRENT_VIEW:"current_view",SIDEBAR_COLLAPSED:"sidebar_collapsed",MARKETING_ANALYTICS:"marketingAnalytics",SMART_TIMING:"smartTiming",SMART_AUTOMATION:"smartAutomation",PLANNER_DRAFT:"plannerDraft",ACCOUNTS_CACHE:"accounts_cache",SESSION_PATHS:"session_paths",SEARCH_HISTORY:"search_history",RECENT_CONTACTS:"recent_contacts",STORAGE_VERSION:"storage_version"},v=1,N={1:l=>p(d({},l),{migratedAt:Date.now()})},C=class l{constructor(){this._stats=c(null);this.stats=this._stats.asReadonly();this._available=c(!0);this.available=this._available.asReadonly();this.checkStorageAvailability(),this.runMigrations(),this.updateStats()}save(e,t,s){if(!this._available())return!1;try{let i={_meta:{key:e,version:s?.version??v,savedAt:Date.now(),expiresAt:s?.ttl?Date.now()+s.ttl:void 0},data:t};return localStorage.setItem(e,JSON.stringify(i)),this.updateStats(),!0}catch(n){if(console.error(`[StatePersistence] \u4FDD\u5B58\u5931\u6557 (${e}):`,n),n.name==="QuotaExceededError"){this.cleanup();try{return localStorage.setItem(e,JSON.stringify({data:t,_meta:{key:e,version:v,savedAt:Date.now()}})),!0}catch{return!1}}return!1}}load(e,t){if(!this._available())return t;try{let s=localStorage.getItem(e);if(!s)return t;let n=JSON.parse(s);if(n._meta){if(n._meta.expiresAt&&Date.now()>n._meta.expiresAt)return this.remove(e),t;if(n._meta.version<v){let i=this.migrate(n.data,n._meta.version);return this.save(e,i),i}return n.data}return n}catch(s){return console.error(`[StatePersistence] \u8B80\u53D6\u5931\u6557 (${e}):`,s),t}}remove(e){try{return localStorage.removeItem(e),this.updateStats(),!0}catch{return!1}}has(e){return localStorage.getItem(e)!==null}saveMultiple(e){let t=!0;for(let s of e)this.save(s.key,s.data)||(t=!1);return t}loadMultiple(e){let t={};for(let s of e)t[s]=this.load(s);return t}savePreference(e,t){let s=this.load(y.USER_PREFERENCES,{});s[e]=t,this.save(y.USER_PREFERENCES,s)}loadPreference(e,t){return this.load(y.USER_PREFERENCES,{})[e]??t}saveSession(e,t){try{return sessionStorage.setItem(e,JSON.stringify(t)),!0}catch{return!1}}loadSession(e,t){try{let s=sessionStorage.getItem(e);return s?JSON.parse(s):t}catch{return t}}clearSession(){sessionStorage.clear()}cleanup(){let e=0,t=Date.now();for(let s=0;s<localStorage.length;s++){let n=localStorage.key(s);if(n)try{let i=localStorage.getItem(n);if(!i)continue;let a=JSON.parse(i);a._meta?.expiresAt&&t>a._meta.expiresAt&&(localStorage.removeItem(n),e++,s--)}catch{}}return this.updateStats(),console.log(`[StatePersistence] \u6E05\u7406\u4E86 ${e} \u500B\u904E\u671F\u9805`),e}cleanupOld(e=720*60*60*1e3){let t=0,s=Date.now()-e;for(let n=0;n<localStorage.length;n++){let i=localStorage.key(n);if(i)try{let a=localStorage.getItem(i);if(!a)continue;let r=JSON.parse(a);r._meta?.savedAt&&r._meta.savedAt<s&&(localStorage.removeItem(i),t++,n--)}catch{}}return this.updateStats(),t}clearAll(){localStorage.clear(),this.updateStats()}exportAll(){let e={};for(let t=0;t<localStorage.length;t++){let s=localStorage.key(t);if(s)try{e[s]=JSON.parse(localStorage.getItem(s)||"null")}catch{e[s]=localStorage.getItem(s)}}return JSON.stringify({exportedAt:new Date().toISOString(),version:v,data:e},null,2)}importAll(e){try{let t=JSON.parse(e);if(!t.data)return console.error("[StatePersistence] \u7121\u6548\u7684\u5C0E\u5165\u683C\u5F0F"),!1;for(let[s,n]of Object.entries(t.data))localStorage.setItem(s,JSON.stringify(n));return this.updateStats(),!0}catch(t){return console.error("[StatePersistence] \u5C0E\u5165\u5931\u6557:",t),!1}}checkStorageAvailability(){try{let e="__storage_test__";localStorage.setItem(e,e),localStorage.removeItem(e),this._available.set(!0)}catch{this._available.set(!1),console.warn("[StatePersistence] localStorage \u4E0D\u53EF\u7528")}}runMigrations(){let e=this.load(y.STORAGE_VERSION,0);if(e!==void 0&&e<v){console.log(`[StatePersistence] \u904B\u884C\u9077\u79FB: ${e} -> ${v}`);for(let t=0;t<localStorage.length;t++){let s=localStorage.key(t);if(s)try{let n=this.load(s);if(n){let i=this.migrate(n,e);this.save(s,i)}}catch{}}this.save(y.STORAGE_VERSION,v)}}migrate(e,t){let s=e;for(let n=t+1;n<=v;n++)N[n]&&(s=N[n](s));return s}updateStats(){let e=0,t=[];for(let s=0;s<localStorage.length;s++){let n=localStorage.key(s);if(!n)continue;let i=localStorage.getItem(n),a=new Blob([i||""]).size;e+=a,t.push({key:n,size:a})}t.sort((s,n)=>n.size-s.size),this._stats.set({totalKeys:localStorage.length,totalSize:e,byKey:t})}getUsageInfo(){let e=this._stats();if(!e)return{used:"0 KB",available:"5 MB",percentage:0};let t=e.totalSize/(1024*1024),s=5,n=t/s*100;return{used:t<1?`${(e.totalSize/1024).toFixed(1)} KB`:`${t.toFixed(2)} MB`,available:`${s} MB`,percentage:Math.min(100,n)}}static{this.\u0275fac=function(t){return new(t||l)}}static{this.\u0275prov=f({token:l,factory:l.\u0275fac,providedIn:"root"})}};var U=class l{constructor(){this.persistence=_(C);this._experiments=c([]);this.experiments=this._experiments.asReadonly();this._variantStats=c(new Map);this._userAssignments=c(new Map);this.activeExperiments=S(()=>this._experiments().filter(e=>e.status==="running"));this.activeTests=this.activeExperiments;this.completedExperiments=S(()=>this._experiments().filter(e=>e.status==="completed"));this.stats=S(()=>{let e=this._experiments(),t=this.completedExperiments(),s=0,n=0;return t.forEach(i=>{let a=this.getExperimentResult(i.id);if(a?.recommendedWinner){let r=a.variantStats.find(o=>o.variantId===a.recommendedWinner);r?.uplift&&(s+=r.uplift,n++)}}),{total:e.length,running:this.activeExperiments().length,completed:t.length,draft:e.filter(i=>i.status==="draft").length,avgConversionLift:n>0?s/n:0}});this.STORAGE_KEY="abTesting";this.loadFromStorage()}createExperiment(e){let t=e.variants.reduce((i,a)=>i+a.weight,0),s=e.variants.map((i,a)=>p(d({},i),{id:`var_${Date.now()}_${a}`,weight:Math.round(i.weight/t*100)})),n={id:`exp_${Date.now()}`,name:e.name,description:e.description,status:"draft",variants:s,controlVariantId:s[0].id,primaryMetric:e.primaryMetric,secondaryMetrics:e.secondaryMetrics,createdAt:new Date,sampleSize:e.sampleSize??100,minRunDays:e.minRunDays??7,confidenceLevel:e.confidenceLevel??.95,autoSelectWinner:e.autoSelectWinner??!0};return this._experiments.update(i=>[...i,n]),this._variantStats.update(i=>{let a=new Map(i);return a.set(n.id,s.map(r=>this.createEmptyStats(r.id))),a}),this.saveToStorage(),console.log(`[ABTesting] \u5275\u5EFA\u5BE6\u9A57: ${n.name}`),n}startExperiment(e){let t=this.getExperiment(e);return!t||t.status!=="draft"?!1:(this.updateExperiment(e,{status:"running",startedAt:new Date}),console.log(`[ABTesting] \u958B\u59CB\u5BE6\u9A57: ${t.name}`),!0)}pauseExperiment(e){let t=this.getExperiment(e);return!t||t.status!=="running"?!1:(this.updateExperiment(e,{status:"paused"}),!0)}resumeExperiment(e){let t=this.getExperiment(e);return!t||t.status!=="paused"?!1:(this.updateExperiment(e,{status:"running"}),!0)}endExperiment(e,t){let s=this.getExperiment(e);return s?(this.updateExperiment(e,{status:"completed",endedAt:new Date,winner:t}),console.log(`[ABTesting] \u7D50\u675F\u5BE6\u9A57: ${s.name}, \u512A\u52DD: ${t}`),!0):!1}getExperiment(e){return this._experiments().find(t=>t.id===e)}updateExperiment(e,t){this._experiments.update(s=>s.map(n=>n.id===e?d(d({},n),t):n)),this.saveToStorage()}assignVariant(e,t){let s=this.getExperiment(e);if(!s||s.status!=="running")return null;let n=`${e}_${t}`,i=this._userAssignments().get(n);if(i)return s.variants.find(r=>r.id===i.variantId)||null;let a=this.selectVariantByWeight(s.variants);return this._userAssignments.update(r=>{let o=new Map(r);return o.set(n,{experimentId:e,variantId:a.id,assignedAt:new Date}),o}),this.saveToStorage(),a}selectVariantByWeight(e){let t=e.reduce((n,i)=>n+i.weight,0),s=Math.random()*t;for(let n of e)if(s-=n.weight,s<=0)return n;return e[e.length-1]}getUserVariant(e,t){let s=this.getExperiment(e);if(!s)return null;let n=`${e}_${t}`,i=this._userAssignments().get(n);return i&&s.variants.find(a=>a.id===i.variantId)||null}recordConversion(e,t,s){let n=this.getUserVariant(e,t);n&&(this._variantStats.update(i=>{let a=new Map(i),r=a.get(e)||[],o=r.find(u=>u.variantId===n.id);return o&&(o.sampleSize++,o.conversions++,o.conversionRate=o.conversions/o.sampleSize,o.totalRevenue+=s.revenue||0,s.interestScore!==void 0&&(o.avgInterestScore=(o.avgInterestScore*(o.sampleSize-1)+s.interestScore)/o.sampleSize),s.messageCount!==void 0&&(o.avgMessageCount=(o.avgMessageCount*(o.sampleSize-1)+s.messageCount)/o.sampleSize)),a.set(e,r),a}),this.saveToStorage(),this.checkAutoComplete(e))}recordExposure(e,t){let s=this.getUserVariant(e,t);s&&(this._variantStats.update(n=>{let i=new Map(n),a=i.get(e)||[],r=a.find(o=>o.variantId===s.id);return r&&(r.sampleSize++,r.conversionRate=r.conversions/r.sampleSize),i.set(e,a),i}),this.saveToStorage())}getExperimentResult(e){let t=this.getExperiment(e);if(!t)return null;let s=this._variantStats().get(e)||[],n=s.find(g=>g.variantId===t.controlVariantId),i=s.map(g=>{if(g.variantId===t.controlVariantId)return g;let h=n&&n.conversionRate>0?(g.conversionRate-n.conversionRate)/n.conversionRate*100:0,T=this.calculateSignificance(g,n);return d(p(d({},g),{uplift:h}),T)}),a=i.filter(g=>g.isSignificant&&(g.uplift||0)>0),r=t.startedAt?Math.floor((Date.now()-t.startedAt.getTime())/(1e3*60*60*24)):0,o=i.reduce((g,h)=>g+h.sampleSize,0),u="",m;return o<(t.sampleSize||100)?u=`\u6A23\u672C\u91CF\u4E0D\u8DB3\uFF0C\u5EFA\u8B70\u7E7C\u7E8C\u6536\u96C6\u6578\u64DA\uFF08\u7576\u524D ${o}/${t.sampleSize}\uFF09`:r<(t.minRunDays||7)?u=`\u904B\u884C\u6642\u9593\u4E0D\u8DB3\uFF0C\u5EFA\u8B70\u81F3\u5C11\u904B\u884C ${t.minRunDays} \u5929`:a.length===0?u="\u66AB\u7121\u7D71\u8A08\u986F\u8457\u7684\u512A\u52DD\u8005\uFF0C\u5EFA\u8B70\u7E7C\u7E8C\u89C0\u5BDF\u6216\u8ABF\u6574\u8B8A\u9AD4":a.length===1?(m=a[0].variantId,u=`\u5EFA\u8B70\u9078\u64C7\u8B8A\u9AD4 ${this.getVariantName(t,m)}\uFF0C\u63D0\u5347 ${a[0].uplift?.toFixed(1)}%`):(m=a.sort((h,T)=>(T.uplift||0)-(h.uplift||0))[0].variantId,u=`\u591A\u500B\u8B8A\u9AD4\u8868\u73FE\u512A\u79C0\uFF0C\u5EFA\u8B70\u9078\u64C7 ${this.getVariantName(t,m)}`),{experimentId:e,variantStats:i,overallSampleSize:o,runDays:r,hasSignificantWinner:a.length>0,recommendedWinner:m,recommendation:u}}calculateSignificance(e,t){if(!t||t.sampleSize<30||e.sampleSize<30)return{};let s=e.conversionRate,n=t.conversionRate,i=e.sampleSize,a=t.sampleSize,r=(e.conversions+t.conversions)/(i+a),o=Math.sqrt(r*(1-r)*(1/i+1/a));if(o===0)return{};let u=(s-n)/o,m=2*(1-this.normalCDF(Math.abs(u))),g=1.96*o,h=s-n;return{pValue:m,isSignificant:m<.05,confidenceInterval:[h-g,h+g]}}normalCDF(e){let t=.254829592,s=-.284496736,n=1.421413741,i=-1.453152027,a=1.061405429,r=.3275911,o=e<0?-1:1;e=Math.abs(e)/Math.sqrt(2);let u=1/(1+r*e),m=1-((((a*u+i)*u+n)*u+s)*u+t)*u*Math.exp(-e*e);return .5*(1+o*m)}checkAutoComplete(e){let t=this.getExperiment(e);if(!t||!t.autoSelectWinner)return;let s=this.getExperimentResult(e);s&&s.hasSignificantWinner&&s.overallSampleSize>=(t.sampleSize||100)&&s.runDays>=(t.minRunDays||7)&&(this.endExperiment(e,s.recommendedWinner),console.log(`[ABTesting] \u81EA\u52D5\u9078\u64C7\u512A\u52DD\u8005: ${s.recommendedWinner}`))}getVariantName(e,t){return e.variants.find(s=>s.id===t)?.name||t}createEmptyStats(e){return{variantId:e,sampleSize:0,conversions:0,conversionRate:0,totalRevenue:0,avgInterestScore:0,avgResponseTime:0,avgMessageCount:0}}saveToStorage(){let e={experiments:this._experiments(),variantStats:Array.from(this._variantStats().entries()),userAssignments:Array.from(this._userAssignments().entries()),savedAt:Date.now()};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}loadFromStorage(){try{let e=localStorage.getItem(this.STORAGE_KEY);if(!e)return;let t=JSON.parse(e);t.experiments&&this._experiments.set(t.experiments.map(s=>p(d({},s),{createdAt:new Date(s.createdAt),startedAt:s.startedAt?new Date(s.startedAt):void 0,endedAt:s.endedAt?new Date(s.endedAt):void 0}))),t.variantStats&&this._variantStats.set(new Map(t.variantStats)),t.userAssignments&&this._userAssignments.set(new Map(t.userAssignments.map(s=>[s[0],p(d({},s[1]),{assignedAt:new Date(s[1].assignedAt)})]))),console.log("[ABTesting] \u5DF2\u5F9E\u5B58\u5132\u6062\u5FA9\u6578\u64DA")}catch(e){console.error("[ABTesting] \u6062\u5FA9\u6578\u64DA\u5931\u6557:",e)}}static{this.\u0275fac=function(t){return new(t||l)}}static{this.\u0275prov=f({token:l,factory:l.\u0275fac,providedIn:"root"})}};export{P as a,x as b,R as c,M as d,U as e};
