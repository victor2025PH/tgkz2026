{
  "version": 3,
  "sources": ["src/services/unified-contacts.service.ts", "src/services/lead-scoring.service.ts", "src/services/state-persistence.service.ts", "src/services/ab-testing.service.ts"],
  "sourcesContent": ["/**\r\n * çµ±ä¸€è¯ç¹«äººæœå‹™ - Unified Contacts Service\r\n * æ•´åˆ extracted_members, discovered_resources æ•¸æ“š\r\n * \r\n * åŠŸèƒ½ï¼š\r\n * 1. çµ±ä¸€è¦–åœ–æŸ¥è©¢\r\n * 2. æ•¸æ“šåŒæ­¥\r\n * 3. æ¨™ç±¤ç®¡ç†\r\n * 4. æ‰¹é‡æ“ä½œ\r\n */\r\n\r\nimport { Injectable, inject, signal, computed } from '@angular/core';\r\nimport { ElectronIpcService } from '../electron-ipc.service';\r\n\r\n// è¯ç¹«äººé¡å‹\r\nexport type ContactType = 'user' | 'group' | 'channel';\r\n\r\n// ä¾†æºé¡å‹\r\nexport type SourceType = 'member' | 'resource' | 'lead' | 'manual' | 'import';\r\n\r\n// è¯ç¹«äººç‹€æ…‹\r\n// ğŸ”§ P1: æ“´å±•ç‹€æ…‹é¡å‹æ”¯æŒç™¼é€æ§åˆ¶å°\r\nexport type ContactStatus = 'new' | 'contacted' | 'interested' | 'negotiating' | 'converted' | 'lost' | 'blocked' | 'replied' | 'failed';\r\n\r\n// çµ±ä¸€è¯ç¹«äººæ•¸æ“š\r\nexport interface UnifiedContact {\r\n  id: number;\r\n  telegram_id: string;\r\n  username?: string;\r\n  display_name: string;\r\n  first_name?: string;\r\n  last_name?: string;\r\n  phone?: string;\r\n  \r\n  // é¡å‹\r\n  contact_type: ContactType;\r\n  \r\n  // ä¾†æº\r\n  source_type: SourceType;\r\n  source_id?: string;\r\n  source_name?: string;\r\n  \r\n  // ç‹€æ…‹å’Œæ¨™ç±¤\r\n  status: ContactStatus;\r\n  tags: string[];\r\n  \r\n  // è©•åˆ†\r\n  ai_score: number;\r\n  activity_score: number;\r\n  value_level: string;\r\n  \r\n  // åœ¨ç·šç‹€æ…‹\r\n  is_online: boolean;\r\n  last_seen?: string;\r\n  \r\n  // å±¬æ€§\r\n  is_bot: boolean;\r\n  is_premium: boolean;\r\n  is_verified: boolean;\r\n  member_count?: number;\r\n  \r\n  // äº’å‹•çµ±è¨ˆ\r\n  message_count: number;\r\n  last_contact_at?: string;\r\n  last_message_at?: string;\r\n  \r\n  // å…ƒæ•¸æ“š\r\n  bio?: string;\r\n  notes?: string;\r\n  metadata?: Record<string, any>;\r\n  \r\n  // æ™‚é–“æˆ³\r\n  created_at: string;\r\n  updated_at: string;\r\n  synced_at?: string;\r\n}\r\n\r\n// çµ±è¨ˆæ•¸æ“š\r\nexport interface UnifiedContactStats {\r\n  total: number;\r\n  users: number;\r\n  groups: number;\r\n  channels: number;\r\n  by_status: Record<string, number>;\r\n  by_source: Record<string, number>;\r\n  recent_added: number;\r\n}\r\n\r\n// ç¯©é¸æ¢ä»¶\r\nexport interface ContactFilter {\r\n  contactType?: ContactType;\r\n  sourceType?: SourceType;\r\n  status?: ContactStatus;\r\n  tags?: string[];\r\n  search?: string;\r\n  orderBy?: string;\r\n  limit?: number;\r\n  offset?: number;\r\n}\r\n\r\n// é è¨­æ¨™ç±¤\r\nexport const DEFAULT_TAGS = [\r\n  'é«˜æ„å‘', 'å¾…è·Ÿé€²', 'å·²æˆäº¤', 'æµå¤±é¢¨éšª', 'VIP',\r\n  'æ–°ç™¼ç¾', 'å·²è¯ç¹«', 'éœ€è¦å ±åƒ¹', 'æŠ€è¡“è«®è©¢', 'æ½›åœ¨å¤§å®¢æˆ¶'\r\n];\r\n\r\n// ç‹€æ…‹é¸é …\r\nexport const STATUS_OPTIONS: { value: ContactStatus; label: string; color: string }[] = [\r\n  { value: 'new', label: 'æ–°ç™¼ç¾', color: 'bg-blue-500' },\r\n  { value: 'contacted', label: 'å·²è¯ç¹«', color: 'bg-yellow-500' },\r\n  { value: 'interested', label: 'æœ‰æ„å‘', color: 'bg-green-500' },\r\n  { value: 'negotiating', label: 'æ´½è«‡ä¸­', color: 'bg-purple-500' },\r\n  { value: 'converted', label: 'å·²æˆäº¤', color: 'bg-emerald-500' },\r\n  { value: 'lost', label: 'å·²æµå¤±', color: 'bg-gray-500' },\r\n  { value: 'blocked', label: 'å·²å°é–', color: 'bg-red-500' },\r\n  // ğŸ”§ P1: ç™¼é€æ§åˆ¶å°å°ˆç”¨ç‹€æ…‹\r\n  { value: 'replied', label: 'å·²å›è¦†', color: 'bg-teal-500' },\r\n  { value: 'failed', label: 'ç™¼é€å¤±æ•—', color: 'bg-rose-500' }\r\n];\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class UnifiedContactsService {\r\n  private ipc = inject(ElectronIpcService);\r\n  \r\n  // è¯ç¹«äººåˆ—è¡¨\r\n  private _contacts = signal<UnifiedContact[]>([]);\r\n  contacts = this._contacts.asReadonly();\r\n  \r\n  // çµ±è¨ˆ\r\n  private _stats = signal<UnifiedContactStats>({\r\n    total: 0,\r\n    users: 0,\r\n    groups: 0,\r\n    channels: 0,\r\n    by_status: {},\r\n    by_source: {},\r\n    recent_added: 0\r\n  });\r\n  stats = this._stats.asReadonly();\r\n  \r\n  // ç¸½æ•¸\r\n  private _total = signal(0);\r\n  total = this._total.asReadonly();\r\n  \r\n  // è¼‰å…¥ç‹€æ…‹\r\n  private _isLoading = signal(false);\r\n  isLoading = this._isLoading.asReadonly();\r\n  \r\n  // åŒæ­¥ç‹€æ…‹\r\n  private _isSyncing = signal(false);\r\n  isSyncing = this._isSyncing.asReadonly();\r\n  \r\n  // ğŸ†• æ¨™è¨˜ï¼šæ•¸æ“šæ˜¯å¦å·²å¾ leads å°å…¥ï¼ˆé¿å…é‡è¤‡è«‹æ±‚ï¼‰\r\n  private _hasImportedFromLeads = signal(false);\r\n  hasData = computed(() => this._contacts().length > 0 || this._hasImportedFromLeads());\r\n  \r\n  // ğŸ†• å¾…åˆªé™¤çš„ IDsï¼ˆç”¨æ–¼åˆªé™¤å®Œæˆå¾Œæ›´æ–°æœ¬åœ°ç‹€æ…‹ï¼‰\r\n  private _pendingDeleteIds: Set<string> | undefined;\r\n  \r\n  // ç•¶å‰ç¯©é¸\r\n  private _filter = signal<ContactFilter>({});\r\n  filter = this._filter.asReadonly();\r\n  \r\n  // é¸ä¸­çš„è¯ç¹«äºº\r\n  private _selectedIds = signal<Set<string>>(new Set());\r\n  selectedIds = this._selectedIds.asReadonly();\r\n  \r\n  // è¨ˆç®—å±¬æ€§ï¼šé¸ä¸­çš„è¯ç¹«äººåˆ—è¡¨\r\n  selectedContacts = computed(() => {\r\n    const ids = this._selectedIds();\r\n    return this._contacts().filter(c => ids.has(c.telegram_id));\r\n  });\r\n  \r\n  constructor() {\r\n    this.setupIpcListeners();\r\n  }\r\n  \r\n  private setupIpcListeners() {\r\n    // ç›£è½è¯ç¹«äººåˆ—è¡¨\r\n    this.ipc.on('unified-contacts:list', (data: any) => {\r\n      console.log('[UnifiedContacts] Received list:', data);\r\n      this._isLoading.set(false);\r\n      \r\n      if (data.success) {\r\n        this._contacts.set(data.contacts || []);\r\n        this._total.set(data.total || 0);\r\n      } else {\r\n        console.error('[UnifiedContacts] List error:', data.error);\r\n        this._contacts.set([]);\r\n        this._total.set(0);\r\n      }\r\n    });\r\n    \r\n    // ç›£è½çµ±è¨ˆ\r\n    this.ipc.on('unified-contacts:stats', (data: any) => {\r\n      console.log('[UnifiedContacts] Received stats:', data);\r\n      if (data.success) {\r\n        this._stats.set(data.stats);\r\n      }\r\n    });\r\n    \r\n    // ç›£è¯åŒæ­¥çµæœ\r\n    this.ipc.on('unified-contacts:sync-result', (data: any) => {\r\n      console.log('[UnifiedContacts] ========== SYNC RESULT ==========');\r\n      console.log('[UnifiedContacts] Sync result:', data);\r\n      this._isSyncing.set(false);\r\n      \r\n      if (data.success) {\r\n        console.log('[UnifiedContacts] Sync successful, stats:', data.stats);\r\n        // åŒæ­¥å®Œæˆå¾Œé‡æ–°è¼‰å…¥\r\n        this.loadContacts();\r\n        this.loadStats();\r\n      } else {\r\n        console.error('[UnifiedContacts] Sync failed:', data.error);\r\n      }\r\n    });\r\n    \r\n    // ç›£è½æ›´æ–°çµæœ\r\n    this.ipc.on('unified-contacts:update-result', (data: any) => {\r\n      console.log('[UnifiedContacts] Update result:', data);\r\n      if (data.success) {\r\n        this.loadContacts();\r\n      }\r\n    });\r\n    \r\n    // ç›£è½æ¨™ç±¤æ·»åŠ çµæœ\r\n    this.ipc.on('unified-contacts:add-tags-result', (data: any) => {\r\n      console.log('[UnifiedContacts] Add tags result:', data);\r\n      if (data.success) {\r\n        this.loadContacts();\r\n      }\r\n    });\r\n    \r\n    // ç›£è½ç‹€æ…‹æ›´æ–°çµæœ\r\n    this.ipc.on('unified-contacts:update-status-result', (data: any) => {\r\n      console.log('[UnifiedContacts] Update status result:', data);\r\n      if (data.success) {\r\n        this.loadContacts();\r\n      }\r\n    });\r\n    \r\n    // ç›£è½åˆªé™¤çµæœ\r\n    this.ipc.on('unified-contacts:delete-result', (data: any) => {\r\n      console.log('[UnifiedContacts] Delete result:', data);\r\n      if (data.success) {\r\n        // å¾æœ¬åœ°ç‹€æ…‹ä¸­ç§»é™¤å·²åˆªé™¤çš„é …ç›®\r\n        const deletedIds = this._pendingDeleteIds || new Set<string>();\r\n        const currentContacts = this._contacts();\r\n        const remainingContacts = currentContacts.filter(c => !deletedIds.has(c.telegram_id));\r\n        \r\n        this._contacts.set(remainingContacts);\r\n        this._total.set(remainingContacts.length);\r\n        this._selectedIds.set(new Set());\r\n        this._pendingDeleteIds = undefined;\r\n        \r\n        // æ›´æ–°çµ±è¨ˆ\r\n        this.updateLocalStats(remainingContacts);\r\n        \r\n        console.log('[UnifiedContacts] Deleted successfully, remaining:', remainingContacts.length);\r\n      }\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * åŒæ­¥æ‰€æœ‰ä¾†æºæ•¸æ“š\r\n   */\r\n  syncFromSources() {\r\n    console.log('[UnifiedContacts] ========== SYNC START ==========');\r\n    console.log('[UnifiedContacts] Sending unified-contacts:sync to backend...');\r\n    this._isSyncing.set(true);\r\n    \r\n    // ğŸ”§ FIX: ç¢ºä¿ç™¼é€å‘½ä»¤\r\n    try {\r\n      this.ipc.send('unified-contacts:sync', {});\r\n      console.log('[UnifiedContacts] IPC command sent successfully');\r\n    } catch (e) {\r\n      console.error('[UnifiedContacts] Failed to send IPC command:', e);\r\n      this._isSyncing.set(false);\r\n      return;\r\n    }\r\n    \r\n    // æ·»åŠ è¶…æ™‚ä¿è­·ï¼š60ç§’å¾Œè‡ªå‹•çµæŸåŒæ­¥ç‹€æ…‹ï¼ˆå¢åŠ æ™‚é–“ï¼‰\r\n    setTimeout(() => {\r\n      if (this._isSyncing()) {\r\n        console.warn('[UnifiedContacts] Sync timeout after 60s, resetting state');\r\n        this._isSyncing.set(false);\r\n      }\r\n    }, 60000);\r\n  }\r\n  \r\n  /**\r\n   * å¼·åˆ¶çµæŸæ‰€æœ‰ç‹€æ…‹ï¼ˆåŒæ­¥ + è¼‰å…¥ï¼‰\r\n   */\r\n  forceEndSync() {\r\n    console.log('[UnifiedContacts] Force ending all loading states...');\r\n    this._isSyncing.set(false);\r\n    this._isLoading.set(false);\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• å¼·åˆ¶é‡æ–°è¼‰å…¥è¯ç¹«äººï¼ˆå¿½ç•¥ç·©å­˜ï¼Œç¢ºä¿æ•¸æ“šæœ€æ–°ï¼‰\r\n   */\r\n  forceReloadContacts(filter?: ContactFilter) {\r\n    console.log('[UnifiedContacts] Force reload contacts');\r\n    // é‡ç½®å°å…¥æ¨™è¨˜ï¼Œå¼·åˆ¶å¾å¾Œç«¯ç²å–\r\n    this._hasImportedFromLeads.set(false);\r\n    \r\n    const currentFilter = filter || this._filter();\r\n    this._filter.set(currentFilter);\r\n    this._isLoading.set(true);\r\n    \r\n    // ç²å–æ›´å¤šæ•¸æ“šï¼ˆæé«˜é™åˆ¶ï¼‰\r\n    this.ipc.send('unified-contacts:get', {\r\n      contactType: currentFilter.contactType,\r\n      sourceType: currentFilter.sourceType,\r\n      status: currentFilter.status,\r\n      tags: currentFilter.tags,\r\n      search: currentFilter.search,\r\n      orderBy: currentFilter.orderBy || 'created_at DESC',\r\n      limit: 500,  // ç²å–æ›´å¤šæ•¸æ“š\r\n      offset: 0\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * è¼‰å…¥è¯ç¹«äººåˆ—è¡¨\r\n   * ğŸ†• å„ªåŒ–ï¼šå¦‚æœå·²å¾ leads å°å…¥æ•¸æ“šï¼Œå‰‡åªåœ¨å‰ç«¯éæ¿¾ï¼Œä¸ç™¼é€å¾Œç«¯è«‹æ±‚\r\n   */\r\n  loadContacts(filter?: ContactFilter) {\r\n    const currentFilter = filter || this._filter();\r\n    this._filter.set(currentFilter);\r\n    \r\n    // ğŸ†• å¦‚æœæ•¸æ“šå·²å¾ leads å°å…¥ï¼Œç›´æ¥åœ¨å‰ç«¯æ‡‰ç”¨éæ¿¾ï¼Œä¸è«‹æ±‚å¾Œç«¯\r\n    if (this._hasImportedFromLeads() && this._contacts().length > 0) {\r\n      console.log('[UnifiedContacts] Data already imported from leads, skipping backend request');\r\n      this._isLoading.set(false);\r\n      return;\r\n    }\r\n    \r\n    console.log('[UnifiedContacts] Loading contacts with filter:', currentFilter);\r\n    this._isLoading.set(true);\r\n    \r\n    this.ipc.send('unified-contacts:get', {\r\n      contactType: currentFilter.contactType,\r\n      sourceType: currentFilter.sourceType,\r\n      status: currentFilter.status,\r\n      tags: currentFilter.tags,\r\n      search: currentFilter.search,\r\n      orderBy: currentFilter.orderBy || 'created_at DESC',\r\n      limit: currentFilter.limit || 100,\r\n      offset: currentFilter.offset || 0\r\n    });\r\n    \r\n    // æ·»åŠ è¶…æ™‚ä¿è­·ï¼š15ç§’å¾Œè‡ªå‹•çµæŸè¼‰å…¥ç‹€æ…‹\r\n    setTimeout(() => {\r\n      if (this._isLoading()) {\r\n        console.warn('[UnifiedContacts] Load timeout, resetting state');\r\n        this._isLoading.set(false);\r\n      }\r\n    }, 15000);\r\n  }\r\n  \r\n  /**\r\n   * è¼‰å…¥çµ±è¨ˆæ•¸æ“š\r\n   * ğŸ†• å„ªåŒ–ï¼šå¦‚æœå·²å¾ leads å°å…¥æ•¸æ“šï¼Œè·³éå¾Œç«¯è«‹æ±‚\r\n   */\r\n  loadStats() {\r\n    // ğŸ†• å¦‚æœæ•¸æ“šå·²å¾ leads å°å…¥ï¼Œçµ±è¨ˆå·²åœ¨ importLeadsDirectly ä¸­è¨ˆç®—\r\n    if (this._hasImportedFromLeads()) {\r\n      console.log('[UnifiedContacts] Stats already computed from leads, skipping backend request');\r\n      return;\r\n    }\r\n    \r\n    console.log('[UnifiedContacts] Loading stats...');\r\n    this.ipc.send('unified-contacts:stats', {});\r\n  }\r\n  \r\n  /**\r\n   * è¨­ç½®ç¯©é¸æ¢ä»¶\r\n   */\r\n  setFilter(filter: Partial<ContactFilter>) {\r\n    const newFilter = { ...this._filter(), ...filter };\r\n    this.loadContacts(newFilter);\r\n  }\r\n  \r\n  /**\r\n   * é‡ç½®ç¯©é¸\r\n   */\r\n  resetFilter() {\r\n    this.loadContacts({});\r\n  }\r\n  \r\n  /**\r\n   * æœç´¢\r\n   */\r\n  search(keyword: string) {\r\n    this.setFilter({ search: keyword, offset: 0 });\r\n  }\r\n  \r\n  /**\r\n   * åˆ†é \r\n   */\r\n  setPage(page: number, pageSize: number = 100) {\r\n    this.setFilter({ offset: (page - 1) * pageSize, limit: pageSize });\r\n  }\r\n  \r\n  /**\r\n   * é¸æ“‡/å–æ¶ˆé¸æ“‡è¯ç¹«äºº\r\n   */\r\n  toggleSelect(telegramId: string) {\r\n    const current = new Set(this._selectedIds());\r\n    if (current.has(telegramId)) {\r\n      current.delete(telegramId);\r\n    } else {\r\n      current.add(telegramId);\r\n    }\r\n    this._selectedIds.set(current);\r\n  }\r\n  \r\n  /**\r\n   * å…¨é¸/å–æ¶ˆå…¨é¸\r\n   */\r\n  toggleSelectAll() {\r\n    const current = this._selectedIds();\r\n    const allIds = this._contacts().map(c => c.telegram_id);\r\n    \r\n    if (current.size === allIds.length) {\r\n      this._selectedIds.set(new Set());\r\n    } else {\r\n      this._selectedIds.set(new Set(allIds));\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æ¸…é™¤é¸æ“‡\r\n   */\r\n  clearSelection() {\r\n    this._selectedIds.set(new Set());\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°å–®å€‹è¯ç¹«äºº\r\n   */\r\n  updateContact(telegramId: string, updates: Partial<UnifiedContact>) {\r\n    console.log('[UnifiedContacts] Updating contact:', telegramId, updates);\r\n    this.ipc.send('unified-contacts:update', {\r\n      telegramId,\r\n      updates\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * æ‰¹é‡æ·»åŠ æ¨™ç±¤\r\n   */\r\n  addTags(telegramIds: string[], tags: string[]) {\r\n    console.log('[UnifiedContacts] Adding tags:', telegramIds, tags);\r\n    this.ipc.send('unified-contacts:add-tags', {\r\n      telegramIds,\r\n      tags\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * æ‰¹é‡æ›´æ–°ç‹€æ…‹\r\n   */\r\n  updateStatus(telegramIds: string[], status: ContactStatus) {\r\n    console.log('[UnifiedContacts] Updating status:', telegramIds, status);\r\n    this.ipc.send('unified-contacts:update-status', {\r\n      telegramIds,\r\n      status\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * æ‰¹é‡åˆªé™¤\r\n   */\r\n  deleteContacts(telegramIds: string[]) {\r\n    console.log('[UnifiedContacts] Deleting contacts:', telegramIds.length);\r\n    // ä¿å­˜å¾…åˆªé™¤çš„ IDsï¼Œç”¨æ–¼åˆªé™¤å®Œæˆå¾Œæ›´æ–°æœ¬åœ°ç‹€æ…‹\r\n    this._pendingDeleteIds = new Set(telegramIds);\r\n    this.ipc.send('unified-contacts:delete', {\r\n      telegramIds\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• æ›´æ–°æœ¬åœ°çµ±è¨ˆï¼ˆåˆªé™¤å¾Œä½¿ç”¨ï¼‰\r\n   */\r\n  private updateLocalStats(contacts: UnifiedContact[]) {\r\n    const byStatus: Record<string, number> = {};\r\n    const bySource: Record<string, number> = {};\r\n    \r\n    contacts.forEach(c => {\r\n      byStatus[c.status] = (byStatus[c.status] || 0) + 1;\r\n      bySource[c.source_type] = (bySource[c.source_type] || 0) + 1;\r\n    });\r\n    \r\n    this._stats.set({\r\n      total: contacts.length,\r\n      users: contacts.filter(c => c.contact_type === 'user').length,\r\n      groups: contacts.filter(c => c.contact_type === 'group').length,\r\n      channels: contacts.filter(c => c.contact_type === 'channel').length,\r\n      by_status: byStatus,\r\n      by_source: bySource,\r\n      recent_added: contacts.filter(c => {\r\n        const created = new Date(c.created_at);\r\n        const weekAgo = new Date();\r\n        weekAgo.setDate(weekAgo.getDate() - 7);\r\n        return created > weekAgo;\r\n      }).length\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * ç‚ºé¸ä¸­çš„è¯ç¹«äººæ·»åŠ æ¨™ç±¤\r\n   */\r\n  addTagsToSelected(tags: string[]) {\r\n    const ids = Array.from(this._selectedIds());\r\n    if (ids.length > 0) {\r\n      this.addTags(ids, tags);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°é¸ä¸­è¯ç¹«äººçš„ç‹€æ…‹\r\n   */\r\n  updateSelectedStatus(status: ContactStatus) {\r\n    const ids = Array.from(this._selectedIds());\r\n    if (ids.length > 0) {\r\n      this.updateStatus(ids, status);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * åˆªé™¤é¸ä¸­çš„è¯ç¹«äºº\r\n   */\r\n  deleteSelected() {\r\n    const ids = Array.from(this._selectedIds());\r\n    if (ids.length > 0) {\r\n      this.deleteContacts(ids);\r\n    }\r\n  }\r\n  \r\n  // ==================== æˆå“¡æå–åŒæ­¥ ====================\r\n  \r\n  /**\r\n   * å¾æˆå“¡æå–çµæœå°å…¥è¯ç¹«äºº\r\n   * å°‡æå–çš„æˆå“¡è‡ªå‹•åŒæ­¥åˆ°çµ±ä¸€è¯ç¹«äººåº«\r\n   */\r\n  importFromExtraction(\r\n    members: Array<{\r\n      telegramId: string;\r\n      username?: string;\r\n      firstName?: string;\r\n      lastName?: string;\r\n      displayName: string;\r\n      phone?: string;\r\n      isBot: boolean;\r\n      isPremium: boolean;\r\n      isVerified: boolean;\r\n      onlineStatus: string;\r\n      lastSeen?: string;\r\n      isChinese?: boolean;\r\n      activityScore?: number;\r\n      valueLevel?: string;\r\n    }>,\r\n    source: {\r\n      sourceType: SourceType;\r\n      sourceName: string;\r\n      sourceId?: string;\r\n    }\r\n  ): void {\r\n    if (!members.length) return;\r\n    \r\n    console.log('[UnifiedContacts] Importing from extraction:', members.length, 'members from', source.sourceName);\r\n    \r\n    // ç™¼é€åˆ°å¾Œç«¯è™•ç†\r\n    this.ipc.send('unified-contacts:import-members', {\r\n      members: members.map(m => ({\r\n        telegram_id: m.telegramId,\r\n        username: m.username,\r\n        first_name: m.firstName,\r\n        last_name: m.lastName,\r\n        display_name: m.displayName,\r\n        phone: m.phone,\r\n        is_bot: m.isBot,\r\n        is_premium: m.isPremium,\r\n        is_verified: m.isVerified,\r\n        online_status: m.onlineStatus,\r\n        last_seen: m.lastSeen,\r\n        is_chinese: m.isChinese,\r\n        activity_score: m.activityScore,\r\n        value_level: m.valueLevel\r\n      })),\r\n      sourceType: source.sourceType,\r\n      sourceName: source.sourceName,\r\n      sourceId: source.sourceId\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°è¯ç¹«äººç‹€æ…‹ï¼ˆå¾ç™¼é€æ§åˆ¶å°æ¥æ”¶ï¼‰\r\n   * ç•¶ç”¨æˆ¶å¾ç™¼é€æ§åˆ¶å°ç™¼é€æ¶ˆæ¯å¾Œï¼Œæ›´æ–°è¯ç¹«äººç‹€æ…‹\r\n   */\r\n  updateContactStatus(telegramId: string, status: ContactStatus): void {\r\n    console.log('[UnifiedContacts] Updating single contact status:', telegramId, status);\r\n    this.updateContact(telegramId, { status });\r\n  }\r\n  \r\n  /**\r\n   * åŒæ­¥ç™¼é€æ§åˆ¶å°çš„ç›®æ¨™åˆ—è¡¨\r\n   * è¿”å›æ‰€æœ‰å¯ç™¼é€çš„ç”¨æˆ¶è¯ç¹«äºº\r\n   */\r\n  getSendTargets(): UnifiedContact[] {\r\n    return this._contacts().filter(c => c.contact_type === 'user' && !c.is_bot);\r\n  }\r\n  \r\n  /**\r\n   * æ¨™è¨˜è¯ç¹«äººç‚ºå·²è¯ç¹«\r\n   */\r\n  markAsContacted(telegramIds: string[]): void {\r\n    this.updateStatus(telegramIds, 'contacted');\r\n  }\r\n  \r\n  /**\r\n   * ç²å–æŒ‡å®šä¾†æºçš„è¯ç¹«äººæ•¸é‡\r\n   */\r\n  getCountBySource(sourceType: SourceType): number {\r\n    return this._contacts().filter(c => c.source_type === sourceType).length;\r\n  }\r\n  \r\n  /**\r\n   * ç²å–ç‹€æ…‹æ¨™ç±¤é¡è‰²\r\n   */\r\n  getStatusColor(status: ContactStatus): string {\r\n    const option = STATUS_OPTIONS.find(o => o.value === status);\r\n    return option?.color || 'bg-gray-500';\r\n  }\r\n  \r\n  /**\r\n   * ç²å–ç‹€æ…‹æ¨™ç±¤\r\n   */\r\n  getStatusLabel(status: ContactStatus): string {\r\n    const option = STATUS_OPTIONS.find(o => o.value === status);\r\n    return option?.label || status;\r\n  }\r\n  \r\n  // ==================== ğŸ†• ç›´æ¥å¾ Leads å°å…¥ï¼ˆå‰ç«¯åŒæ­¥ï¼‰ ====================\r\n  \r\n  /**\r\n   * Lead ç‹€æ…‹æ˜ å°„åˆ° Contact ç‹€æ…‹\r\n   */\r\n  private mapLeadStatus(leadStatus: string): ContactStatus {\r\n    const mapping: Record<string, ContactStatus> = {\r\n      'New': 'new',\r\n      'Contacted': 'contacted',\r\n      'Replied': 'interested',\r\n      'Interested': 'interested',\r\n      'Follow-up': 'negotiating',\r\n      'Negotiating': 'negotiating',\r\n      'Closed-Won': 'converted',\r\n      'Closed-Lost': 'lost',\r\n      'Unsubscribed': 'blocked'\r\n    };\r\n    return mapping[leadStatus] || 'new';\r\n  }\r\n  \r\n  /**\r\n   * ç›´æ¥å¾å‰ç«¯ leads æ•¸æ“šå°å…¥åˆ°è³‡æºä¸­å¿ƒ\r\n   * é€™æ¨£å°±ä¸éœ€è¦å¾Œç«¯åŒæ­¥ï¼Œæ•¸æ“šä¿æŒä¸€è‡´\r\n   */\r\n  importLeadsDirectly(leads: any[]): void {\r\n    console.log('[UnifiedContacts] Importing leads directly:', leads.length);\r\n    \r\n    if (!leads || leads.length === 0) {\r\n      return;\r\n    }\r\n    \r\n    // å°‡ leads è½‰æ›ç‚º UnifiedContact æ ¼å¼\r\n    const contacts: UnifiedContact[] = leads.map((lead, index) => ({\r\n      id: lead.id || index,\r\n      telegram_id: String(lead.userId || lead.user_id || ''),\r\n      username: lead.username || '',\r\n      display_name: lead.firstName || lead.username || String(lead.userId || ''),\r\n      first_name: lead.firstName || '',\r\n      last_name: lead.lastName || '',\r\n      phone: lead.phone || '',\r\n      \r\n      contact_type: 'user' as ContactType,\r\n      source_type: (lead.sourceType === 'group_extract' ? 'member' : 'lead') as SourceType,\r\n      source_id: lead.sourceChatId || lead.campaignId?.toString() || '',\r\n      source_name: lead.sourceGroup || lead.sourceChatTitle || 'ç™¼é€æ§åˆ¶å°',\r\n      \r\n      status: this.mapLeadStatus(lead.status || 'New'),\r\n      tags: lead.tags || [],\r\n      \r\n      ai_score: lead.aiScore || 0.5,\r\n      activity_score: lead.activityScore || 0.5,\r\n      value_level: lead.valueLevel || 'C',\r\n      \r\n      is_online: lead.onlineStatus === 'Online',\r\n      last_seen: lead.lastSeen,\r\n      \r\n      is_bot: false,\r\n      is_premium: lead.isPremium || false,\r\n      is_verified: lead.isVerified || false,\r\n      member_count: 0,\r\n      \r\n      message_count: (lead.interactionHistory || []).length,\r\n      last_contact_at: lead.lastContactAt,\r\n      last_message_at: lead.lastMessageAt,\r\n      \r\n      bio: lead.bio || '',\r\n      notes: lead.notes || '',\r\n      metadata: {},\r\n      \r\n      created_at: lead.timestamp || new Date().toISOString(),\r\n      updated_at: new Date().toISOString(),\r\n      synced_at: new Date().toISOString()\r\n    }));\r\n    \r\n    // æ›´æ–°è¯ç¹«äººåˆ—è¡¨\r\n    this._contacts.set(contacts);\r\n    this._total.set(contacts.length);\r\n    \r\n    // æ›´æ–°çµ±è¨ˆ\r\n    const byStatus: Record<string, number> = {};\r\n    const bySource: Record<string, number> = {};\r\n    \r\n    contacts.forEach(c => {\r\n      byStatus[c.status] = (byStatus[c.status] || 0) + 1;\r\n      bySource[c.source_type] = (bySource[c.source_type] || 0) + 1;\r\n    });\r\n    \r\n    this._stats.set({\r\n      total: contacts.length,\r\n      users: contacts.length,\r\n      groups: 0,\r\n      channels: 0,\r\n      by_status: byStatus,\r\n      by_source: bySource,\r\n      recent_added: contacts.filter(c => {\r\n        const created = new Date(c.created_at);\r\n        const weekAgo = new Date();\r\n        weekAgo.setDate(weekAgo.getDate() - 7);\r\n        return created >= weekAgo;\r\n      }).length\r\n    });\r\n    \r\n    this._isLoading.set(false);\r\n    this._isSyncing.set(false);\r\n    \r\n    // ğŸ†• æ¨™è¨˜æ•¸æ“šå·²å°å…¥\r\n    this._hasImportedFromLeads.set(true);\r\n    \r\n    console.log('[UnifiedContacts] Imported', contacts.length, 'contacts from leads');\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• é‡ç½®å°å…¥ç‹€æ…‹ï¼ˆç”¨æ–¼å¼·åˆ¶åˆ·æ–°ï¼‰\r\n   */\r\n  resetImportState() {\r\n    this._hasImportedFromLeads.set(false);\r\n  }\r\n  \r\n  /**\r\n   * æ¸…ç†\r\n   */\r\n  ngOnDestroy() {\r\n    // IPC ç›£è½å™¨éš¨æœå‹™ç”Ÿå‘½é€±æœŸè‡ªå‹•æ¸…ç†\r\n  }\r\n}\r\n", "/**\r\n * å®¢æˆ¶è©•åˆ†æœå‹™\r\n * Lead Scoring Service\r\n * \r\n * åŠŸèƒ½ï¼š\r\n * 1. è¡Œç‚ºè©•åˆ†ï¼ˆäº’å‹•è¡Œç‚ºåŠ åˆ†ï¼‰\r\n * 2. AI è©•åˆ†ï¼ˆå°è©±æ„åœ–åˆ†æï¼‰\r\n * 3. è©•åˆ†è¦å‰‡ç®¡ç†\r\n * 4. è©•åˆ†æ­·å²è¨˜éŒ„\r\n * 5. ç†±åº¦ç­‰ç´šè¨ˆç®—\r\n */\r\n\r\nimport { Injectable, signal, computed, inject } from '@angular/core';\r\nimport { ElectronIpcService } from '../electron-ipc.service';\r\nimport { ToastService } from '../toast.service';\r\n\r\n// è©•åˆ†è¡Œç‚ºé¡å‹\r\nexport type ScoringAction = \r\n  | 'message_sent'        // ç™¼é€æ¶ˆæ¯\r\n  | 'message_opened'      // æ‰“é–‹æ¶ˆæ¯\r\n  | 'message_replied'     // å›è¦†æ¶ˆæ¯\r\n  | 'link_clicked'        // é»æ“Šé€£çµ\r\n  | 'positive_reply'      // æ­£é¢å›è¦†\r\n  | 'negative_reply'      // è² é¢å›è¦†\r\n  | 'question_asked'      // æå•\r\n  | 'price_inquiry'       // è©¢åƒ¹\r\n  | 'meeting_scheduled'   // é ç´„æœƒè­°\r\n  | 'demo_requested'      // è«‹æ±‚æ¼”ç¤º\r\n  | 'referral_made'       // è½‰ä»‹ç´¹\r\n  | 'unsubscribed'        // å–æ¶ˆè¨‚é–±\r\n  | 'complained'          // æŠ•è¨´\r\n  | 'inactive_7d'         // 7å¤©æœªæ´»èº\r\n  | 'inactive_30d';       // 30å¤©æœªæ´»èº\r\n\r\n// è©•åˆ†è¦å‰‡\r\nexport interface ScoringRule {\r\n  id: string;\r\n  action: ScoringAction;\r\n  name: string;\r\n  description: string;\r\n  points: number;           // åˆ†æ•¸ï¼ˆå¯ç‚ºè² æ•¸ï¼‰\r\n  enabled: boolean;\r\n  maxPerDay?: number;       // æ¯æ—¥æœ€å¤§è§¸ç™¼æ¬¡æ•¸\r\n  cooldownMinutes?: number; // å†·å»æ™‚é–“ï¼ˆåˆ†é˜ï¼‰\r\n}\r\n\r\n// ç†±åº¦ç­‰ç´š\r\nexport type HeatLevel = 'cold' | 'warm' | 'hot' | 'burning';\r\n\r\n// è©•åˆ†æ­·å²\r\nexport interface ScoreHistory {\r\n  id: string;\r\n  contactId: string;\r\n  action: ScoringAction;\r\n  points: number;\r\n  reason: string;\r\n  timestamp: string;\r\n  metadata?: any;\r\n}\r\n\r\n// å®¢æˆ¶è©•åˆ†è©³æƒ…\r\nexport interface LeadScore {\r\n  contactId: string;\r\n  totalScore: number;\r\n  heatLevel: HeatLevel;\r\n  \r\n  // åˆ†é¡è©•åˆ†\r\n  behaviorScore: number;    // è¡Œç‚ºè©•åˆ†\r\n  engagementScore: number;  // äº’å‹•è©•åˆ†\r\n  intentScore: number;      // æ„åœ–è©•åˆ†\r\n  recencyScore: number;     // æ™‚æ•ˆè©•åˆ†\r\n  \r\n  // çµ±è¨ˆ\r\n  lastActivity?: string;\r\n  activityCount: number;\r\n  \r\n  // AI åˆ†æ\r\n  aiAnalysis?: {\r\n    sentiment: number;      // æƒ…æ„Ÿåˆ†æ•¸ -1 åˆ° 1\r\n    purchaseIntent: number; // è³¼è²·æ„åœ– 0 åˆ° 100\r\n    urgency: number;        // ç·Šè¿«åº¦ 0 åˆ° 100\r\n    keywords: string[];     // é—œéµè©\r\n  };\r\n  \r\n  // æ­·å²\r\n  history: ScoreHistory[];\r\n  \r\n  updatedAt: string;\r\n}\r\n\r\n// ç†±åº¦ç­‰ç´šé…ç½®\r\ninterface HeatLevelConfig {\r\n  level: HeatLevel;\r\n  minScore: number;\r\n  maxScore: number;\r\n  color: string;\r\n  icon: string;\r\n  label: string;\r\n}\r\n\r\n// é»˜èªè©•åˆ†è¦å‰‡\r\nconst DEFAULT_RULES: ScoringRule[] = [\r\n  // æ­£é¢è¡Œç‚º\r\n  { id: 'r1', action: 'message_replied', name: 'å›è¦†æ¶ˆæ¯', description: 'å®¢æˆ¶å›è¦†äº†æ‚¨çš„æ¶ˆæ¯', points: 10, enabled: true, maxPerDay: 5 },\r\n  { id: 'r2', action: 'positive_reply', name: 'æ­£é¢å›è¦†', description: 'å®¢æˆ¶è¡¨é”äº†èˆˆè¶£æˆ–ç©æ¥µæ…‹åº¦', points: 15, enabled: true },\r\n  { id: 'r3', action: 'question_asked', name: 'ä¸»å‹•æå•', description: 'å®¢æˆ¶ä¸»å‹•è©¢å•ç”¢å“/æœå‹™', points: 20, enabled: true },\r\n  { id: 'r4', action: 'price_inquiry', name: 'è©¢å•åƒ¹æ ¼', description: 'å®¢æˆ¶è©¢å•åƒ¹æ ¼ï¼Œé«˜è³¼è²·æ„å‘', points: 25, enabled: true },\r\n  { id: 'r5', action: 'demo_requested', name: 'è«‹æ±‚æ¼”ç¤º', description: 'å®¢æˆ¶è«‹æ±‚ç”¢å“æ¼”ç¤º', points: 30, enabled: true },\r\n  { id: 'r6', action: 'meeting_scheduled', name: 'é ç´„æœƒè­°', description: 'å®¢æˆ¶åŒæ„é ç´„æœƒè­°', points: 40, enabled: true },\r\n  { id: 'r7', action: 'referral_made', name: 'æ¨è–¦ä»–äºº', description: 'å®¢æˆ¶æ¨è–¦äº†å…¶ä»–æ½›åœ¨å®¢æˆ¶', points: 50, enabled: true },\r\n  \r\n  // ä¸­æ€§è¡Œç‚º\r\n  { id: 'r8', action: 'message_sent', name: 'ç™¼é€æ¶ˆæ¯', description: 'å‘å®¢æˆ¶ç™¼é€æ¶ˆæ¯', points: 2, enabled: true, maxPerDay: 3 },\r\n  { id: 'r9', action: 'message_opened', name: 'æ‰“é–‹æ¶ˆæ¯', description: 'å®¢æˆ¶æ‰“é–‹äº†æ¶ˆæ¯', points: 5, enabled: true, maxPerDay: 5 },\r\n  { id: 'r10', action: 'link_clicked', name: 'é»æ“Šé€£çµ', description: 'å®¢æˆ¶é»æ“Šäº†æ¶ˆæ¯ä¸­çš„é€£çµ', points: 8, enabled: true },\r\n  \r\n  // è² é¢è¡Œç‚º\r\n  { id: 'r11', action: 'negative_reply', name: 'è² é¢å›è¦†', description: 'å®¢æˆ¶è¡¨é”ä¸æ„Ÿèˆˆè¶£', points: -10, enabled: true },\r\n  { id: 'r12', action: 'unsubscribed', name: 'å–æ¶ˆè¨‚é–±', description: 'å®¢æˆ¶å–æ¶ˆè¨‚é–±æˆ–æ‹‰é»‘', points: -30, enabled: true },\r\n  { id: 'r13', action: 'complained', name: 'æŠ•è¨´', description: 'å®¢æˆ¶æŠ•è¨´æˆ–èˆ‰å ±', points: -50, enabled: true },\r\n  { id: 'r14', action: 'inactive_7d', name: '7å¤©æœªæ´»èº', description: 'å®¢æˆ¶7å¤©å…§ç„¡ä»»ä½•äº’å‹•', points: -5, enabled: true },\r\n  { id: 'r15', action: 'inactive_30d', name: '30å¤©æœªæ´»èº', description: 'å®¢æˆ¶30å¤©å…§ç„¡ä»»ä½•äº’å‹•', points: -15, enabled: true },\r\n];\r\n\r\n// ç†±åº¦ç­‰ç´šé…ç½®\r\nconst HEAT_LEVELS: HeatLevelConfig[] = [\r\n  { level: 'cold', minScore: -100, maxScore: 20, color: '#64748b', icon: 'â„ï¸', label: 'å†·æ·¡' },\r\n  { level: 'warm', minScore: 21, maxScore: 50, color: '#eab308', icon: 'ğŸŒ¤ï¸', label: 'æº«å’Œ' },\r\n  { level: 'hot', minScore: 51, maxScore: 100, color: '#f97316', icon: 'ğŸ”¥', label: 'ç†±é–€' },\r\n  { level: 'burning', minScore: 101, maxScore: 999, color: '#ef4444', icon: 'ğŸ’¥', label: 'çˆ†ç†±' },\r\n];\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LeadScoringService {\r\n  private ipc = inject(ElectronIpcService);\r\n  private toast = inject(ToastService);\r\n  \r\n  // è©•åˆ†è¦å‰‡\r\n  private _rules = signal<ScoringRule[]>(DEFAULT_RULES);\r\n  rules = this._rules.asReadonly();\r\n  \r\n  // æ‰€æœ‰å®¢æˆ¶è©•åˆ†\r\n  private _scores = signal<Map<string, LeadScore>>(new Map());\r\n  \r\n  // è©•åˆ†æ­·å²ï¼ˆå…¨å±€ï¼‰\r\n  private _globalHistory = signal<ScoreHistory[]>([]);\r\n  globalHistory = this._globalHistory.asReadonly();\r\n  \r\n  // çµ±è¨ˆ\r\n  stats = computed(() => {\r\n    const scores = Array.from(this._scores().values());\r\n    const byLevel = {\r\n      cold: scores.filter(s => s.heatLevel === 'cold').length,\r\n      warm: scores.filter(s => s.heatLevel === 'warm').length,\r\n      hot: scores.filter(s => s.heatLevel === 'hot').length,\r\n      burning: scores.filter(s => s.heatLevel === 'burning').length,\r\n    };\r\n    \r\n    return {\r\n      total: scores.length,\r\n      avgScore: scores.length > 0 ? scores.reduce((sum, s) => sum + s.totalScore, 0) / scores.length : 0,\r\n      byLevel,\r\n      hotLeads: scores.filter(s => s.heatLevel === 'hot' || s.heatLevel === 'burning'),\r\n    };\r\n  });\r\n  \r\n  constructor() {\r\n    this.loadData();\r\n    this.setupIpcListeners();\r\n  }\r\n  \r\n  /**\r\n   * è¨­ç½® IPC ç›£è½å™¨\r\n   */\r\n  private setupIpcListeners() {\r\n    // ç›£è½æ¶ˆæ¯ç™¼é€äº‹ä»¶\r\n    this.ipc.on('scoring:message-sent', (data: { contactId: string }) => {\r\n      this.recordAction(data.contactId, 'message_sent');\r\n    });\r\n    \r\n    // ç›£è½å›è¦†äº‹ä»¶\r\n    this.ipc.on('scoring:reply-received', (data: { contactId: string; sentiment?: number }) => {\r\n      if (data.sentiment && data.sentiment > 0.3) {\r\n        this.recordAction(data.contactId, 'positive_reply');\r\n      } else if (data.sentiment && data.sentiment < -0.3) {\r\n        this.recordAction(data.contactId, 'negative_reply');\r\n      } else {\r\n        this.recordAction(data.contactId, 'message_replied');\r\n      }\r\n    });\r\n    \r\n    // ç›£è½è©¢åƒ¹äº‹ä»¶\r\n    this.ipc.on('scoring:price-inquiry', (data: { contactId: string }) => {\r\n      this.recordAction(data.contactId, 'price_inquiry');\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * è¼‰å…¥æ•¸æ“š\r\n   */\r\n  private loadData() {\r\n    try {\r\n      // è¼‰å…¥è¦å‰‡\r\n      const rulesStr = localStorage.getItem('tg-matrix-scoring-rules');\r\n      if (rulesStr) {\r\n        this._rules.set(JSON.parse(rulesStr));\r\n      }\r\n      \r\n      // è¼‰å…¥è©•åˆ†\r\n      const scoresStr = localStorage.getItem('tg-matrix-lead-scores');\r\n      if (scoresStr) {\r\n        const scoresArr: LeadScore[] = JSON.parse(scoresStr);\r\n        const scoresMap = new Map<string, LeadScore>();\r\n        scoresArr.forEach(s => scoresMap.set(s.contactId, s));\r\n        this._scores.set(scoresMap);\r\n      }\r\n      \r\n      // è¼‰å…¥æ­·å²\r\n      const historyStr = localStorage.getItem('tg-matrix-scoring-history');\r\n      if (historyStr) {\r\n        this._globalHistory.set(JSON.parse(historyStr));\r\n      }\r\n    } catch (e) {\r\n      console.error('Failed to load scoring data:', e);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ä¿å­˜æ•¸æ“š\r\n   */\r\n  private saveData() {\r\n    try {\r\n      localStorage.setItem('tg-matrix-scoring-rules', JSON.stringify(this._rules()));\r\n      localStorage.setItem('tg-matrix-lead-scores', JSON.stringify(Array.from(this._scores().values())));\r\n      localStorage.setItem('tg-matrix-scoring-history', JSON.stringify(this._globalHistory().slice(0, 1000)));\r\n    } catch (e) {\r\n      console.error('Failed to save scoring data:', e);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * è¨˜éŒ„è©•åˆ†è¡Œç‚º\r\n   */\r\n  recordAction(\r\n    contactId: string,\r\n    action: ScoringAction,\r\n    metadata?: any\r\n  ): number {\r\n    const rule = this._rules().find(r => r.action === action && r.enabled);\r\n    if (!rule) return 0;\r\n    \r\n    // æª¢æŸ¥æ¯æ—¥é™åˆ¶\r\n    if (rule.maxPerDay) {\r\n      const todayCount = this.getTodayActionCount(contactId, action);\r\n      if (todayCount >= rule.maxPerDay) {\r\n        return 0;\r\n      }\r\n    }\r\n    \r\n    // æª¢æŸ¥å†·å»æ™‚é–“\r\n    if (rule.cooldownMinutes) {\r\n      const lastAction = this.getLastActionTime(contactId, action);\r\n      if (lastAction) {\r\n        const cooldownMs = rule.cooldownMinutes * 60 * 1000;\r\n        if (Date.now() - new Date(lastAction).getTime() < cooldownMs) {\r\n          return 0;\r\n        }\r\n      }\r\n    }\r\n    \r\n    // å‰µå»ºæ­·å²è¨˜éŒ„\r\n    const history: ScoreHistory = {\r\n      id: `sh_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n      contactId,\r\n      action,\r\n      points: rule.points,\r\n      reason: rule.name,\r\n      timestamp: new Date().toISOString(),\r\n      metadata\r\n    };\r\n    \r\n    // æ›´æ–°å…¨å±€æ­·å²\r\n    this._globalHistory.update(h => [history, ...h.slice(0, 999)]);\r\n    \r\n    // æ›´æ–°å®¢æˆ¶è©•åˆ†\r\n    this.updateScore(contactId, history);\r\n    \r\n    // ä¿å­˜\r\n    this.saveData();\r\n    \r\n    return rule.points;\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°å®¢æˆ¶è©•åˆ†\r\n   */\r\n  private updateScore(contactId: string, history: ScoreHistory) {\r\n    const scores = this._scores();\r\n    let score = scores.get(contactId);\r\n    \r\n    if (!score) {\r\n      score = this.createNewScore(contactId);\r\n    }\r\n    \r\n    // æ·»åŠ æ­·å²\r\n    score.history = [history, ...score.history.slice(0, 99)];\r\n    \r\n    // é‡æ–°è¨ˆç®—ç¸½åˆ†\r\n    score.totalScore = Math.max(-100, Math.min(999, score.totalScore + history.points));\r\n    \r\n    // æ›´æ–°åˆ†é¡è©•åˆ†\r\n    this.updateCategoryScores(score);\r\n    \r\n    // è¨ˆç®—ç†±åº¦ç­‰ç´š\r\n    score.heatLevel = this.calculateHeatLevel(score.totalScore);\r\n    \r\n    // æ›´æ–°æ´»å‹•ä¿¡æ¯\r\n    score.lastActivity = history.timestamp;\r\n    score.activityCount++;\r\n    score.updatedAt = new Date().toISOString();\r\n    \r\n    // æ›´æ–° Map\r\n    const newScores = new Map(scores);\r\n    newScores.set(contactId, score);\r\n    this._scores.set(newScores);\r\n  }\r\n  \r\n  /**\r\n   * å‰µå»ºæ–°è©•åˆ†è¨˜éŒ„\r\n   */\r\n  private createNewScore(contactId: string): LeadScore {\r\n    return {\r\n      contactId,\r\n      totalScore: 0,\r\n      heatLevel: 'cold',\r\n      behaviorScore: 0,\r\n      engagementScore: 0,\r\n      intentScore: 0,\r\n      recencyScore: 0,\r\n      activityCount: 0,\r\n      history: [],\r\n      updatedAt: new Date().toISOString()\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°åˆ†é¡è©•åˆ†\r\n   */\r\n  private updateCategoryScores(score: LeadScore) {\r\n    const recent = score.history.slice(0, 20);\r\n    \r\n    // è¡Œç‚ºè©•åˆ†\r\n    const behaviorActions: ScoringAction[] = ['message_replied', 'link_clicked', 'message_opened'];\r\n    score.behaviorScore = recent\r\n      .filter(h => behaviorActions.includes(h.action))\r\n      .reduce((sum, h) => sum + h.points, 0);\r\n    \r\n    // äº’å‹•è©•åˆ†\r\n    const engagementActions: ScoringAction[] = ['positive_reply', 'question_asked'];\r\n    score.engagementScore = recent\r\n      .filter(h => engagementActions.includes(h.action))\r\n      .reduce((sum, h) => sum + h.points, 0);\r\n    \r\n    // æ„åœ–è©•åˆ†\r\n    const intentActions: ScoringAction[] = ['price_inquiry', 'demo_requested', 'meeting_scheduled'];\r\n    score.intentScore = recent\r\n      .filter(h => intentActions.includes(h.action))\r\n      .reduce((sum, h) => sum + h.points, 0);\r\n    \r\n    // æ™‚æ•ˆè©•åˆ†ï¼ˆåŸºæ–¼æœ€è¿‘æ´»å‹•æ™‚é–“ï¼‰\r\n    if (score.lastActivity) {\r\n      const daysSinceActivity = (Date.now() - new Date(score.lastActivity).getTime()) / (1000 * 60 * 60 * 24);\r\n      if (daysSinceActivity < 1) {\r\n        score.recencyScore = 20;\r\n      } else if (daysSinceActivity < 3) {\r\n        score.recencyScore = 15;\r\n      } else if (daysSinceActivity < 7) {\r\n        score.recencyScore = 10;\r\n      } else if (daysSinceActivity < 14) {\r\n        score.recencyScore = 5;\r\n      } else {\r\n        score.recencyScore = 0;\r\n      }\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * è¨ˆç®—ç†±åº¦ç­‰ç´š\r\n   */\r\n  private calculateHeatLevel(score: number): HeatLevel {\r\n    for (const config of HEAT_LEVELS) {\r\n      if (score >= config.minScore && score <= config.maxScore) {\r\n        return config.level;\r\n      }\r\n    }\r\n    return 'cold';\r\n  }\r\n  \r\n  /**\r\n   * ç²å–ä»Šæ—¥è¡Œç‚ºè¨ˆæ•¸\r\n   */\r\n  private getTodayActionCount(contactId: string, action: ScoringAction): number {\r\n    const today = new Date().toDateString();\r\n    const score = this._scores().get(contactId);\r\n    if (!score) return 0;\r\n    \r\n    return score.history.filter(h => \r\n      h.action === action && \r\n      new Date(h.timestamp).toDateString() === today\r\n    ).length;\r\n  }\r\n  \r\n  /**\r\n   * ç²å–æœ€å¾Œè¡Œç‚ºæ™‚é–“\r\n   */\r\n  private getLastActionTime(contactId: string, action: ScoringAction): string | null {\r\n    const score = this._scores().get(contactId);\r\n    if (!score) return null;\r\n    \r\n    const lastAction = score.history.find(h => h.action === action);\r\n    return lastAction?.timestamp || null;\r\n  }\r\n  \r\n  /**\r\n   * ç²å–å®¢æˆ¶è©•åˆ†\r\n   */\r\n  getScore(contactId: string): LeadScore | null {\r\n    return this._scores().get(contactId) || null;\r\n  }\r\n  \r\n  /**\r\n   * ç²å–æ‰€æœ‰è©•åˆ†\r\n   */\r\n  getAllScores(): LeadScore[] {\r\n    return Array.from(this._scores().values());\r\n  }\r\n  \r\n  /**\r\n   * ç²å–ç†±é–€å®¢æˆ¶\r\n   */\r\n  getHotLeads(limit = 10): LeadScore[] {\r\n    return this.getAllScores()\r\n      .sort((a, b) => b.totalScore - a.totalScore)\r\n      .slice(0, limit);\r\n  }\r\n  \r\n  /**\r\n   * æŒ‰ç†±åº¦ç­‰ç´šç²å–å®¢æˆ¶\r\n   */\r\n  getLeadsByHeatLevel(level: HeatLevel): LeadScore[] {\r\n    return this.getAllScores().filter(s => s.heatLevel === level);\r\n  }\r\n  \r\n  /**\r\n   * æ‰‹å‹•èª¿æ•´åˆ†æ•¸\r\n   */\r\n  adjustScore(contactId: string, points: number, reason: string): void {\r\n    const history: ScoreHistory = {\r\n      id: `sh_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n      contactId,\r\n      action: 'message_sent', // ä½¿ç”¨é€šç”¨è¡Œç‚º\r\n      points,\r\n      reason: `æ‰‹å‹•èª¿æ•´: ${reason}`,\r\n      timestamp: new Date().toISOString()\r\n    };\r\n    \r\n    this._globalHistory.update(h => [history, ...h.slice(0, 999)]);\r\n    this.updateScore(contactId, history);\r\n    this.saveData();\r\n    \r\n    this.toast.success(`è©•åˆ†å·²èª¿æ•´ ${points > 0 ? '+' : ''}${points} åˆ†`);\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–° AI åˆ†æ\r\n   */\r\n  updateAIAnalysis(contactId: string, analysis: LeadScore['aiAnalysis']): void {\r\n    const scores = this._scores();\r\n    const score = scores.get(contactId);\r\n    if (!score) return;\r\n    \r\n    score.aiAnalysis = analysis;\r\n    \r\n    // æ ¹æ“š AI åˆ†æèª¿æ•´æ„åœ–è©•åˆ†\r\n    if (analysis) {\r\n      const aiBonus = Math.round(analysis.purchaseIntent * 0.3 + analysis.urgency * 0.2);\r\n      score.intentScore = Math.max(0, score.intentScore + aiBonus);\r\n    }\r\n    \r\n    score.updatedAt = new Date().toISOString();\r\n    \r\n    const newScores = new Map(scores);\r\n    newScores.set(contactId, score);\r\n    this._scores.set(newScores);\r\n    this.saveData();\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°è©•åˆ†è¦å‰‡\r\n   */\r\n  updateRule(ruleId: string, updates: Partial<ScoringRule>): void {\r\n    this._rules.update(rules =>\r\n      rules.map(r => r.id === ruleId ? { ...r, ...updates } : r)\r\n    );\r\n    this.saveData();\r\n  }\r\n  \r\n  /**\r\n   * é‡ç½®è¦å‰‡ç‚ºé»˜èªå€¼\r\n   */\r\n  resetRules(): void {\r\n    this._rules.set(DEFAULT_RULES);\r\n    this.saveData();\r\n    this.toast.success('è©•åˆ†è¦å‰‡å·²é‡ç½®');\r\n  }\r\n  \r\n  /**\r\n   * æ¸…é™¤å®¢æˆ¶è©•åˆ†\r\n   */\r\n  clearScore(contactId: string): void {\r\n    const scores = new Map(this._scores());\r\n    scores.delete(contactId);\r\n    this._scores.set(scores);\r\n    this.saveData();\r\n  }\r\n  \r\n  /**\r\n   * ç²å–ç†±åº¦ç­‰ç´šé…ç½®\r\n   */\r\n  getHeatLevelConfig(level: HeatLevel): HeatLevelConfig {\r\n    return HEAT_LEVELS.find(h => h.level === level) || HEAT_LEVELS[0];\r\n  }\r\n  \r\n  /**\r\n   * ç²å–æ‰€æœ‰ç†±åº¦ç­‰ç´šé…ç½®\r\n   */\r\n  getAllHeatLevelConfigs(): HeatLevelConfig[] {\r\n    return HEAT_LEVELS;\r\n  }\r\n  \r\n  /**\r\n   * æ‰¹é‡æª¢æŸ¥ä¸æ´»èºå®¢æˆ¶\r\n   */\r\n  checkInactiveLeads(): void {\r\n    const now = Date.now();\r\n    const scores = this.getAllScores();\r\n    \r\n    for (const score of scores) {\r\n      if (!score.lastActivity) continue;\r\n      \r\n      const lastActivityTime = new Date(score.lastActivity).getTime();\r\n      const daysSinceActivity = (now - lastActivityTime) / (1000 * 60 * 60 * 24);\r\n      \r\n      // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¨˜éŒ„éä¸æ´»èº\r\n      const has7d = score.history.some(h => \r\n        h.action === 'inactive_7d' && \r\n        (now - new Date(h.timestamp).getTime()) < 7 * 24 * 60 * 60 * 1000\r\n      );\r\n      const has30d = score.history.some(h => \r\n        h.action === 'inactive_30d' && \r\n        (now - new Date(h.timestamp).getTime()) < 30 * 24 * 60 * 60 * 1000\r\n      );\r\n      \r\n      if (daysSinceActivity >= 30 && !has30d) {\r\n        this.recordAction(score.contactId, 'inactive_30d');\r\n      } else if (daysSinceActivity >= 7 && !has7d) {\r\n        this.recordAction(score.contactId, 'inactive_7d');\r\n      }\r\n    }\r\n  }\r\n}\r\n", "/**\r\n * ç‹€æ…‹æŒä¹…åŒ–æœå‹™\r\n * State Persistence Service\r\n * \r\n * ğŸ†• P4 éšæ®µï¼šç”¨æˆ¶é«”é©—å„ªåŒ–\r\n * \r\n * åŠŸèƒ½ï¼š\r\n * - çµ±ä¸€å­˜å„²ç®¡ç†\r\n * - è‡ªå‹•åºåˆ—åŒ–/ååºåˆ—åŒ–\r\n * - ç‰ˆæœ¬é·ç§»\r\n * - å­˜å„²æ¸…ç†\r\n */\r\n\r\nimport { Injectable, signal, effect } from '@angular/core';\r\n\r\n// ============ é¡å‹å®šç¾© ============\r\n\r\n/** å­˜å„²éµå®šç¾© */\r\nexport const STORAGE_KEYS = {\r\n  // ç”¨æˆ¶åå¥½\r\n  USER_PREFERENCES: 'user_preferences',\r\n  THEME: 'theme',\r\n  LANGUAGE: 'language',\r\n  \r\n  // æœƒè©±ç‹€æ…‹\r\n  CURRENT_VIEW: 'current_view',\r\n  SIDEBAR_COLLAPSED: 'sidebar_collapsed',\r\n  \r\n  // åŠŸèƒ½æ•¸æ“š\r\n  MARKETING_ANALYTICS: 'marketingAnalytics',\r\n  SMART_TIMING: 'smartTiming',\r\n  SMART_AUTOMATION: 'smartAutomation',\r\n  PLANNER_DRAFT: 'plannerDraft',\r\n  \r\n  // å¸³è™Ÿç›¸é—œ\r\n  ACCOUNTS_CACHE: 'accounts_cache',\r\n  SESSION_PATHS: 'session_paths',\r\n  \r\n  // æœç´¢æ­·å²\r\n  SEARCH_HISTORY: 'search_history',\r\n  RECENT_CONTACTS: 'recent_contacts',\r\n  \r\n  // ç‰ˆæœ¬ä¿¡æ¯\r\n  STORAGE_VERSION: 'storage_version'\r\n} as const;\r\n\r\ntype StorageKey = typeof STORAGE_KEYS[keyof typeof STORAGE_KEYS];\r\n\r\n/** å­˜å„²é …å…ƒæ•¸æ“š */\r\ninterface StorageMetadata {\r\n  key: string;\r\n  version: number;\r\n  savedAt: number;\r\n  expiresAt?: number;\r\n}\r\n\r\n/** å­˜å„²çµ±è¨ˆ */\r\ninterface StorageStats {\r\n  totalKeys: number;\r\n  totalSize: number;  // å­—ç¯€\r\n  byKey: { key: string; size: number }[];\r\n}\r\n\r\n// ============ ç‰ˆæœ¬å®šç¾© ============\r\n\r\nconst CURRENT_VERSION = 1;\r\n\r\n// ç‰ˆæœ¬é·ç§»å‡½æ•¸\r\nconst MIGRATIONS: Record<number, (data: any) => any> = {\r\n  // ç‰ˆæœ¬ 0 -> 1\r\n  1: (data) => {\r\n    // ç¤ºä¾‹é·ç§»ï¼šæ·»åŠ æ–°å­—æ®µ\r\n    return {\r\n      ...data,\r\n      migratedAt: Date.now()\r\n    };\r\n  }\r\n};\r\n\r\n// ============ æœå‹™å¯¦ç¾ ============\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StatePersistenceService {\r\n  \r\n  // å­˜å„²çµ±è¨ˆ\r\n  private _stats = signal<StorageStats | null>(null);\r\n  stats = this._stats.asReadonly();\r\n  \r\n  // å­˜å„²æ˜¯å¦å¯ç”¨\r\n  private _available = signal(true);\r\n  available = this._available.asReadonly();\r\n  \r\n  constructor() {\r\n    this.checkStorageAvailability();\r\n    this.runMigrations();\r\n    this.updateStats();\r\n  }\r\n  \r\n  // ============ æ ¸å¿ƒæ–¹æ³• ============\r\n  \r\n  /**\r\n   * ä¿å­˜æ•¸æ“š\r\n   */\r\n  save<T>(key: StorageKey, data: T, options?: {\r\n    ttl?: number;  // éæœŸæ™‚é–“ï¼ˆæ¯«ç§’ï¼‰\r\n    version?: number;\r\n  }): boolean {\r\n    if (!this._available()) return false;\r\n    \r\n    try {\r\n      const metadata: StorageMetadata = {\r\n        key,\r\n        version: options?.version ?? CURRENT_VERSION,\r\n        savedAt: Date.now(),\r\n        expiresAt: options?.ttl ? Date.now() + options.ttl : undefined\r\n      };\r\n      \r\n      const wrapper = {\r\n        _meta: metadata,\r\n        data\r\n      };\r\n      \r\n      localStorage.setItem(key, JSON.stringify(wrapper));\r\n      this.updateStats();\r\n      return true;\r\n    } catch (error: any) {\r\n      console.error(`[StatePersistence] ä¿å­˜å¤±æ•— (${key}):`, error);\r\n      \r\n      // å­˜å„²æ»¿æ™‚å˜—è©¦æ¸…ç†\r\n      if (error.name === 'QuotaExceededError') {\r\n        this.cleanup();\r\n        // é‡è©¦ä¸€æ¬¡\r\n        try {\r\n          localStorage.setItem(key, JSON.stringify({ data, _meta: { key, version: CURRENT_VERSION, savedAt: Date.now() } }));\r\n          return true;\r\n        } catch {\r\n          return false;\r\n        }\r\n      }\r\n      \r\n      return false;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * è®€å–æ•¸æ“š\r\n   */\r\n  load<T>(key: StorageKey, defaultValue?: T): T | undefined {\r\n    if (!this._available()) return defaultValue;\r\n    \r\n    try {\r\n      const stored = localStorage.getItem(key);\r\n      if (!stored) return defaultValue;\r\n      \r\n      const wrapper = JSON.parse(stored);\r\n      \r\n      // æª¢æŸ¥æ˜¯å¦æœ‰å…ƒæ•¸æ“š\r\n      if (wrapper._meta) {\r\n        // æª¢æŸ¥éæœŸ\r\n        if (wrapper._meta.expiresAt && Date.now() > wrapper._meta.expiresAt) {\r\n          this.remove(key);\r\n          return defaultValue;\r\n        }\r\n        \r\n        // ç‰ˆæœ¬é·ç§»\r\n        if (wrapper._meta.version < CURRENT_VERSION) {\r\n          const migrated = this.migrate(wrapper.data, wrapper._meta.version);\r\n          this.save(key, migrated);\r\n          return migrated as T;\r\n        }\r\n        \r\n        return wrapper.data as T;\r\n      }\r\n      \r\n      // èˆŠæ ¼å¼æ•¸æ“šï¼ˆç„¡å…ƒæ•¸æ“šï¼‰\r\n      return wrapper as T;\r\n    } catch (error) {\r\n      console.error(`[StatePersistence] è®€å–å¤±æ•— (${key}):`, error);\r\n      return defaultValue;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * åˆªé™¤æ•¸æ“š\r\n   */\r\n  remove(key: StorageKey): boolean {\r\n    try {\r\n      localStorage.removeItem(key);\r\n      this.updateStats();\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æª¢æŸ¥æ•¸æ“šæ˜¯å¦å­˜åœ¨\r\n   */\r\n  has(key: StorageKey): boolean {\r\n    return localStorage.getItem(key) !== null;\r\n  }\r\n  \r\n  // ============ æ‰¹é‡æ“ä½œ ============\r\n  \r\n  /**\r\n   * æ‰¹é‡ä¿å­˜\r\n   */\r\n  saveMultiple(items: { key: StorageKey; data: any }[]): boolean {\r\n    let allSuccess = true;\r\n    for (const item of items) {\r\n      if (!this.save(item.key, item.data)) {\r\n        allSuccess = false;\r\n      }\r\n    }\r\n    return allSuccess;\r\n  }\r\n  \r\n  /**\r\n   * æ‰¹é‡è®€å–\r\n   */\r\n  loadMultiple<T extends Record<string, any>>(keys: StorageKey[]): Partial<T> {\r\n    const result: Partial<T> = {};\r\n    for (const key of keys) {\r\n      (result as any)[key] = this.load(key);\r\n    }\r\n    return result;\r\n  }\r\n  \r\n  // ============ ç”¨æˆ¶åå¥½ ============\r\n  \r\n  /**\r\n   * ä¿å­˜ç”¨æˆ¶åå¥½\r\n   */\r\n  savePreference<T>(prefKey: string, value: T) {\r\n    const prefs = this.load<Record<string, any>>(STORAGE_KEYS.USER_PREFERENCES, {});\r\n    prefs[prefKey] = value;\r\n    this.save(STORAGE_KEYS.USER_PREFERENCES, prefs);\r\n  }\r\n  \r\n  /**\r\n   * è®€å–ç”¨æˆ¶åå¥½\r\n   */\r\n  loadPreference<T>(prefKey: string, defaultValue?: T): T | undefined {\r\n    const prefs = this.load<Record<string, any>>(STORAGE_KEYS.USER_PREFERENCES, {});\r\n    return (prefs[prefKey] as T) ?? defaultValue;\r\n  }\r\n  \r\n  // ============ æœƒè©±ç‹€æ…‹ ============\r\n  \r\n  /**\r\n   * ä¿å­˜æœƒè©±ç‹€æ…‹ï¼ˆä½¿ç”¨ sessionStorageï¼‰\r\n   */\r\n  saveSession<T>(key: string, data: T): boolean {\r\n    try {\r\n      sessionStorage.setItem(key, JSON.stringify(data));\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * è®€å–æœƒè©±ç‹€æ…‹\r\n   */\r\n  loadSession<T>(key: string, defaultValue?: T): T | undefined {\r\n    try {\r\n      const stored = sessionStorage.getItem(key);\r\n      return stored ? JSON.parse(stored) : defaultValue;\r\n    } catch {\r\n      return defaultValue;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æ¸…é™¤æœƒè©±ç‹€æ…‹\r\n   */\r\n  clearSession(): void {\r\n    sessionStorage.clear();\r\n  }\r\n  \r\n  // ============ æ¸…ç†å’Œç¶­è­· ============\r\n  \r\n  /**\r\n   * æ¸…ç†éæœŸæ•¸æ“š\r\n   */\r\n  cleanup(): number {\r\n    let cleaned = 0;\r\n    const now = Date.now();\r\n    \r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (!key) continue;\r\n      \r\n      try {\r\n        const stored = localStorage.getItem(key);\r\n        if (!stored) continue;\r\n        \r\n        const wrapper = JSON.parse(stored);\r\n        \r\n        // æ¸…ç†éæœŸæ•¸æ“š\r\n        if (wrapper._meta?.expiresAt && now > wrapper._meta.expiresAt) {\r\n          localStorage.removeItem(key);\r\n          cleaned++;\r\n          i--;  // èª¿æ•´ç´¢å¼•\r\n        }\r\n      } catch {\r\n        // ç„¡æ³•è§£æçš„æ•¸æ“šï¼Œè·³é\r\n      }\r\n    }\r\n    \r\n    this.updateStats();\r\n    console.log(`[StatePersistence] æ¸…ç†äº† ${cleaned} å€‹éæœŸé …`);\r\n    return cleaned;\r\n  }\r\n  \r\n  /**\r\n   * æ¸…ç†èˆŠæ•¸æ“šï¼ˆæŒ‰æ™‚é–“ï¼‰\r\n   */\r\n  cleanupOld(maxAge: number = 30 * 24 * 60 * 60 * 1000): number {\r\n    let cleaned = 0;\r\n    const cutoff = Date.now() - maxAge;\r\n    \r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (!key) continue;\r\n      \r\n      try {\r\n        const stored = localStorage.getItem(key);\r\n        if (!stored) continue;\r\n        \r\n        const wrapper = JSON.parse(stored);\r\n        \r\n        if (wrapper._meta?.savedAt && wrapper._meta.savedAt < cutoff) {\r\n          localStorage.removeItem(key);\r\n          cleaned++;\r\n          i--;\r\n        }\r\n      } catch {\r\n        // è·³é\r\n      }\r\n    }\r\n    \r\n    this.updateStats();\r\n    return cleaned;\r\n  }\r\n  \r\n  /**\r\n   * æ¸…é™¤æ‰€æœ‰å­˜å„²\r\n   */\r\n  clearAll(): void {\r\n    localStorage.clear();\r\n    this.updateStats();\r\n  }\r\n  \r\n  // ============ å°å…¥/å°å‡º ============\r\n  \r\n  /**\r\n   * å°å‡ºæ‰€æœ‰æ•¸æ“š\r\n   */\r\n  exportAll(): string {\r\n    const data: Record<string, any> = {};\r\n    \r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (!key) continue;\r\n      \r\n      try {\r\n        data[key] = JSON.parse(localStorage.getItem(key) || 'null');\r\n      } catch {\r\n        data[key] = localStorage.getItem(key);\r\n      }\r\n    }\r\n    \r\n    return JSON.stringify({\r\n      exportedAt: new Date().toISOString(),\r\n      version: CURRENT_VERSION,\r\n      data\r\n    }, null, 2);\r\n  }\r\n  \r\n  /**\r\n   * å°å…¥æ•¸æ“š\r\n   */\r\n  importAll(jsonString: string): boolean {\r\n    try {\r\n      const imported = JSON.parse(jsonString);\r\n      \r\n      if (!imported.data) {\r\n        console.error('[StatePersistence] ç„¡æ•ˆçš„å°å…¥æ ¼å¼');\r\n        return false;\r\n      }\r\n      \r\n      for (const [key, value] of Object.entries(imported.data)) {\r\n        localStorage.setItem(key, JSON.stringify(value));\r\n      }\r\n      \r\n      this.updateStats();\r\n      return true;\r\n    } catch (error) {\r\n      console.error('[StatePersistence] å°å…¥å¤±æ•—:', error);\r\n      return false;\r\n    }\r\n  }\r\n  \r\n  // ============ å…§éƒ¨æ–¹æ³• ============\r\n  \r\n  /**\r\n   * æª¢æŸ¥å­˜å„²å¯ç”¨æ€§\r\n   */\r\n  private checkStorageAvailability(): void {\r\n    try {\r\n      const test = '__storage_test__';\r\n      localStorage.setItem(test, test);\r\n      localStorage.removeItem(test);\r\n      this._available.set(true);\r\n    } catch {\r\n      this._available.set(false);\r\n      console.warn('[StatePersistence] localStorage ä¸å¯ç”¨');\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * é‹è¡Œç‰ˆæœ¬é·ç§»\r\n   */\r\n  private runMigrations(): void {\r\n    const storedVersion = this.load<number>(STORAGE_KEYS.STORAGE_VERSION as StorageKey, 0);\r\n    \r\n    if (storedVersion !== undefined && storedVersion < CURRENT_VERSION) {\r\n      console.log(`[StatePersistence] é‹è¡Œé·ç§»: ${storedVersion} -> ${CURRENT_VERSION}`);\r\n      \r\n      // é·ç§»æ¯å€‹å­˜å„²é …\r\n      for (let i = 0; i < localStorage.length; i++) {\r\n        const key = localStorage.key(i);\r\n        if (!key) continue;\r\n        \r\n        try {\r\n          const data = this.load(key as StorageKey);\r\n          if (data) {\r\n            const migrated = this.migrate(data, storedVersion);\r\n            this.save(key as StorageKey, migrated);\r\n          }\r\n        } catch {\r\n          // è·³éç„¡æ³•é·ç§»çš„é …\r\n        }\r\n      }\r\n      \r\n      this.save(STORAGE_KEYS.STORAGE_VERSION as StorageKey, CURRENT_VERSION);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * é·ç§»æ•¸æ“š\r\n   */\r\n  private migrate(data: any, fromVersion: number): any {\r\n    let result = data;\r\n    \r\n    for (let v = fromVersion + 1; v <= CURRENT_VERSION; v++) {\r\n      if (MIGRATIONS[v]) {\r\n        result = MIGRATIONS[v](result);\r\n      }\r\n    }\r\n    \r\n    return result;\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°å­˜å„²çµ±è¨ˆ\r\n   */\r\n  private updateStats(): void {\r\n    let totalSize = 0;\r\n    const byKey: { key: string; size: number }[] = [];\r\n    \r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (!key) continue;\r\n      \r\n      const value = localStorage.getItem(key);\r\n      const size = new Blob([value || '']).size;\r\n      totalSize += size;\r\n      byKey.push({ key, size });\r\n    }\r\n    \r\n    byKey.sort((a, b) => b.size - a.size);\r\n    \r\n    this._stats.set({\r\n      totalKeys: localStorage.length,\r\n      totalSize,\r\n      byKey\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * ç²å–å­˜å„²ä½¿ç”¨æƒ…æ³\r\n   */\r\n  getUsageInfo(): { used: string; available: string; percentage: number } {\r\n    const stats = this._stats();\r\n    if (!stats) {\r\n      return { used: '0 KB', available: '5 MB', percentage: 0 };\r\n    }\r\n    \r\n    const usedMB = stats.totalSize / (1024 * 1024);\r\n    const availableMB = 5; // å‡è¨­ 5MB é™åˆ¶\r\n    const percentage = (usedMB / availableMB) * 100;\r\n    \r\n    return {\r\n      used: usedMB < 1 ? `${(stats.totalSize / 1024).toFixed(1)} KB` : `${usedMB.toFixed(2)} MB`,\r\n      available: `${availableMB} MB`,\r\n      percentage: Math.min(100, percentage)\r\n    };\r\n  }\r\n}\r\n", "/**\r\n * A/B æ¸¬è©¦æœå‹™\r\n * A/B Testing Service\r\n * \r\n * ğŸ†• P5 éšæ®µï¼šé«˜ç´šåŠŸèƒ½æ“´å±•\r\n * \r\n * åŠŸèƒ½ï¼š\r\n * - å‰µå»ºå’Œç®¡ç†å¯¦é©—\r\n * - è®Šé«”åˆ†é…\r\n * - æ•ˆæœçµ±è¨ˆ\r\n * - è‡ªå‹•å„ªå‹é¸æ“‡\r\n */\r\n\r\nimport { Injectable, signal, computed, inject } from '@angular/core';\r\nimport { StatePersistenceService } from './state-persistence.service';\r\n\r\n// ============ é¡å‹å®šç¾© ============\r\n\r\n/** å¯¦é©—ç‹€æ…‹ */\r\nexport type ExperimentStatus = 'draft' | 'running' | 'paused' | 'completed' | 'archived';\r\n\r\n/** è®Šé«”é¡å‹ */\r\nexport interface Variant {\r\n  id: string;\r\n  name: string;\r\n  description?: string;\r\n  weight: number;           // åˆ†é…æ¬Šé‡ (0-100)\r\n  config: Record<string, any>;  // è®Šé«”é…ç½®\r\n}\r\n\r\n/** å¯¦é©—å®šç¾© */\r\nexport interface Experiment {\r\n  id: string;\r\n  name: string;\r\n  description?: string;\r\n  status: ExperimentStatus;\r\n  \r\n  // è®Šé«”\r\n  variants: Variant[];\r\n  controlVariantId: string;  // å°ç…§çµ„\r\n  \r\n  // ç›®æ¨™\r\n  primaryMetric: MetricType;\r\n  secondaryMetrics?: MetricType[];\r\n  \r\n  // æ™‚é–“\r\n  createdAt: Date;\r\n  startedAt?: Date;\r\n  endedAt?: Date;\r\n  \r\n  // é…ç½®\r\n  sampleSize?: number;       // ç›®æ¨™æ¨£æœ¬é‡\r\n  minRunDays?: number;       // æœ€å°é‹è¡Œå¤©æ•¸\r\n  confidenceLevel?: number;  // ç½®ä¿¡åº¦ (0.9-0.99)\r\n  \r\n  // çµæœ\r\n  winner?: string;           // å„ªå‹è®Šé«” ID\r\n  autoSelectWinner?: boolean;\r\n}\r\n\r\n/** æŒ‡æ¨™é¡å‹ */\r\nexport type MetricType = \r\n  | 'conversion_rate'    // è½‰åŒ–ç‡\r\n  | 'response_rate'      // å›è¦†ç‡\r\n  | 'avg_interest_score' // å¹³å‡èˆˆè¶£åº¦\r\n  | 'avg_message_count'  // å¹³å‡æ¶ˆæ¯æ•¸\r\n  | 'revenue'            // æ”¶å…¥\r\n  | 'engagement_time';   // äº’å‹•æ™‚é•·\r\n\r\n/** è®Šé«”çµ±è¨ˆ */\r\nexport interface VariantStats {\r\n  variantId: string;\r\n  sampleSize: number;\r\n  \r\n  // æ ¸å¿ƒæŒ‡æ¨™\r\n  conversions: number;\r\n  conversionRate: number;\r\n  \r\n  // å…¶ä»–æŒ‡æ¨™\r\n  totalRevenue: number;\r\n  avgInterestScore: number;\r\n  avgResponseTime: number;\r\n  avgMessageCount: number;\r\n  \r\n  // çµ±è¨ˆé¡¯è‘—æ€§\r\n  pValue?: number;\r\n  confidenceInterval?: [number, number];\r\n  isSignificant?: boolean;\r\n  \r\n  // ç›¸å°æå‡\r\n  uplift?: number;  // ç›¸å°å°ç…§çµ„çš„æå‡\r\n}\r\n\r\n/** å¯¦é©—çµæœ */\r\nexport interface ExperimentResult {\r\n  experimentId: string;\r\n  variantStats: VariantStats[];\r\n  overallSampleSize: number;\r\n  runDays: number;\r\n  hasSignificantWinner: boolean;\r\n  recommendedWinner?: string;\r\n  recommendation: string;\r\n}\r\n\r\n/** ç”¨æˆ¶åˆ†é…è¨˜éŒ„ */\r\ninterface UserAssignment {\r\n  experimentId: string;\r\n  variantId: string;\r\n  assignedAt: Date;\r\n}\r\n\r\n// ============ æœå‹™å¯¦ç¾ ============\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ABTestingService {\r\n  private persistence = inject(StatePersistenceService);\r\n  \r\n  // å¯¦é©—åˆ—è¡¨\r\n  private _experiments = signal<Experiment[]>([]);\r\n  experiments = this._experiments.asReadonly();\r\n  \r\n  // è®Šé«”çµ±è¨ˆ\r\n  private _variantStats = signal<Map<string, VariantStats[]>>(new Map());\r\n  \r\n  // ç”¨æˆ¶åˆ†é…\r\n  private _userAssignments = signal<Map<string, UserAssignment>>(new Map());\r\n  \r\n  // æ´»èºå¯¦é©—\r\n  activeExperiments = computed(() => \r\n    this._experiments().filter(e => e.status === 'running')\r\n  );\r\n  \r\n  // ğŸ”§ å…¼å®¹èˆŠç‰ˆï¼šactiveTests åˆ¥å\r\n  activeTests = this.activeExperiments;\r\n  \r\n  // å·²å®Œæˆå¯¦é©—\r\n  completedExperiments = computed(() => \r\n    this._experiments().filter(e => e.status === 'completed')\r\n  );\r\n  \r\n  // ğŸ”§ å…¼å®¹èˆŠç‰ˆï¼šçµ±è¨ˆä¿¡è™Ÿ\r\n  stats = computed(() => {\r\n    const experiments = this._experiments();\r\n    const completed = this.completedExperiments();\r\n    \r\n    // è¨ˆç®—å¹³å‡æå‡\r\n    let totalLift = 0;\r\n    let liftCount = 0;\r\n    \r\n    completed.forEach(exp => {\r\n      const result = this.getExperimentResult(exp.id);\r\n      if (result?.recommendedWinner) {\r\n        const winnerStats = result.variantStats.find(s => s.variantId === result.recommendedWinner);\r\n        if (winnerStats?.uplift) {\r\n          totalLift += winnerStats.uplift;\r\n          liftCount++;\r\n        }\r\n      }\r\n    });\r\n    \r\n    return {\r\n      total: experiments.length,\r\n      running: this.activeExperiments().length,\r\n      completed: completed.length,\r\n      draft: experiments.filter(e => e.status === 'draft').length,\r\n      avgConversionLift: liftCount > 0 ? totalLift / liftCount : 0\r\n    };\r\n  });\r\n  \r\n  private readonly STORAGE_KEY = 'abTesting';\r\n  \r\n  constructor() {\r\n    this.loadFromStorage();\r\n  }\r\n  \r\n  // ============ å¯¦é©—ç®¡ç† ============\r\n  \r\n  /**\r\n   * å‰µå»ºå¯¦é©—\r\n   */\r\n  createExperiment(config: {\r\n    name: string;\r\n    description?: string;\r\n    variants: Omit<Variant, 'id'>[];\r\n    primaryMetric: MetricType;\r\n    secondaryMetrics?: MetricType[];\r\n    sampleSize?: number;\r\n    minRunDays?: number;\r\n    confidenceLevel?: number;\r\n    autoSelectWinner?: boolean;\r\n  }): Experiment {\r\n    // ç¢ºä¿æ¬Šé‡ç¸½å’Œç‚º 100\r\n    const totalWeight = config.variants.reduce((sum, v) => sum + v.weight, 0);\r\n    const normalizedVariants: Variant[] = config.variants.map((v, i) => ({\r\n      ...v,\r\n      id: `var_${Date.now()}_${i}`,\r\n      weight: Math.round((v.weight / totalWeight) * 100)\r\n    }));\r\n    \r\n    const experiment: Experiment = {\r\n      id: `exp_${Date.now()}`,\r\n      name: config.name,\r\n      description: config.description,\r\n      status: 'draft',\r\n      variants: normalizedVariants,\r\n      controlVariantId: normalizedVariants[0].id,\r\n      primaryMetric: config.primaryMetric,\r\n      secondaryMetrics: config.secondaryMetrics,\r\n      createdAt: new Date(),\r\n      sampleSize: config.sampleSize ?? 100,\r\n      minRunDays: config.minRunDays ?? 7,\r\n      confidenceLevel: config.confidenceLevel ?? 0.95,\r\n      autoSelectWinner: config.autoSelectWinner ?? true\r\n    };\r\n    \r\n    this._experiments.update(exps => [...exps, experiment]);\r\n    \r\n    // åˆå§‹åŒ–çµ±è¨ˆ\r\n    this._variantStats.update(stats => {\r\n      const newStats = new Map(stats);\r\n      newStats.set(experiment.id, normalizedVariants.map(v => this.createEmptyStats(v.id)));\r\n      return newStats;\r\n    });\r\n    \r\n    this.saveToStorage();\r\n    console.log(`[ABTesting] å‰µå»ºå¯¦é©—: ${experiment.name}`);\r\n    return experiment;\r\n  }\r\n  \r\n  /**\r\n   * é–‹å§‹å¯¦é©—\r\n   */\r\n  startExperiment(experimentId: string): boolean {\r\n    const experiment = this.getExperiment(experimentId);\r\n    if (!experiment || experiment.status !== 'draft') return false;\r\n    \r\n    this.updateExperiment(experimentId, {\r\n      status: 'running',\r\n      startedAt: new Date()\r\n    });\r\n    \r\n    console.log(`[ABTesting] é–‹å§‹å¯¦é©—: ${experiment.name}`);\r\n    return true;\r\n  }\r\n  \r\n  /**\r\n   * æš«åœå¯¦é©—\r\n   */\r\n  pauseExperiment(experimentId: string): boolean {\r\n    const experiment = this.getExperiment(experimentId);\r\n    if (!experiment || experiment.status !== 'running') return false;\r\n    \r\n    this.updateExperiment(experimentId, { status: 'paused' });\r\n    return true;\r\n  }\r\n  \r\n  /**\r\n   * æ¢å¾©å¯¦é©—\r\n   */\r\n  resumeExperiment(experimentId: string): boolean {\r\n    const experiment = this.getExperiment(experimentId);\r\n    if (!experiment || experiment.status !== 'paused') return false;\r\n    \r\n    this.updateExperiment(experimentId, { status: 'running' });\r\n    return true;\r\n  }\r\n  \r\n  /**\r\n   * çµæŸå¯¦é©—\r\n   */\r\n  endExperiment(experimentId: string, winnerId?: string): boolean {\r\n    const experiment = this.getExperiment(experimentId);\r\n    if (!experiment) return false;\r\n    \r\n    this.updateExperiment(experimentId, {\r\n      status: 'completed',\r\n      endedAt: new Date(),\r\n      winner: winnerId\r\n    });\r\n    \r\n    console.log(`[ABTesting] çµæŸå¯¦é©—: ${experiment.name}, å„ªå‹: ${winnerId}`);\r\n    return true;\r\n  }\r\n  \r\n  /**\r\n   * ç²å–å¯¦é©—\r\n   */\r\n  getExperiment(experimentId: string): Experiment | undefined {\r\n    return this._experiments().find(e => e.id === experimentId);\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°å¯¦é©—\r\n   */\r\n  private updateExperiment(experimentId: string, updates: Partial<Experiment>) {\r\n    this._experiments.update(exps => \r\n      exps.map(e => e.id === experimentId ? { ...e, ...updates } : e)\r\n    );\r\n    this.saveToStorage();\r\n  }\r\n  \r\n  // ============ è®Šé«”åˆ†é… ============\r\n  \r\n  /**\r\n   * åˆ†é…è®Šé«”\r\n   */\r\n  assignVariant(experimentId: string, userId: string): Variant | null {\r\n    const experiment = this.getExperiment(experimentId);\r\n    if (!experiment || experiment.status !== 'running') return null;\r\n    \r\n    // æª¢æŸ¥æ˜¯å¦å·²åˆ†é…\r\n    const existingKey = `${experimentId}_${userId}`;\r\n    const existing = this._userAssignments().get(existingKey);\r\n    if (existing) {\r\n      return experiment.variants.find(v => v.id === existing.variantId) || null;\r\n    }\r\n    \r\n    // æ ¹æ“šæ¬Šé‡éš¨æ©Ÿåˆ†é…\r\n    const variant = this.selectVariantByWeight(experiment.variants);\r\n    \r\n    // è¨˜éŒ„åˆ†é…\r\n    this._userAssignments.update(assignments => {\r\n      const newAssignments = new Map(assignments);\r\n      newAssignments.set(existingKey, {\r\n        experimentId,\r\n        variantId: variant.id,\r\n        assignedAt: new Date()\r\n      });\r\n      return newAssignments;\r\n    });\r\n    \r\n    this.saveToStorage();\r\n    return variant;\r\n  }\r\n  \r\n  /**\r\n   * æ ¹æ“šæ¬Šé‡é¸æ“‡è®Šé«”\r\n   */\r\n  private selectVariantByWeight(variants: Variant[]): Variant {\r\n    const totalWeight = variants.reduce((sum, v) => sum + v.weight, 0);\r\n    let random = Math.random() * totalWeight;\r\n    \r\n    for (const variant of variants) {\r\n      random -= variant.weight;\r\n      if (random <= 0) {\r\n        return variant;\r\n      }\r\n    }\r\n    \r\n    return variants[variants.length - 1];\r\n  }\r\n  \r\n  /**\r\n   * ç²å–ç”¨æˆ¶çš„è®Šé«”\r\n   */\r\n  getUserVariant(experimentId: string, userId: string): Variant | null {\r\n    const experiment = this.getExperiment(experimentId);\r\n    if (!experiment) return null;\r\n    \r\n    const key = `${experimentId}_${userId}`;\r\n    const assignment = this._userAssignments().get(key);\r\n    if (!assignment) return null;\r\n    \r\n    return experiment.variants.find(v => v.id === assignment.variantId) || null;\r\n  }\r\n  \r\n  // ============ çµæœè¨˜éŒ„ ============\r\n  \r\n  /**\r\n   * è¨˜éŒ„è½‰åŒ–\r\n   */\r\n  recordConversion(experimentId: string, userId: string, data: {\r\n    revenue?: number;\r\n    interestScore?: number;\r\n    messageCount?: number;\r\n    responseTime?: number;\r\n  }) {\r\n    const variant = this.getUserVariant(experimentId, userId);\r\n    if (!variant) return;\r\n    \r\n    this._variantStats.update(stats => {\r\n      const newStats = new Map(stats);\r\n      const expStats = newStats.get(experimentId) || [];\r\n      \r\n      const variantStats = expStats.find(s => s.variantId === variant.id);\r\n      if (variantStats) {\r\n        variantStats.sampleSize++;\r\n        variantStats.conversions++;\r\n        variantStats.conversionRate = variantStats.conversions / variantStats.sampleSize;\r\n        variantStats.totalRevenue += data.revenue || 0;\r\n        \r\n        // æ›´æ–°å¹³å‡å€¼\r\n        if (data.interestScore !== undefined) {\r\n          variantStats.avgInterestScore = \r\n            (variantStats.avgInterestScore * (variantStats.sampleSize - 1) + data.interestScore) / variantStats.sampleSize;\r\n        }\r\n        if (data.messageCount !== undefined) {\r\n          variantStats.avgMessageCount = \r\n            (variantStats.avgMessageCount * (variantStats.sampleSize - 1) + data.messageCount) / variantStats.sampleSize;\r\n        }\r\n      }\r\n      \r\n      newStats.set(experimentId, expStats);\r\n      return newStats;\r\n    });\r\n    \r\n    this.saveToStorage();\r\n    this.checkAutoComplete(experimentId);\r\n  }\r\n  \r\n  /**\r\n   * è¨˜éŒ„æ›å…‰ï¼ˆç„¡è½‰åŒ–ï¼‰\r\n   */\r\n  recordExposure(experimentId: string, userId: string) {\r\n    const variant = this.getUserVariant(experimentId, userId);\r\n    if (!variant) return;\r\n    \r\n    this._variantStats.update(stats => {\r\n      const newStats = new Map(stats);\r\n      const expStats = newStats.get(experimentId) || [];\r\n      \r\n      const variantStats = expStats.find(s => s.variantId === variant.id);\r\n      if (variantStats) {\r\n        variantStats.sampleSize++;\r\n        variantStats.conversionRate = variantStats.conversions / variantStats.sampleSize;\r\n      }\r\n      \r\n      newStats.set(experimentId, expStats);\r\n      return newStats;\r\n    });\r\n    \r\n    this.saveToStorage();\r\n  }\r\n  \r\n  // ============ çµ±è¨ˆåˆ†æ ============\r\n  \r\n  /**\r\n   * ç²å–å¯¦é©—çµæœ\r\n   */\r\n  getExperimentResult(experimentId: string): ExperimentResult | null {\r\n    const experiment = this.getExperiment(experimentId);\r\n    if (!experiment) return null;\r\n    \r\n    const variantStats = this._variantStats().get(experimentId) || [];\r\n    const controlStats = variantStats.find(s => s.variantId === experiment.controlVariantId);\r\n    \r\n    // è¨ˆç®—æ¯å€‹è®Šé«”çš„çµ±è¨ˆé¡¯è‘—æ€§\r\n    const enrichedStats = variantStats.map(stats => {\r\n      if (stats.variantId === experiment.controlVariantId) {\r\n        return stats;\r\n      }\r\n      \r\n      // è¨ˆç®—ç›¸å°æå‡\r\n      const uplift = controlStats && controlStats.conversionRate > 0\r\n        ? ((stats.conversionRate - controlStats.conversionRate) / controlStats.conversionRate) * 100\r\n        : 0;\r\n      \r\n      // ç°¡åŒ–çš„é¡¯è‘—æ€§æª¢é©—\r\n      const significance = this.calculateSignificance(stats, controlStats);\r\n      \r\n      return {\r\n        ...stats,\r\n        uplift,\r\n        ...significance\r\n      };\r\n    });\r\n    \r\n    // åˆ¤æ–·æ˜¯å¦æœ‰é¡¯è‘—å„ªå‹è€…\r\n    const significantWinners = enrichedStats.filter(s => \r\n      s.isSignificant && (s.uplift || 0) > 0\r\n    );\r\n    \r\n    const runDays = experiment.startedAt \r\n      ? Math.floor((Date.now() - experiment.startedAt.getTime()) / (1000 * 60 * 60 * 24))\r\n      : 0;\r\n    \r\n    const totalSampleSize = enrichedStats.reduce((sum, s) => sum + s.sampleSize, 0);\r\n    \r\n    let recommendation = '';\r\n    let recommendedWinner: string | undefined;\r\n    \r\n    if (totalSampleSize < (experiment.sampleSize || 100)) {\r\n      recommendation = `æ¨£æœ¬é‡ä¸è¶³ï¼Œå»ºè­°ç¹¼çºŒæ”¶é›†æ•¸æ“šï¼ˆç•¶å‰ ${totalSampleSize}/${experiment.sampleSize}ï¼‰`;\r\n    } else if (runDays < (experiment.minRunDays || 7)) {\r\n      recommendation = `é‹è¡Œæ™‚é–“ä¸è¶³ï¼Œå»ºè­°è‡³å°‘é‹è¡Œ ${experiment.minRunDays} å¤©`;\r\n    } else if (significantWinners.length === 0) {\r\n      recommendation = 'æš«ç„¡çµ±è¨ˆé¡¯è‘—çš„å„ªå‹è€…ï¼Œå»ºè­°ç¹¼çºŒè§€å¯Ÿæˆ–èª¿æ•´è®Šé«”';\r\n    } else if (significantWinners.length === 1) {\r\n      recommendedWinner = significantWinners[0].variantId;\r\n      recommendation = `å»ºè­°é¸æ“‡è®Šé«” ${this.getVariantName(experiment, recommendedWinner)}ï¼Œæå‡ ${significantWinners[0].uplift?.toFixed(1)}%`;\r\n    } else {\r\n      const best = significantWinners.sort((a, b) => (b.uplift || 0) - (a.uplift || 0))[0];\r\n      recommendedWinner = best.variantId;\r\n      recommendation = `å¤šå€‹è®Šé«”è¡¨ç¾å„ªç§€ï¼Œå»ºè­°é¸æ“‡ ${this.getVariantName(experiment, recommendedWinner)}`;\r\n    }\r\n    \r\n    return {\r\n      experimentId,\r\n      variantStats: enrichedStats,\r\n      overallSampleSize: totalSampleSize,\r\n      runDays,\r\n      hasSignificantWinner: significantWinners.length > 0,\r\n      recommendedWinner,\r\n      recommendation\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * è¨ˆç®—çµ±è¨ˆé¡¯è‘—æ€§ï¼ˆç°¡åŒ–ç‰ˆï¼‰\r\n   */\r\n  private calculateSignificance(variant: VariantStats, control?: VariantStats): {\r\n    pValue?: number;\r\n    isSignificant?: boolean;\r\n    confidenceInterval?: [number, number];\r\n  } {\r\n    if (!control || control.sampleSize < 30 || variant.sampleSize < 30) {\r\n      return {};\r\n    }\r\n    \r\n    // ä½¿ç”¨ Z æª¢é©—è¿‘ä¼¼\r\n    const p1 = variant.conversionRate;\r\n    const p2 = control.conversionRate;\r\n    const n1 = variant.sampleSize;\r\n    const n2 = control.sampleSize;\r\n    \r\n    const pooledP = (variant.conversions + control.conversions) / (n1 + n2);\r\n    const se = Math.sqrt(pooledP * (1 - pooledP) * (1/n1 + 1/n2));\r\n    \r\n    if (se === 0) return {};\r\n    \r\n    const z = (p1 - p2) / se;\r\n    const pValue = 2 * (1 - this.normalCDF(Math.abs(z)));\r\n    \r\n    // ç½®ä¿¡å€é–“\r\n    const margin = 1.96 * se;\r\n    const diff = p1 - p2;\r\n    \r\n    return {\r\n      pValue,\r\n      isSignificant: pValue < 0.05,\r\n      confidenceInterval: [diff - margin, diff + margin]\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * æ¨™æº–æ­£æ…‹åˆ†ä½ˆ CDFï¼ˆè¿‘ä¼¼ï¼‰\r\n   */\r\n  private normalCDF(x: number): number {\r\n    const a1 = 0.254829592;\r\n    const a2 = -0.284496736;\r\n    const a3 = 1.421413741;\r\n    const a4 = -1.453152027;\r\n    const a5 = 1.061405429;\r\n    const p = 0.3275911;\r\n    \r\n    const sign = x < 0 ? -1 : 1;\r\n    x = Math.abs(x) / Math.sqrt(2);\r\n    \r\n    const t = 1.0 / (1.0 + p * x);\r\n    const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);\r\n    \r\n    return 0.5 * (1.0 + sign * y);\r\n  }\r\n  \r\n  /**\r\n   * æª¢æŸ¥è‡ªå‹•å®Œæˆ\r\n   */\r\n  private checkAutoComplete(experimentId: string) {\r\n    const experiment = this.getExperiment(experimentId);\r\n    if (!experiment || !experiment.autoSelectWinner) return;\r\n    \r\n    const result = this.getExperimentResult(experimentId);\r\n    if (!result) return;\r\n    \r\n    // æª¢æŸ¥æ˜¯å¦é”åˆ°æ¢ä»¶\r\n    if (result.hasSignificantWinner && \r\n        result.overallSampleSize >= (experiment.sampleSize || 100) &&\r\n        result.runDays >= (experiment.minRunDays || 7)) {\r\n      \r\n      this.endExperiment(experimentId, result.recommendedWinner);\r\n      console.log(`[ABTesting] è‡ªå‹•é¸æ“‡å„ªå‹è€…: ${result.recommendedWinner}`);\r\n    }\r\n  }\r\n  \r\n  // ============ è¼”åŠ©æ–¹æ³• ============\r\n  \r\n  private getVariantName(experiment: Experiment, variantId: string): string {\r\n    return experiment.variants.find(v => v.id === variantId)?.name || variantId;\r\n  }\r\n  \r\n  private createEmptyStats(variantId: string): VariantStats {\r\n    return {\r\n      variantId,\r\n      sampleSize: 0,\r\n      conversions: 0,\r\n      conversionRate: 0,\r\n      totalRevenue: 0,\r\n      avgInterestScore: 0,\r\n      avgResponseTime: 0,\r\n      avgMessageCount: 0\r\n    };\r\n  }\r\n  \r\n  // ============ æŒä¹…åŒ– ============\r\n  \r\n  private saveToStorage() {\r\n    const data = {\r\n      experiments: this._experiments(),\r\n      variantStats: Array.from(this._variantStats().entries()),\r\n      userAssignments: Array.from(this._userAssignments().entries()),\r\n      savedAt: Date.now()\r\n    };\r\n    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));\r\n  }\r\n  \r\n  private loadFromStorage() {\r\n    try {\r\n      const stored = localStorage.getItem(this.STORAGE_KEY);\r\n      if (!stored) return;\r\n      \r\n      const data = JSON.parse(stored);\r\n      \r\n      if (data.experiments) {\r\n        this._experiments.set(data.experiments.map((e: any) => ({\r\n          ...e,\r\n          createdAt: new Date(e.createdAt),\r\n          startedAt: e.startedAt ? new Date(e.startedAt) : undefined,\r\n          endedAt: e.endedAt ? new Date(e.endedAt) : undefined\r\n        })));\r\n      }\r\n      \r\n      if (data.variantStats) {\r\n        this._variantStats.set(new Map(data.variantStats));\r\n      }\r\n      \r\n      if (data.userAssignments) {\r\n        this._userAssignments.set(new Map(data.userAssignments.map((e: any) => [\r\n          e[0],\r\n          { ...e[1], assignedAt: new Date(e[1].assignedAt) }\r\n        ])));\r\n      }\r\n      \r\n      console.log('[ABTesting] å·²å¾å­˜å„²æ¢å¾©æ•¸æ“š');\r\n    } catch (e) {\r\n      console.error('[ABTesting] æ¢å¾©æ•¸æ“šå¤±æ•—:', e);\r\n    }\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
