import{a as g}from"./chunk-TMNXXRHZ.js";import{M as u,Q as d,Zb as i,a as c,b as l,ga as n}from"./chunk-PDD6YQ47.js";var m=class o{constructor(r){this.api=r;this._wallet=n(null);this.wallet=this._wallet.asReadonly();this._transactions=n([]);this.transactions=this._transactions.asReadonly();this._rechargePackages=n([]);this.rechargePackages=this._rechargePackages.asReadonly();this._statistics=n(null);this.statistics=this._statistics.asReadonly();this._loading=n(!1);this.loading=this._loading.asReadonly();this._lastUpdated=n(null);this.lastUpdated=this._lastUpdated.asReadonly();this.STALE_TIME=3e4;this.AUTO_REFRESH_INTERVAL=6e4;this.autoRefreshTimer=null;this.balance=i(()=>this._wallet()?.available_balance??0);this.balanceDisplay=i(()=>this._wallet()?.total_display??"$0.00");this.hasBalance=i(()=>this.balance()>0);this.isStale=i(()=>{let r=this._lastUpdated();return r?Date.now()-r.getTime()>this.STALE_TIME:!0});this.isFrozen=i(()=>this._wallet()?.status==="frozen");typeof document<"u"&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&this.isStale()&&this.loadWallet()})}startAutoRefresh(){this.autoRefreshTimer||(this.autoRefreshTimer=setInterval(()=>{document.hidden||this.loadWallet()},this.AUTO_REFRESH_INTERVAL))}stopAutoRefresh(){this.autoRefreshTimer&&(clearInterval(this.autoRefreshTimer),this.autoRefreshTimer=null)}async forceRefresh(){return this.loadWallet(!0)}async loadWallet(r=!1){if(!r&&!this.isStale()&&this._wallet())return this._wallet();this._loading.set(!0);try{let e=await this.api.get("/api/wallet",{cache:!1});return e?.success&&e?.data?(this._wallet.set(e.data),this._lastUpdated.set(new Date),e.data):null}catch(e){return console.error("Load wallet error:",e),null}finally{this._loading.set(!1)}}optimisticUpdateBalance(r,e=0){let a=this._wallet();if(!a)return;let t=l(c({},a),{balance:a.balance+r,bonus_balance:a.bonus_balance+e,available_balance:a.available_balance+r+e,balance_display:`$${((a.balance+r)/100).toFixed(2)}`,bonus_display:`$${((a.bonus_balance+e)/100).toFixed(2)}`,total_display:`$${((a.available_balance+r+e)/100).toFixed(2)}`,total_recharged:a.total_recharged+(r>0?r:0)});this._wallet.set(t),this._lastUpdated.set(new Date)}invalidateCache(){this._lastUpdated.set(null)}async getBalance(){try{let r=await this.api.get("/api/wallet/balance");return r?.success&&r?.data?{balance:r.data.available_balance,display:r.data.total_display}:null}catch(r){return console.error("Get balance error:",r),null}}async loadStatistics(){try{let r=await this.api.get("/api/wallet/statistics");return r?.success&&r?.data?(this._statistics.set(r.data),r.data):null}catch(r){return console.error("Load statistics error:",r),null}}async loadTransactions(r){this._loading.set(!0);try{let e=new URLSearchParams;r?.page&&e.set("page",String(r.page)),r?.pageSize&&e.set("page_size",String(r.pageSize)),r?.type&&e.set("type",r.type),r?.category&&e.set("category",r.category),r?.status&&e.set("status",r.status),r?.startDate&&e.set("start_date",r.startDate),r?.endDate&&e.set("end_date",r.endDate);let a=`/api/wallet/transactions${e.toString()?"?"+e.toString():""}`,t=await this.api.get(a);return t?.success&&t?.data?(this._transactions.set(t.data.transactions),t.data):null}catch(e){return console.error("Load transactions error:",e),null}finally{this._loading.set(!1)}}async getRecentTransactions(r=5){try{let e=await this.api.get(`/api/wallet/transactions/recent?limit=${r}`);return e?.success&&e?.data?e.data:[]}catch(e){return console.error("Get recent transactions error:",e),[]}}async getConsumeAnalysis(r,e){try{let a=new URLSearchParams;r&&a.set("start_date",r),e&&a.set("end_date",e);let t=`/api/wallet/analysis/consume${a.toString()?"?"+a.toString():""}`,s=await this.api.get(t);return s?.success&&s?.data?s.data:null}catch(a){return console.error("Get consume analysis error:",a),null}}async getMonthlySummary(r=6){try{let e=await this.api.get(`/api/wallet/analysis/monthly?months=${r}`);return e?.success&&e?.data?e.data:[]}catch(e){return console.error("Get monthly summary error:",e),[]}}async loadRechargePackages(){try{let r=await this.api.get("/api/wallet/packages");return r?.success&&r?.data?(this._rechargePackages.set(r.data),r.data):[]}catch(r){return console.error("Load recharge packages error:",r),[]}}async consume(r){try{let e=await this.api.post("/api/wallet/consume",{amount:r.amount,category:r.category,description:r.description,order_id:r.orderId,reference_id:r.referenceId,reference_type:r.referenceType});return e?.success?(await this.loadWallet(),{success:!0,transaction:e.data?.transaction,newBalance:e.data?.new_balance}):{success:!1,error:e?.error||"\u6D88\u8CBB\u5931\u6557"}}catch(e){return console.error("Consume error:",e),{success:!1,error:String(e)}}}async checkBalance(r){try{let e=await this.api.post("/api/wallet/check-balance",{amount:r});return e?.success&&e?.data?e.data:{sufficient:!1,required:r,available:0,shortfall:r}}catch(e){return console.error("Check balance error:",e),{sufficient:!1,required:r,available:0,shortfall:r}}}async exportTransactions(r,e){try{let a=new URLSearchParams;r&&a.set("start_date",r),e&&a.set("end_date",e);let t=`/api/wallet/transactions/export${a.toString()?"?"+a.toString():""}`;window.open(t,"_blank")}catch(a){console.error("Export transactions error:",a)}}formatAmount(r,e="USD"){let a=r/100;return`${{USD:"$",CNY:"\xA5",EUR:"\u20AC"}[e]||"$"}${a.toFixed(2)}`}getTypeName(r){return{recharge:"\u5145\u503C",consume:"\u6D88\u8CBB",refund:"\u9000\u6B3E",withdraw:"\u63D0\u73FE",bonus:"\u8D08\u9001",adjust:"\u8ABF\u8CEC"}[r]||r}getTypeIcon(r){return{recharge:"\u{1F4B0}",consume:"\u{1F6D2}",refund:"\u21A9\uFE0F",withdraw:"\u{1F4B8}",bonus:"\u{1F381}",adjust:"\u2699\uFE0F"}[r]||"\u{1F4CB}"}getStatusLabel(r){return{pending:{text:"\u8655\u7406\u4E2D",color:"#f59e0b"},success:{text:"\u6210\u529F",color:"#22c55e"},failed:{text:"\u5931\u6557",color:"#ef4444"},cancelled:{text:"\u5DF2\u53D6\u6D88",color:"#6b7280"},refunded:{text:"\u5DF2\u9000\u6B3E",color:"#8b5cf6"}}[r]||{text:r,color:"#666"}}getCategoryName(r){return{membership:"\u6703\u54E1\u670D\u52D9",ip_proxy:"\u975C\u614B IP",quota_pack:"\u914D\u984D\u5305",other:"\u5176\u4ED6"}[r]||r||"\u5176\u4ED6"}async refresh(){await Promise.all([this.loadWallet(),this.loadStatistics(),this.loadRechargePackages()])}async createRechargeOrder(r){try{let e=await this.api.post("/api/wallet/recharge/create",{amount:r.amount,payment_method:r.paymentMethod,payment_channel:r.paymentChannel||"direct"});return e?.success&&e?.data?{success:!0,order:e.data.order,paymentInfo:e.data.payment_info}:{success:!1,error:e?.error||"\u5275\u5EFA\u8A02\u55AE\u5931\u6557"}}catch(e){return console.error("Create recharge order error:",e),{success:!1,error:String(e)}}}async getRechargeOrder(r){try{let e=await this.api.get(`/api/wallet/recharge/${r}`);return e?.success&&e?.data?{order:e.data.order,paymentInfo:e.data.payment_info}:null}catch(e){return console.error("Get recharge order error:",e),null}}async getRechargeOrders(r){try{let e=new URLSearchParams;r?.page&&e.set("page",String(r.page)),r?.pageSize&&e.set("page_size",String(r.pageSize)),r?.status&&e.set("status",r.status);let a=`/api/wallet/recharge/orders${e.toString()?"?"+e.toString():""}`,t=await this.api.get(a);return t?.success&&t?.data?{orders:t.data.orders,pagination:t.data.pagination}:null}catch(e){return console.error("Get recharge orders error:",e),null}}async markRechargeOrderPaid(r,e){try{let a=await this.api.post(`/api/wallet/recharge/${r}/paid`,{tx_hash:e});return a?.success?{success:!0}:{success:!1,error:a?.error||"\u6A19\u8A18\u5931\u6557"}}catch(a){return console.error("Mark recharge order paid error:",a),{success:!1,error:String(a)}}}async cancelRechargeOrder(r){try{let e=await this.api.post(`/api/wallet/recharge/${r}/cancel`,{});return e?.success?{success:!0}:{success:!1,error:e?.error||"\u53D6\u6D88\u5931\u6557"}}catch(e){return console.error("Cancel recharge order error:",e),{success:!1,error:String(e)}}}async checkRechargeOrderStatus(r){try{let e=await this.api.get(`/api/wallet/recharge/${r}/status`);return e?.success&&e?.data?{status:e.data.status,isConfirmed:e.data.is_confirmed,isPending:e.data.is_pending,isExpired:e.data.is_expired,confirmedAt:e.data.confirmed_at}:null}catch(e){return console.error("Check recharge order status error:",e),null}}async pollRechargeOrderStatus(r,e=5e3,a=60){let t=0;for(;t<a;){let s=await this.checkRechargeOrderStatus(r);if(!s)return{success:!1,confirmed:!1};if(s.isConfirmed)return await this.loadWallet(),{success:!0,confirmed:!0};if(s.isExpired)return{success:!1,confirmed:!1};t++,await new Promise(p=>setTimeout(p,e))}return{success:!1,confirmed:!1}}getRechargeStatusLabel(r){return{pending:{text:"\u5F85\u652F\u4ED8",color:"#f59e0b"},paid:{text:"\u5DF2\u652F\u4ED8",color:"#3b82f6"},confirmed:{text:"\u5DF2\u5230\u8CEC",color:"#22c55e"},failed:{text:"\u5931\u6557",color:"#ef4444"},expired:{text:"\u5DF2\u904E\u671F",color:"#9ca3af"},refunded:{text:"\u5DF2\u9000\u6B3E",color:"#8b5cf6"}}[r]||{text:r,color:"#666"}}async consumeUnified(r){try{let e=await this.api.post("/api/wallet/consume/unified",{amount:r.amount,category:r.category,description:r.description,reference_id:r.referenceId,reference_type:r.referenceType,order_id:r.orderId});return e?.success?(await this.loadWallet(),{success:!0,transactionId:e.data?.transaction_id,balanceBefore:e.data?.balance_before,balanceAfter:e.data?.balance_after}):{success:!1,error:e?.error||"\u6D88\u8CBB\u5931\u6557"}}catch(e){return console.error("Consume unified error:",e),{success:!1,error:String(e)}}}async checkConsumeLimit(r,e){try{let a=await this.api.get(`/api/wallet/consume/limit?amount=${r}&category=${e}`);return a?.success&&a?.data?{canConsume:a.data.can_consume,limitPassed:a.data.limit_passed,limitError:a.data.limit_error,requiresPassword:a.data.requires_password,balanceSufficient:a.data.balance_sufficient,balanceInfo:a.data.balance_info}:{canConsume:!1,limitPassed:!1,requiresPassword:!1,balanceSufficient:!1,balanceInfo:null}}catch(a){return console.error("Check consume limit error:",a),{canConsume:!1,limitPassed:!1,requiresPassword:!1,balanceSufficient:!1,balanceInfo:null}}}async getConsumeSummary(r=30){try{let e=await this.api.get(`/api/wallet/consume/summary?days=${r}`);return e?.success&&e?.data?e.data:null}catch(e){return console.error("Get consume summary error:",e),null}}async refund(r,e,a){try{let t=await this.api.post("/api/wallet/refund",{original_order_id:r,amount:e,reason:a});return t?.success?(await this.loadWallet(),{success:!0,transactionId:t.data?.transaction_id,refundAmount:t.data?.refund_amount}):{success:!1,error:t?.error||"\u9000\u6B3E\u5931\u6557"}}catch(t){return console.error("Refund error:",t),{success:!1,error:String(t)}}}static{this.\u0275fac=function(e){return new(e||o)(d(g))}}static{this.\u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})}};export{m as a};
