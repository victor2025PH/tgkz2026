import{b as g}from"./chunk-7LTHB4NI.js";import{a as d}from"./chunk-5HHK7KPZ.js";import{M as l,Q as c,Zb as i,a as o,b as u,ga as r}from"./chunk-PDD6YQ47.js";var p=class a{constructor(e,t){this.ipcService=e;this.toastService=t;this._isInitialized=r(!1);this._isLoading=r(!1);this._isSearching=r(!1);this._stats=r(null);this._recentKnowledge=r([]);this._learningEvents=r([]);this._searchResults=r([]);this._buildProgress=r(null);this._healthScore=r(0);this._knowledgeGaps=r([]);this._healthReport=r(null);this._guidedQuestion=r(null);this._guidedAnswers=r({});this._lastImportResult=r(null);this._lastError=r(null);this.lastError=i(()=>this._lastError());this._pendingRequests=new Map;this.REQUEST_TIMEOUT=15e3;this._currentRequest=r(null);this._requestStartTime=r(0);this.currentRequest=i(()=>this._currentRequest());this.requestElapsed=i(()=>{let e=this._requestStartTime();return e?Date.now()-e:0});this.isInitialized=i(()=>this._isInitialized());this.isLoading=i(()=>this._isLoading());this.isSearching=i(()=>this._isSearching());this.stats=i(()=>this._stats());this.recentKnowledge=i(()=>this._recentKnowledge());this.learningEvents=i(()=>this._learningEvents());this.searchResults=i(()=>this._searchResults());this.buildProgress=i(()=>this._buildProgress());this.healthScore=i(()=>this._healthScore());this.knowledgeGaps=i(()=>this._knowledgeGaps());this.healthReport=i(()=>this._healthReport());this.guidedQuestion=i(()=>this._guidedQuestion());this.gapsCount=i(()=>this._knowledgeGaps().length);this.totalKnowledge=i(()=>this._stats()?.totalKnowledge||0);this.hitRate=i(()=>{let e=this._stats();return!e||e.totalKnowledge===0?0:Math.round(e.totalUses/Math.max(1,e.totalKnowledge*10)*100)});this.todayLearned=i(()=>this._learningEvents().filter(e=>{let t=new Date().toDateString();return new Date(e.timestamp).toDateString()===t}).length);this.setupEventListeners()}clearLastError(){this._lastError.set(null)}startRequestWithTimeout(e,t=this.REQUEST_TIMEOUT){this.cancelRequest(e),this._currentRequest.set(e),this._requestStartTime.set(Date.now());let s=setTimeout(()=>{console.warn(`[RAGBrain] Request timeout: ${e}`),this._isLoading.set(!1),this._currentRequest.set(null),this._requestStartTime.set(0),this._pendingRequests.delete(e),this.toastService.error(`\u8ACB\u6C42\u8D85\u6642\uFF0C\u8ACB\u7A0D\u5F8C\u91CD\u8A66 (${this.getRequestDisplayName(e)})`),(e==="build"||e==="guided-build")&&this._buildProgress.set(null),e==="search"&&this._searchResults.set([])},t);this._pendingRequests.set(e,s)}getRequestDisplayName(e){return{initialize:"\u521D\u59CB\u5316",search:"\u641C\u7D22",build:"\u69CB\u5EFA\u77E5\u8B58\u5EAB","guided-build":"\u5F15\u5C0E\u5F0F\u69CB\u5EFA","import-url":"\u7DB2\u9801\u5C0E\u5165","import-doc":"\u6587\u6A94\u5C0E\u5165"}[e]||e}getCurrentRequestName(){let e=this._currentRequest();return e?this.getRequestDisplayName(e):""}completeRequest(e){let t=this._pendingRequests.get(e);t&&(clearTimeout(t),this._pendingRequests.delete(e)),this._currentRequest()===e&&(this._currentRequest.set(null),this._requestStartTime.set(0))}cancelRequest(e){let t=this._pendingRequests.get(e);t&&(clearTimeout(t),this._pendingRequests.delete(e)),this._currentRequest()===e&&(this._currentRequest.set(null),this._requestStartTime.set(0))}cancelAllRequests(){this._pendingRequests.forEach(e=>clearTimeout(e)),this._pendingRequests.clear(),this._currentRequest.set(null),this._requestStartTime.set(0)}cancelCurrentRequest(){let e=this._currentRequest();e&&(this.cancelRequest(e),this._isLoading.set(!1),this._buildProgress.set(null),this.toastService.info("\u5DF2\u53D6\u6D88\u8ACB\u6C42"))}setupEventListeners(){this.ipcService.on("rag-initialized",e=>{console.log("[RAGBrain] System initialized:",e),this.completeRequest("initialize"),this._isLoading.set(!1),e.success?(this._isInitialized.set(!0),this.refreshStats(),this.toastService.success("\u{1F9E0} AI \u77E5\u8B58\u5927\u8166\u5DF2\u555F\u52D5")):this.toastService.error(`\u521D\u59CB\u5316\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}),this.ipcService.on("rag-search-results",e=>{console.log("[RAGBrain] Search results:",e),this.completeRequest("search"),this._isLoading.set(!1),e.success&&e.results?this._searchResults.set(e.results.map(this.mapSearchResult)):e.success||(this.toastService.error(`\u641C\u7D22\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`),this._searchResults.set([]))}),this.ipcService.on("rag-stats-updated",e=>{console.log("[RAGBrain] Stats updated:",e),e.success&&e.stats&&(this._stats.set(this.mapStats(e.stats)),this.calculateHealthScore())}),this.ipcService.on("rag-knowledge-added",e=>{console.log("[RAGBrain] Knowledge added:",e),e.success&&(this.addLearningEvent({type:"new_knowledge",description:`\u6DFB\u52A0\u4E86\u65B0${this.getTypeName(e.knowledgeType)}\u77E5\u8B58`,details:{knowledgeType:e.knowledgeType}}),this.refreshStats())}),this.ipcService.on("rag-auto-learned",e=>{if(console.log("[RAGBrain] Auto learned:",e),e.success&&e.result){let t=e.result,s=(t.qa_extracted||0)+(t.scripts_extracted||0)+(t.objections_extracted||0);s>0&&(this.addLearningEvent({type:"auto_learn",description:`\u5F9E\u5C0D\u8A71\u5B78\u7FD2\u4E86 ${s} \u689D\u77E5\u8B58`,details:{userId:e.userId,count:s,quality:t.quality_score}}),this.refreshStats(),this.toastService.info(`\u{1F4AC} \u5F9E\u5C0D\u8A71\u5B78\u7FD2\u4E86 ${s} \u689D\u77E5\u8B58`))}}),this.ipcService.on("rag-build-progress",e=>{console.log("[RAGBrain] Build progress:",e),e.progress&&this._buildProgress.set(e.progress)}),this.ipcService.on("rag-build-complete",e=>{console.log("[RAGBrain] Build complete:",e),this.completeRequest("build"),this._buildProgress.set(null),this._isLoading.set(!1),e.success?(this.addLearningEvent({type:"new_knowledge",description:`\u901A\u904E\u5C0D\u8A71\u69CB\u5EFA\u4E86 ${e.totalItems} \u689D\u77E5\u8B58`,details:{count:e.totalItems}}),this.refreshStats(),this._lastImportResult.set({success:!0,totalItems:e.totalItems||0,stats:e.stats||{},source:"conversation"}),this.toastService.success(`\u2728 \u77E5\u8B58\u5927\u8166\u69CB\u5EFA\u5B8C\u6210\uFF01\u5171 ${e.totalItems} \u689D\u77E5\u8B58`)):this.toastService.error(`\u69CB\u5EFA\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}),this.ipcService.on("rag-url-imported",e=>{console.log("[RAGBrain] URL imported:",e),this.completeRequest("import-url"),this._isLoading.set(!1),e.success?(this.addLearningEvent({type:"new_knowledge",description:`\u5F9E\u7DB2\u9801\u5C0E\u5165\u4E86 ${e.itemsCount} \u689D\u77E5\u8B58`,details:{count:e.itemsCount}}),this.refreshStats(),this.toastService.success(`\u{1F310} \u5DF2\u5F9E\u7DB2\u9801\u5C0E\u5165 ${e.itemsCount} \u689D\u77E5\u8B58`)):e.needsApiKey?(this.toastService.error(`\u26A0\uFE0F ${e.error}`,8e3),this._lastError.set({type:"api_key_missing",message:e.error,action:"configure_ai"})):this.toastService.error(`\u5C0E\u5165\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}),this.ipcService.on("rag-document-imported",e=>{console.log("[RAGBrain] Document imported:",e),this.completeRequest("import-doc"),this._isLoading.set(!1),e.success?(this.addLearningEvent({type:"new_knowledge",description:`\u5F9E\u6587\u6A94\u5C0E\u5165\u4E86 ${e.itemsCount} \u689D\u77E5\u8B58`,details:{count:e.itemsCount}}),this.refreshStats(),this.toastService.success(`\u{1F4C4} \u5DF2\u5F9E\u6587\u6A94\u5C0E\u5165 ${e.itemsCount} \u689D\u77E5\u8B58`)):this.toastService.error(`\u5C0E\u5165\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}),this.ipcService.on("rag-gaps-list",e=>{console.log("[RAGBrain] Gaps list:",e),e.success&&e.gaps&&this._knowledgeGaps.set(e.gaps)}),this.ipcService.on("rag-gap-resolved",e=>{console.log("[RAGBrain] Gap resolved:",e),e.success&&(this._knowledgeGaps.update(t=>t.filter(s=>s.id!==e.gapId)),this.toastService.success("\u2705 \u77E5\u8B58\u7F3A\u53E3\u5DF2\u89E3\u6C7A\uFF01"),this.refreshStats())}),this.ipcService.on("rag-gap-ignored",e=>{e.success&&this._knowledgeGaps.update(t=>t.filter(s=>s.id!==e.gapId))}),this.ipcService.on("rag-gap-suggestion",e=>{console.log("[RAGBrain] Gap suggestion:",e),e.success&&e.suggestedAnswer&&this._knowledgeGaps.update(t=>t.map(s=>s.id===e.gapId?u(o({},s),{suggestedAnswer:e.suggestedAnswer}):s))}),this.ipcService.on("rag-health-report",e=>{console.log("[RAGBrain] Health report:",e),e.success&&e.report&&(this._healthReport.set(e.report),this._healthScore.set(e.report.overallScore||0))}),this.ipcService.on("rag-guided-question",e=>{console.log("[RAGBrain] Guided question:",e),this.completeRequest("guided-build"),this._isLoading.set(!1),e.success?this._guidedQuestion.set({step:e.step,totalSteps:e.totalSteps,title:e.title,question:e.question,type:e.type,options:e.options,placeholder:e.placeholder,suggestions:e.suggestions}):this.toastService.error(`\u5F15\u5C0E\u5F0F\u69CB\u5EFA\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}),this.ipcService.on("rag-error",e=>{console.error("[RAGBrain] Error event:",e),this.cancelAllRequests(),this._isLoading.set(!1),this._buildProgress.set(null),this.toastService.error(`RAG \u932F\u8AA4: ${e.error||"\u64CD\u4F5C\u5931\u6557"}`)}),this.ipcService.on("backend-status",e=>{e.running||(console.warn("[RAGBrain] Backend disconnected, resetting states"),this.cancelAllRequests(),this._isLoading.set(!1),this._isInitialized.set(!1),this._buildProgress.set(null))})}async initialize(){this._isInitialized()||this._isLoading()||(console.log("[RAGBrain] Initializing..."),this._isLoading.set(!0),this.startRequestWithTimeout("initialize",3e4),this.ipcService.send("rag-initialize",{useChromadb:!0,useNeural:!0}))}refreshStats(){this.ipcService.send("rag-get-stats",{})}search(e,t){this._isLoading()||(this._isLoading.set(!0),this._searchResults.set([]),this.startRequestWithTimeout("search"),this.ipcService.send("rag-search",{query:e,limit:t?.limit||5,knowledgeType:t?.type,minScore:t?.minScore||.3}))}async buildFromConversation(e){this._isLoading()||(this._isLoading.set(!0),this._buildProgress.set({step:1,totalSteps:5,currentAction:"\u5206\u6790\u696D\u52D9\u63CF\u8FF0...",itemsGenerated:0}),this.startRequestWithTimeout("build",12e4),this.ipcService.send("rag-build-from-conversation",e))}importFromUrl(e){this._isLoading()||(this._isLoading.set(!0),this.startRequestWithTimeout("import-url",6e4),this.toastService.info("\u{1F50D} \u6B63\u5728\u89E3\u6790\u7DB2\u9801\u5167\u5BB9..."),this.ipcService.send("rag-import-url",{url:e}))}importFromDocument(e,t){this._isLoading()||(this._isLoading.set(!0),this.startRequestWithTimeout("import-doc",6e4),this.toastService.info("\u{1F4D6} \u6B63\u5728\u89E3\u6790\u6587\u6A94..."),this.ipcService.send("rag-import-document",{filePath:e,fileType:t}))}addKnowledge(e,t,s,n){this.ipcService.send("rag-add-knowledge",{knowledgeType:e,question:t,answer:s,context:n||""})}recordFeedback(e,t){this.ipcService.send("rag-record-feedback",{knowledgeId:e,isPositive:t}),this.addLearningEvent({type:"feedback",description:`\u6536\u5230${t?"\u6B63\u9762":"\u8CA0\u9762"}\u53CD\u994B`,details:{}})}getRecentKnowledge(e=20){this.ipcService.send("rag-get-recent",{limit:e})}cleanupLowQuality(){this.ipcService.send("rag-cleanup",{minScore:.2,minUses:0,daysOld:30})}mergeSimilar(){this.ipcService.send("rag-merge-similar",{similarityThreshold:.9})}getKnowledgeGaps(e=1){this.ipcService.send("rag-get-gaps",{status:"pending",limit:50,minHits:e})}resolveGap(e,t,s,n){this.ipcService.send("rag-resolve-gap",{gapId:e,knowledgeType:t,question:s,answer:n})}ignoreGap(e){this.ipcService.send("rag-ignore-gap",{gapId:e})}deleteGap(e){this.ipcService.send("rag-delete-gap",{gapId:e}),this._knowledgeGaps.update(t=>t.filter(s=>s.id!==e))}deleteGapsBatch(e){this.ipcService.send("rag-delete-gaps-batch",{gapIds:e}),this._knowledgeGaps.update(t=>t.filter(s=>!e.includes(s.id)))}cleanupDuplicateGaps(){this.ipcService.send("rag-cleanup-duplicate-gaps",{}),setTimeout(()=>this.getKnowledgeGaps(),1e3)}suggestGapAnswer(e,t){this.ipcService.send("rag-suggest-gap-answer",{gapId:e,query:t})}getHealthReport(){this.ipcService.send("rag-get-health-report",{})}startGuidedBuild(){this._isLoading()||(this._guidedAnswers.set({}),this._isLoading.set(!0),this.startRequestWithTimeout("guided-build",3e4),this.ipcService.send("rag-start-guided-build",{step:1,answers:{}}))}answerGuidedQuestion(e){let t=this._guidedQuestion();if(!t)return;let s=`step${t.step}`;this._guidedAnswers.update(m=>u(o({},m),{[s]:e}));let n=t.step+1;this._isLoading.set(!0);let h=n>t.totalSteps?12e4:3e4;this.startRequestWithTimeout("guided-build",h),n<=t.totalSteps?this.ipcService.send("rag-start-guided-build",{step:n,answers:this._guidedAnswers()}):(this._guidedQuestion.set(null),this.ipcService.send("rag-start-guided-build",{step:n,answers:this._guidedAnswers()}))}cancelGuidedBuild(){this.cancelRequest("guided-build"),this._guidedQuestion.set(null),this._guidedAnswers.set({}),this._isLoading.set(!1)}addLearningEvent(e){let t=o({id:`event_${Date.now()}`,timestamp:new Date().toISOString()},e);this._learningEvents.update(s=>[t,...s].slice(0,50))}calculateHealthScore(){let e=this._stats();if(!e){this._healthScore.set(0);return}let t=0;t+=Math.min(25,e.totalKnowledge*.5),t+=e.avgScore*25;let s=e.totalUses/Math.max(1,e.totalKnowledge);t+=Math.min(25,s*5);let n=Object.keys(e.byType).length;t+=Math.min(25,n*5),this._healthScore.set(Math.round(t))}mapSearchResult(e){return{item:{id:e.item.id,type:e.item.knowledge_type||e.item.type,question:e.item.question,answer:e.item.answer,context:e.item.context,keywords:e.item.keywords||[],successScore:e.item.success_score||e.item.successScore||.5,useCount:e.item.use_count||e.item.useCount||0,feedbackPositive:e.item.feedback_positive||0,feedbackNegative:e.item.feedback_negative||0,createdAt:e.item.created_at||e.item.createdAt||"",updatedAt:e.item.updated_at||e.item.updatedAt||""},similarity:e.similarity,source:e.source}}mapStats(e){return{totalKnowledge:e.total_knowledge||e.totalKnowledge||0,totalUses:e.total_uses||e.totalUses||0,avgScore:e.avg_score||e.avgScore||0,byType:e.by_type||e.byType||{},vectorCount:e.vector_count||e.vectorCount,chromadbEnabled:e.chromadb_enabled??e.chromadbEnabled??!1,neuralEmbedding:e.neural_embedding??e.neuralEmbedding??!1,learning:e.learning?{sessionsProcessed:e.learning.sessions_processed||0,totalQaExtracted:e.learning.total_qa_extracted||0,totalScriptsExtracted:e.learning.total_scripts_extracted||0,avgQualityScore:e.learning.avg_quality_score||0}:void 0}}getTypeName(e){return{qa:"\u554F\u7B54",script:"\u8A71\u8853",product:"\u7522\u54C1",objection:"\u7570\u8B70\u8655\u7406",greeting:"\u958B\u5834\u767D",closing:"\u6210\u4EA4",faq:"FAQ",custom:"\u81EA\u5B9A\u7FA9"}[e]||e}static{this.\u0275fac=function(t){return new(t||a)(c(d),c(g))}}static{this.\u0275prov=l({token:a,factory:a.\u0275fac,providedIn:"root"})}};export{p as a};
