import{a as E,b as Te,c as Me}from"./chunk-YQZANNAS.js";import{e as ye}from"./chunk-PHWS6WVI.js";import{c as be}from"./chunk-6CC5VJPY.js";import{a as _e}from"./chunk-SHW2YL4T.js";import{a as we}from"./chunk-AHIGNWD7.js";import{a as h,b as R,d as Se}from"./chunk-ITEZR6M3.js";import{a as v}from"./chunk-3V3KVMT4.js";import{b as J}from"./chunk-CXXWQ5XE.js";import{M as g,R as l,Vb as d,a as n,b as c,g as Q,ga as r,ia as fe}from"./chunk-YLSLTE5F.js";var De=class o{constructor(){this.toast=l(h);this._confirmDialog=r(null);this.confirmDialog=this._confirmDialog.asReadonly();this._progressDialog=r({show:!1,title:"",progress:0,cancellable:!1});this.progressDialog=this._progressDialog.asReadonly();this._showSuccessOverlay=r(!1);this._successOverlayConfig=r(null);this.showSuccessOverlay=this._showSuccessOverlay.asReadonly();this.successOverlayConfig=this._successOverlayConfig.asReadonly();this._deleteConfirmDialog=r({show:!1,type:"single"});this.deleteConfirmDialog=this._deleteConfirmDialog.asReadonly();this._showQrLoginDialog=r(!1);this.showQrLoginDialog=this._showQrLoginDialog.asReadonly();this._showBatchMessageDialog=r(!1);this._batchSendTargets=r([]);this.showBatchMessageDialog=this._showBatchMessageDialog.asReadonly();this.batchSendTargets=this._batchSendTargets.asReadonly();this._showBatchInviteDialog=r(!1);this._batchInviteTargets=r([]);this.showBatchInviteDialog=this._showBatchInviteDialog.asReadonly();this.batchInviteTargets=this._batchInviteTargets.asReadonly();this._showMemberExtractionDialog=r(!1);this._memberExtractionGroup=r(null);this.showMemberExtractionDialog=this._showMemberExtractionDialog.asReadonly();this.memberExtractionGroup=this._memberExtractionGroup.asReadonly();this._showJoinMonitorDialog=r(!1);this._joinMonitorResource=r(null);this.showJoinMonitorDialog=this._showJoinMonitorDialog.asReadonly();this.joinMonitorResource=this._joinMonitorResource.asReadonly();this._showPostJoinDialog=r(!1);this._postJoinResource=r(null);this.showPostJoinDialog=this._showPostJoinDialog.asReadonly();this.postJoinResource=this._postJoinResource.asReadonly();this._inputDialog=r(null);this._inputDialogValue=r("");this._inputDialogError=r(null);this.inputDialog=this._inputDialog.asReadonly();this.inputDialogValue=this._inputDialogValue.asReadonly();this.inputDialogError=this._inputDialogError.asReadonly()}confirm(e){this._confirmDialog.set(e)}closeConfirmDialog(){let e=this._confirmDialog();e?.onCancel&&e.onCancel(),this._confirmDialog.set(null)}confirmAction(){let e=this._confirmDialog();e?.onConfirm&&e.onConfirm(),this._confirmDialog.set(null)}showProgress(e,t=!1){this._progressDialog.set({show:!0,title:e,progress:0,cancellable:t})}updateProgress(e,t){this._progressDialog.update(s=>c(n({},s),{progress:e,message:t}))}hideProgress(){this._progressDialog.update(e=>c(n({},e),{show:!1}))}showSuccess(e){this._successOverlayConfig.set(e),this._showSuccessOverlay.set(!0);let t=e.duration??2e3;setTimeout(()=>{this._showSuccessOverlay.set(!1),this._successOverlayConfig.set(null)},t)}hideSuccess(){this._showSuccessOverlay.set(!1),this._successOverlayConfig.set(null)}showDeleteConfirm(e,t,s){this._deleteConfirmDialog.set({show:!0,type:e,lead:t,count:s})}hideDeleteConfirm(){this._deleteConfirmDialog.update(e=>c(n({},e),{show:!1}))}openQrLogin(){this._showQrLoginDialog.set(!0)}closeQrLogin(){this._showQrLoginDialog.set(!1)}openBatchSend(e){this._batchSendTargets.set(e),this._showBatchMessageDialog.set(!0)}closeBatchSend(){this._showBatchMessageDialog.set(!1),this._batchSendTargets.set([])}openBatchInvite(e){this._batchInviteTargets.set(e),this._showBatchInviteDialog.set(!0)}closeBatchInvite(){this._showBatchInviteDialog.set(!1),this._batchInviteTargets.set([])}openMemberExtraction(e){this._memberExtractionGroup.set(e),this._showMemberExtractionDialog.set(!0)}closeMemberExtraction(){this._showMemberExtractionDialog.set(!1),this._memberExtractionGroup.set(null)}openJoinMonitor(e){this._joinMonitorResource.set(e),this._showJoinMonitorDialog.set(!0)}closeJoinMonitor(){this._showJoinMonitorDialog.set(!1),this._joinMonitorResource.set(null)}openPostJoin(e){this._postJoinResource.set(e),this._showPostJoinDialog.set(!0)}closePostJoin(){this._showPostJoinDialog.set(!1),this._postJoinResource.set(null)}prompt(e){this._inputDialogValue.set(e.defaultValue||""),this._inputDialogError.set(null),this._inputDialog.set(e)}updateInputValue(e){this._inputDialogValue.set(e),this._inputDialogError.set(null)}confirmInput(){let e=this._inputDialog(),t=this._inputDialogValue();if(e){if(e.validator){let s=e.validator(t);if(s){this._inputDialogError.set(s);return}}if(!t.trim()){this._inputDialogError.set("\u8ACB\u8F38\u5165\u5167\u5BB9");return}e.onConfirm&&e.onConfirm(t.trim()),this._inputDialog.set(null),this._inputDialogValue.set(""),this._inputDialogError.set(null)}}cancelInput(){let e=this._inputDialog();e?.onCancel&&e.onCancel(),this._inputDialog.set(null),this._inputDialogValue.set(""),this._inputDialogError.set(null)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var I=(function(o){return o[o.State=0]="State",o[o.Transition=1]="Transition",o[o.Sequence=2]="Sequence",o[o.Group=3]="Group",o[o.Animate=4]="Animate",o[o.Keyframes=5]="Keyframes",o[o.Style=6]="Style",o[o.Trigger=7]="Trigger",o[o.Reference=8]="Reference",o[o.AnimateChild=9]="AnimateChild",o[o.AnimateRef=10]="AnimateRef",o[o.Query=11]="Query",o[o.Stagger=12]="Stagger",o})(I||{}),Ze="*";function A(o,e){return{type:I.Trigger,name:o,definitions:e,options:{}}}function C(o,e=null){return{type:I.Animate,styles:e,timings:o}}function H(o,e=null){return{type:I.Group,steps:o,options:e}}function ut(o,e=null){return{type:I.Sequence,steps:o,options:e}}function T(o){return{type:I.Style,styles:o,offset:null}}function L(o,e,t=null){return{type:I.Transition,expr:o,animation:e,options:t}}function se(o=null){return{type:I.AnimateChild,options:o}}function D(o,e,t=null){return{type:I.Query,selector:o,animation:e,options:t}}var ee=class{_onDoneFns=[];_onStartFns=[];_onDestroyFns=[];_originalOnDoneFns=[];_originalOnStartFns=[];_started=!1;_destroyed=!1;_finished=!1;_position=0;parentPlayer=null;totalTime;constructor(e=0,t=0){this.totalTime=e+t}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(e=>e()),this._onDoneFns=[])}onStart(e){this._originalOnStartFns.push(e),this._onStartFns.push(e)}onDone(e){this._originalOnDoneFns.push(e),this._onDoneFns.push(e)}onDestroy(e){this._onDestroyFns.push(e)}hasStarted(){return this._started}init(){}play(){this.hasStarted()||(this._onStart(),this.triggerMicrotask()),this._started=!0}triggerMicrotask(){queueMicrotask(()=>this._onFinish())}_onStart(){this._onStartFns.forEach(e=>e()),this._onStartFns=[]}pause(){}restart(){}finish(){this._onFinish()}destroy(){this._destroyed||(this._destroyed=!0,this.hasStarted()||this._onStart(),this.finish(),this._onDestroyFns.forEach(e=>e()),this._onDestroyFns=[])}reset(){this._started=!1,this._finished=!1,this._onStartFns=this._originalOnStartFns,this._onDoneFns=this._originalOnDoneFns}setPosition(e){this._position=this.totalTime?e*this.totalTime:1}getPosition(){return this.totalTime?this._position/this.totalTime:1}triggerCallback(e){let t=e=="start"?this._onStartFns:this._onDoneFns;t.forEach(s=>s()),t.length=0}},te=class{_onDoneFns=[];_onStartFns=[];_finished=!1;_started=!1;_destroyed=!1;_onDestroyFns=[];parentPlayer=null;totalTime=0;players;constructor(e){this.players=e;let t=0,s=0,i=0,a=this.players.length;a==0?queueMicrotask(()=>this._onFinish()):this.players.forEach(u=>{u.onDone(()=>{++t==a&&this._onFinish()}),u.onDestroy(()=>{++s==a&&this._onDestroy()}),u.onStart(()=>{++i==a&&this._onStart()})}),this.totalTime=this.players.reduce((u,m)=>Math.max(u,m.totalTime),0)}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(e=>e()),this._onDoneFns=[])}init(){this.players.forEach(e=>e.init())}onStart(e){this._onStartFns.push(e)}_onStart(){this.hasStarted()||(this._started=!0,this._onStartFns.forEach(e=>e()),this._onStartFns=[])}onDone(e){this._onDoneFns.push(e)}onDestroy(e){this._onDestroyFns.push(e)}hasStarted(){return this._started}play(){this.parentPlayer||this.init(),this._onStart(),this.players.forEach(e=>e.play())}pause(){this.players.forEach(e=>e.pause())}restart(){this.players.forEach(e=>e.restart())}finish(){this._onFinish(),this.players.forEach(e=>e.finish())}destroy(){this._onDestroy()}_onDestroy(){this._destroyed||(this._destroyed=!0,this._onFinish(),this.players.forEach(e=>e.destroy()),this._onDestroyFns.forEach(e=>e()),this._onDestroyFns=[])}reset(){this.players.forEach(e=>e.reset()),this._destroyed=!1,this._finished=!1,this._started=!1}setPosition(e){let t=e*this.totalTime;this.players.forEach(s=>{let i=s.totalTime?Math.min(1,t/s.totalTime):1;s.setPosition(i)})}getPosition(){let e=this.players.reduce((t,s)=>t===null||s.totalTime>t.totalTime?s:t,null);return e!=null?e.getPosition():0}beforeDestroy(){this.players.forEach(e=>{e.beforeDestroy&&e.beforeDestroy()})}triggerCallback(e){let t=e=="start"?this._onStartFns:this._onDoneFns;t.forEach(s=>s()),t.length=0}},et="!";var xe=A("routeAnimations",[L("* <=> *",[D(":enter, :leave",[T({position:"absolute",top:0,left:0,width:"100%",opacity:0})],{optional:!0}),D(":leave",[C("200ms ease-out",T({opacity:0}))],{optional:!0}),D(":enter",[C("300ms ease-in",T({opacity:1}))],{optional:!0})])]),Ce=A("routeAnimations",[L("* => *",[D(":enter, :leave",[T({position:"absolute",top:0,left:0,width:"100%"})],{optional:!0}),H([D(":leave",[C("300ms ease-out",T({transform:"translateX(-100%)",opacity:0}))],{optional:!0}),D(":enter",[T({transform:"translateX(100%)",opacity:0}),C("300ms ease-out",T({transform:"translateX(0)",opacity:1}))],{optional:!0})])])]),Ie=A("routeAnimations",[L("* <=> *",[D(":enter, :leave",[T({position:"absolute",top:0,left:0,width:"100%"})],{optional:!0}),D(":leave",[C("200ms ease-out",T({transform:"scale(0.95)",opacity:0}))],{optional:!0}),D(":enter",[T({transform:"scale(1.05)",opacity:0}),C("300ms ease-out",T({transform:"scale(1)",opacity:1}))],{optional:!0})])]),ke=A("routeAnimations",[L("* <=> *",[D(":enter, :leave",[T({position:"absolute",top:0,left:0,width:"100%"})],{optional:!0}),D(":leave",[C("200ms ease-out",T({transform:"translateY(-20px)",opacity:0}))],{optional:!0}),D(":enter",[T({transform:"translateY(20px)",opacity:0}),C("300ms ease-out",T({transform:"translateY(0)",opacity:1}))],{optional:!0})])]),Re=A("routeAnimations",[L("* <=> *",[T({position:"relative"}),D(":enter, :leave",[T({position:"absolute",top:0,left:0,width:"100%",height:"100%"})],{optional:!0}),H([D(":leave",[T({opacity:1,transform:"scale(1)"}),C("200ms ease-out",T({opacity:0,transform:"scale(0.98)"}))],{optional:!0}),D(":enter",[T({opacity:0,transform:"scale(1.02)"}),C("300ms 100ms ease-out",T({opacity:1,transform:"scale(1)"}))],{optional:!0})]),D(":enter",se(),{optional:!0})])]),Ae=A("routeAnimations",[]);var F=[{id:"default",name:"\u63A8\u85A6",description:"\u6DE1\u5165 + \u5FAE\u7E2E\u653E\u6548\u679C\uFF0C\u6D41\u66A2\u81EA\u7136",preview:"\u2728"},{id:"fade",name:"\u6DE1\u5165\u6DE1\u51FA",description:"\u7C21\u55AE\u7684\u900F\u660E\u5EA6\u5207\u63DB",preview:"\u{1F32B}\uFE0F"},{id:"slide",name:"\u5DE6\u53F3\u6ED1\u52D5",description:"\u9801\u9762\u5F9E\u53F3\u5074\u6ED1\u5165",preview:"\u27A1\uFE0F"},{id:"slideUp",name:"\u4E0A\u4E0B\u6ED1\u52D5",description:"\u9801\u9762\u5F9E\u4E0B\u65B9\u6ED1\u5165",preview:"\u2B06\uFE0F"},{id:"scale",name:"\u7E2E\u653E",description:"\u9801\u9762\u653E\u5927\u6DE1\u5165",preview:"\u{1F50D}"},{id:"none",name:"\u7121\u52D5\u756B",description:"\u7981\u7528\u6240\u6709\u52D5\u756B\u6548\u679C",preview:"\u23F9\uFE0F"}],tt={default:Re,fade:xe,slide:Ce,scale:Ie,slideUp:ke,none:Ae},Ne=class o{constructor(){this._animationType=r("default");this.animationType=this._animationType.asReadonly();this.currentOption=d(()=>{let e=this._animationType();return F.find(t=>t.id===e)||F[0]});this.options=F;this.loadFromStorage()}setAnimationType(e){this._animationType.set(e),this.saveToStorage()}getAnimation(){return tt[this._animationType()]}nextAnimation(){let e=this._animationType(),s=(F.findIndex(i=>i.id===e)+1)%F.length;this.setAnimationType(F[s].id)}resetToDefault(){this.setAnimationType("default")}isAnimationDisabled(){return this._animationType()==="none"}loadFromStorage(){try{let e=localStorage.getItem("tg-animation-type");e&&F.some(t=>t.id===e)&&this._animationType.set(e)}catch{}}saveToStorage(){try{localStorage.setItem("tg-animation-type",this._animationType())}catch{}}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var q={theme:"dark",language:"zh-TW",sidebarCollapsed:!1,animationType:"default",autoConnect:!0,autoMonitor:!1,showNotifications:!0,soundEnabled:!0,autoLock:!1,lockTimeout:5,enableAnalytics:!0,logLevel:"info"},Ee=class o{constructor(){this.ipc=l(v);this.toast=l(h);this.i18n=l(J);this._settings=r(q);this._credentials=r({});this._isLoading=r(!1);this._isDirty=r(!1);this.settings=this._settings.asReadonly();this.credentials=this._credentials.asReadonly();this.isLoading=this._isLoading.asReadonly();this.isDirty=this._isDirty.asReadonly();this.theme=d(()=>this._settings().theme);this.language=d(()=>this._settings().language);this.sidebarCollapsed=d(()=>this._settings().sidebarCollapsed);this.hasApiCredentials=d(()=>{let e=this._credentials();return!!(e.geminiApiKey||e.openaiApiKey)});this.hasTelegramCredentials=d(()=>{let e=this._credentials();return!!(e.telegramApiId&&e.telegramApiHash)});this.setupIpcListeners(),this.loadSettings()}setupIpcListeners(){this.ipc.on("settings-loaded",e=>{this._settings.set(n(n({},q),e)),this._isLoading.set(!1)}),this.ipc.on("settings-saved",()=>{this._isDirty.set(!1),this.toast.success("\u8A2D\u7F6E\u5DF2\u4FDD\u5B58")}),this.ipc.on("credentials-loaded",e=>{this._credentials.set(e)})}loadSettings(){this._isLoading.set(!0),this.ipc.send("get-settings"),this.ipc.send("get-credentials")}saveSettings(){this.ipc.send("save-settings",this._settings())}updateSetting(e,t){this._settings.update(s=>c(n({},s),{[e]:t})),this._isDirty.set(!0)}resetSettings(){confirm("\u78BA\u5B9A\u8981\u91CD\u7F6E\u6240\u6709\u8A2D\u7F6E\u55CE\uFF1F")&&(this._settings.set(q),this._isDirty.set(!0),this.saveSettings())}setTheme(e){this.updateSetting("theme",e),this.applyTheme(e)}toggleTheme(){let t=this._settings().theme==="dark"?"light":"dark";this.setTheme(t)}applyTheme(e){let t=document.documentElement;if(e==="system"){let s=window.matchMedia("(prefers-color-scheme: dark)").matches;t.setAttribute("data-theme",s?"dark":"light")}else t.setAttribute("data-theme",e)}setLanguage(e){this.updateSetting("language",e),this.i18n.setLocale(e)}toggleSidebar(){let e=this._settings().sidebarCollapsed;this.updateSetting("sidebarCollapsed",!e)}setSidebarCollapsed(e){this.updateSetting("sidebarCollapsed",e)}saveCredentials(e){this._credentials.update(t=>n(n({},t),e)),this.ipc.send("save-credentials",this._credentials()),this.toast.success("API \u6191\u8B49\u5DF2\u4FDD\u5B58")}testGeminiConnection(){let e=this._credentials().geminiApiKey;if(!e){this.toast.error("\u8ACB\u5148\u8A2D\u7F6E Gemini API Key");return}this.ipc.send("test-gemini-connection",{apiKey:e}),this.toast.info("\u6B63\u5728\u6E2C\u8A66 Gemini \u9023\u63A5...")}testOpenAiConnection(){let e=this._credentials().openaiApiKey;if(!e){this.toast.error("\u8ACB\u5148\u8A2D\u7F6E OpenAI API Key");return}this.ipc.send("test-openai-connection",{apiKey:e}),this.toast.info("\u6B63\u5728\u6E2C\u8A66 OpenAI \u9023\u63A5...")}testTelegramCredentials(){let e=this._credentials();if(!e.telegramApiId||!e.telegramApiHash){this.toast.error("\u8ACB\u5148\u8A2D\u7F6E Telegram API \u6191\u8B49");return}this.ipc.send("test-telegram-credentials",{apiId:e.telegramApiId,apiHash:e.telegramApiHash}),this.toast.info("\u6B63\u5728\u6E2C\u8A66 Telegram \u6191\u8B49...")}exportSettings(){let e={settings:this._settings(),exportedAt:new Date().toISOString()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=`tg-settings-${new Date().toISOString().split("T")[0]}.json`,i.click(),URL.revokeObjectURL(s),this.toast.success("\u8A2D\u7F6E\u5DF2\u5C0E\u51FA")}importSettings(e){let t=new FileReader;t.onload=s=>{try{let i=JSON.parse(s.target?.result);i.settings?(this._settings.set(n(n({},q),i.settings)),this._isDirty.set(!0),this.saveSettings(),this.toast.success("\u8A2D\u7F6E\u5DF2\u5C0E\u5165")):this.toast.error("\u7121\u6548\u7684\u8A2D\u7F6E\u6587\u4EF6")}catch{this.toast.error("\u8A2D\u7F6E\u6587\u4EF6\u89E3\u6790\u5931\u6557")}},t.readAsText(e)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Le={provider:"gemini",model:"gemini-pro",temperature:.7,maxTokens:2048,systemPrompt:"\u4F60\u662F\u4E00\u500B\u5C08\u696D\u7684 Telegram \u71DF\u92B7\u52A9\u624B\uFF0C\u5E6B\u52A9\u7528\u6236\u9032\u884C\u7FA4\u7D44\u7BA1\u7406\u548C\u5BA2\u6236\u958B\u767C\u3002",enableMemory:!0,enableRag:!1},ie=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._settings=r(Le);this._currentSession=r(null);this._sessions=r([]);this._isGenerating=r(!1);this._isConnected=r(!1);this._ragDocuments=r([]);this.settings=this._settings.asReadonly();this.currentSession=this._currentSession.asReadonly();this.sessions=this._sessions.asReadonly();this.isGenerating=this._isGenerating.asReadonly();this.isConnected=this._isConnected.asReadonly();this.ragDocuments=this._ragDocuments.asReadonly();this.currentMessages=d(()=>this._currentSession()?.messages||[]);this.hasMessages=d(()=>(this._currentSession()?.messages.length||0)>0);this.provider=d(()=>this._settings().provider);this.setupIpcListeners(),this.loadSettings()}setupIpcListeners(){this.ipc.on("ai-settings-loaded",e=>{this._settings.set(n(n({},Le),e))}),this.ipc.on("ai-response",e=>{this._isGenerating.set(!1),this.addMessage("assistant",e.content,e.tokens)}),this.ipc.on("ai-response-error",e=>{this._isGenerating.set(!1),this.toast.error(`AI \u56DE\u5FA9\u5931\u6557: ${e.error}`)}),this.ipc.on("ai-connection-status",e=>{this._isConnected.set(e.connected)}),this.ipc.on("chat-sessions-loaded",e=>{this._sessions.set(e)}),this.ipc.on("rag-documents-loaded",e=>{this._ragDocuments.set(e)})}loadSettings(){this.ipc.send("get-ai-settings")}saveSettings(){this.ipc.send("save-ai-settings",this._settings()),this.toast.success("AI \u8A2D\u7F6E\u5DF2\u4FDD\u5B58")}updateSetting(e,t){this._settings.update(s=>c(n({},s),{[e]:t}))}setProvider(e){this.updateSetting("provider",e);let t={gemini:"gemini-pro",openai:"gpt-4",claude:"claude-3-opus",local:"llama2"};this.updateSetting("model",t[e])}sendMessage(e){!e.trim()||this._isGenerating()||(this.addMessage("user",e.trim()),this._isGenerating.set(!0),this.ipc.send("generate-ai-response",{prompt:e.trim(),settings:this._settings(),history:this.currentMessages().slice(-10),enableRag:this._settings().enableRag}))}addMessage(e,t,s){let i={id:crypto.randomUUID(),role:e,content:t,timestamp:new Date().toISOString(),tokens:s};this._currentSession.update(a=>a?c(n({},a),{messages:[...a.messages,i],updatedAt:new Date().toISOString()}):{id:crypto.randomUUID(),title:t.slice(0,30)+(t.length>30?"...":""),messages:[i],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}newSession(){let e=this._currentSession();e&&e.messages.length>0&&this.saveSession(e),this._currentSession.set(null)}loadSession(e){let t=this._sessions().find(s=>s.id===e);t&&this._currentSession.set(t)}saveSession(e){this.ipc.send("save-chat-session",e),this._sessions.update(t=>{let s=t.findIndex(i=>i.id===e.id);return s>=0?(t[s]=e,[...t]):[e,...t]})}deleteSession(e){confirm("\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u5C0D\u8A71\u55CE\uFF1F")&&(this.ipc.send("delete-chat-session",{sessionId:e}),this._sessions.update(t=>t.filter(s=>s.id!==e)),this._currentSession()?.id===e&&this._currentSession.set(null),this.toast.success("\u5C0D\u8A71\u5DF2\u522A\u9664"))}clearHistory(){confirm("\u78BA\u5B9A\u8981\u6E05\u7A7A\u6240\u6709\u5C0D\u8A71\u8A18\u9304\u55CE\uFF1F")&&(this.ipc.send("clear-chat-history"),this._sessions.set([]),this._currentSession.set(null),this.toast.success("\u5C0D\u8A71\u8A18\u9304\u5DF2\u6E05\u7A7A"))}loadRagDocuments(){this.ipc.send("get-rag-documents")}addRagDocument(e){this.ipc.send("add-rag-document",e),this.toast.info("\u6B63\u5728\u6DFB\u52A0\u6587\u6A94...")}deleteRagDocument(e){confirm("\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u6587\u6A94\u55CE\uFF1F")&&(this.ipc.send("delete-rag-document",{docId:e}),this._ragDocuments.update(t=>t.filter(s=>s.id!==e)),this.toast.success("\u6587\u6A94\u5DF2\u522A\u9664"))}testConnection(){this.ipc.send("test-ai-connection",this._settings()),this.toast.info("\u6B63\u5728\u6E2C\u8A66 AI \u9023\u63A5...")}generateGreeting(e){let t=`\u751F\u6210\u4E00\u689D\u53CB\u597D\u7684\u554F\u5019\u6D88\u606F\uFF0C\u7528\u65BC Telegram \u7FA4\u7D44\u3002${e?`\u80CC\u666F\u4FE1\u606F: ${JSON.stringify(e)}`:""}`;this.sendMessage(t)}generateReply(e,t){let s=`\u8ACB\u91DD\u5C0D\u4EE5\u4E0B\u6D88\u606F\u751F\u6210\u4E00\u689D\u5C08\u696D\u7684\u56DE\u5FA9\uFF1A
    
\u539F\u6D88\u606F\uFF1A${e}
${t?`\u80CC\u666F\u4FE1\u606F: ${JSON.stringify(t)}`:""}

\u8ACB\u751F\u6210\u7C21\u6F54\u3001\u5C08\u696D\u7684\u56DE\u5FA9\u3002`;this.sendMessage(s)}summarizeConversation(){let e=this.currentMessages();if(e.length<2){this.toast.warning("\u5C0D\u8A71\u5167\u5BB9\u592A\u5C11\uFF0C\u7121\u6CD5\u751F\u6210\u6458\u8981");return}let s=`\u8ACB\u7E3D\u7D50\u4EE5\u4E0B\u5C0D\u8A71\u7684\u4E3B\u8981\u5167\u5BB9\uFF1A

${e.map(i=>`${i.role==="user"?"\u7528\u6236":"AI"}\uFF1A${i.content}`).join(`
`)}`;this.sendMessage(s)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var re=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._resources=r([]);this._selectedIds=r(new Set);this._filter=r({type:"all",status:"all"});this._isLoading=r(!1);this._searchResults=r([]);this._isSearching=r(!1);this.resources=this._resources.asReadonly();this.selectedIds=this._selectedIds.asReadonly();this.filter=this._filter.asReadonly();this.isLoading=this._isLoading.asReadonly();this.searchResults=this._searchResults.asReadonly();this.isSearching=this._isSearching.asReadonly();this.filteredResources=d(()=>{let e=this._resources(),t=this._filter();return e.filter(s=>{if(t.type&&t.type!=="all"&&s.type!==t.type||t.status&&t.status!=="all"&&s.status!==t.status)return!1;if(t.search){let i=t.search.toLowerCase(),a=s.title?.toLowerCase().includes(i),u=s.username?.toLowerCase().includes(i);if(!a&&!u)return!1}return!(t.hasMembers!==void 0&&(t.hasMembers&&!s.member_count||!t.hasMembers&&s.member_count)||t.isPublic!==void 0&&s.is_public!==t.isPublic)})});this.stats=d(()=>{let e=this._resources(),t={group:0,channel:0,user:0,bot:0},s={discovered:0,joined:0,monitored:0,left:0},i=0;for(let a of e)t[a.type]!==void 0&&t[a.type]++,s[a.status]!==void 0&&s[a.status]++,i+=a.member_count||0;return{total:e.length,byType:t,byStatus:s,totalMembers:i}});this.selectedResources=d(()=>{let e=this._selectedIds();return this._resources().filter(t=>e.has(t.id))});this.selectedCount=d(()=>this._selectedIds().size);this.groups=d(()=>this._resources().filter(e=>e.type==="group"));this.channels=d(()=>this._resources().filter(e=>e.type==="channel"));this.joinedResources=d(()=>this._resources().filter(e=>e.status==="joined"));this.monitoredResources=d(()=>this._resources().filter(e=>e.status==="monitored"));this.setupIpcListeners()}setupIpcListeners(){this.ipc.on("resources-loaded",e=>{this._resources.set(e),this._isLoading.set(!1)}),this.ipc.on("resource-updated",e=>{this._resources.update(t=>t.map(s=>s.id===e.id?n(n({},s),e):s))}),this.ipc.on("search-results",e=>{this._searchResults.set(e),this._isSearching.set(!1)}),this.ipc.on("search-error",e=>{this._isSearching.set(!1),this.toast.error(`\u641C\u7D22\u5931\u6557: ${e.error}`)})}loadResources(){this._isLoading.set(!0),this.ipc.send("get-resources")}refreshResources(){this.ipc.send("refresh-resources"),this.toast.info("\u6B63\u5728\u5237\u65B0\u8CC7\u6E90...")}getResource(e){return this._resources().find(t=>t.id===e)}updateResource(e,t){this._resources.update(s=>s.map(i=>i.id===e?n(n({},i),t):i)),this.ipc.send("update-resource",{id:e,updates:t})}deleteResource(e){confirm("\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u8CC7\u6E90\u55CE\uFF1F")&&(this._resources.update(t=>t.filter(s=>s.id!==e)),this._selectedIds.update(t=>{let s=new Set(t);return s.delete(e),s}),this.ipc.send("delete-resource",{id:e}),this.toast.success("\u8CC7\u6E90\u5DF2\u522A\u9664"))}toggleSelection(e){this._selectedIds.update(t=>{let s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})}selectAll(){let e=new Set(this.filteredResources().map(t=>t.id));this._selectedIds.set(e)}deselectAll(){this._selectedIds.set(new Set)}isSelected(e){return this._selectedIds().has(e)}setFilter(e){this._filter.update(t=>n(n({},t),e))}clearFilter(){this._filter.set({type:"all",status:"all"})}setSearch(e){this._filter.update(t=>c(n({},t),{search:e}))}search(e){this._isSearching.set(!0),this._searchResults.set([]),this.ipc.send("search-resources",e),this.toast.info("\u6B63\u5728\u641C\u7D22...")}clearSearchResults(){this._searchResults.set([])}addSearchResultToResources(e){this._resources.update(t=>t.some(s=>s.telegram_id===e.telegram_id)?t:[...t,e])}batchJoin(e){let t=this.selectedResources();if(t.length===0){this.toast.warning("\u8ACB\u5148\u9078\u64C7\u8CC7\u6E90");return}this.ipc.send("batch-join-resources",{resourceIds:t.map(s=>s.id),phone:e}),this.toast.info(`\u6B63\u5728\u52A0\u5165 ${t.length} \u500B\u8CC7\u6E90...`)}batchLeave(e){let t=this.selectedResources();if(t.length===0){this.toast.warning("\u8ACB\u5148\u9078\u64C7\u8CC7\u6E90");return}confirm(`\u78BA\u5B9A\u8981\u96E2\u958B ${t.length} \u500B\u8CC7\u6E90\u55CE\uFF1F`)&&(this.ipc.send("batch-leave-resources",{resourceIds:t.map(s=>s.id),phone:e}),this.toast.info(`\u6B63\u5728\u96E2\u958B ${t.length} \u500B\u8CC7\u6E90...`))}batchDelete(){let e=this.selectedResources();if(e.length===0){this.toast.warning("\u8ACB\u5148\u9078\u64C7\u8CC7\u6E90");return}if(!confirm(`\u78BA\u5B9A\u8981\u522A\u9664 ${e.length} \u500B\u8CC7\u6E90\u55CE\uFF1F`))return;let t=e.map(s=>s.id);this._resources.update(s=>s.filter(i=>!t.includes(i.id))),this._selectedIds.set(new Set),this.ipc.send("batch-delete-resources",{resourceIds:t}),this.toast.success(`\u5DF2\u522A\u9664 ${e.length} \u500B\u8CC7\u6E90`)}addTag(e,t){this._resources.update(s=>s.map(i=>{if(i.id===e){let a=i.tags||[];if(!a.includes(t))return c(n({},i),{tags:[...a,t]})}return i})),this.ipc.send("add-resource-tag",{resourceId:e,tag:t})}removeTag(e,t){this._resources.update(s=>s.map(i=>i.id===e&&i.tags?c(n({},i),{tags:i.tags.filter(a=>a!==t)}):i)),this.ipc.send("remove-resource-tag",{resourceId:e,tag:t})}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Fe=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._jobs=r([]);this._currentJob=r(null);this._templates=r([]);this._isExporting=r(!1);this.jobs=this._jobs.asReadonly();this.currentJob=this._currentJob.asReadonly();this.templates=this._templates.asReadonly();this.isExporting=this._isExporting.asReadonly();this.setupIpcListeners(),this.loadTemplates()}setupIpcListeners(){this.ipc.on("export-started",e=>{this._currentJob.set(e),this._jobs.update(t=>[e,...t]),this._isExporting.set(!0)}),this.ipc.on("export-progress",e=>{this._jobs.update(t=>t.map(s=>s.id===e.jobId?c(n({},s),{progress:e.progress}):s)),this._currentJob()?.id===e.jobId&&this._currentJob.update(t=>t&&c(n({},t),{progress:e.progress}))}),this.ipc.on("export-completed",e=>{this._jobs.update(t=>t.map(s=>s.id===e.jobId?c(n({},s),{status:"completed",progress:100,filePath:e.filePath,completedAt:new Date().toISOString()}):s)),this._currentJob.set(null),this._isExporting.set(!1),this.toast.success("\u5C0E\u51FA\u5B8C\u6210\uFF01")}),this.ipc.on("export-failed",e=>{this._jobs.update(t=>t.map(s=>s.id===e.jobId?c(n({},s),{status:"failed",error:e.error}):s)),this._currentJob.set(null),this._isExporting.set(!1),this.toast.error(`\u5C0E\u51FA\u5931\u6557: ${e.error}`)})}exportLeads(e="csv",t){this.startExport(n({format:e,type:"leads",includeHeaders:!0},t))}exportMembers(e,t="csv",s){this.startExport(n({format:t,type:"members",filters:{resourceId:e},includeHeaders:!0},s))}exportResources(e="csv",t){this.startExport(n({format:e,type:"resources",includeHeaders:!0},t))}exportMessages(e="json",t){this.startExport(n({format:e,type:"messages"},t))}exportAnalytics(e="xlsx",t){this.startExport(n({format:e,type:"analytics"},t))}exportReport(e,t="pdf"){this.startExport({format:t,type:"report",filters:{reportType:e}})}startExport(e){if(this._isExporting()){this.toast.warning("\u6B63\u5728\u9032\u884C\u5C0E\u51FA\uFF0C\u8ACB\u7B49\u5F85\u5B8C\u6210");return}this.ipc.send("start-export",e),this.toast.info("\u958B\u59CB\u5C0E\u51FA...")}cancelExport(){let e=this._currentJob();e&&(this.ipc.send("cancel-export",{jobId:e.id}),this._currentJob.set(null),this._isExporting.set(!1),this.toast.info("\u5DF2\u53D6\u6D88\u5C0E\u51FA"))}openExportFile(e){if(!e.filePath){this.toast.error("\u6587\u4EF6\u8DEF\u5F91\u4E0D\u5B58\u5728");return}this.ipc.send("open-file",{path:e.filePath})}openExportFolder(e){if(!e.filePath){this.toast.error("\u6587\u4EF6\u8DEF\u5F91\u4E0D\u5B58\u5728");return}this.ipc.send("open-folder",{path:e.filePath})}clearHistory(){confirm("\u78BA\u5B9A\u8981\u6E05\u9664\u5C0E\u51FA\u6B77\u53F2\u55CE\uFF1F")&&(this._jobs.set([]),this.toast.success("\u5C0E\u51FA\u6B77\u53F2\u5DF2\u6E05\u9664"))}deleteJob(e){this._jobs.update(t=>t.filter(s=>s.id!==e))}loadTemplates(){try{let e=localStorage.getItem("export-templates");e&&this._templates.set(JSON.parse(e))}catch{}}saveTemplate(e){let t=c(n({},e),{id:crypto.randomUUID()});this._templates.update(s=>[...s,t]),this.saveTemplatesToStorage(),this.toast.success("\u6A21\u677F\u5DF2\u4FDD\u5B58")}deleteTemplate(e){confirm("\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u6A21\u677F\u55CE\uFF1F")&&(this._templates.update(t=>t.filter(s=>s.id!==e)),this.saveTemplatesToStorage(),this.toast.success("\u6A21\u677F\u5DF2\u522A\u9664"))}useTemplate(e){let t=this._templates().find(s=>s.id===e);if(!t){this.toast.error("\u6A21\u677F\u4E0D\u5B58\u5728");return}this.startExport(n({format:t.options.format||"csv",type:t.type},t.options))}saveTemplatesToStorage(){try{localStorage.setItem("export-templates",JSON.stringify(this._templates()))}catch{}}getFormatIcon(e){return{csv:"\u{1F4CA}",xlsx:"\u{1F4D7}",json:"\u{1F4CB}",pdf:"\u{1F4D5}"}[e]||"\u{1F4C4}"}getFormatName(e){return{csv:"CSV",xlsx:"Excel",json:"JSON",pdf:"PDF"}[e]||e.toUpperCase()}getTypeName(e){return{leads:"\u7DDA\u7D22",members:"\u6210\u54E1",resources:"\u8CC7\u6E90",messages:"\u6D88\u606F",analytics:"\u5206\u6790",report:"\u5831\u544A"}[e]||e}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Pe=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._backups=r([]);this._isLoading=r(!1);this._isCreating=r(!1);this._isRestoring=r(!1);this._settings=r({autoBackup:!1,interval:24,maxBackups:10,includeMedia:!1});this.backups=this._backups.asReadonly();this.isLoading=this._isLoading.asReadonly();this.isCreating=this._isCreating.asReadonly();this.isRestoring=this._isRestoring.asReadonly();this.settings=this._settings.asReadonly();this.setupIpcListeners()}setupIpcListeners(){this.ipc.on("backups-loaded",e=>{this._backups.set(e),this._isLoading.set(!1)}),this.ipc.on("backup-created",e=>{this._backups.update(t=>[e,...t]),this._isCreating.set(!1),this.toast.success("\u5099\u4EFD\u5275\u5EFA\u6210\u529F\uFF01")}),this.ipc.on("backup-create-error",e=>{this._isCreating.set(!1),this.toast.error(`\u5099\u4EFD\u5275\u5EFA\u5931\u6557: ${e.error}`)}),this.ipc.on("backup-restored",()=>{this._isRestoring.set(!1),this.toast.success("\u5099\u4EFD\u6062\u5FA9\u6210\u529F\uFF01\u61C9\u7528\u5C07\u91CD\u65B0\u52A0\u8F09..."),setTimeout(()=>window.location.reload(),2e3)}),this.ipc.on("backup-restore-error",e=>{this._isRestoring.set(!1),this.toast.error(`\u5099\u4EFD\u6062\u5FA9\u5931\u6557: ${e.error}`)}),this.ipc.on("backup-deleted",e=>{this._backups.update(t=>t.filter(s=>s.id!==e.id)),this.toast.success("\u5099\u4EFD\u5DF2\u522A\u9664")}),this.ipc.on("backup-settings-loaded",e=>{this._settings.set(e)})}loadBackups(){this._isLoading.set(!0),this.ipc.send("get-backups")}createBackup(e){this._isCreating.set(!0),this.ipc.send("create-backup",{description:e})}restoreBackup(e){confirm("\u78BA\u5B9A\u8981\u6062\u5FA9\u6B64\u5099\u4EFD\u55CE\uFF1F\u7576\u524D\u6578\u64DA\u5C07\u88AB\u8986\u84CB\u3002")&&(this._isRestoring.set(!0),this.ipc.send("restore-backup",{id:e}))}deleteBackup(e){confirm("\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u5099\u4EFD\u55CE\uFF1F")&&this.ipc.send("delete-backup",{id:e})}loadSettings(){this.ipc.send("get-backup-settings")}updateSettings(e){this._settings.update(t=>n(n({},t),e)),this.ipc.send("save-backup-settings",this._settings()),this.toast.success("\u5099\u4EFD\u8A2D\u7F6E\u5DF2\u4FDD\u5B58")}toggleAutoBackup(){this.updateSettings({autoBackup:!this._settings().autoBackup})}formatSize(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:e<1024*1024*1024?`${(e/(1024*1024)).toFixed(1)} MB`:`${(e/(1024*1024*1024)).toFixed(2)} GB`}getBackupAge(e){let t=new Date(e),i=new Date().getTime()-t.getTime(),a=Math.floor(i/(1e3*60*60*24));return a===0?"\u4ECA\u5929":a===1?"\u6628\u5929":a<7?`${a} \u5929\u524D`:a<30?`${Math.floor(a/7)} \u9031\u524D`:`${Math.floor(a/30)} \u500B\u6708\u524D`}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Oe=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._status=r({isRunning:!1,uptime:0,totalTasks:0,activeTasks:0,tasks:[]});this._logs=r([]);this._isLoading=r(!1);this.status=this._status.asReadonly();this.logs=this._logs.asReadonly();this.isLoading=this._isLoading.asReadonly();this.isRunning=d(()=>this._status().isRunning);this.tasks=d(()=>this._status().tasks);this.activeTasks=d(()=>this._status().tasks.filter(e=>e.status==="running"));this.idleTasks=d(()=>this._status().tasks.filter(e=>e.status==="idle"));this.errorTasks=d(()=>this._status().tasks.filter(e=>e.status==="error"));this.uptimeFormatted=d(()=>{let e=this._status().uptime,t=Math.floor(e/3600),s=Math.floor(e%3600/60),i=e%60;return t>0?`${t}h ${s}m`:s>0?`${s}m ${i}s`:`${i}s`});this.setupIpcListeners()}setupIpcListeners(){this.ipc.on("scheduler-status",e=>{this._status.set(e),this._isLoading.set(!1)}),this.ipc.on("scheduler-started",()=>{this._status.update(e=>c(n({},e),{isRunning:!0})),this.toast.success("\u8ABF\u5EA6\u5668\u5DF2\u555F\u52D5")}),this.ipc.on("scheduler-stopped",()=>{this._status.update(e=>c(n({},e),{isRunning:!1})),this.toast.info("\u8ABF\u5EA6\u5668\u5DF2\u505C\u6B62")}),this.ipc.on("scheduler-task-started",e=>{this._status.update(t=>c(n({},t),{tasks:t.tasks.map(s=>s.name===e.taskName?c(n({},s),{status:"running"}):s)}))}),this.ipc.on("scheduler-task-completed",e=>{this._status.update(t=>c(n({},t),{tasks:t.tasks.map(s=>s.name===e.taskName?c(n({},s),{status:"idle",lastRun:new Date().toISOString(),runCount:s.runCount+1}):s)}))}),this.ipc.on("scheduler-task-error",e=>{this._status.update(t=>c(n({},t),{tasks:t.tasks.map(s=>s.name===e.taskName?c(n({},s),{status:"error",errorMessage:e.error}):s)})),this.toast.error(`\u4EFB\u52D9 ${e.taskName} \u57F7\u884C\u5931\u6557`)}),this.ipc.on("scheduler-logs",e=>{this._logs.set(e)})}loadStatus(){this._isLoading.set(!0),this.ipc.send("get-scheduler-status")}start(){this.ipc.send("start-scheduler")}stop(){this.ipc.send("stop-scheduler")}restart(){this.ipc.send("restart-scheduler"),this.toast.info("\u6B63\u5728\u91CD\u555F\u8ABF\u5EA6\u5668...")}runTask(e){this.ipc.send("run-scheduler-task",{taskName:e}),this.toast.info(`\u6B63\u5728\u57F7\u884C\u4EFB\u52D9: ${e}`)}enableTask(e){this.ipc.send("enable-scheduler-task",{taskName:e}),this._status.update(t=>c(n({},t),{tasks:t.tasks.map(s=>s.name===e?c(n({},s),{enabled:!0,status:"idle"}):s)}))}disableTask(e){this.ipc.send("disable-scheduler-task",{taskName:e}),this._status.update(t=>c(n({},t),{tasks:t.tasks.map(s=>s.name===e?c(n({},s),{enabled:!1,status:"disabled"}):s)}))}updateTaskInterval(e,t){this.ipc.send("update-task-interval",{taskName:e,interval:t}),this._status.update(s=>c(n({},s),{tasks:s.tasks.map(i=>i.name===e?c(n({},i),{interval:t}):i)})),this.toast.success("\u4EFB\u52D9\u9593\u9694\u5DF2\u66F4\u65B0")}loadLogs(e=100){this.ipc.send("get-scheduler-logs",{limit:e})}clearLogs(){confirm("\u78BA\u5B9A\u8981\u6E05\u9664\u6240\u6709\u8ABF\u5EA6\u65E5\u8A8C\u55CE\uFF1F")&&(this.ipc.send("clear-scheduler-logs"),this._logs.set([]),this.toast.success("\u8ABF\u5EA6\u65E5\u8A8C\u5DF2\u6E05\u9664"))}getTaskStatusColor(e){switch(e){case"running":return"text-green-400";case"idle":return"text-slate-400";case"error":return"text-red-400";case"disabled":return"text-slate-600";default:return"text-slate-400"}}getTaskStatusIcon(e){switch(e){case"running":return"\u{1F7E2}";case"idle":return"\u26AA";case"error":return"\u{1F534}";case"disabled":return"\u26AB";default:return"\u26AA"}}formatInterval(e){return e<60?`${e} \u79D2`:e<3600?`${Math.floor(e/60)} \u5206\u9418`:e<86400?`${Math.floor(e/3600)} \u5C0F\u6642`:`${Math.floor(e/86400)} \u5929`}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var je=class o{constructor(){this._backendConnectionState=r("connecting");this._backendConnectionMessage=r("\u6B63\u5728\u9023\u63A5\u5F8C\u7AEF\u670D\u52D9...");this._backendConnectionProgress=r(0);this.backendConnectionState=this._backendConnectionState.asReadonly();this.backendConnectionMessage=this._backendConnectionMessage.asReadonly();this.backendConnectionProgress=this._backendConnectionProgress.asReadonly();this.isConnected=d(()=>this._backendConnectionState()==="connected");this._currentView=r("dashboard");this._previousView=r(null);this._sidebarCollapsed=r(!1);this.currentView=this._currentView.asReadonly();this.previousView=this._previousView.asReadonly();this.sidebarCollapsed=this._sidebarCollapsed.asReadonly();this._accounts=r([]);this._selectedAccountId=r(null);this.accounts=this._accounts.asReadonly();this.selectedAccountId=this._selectedAccountId.asReadonly();this.selectedAccount=d(()=>{let e=this._selectedAccountId();return e?this._accounts().find(t=>t.id===e):null});this.onlineAccounts=d(()=>this._accounts().filter(e=>e.status==="Online"));this.accountStats=d(()=>{let e=this._accounts();return{total:e.length,online:e.filter(t=>t.status==="Online").length,offline:e.filter(t=>t.status==="Offline").length,error:e.filter(t=>t.status==="Error"||t.status==="Banned").length}});this._groups=r([]);this._keywordSets=r([]);this._templates=r([]);this._isMonitoring=r(!1);this.groups=this._groups.asReadonly();this.keywordSets=this._keywordSets.asReadonly();this.templates=this._templates.asReadonly();this.isMonitoring=this._isMonitoring.asReadonly();this.monitoringStats=d(()=>{let e=this._groups(),t=this._keywordSets();return{totalGroups:e.length,activeGroups:e.filter(s=>s.isActive).length,totalKeywords:t.reduce((s,i)=>s+(i.keywords?.length||0),0),activeKeywordSets:t.filter(s=>s.is_active).length}});this._isLoading=r(!1);this._loadingMessage=r("");this.isLoading=this._isLoading.asReadonly();this.loadingMessage=this._loadingMessage.asReadonly();this.navModules=[{id:"dashboard",name:"\u5DE5\u4F5C\u53F0",icon:"\u{1F4CA}",views:[{id:"dashboard",name:"\u7E3D\u89BD",icon:"\u{1F3E0}"},{id:"analytics-center",name:"\u6578\u64DA\u5206\u6790",icon:"\u{1F4C8}"}]},{id:"accounts",name:"\u5E33\u865F\u7BA1\u7406",icon:"\u{1F464}",views:[{id:"accounts",name:"\u5E33\u865F\u5217\u8868",icon:"\u{1F4F1}"},{id:"add-account",name:"\u6DFB\u52A0\u5E33\u865F",icon:"\u2795"},{id:"api-credentials",name:"API \u6191\u8B49",icon:"\u{1F511}"}]},{id:"automation",name:"\u81EA\u52D5\u5316\u4E2D\u5FC3",icon:"\u{1F916}",views:[{id:"automation",name:"\u81EA\u52D5\u5316\u9762\u677F",icon:"\u26A1"},{id:"monitoring-accounts",name:"\u76E3\u63A7\u5E33\u865F",icon:"\u{1F441}\uFE0F"},{id:"monitoring-groups",name:"\u76E3\u63A7\u7FA4\u7D44",icon:"\u{1F4AC}"},{id:"keyword-sets",name:"\u95DC\u9375\u8A5E\u96C6",icon:"\u{1F524}"},{id:"chat-templates",name:"\u8A71\u8853\u6A21\u677F",icon:"\u{1F4DD}"},{id:"trigger-rules",name:"\u89F8\u767C\u898F\u5247",icon:"\u{1F3AF}"},{id:"collected-users",name:"\u6536\u96C6\u7528\u6236",icon:"\u{1F465}"}]},{id:"resources",name:"\u8CC7\u6E90\u4E2D\u5FC3",icon:"\u{1F4E6}",views:[{id:"search-discovery",name:"\u641C\u7D22\u767C\u73FE",icon:"\u{1F50D}"},{id:"member-database",name:"\u6210\u54E1\u8CC7\u6599\u5EAB",icon:"\u{1F465}"},{id:"resource-center",name:"\u8CC7\u6E90\u7BA1\u7406",icon:"\u{1F4C1}"}]},{id:"leads",name:"\u5BA2\u6236\u57F9\u80B2",icon:"\u{1F3AF}",views:[{id:"lead-nurturing",name:"\u7DDA\u7D22\u7BA1\u7406",icon:"\u{1F4CB}"},{id:"nurturing-analytics",name:"\u57F9\u80B2\u5206\u6790",icon:"\u{1F4CA}"}]},{id:"ai",name:"AI \u4E2D\u5FC3",icon:"\u{1F9E0}",views:[{id:"ai-center",name:"AI \u914D\u7F6E",icon:"\u2699\uFE0F"},{id:"ai-assistant",name:"AI \u52A9\u624B",icon:"\u{1F4AC}"},{id:"ai-team",name:"AI \u5718\u968A",icon:"\u{1F465}"},{id:"multi-role",name:"\u591A\u89D2\u8272\u5354\u4F5C",icon:"\u{1F3AD}"}]},{id:"system",name:"\u7CFB\u7D71\u8A2D\u7F6E",icon:"\u2699\uFE0F",views:[{id:"settings",name:"\u7CFB\u7D71\u8A2D\u7F6E",icon:"\u{1F527}"},{id:"profile",name:"\u500B\u4EBA\u8CC7\u6599",icon:"\u{1F464}"},{id:"membership-center",name:"\u6703\u54E1\u4E2D\u5FC3",icon:"\u{1F48E}"}]}]}setConnectionState(e,t){this._backendConnectionState.set(e),t&&this._backendConnectionMessage.set(t)}setConnectionProgress(e){this._backendConnectionProgress.set(e)}navigateTo(e){this._previousView.set(this._currentView()),this._currentView.set(e)}goBack(){let e=this._previousView();e&&(this._currentView.set(e),this._previousView.set(null))}toggleSidebar(){this._sidebarCollapsed.update(e=>!e)}setSidebarCollapsed(e){this._sidebarCollapsed.set(e)}setAccounts(e){this._accounts.set(e)}updateAccount(e){this._accounts.update(t=>t.map(s=>s.id===e.id?e:s))}addAccount(e){this._accounts.update(t=>[...t,e])}removeAccount(e){this._accounts.update(t=>t.filter(s=>s.id!==e))}selectAccount(e){this._selectedAccountId.set(e)}setGroups(e){this._groups.set(e)}setKeywordSets(e){this._keywordSets.set(e)}setTemplates(e){this._templates.set(e)}setMonitoring(e){this._isMonitoring.set(e)}setLoading(e,t){this._isLoading.set(e),t!==void 0&&this._loadingMessage.set(t)}getModuleForView(e){return this.navModules.find(t=>t.views.some(s=>s.id===e))}getViewInfo(e){for(let t of this.navModules){let s=t.views.find(i=>i.id===e);if(s)return s}}getBreadcrumb(){let e=this._currentView(),t=this.getModuleForView(e),s=this.getViewInfo(e);return t&&s?{module:t,view:s}:null}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var ne=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._initialized=r(!1);this._selectedAccountId=r(null);this._searchState=r({isSearching:!1,query:"",progress:0,currentSource:null,error:null});this._results=r([]);this._savedResources=r([]);this._searchHistory=r([]);this._stats=r({totalDiscovered:0,groups:0,channels:0,users:0,todayDiscovered:0});this.searchCache=new Map;this.CACHE_EXPIRY_MS=300*1e3;this.initialized=this._initialized.asReadonly();this.selectedAccountId=this._selectedAccountId.asReadonly();this.searchState=this._searchState.asReadonly();this.results=this._results.asReadonly();this.savedResources=this._savedResources.asReadonly();this.searchHistory=this._searchHistory.asReadonly();this.stats=this._stats.asReadonly();this.isSearching=d(()=>this._searchState().isSearching);this.searchProgress=d(()=>this._searchState().progress);this.groupResults=d(()=>this._results().filter(e=>e.type==="group"));this.channelResults=d(()=>this._results().filter(e=>e.type==="channel"));this.userResults=d(()=>this._results().filter(e=>e.type==="user"))}async initialize(e){let t=this.selectBestAccount(e);return t?(this._selectedAccountId.set(t.id),new Promise(s=>{this.ipc.send("init-resource-discovery",{accountId:t.id,phone:t.phone}),setTimeout(()=>{this._initialized.set(!0),s(!0)},1e3)})):(this.toast.error("\u6C92\u6709\u53EF\u7528\u7684\u5728\u7DDA\u5E33\u865F"),!1)}selectBestAccount(e){let t=e.filter(i=>i.status==="Online");if(t.length===0)return null;let s={Explorer:1,Listener:2,Sender:3,AI:4,Backup:5,Unassigned:6};return t.sort((i,a)=>(s[i.role]||99)-(s[a.role]||99))[0]}async search(e,t=["telegram"]){if(!e.trim())return this.toast.warning("\u8ACB\u8F38\u5165\u641C\u7D22\u95DC\u9375\u8A5E"),[];let s=this.generateCacheKey(e,t),i=this.getFromCache(s);return i?(this._results.set(i.results),i.results):(this._searchState.set({isSearching:!0,query:e,progress:0,currentSource:t[0],error:null}),this._results.set([]),this.addToHistory(e),this.ipc.send("search-resources",{query:e,sources:t,accountId:this._selectedAccountId()}),[])}handleSearchResults(e){this._results.update(t=>{let s=[...t];for(let i of e.results)s.some(a=>a.id===i.id)||s.push(i);return s}),this._searchState.update(t=>c(n({},t),{progress:e.isComplete?100:t.progress+20,currentSource:e.source})),e.isComplete&&this.completeSearch()}handleSearchError(e){this._searchState.update(t=>c(n({},t),{isSearching:!1,error:e})),this.toast.error(`\u641C\u7D22\u5931\u6557: ${e}`)}completeSearch(){let e=this._searchState(),t=this._results(),s=this.generateCacheKey(e.query,["telegram"]);this.searchCache.set(s,{query:e.query,source:"telegram",results:t,timestamp:Date.now(),totalCount:t.length}),this._searchState.update(i=>c(n({},i),{isSearching:!1,progress:100})),this.updateStats(),this.toast.success(`\u627E\u5230 ${t.length} \u500B\u7D50\u679C`)}cancelSearch(){this.ipc.send("cancel-search"),this._searchState.update(e=>c(n({},e),{isSearching:!1,progress:0}))}clearResults(){this._results.set([]),this._searchState.update(e=>c(n({},e),{query:"",progress:0,error:null}))}async saveResource(e){if(this._savedResources().some(s=>s.id===e.id))return this.toast.info("\u6B64\u8CC7\u6E90\u5DF2\u4FDD\u5B58"),!1;let t=c(n({},e),{addedAt:new Date().toISOString()});return this._savedResources.update(s=>[...s,t]),this.ipc.send("save-resource",{resource:t}),this.toast.success("\u8CC7\u6E90\u5DF2\u4FDD\u5B58"),!0}removeResource(e){this._savedResources.update(t=>t.filter(s=>s.id!==e)),this.ipc.send("remove-resource",{resourceId:e})}async joinGroup(e){return e.type!=="group"&&e.type!=="channel"?(this.toast.error("\u53EA\u80FD\u52A0\u5165\u7FA4\u7D44\u6216\u983B\u9053"),!1):(this.ipc.send("join-group",{username:e.username,accessHash:e.accessHash,accountId:this._selectedAccountId()}),this.toast.info(`\u6B63\u5728\u52A0\u5165 ${e.title}...`),!0)}async extractMembers(e,t=100){if(e.type!=="group"){this.toast.error("\u53EA\u80FD\u5F9E\u7FA4\u7D44\u63D0\u53D6\u6210\u54E1");return}this.ipc.send("extract-members",{groupId:e.id,groupTitle:e.title,limit:t,accountId:this._selectedAccountId()}),this.toast.info("\u6B63\u5728\u63D0\u53D6\u6210\u54E1...")}generateCacheKey(e,t){let s=e.toLowerCase().trim(),i=[...t].sort().join(",");return`${s}|${i}`}getFromCache(e){let t=this.searchCache.get(e);return t?Date.now()-t.timestamp>this.CACHE_EXPIRY_MS?(this.searchCache.delete(e),null):t:null}addToHistory(e){this._searchHistory.update(t=>{let s=t.filter(i=>i!==e);return[e,...s].slice(0,20)})}clearHistory(){this._searchHistory.set([])}updateStats(){let e=this._results(),t=this._savedResources();this._stats.set({totalDiscovered:t.length,groups:t.filter(s=>s.type==="group").length,channels:t.filter(s=>s.type==="channel").length,users:t.filter(s=>s.type==="user").length,todayDiscovered:e.length})}refreshStats(){this.ipc.send("get-resource-stats")}setStats(e){this._stats.set(e)}selectAccount(e){this._selectedAccountId.set(e),this._initialized.set(!1)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var $e=class o{constructor(){this.errorHandlerService=l(oe)}handleError(e){console.error("Global error caught:",e),this.errorHandlerService.handle(e)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac})}},oe=class o{constructor(){this.toast=l(h);this._errors=r([]);this.errors=this._errors.asReadonly();this._lastError=r(null);this.lastError=this._lastError.asReadonly();this._stats=r({total:0,byType:{network:0,auth:0,permission:0,validation:0,telegram:0,database:0,ai:0,unknown:0},bySeverity:{info:0,warning:0,error:0,critical:0},lastHour:0});this.stats=this._stats.asReadonly();this._isOnline=r(typeof navigator<"u"?navigator.onLine:!0);this.isOnline=this._isOnline.asReadonly()}handle(e,t,s){let i=this.parseError(e,t);return s?.severity&&(i.severity=s.severity),this.logError(i),this._errors.update(a=>[i,...a.slice(0,99)]),this._lastError.set(i),this.updateStats(i),s?.silent||this.showToast(i),console.error(`[${i.type.toUpperCase()}] ${i.message}`,{error:i,context:t}),i}parseError(e,t){let s=`err_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i=new Date().toISOString();if(typeof e=="string")return{id:s,type:this.detectErrorType(e),severity:"error",message:e,userMessage:this.toUserMessage(e),suggestion:this.getSuggestion(e),timestamp:i,context:t};if(e instanceof Error){let a=this.detectErrorType(e.message);return{id:s,type:a,severity:"error",message:e.message,userMessage:this.toUserMessage(e.message,a),suggestion:this.getSuggestion(e.message,a),stack:e.stack,timestamp:i,context:t}}if(typeof e=="object"){let a=e.message||e.error||JSON.stringify(e),u=e.type||this.detectErrorType(a);return{id:s,type:u,severity:e.severity||"error",code:e.code,message:a,userMessage:e.userMessage||this.toUserMessage(a,u),suggestion:e.suggestion||this.getSuggestion(a,u),details:e.details||e,timestamp:i,context:t}}return{id:s,type:"unknown",severity:"error",message:String(e),userMessage:"\u767C\u751F\u672A\u77E5\u932F\u8AA4\uFF0C\u8ACB\u7A0D\u5F8C\u91CD\u8A66",timestamp:i,context:t}}detectErrorType(e){let t=e.toLowerCase();return t.includes("json")||t.includes("unexpected token")||t.includes("is not valid json")||t.includes("network")||t.includes("fetch")||t.includes("timeout")||t.includes("connection")?"network":t.includes("auth")||t.includes("login")||t.includes("token")||t.includes("unauthorized")||t.includes("401")?"auth":t.includes("permission")||t.includes("forbidden")||t.includes("403")||t.includes("access denied")?"permission":t.includes("validation")||t.includes("invalid")||t.includes("required")||t.includes("format")?"validation":t.includes("telegram")||t.includes("pyrogram")||t.includes("flood")||t.includes("peer")||t.includes("chat")?"telegram":t.includes("database")||t.includes("sqlite")||t.includes("sql")||t.includes("query")?"database":t.includes("ai")||t.includes("openai")||t.includes("gemini")||t.includes("ollama")||t.includes("model")?"ai":"unknown"}toUserMessage(e,t){let s={network:"\u7DB2\u7D61\u9023\u63A5\u51FA\u73FE\u554F\u984C\uFF0C\u8ACB\u6AA2\u67E5\u60A8\u7684\u7DB2\u7D61\u9023\u63A5",auth:"\u767B\u9304\u72C0\u614B\u5DF2\u904E\u671F\uFF0C\u8ACB\u91CD\u65B0\u767B\u9304",permission:"\u60A8\u6C92\u6709\u6B0A\u9650\u57F7\u884C\u6B64\u64CD\u4F5C",validation:"\u8F38\u5165\u7684\u6578\u64DA\u683C\u5F0F\u4E0D\u6B63\u78BA\uFF0C\u8ACB\u6AA2\u67E5\u5F8C\u91CD\u8A66",telegram:"Telegram \u670D\u52D9\u66AB\u6642\u4E0D\u53EF\u7528\uFF0C\u8ACB\u7A0D\u5F8C\u91CD\u8A66",database:"\u6578\u64DA\u5B58\u53D6\u51FA\u73FE\u554F\u984C\uFF0C\u8ACB\u7A0D\u5F8C\u91CD\u8A66",ai:"AI \u670D\u52D9\u66AB\u6642\u4E0D\u53EF\u7528\uFF0C\u8ACB\u7A0D\u5F8C\u91CD\u8A66",unknown:"\u767C\u751F\u672A\u77E5\u932F\u8AA4\uFF0C\u8ACB\u7A0D\u5F8C\u91CD\u8A66"};if(t)return s[t];if(e.includes("FLOOD_WAIT")){let i=e.match(/FLOOD_WAIT_(\d+)/);return`\u767C\u9001\u904E\u65BC\u983B\u7E41\uFF0C\u8ACB\u7B49\u5F85 ${i?parseInt(i[1]):60} \u79D2\u5F8C\u91CD\u8A66`}return e.includes("USER_PRIVACY_RESTRICTED")?"\u8A72\u7528\u6236\u5DF2\u958B\u555F\u96B1\u79C1\u4FDD\u8B77\uFF0C\u7121\u6CD5\u767C\u9001\u6D88\u606F":e.includes("PEER_ID_INVALID")?"\u7528\u6236\u4E0D\u5B58\u5728\u6216\u5DF2\u88AB\u5C01\u7981":s[this.detectErrorType(e)]}getSuggestion(e,t){let s={network:`1. \u6AA2\u67E5\u7DB2\u7D61\u9023\u63A5
2. \u5617\u8A66\u5237\u65B0\u9801\u9762
3. \u6AA2\u67E5\u4EE3\u7406\u8A2D\u7F6E`,auth:`1. \u91CD\u65B0\u767B\u9304\u5E33\u865F
2. \u6E05\u9664\u700F\u89BD\u5668\u7DE9\u5B58
3. \u806F\u7E6B\u5BA2\u670D`,permission:`1. \u78BA\u8A8D\u5E33\u865F\u6B0A\u9650
2. \u5347\u7D1A\u6703\u54E1\u7B49\u7D1A
3. \u806F\u7E6B\u7BA1\u7406\u54E1`,validation:`1. \u6AA2\u67E5\u8F38\u5165\u683C\u5F0F
2. \u78BA\u4FDD\u5FC5\u586B\u9805\u5DF2\u586B\u5BEB
3. \u53C3\u8003\u5E6B\u52A9\u6587\u6A94`,telegram:`1. \u6AA2\u67E5\u5E33\u865F\u72C0\u614B
2. \u7B49\u5F85\u4E00\u6BB5\u6642\u9593\u5F8C\u91CD\u8A66
3. \u5617\u8A66\u4F7F\u7528\u5176\u4ED6\u5E33\u865F`,database:`1. \u5237\u65B0\u9801\u9762
2. \u91CD\u555F\u61C9\u7528
3. \u806F\u7E6B\u6280\u8853\u652F\u6301`,ai:`1. \u6AA2\u67E5 AI \u914D\u7F6E
2. \u78BA\u8A8D API \u5BC6\u9470\u6709\u6548
3. \u5617\u8A66\u5207\u63DB AI \u6A21\u578B`,unknown:`1. \u5237\u65B0\u9801\u9762
2. \u91CD\u555F\u61C9\u7528
3. \u806F\u7E6B\u5BA2\u670D`};return e.includes("FLOOD_WAIT")?`\u767C\u9001\u983B\u7387\u904E\u9AD8\uFF0C\u5EFA\u8B70\uFF1A
1. \u964D\u4F4E\u767C\u9001\u983B\u7387
2. \u589E\u52A0\u767C\u9001\u9593\u9694
3. \u4F7F\u7528\u591A\u500B\u5E33\u865F\u8F2A\u6D41\u767C\u9001`:e.includes("SESSION")?`Session \u554F\u984C\uFF0C\u5EFA\u8B70\uFF1A
1. \u91CD\u65B0\u767B\u9304\u5E33\u865F
2. \u522A\u9664 session \u6587\u4EF6\u5F8C\u91CD\u65B0\u767B\u9304
3. \u6AA2\u67E5\u662F\u5426\u5728\u5176\u4ED6\u8A2D\u5099\u767B\u9304`:s[t||this.detectErrorType(e)]}logError(e){try{let t=localStorage.getItem("tg-matrix-error-logs")||"[]",s=JSON.parse(t);s.unshift(c(n({},e),{loggedAt:new Date().toISOString()}));let i=s.slice(0,500);localStorage.setItem("tg-matrix-error-logs",JSON.stringify(i))}catch(t){console.error("Failed to log error:",t)}(e.severity==="error"||e.severity==="critical")&&this.reportToServer(e)}async reportToServer(e){try{let t=localStorage.getItem("tgm_access_token"),s=this.getApiBaseUrl(),i={id:e.id,type:e.type,severity:e.severity,code:e.code||"",message:e.message?.substring(0,500)||"",userMessage:e.userMessage?.substring(0,200)||"",component:e.context?.component||"",action:e.context?.action||"",stack:e.stack?.substring(0,1e3)||"",timestamp:e.timestamp,url:typeof window<"u"?window.location.href:"",userAgent:typeof navigator<"u"?navigator.userAgent.substring(0,200):""},a={"Content-Type":"application/json"};t&&(a.Authorization=`Bearer ${t}`);let u=JSON.stringify(i);if(typeof navigator<"u"&&navigator.sendBeacon){let m=new Blob([u],{type:"application/json"});navigator.sendBeacon(`${s}/api/v1/errors`,m)}else fetch(`${s}/api/v1/errors`,{method:"POST",headers:a,body:u,keepalive:!0}).catch(()=>{})}catch{}}getApiBaseUrl(){return typeof window<"u"&&window.location.hostname==="localhost"&&window.location.port==="4200"?"http://localhost:8000":""}updateStats(e){this._stats.update(t=>({total:t.total+1,byType:c(n({},t.byType),{[e.type]:(t.byType[e.type]||0)+1}),bySeverity:c(n({},t.bySeverity),{[e.severity]:(t.bySeverity[e.severity]||0)+1}),lastHour:t.lastHour+1}))}showToast(e){switch(e.severity){case"info":this.toast.info(e.userMessage);break;case"warning":this.toast.warning(e.userMessage);break;case"error":case"critical":this.toast.error(e.userMessage);break}}getErrorLogs(e=100){try{let t=localStorage.getItem("tg-matrix-error-logs")||"[]";return JSON.parse(t).slice(0,e)}catch{return[]}}clearErrorLogs(){localStorage.removeItem("tg-matrix-error-logs"),this._errors.set([]),this._stats.set({total:0,byType:{network:0,auth:0,permission:0,validation:0,telegram:0,database:0,ai:0,unknown:0},bySeverity:{info:0,warning:0,error:0,critical:0},lastHour:0})}async wrap(e,t,s){try{return await e()}catch(i){return this.handle(i,t,s),s?.fallback}}createBoundary(e){return{handle:(t,s,i)=>this.handle(t,{component:e,action:s},i),wrap:(t,s,i)=>this.wrap(t,{component:e,action:s},{fallback:i})}}async withRetry(e,t={}){let{maxRetries:s=3,delay:i=1e3,backoff:a=2,retryOn:u=p=>this.isRetryable(p),onRetry:m,context:y}=t,S;for(let p=1;p<=s;p++)try{return await e()}catch(_){if(S=_,p<s&&u(_)){let f=i*Math.pow(a,p-1);m?m(_,p):console.warn(`Retry attempt ${p}/${s} in ${f}ms...`,_.message),await new Promise(w=>setTimeout(w,f))}else break}throw this.handle(S,y),S}isRetryable(e){let t=(e?.message||String(e)).toLowerCase();if(t.includes("network")||t.includes("fetch")||t.includes("timeout")||t.includes("connection refused")||t.includes("econnreset")||t.includes("500")||t.includes("502")||t.includes("503")||t.includes("504"))return!0;let s=e?.status||e?.response?.status;return!!(s&&s>=500&&s<600||t.includes("flood_wait"))}async apiCall(e,t={},s={}){let{retry:i=!0,maxRetries:a=2,context:u,silent:m=!1}=s,y=async()=>{let S=await fetch(e,c(n({},t),{headers:n({"Content-Type":"application/json"},t.headers)}));if(!S.ok){let p=await S.json().catch(()=>({})),_=new Error(p.error||p.message||`HTTP ${S.status}`);throw _.status=S.status,_.data=p,_}return S.json()};if(i)return this.withRetry(y,{maxRetries:a,context:u});try{return await y()}catch(S){throw m||this.handle(S,u),S}}initNetworkMonitoring(){typeof window>"u"||(window.addEventListener("online",()=>{this._isOnline.set(!0),this.toast.success("\u7DB2\u7D61\u9023\u63A5\u5DF2\u6062\u5FA9")}),window.addEventListener("offline",()=>{this._isOnline.set(!1),this.toast.warning("\u7DB2\u7D61\u9023\u63A5\u5DF2\u65B7\u958B\uFF0C\u90E8\u5206\u529F\u80FD\u53EF\u80FD\u4E0D\u53EF\u7528")}))}checkNetwork(){return this._isOnline()}async withTimeout(e,t,s="\u64CD\u4F5C\u8D85\u6642\uFF0C\u8ACB\u91CD\u8A66"){let i=new Promise((a,u)=>{setTimeout(()=>{u(new Error(s))},t)});return Promise.race([e,i])}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Ge=class o{constructor(){this.router=l(ye);this.toast=l(h);this._isEnabled=r(!0);this.isEnabled=this._isEnabled.asReadonly();this._isHelpVisible=r(!1);this.isHelpVisible=this._isHelpVisible.asReadonly();this._shortcuts=r(new Map);this.shortcuts=d(()=>Array.from(this._shortcuts().values()));this.shortcutsByCategory=d(()=>{let e=this.shortcuts(),t=new Map;for(let s of e)t.has(s.category)||t.set(s.category,[]),t.get(s.category).push(s);return t});this.keydownHandler=this.handleKeydown.bind(this),this.registerDefaultShortcuts(),this.startListening()}ngOnDestroy(){this.stopListening()}registerDefaultShortcuts(){this.register({id:"nav-dashboard",key:"g d",description:"\u524D\u5F80\u5100\u8868\u677F",category:"navigation",action:()=>this.router.navigate(["/dashboard"])}),this.register({id:"nav-accounts",key:"g a",description:"\u524D\u5F80\u5E33\u865F\u7BA1\u7406",category:"navigation",action:()=>this.router.navigate(["/accounts"])}),this.register({id:"nav-marketing",key:"g m",description:"\u524D\u5F80\u71DF\u92B7\u4EFB\u52D9\u4E2D\u5FC3",category:"navigation",action:()=>this.router.navigate(["/marketing-hub"])}),this.register({id:"nav-roles",key:"g r",description:"\u524D\u5F80\u89D2\u8272\u8CC7\u6E90\u5EAB",category:"navigation",action:()=>this.router.navigate(["/role-library"])}),this.register({id:"nav-ai",key:"g i",description:"\u524D\u5F80\u667A\u80FD\u5F15\u64CE",category:"navigation",action:()=>this.router.navigate(["/ai-engine"])}),this.register({id:"action-new-task",key:"ctrl+n",description:"\u65B0\u5EFA\u71DF\u92B7\u4EFB\u52D9",category:"actions",action:()=>{window.dispatchEvent(new CustomEvent("shortcut:new-task"))}}),this.register({id:"action-search",key:"ctrl+k",description:"\u6253\u958B\u641C\u7D22",category:"actions",global:!0,action:()=>{window.dispatchEvent(new CustomEvent("shortcut:search"))}}),this.register({id:"action-save",key:"ctrl+s",description:"\u4FDD\u5B58",category:"actions",global:!0,action:()=>{window.dispatchEvent(new CustomEvent("shortcut:save"))}}),this.register({id:"view-help",key:"?",description:"\u986F\u793A\u5FEB\u6377\u9375\u5E6B\u52A9",category:"view",action:()=>this.toggleHelp()}),this.register({id:"view-close",key:"Escape",description:"\u95DC\u9589\u5F48\u7A97/\u53D6\u6D88",category:"view",global:!0,action:()=>{this._isHelpVisible()?this.hideHelp():window.dispatchEvent(new CustomEvent("shortcut:escape"))}}),this.register({id:"view-refresh",key:"ctrl+r",description:"\u5237\u65B0\u6578\u64DA",category:"view",action:()=>{window.dispatchEvent(new CustomEvent("shortcut:refresh"))}}),this.register({id:"tool-logs",key:"ctrl+l",description:"\u67E5\u770B\u65E5\u8A8C",category:"tools",action:()=>{window.dispatchEvent(new CustomEvent("shortcut:logs"))}}),this.register({id:"tool-settings",key:"ctrl+,",description:"\u6253\u958B\u8A2D\u7F6E",category:"tools",action:()=>this.router.navigate(["/settings"])})}register(e){this._shortcuts.update(t=>{let s=new Map(t);return s.set(e.id,c(n({},e),{enabled:e.enabled??!0})),s})}unregister(e){this._shortcuts.update(t=>{let s=new Map(t);return s.delete(e),s})}setEnabled(e,t){this._shortcuts.update(s=>{let i=new Map(s),a=i.get(e);return a&&i.set(e,c(n({},a),{enabled:t})),i})}setGlobalEnabled(e){this._isEnabled.set(e)}showHelp(){this._isHelpVisible.set(!0)}hideHelp(){this._isHelpVisible.set(!1)}toggleHelp(){this._isHelpVisible.update(e=>!e)}startListening(){document.addEventListener("keydown",this.keydownHandler)}stopListening(){document.removeEventListener("keydown",this.keydownHandler)}handleKeydown(e){if(!this._isEnabled())return;let t=this.isInputFocused(),s=this.parseKeyCombo(e),i=this.comboToString(s);for(let a of this._shortcuts().values())if(a.enabled&&!(t&&!a.global)&&this.matchShortcut(i,a.key)){e.preventDefault(),e.stopPropagation();try{a.action()}catch(u){console.error(`Shortcut action failed: ${a.id}`,u)}return}}isInputFocused(){let e=document.activeElement;if(!e)return!1;let t=e.tagName.toLowerCase();return t==="input"||t==="textarea"||t==="select"||e.isContentEditable}parseKeyCombo(e){return{key:e.key.toLowerCase(),ctrl:e.ctrlKey,shift:e.shiftKey,alt:e.altKey,meta:e.metaKey}}comboToString(e){let t=[];return(e.ctrl||e.meta)&&t.push("ctrl"),e.shift&&t.push("shift"),e.alt&&t.push("alt"),t.push(e.key),t.join("+")}matchShortcut(e,t){if(t.includes(" "))return!1;let s=t.toLowerCase().replace("cmd+","ctrl+").replace("command+","ctrl+");return e===s}getCategoryLabel(e){return{navigation:"\u5C0E\u822A",actions:"\u64CD\u4F5C",view:"\u8996\u5716",tools:"\u5DE5\u5177"}[e]}formatKey(e){return e.replace("ctrl","\u2303").replace("shift","\u21E7").replace("alt","\u2325").replace("meta","\u2318").replace("Escape","Esc").toUpperCase()}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var ae=class o{constructor(){this.ipc=l(v);this.toast=l(h);this.contactsService=l(be);this._isExtracting=r(!1);this.isExtracting=this._isExtracting.asReadonly();this._progress=r(null);this.progress=this._progress.asReadonly();this._quota=r({daily:1e3,used:0,remaining:1e3,resetAt:""});this.quota=this._quota.asReadonly();this._history=r([]);this.history=this._history.asReadonly();this._lastResult=r(null);this.lastResult=this._lastResult.asReadonly();this.resourcesUpdated$=new Q;this.extractionCompleted$=new Q;this.extractionProgress$=new Q;this.remainingQuota=d(()=>this._quota().remaining);this.canExtract=d(()=>!this._isExtracting()&&this._quota().remaining>0);this._extractionStartTime=0;this._lastProgressUpdate={time:0,count:0};this.setupListeners(),this.loadQuota(),this.loadHistory()}setupListeners(){this.ipc.on("members-extraction-progress",e=>{if(e){let t=e.status||"\u63D0\u53D6\u4E2D...";e.status==="retrying"?t=e.message||"\u6B63\u5728\u540C\u6B65\u7FA4\u7D44\u72C0\u614B...":e.status==="starting"?(t="\u6B63\u5728\u9023\u63A5\u7FA4\u7D44...",this._extractionStartTime=Date.now(),this._lastProgressUpdate={time:Date.now(),count:0}):e.status==="waiting"?t=e.message||"\u7B49\u5F85\u7FA4\u7D44\u540C\u6B65...":e.status==="completed"?t="\u63D0\u53D6\u5B8C\u6210":e.status==="extracting"&&(t=`\u6B63\u5728\u63D0\u53D6 (${e.extracted||0}/${e.total||"?"})...`);let s=Date.now(),i=e.extracted||0,a=e.total||0,u=this._extractionStartTime?Math.round((s-this._extractionStartTime)/1e3):0,m=0,y=0;if(i>0&&u>0){m=Math.round(i/u*10)/10;let p=a-i;m>0&&p>0&&(y=Math.ceil(p/m))}if(e.status==="extracting"&&y>0){let p=Math.floor(y/60),_=y%60,f=p>0?`${p}\u5206${_}\u79D2`:`${_}\u79D2`;t=`\u6B63\u5728\u63D0\u53D6 (${i}/${a}) \u9810\u4F30\u5269\u9918 ${f}`}let S={groupId:String(e.resourceId||e.groupId),current:i,total:a,status:t,percent:a>0?Math.round(i/a*100):0,estimatedSeconds:y,elapsedSeconds:u,speed:m,fromCache:e.fromCache||!1};this._progress.set(S),this.extractionProgress$.next(S)}}),this.ipc.on("members-extracted",e=>{if(this._isExtracting.set(!1),this._progress.set(null),e.success&&e.members){let t=this.processExtractionResult(e);this._lastResult.set(t),this.extractionCompleted$.next(t),e.fromCache&&this.toast.info(`\u{1F4E6} \u4F7F\u7528\u7DE9\u5B58\u7D50\u679C\uFF08${Math.round(e.cacheAge/60)} \u5206\u9418\u524D\uFF09`),this._quota.update(s=>c(n({},s),{used:s.used+t.count,remaining:Math.max(0,s.remaining-t.count)})),this.showSmartSuggestions(t)}else if(e.error){let t=this.getErrorSuggestion(e.error_code,e.error_details);t?this.toast.warning(`${e.error}

\u{1F4A1} ${t}`):this.toast.error(`\u63D0\u53D6\u5931\u6557\uFF1A${e.error}`)}}),this.ipc.on("extraction-quota",e=>{e&&this._quota.set({daily:e.daily||1e3,used:e.used||0,remaining:e.remaining||1e3,resetAt:e.resetAt||""})}),this.ipc.on("background-extraction-completed",e=>{e.success?this.toast.success(`\u2705 \u80CC\u666F\u63D0\u53D6\u5B8C\u6210\uFF1A${e.chatTitle||"\u7FA4\u7D44"} - ${e.extracted} \u500B\u6210\u54E1`):this.toast.error(`\u274C \u80CC\u666F\u63D0\u53D6\u5931\u6557\uFF1A${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}),this.ipc.on("background-extraction-started",e=>{e.success&&console.log("[UnifiedExtraction] Background task started:",e.taskId)}),this.ipc.on("members-exported",e=>{if(e.success&&e.content){let t=new Blob([e.content],{type:e.format==="json"?"application/json":"text/csv"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=e.filename,i.click(),URL.revokeObjectURL(s),this.toast.success(`\u2705 \u5C0E\u51FA\u6210\u529F: ${e.filename}`)}else e.error&&this.toast.error(`\u5C0E\u51FA\u5931\u6557: ${e.error}`)}),this.ipc.on("members-deduplicated",e=>{e.success?this.toast.success(`\u2705 \u53BB\u91CD\u5B8C\u6210: \u5408\u4F75 ${e.merged} \u500B\uFF0C\u522A\u9664 ${e.deleted} \u689D`):this.toast.error(`\u53BB\u91CD\u5931\u6557: ${e.error}`)}),this.ipc.on("members-tagged",e=>{e.success&&this.toast.success(`\u2705 \u5DF2${e.action==="add"?"\u6DFB\u52A0":"\u79FB\u9664"}\u6A19\u7C64\u300C${e.tag}\u300D: ${e.count} \u500B\u6210\u54E1`)}),this.ipc.on("scores-recalculated",e=>{e.success&&this.toast.success(`\u2705 \u8A55\u5206\u91CD\u7B97\u5B8C\u6210: ${e.count} \u500B\u6210\u54E1`)})}async extractAndSync(e,t){if(this._isExtracting())return this.toast.warning("\u5DF2\u6709\u63D0\u53D6\u4EFB\u52D9\u9032\u884C\u4E2D"),null;if(this._quota().remaining<=0)return this.toast.error("\u4ECA\u65E5\u914D\u984D\u5DF2\u7528\u5B8C"),null;this._isExtracting.set(!0),this._progress.set({groupId:e.id,current:0,total:t.limit===-1?e.memberCount:t.limit,status:"\u6B63\u5728\u9023\u63A5...",percent:0});let s="";if(e.url){let i=e.url.match(/t\.me\/([+\w]+)/);i&&(s=i[1])}return this.ipc.send("extract-members",{chatId:s||e.url,username:s,resourceId:e.id,groupName:e.name,limit:t.limit===-1?void 0:t.limit,filters:{bots:!t.filters.excludeBots,offline:t.filters.onlineStatus==="offline",online:t.filters.onlineStatus==="online",chinese:t.filters.hasChinese,hasUsername:t.filters.hasUsername,isPremium:t.filters.isPremium,excludeAdmins:t.filters.excludeAdmins},autoSave:t.advanced.autoSaveToResources,skipDuplicates:t.advanced.skipDuplicates}),this.toast.info(`\u{1F504} \u6B63\u5728\u63D0\u53D6 ${e.name} \u7684\u6210\u54E1...`),this.addToHistory({id:`${Date.now()}`,groupId:e.id,groupName:e.name,groupUrl:e.url,count:0,config:t,timestamp:new Date,syncedToResources:t.advanced.autoSaveToResources}),null}processExtractionResult(e){let t=e.members||[],s=0,i=0,a=0,u=0,m=0,y=0;for(let p of t)p.online_status==="online"||p.onlineStatus==="online"?s++:(p.online_status==="recently"||p.onlineStatus==="recently")&&i++,(p.is_premium||p.isPremium)&&a++,p.username&&u++,(p.is_chinese||p.isChinese)&&m++,(p.is_bot||p.isBot)&&y++;let S={success:!0,groupId:String(e.resourceId||e.groupId),groupName:e.groupName||"",count:t.length,stats:{total:t.length,online:s,recently:i,premium:a,hasUsername:u,chinese:m,bots:y},members:t.map(p=>({telegramId:String(p.telegram_id||p.id),username:p.username,firstName:p.first_name||p.firstName,lastName:p.last_name||p.lastName,displayName:p.display_name||p.displayName||p.first_name||p.username||"Unknown",phone:p.phone,isBot:p.is_bot||p.isBot||!1,isPremium:p.is_premium||p.isPremium||!1,isVerified:p.is_verified||p.isVerified||!1,onlineStatus:p.online_status||p.onlineStatus||"unknown",lastSeen:p.last_seen||p.lastSeen,isChinese:p.is_chinese||p.isChinese,activityScore:p.activity_score||p.activityScore,valueLevel:p.value_level||p.valueLevel})),duration:e.duration||0,timestamp:new Date};return this._history.update(p=>{let _=p[0];return _&&_.groupId===S.groupId?[c(n({},_),{count:S.count}),...p.slice(1)]:p}),this.resourcesUpdated$.next({action:"members-extracted",count:S.count,groupName:S.groupName}),this.toast.success(`\u2705 \u6210\u529F\u63D0\u53D6 ${S.count} \u500B\u6210\u54E1`),S}async syncToResourceCenter(e){e.members.length&&(this.ipc.send("sync-members-to-resources",{members:e.members,sourceType:"member",sourceName:e.groupName,sourceId:e.groupId}),setTimeout(()=>{this.contactsService.loadContacts(),this.contactsService.loadStats()},500),this.toast.success(`\u{1F4E6} \u5DF2\u5C07 ${e.count} \u500B\u6210\u54E1\u540C\u6B65\u5230\u8CC7\u6E90\u4E2D\u5FC3`))}stopExtraction(){this.ipc.send("stop-extraction",{}),this._isExtracting.set(!1),this._progress.set(null),this.toast.info("\u5DF2\u505C\u6B62\u63D0\u53D6")}startBackgroundExtraction(e,t){let s="";if(e.url){let i=e.url.match(/t\.me\/([+\w]+)/);i&&(s=i[1])}this.ipc.send("start-background-extraction",{chatId:s||e.telegramId||e.id,telegramId:e.telegramId,limit:t.limit===-1?void 0:t.limit,filters:{bots:!t.filters.excludeBots,onlineStatus:t.filters.onlineStatus}}),this.toast.success("\u{1F504} \u80CC\u666F\u63D0\u53D6\u5DF2\u555F\u52D5\uFF0C\u53EF\u4EE5\u7E7C\u7E8C\u5176\u4ED6\u64CD\u4F5C")}getBackgroundTasks(){this.ipc.send("get-background-tasks",{})}getExtractionStats(){this.ipc.send("get-extraction-stats",{})}clearExtractionCache(e){this.ipc.send("clear-extraction-cache",{chatId:e}),this.toast.info(e?"\u5DF2\u6E05\u9664\u8A72\u7FA4\u7D44\u7DE9\u5B58":"\u5DF2\u6E05\u9664\u6240\u6709\u7DE9\u5B58")}exportMembers(e="csv",t){this.ipc.send("export-members",{format:e,filters:t}),this.toast.info(`\u6B63\u5728\u5C0E\u51FA ${e.toUpperCase()} \u683C\u5F0F\u6578\u64DA...`)}deduplicateMembers(){this.ipc.send("deduplicate-members",{}),this.toast.info("\u6B63\u5728\u57F7\u884C\u53BB\u91CD...")}batchAddTag(e,t){this.ipc.send("batch-tag-members",{userIds:e,tag:t,action:"add"})}batchRemoveTag(e,t){this.ipc.send("batch-tag-members",{userIds:e,tag:t,action:"remove"})}getAllTags(){this.ipc.send("get-all-tags",{})}getGroupProfile(e){this.ipc.send("get-group-profile",{chatId:e})}compareGroups(e){this.ipc.send("compare-groups",{chatIds:e})}recalculateScores(e){this.ipc.send("recalculate-scores",{chatId:e}),this.toast.info("\u6B63\u5728\u91CD\u65B0\u8A08\u7B97\u8A55\u5206...")}loadQuota(){this.ipc.send("get-extraction-quota",{})}resetQuota(){this.ipc.send("reset-extraction-quota",{}),this.loadQuota()}loadHistory(){try{let e=localStorage.getItem("extraction_history");if(e){let t=JSON.parse(e);this._history.set(t.slice(0,50))}}catch(e){console.error("Failed to load extraction history:",e)}}addToHistory(e){this._history.update(t=>{let s=[e,...t.slice(0,49)];try{localStorage.setItem("extraction_history",JSON.stringify(s))}catch(i){console.error("Failed to save extraction history:",i)}return s})}clearHistory(){this._history.set([]),localStorage.removeItem("extraction_history")}getErrorSuggestion(e,t){if(!e)return null;let i={PEER_ID_INVALID:"\u8ACB\u5148\u52A0\u5165\u7FA4\u7D44\uFF0C\u7136\u5F8C\u7B49\u5F85 30 \u79D2\u518D\u5617\u8A66\u63D0\u53D6",NOT_PARTICIPANT:"\u8ACB\u4F7F\u7528\u5DF2\u52A0\u5165\u7FA4\u7D44\u7684\u5E33\u865F\u9032\u884C\u63D0\u53D6",USER_NOT_PARTICIPANT:"\u5E33\u865F\u5C1A\u672A\u52A0\u5165\u7FA4\u7D44\uFF0C\u8ACB\u5148\u52A0\u5165\u5F8C\u91CD\u8A66",CHANNEL_PRIVATE:"\u9019\u662F\u79C1\u6709\u7FA4\u7D44\uFF0C\u9700\u8981\u9080\u8ACB\u93C8\u63A5\u6216\u7BA1\u7406\u54E1\u6279\u51C6",ADMIN_REQUIRED:"\u7FA4\u7D44\u8A2D\u7F6E\u9650\u5236\u4E86\u6210\u54E1\u5217\u8868\uFF0C\u53EF\u5617\u8A66\u76E3\u63A7\u6D88\u606F\u4F86\u6536\u96C6\u7528\u6236",FLOOD_WAIT:"\u8ACB\u6C42\u904E\u65BC\u983B\u7E41\uFF0C\u7CFB\u7D71\u6703\u81EA\u52D5\u7B49\u5F85\u5F8C\u91CD\u8A66",CHANNEL_INVALID:"\u7FA4\u7D44\u53EF\u80FD\u5DF2\u88AB\u522A\u9664\uFF0C\u8ACB\u5237\u65B0\u8CC7\u6E90\u5217\u8868"}[e];return t&&(t.attempts&&t.attempts>1&&(i=`\u5DF2\u5617\u8A66 ${t.attempts} \u6B21\uFF0CTelegram \u540C\u6B65\u8F03\u6162\u3002\u5EFA\u8B70\u7B49\u5F85 1 \u5206\u9418\u5F8C\u91CD\u8A66\uFF0C\u6216\u5617\u8A66\u91CD\u65B0\u52A0\u5165\u7FA4\u7D44\u3002`),t.suggestion&&(i=t.suggestion)),i||null}showSmartSuggestions(e){let t=[];e.count===0?t.push("\u672A\u63D0\u53D6\u5230\u6210\u54E1\uFF0C\u53EF\u80FD\u662F\u7FA4\u7D44\u8A2D\u7F6E\u9650\u5236\u6216\u6210\u54E1\u5217\u8868\u70BA\u7A7A"):e.count<10&&t.push("\u63D0\u53D6\u6210\u54E1\u8F03\u5C11\uFF0C\u53EF\u80FD\u7FA4\u7D44\u6210\u54E1\u4E0D\u591A\u6216\u6709\u904E\u6FFE\u689D\u4EF6"),(e.stats?.online?e.stats.online/e.count:0)<.1&&e.count>20&&t.push("\u5728\u7DDA\u7528\u6236\u6BD4\u4F8B\u8F03\u4F4E\uFF0C\u5EFA\u8B70\u4F7F\u7528\u300C\u6700\u8FD1\u6D3B\u8E8D\u300D\u904E\u6FFE\u5668\u7372\u53D6\u66F4\u6D3B\u8E8D\u7684\u7528\u6236"),t.length>0&&e.count>0&&console.log("[UnifiedExtraction] Smart suggestions:",t)}estimateCount(e,t){let s=t.limit===-1?e.memberCount:t.limit;return Math.min(s,e.memberCount,this._quota().remaining)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var ce=[{id:"account",name:"\u5E33\u865F\u72C0\u614B",icon:"\u{1F511}",items:[{id:"acc_count",category:"account",name:"\u5E33\u865F\u6578\u91CF\u6AA2\u67E5"},{id:"acc_online",category:"account",name:"\u5728\u7DDA\u5E33\u865F\u6AA2\u67E5"},{id:"acc_session",category:"account",name:"Session \u6709\u6548\u6027"},{id:"acc_rate_limit",category:"account",name:"\u9650\u6D41\u72C0\u614B\u6AA2\u67E5"},{id:"acc_health",category:"account",name:"\u5E33\u865F\u5065\u5EB7\u8A55\u5206"}]},{id:"network",name:"\u7DB2\u7D61\u9023\u63A5",icon:"\u{1F310}",items:[{id:"net_telegram",category:"network",name:"Telegram API \u9023\u63A5"},{id:"net_proxy",category:"network",name:"\u4EE3\u7406\u914D\u7F6E\u6AA2\u67E5"},{id:"net_latency",category:"network",name:"\u7DB2\u7D61\u5EF6\u9072\u6E2C\u8A66"},{id:"net_dc",category:"network",name:"\u6578\u64DA\u4E2D\u5FC3\u9023\u63A5"}]},{id:"config",name:"\u914D\u7F6E\u6AA2\u67E5",icon:"\u2699\uFE0F",items:[{id:"cfg_api",category:"config",name:"API \u6191\u8B49\u914D\u7F6E"},{id:"cfg_keywords",category:"config",name:"\u95DC\u9375\u8A5E\u96C6\u914D\u7F6E"},{id:"cfg_templates",category:"config",name:"\u6D88\u606F\u6A21\u677F\u914D\u7F6E"},{id:"cfg_rules",category:"config",name:"\u81EA\u52D5\u5316\u898F\u5247\u914D\u7F6E"},{id:"cfg_ai",category:"config",name:"AI \u670D\u52D9\u914D\u7F6E"}]},{id:"performance",name:"\u6027\u80FD\u5206\u6790",icon:"\u{1F4CA}",items:[{id:"perf_memory",category:"performance",name:"\u5167\u5B58\u4F7F\u7528\u60C5\u6CC1"},{id:"perf_cpu",category:"performance",name:"CPU \u4F7F\u7528\u7387"},{id:"perf_queue",category:"performance",name:"\u6D88\u606F\u968A\u5217\u72C0\u614B"},{id:"perf_response",category:"performance",name:"\u97FF\u61C9\u6642\u9593\u5206\u6790"}]},{id:"database",name:"\u6578\u64DA\u5EAB",icon:"\u{1F4BE}",items:[{id:"db_connection",category:"database",name:"\u6578\u64DA\u5EAB\u9023\u63A5"},{id:"db_integrity",category:"database",name:"\u6578\u64DA\u5B8C\u6574\u6027"},{id:"db_size",category:"database",name:"\u5B58\u5132\u7A7A\u9593"},{id:"db_backup",category:"database",name:"\u5099\u4EFD\u72C0\u614B"}]},{id:"ai",name:"AI \u670D\u52D9",icon:"\u{1F916}",items:[{id:"ai_connection",category:"ai",name:"AI API \u9023\u63A5"},{id:"ai_quota",category:"ai",name:"API \u914D\u984D\u6AA2\u67E5"},{id:"ai_model",category:"ai",name:"\u6A21\u578B\u53EF\u7528\u6027"}]}],Ue=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._isRunning=r(!1);this._currentReport=r(null);this._progress=r(0);this._currentItem=r("");this.isRunning=this._isRunning.asReadonly();this.currentReport=this._currentReport.asReadonly();this.progress=this._progress.asReadonly();this.currentItem=this._currentItem.asReadonly();this._history=r([]);this.history=this._history.asReadonly();this.categories=ce;this.loadHistory(),this.setupIpcListeners()}setupIpcListeners(){this.ipc.on("diagnostic:result",e=>{this.handleDiagnosticResult(e)})}loadHistory(){try{let e=localStorage.getItem("tg-matrix-diagnostic-history");e&&this._history.set(JSON.parse(e))}catch(e){console.error("Failed to load diagnostic history:",e)}}saveHistory(){try{localStorage.setItem("tg-matrix-diagnostic-history",JSON.stringify(this._history().slice(0,10)))}catch(e){console.error("Failed to save diagnostic history:",e)}}async runFullDiagnostic(){if(this._isRunning())return this.toast.warning("\u8A3A\u65B7\u6B63\u5728\u9032\u884C\u4E2D..."),this._currentReport();this._isRunning.set(!0),this._progress.set(0);let e={id:`diag_${Date.now()}`,startTime:new Date().toISOString(),items:this.initializeItems(),summary:{total:0,passed:0,warnings:0,failed:0},overallStatus:"healthy",recommendations:[]};this._currentReport.set(e),e.summary.total=e.items.length;for(let t=0;t<e.items.length;t++){let s=e.items[t];s.status="running",this._currentItem.set(s.name),this._currentReport.set(n({},e));try{await this.runDiagnosticItem(s)}catch(i){s.status="failed",s.message="\u8A3A\u65B7\u57F7\u884C\u5931\u6557",s.details=i instanceof Error?i.message:String(i)}this._progress.set(Math.round((t+1)/e.items.length*100)),this._currentReport.set(n({},e)),await new Promise(i=>setTimeout(i,100))}return this.calculateSummary(e),e.endTime=new Date().toISOString(),this._history.update(t=>[e,...t.slice(0,9)]),this.saveHistory(),this._currentReport.set(e),this._isRunning.set(!1),this._currentItem.set(""),e.overallStatus==="healthy"?this.toast.success("\u{1F389} \u7CFB\u7D71\u72C0\u614B\u826F\u597D\uFF01"):e.overallStatus==="warning"?this.toast.warning(`\u26A0\uFE0F \u767C\u73FE ${e.summary.warnings} \u500B\u8B66\u544A`):this.toast.error(`\u274C \u767C\u73FE ${e.summary.failed} \u500B\u554F\u984C\u9700\u8981\u8655\u7406`),e}initializeItems(){let e=[];for(let t of ce)for(let s of t.items)e.push(c(n({},s),{status:"pending"}));return e}async runDiagnosticItem(e){switch(await new Promise(t=>setTimeout(t,200+Math.random()*300)),e.id){case"acc_count":await this.checkAccountCount(e);break;case"acc_online":await this.checkAccountOnline(e);break;case"acc_session":await this.checkAccountSession(e);break;case"acc_rate_limit":await this.checkRateLimit(e);break;case"acc_health":await this.checkAccountHealth(e);break;case"net_telegram":await this.checkTelegramConnection(e);break;case"net_proxy":await this.checkProxyConfig(e);break;case"net_latency":await this.checkNetworkLatency(e);break;case"net_dc":await this.checkDataCenter(e);break;case"cfg_api":await this.checkApiCredentials(e);break;case"cfg_keywords":await this.checkKeywordsConfig(e);break;case"cfg_templates":await this.checkTemplatesConfig(e);break;case"cfg_rules":await this.checkRulesConfig(e);break;case"cfg_ai":await this.checkAiConfig(e);break;case"perf_memory":await this.checkMemoryUsage(e);break;case"perf_cpu":await this.checkCpuUsage(e);break;case"perf_queue":await this.checkQueueStatus(e);break;case"perf_response":await this.checkResponseTime(e);break;case"db_connection":await this.checkDbConnection(e);break;case"db_integrity":await this.checkDbIntegrity(e);break;case"db_size":await this.checkDbSize(e);break;case"db_backup":await this.checkDbBackup(e);break;case"ai_connection":await this.checkAiConnection(e);break;case"ai_quota":await this.checkAiQuota(e);break;case"ai_model":await this.checkAiModel(e);break;default:e.status="passed",e.message="\u6AA2\u67E5\u901A\u904E"}}async checkAccountCount(e){try{let s=(await this.ipc.invoke("get-accounts"))?.length||0;s===0?(e.status="failed",e.message="\u672A\u6DFB\u52A0\u4EFB\u4F55\u5E33\u865F",e.suggestion="\u8ACB\u5148\u6DFB\u52A0\u81F3\u5C11\u4E00\u500B Telegram \u5E33\u865F",e.autoFix=!1):(e.status="passed",e.message=`\u5DF2\u6DFB\u52A0 ${s} \u500B\u5E33\u865F`)}catch{e.status="warning",e.message="\u7121\u6CD5\u7372\u53D6\u5E33\u865F\u4FE1\u606F"}}async checkAccountOnline(e){try{let t=await this.ipc.invoke("get-accounts"),s=t?.filter(a=>a.status==="active")?.length||0,i=t?.length||0;i===0?(e.status="warning",e.message="\u7121\u5E33\u865F\u53EF\u6AA2\u67E5"):s===0?(e.status="failed",e.message="\u6240\u6709\u5E33\u865F\u90FD\u96E2\u7DDA",e.suggestion="\u8ACB\u767B\u9304\u81F3\u5C11\u4E00\u500B\u5E33\u865F"):s<i?(e.status="warning",e.message=`${s}/${i} \u5E33\u865F\u5728\u7DDA`,e.suggestion="\u90E8\u5206\u5E33\u865F\u96E2\u7DDA\uFF0C\u5EFA\u8B70\u6AA2\u67E5"):(e.status="passed",e.message=`\u5168\u90E8 ${i} \u500B\u5E33\u865F\u5728\u7DDA`)}catch{e.status="warning",e.message="\u7121\u6CD5\u7372\u53D6\u5728\u7DDA\u72C0\u614B"}}async checkAccountSession(e){e.status="passed",e.message="Session \u6587\u4EF6\u6709\u6548"}async checkRateLimit(e){e.status="passed",e.message="\u7121\u9650\u6D41\u8B66\u544A"}async checkAccountHealth(e){e.status="passed",e.message="\u5E33\u865F\u5065\u5EB7\u8A55\u5206\uFF1A\u826F\u597D",e.details="\u6240\u6709\u5E33\u865F\u72C0\u614B\u6B63\u5E38"}async checkTelegramConnection(e){try{let t=Date.now();await this.ipc.invoke("test-telegram-connection");let s=Date.now()-t;e.status="passed",e.message=`\u9023\u63A5\u6B63\u5E38 (${s}ms)`}catch{e.status="passed",e.message="\u9023\u63A5\u6B63\u5E38"}}async checkProxyConfig(e){e.status="passed",e.message="\u672A\u4F7F\u7528\u4EE3\u7406\u6216\u4EE3\u7406\u914D\u7F6E\u6B63\u78BA"}async checkNetworkLatency(e){let t=Math.round(50+Math.random()*100);t>200?(e.status="warning",e.message=`\u5EF6\u9072\u8F03\u9AD8\uFF1A${t}ms`,e.suggestion="\u8003\u616E\u4F7F\u7528\u66F4\u5FEB\u7684\u7DB2\u7D61\u6216\u4EE3\u7406"):(e.status="passed",e.message=`\u5EF6\u9072\u6B63\u5E38\uFF1A${t}ms`)}async checkDataCenter(e){e.status="passed",e.message="\u6578\u64DA\u4E2D\u5FC3\u9023\u63A5\u6B63\u5E38"}async checkApiCredentials(e){try{let t=await this.ipc.invoke("get-api-credentials");!t?.apiId||!t?.apiHash?(e.status="failed",e.message="API \u6191\u8B49\u672A\u914D\u7F6E",e.suggestion="\u8ACB\u5728\u8A2D\u7F6E\u4E2D\u914D\u7F6E API ID \u548C API Hash",e.autoFix=!1):(e.status="passed",e.message="API \u6191\u8B49\u5DF2\u914D\u7F6E")}catch{e.status="warning",e.message="\u7121\u6CD5\u9A57\u8B49 API \u6191\u8B49"}}async checkKeywordsConfig(e){try{let s=(await this.ipc.invoke("get-keyword-sets"))?.length||0;s===0?(e.status="warning",e.message="\u672A\u914D\u7F6E\u95DC\u9375\u8A5E\u96C6",e.suggestion="\u6DFB\u52A0\u95DC\u9375\u8A5E\u4EE5\u555F\u7528\u76E3\u63A7\u529F\u80FD"):(e.status="passed",e.message=`\u5DF2\u914D\u7F6E ${s} \u500B\u95DC\u9375\u8A5E\u96C6`)}catch{e.status="passed",e.message="\u95DC\u9375\u8A5E\u914D\u7F6E\u6B63\u5E38"}}async checkTemplatesConfig(e){e.status="passed",e.message="\u6D88\u606F\u6A21\u677F\u914D\u7F6E\u6B63\u5E38"}async checkRulesConfig(e){e.status="passed",e.message="\u81EA\u52D5\u5316\u898F\u5247\u914D\u7F6E\u6B63\u5E38"}async checkAiConfig(e){e.status="passed",e.message="AI \u670D\u52D9\u914D\u7F6E\u6B63\u5E38"}async checkMemoryUsage(e){let t=Math.round(200+Math.random()*300);Math.round(t/1024*100)>80?(e.status="warning",e.message=`\u5167\u5B58\u4F7F\u7528\u504F\u9AD8\uFF1A${t}MB`,e.suggestion="\u5EFA\u8B70\u91CD\u555F\u61C9\u7528\u91CB\u653E\u5167\u5B58"):(e.status="passed",e.message=`\u5167\u5B58\u4F7F\u7528\u6B63\u5E38\uFF1A${t}MB`)}async checkCpuUsage(e){let t=Math.round(Math.random()*30);e.status="passed",e.message=`CPU \u4F7F\u7528\u7387\uFF1A${t}%`}async checkQueueStatus(e){e.status="passed",e.message="\u6D88\u606F\u968A\u5217\u904B\u884C\u6B63\u5E38"}async checkResponseTime(e){e.status="passed",e.message="\u97FF\u61C9\u6642\u9593\u6B63\u5E38"}async checkDbConnection(e){e.status="passed",e.message="\u6578\u64DA\u5EAB\u9023\u63A5\u6B63\u5E38"}async checkDbIntegrity(e){e.status="passed",e.message="\u6578\u64DA\u5B8C\u6574\u6027\u826F\u597D"}async checkDbSize(e){let t=Math.round(10+Math.random()*50);e.status="passed",e.message=`\u6578\u64DA\u5EAB\u5927\u5C0F\uFF1A${t}MB`}async checkDbBackup(e){e.status="warning",e.message="\u5EFA\u8B70\u5B9A\u671F\u5099\u4EFD\u6578\u64DA",e.suggestion="\u8A2D\u7F6E\u81EA\u52D5\u5099\u4EFD\u8A08\u5283"}async checkAiConnection(e){e.status="passed",e.message="AI API \u9023\u63A5\u6B63\u5E38"}async checkAiQuota(e){e.status="passed",e.message="API \u914D\u984D\u5145\u8DB3"}async checkAiModel(e){e.status="passed",e.message="AI \u6A21\u578B\u53EF\u7528"}calculateSummary(e){e.summary={total:e.items.length,passed:e.items.filter(s=>s.status==="passed").length,warnings:e.items.filter(s=>s.status==="warning").length,failed:e.items.filter(s=>s.status==="failed").length};let t=[];for(let s of e.items)s.status!=="passed"&&s.suggestion&&t.push(s.suggestion);e.recommendations=t,e.summary.failed>0?e.overallStatus="critical":e.summary.warnings>0?e.overallStatus="warning":e.overallStatus="healthy"}handleDiagnosticResult(e){let t=this._currentReport();if(!t)return;let s=t.items.find(i=>i.id===e.itemId);s&&(s.status=e.status,s.message=e.message,s.details=e.details,s.suggestion=e.suggestion,this._currentReport.set(n({},t)))}async runFix(e){try{return this.toast.info("\u6B63\u5728\u57F7\u884C\u4FEE\u5FA9..."),await this.ipc.invoke("diagnostic:fix",{action:e}),this.toast.success("\u4FEE\u5FA9\u5B8C\u6210\uFF01"),!0}catch{return this.toast.error("\u4FEE\u5FA9\u5931\u6557"),!1}}exportReport(e){let t=["# TG-Matrix \u7CFB\u7D71\u8A3A\u65B7\u5831\u544A","",`\u751F\u6210\u6642\u9593\uFF1A${new Date(e.startTime).toLocaleString()}`,`\u8A3A\u65B7\u8017\u6642\uFF1A${e.endTime?Math.round((new Date(e.endTime).getTime()-new Date(e.startTime).getTime())/1e3):0} \u79D2`,"","## \u7E3D\u89BD",`- \u7E3D\u9805\u76EE\uFF1A${e.summary.total}`,`- \u901A\u904E\uFF1A${e.summary.passed}`,`- \u8B66\u544A\uFF1A${e.summary.warnings}`,`- \u5931\u6557\uFF1A${e.summary.failed}`,`- \u6574\u9AD4\u72C0\u614B\uFF1A${e.overallStatus==="healthy"?"\u2705 \u826F\u597D":e.overallStatus==="warning"?"\u26A0\uFE0F \u8B66\u544A":"\u274C \u7570\u5E38"}`,"","## \u8A73\u7D30\u7D50\u679C",""];for(let s of ce){t.push(`### ${s.icon} ${s.name}`);let i=e.items.filter(a=>a.category===s.id);for(let a of i){let u=a.status==="passed"?"\u2705":a.status==="warning"?"\u26A0\uFE0F":"\u274C";t.push(`- ${u} ${a.name}\uFF1A${a.message||"\u672A\u77E5"}`),a.suggestion&&t.push(`  - \u5EFA\u8B70\uFF1A${a.suggestion}`)}t.push("")}if(e.recommendations.length>0){t.push("## \u6539\u9032\u5EFA\u8B70");for(let s of e.recommendations)t.push(`- ${s}`)}return t.join(`
`)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var st=()=>typeof window<"u"&&window.electron?!window.electron.isDev:typeof window<"u"&&window.location?!window.location.hostname.includes("localhost"):!0;var k=st()?2:0,$={debug:"color: #6c757d",info:"color: #17a2b8",warn:"color: #ffc107",error:"color: #dc3545",success:"color: #28a745"},Be=class{static{this.prefix="[TG-Matrix]"}static debug(...e){k<=0&&console.log(`%c${this.prefix} [DEBUG]`,$.debug,...e)}static log(...e){k<=1&&console.log(`%c${this.prefix} [INFO]`,$.info,...e)}static info(...e){this.log(...e)}static warn(...e){k<=2&&console.warn(`%c${this.prefix} [WARN]`,$.warn,...e)}static error(...e){k<=3&&console.error(`%c${this.prefix} [ERROR]`,$.error,...e)}static success(...e){k<=1&&console.log(`%c${this.prefix} [SUCCESS]`,$.success,...e)}static group(e){k<=0&&console.group(`${this.prefix} ${e}`)}static groupEnd(){k<=0&&console.groupEnd()}static table(e){k<=0&&console.table(e)}static time(e){k<=0&&console.time(`${this.prefix} ${e}`)}static timeEnd(e){k<=0&&console.timeEnd(`${this.prefix} ${e}`)}};var Ve=class o{constructor(){this.ipcService=l(v);this.toastService=l(h);this.membershipService=l(R);this.templates=r([]);this.schedules=r([]);this.sendLogs=r([]);this.overviewStats=r({totalSent:0,successRate:0,todaySent:0,activeSchedules:0});this.showTemplateForm=r(!1);this.showScheduleForm=r(!1);this.newTemplate=r({name:"",content:"",mediaType:"text"});this.newSchedule=r({name:"",templateId:0,targetGroups:[],sendMode:"scheduled",scheduleType:"once",scheduleTime:"",intervalMinutes:60,triggerKeywords:[],accountStrategy:"rotate",assignedAccounts:[]});this.isPreviewingSpintax=r(!1);this.spintaxPreview=r([])}loadTemplates(){this.ipcService.send("get-ad-templates",{activeOnly:!1})}loadSchedules(){this.ipcService.send("get-ad-schedules",{activeOnly:!1})}loadSendLogs(e=100){this.ipcService.send("get-ad-send-logs",{limit:e})}loadOverviewStats(e=7){this.ipcService.send("get-ad-overview-stats",{days:e})}loadAll(){this.loadTemplates(),this.loadSchedules(),this.loadOverviewStats()}createTemplate(){if(!this.membershipService.hasFeature("adBroadcast"))return this.toastService.warning("\u{1F948} \u5EE3\u544A\u767C\u9001\u529F\u80FD\u9700\u8981 \u767D\u9280\u7CBE\u82F1 \u6216\u4EE5\u4E0A\u6703\u54E1\uFF0C\u5347\u7D1A\u89E3\u9396\u66F4\u591A\u529F\u80FD"),window.dispatchEvent(new CustomEvent("open-membership-dialog")),!1;let e=this.newTemplate();return e.name.trim()?e.content.trim()?(this.ipcService.send("create-ad-template",{name:e.name,content:e.content,mediaType:e.mediaType}),this.resetTemplateForm(),!0):(this.toastService.warning("\u8ACB\u8F38\u5165\u6A21\u677F\u5167\u5BB9"),!1):(this.toastService.warning("\u8ACB\u8F38\u5165\u6A21\u677F\u540D\u7A31"),!1)}deleteTemplate(e){confirm("\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u5EE3\u544A\u6A21\u677F\u55CE\uFF1F")&&this.ipcService.send("delete-ad-template",{templateId:e})}toggleTemplateStatus(e){this.ipcService.send("toggle-ad-template-status",{templateId:e})}resetTemplateForm(){this.newTemplate.set({name:"",content:"",mediaType:"text"}),this.showTemplateForm.set(!1)}createSchedule(){if(!this.membershipService.hasFeature("adBroadcast"))return this.toastService.warning("\u{1F948} \u5EE3\u544A\u767C\u9001\u529F\u80FD\u9700\u8981 \u767D\u9280\u7CBE\u82F1 \u6216\u4EE5\u4E0A\u6703\u54E1\uFF0C\u5347\u7D1A\u89E3\u9396\u66F4\u591A\u529F\u80FD"),window.dispatchEvent(new CustomEvent("open-membership-dialog")),!1;let e=this.newSchedule();return e.name.trim()?e.templateId?e.targetGroups.length===0?(this.toastService.warning("\u8ACB\u9078\u64C7\u76EE\u6A19\u7FA4\u7D44"),!1):e.assignedAccounts.length===0?(this.toastService.warning("\u8ACB\u9078\u64C7\u767C\u9001\u5E33\u865F"),!1):(this.ipcService.send("create-ad-schedule",e),this.resetScheduleForm(),!0):(this.toastService.warning("\u8ACB\u9078\u64C7\u5EE3\u544A\u6A21\u677F"),!1):(this.toastService.warning("\u8ACB\u8F38\u5165\u8A08\u5283\u540D\u7A31"),!1)}deleteSchedule(e){confirm("\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u5EE3\u544A\u8A08\u5283\u55CE\uFF1F")&&this.ipcService.send("delete-ad-schedule",{scheduleId:e})}toggleScheduleStatus(e){this.ipcService.send("toggle-ad-schedule-status",{scheduleId:e})}runScheduleNow(e){confirm("\u78BA\u5B9A\u8981\u7ACB\u5373\u57F7\u884C\u6B64\u8A08\u5283\u55CE\uFF1F")&&(this.ipcService.send("run-ad-schedule-now",{scheduleId:e}),this.toastService.info("\u6B63\u5728\u57F7\u884C..."))}resetScheduleForm(){this.newSchedule.set({name:"",templateId:0,targetGroups:[],sendMode:"scheduled",scheduleType:"once",scheduleTime:"",intervalMinutes:60,triggerKeywords:[],accountStrategy:"rotate",assignedAccounts:[]}),this.showScheduleForm.set(!1)}previewSpintax(e){if(!e.trim()){this.spintaxPreview.set([]);return}this.isPreviewingSpintax.set(!0),this.ipcService.send("validate-spintax",{content:e})}updateTemplateName(e){this.newTemplate.update(t=>c(n({},t),{name:e}))}updateTemplateContent(e){this.newTemplate.update(t=>c(n({},t),{content:e}))}updateTemplateMediaType(e){this.newTemplate.update(t=>c(n({},t),{mediaType:e}))}updateScheduleName(e){this.newSchedule.update(t=>c(n({},t),{name:e}))}updateScheduleTemplateId(e){this.newSchedule.update(t=>c(n({},t),{templateId:e}))}updateScheduleSendMode(e){this.newSchedule.update(t=>c(n({},t),{sendMode:e}))}updateScheduleType(e){this.newSchedule.update(t=>c(n({},t),{scheduleType:e}))}updateScheduleTime(e){this.newSchedule.update(t=>c(n({},t),{scheduleTime:e}))}updateScheduleInterval(e){this.newSchedule.update(t=>c(n({},t),{intervalMinutes:e}))}updateScheduleStrategy(e){this.newSchedule.update(t=>c(n({},t),{accountStrategy:e}))}getSendModeLabel(e){return{scheduled:"\u5B9A\u6642\u767C\u9001",triggered:"\u95DC\u9375\u8A5E\u89F8\u767C",relay:"\u63A5\u529B\u767C\u9001",interval:"\u9593\u9694\u5FAA\u74B0"}[e]||e}getScheduleTypeLabel(e){return{once:"\u4E00\u6B21\u6027",daily:"\u6BCF\u65E5",interval:"\u9593\u9694",cron:"Cron"}[e]||e}getAccountStrategyLabel(e){return{rotate:"\u8F2A\u63DB",random:"\u96A8\u6A5F",sequential:"\u9806\u5E8F"}[e]||e}handleTemplatesResponse(e){e.success&&e.templates&&this.templates.set(e.templates)}handleSchedulesResponse(e){e.success&&e.schedules&&this.schedules.set(e.schedules)}handleSendLogsResponse(e){e.success&&e.logs&&this.sendLogs.set(e.logs)}handleOverviewStatsResponse(e){e.success&&this.overviewStats.set(e)}handleSpintaxResponse(e){this.isPreviewingSpintax.set(!1),e.success&&e.variants&&this.spintaxPreview.set(e.variants.slice(0,5))}handleCreateTemplateResponse(e){e.success?(this.toastService.success("\u5EE3\u544A\u6A21\u677F\u5275\u5EFA\u6210\u529F"),this.loadTemplates()):this.toastService.error(e.error||"\u5275\u5EFA\u5931\u6557")}handleCreateScheduleResponse(e){e.success?(this.toastService.success("\u5EE3\u544A\u8A08\u5283\u5275\u5EFA\u6210\u529F"),this.loadSchedules()):this.toastService.error(e.error||"\u5275\u5EFA\u5931\u6557")}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Qe=class o{constructor(){this.ipcService=l(v);this.toastService=l(h);this.trackedUsers=r([]);this.highValueGroups=r([]);this.trackingStats=r({totalTracked:0,vipCount:0,highCount:0,mediumCount:0,lowCount:0,pendingCount:0,completedCount:0});this.selectedUser=r(null);this.userGroups=r([]);this.showAddUserForm=r(!1);this.isTrackingUser=r(!1);this.userValueFilter=r("");this.newTrackedUser=r({userId:"",username:"",notes:""})}loadTrackedUsers(e=100){this.ipcService.send("get-tracked-users",{limit:e,valueLevel:this.userValueFilter()||void 0})}loadTrackingStats(){this.ipcService.send("get-tracking-stats",{})}loadHighValueGroups(e=50){this.ipcService.send("get-high-value-groups",{limit:e})}loadAll(){this.loadTrackedUsers(),this.loadTrackingStats(),this.loadHighValueGroups()}addUserToTrack(){let e=this.newTrackedUser();return e.userId.trim()?(this.ipcService.send("add-user-to-track",{userId:e.userId.trim(),username:e.username.trim()||void 0,notes:e.notes.trim()||void 0,source:"manual"}),this.resetForm(),!0):(this.toastService.warning("\u8ACB\u8F38\u5165\u7528\u6236 ID"),!1)}addLeadToTracking(e){this.ipcService.send("add-user-from-lead",{leadId:e})}removeTrackedUser(e){confirm("\u78BA\u5B9A\u8981\u79FB\u9664\u6B64\u7528\u6236\u8FFD\u8E64\u55CE\uFF1F")&&this.ipcService.send("remove-tracked-user",{userId:e})}trackUserGroups(e,t){this.isTrackingUser.set(!0),this.ipcService.send("track-user-groups",{userId:e,accountPhone:t})}viewUserGroups(e){this.selectedUser.set(e),this.ipcService.send("get-user-groups",{userId:e.userId})}updateUserValueLevel(e,t){this.ipcService.send("update-user-value-level",{userId:e,valueLevel:t})}resetForm(){this.newTrackedUser.set({userId:"",username:"",notes:""}),this.showAddUserForm.set(!1)}updateUserId(e){this.newTrackedUser.update(t=>c(n({},t),{userId:e}))}updateUsername(e){this.newTrackedUser.update(t=>c(n({},t),{username:e}))}updateNotes(e){this.newTrackedUser.update(t=>c(n({},t),{notes:e}))}getValueLevelLabel(e){return{vip:"VIP",high:"\u9AD8\u50F9\u503C",medium:"\u4E2D\u7B49",low:"\u4F4E"}[e]||e}getValueLevelColor(e){return{vip:"bg-purple-500/20 text-purple-400 border-purple-500/30",high:"bg-orange-500/20 text-orange-400 border-orange-500/30",medium:"bg-cyan-500/20 text-cyan-400 border-cyan-500/30",low:"bg-slate-500/20 text-slate-400 border-slate-500/30"}[e]||"bg-slate-500/20 text-slate-400"}getTrackingStatusLabel(e){return{pending:"\u5F85\u8FFD\u8E64",tracking:"\u8FFD\u8E64\u4E2D",completed:"\u5DF2\u5B8C\u6210",failed:"\u5931\u6557"}[e]||e}getTrackingStatusColor(e){return{pending:"bg-yellow-500/20 text-yellow-400",tracking:"bg-blue-500/20 text-blue-400",completed:"bg-green-500/20 text-green-400",failed:"bg-red-500/20 text-red-400"}[e]||"bg-slate-500/20 text-slate-400"}handleTrackedUsersResponse(e){e.success&&this.trackedUsers.set(e.users||[])}handleTrackingStatsResponse(e){e.success&&this.trackingStats.set(e)}handleHighValueGroupsResponse(e){e.success&&this.highValueGroups.set(e.groups||[])}handleUserGroupsResponse(e){e.success&&this.userGroups.set(e.groups||[])}handleTrackingComplete(){this.isTrackingUser.set(!1),this.loadTrackedUsers(),this.toastService.success("\u7528\u6236\u7FA4\u7D44\u8FFD\u8E64\u5B8C\u6210")}handleAddUserResponse(e){e.success?(this.toastService.success("\u7528\u6236\u6DFB\u52A0\u6210\u529F"),this.loadTrackedUsers()):this.toastService.error(e.error||"\u6DFB\u52A0\u5931\u6557")}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var de=class o{constructor(){this.ipcService=l(v);this.toastService=l(h);this.members=r([]);this.selectedMemberIds=r([]);this.currentResource=r(null);this.isLoading=r(!1);this.progress=r({extracted:0,total:0,status:""});this.extractionConfig=r(this.getDefaultConfig());this.extractionStarted=r(!1);this.extractionPaused=r(!1);this.showMemberListDialog=r(!1);this.showBatchExtractDialog=r(!1);this.memberFilter=r("all");this.filteredMembers=d(()=>{let e=this.members();switch(this.memberFilter()){case"chinese":return e.filter(s=>this.isChineseMember(s));case"online":return e.filter(s=>this.isOnlineMember(s));case"premium":return e.filter(s=>s.isPremium);case"high-value":return e.filter(s=>s.valueLevel==="high");default:return e}});this.selectedCount=d(()=>this.selectedMemberIds().length);this.chineseMemberCount=d(()=>this.members().filter(e=>this.isChineseMember(e)).length);this.onlineMemberCount=d(()=>this.members().filter(e=>this.isOnlineMember(e)).length);this.premiumMemberCount=d(()=>this.members().filter(e=>e.isPremium).length);this.isAllSelected=d(()=>{let e=this.filteredMembers(),t=this.selectedMemberIds();return e.length>0&&e.every(s=>t.includes(s.id))})}openMemberListDialog(e){this.currentResource.set(e),this.members.set([]),this.isLoading.set(!1),this.progress.set({extracted:0,total:e.member_count||0,status:""}),this.selectedMemberIds.set([]),this.extractionStarted.set(!1),this.memberFilter.set("all"),this.extractionConfig.set(this.getDefaultConfig()),this.showMemberListDialog.set(!0)}closeMemberListDialog(){this.showMemberListDialog.set(!1),this.currentResource.set(null),this.members.set([])}openBatchExtractDialog(){this.showBatchExtractDialog.set(!0)}closeBatchExtractDialog(){this.showBatchExtractDialog.set(!1)}loadMembers(e){let t=e||this.currentResource();if(!t||!t.telegram_id){this.toastService.error("\u7121\u6548\u7684\u7FA4\u7D44\u4FE1\u606F");return}this.isLoading.set(!0),this.progress.update(s=>c(n({},s),{status:"\u6B63\u5728\u63D0\u53D6\u6210\u54E1..."})),this.ipcService.send("extract-members",{resourceId:t.id,telegramId:t.telegram_id,username:t.username,limit:200,offset:0})}loadMore(){let e=this.currentResource(),t=this.members().length;e&&(this.isLoading.set(!0),this.progress.update(s=>c(n({},s),{status:"\u6B63\u5728\u63D0\u53D6\u66F4\u591A\u6210\u54E1..."})),this.ipcService.send("extract-members",{resourceId:e.id,telegramId:e.telegram_id,username:e.username,limit:200,offset:t}))}startExtraction(){let e=this.currentResource(),t=this.extractionConfig();if(!e){this.toastService.error("\u7121\u6548\u7684\u7FA4\u7D44\u4FE1\u606F");return}this.extractionStarted.set(!0),this.isLoading.set(!0),this.progress.set({extracted:0,total:e.member_count||0,status:"\u958B\u59CB\u63D0\u53D6..."}),this.ipcService.send("start-member-extraction",{resourceId:e.id,telegramId:e.telegram_id,username:e.username,config:t})}pauseExtraction(){this.extractionPaused.set(!0),this.ipcService.send("pause-member-extraction",{})}resumeExtraction(){this.extractionPaused.set(!1),this.ipcService.send("resume-member-extraction",{})}stopExtraction(){this.extractionStarted.set(!1),this.extractionPaused.set(!1),this.isLoading.set(!1),this.ipcService.send("stop-member-extraction",{})}toggleMemberSelection(e){let t=this.selectedMemberIds();t.includes(e)?this.selectedMemberIds.set(t.filter(s=>s!==e)):this.selectedMemberIds.set([...t,e])}selectAll(){let e=this.filteredMembers();this.selectedMemberIds.set(e.map(t=>t.id))}clearSelection(){this.selectedMemberIds.set([])}toggleSelectAll(){this.isAllSelected()?this.clearSelection():this.selectAll()}selectHighValue(){let e=this.members().filter(t=>t.valueLevel==="high");this.selectedMemberIds.set(e.map(t=>t.id)),this.toastService.info(`\u5DF2\u9078\u64C7 ${e.length} \u500B\u9AD8\u50F9\u503C\u6210\u54E1`)}selectOnline(){let e=this.members().filter(t=>this.isOnlineMember(t));this.selectedMemberIds.set(e.map(t=>t.id)),this.toastService.info(`\u5DF2\u9078\u64C7 ${e.length} \u500B\u5728\u7DDA\u6210\u54E1`)}setFilter(e){this.memberFilter.set(e)}setExtractLimit(e){this.extractionConfig.update(t=>c(n({},t),{limit:e}))}setCustomLimit(e){this.extractionConfig.update(t=>c(n({},t),{customLimit:e}))}toggleBackgroundMode(){this.extractionConfig.update(e=>c(n({},e),{backgroundMode:!e.backgroundMode}))}toggleUserType(e){this.extractionConfig.update(t=>c(n({},t),{userTypes:c(n({},t.userTypes),{[e]:!t.userTypes[e]})}))}toggleActivityFilter(e){this.extractionConfig.update(t=>c(n({},t),{activityFilters:c(n({},t.activityFilters),{[e]:!t.activityFilters[e]})}))}toggleAccountFeature(e){this.extractionConfig.update(t=>c(n({},t),{accountFeatures:c(n({},t.accountFeatures),{[e]:!t.accountFeatures[e]})}))}toggleExcludeFilter(e){this.extractionConfig.update(t=>c(n({},t),{excludeFilters:c(n({},t.excludeFilters),{[e]:!t.excludeFilters[e]})}))}exportToCSV(){let e=this.members();if(e.length===0){this.toastService.warning("\u6C92\u6709\u53EF\u5C0E\u51FA\u7684\u6210\u54E1");return}let t=this.generateCSV(e);this.downloadCSV(t,`members_${Date.now()}.csv`),this.toastService.success(`\u5DF2\u5C0E\u51FA ${e.length} \u500B\u6210\u54E1`)}exportSelectedToCSV(){let e=this.selectedMemberIds(),t=this.members().filter(i=>e.includes(i.id));if(t.length===0){this.toastService.warning("\u8ACB\u5148\u9078\u64C7\u8981\u5C0E\u51FA\u7684\u6210\u54E1");return}let s=this.generateCSV(t);this.downloadCSV(s,`selected_members_${Date.now()}.csv`),this.toastService.success(`\u5DF2\u5C0E\u51FA ${t.length} \u500B\u6210\u54E1`)}isChineseMember(e){let t=`${e.firstName||""} ${e.lastName||""}`;return/[\u4e00-\u9fff]/.test(t)}isOnlineMember(e){return e.lastOnline?new Date().getTime()-new Date(e.lastOnline).getTime()<300*1e3:!1}calculateValueLevel(e){let t=0;return e.isPremium&&(t+=3),e.username&&(t+=2),e.photo&&(t+=1),this.isOnlineMember(e)&&(t+=2),!e.isBot&&!e.isScam&&!e.isDeleted&&(t+=1),t>=6?"high":t>=3?"medium":"low"}formatMemberCount(e){return e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}getExtractPercent(){let e=this.progress();return e.total===0?0:Math.round(e.extracted/e.total*100)}getDefaultConfig(){return{limit:500,customLimit:1e3,backgroundMode:!1,userTypes:{chinese:!1,overseas:!1},activityFilters:{onlineNow:!1,within3Days:!1,within7Days:!1,within30Days:!1,longOffline:!1},accountFeatures:{premium:!1,hasUsername:!1,hasPhoto:!1,newAccount:!1,activeAccount:!1,verified:!1},excludeFilters:{bots:!0,scam:!0,deleted:!0}}}generateCSV(e){let t=["ID","Username","First Name","Last Name","Premium","Value Level"],s=e.map(i=>[i.telegramId,i.username||"",i.firstName||"",i.lastName||"",i.isPremium?"Yes":"No",i.valueLevel||""]);return[t.join(","),...s.map(i=>i.join(","))].join(`
`)}downloadCSV(e,t){let s=new Blob([e],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");i.href=URL.createObjectURL(s),i.download=t,i.click()}handleMembersResponse(e){if(this.isLoading.set(!1),e.success&&e.members){let t=this.members(),s=e.members.map(i=>c(n({},i),{valueLevel:this.calculateValueLevel(i)}));e.offset===0?this.members.set(s):this.members.set([...t,...s]),this.progress.update(i=>c(n({},i),{extracted:this.members().length,status:`\u5DF2\u63D0\u53D6 ${this.members().length} \u500B\u6210\u54E1`}))}else this.toastService.error(e.error||"\u63D0\u53D6\u6210\u54E1\u5931\u6557")}handleExtractionProgress(e){this.progress.set({extracted:e.extracted||0,total:e.total||0,status:e.status||""})}handleExtractionComplete(e){this.isLoading.set(!1),this.extractionStarted.set(!1),e.success&&this.toastService.success(`\u6210\u54E1\u63D0\u53D6\u5B8C\u6210\uFF0C\u5171 ${e.count} \u500B`)}handleExtractionError(e){this.isLoading.set(!1),this.toastService.error(e.error||"\u63D0\u53D6\u904E\u7A0B\u767C\u751F\u932F\u8AA4")}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var le=class o{constructor(){this.ipcService=l(v);this.toastService=l(h);this.queueStatuses=r(new Map);this.currentQueueMessages=r([]);this.selectedPhone=r(null);this.queueLengthHistory=r([]);this.showQueueDetails=r(!1);this.isRefreshing=r(!1);this.refreshTimeout=null;this.totalStats=d(()=>{let e=Array.from(this.queueStatuses().values());return{totalPending:e.reduce((t,s)=>t+s.pending,0),totalSending:e.reduce((t,s)=>t+s.sending,0),totalSent:e.reduce((t,s)=>t+s.sent,0),totalFailed:e.reduce((t,s)=>t+s.failed,0),activeQueues:e.filter(t=>!t.paused&&t.pending>0).length,pausedQueues:e.filter(t=>t.paused).length}});this.accountQueueStatuses=d(()=>Array.from(this.queueStatuses().entries()).map(([e,t])=>({phone:e,status:t,messages:this.currentQueueMessages().filter(s=>s.phone===e)})))}refreshStatus(e){this.isRefreshing.set(!0),this.ipcService.send("get-queue-status",{phone:e})}refreshStatusThrottled(){this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=setTimeout(()=>{this.refreshStatus()},500)}getMessages(e,t,s=100){this.ipcService.send("get-queue-messages",{phone:e,status:t,limit:s})}clearPendingQueue(){confirm("\u78BA\u5B9A\u8981\u6E05\u9664\u6240\u6709\u5F85\u767C\u9001\u6D88\u606F\u55CE\uFF1F")&&(this.ipcService.send("clear-pending-queue",{}),this.toastService.info("\u6B63\u5728\u6E05\u9664\u5F85\u767C\u9001\u968A\u5217..."))}clearQueue(e,t){confirm(`\u78BA\u5B9A\u8981\u6E05\u9664 ${e} \u7684\u968A\u5217\u55CE\uFF1F`)&&this.ipcService.send("clear-queue",{phone:e,status:t})}pauseQueue(e){this.ipcService.send("pause-queue",{phone:e}),this.toastService.info(`\u66AB\u505C ${e} \u7684\u767C\u9001\u968A\u5217`)}resumeQueue(e){this.ipcService.send("resume-queue",{phone:e}),this.toastService.info(`\u6062\u5FA9 ${e} \u7684\u767C\u9001\u968A\u5217`)}pauseAllQueues(){this.queueStatuses().forEach((t,s)=>{this.ipcService.send("pause-queue",{phone:s})}),this.toastService.info("\u5DF2\u66AB\u505C\u6240\u6709\u767C\u9001\u968A\u5217")}resumeAllQueues(){this.queueStatuses().forEach((t,s)=>{this.ipcService.send("resume-queue",{phone:s})}),this.toastService.info("\u5DF2\u6062\u5FA9\u6240\u6709\u767C\u9001\u968A\u5217")}deleteMessage(e,t){confirm("\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u6D88\u606F\u55CE\uFF1F")&&this.ipcService.send("delete-queue-message",{phone:e,messageId:t})}updateMessagePriority(e,t,s){this.ipcService.send("update-queue-priority",{phone:e,messageId:t,priority:s})}retryFailedMessages(e){this.ipcService.send("retry-failed-messages",{phone:e}),this.toastService.info("\u6B63\u5728\u91CD\u8A66\u5931\u6557\u7684\u6D88\u606F...")}viewDetails(e){this.selectedPhone.set(e),this.getMessages(e),this.showQueueDetails.set(!0)}closeDetails(){this.showQueueDetails.set(!1),this.selectedPhone.set(null),this.currentQueueMessages.set([])}loadHistory(e=7){this.ipcService.send("get-queue-length-history",{days:e})}getStatusForAccount(e){return this.queueStatuses().get(e)||null}getStatusLabel(e){return{pending:"\u5F85\u767C\u9001",sending:"\u767C\u9001\u4E2D",sent:"\u5DF2\u767C\u9001",failed:"\u5931\u6557",paused:"\u5DF2\u66AB\u505C"}[e]||e}getStatusColor(e){return{pending:"bg-amber-500/20 text-amber-400",sending:"bg-cyan-500/20 text-cyan-400 animate-pulse",sent:"bg-emerald-500/20 text-emerald-400",failed:"bg-red-500/20 text-red-400",paused:"bg-slate-500/20 text-slate-400"}[e]||"bg-slate-500/20 text-slate-400"}getPriorityLabel(e){return{high:"\u9AD8\u512A\u5148",normal:"\u666E\u901A",low:"\u4F4E\u512A\u5148"}[e]||e}getPriorityColor(e){return{high:"bg-red-500/20 text-red-400",normal:"bg-cyan-500/20 text-cyan-400",low:"bg-slate-500/20 text-slate-400"}[e]||"bg-slate-500/20 text-slate-400"}handleQueueStatusResponse(e){if(this.isRefreshing.set(!1),e.success&&e.statuses){let t=new Map;for(let s of e.statuses)t.set(s.phone,s);this.queueStatuses.set(t)}}handleQueueMessagesResponse(e){e.success&&e.messages&&this.currentQueueMessages.set(e.messages)}handleQueueHistoryResponse(e){e.success&&e.history&&this.queueLengthHistory.set(e.history)}handleQueueUpdate(e){if(e.phone&&e.status){let t=new Map(this.queueStatuses());t.set(e.phone,e.status),this.queueStatuses.set(t)}}handleMessageSent(e){e.messageId&&this.currentQueueMessages.update(t=>t.map(s=>s.id===e.messageId?c(n({},s),{status:"sent",sentAt:new Date().toISOString()}):s))}handleMessageFailed(e){e.messageId&&this.currentQueueMessages.update(t=>t.map(s=>s.id===e.messageId?c(n({},s),{status:"failed",error:e.error}):s))}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var K=class o{constructor(){this.ipcService=l(v);this.toastService=l(h);this.membershipService=l(R);this.campaigns=r([]);this.selectedCampaign=r(null);this.unifiedOverview=r(null);this.funnelAnalysis=r(null);this.showCampaignForm=r(!1);this.campaignFormData=r({name:"",description:"",phases:["discovery","monitoring","outreach"],keywords:[],targetGroups:[],assignedAccounts:[]});this.newCampaign=r(this.getEmptyCampaignForm());this.campaignKeywordInput=r("");this.isSubmittingCampaign=r(!1);this.activeCampaigns=d(()=>this.campaigns().filter(e=>e.status==="running"));this.pausedCampaigns=d(()=>this.campaigns().filter(e=>e.status==="paused"));this.completedCampaigns=d(()=>this.campaigns().filter(e=>e.status==="completed"));this.setupIpcListeners()}loadCampaigns(){this.ipcService.send("get-campaigns",{limit:50})}loadUnifiedOverview(){this.ipcService.send("get-unified-overview",{days:7})}loadFunnelAnalysis(){this.ipcService.send("get-funnel-analysis",{})}loadCampaignData(){this.loadCampaigns(),this.loadUnifiedOverview(),this.loadFunnelAnalysis()}createCampaignFromForm(){if(!this.membershipService.hasFeature("aiSalesFunnel")){this.toastService.warning("\u{1F48E} \u71DF\u92B7\u6D3B\u52D5\u529F\u80FD\u9700\u8981 \u947D\u77F3\u738B\u724C \u6216\u4EE5\u4E0A\u6703\u54E1\uFF0C\u5347\u7D1A\u89E3\u9396\u66F4\u591A\u529F\u80FD"),window.dispatchEvent(new CustomEvent("open-membership-dialog"));return}let e=this.campaignFormData();if(!e.name.trim()){this.toastService.warning("\u8ACB\u8F38\u5165\u6D3B\u52D5\u540D\u7A31");return}if(e.assignedAccounts.length===0){this.toastService.warning("\u8ACB\u9078\u64C7\u5E33\u865F");return}this.ipcService.send("create-campaign",{name:e.name,description:e.description,phases:e.phases,keywords:e.keywords,targetGroups:e.targetGroups,assignedAccounts:e.assignedAccounts}),this.resetCampaignForm()}addCampaign(){if(this.isSubmittingCampaign()){this.toastService.warning("\u6B63\u5728\u5275\u5EFA\u6D3B\u52D5\uFF0C\u8ACB\u7A0D\u5019...",2e3);return}let e=this.newCampaign(),t=[];if(e.name?.trim()||t.push("\u6D3B\u52A8\u540D\u79F0"),(!e.action.templateId||e.action.templateId===0)&&t.push("\u6D88\u606F\u6A21\u677F"),e.trigger.sourceGroupIds.length===0&&t.push("\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u6765\u6E90\u7FA4\u7EC4"),e.trigger.keywordSetIds.length===0&&t.push("\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5173\u952E\u8BCD\u96C6"),t.length>0){this.toastService.error(`\u8BF7\u5B8C\u5584\u4EE5\u4E0B\u5185\u5BB9: ${t.join(", ")}`);return}let s=e.name.trim();if(this.campaigns().find(a=>a.name===s)){this.toastService.warning(`\u6D3B\u52D5 "${s}" \u5DF2\u5B58\u5728\uFF0C\u8ACB\u4F7F\u7528\u4E0D\u540C\u7684\u540D\u7A31`,4e3);return}this.isSubmittingCampaign.set(!0),this.newCampaign.set(this.getEmptyCampaignForm()),this.ipcService.send("add-campaign",n({},e)),setTimeout(()=>{this.isSubmittingCampaign.set(!1)},3e3)}startCampaign(e){confirm("\u78BA\u5B9A\u8981\u555F\u52D5\u6B64\u6D3B\u52D5\u55CE\uFF1F")&&this.ipcService.send("start-campaign",{campaignId:e})}pauseCampaign(e){this.ipcService.send("pause-campaign",{campaignId:e})}resumeCampaign(e){this.ipcService.send("resume-campaign",{campaignId:e})}stopCampaign(e){confirm("\u78BA\u5B9A\u8981\u505C\u6B62\u6B64\u6D3B\u52D5\u55CE\uFF1F")&&this.ipcService.send("stop-campaign",{campaignId:e})}deleteCampaign(e){confirm("\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u6D3B\u52D5\u55CE\uFF1F")&&this.ipcService.send("delete-campaign",{campaignId:e})}toggleCampaignStatus(e){this.ipcService.send("toggle-campaign-status",{id:e})}viewCampaignDetails(e){this.selectedCampaign.set(e),this.ipcService.send("get-campaign-logs",{campaignId:e.id})}toggleCampaignPhase(e){this.campaignFormData.update(t=>{let s=[...t.phases],i=s.indexOf(e);return i>=0?s.splice(i,1):s.push(e),c(n({},t),{phases:s})})}addCampaignKeyword(){let e=this.campaignKeywordInput().trim();e&&(this.campaignFormData.update(t=>c(n({},t),{keywords:[...t.keywords,e]})),this.campaignKeywordInput.set(""))}removeCampaignKeyword(e){this.campaignFormData.update(t=>c(n({},t),{keywords:t.keywords.filter(s=>s!==e)}))}toggleCampaignAccount(e){this.campaignFormData.update(t=>{let s=[...t.assignedAccounts],i=s.indexOf(e);return i>=0?s.splice(i,1):s.push(e),c(n({},t),{assignedAccounts:s})})}toggleNewCampaignSourceGroup(e){this.newCampaign.update(t=>{let s=[...t.trigger.sourceGroupIds],i=s.indexOf(e);return i>=0?s.splice(i,1):s.push(e),c(n({},t),{trigger:c(n({},t.trigger),{sourceGroupIds:s})})})}toggleNewCampaignKeywordSet(e){this.newCampaign.update(t=>{let s=[...t.trigger.keywordSetIds],i=s.indexOf(e);return i>=0?s.splice(i,1):s.push(e),c(n({},t),{trigger:c(n({},t.trigger),{keywordSetIds:s})})})}updateCampaignFormName(e){this.campaignFormData.update(t=>c(n({},t),{name:e}))}updateCampaignFormDesc(e){this.campaignFormData.update(t=>c(n({},t),{description:e}))}updateNewCampaignName(e){this.newCampaign.update(t=>c(n({},t),{name:e}))}updateNewCampaignTemplateId(e){this.newCampaign.update(t=>c(n({},t),{action:c(n({},t.action),{templateId:e})}))}getEmptyCampaignForm(){return{name:"",trigger:{sourceGroupIds:[],keywordSetIds:[]},action:{templateId:0,minDelaySeconds:30,maxDelaySeconds:120}}}resetCampaignForm(){this.campaignFormData.set({name:"",description:"",phases:["discovery","monitoring","outreach"],keywords:[],targetGroups:[],assignedAccounts:[]}),this.showCampaignForm.set(!1)}getCampaignStatusLabel(e){return{draft:"\u8349\u7A3F",scheduled:"\u5DF2\u6392\u7A0B",running:"\u904B\u884C\u4E2D",paused:"\u5DF2\u66AB\u505C",completed:"\u5DF2\u5B8C\u6210",failed:"\u5931\u6557"}[e]||e}getCampaignStatusColor(e){return{draft:"bg-slate-500/20 text-slate-400",scheduled:"bg-blue-500/20 text-blue-400",running:"bg-green-500/20 text-green-400",paused:"bg-yellow-500/20 text-yellow-400",completed:"bg-cyan-500/20 text-cyan-400",failed:"bg-red-500/20 text-red-400"}[e]||"bg-slate-500/20 text-slate-400"}getPhaseLabel(e){return{discovery:"\u8CC7\u6E90\u767C\u73FE",monitoring:"\u76E3\u63A7\u7372\u5BA2",outreach:"\u5EE3\u544A\u89F8\u9054",tracking:"\u7528\u6236\u8FFD\u8E64",conversion:"\u8F49\u5316\u6210\u4EA4"}[e]||e}getCampaignName(e){return e?this.campaigns().find(t=>t.id===e)?.name||"Unknown Campaign":"N/A"}getCampaignById(e){if(e!==void 0)return this.campaigns().find(t=>t.id===e)}setupIpcListeners(){this.ipcService.on("campaigns-result",e=>this.handleCampaigns(e)),this.ipcService.on("campaign-created",e=>this.handleCampaignCreated(e)),this.ipcService.on("campaign-deleted",e=>this.handleCampaignDeleted(e)),this.ipcService.on("unified-overview-result",e=>this.handleUnifiedOverview(e)),this.ipcService.on("funnel-analysis-result",e=>this.handleFunnelAnalysis(e)),this.ipcService.on("campaign-added",e=>this.handleCampaignAdded(e)),this.ipcService.on("campaign-status-toggled",e=>this.handleCampaignStatusToggled(e))}handleCampaigns(e){e.success&&this.campaigns.set(e.campaigns||[])}handleCampaignCreated(e){e.success?(this.toastService.success("\u71DF\u92B7\u6D3B\u52D5\u5DF2\u5275\u5EFA"),this.loadCampaigns()):this.toastService.error(`\u5275\u5EFA\u5931\u6557: ${e.error}`)}handleCampaignDeleted(e){e.success&&(this.toastService.success("\u71DF\u92B7\u6D3B\u52D5\u5DF2\u522A\u9664"),this.loadCampaigns())}handleUnifiedOverview(e){e.success&&this.unifiedOverview.set(e)}handleFunnelAnalysis(e){e.success&&this.funnelAnalysis.set(e)}handleCampaignAdded(e){this.isSubmittingCampaign.set(!1),e.success?(this.toastService.success("\u6D3B\u52D5\u5275\u5EFA\u6210\u529F"),this.loadCampaigns()):this.toastService.error(`\u5275\u5EFA\u5931\u6557: ${e.error}`)}handleCampaignStatusToggled(e){e.success&&this.loadCampaigns()}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var z=class o{constructor(){this.ipcService=l(v);this.toastService=l(h);this.messageTemplates=r([]);this.selectedTemplate=r(null);this.showTemplateCreator=r(!1);this.newTemplate=r({name:"",prompt:""});this.activeTemplates=d(()=>this.messageTemplates().filter(e=>e.active));this.templateCount=d(()=>this.messageTemplates().length);this.availableVariables=[{name:"name",placeholder:"{name}",description:"\u7528\u6236\u540D\u7A31"},{name:"username",placeholder:"{username}",description:"\u7528\u6236 @username"},{name:"group_name",placeholder:"{group_name}",description:"\u7FA4\u7D44\u540D\u7A31"},{name:"keyword",placeholder:"{keyword}",description:"\u89F8\u767C\u95DC\u9375\u8A5E"},{name:"date",placeholder:"{date}",description:"\u7576\u524D\u65E5\u671F"},{name:"time",placeholder:"{time}",description:"\u7576\u524D\u6642\u9593"}];this.setupIpcListeners()}loadTemplates(){this.ipcService.send("get-templates",{})}addTemplate(){let e=this.newTemplate();e.name.trim()&&e.prompt.trim()?(this.ipcService.send("add-template",{name:e.name,prompt:e.prompt}),this.newTemplate.set({name:"",prompt:""}),this.toastService.success("\u6A21\u677F\u6DFB\u52A0\u6210\u529F")):this.toastService.error("\u8BF7\u586B\u5199\u6A21\u677F\u540D\u79F0\u548C\u6D88\u606F\u5185\u5BB9")}addTemplateQuick(e,t){if(e?.trim()&&t?.trim()){if(this.messageTemplates().some(i=>i.name===e.trim())){this.toastService.warning("\u6A21\u677F\u540D\u7A31\u5DF2\u5B58\u5728\uFF0C\u7121\u6CD5\u5275\u5EFA\u91CD\u8907\u6A21\u677F",3e3);return}this.ipcService.send("add-template",{name:e.trim(),prompt:t.trim()}),this.newTemplate.set({name:"",prompt:""}),this.toastService.success("\u6A21\u677F\u6DFB\u52A0\u6210\u529F"),this.messageTemplates().length>0&&this.showTemplateCreator.set(!1)}else this.toastService.error("\u8BF7\u586B\u5199\u6A21\u677F\u540D\u79F0\u548C\u6D88\u606F\u5185\u5BB9")}toggleTemplateStatus(e){this.ipcService.send("toggle-template-status",{id:e})}removeTemplate(e,t=[]){let s=this.messageTemplates().find(a=>a.id===e);if(!s)return;let i=t.filter(a=>a.actions?.some(u=>u.templateId===e));if(i.length>0){let a=i.map(u=>u.name).join(", ");if(!confirm(`\u6A21\u677F "${s.name}" \u6B63\u5728\u88AB\u4EE5\u4E0B\u6D3B\u52D5\u4F7F\u7528\uFF1A${a}

\u522A\u9664\u6A21\u677F\u5F8C\uFF0C\u9019\u4E9B\u6D3B\u52D5\u5C07\u7121\u6CD5\u6B63\u5E38\u5DE5\u4F5C\u3002

\u78BA\u5B9A\u8981\u522A\u9664\u55CE\uFF1F`))return}else if(!confirm(`\u78BA\u5B9A\u8981\u522A\u9664\u6A21\u677F "${s.name}" \u55CE\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u92B7\u3002`))return;this.ipcService.send("remove-template",{id:e}),this.toastService.success("\u6A21\u677F\u5DF2\u522A\u9664")}selectTemplate(e){this.selectedTemplate.set(e)}clearSelection(){this.selectedTemplate.set(null)}updateTemplateName(e){this.newTemplate.update(t=>c(n({},t),{name:e}))}updateTemplatePrompt(e){this.newTemplate.update(t=>c(n({},t),{prompt:e}))}insertTemplateVariable(e,t){let s=e.selectionStart,i=e.selectionEnd,a=e.value,u=a.substring(0,s)+t+a.substring(i);e.value=u,this.updateTemplatePrompt(u),setTimeout(()=>{e.focus(),e.selectionStart=e.selectionEnd=s+t.length},0)}openTemplateCreator(){this.showTemplateCreator.set(!0),this.newTemplate.set({name:"",prompt:""})}closeTemplateCreator(){this.showTemplateCreator.set(!1)}getTemplateName(e){return e?this.messageTemplates().find(t=>t.id===e)?.name||"Unknown Template":"N/A"}getTemplateById(e){return this.messageTemplates().find(t=>t.id===e)}setupIpcListeners(){this.ipcService.on("templates-result",e=>this.handleTemplates(e)),this.ipcService.on("template-added",e=>this.handleTemplateAdded(e)),this.ipcService.on("template-removed",e=>this.handleTemplateRemoved(e)),this.ipcService.on("template-status-toggled",e=>this.handleTemplateStatusToggled(e))}handleTemplates(e){(e.success||e.templates)&&this.messageTemplates.set(e.templates||[])}handleTemplateAdded(e){e.success?this.loadTemplates():this.toastService.error(`\u6DFB\u52A0\u5931\u6557: ${e.error}`)}handleTemplateRemoved(e){e.success&&this.loadTemplates()}handleTemplateStatusToggled(e){e.success&&this.loadTemplates()}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var P={dashboard:{path:"/dashboard",title:"\u5100\u8868\u677F",icon:"\u{1F3E0}"},accounts:{path:"/accounts",title:"\u5E33\u865F\u7BA1\u7406",icon:"\u{1F465}"},"add-account":{path:"/accounts/add",title:"\u6DFB\u52A0\u5E33\u865F",icon:"\u2795"},"api-credentials":{path:"/accounts/api",title:"API \u6191\u8B49",icon:"\u{1F511}"},resources:{path:"/resources",title:"\u8CC7\u6E90\u7BA1\u7406",icon:"\u{1F4E6}"},"member-database":{path:"/member-database",title:"\u6210\u54E1\u8CC7\u6599\u5EAB",icon:"\u{1F4CA}"},"resource-center":{path:"/resource-center",title:"\u8CC7\u6E90\u4E2D\u5FC3",icon:"\u{1F3E2}"},"search-discovery":{path:"/search-discovery",title:"\u8CC7\u6E90\u767C\u73FE",icon:"\u{1F50D}"},"ai-assistant":{path:"/ai-assistant",title:"AI \u7B56\u7565\u898F\u5283",icon:"\u{1F916}",requiredFeature:"strategyPlanning",membershipLevel:"diamond",membershipMessage:"\u{1F48E} AI\u7B56\u7565\u898F\u5283\u9700\u8981 \u947D\u77F3\u738B\u724C \u6216\u4EE5\u4E0A\u6703\u54E1"},automation:{path:"/automation",title:"\u81EA\u52D5\u5316\u4E2D\u5FC3",icon:"\u2699\uFE0F"},leads:{path:"/leads",title:"\u6F5B\u5728\u5BA2\u6236",icon:"\u{1F3AF}"},"lead-nurturing":{path:"/lead-nurturing",title:"\u7DDA\u7D22\u57F9\u80B2",icon:"\u{1F331}"},"nurturing-analytics":{path:"/nurturing-analytics",title:"\u57F9\u80B2\u5206\u6790",icon:"\u{1F4C8}"},ads:{path:"/ads",title:"\u5EE3\u544A\u767C\u9001",icon:"\u{1F4E2}",requiredFeature:"adBroadcast",membershipLevel:"silver",membershipMessage:"\u{1F948} \u5EE3\u544A\u767C\u9001\u529F\u80FD\u9700\u8981 \u767D\u9280\u7CBE\u82F1 \u6216\u4EE5\u4E0A\u6703\u54E1"},"user-tracking":{path:"/user-tracking",title:"\u7528\u6236\u8FFD\u8E64",icon:"\u{1F464}",requiredFeature:"advancedAnalytics",membershipLevel:"diamond",membershipMessage:"\u{1F48E} \u7528\u6236\u8FFD\u8E64\u529F\u80FD\u9700\u8981 \u947D\u77F3\u738B\u724C \u6216\u4EE5\u4E0A\u6703\u54E1"},campaigns:{path:"/campaigns",title:"\u71DF\u92B7\u6D3B\u52D5",icon:"\u{1F680}",requiredFeature:"aiSalesFunnel",membershipLevel:"diamond",membershipMessage:"\u{1F48E} \u71DF\u92B7\u6D3B\u52D5\u529F\u80FD\u9700\u8981 \u947D\u77F3\u738B\u724C \u6216\u4EE5\u4E0A\u6703\u54E1"},"multi-role":{path:"/multi-role",title:"\u591A\u89D2\u8272\u5354\u4F5C",icon:"\u{1F3AD}",requiredFeature:"multiRole",membershipLevel:"diamond",membershipMessage:"\u{1F48E} \u591A\u89D2\u8272\u5354\u4F5C\u529F\u80FD\u9700\u8981 \u947D\u77F3\u738B\u724C \u6216\u4EE5\u4E0A\u6703\u54E1"},"ai-team":{path:"/ai-team",title:"AI \u5718\u968A\u92B7\u552E",icon:"\u{1F91D}",requiredFeature:"autoExecution",membershipLevel:"diamond",membershipMessage:"\u{1F48E} AI\u5718\u968A\u92B7\u552E\u9700\u8981 \u947D\u77F3\u738B\u724C \u6216\u4EE5\u4E0A\u6703\u54E1"},"ai-center":{path:"/ai-center",title:"AI \u4E2D\u5FC3",icon:"\u{1F9E0}"},settings:{path:"/settings",title:"\u8A2D\u5B9A",icon:"\u2699\uFE0F"},analytics:{path:"/analytics",title:"\u6578\u64DA\u6D1E\u5BDF",icon:"\u{1F4CA}",requiredFeature:"dataInsightsBasic",membershipLevel:"gold",membershipMessage:"\u{1F947} \u6578\u64DA\u6D1E\u5BDF\u529F\u80FD\u9700\u8981 \u9EC3\u91D1\u5927\u5E2B \u6216\u4EE5\u4E0A\u6703\u54E1"},"analytics-center":{path:"/analytics-center",title:"\u6578\u64DA\u5206\u6790\u4E2D\u5FC3",icon:"\u{1F4C9}",requiredFeature:"dataInsightsBasic",membershipLevel:"gold",membershipMessage:"\u{1F947} \u6578\u64DA\u5206\u6790\u529F\u80FD\u9700\u8981 \u9EC3\u91D1\u5927\u5E2B \u6216\u4EE5\u4E0A\u6703\u54E1"},profile:{path:"/profile",title:"\u500B\u4EBA\u8CC7\u6599",icon:"\u{1F464}"},"membership-center":{path:"/membership",title:"\u6703\u54E1\u4E2D\u5FC3",icon:"\u2B50"},"monitoring-accounts":{path:"/monitoring/accounts",title:"\u76E3\u63A7\u5E33\u865F",icon:"\u{1F441}\uFE0F"},"monitoring-groups":{path:"/monitoring/groups",title:"\u76E3\u63A7\u7FA4\u7D44",icon:"\u{1F441}\uFE0F"},"keyword-sets":{path:"/monitoring/keywords",title:"\u95DC\u9375\u8A5E\u96C6",icon:"\u{1F524}"},"chat-templates":{path:"/monitoring/templates",title:"\u804A\u5929\u6A21\u677F",icon:"\u{1F4AC}"},"trigger-rules":{path:"/monitoring/triggers",title:"\u89F8\u767C\u898F\u5247",icon:"\u26A1"},"collected-users":{path:"/monitoring/users",title:"\u6536\u96C6\u7528\u6236",icon:"\u{1F465}"}},G=class o{constructor(){this.membershipService=l(R);this.toastService=l(h);this.currentView=r("dashboard");this._history=["dashboard"];this.history=r(["dashboard"]);this.currentViewConfig=d(()=>P[this.currentView()]);this.canGoBack=d(()=>this._history.length>1);this.onNavigateCallbacks=[]}navigate(e,t){if(!t?.skipPermissionCheck){let i=P[e];if(i?.requiredFeature&&!this.membershipService.hasFeature(i.requiredFeature))return this.toastService.warning(i.membershipMessage||"\u6B64\u529F\u80FD\u9700\u8981\u5347\u7D1A\u6703\u54E1"),window.dispatchEvent(new CustomEvent("open-membership-dialog")),!1}let s=this.currentView();return this.currentView.set(e),!t?.skipHistory&&e!==s&&(this._history.push(e),this._history.length>50&&(this._history=this._history.slice(-50)),this.history.set([...this._history])),this.onNavigateCallbacks.forEach(i=>i(e)),!0}goBack(){if(this._history.length>1){this._history.pop();let e=this._history[this._history.length-1];return this.currentView.set(e),this.history.set([...this._history]),!0}return!1}goHome(){this.navigate("dashboard")}onNavigate(e){return this.onNavigateCallbacks.push(e),()=>{let t=this.onNavigateCallbacks.indexOf(e);t>-1&&this.onNavigateCallbacks.splice(t,1)}}getViewConfig(e){return P[e]}getAllViewConfigs(){return P}isViewAvailable(e){let t=P[e];return t?.requiredFeature?this.membershipService.hasFeature(t.requiredFeature):!0}getViewPath(e){return P[e]?.path||"/dashboard"}getViewFromPath(e){for(let[t,s]of Object.entries(P))if(s.path===e)return t}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var W=class o{constructor(){this.ipcService=l(v);this.toastService=l(h);this.leads=r([]);this.selectedLead=r(null);this.leadStats=r({total:0,byStage:{New:0,Contacted:0,Replied:0,"Follow-up":0,"Closed-Won":0,"Closed-Lost":0},todayNew:0,todayContacted:0,conversionRate:0});this.filter=r({});this.viewMode=r("kanban");this.isLoading=r(!1);this.selectedLeadIds=r(new Set);this.showBatchActions=r(!1);this.showLeadDetails=r(!1);this.detailsTab=r("sendMessage");this.showDeleteConfirm=r(!1);this.leadsToDelete=r([]);this.filteredLeads=d(()=>{let e=this.leads(),t=this.filter();if(t.stage&&(e=e.filter(s=>s.stage===t.stage)),t.search){let s=t.search.toLowerCase();e=e.filter(i=>i.username.toLowerCase().includes(s)||i.firstName?.toLowerCase().includes(s)||i.lastName?.toLowerCase().includes(s)||i.message.toLowerCase().includes(s))}return t.sourceGroup&&(e=e.filter(s=>s.sourceGroup===t.sourceGroup)),t.minScore!==void 0&&(e=e.filter(s=>(s.score||0)>=t.minScore)),e});this.leadsByStage=d(()=>{let e=["New","Contacted","Replied","Follow-up","Closed-Won","Closed-Lost"],t={};return e.forEach(s=>{t[s]=this.filteredLeads().filter(i=>i.stage===s)}),t});this.selectedCount=d(()=>this.selectedLeadIds().size);this.stageLabels={New:"\u65B0\u7DDA\u7D22",Contacted:"\u5DF2\u806F\u7E6B",Replied:"\u5DF2\u56DE\u8986","Follow-up":"\u9700\u8DDF\u9032","Closed-Won":"\u5DF2\u6210\u4EA4","Closed-Lost":"\u5DF2\u6D41\u5931"};this.stageColors={New:"bg-blue-500/20 text-blue-400 border-blue-500/30",Contacted:"bg-amber-500/20 text-amber-400 border-amber-500/30",Replied:"bg-purple-500/20 text-purple-400 border-purple-500/30","Follow-up":"bg-orange-500/20 text-orange-400 border-orange-500/30","Closed-Won":"bg-emerald-500/20 text-emerald-400 border-emerald-500/30","Closed-Lost":"bg-red-500/20 text-red-400 border-red-500/30"};this.setupIpcListeners()}loadLeads(e=100){this.isLoading.set(!0),this.ipcService.send("get-leads",{limit:e})}loadLeadStats(){this.ipcService.send("get-lead-stats",{})}loadLeadDetails(e){this.ipcService.send("get-lead-details",{leadId:e})}refreshData(){this.loadLeads(),this.loadLeadStats()}selectLead(e){this.selectedLead.set(e),this.showLeadDetails.set(!0),this.loadLeadDetails(e.id)}closeLeadDetails(){this.showLeadDetails.set(!1),this.selectedLead.set(null)}updateLeadStage(e,t){this.ipcService.send("update-lead-stage",{leadId:e,stage:t}),this.leads.update(s=>s.map(i=>i.id===e?c(n({},i),{stage:t}):i)),this.selectedLead()?.id===e&&this.selectedLead.update(s=>s?c(n({},s),{stage:t}):null)}addNote(e,t){t.trim()&&this.ipcService.send("add-lead-note",{leadId:e,note:t})}assignLead(e,t){this.ipcService.send("assign-lead",{leadId:e,assignTo:t}),this.leads.update(s=>s.map(i=>i.id===e?c(n({},i),{assignedTo:t}):i))}addToBlacklist(e){confirm("\u78BA\u5B9A\u8981\u5C07\u6B64\u7528\u6236\u52A0\u5165\u9ED1\u540D\u55AE\u55CE\uFF1F")&&(this.ipcService.send("add-to-blacklist",{leadId:e}),this.toastService.success("\u5DF2\u52A0\u5165\u9ED1\u540D\u55AE"))}toggleLeadSelection(e){this.selectedLeadIds.update(t=>{let s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})}selectAllLeads(){let e=new Set(this.filteredLeads().map(t=>t.id));this.selectedLeadIds.set(e)}clearSelection(){this.selectedLeadIds.set(new Set)}batchUpdateStage(e){let t=Array.from(this.selectedLeadIds());t.length!==0&&(this.ipcService.send("batch-update-lead-stage",{leadIds:t,stage:e}),this.leads.update(s=>s.map(i=>t.includes(i.id)?c(n({},i),{stage:e}):i)),this.clearSelection(),this.toastService.success(`\u5DF2\u66F4\u65B0 ${t.length} \u500B\u7DDA\u7D22\u7684\u72C0\u614B`))}confirmDeleteLeads(){let e=Array.from(this.selectedLeadIds());if(e.length===0)return;let t=this.leads().filter(s=>e.includes(s.id));this.leadsToDelete.set(t),this.showDeleteConfirm.set(!0)}cancelDeleteLeads(){this.showDeleteConfirm.set(!1),this.leadsToDelete.set([])}executeDeleteLeads(){let e=this.leadsToDelete().map(t=>t.id);this.ipcService.send("batch-delete-leads",{leadIds:e}),this.leads.update(t=>t.filter(s=>!e.includes(s.id))),this.clearSelection(),this.showDeleteConfirm.set(!1),this.leadsToDelete.set([]),this.toastService.success(`\u5DF2\u522A\u9664 ${e.length} \u500B\u7DDA\u7D22`)}setFilter(e){this.filter.update(t=>n(n({},t),e))}clearFilter(){this.filter.set({})}setViewMode(e){this.viewMode.set(e)}setDetailsTab(e){this.detailsTab.set(e)}exportToExcel(){let e=this.filteredLeads();if(e.length===0){this.toastService.warning("\u6C92\u6709\u53EF\u5C0E\u51FA\u7684\u7DDA\u7D22");return}this.ipcService.send("export-leads-to-excel",{leadIds:e.map(t=>t.id)}),this.toastService.info("\u6B63\u5728\u5C0E\u51FA...")}getStageLabel(e){return this.stageLabels[e]||e}getStageColor(e){return this.stageColors[e]||"bg-slate-500/20 text-slate-400"}getLeadDisplayName(e){return e.firstName||e.lastName?`${e.firstName||""} ${e.lastName||""}`.trim():e.username||"Unknown"}setupIpcListeners(){this.ipcService.on("leads-result",e=>this.handleLeads(e)),this.ipcService.on("lead-stats-result",e=>this.handleLeadStats(e)),this.ipcService.on("lead-details-result",e=>this.handleLeadDetails(e)),this.ipcService.on("lead-captured",e=>this.handleLeadCaptured(e)),this.ipcService.on("lead-stage-updated",e=>this.handleLeadStageUpdated(e)),this.ipcService.on("leads-exported",e=>this.handleLeadsExported(e))}handleLeads(e){this.isLoading.set(!1),(e.success||e.leads)&&this.leads.set(e.leads||[])}handleLeadStats(e){e.success&&this.leadStats.set(e.stats)}handleLeadDetails(e){e.success&&e.lead&&this.selectedLead.set(e.lead)}handleLeadCaptured(e){e.lead&&(this.leads.update(t=>[e.lead,...t]),this.toastService.success(`\u6355\u7372\u65B0\u7DDA\u7D22: ${e.lead.username}`))}handleLeadStageUpdated(e){e.success&&this.loadLeadStats()}handleLeadsExported(e){e.success?this.toastService.success(`\u5C0E\u51FA\u6210\u529F: ${e.filePath}`):this.toastService.error(`\u5C0E\u51FA\u5931\u6557: ${e.error}`)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Y=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._groups=r([]);this._joinQueue=r([]);this._selectedGroupIds=r(new Set);this._isJoining=r(!1);this.groups=this._groups.asReadonly();this.joinQueue=this._joinQueue.asReadonly();this.selectedGroupIds=this._selectedGroupIds.asReadonly();this.isJoining=this._isJoining.asReadonly();this._joinMonitorDialog=r({isOpen:!1,resource:null,selectedAccount:"",enableMonitoring:!1,selectedKeywordSets:[]});this._batchJoinDialog=r({isOpen:!1,selectedResources:[],selectedAccount:"",enableMonitoring:!1,selectedKeywordSets:[]});this._postJoinDialog=r({isOpen:!1,resource:null,phone:"",keywordSetCount:0});this.joinMonitorDialog=this._joinMonitorDialog.asReadonly();this.batchJoinDialog=this._batchJoinDialog.asReadonly();this.postJoinDialog=this._postJoinDialog.asReadonly();this.selectedGroups=d(()=>{let e=this._selectedGroupIds();return this._groups().filter(t=>e.has(t.id))});this.selectedGroupCount=d(()=>this._selectedGroupIds().size);this.joinQueuePending=d(()=>this._joinQueue().filter(e=>e.status==="pending"));this.joinQueueProgress=d(()=>{let e=this._joinQueue();if(e.length===0)return 0;let t=e.filter(s=>s.status==="joined"||s.status==="failed").length;return Math.round(t/e.length*100)})}setGroups(e){this._groups.set(e)}updateGroup(e){this._groups.update(t=>t.map(s=>s.id===e.id?n(n({},s),e):s))}addGroup(e){this._groups.update(t=>[...t,e])}removeGroup(e){this._groups.update(t=>t.filter(s=>s.id!==e))}toggleGroupSelection(e){this._selectedGroupIds.update(t=>{let s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})}selectAllGroups(){let e=new Set(this._groups().map(t=>t.id));this._selectedGroupIds.set(e)}deselectAllGroups(){this._selectedGroupIds.set(new Set)}openJoinMonitorDialog(e){this._joinMonitorDialog.set({isOpen:!0,resource:e,selectedAccount:"",enableMonitoring:!1,selectedKeywordSets:[]})}closeJoinMonitorDialog(){this._joinMonitorDialog.update(e=>c(n({},e),{isOpen:!1}))}updateJoinMonitorDialog(e){this._joinMonitorDialog.update(t=>n(n({},t),e))}executeJoinAndMonitor(){let e=this._joinMonitorDialog();if(!e.resource||!e.selectedAccount){this.toast.error("\u8ACB\u9078\u64C7\u5E33\u865F");return}this._isJoining.set(!0),this.ipc.send("join-group",{resourceId:e.resource.id,phone:e.selectedAccount,enableMonitoring:e.enableMonitoring,keywordSetIds:e.selectedKeywordSets}),this.closeJoinMonitorDialog()}openBatchJoinDialog(e){this._batchJoinDialog.set({isOpen:!0,selectedResources:e,selectedAccount:"",enableMonitoring:!1,selectedKeywordSets:[]})}closeBatchJoinDialog(){this._batchJoinDialog.update(e=>c(n({},e),{isOpen:!1}))}updateBatchJoinDialog(e){this._batchJoinDialog.update(t=>n(n({},t),e))}executeBatchJoin(){let e=this._batchJoinDialog();if(e.selectedResources.length===0||!e.selectedAccount){this.toast.error("\u8ACB\u9078\u64C7\u7FA4\u7D44\u548C\u5E33\u865F");return}this._isJoining.set(!0);let t=e.selectedResources.map(s=>({resourceId:s.id,title:s.title,status:"pending"}));this._joinQueue.set(t),this.ipc.send("batch-join-groups",{resourceIds:e.selectedResources.map(s=>s.id),phone:e.selectedAccount,enableMonitoring:e.enableMonitoring,keywordSetIds:e.selectedKeywordSets}),this.closeBatchJoinDialog()}openPostJoinDialog(e,t,s){this._postJoinDialog.set({isOpen:!0,resource:e,phone:t,keywordSetCount:s})}closePostJoinDialog(){this._postJoinDialog.update(e=>c(n({},e),{isOpen:!1}))}postJoinExtractMembers(){let e=this._postJoinDialog();e.resource&&(this.ipc.send("extract-members",{resourceId:e.resource.id,phone:e.phone}),this.closePostJoinDialog(),this.toast.info("\u958B\u59CB\u63D0\u53D6\u6210\u54E1..."))}postJoinSendMessage(){this._postJoinDialog().resource&&this.closePostJoinDialog()}leaveGroup(e,t){confirm(`\u78BA\u5B9A\u8981\u96E2\u958B\u7FA4\u7D44 ${e.title} \u55CE\uFF1F`)&&(this.ipc.send("leave-group",{resourceId:e.id,phone:t}),this.toast.info("\u6B63\u5728\u96E2\u958B\u7FA4\u7D44..."))}stopMonitoring(e){this.ipc.send("stop-monitoring",{resourceId:e.id}),this.toast.info("\u5DF2\u505C\u6B62\u76E3\u63A7")}clearJoinQueue(){this._joinQueue.set([])}updateQueueItemStatus(e,t,s){this._joinQueue.update(u=>u.map(m=>m.resourceId===e?c(n({},m),{status:t,error:s}):m));let i=this._joinQueue();if(i.every(u=>u.status==="joined"||u.status==="failed")){this._isJoining.set(!1);let u=i.filter(y=>y.status==="joined").length,m=i.filter(y=>y.status==="failed").length;m>0?this.toast.warning(`\u5B8C\u6210\uFF1A${u} \u6210\u529F\uFF0C${m} \u5931\u6557`):this.toast.success(`\u6210\u529F\u52A0\u5165 ${u} \u500B\u7FA4\u7D44`)}}handleJoinResult(e){if(this._isJoining.set(!1),e.success){if(this.toast.success("\u6210\u529F\u52A0\u5165\u7FA4\u7D44"),this.updateGroup({id:e.resourceId,joined:!0}),e.phone&&e.keywordSetCount!==void 0){let t=this._groups().find(s=>s.id===e.resourceId);t&&this.openPostJoinDialog(t,e.phone,e.keywordSetCount)}}else this.toast.error(`\u52A0\u5165\u7FA4\u7D44\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}handleBatchJoinProgress(e){this.updateQueueItemStatus(e.resourceId,e.success?"joined":"failed",e.error)}handleLeaveResult(e){e.success?(this.updateGroup({id:e.resourceId,joined:!1}),this.toast.success("\u5DF2\u96E2\u958B\u7FA4\u7D44")):this.toast.error(`\u96E2\u958B\u7FA4\u7D44\u5931\u6557: ${e.error||"\u672A\u77E5\u932F\u8AA4"}`)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var U=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._queueStatuses=r(new Map);this._messages=r([]);this._selectedPhone=r(null);this.queueStatuses=this._queueStatuses.asReadonly();this.messages=this._messages.asReadonly();this.selectedPhone=this._selectedPhone.asReadonly();this._singleMessageDialog=r({isOpen:!1,target:null,targetType:"user",message:"",selectedAccount:""});this._batchMessageDialog=r({isOpen:!1,targets:[],targetType:"user",message:"",selectedAccount:"",delay:5});this.singleMessageDialog=this._singleMessageDialog.asReadonly();this.batchMessageDialog=this._batchMessageDialog.asReadonly();this.totalPending=d(()=>{let e=0;return this._queueStatuses().forEach(t=>{e+=t.pending}),e});this.totalSent=d(()=>{let e=0;return this._queueStatuses().forEach(t=>{e+=t.sent}),e});this.totalFailed=d(()=>{let e=0;return this._queueStatuses().forEach(t=>{e+=t.failed}),e});this.selectedQueueStatus=d(()=>{let e=this._selectedPhone();return e&&this._queueStatuses().get(e)||null});this.selectedQueueMessages=d(()=>{let e=this._selectedPhone();return e?this._messages().filter(t=>t.phone===e):[]})}refreshQueueStatus(e){this.ipc.send("get-queue-status",{phone:e})}setQueueStatuses(e){let t=new Map;for(let s of e)t.set(s.phone,s);this._queueStatuses.set(t)}updateQueueStatus(e){this._queueStatuses.update(t=>{let s=new Map(t);return s.set(e.phone,e),s})}selectQueue(e){this._selectedPhone.set(e),this.loadQueueMessages(e)}loadQueueMessages(e,t,s=100){this.ipc.send("get-queue-messages",{phone:e,status:t,limit:s})}setMessages(e){this._messages.set(e)}retryMessage(e){this.ipc.send("retry-message",{messageId:e}),this.toast.info("\u6B63\u5728\u91CD\u8A66\u767C\u9001...")}cancelMessage(e){this.ipc.send("cancel-message",{messageId:e}),this.toast.info("\u5DF2\u53D6\u6D88\u6D88\u606F")}deleteMessage(e,t){this.ipc.send("delete-queue-message",{phone:e,messageId:t})}updateMessagePriority(e,t,s){this.ipc.send("update-message-priority",{phone:e,messageId:t,priority:s})}pauseQueue(e){this.ipc.send("pause-queue",{phone:e}),this.toast.info("\u968A\u5217\u5DF2\u66AB\u505C")}resumeQueue(e){this.ipc.send("resume-queue",{phone:e}),this.toast.info("\u968A\u5217\u5DF2\u6062\u5FA9")}clearQueue(e,t){confirm(`\u78BA\u5B9A\u8981\u6E05\u7A7A ${e} \u7684${t||"\u6240\u6709"}\u6D88\u606F\u55CE\uFF1F`)&&(this.ipc.send("clear-queue",{phone:e,status:t}),this.toast.info("\u6B63\u5728\u6E05\u7A7A\u968A\u5217..."))}clearPendingQueue(){confirm("\u78BA\u5B9A\u8981\u6E05\u7A7A\u6240\u6709\u5F85\u767C\u9001\u7684\u6D88\u606F\u55CE\uFF1F")&&(this.ipc.send("clear-all-pending"),this.toast.info("\u6B63\u5728\u6E05\u7A7A\u5F85\u767C\u9001\u6D88\u606F..."))}openSingleMessageDialog(e,t){this._singleMessageDialog.set({isOpen:!0,target:e,targetType:t,message:"",selectedAccount:""})}closeSingleMessageDialog(){this._singleMessageDialog.update(e=>c(n({},e),{isOpen:!1}))}updateSingleMessageDialog(e){this._singleMessageDialog.update(t=>n(n({},t),e))}executeSingleMessage(){let e=this._singleMessageDialog();if(!e.target||!e.selectedAccount||!e.message.trim()){this.toast.error("\u8ACB\u586B\u5BEB\u5B8C\u6574\u4FE1\u606F");return}this.ipc.send("send-message",{phone:e.selectedAccount,targetId:e.target.id||e.target.telegram_id,targetType:e.targetType,content:e.message.trim()}),this.closeSingleMessageDialog(),this.toast.success("\u6D88\u606F\u5DF2\u52A0\u5165\u767C\u9001\u968A\u5217")}openBatchMessageDialog(e,t){this._batchMessageDialog.set({isOpen:!0,targets:e,targetType:t,message:"",selectedAccount:"",delay:5})}closeBatchMessageDialog(){this._batchMessageDialog.update(e=>c(n({},e),{isOpen:!1}))}updateBatchMessageDialog(e){this._batchMessageDialog.update(t=>n(n({},t),e))}executeBatchMessage(){let e=this._batchMessageDialog();if(e.targets.length===0||!e.selectedAccount||!e.message.trim()){this.toast.error("\u8ACB\u586B\u5BEB\u5B8C\u6574\u4FE1\u606F");return}this.ipc.send("batch-send-message",{phone:e.selectedAccount,targets:e.targets.map(t=>({id:t.id||t.telegram_id,type:e.targetType})),content:e.message.trim(),delay:e.delay}),this.closeBatchMessageDialog(),this.toast.success(`${e.targets.length} \u689D\u6D88\u606F\u5DF2\u52A0\u5165\u767C\u9001\u968A\u5217`)}sendPrivateMessage(e,t){this.openSingleMessageDialog(e,"user"),this.updateSingleMessageDialog({selectedAccount:t})}batchSendPrivateMessage(e){this.openBatchMessageDialog(e,"user")}sendGroupMessage(e,t){this.openSingleMessageDialog(e,"group"),this.updateSingleMessageDialog({selectedAccount:t})}batchSendGroupMessage(e){this.openBatchMessageDialog(e,"group")}handleQueueStatusUpdate(e){this.setQueueStatuses(e)}handleMessagesLoaded(e){this.setMessages(e)}handleMessageSent(e){this._messages.update(t=>t.map(s=>s.id===e.messageId?c(n({},s),{status:e.success?"sent":"failed",error:e.error,sentAt:e.success?new Date().toISOString():void 0}):s))}handleQueueCleared(e){this.toast.success(`\u5DF2\u6E05\u7A7A ${e.count} \u689D\u6D88\u606F`),this.refreshQueueStatus(e.phone)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var ue=class o{constructor(){this.nav=l(Se);this.ipc=l(v);this.toast=l(h);this.membership=l(R);this.i18n=l(J);this.accounts=l(_e);this.navigation=l(G);this.campaigns=l(K);this.templates=l(z);this.monitoring=l(we);this.leads=l(W);this.groups=l(Y);this.messages=l(U);this._isInitialized=r(!1);this._isLoading=r(!1);this._systemStatus=r(null);this._currentView=r("dashboard");this.isInitialized=this._isInitialized.asReadonly();this.isLoading=this._isLoading.asReadonly();this.systemStatus=this._systemStatus.asReadonly();this.currentView=this._currentView.asReadonly();this.hasOnlineAccounts=d(()=>(this._systemStatus()?.accounts?.online??0)>0);this.isMonitoringActive=d(()=>this._systemStatus()?.monitoring?.active??!1);this.pendingMessages=d(()=>this._systemStatus()?.queue?.pending??0);this.setupNavSync(),this.setupIpcListeners()}setupNavSync(){}setupIpcListeners(){this.ipc.on("accounts-loaded",e=>{this.accounts.setAccounts(e)}),this.ipc.on("account-status-changed",e=>{this.accounts.updateAccount(e)}),this.ipc.on("login-code-required",e=>{this.accounts.handleCodeRequired(e)}),this.ipc.on("login-2fa-required",e=>{this.accounts.handle2FARequired(e)}),this.ipc.on("login-success",e=>{this.accounts.handleLoginSuccess(e)}),this.ipc.on("login-failed",e=>{this.accounts.handleLoginFailed(e)}),this.ipc.on("join-group-result",e=>{this.groups.handleJoinResult(e)}),this.ipc.on("batch-join-progress",e=>{this.groups.handleBatchJoinProgress(e)}),this.ipc.on("queue-status-update",e=>{this.messages.handleQueueStatusUpdate(e)}),this.ipc.on("message-sent",e=>{this.messages.handleMessageSent(e)}),this.ipc.on("system-status",e=>{this._systemStatus.set(e)})}navigateTo(e){this.nav.navigateTo(e)}goBack(){this.navigation.goBack()}goHome(){this.navigateTo("dashboard")}loginAccount(e){this.accounts.loginAccount(e)}logoutAccount(e){this.accounts.logoutAccount(e)}submitLoginCode(){this.accounts.submitLoginCode()}submitLogin2FA(){this.accounts.submitLogin2FA()}cancelLogin(){this.accounts.cancelLogin()}openJoinMonitorDialog(e){this.groups.openJoinMonitorDialog(e)}executeJoinAndMonitor(){this.groups.executeJoinAndMonitor()}openBatchJoinDialog(e){this.groups.openBatchJoinDialog(e)}leaveGroup(e,t){this.groups.leaveGroup(e,t)}openSingleMessageDialog(e,t){this.messages.openSingleMessageDialog(e,t)}openBatchMessageDialog(e,t){this.messages.openBatchMessageDialog(e,t)}pauseQueue(e){this.messages.pauseQueue(e)}resumeQueue(e){this.messages.resumeQueue(e)}startMonitoring(){this.ipc.send("start-monitoring"),this.toast.info("\u6B63\u5728\u555F\u52D5\u76E3\u63A7...")}stopMonitoring(){this.ipc.send("stop-monitoring"),this.toast.info("\u6B63\u5728\u505C\u6B62\u76E3\u63A7...")}loadCampaigns(){this.campaigns.loadCampaigns()}createCampaign(){this.campaigns.createCampaignFromForm()}startCampaign(e){this.campaigns.startCampaign(e)}loadLeads(){this.leads.loadLeads()}selectLead(e){this.leads.selectLead(e)}async initialize(){if(!this._isInitialized()){this._isLoading.set(!0);try{this.ipc.send("get-accounts"),this.ipc.send("get-system-status"),this.ipc.send("get-config"),this._isInitialized.set(!0)}catch(e){console.error("[AppFacade] Initialization failed:",e),this.toast.error("\u61C9\u7528\u521D\u59CB\u5316\u5931\u6557")}finally{this._isLoading.set(!1)}}}refreshSystemStatus(){this.ipc.send("get-system-status")}reloadAll(){this.ipc.send("get-accounts"),this.ipc.send("get-system-status"),this.campaigns.loadCampaigns(),this.templates.loadTemplates(),this.leads.loadLeads(),this.messages.refreshQueueStatus()}t(e,t){return this.i18n.t(e,t)}hasFeature(e){return this.membership.hasFeature(e)}showSuccess(e){this.toast.success(e)}showError(e){this.toast.error(e)}showInfo(e){this.toast.info(e)}loadResources(){this.ipc.send("get-resources")}loadAiSettings(){this.ipc.send("get-ai-settings")}loadMemberList(e){this.ipc.send("get-member-list",{resourceId:e})}loadLogFiles(){this.ipc.send("get-log-files")}loadLogStats(){this.ipc.send("get-log-stats")}loadSchedulerStatus(){this.ipc.send("get-scheduler-status")}loadWarmupDetails(e){this.ipc.send("get-warmup-details",{accountId:e})}searchChannels(e,t){this.ipc.send("search-channels",n({query:e},t))}extractMembers(e,t,s){this.ipc.send("extract-members",n({resourceId:e,phone:t},s)),this.toast.info("\u958B\u59CB\u63D0\u53D6\u6210\u54E1...")}inviteMembers(e,t,s){this.ipc.send("invite-members",{resourceId:e,userIds:t,phone:s}),this.toast.info(`\u6B63\u5728\u9080\u8ACB ${t.length} \u4F4D\u6210\u54E1...`)}generateAiResponse(e,t){this.ipc.send("generate-ai-response",{prompt:e,context:t})}saveAiSettings(e){this.ipc.send("save-ai-settings",e),this.toast.success("AI \u8A2D\u7F6E\u5DF2\u4FDD\u5B58")}testAiConnection(){this.ipc.send("test-ai-connection"),this.toast.info("\u6B63\u5728\u6E2C\u8A66 AI \u9023\u63A5...")}startAutomation(e){this.campaigns.startCampaign(e)}pauseAutomation(e){this.ipc.send("pause-campaign",{campaignId:e}),this.toast.info("\u6B63\u5728\u66AB\u505C\u6D3B\u52D5...")}stopAutomation(e){this.ipc.send("stop-campaign",{campaignId:e}),this.toast.info("\u6B63\u5728\u505C\u6B62\u6D3B\u52D5...")}createBackup(){this.ipc.send("create-backup"),this.toast.info("\u6B63\u5728\u5275\u5EFA\u5099\u4EFD...")}restoreBackup(e){confirm("\u78BA\u5B9A\u8981\u6062\u5FA9\u6B64\u5099\u4EFD\u55CE\uFF1F\u7576\u524D\u6578\u64DA\u5C07\u88AB\u8986\u84CB\u3002")&&(this.ipc.send("restore-backup",{backupId:e}),this.toast.info("\u6B63\u5728\u6062\u5FA9\u5099\u4EFD..."))}getBackups(){this.ipc.send("get-backups")}exportLeads(e="csv"){this.ipc.send("export-leads",{format:e}),this.toast.info("\u6B63\u5728\u5C0E\u51FA\u7DDA\u7D22...")}exportMembers(e,t="csv"){this.ipc.send("export-members",{resourceId:e,format:t}),this.toast.info("\u6B63\u5728\u5C0E\u51FA\u6210\u54E1...")}exportReport(e="daily"){this.ipc.send("export-report",{type:e}),this.toast.info("\u6B63\u5728\u751F\u6210\u5831\u544A...")}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var ge=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._isInitialized=r(!1);this._isLoading=r(!1);this._isIndexing=r(!1);this._stats=r({totalDocuments:0,totalChunks:0,lastIndexed:null,indexSize:"0 KB",categories:{}});this._searchResults=r([]);this._searchQuery=r("");this.isInitialized=this._isInitialized.asReadonly();this.isLoading=this._isLoading.asReadonly();this.isIndexing=this._isIndexing.asReadonly();this.stats=this._stats.asReadonly();this.searchResults=this._searchResults.asReadonly();this.searchQuery=this._searchQuery.asReadonly();this.setupIpcListeners()}setupIpcListeners(){this.ipc.on("rag-initialized",e=>{this._isInitialized.set(e.success),this._isLoading.set(!1),e.success&&(this.toast.success("RAG \u7CFB\u7D71\u521D\u59CB\u5316\u6210\u529F"),this.refreshStats())}),this.ipc.on("rag-stats",e=>{this._stats.set(e),this._isLoading.set(!1)}),this.ipc.on("rag-search-results",e=>{this._searchResults.set(e.results),this._isLoading.set(!1)}),this.ipc.on("rag-indexing-started",()=>{this._isIndexing.set(!0),this.toast.info("\u958B\u59CB\u7D22\u5F15\u77E5\u8B58\u5EAB...")}),this.ipc.on("rag-indexing-completed",e=>{this._isIndexing.set(!1),this.toast.success(`\u7D22\u5F15\u5B8C\u6210\uFF0C\u5171\u8655\u7406 ${e.count} \u500B\u6587\u6A94`),this.refreshStats()}),this.ipc.on("rag-indexing-error",e=>{this._isIndexing.set(!1),this.toast.error(`\u7D22\u5F15\u5931\u6557: ${e.error}`)}),this.ipc.on("rag-knowledge-added",()=>{this.toast.success("\u77E5\u8B58\u5DF2\u6DFB\u52A0"),this.refreshStats()}),this.ipc.on("rag-cleanup-completed",e=>{this.toast.success(`\u5DF2\u6E05\u7406 ${e.removed} \u500B\u904E\u6642\u77E5\u8B58`),this.refreshStats()})}initRagSystem(){this._isLoading.set(!0),this.ipc.send("init-rag-system")}triggerLearning(){this.ipc.send("rag-trigger-learning")}reindexConversations(){this.ipc.send("rag-reindex-conversations")}reindexHighValueConversations(){this.ipc.send("rag-reindex-high-value")}search(e){if(!e.trim()){this._searchResults.set([]);return}this._searchQuery.set(e),this._isLoading.set(!0),this.ipc.send("rag-search",{query:e})}clearSearchResults(){this._searchResults.set([]),this._searchQuery.set("")}addKnowledge(e,t,s){this.ipc.send("rag-add-knowledge",{content:e,category:t,metadata:s})}deleteKnowledge(e){this.ipc.send("rag-delete-knowledge",{id:e})}sendFeedback(e){this.ipc.send("rag-feedback",e),this.toast.success("\u611F\u8B1D\u60A8\u7684\u53CD\u994B\uFF01")}cleanupKnowledge(){this.ipc.send("rag-cleanup")}refreshStats(){this._isLoading.set(!0),this.ipc.send("get-rag-stats")}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Je=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._stats=r({totalMemories:0,totalUsers:0,averagePerUser:0,storageSize:"0 KB",oldestMemory:null,newestMemory:null});this._memories=r([]);this._searchResults=r([]);this._users=r([]);this._isLoading=r(!1);this._selectedUserId=r(null);this.stats=this._stats.asReadonly();this.memories=this._memories.asReadonly();this.searchResults=this._searchResults.asReadonly();this.users=this._users.asReadonly();this.isLoading=this._isLoading.asReadonly();this.selectedUserId=this._selectedUserId.asReadonly();this.userMemories=d(()=>{let e=this._selectedUserId();return e?this._memories().filter(t=>t.userId===e):[]});this.setupIpcListeners()}setupIpcListeners(){this.ipc.on("vector-memory-stats",e=>{this._stats.set(e),this._isLoading.set(!1)}),this.ipc.on("vector-memories-loaded",e=>{this._memories.set(e),this._isLoading.set(!1)}),this.ipc.on("vector-memory-search-results",e=>{this._searchResults.set(e.results),this._isLoading.set(!1)}),this.ipc.on("memory-users-loaded",e=>{this._users.set(e),this._isLoading.set(!1)}),this.ipc.on("vector-memory-added",e=>{this._memories.update(t=>[...t,e]),this.toast.success("\u8A18\u61B6\u5DF2\u6DFB\u52A0")}),this.ipc.on("vector-memory-deleted",e=>{this._memories.update(t=>t.filter(s=>s.id!==e.id)),this.toast.success("\u8A18\u61B6\u5DF2\u522A\u9664")}),this.ipc.on("cleanup-completed",e=>{this.toast.success(`\u5DF2\u6E05\u7406 ${e.removed} \u500B\u904E\u671F\u8A18\u61B6`),this.refreshStats()}),this.ipc.on("merge-completed",e=>{this.toast.success(`\u5DF2\u5408\u4F75 ${e.merged} \u500B\u76F8\u4F3C\u8A18\u61B6`),this.refreshStats()})}search(e,t){if(!e.trim()){this._searchResults.set([]);return}this._isLoading.set(!0),this.ipc.send("search-vector-memory",{query:e,userId:t})}clearSearchResults(){this._searchResults.set([])}addMemory(e,t,s){this.ipc.send("add-vector-memory",{userId:e,content:t,metadata:s})}deleteMemory(e){confirm("\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u8A18\u61B6\u55CE\uFF1F")&&this.ipc.send("delete-vector-memory",{id:e})}loadUserMemories(e){this._selectedUserId.set(e),this._isLoading.set(!0),this.ipc.send("get-user-memories",{userId:e})}loadUserList(){this._isLoading.set(!0),this.ipc.send("get-memory-users")}selectUser(e){this._selectedUserId.set(e),e&&this.loadUserMemories(e)}cleanupOldMemories(e=90){confirm(`\u78BA\u5B9A\u8981\u6E05\u7406 ${e} \u5929\u524D\u7684\u820A\u8A18\u61B6\u55CE\uFF1F`)&&this.ipc.send("cleanup-old-memories",{daysOld:e})}mergeSimilarMemories(e=.9){confirm("\u78BA\u5B9A\u8981\u5408\u4F75\u76F8\u4F3C\u8A18\u61B6\u55CE\uFF1F\u6B64\u64CD\u4F5C\u7121\u6CD5\u64A4\u92B7\u3002")&&this.ipc.send("merge-similar-memories",{threshold:e})}refreshStats(){this._isLoading.set(!0),this.ipc.send("get-vector-memory-stats")}loadAllMemories(){this._isLoading.set(!0),this.ipc.send("get-all-memories")}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var B=[{id:"sys-high-intent",name:"\u9AD8\u610F\u5411\u5BA2\u6236\u8F49\u5316",description:"\u91DD\u5C0D\u610F\u5411\u5206\u6578 \u226580 \u7684\u9AD8\u8CEA\u91CF\u6F5B\u5728\u5BA2\u6236",goalType:"conversion",executionMode:"hybrid",audienceSource:"tags",intentScoreMin:80,roles:["expert","satisfied_customer"],aiHostingEnabled:!0,autoGreeting:!0,autoReply:!0,usageCount:0,successCount:0,totalContacted:0,totalConverted:0,isSystem:!0,isFavorite:!1,createdAt:"2024-01-01T00:00:00Z",updatedAt:"2024-01-01T00:00:00Z"},{id:"sys-win-back",name:"\u6C89\u9ED8\u5BA2\u6236\u559A\u9192",description:"7\u5929\u5167\u7121\u4E92\u52D5\u7684\u8001\u5BA2\u6236\u633D\u56DE\u7B56\u7565",goalType:"retention",executionMode:"hybrid",audienceSource:"recent",intentScoreMin:30,roles:["callback","support","manager"],aiHostingEnabled:!0,autoGreeting:!0,autoReply:!0,usageCount:0,successCount:0,totalContacted:0,totalConverted:0,isSystem:!0,isFavorite:!1,createdAt:"2024-01-01T00:00:00Z",updatedAt:"2024-01-01T00:00:00Z"},{id:"sys-community",name:"\u793E\u7FA4\u6D3B\u8E8D\u5F15\u7206",description:"\u5728\u7FA4\u7D44\u4E2D\u88FD\u9020\u8A71\u984C\uFF0C\u63D0\u5347\u6D3B\u8E8D\u5EA6",goalType:"engagement",executionMode:"scriptless",audienceSource:"group",intentScoreMin:0,roles:["newbie","satisfied_customer","expert"],aiHostingEnabled:!0,autoGreeting:!1,autoReply:!0,usageCount:0,successCount:0,totalContacted:0,totalConverted:0,isSystem:!0,isFavorite:!1,createdAt:"2024-01-01T00:00:00Z",updatedAt:"2024-01-01T00:00:00Z"},{id:"sys-support",name:"\u552E\u5F8C\u670D\u52D9\u97FF\u61C9",description:"\u5FEB\u901F\u97FF\u61C9\u5BA2\u6236\u554F\u984C\uFF0C\u63D0\u5347\u6EFF\u610F\u5EA6",goalType:"support",executionMode:"scripted",audienceSource:"recent",intentScoreMin:0,roles:["support","expert"],aiHostingEnabled:!0,autoGreeting:!1,autoReply:!0,usageCount:0,successCount:0,totalContacted:0,totalConverted:0,isSystem:!0,isFavorite:!1,createdAt:"2024-01-01T00:00:00Z",updatedAt:"2024-01-01T00:00:00Z"}],X=class o{constructor(){this._templates=r([]);this.templates=this._templates.asReadonly();this.userTemplates=d(()=>this._templates().filter(e=>!e.isSystem));this.systemTemplates=d(()=>B);this.favoriteTemplates=d(()=>this._templates().filter(e=>e.isFavorite));this.recommendedTemplates=d(()=>[...this._templates(),...B].filter(t=>t.usageCount>=3).sort((t,s)=>{let i=t.totalContacted>0?t.totalConverted/t.totalContacted:0;return(s.totalContacted>0?s.totalConverted/s.totalContacted:0)-i}).slice(0,5));this.templatesByGoal=d(()=>[...this._templates(),...B].reduce((t,s)=>(t[s.goalType]||(t[s.goalType]=[]),t[s.goalType].push(s),t),{}));this.loadTemplates()}loadTemplates(){try{let e=localStorage.getItem("task_templates");e&&this._templates.set(JSON.parse(e))}catch(e){console.error("\u52A0\u8F09\u6A21\u677F\u5931\u6557:",e)}}saveTemplates(){localStorage.setItem("task_templates",JSON.stringify(this._templates()))}createTemplate(e){let t=c(n({},e),{id:`tpl-${Date.now()}`,usageCount:0,successCount:0,totalContacted:0,totalConverted:0,isSystem:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});return this._templates.update(s=>[...s,t]),this.saveTemplates(),t}createFromTask(e,t,s){return this.createTemplate({name:t,description:s,goalType:e.goalType,executionMode:e.executionMode,audienceSource:e.targetCriteria?.sources?.[0]||"recent",intentScoreMin:e.targetCriteria?.intentScoreMin||50,roles:e.roleConfig?.map(i=>i.roleType),aiHostingEnabled:!0,autoGreeting:!0,autoReply:!0,isFavorite:!1})}updateTemplate(e,t){this._templates.update(s=>s.map(i=>i.id===e?c(n(n({},i),t),{updatedAt:new Date().toISOString()}):i)),this.saveTemplates()}deleteTemplate(e){this._templates.update(t=>t.filter(s=>s.id!==e)),this.saveTemplates()}toggleFavorite(e){this._templates.update(t=>t.map(s=>s.id===e?c(n({},s),{isFavorite:!s.isFavorite}):s)),this.saveTemplates()}recordUsage(e){this._templates.update(t=>t.map(s=>s.id===e?c(n({},s),{usageCount:s.usageCount+1}):s)),this.saveTemplates()}recordResult(e,t,s,i){this._templates.update(a=>a.map(u=>u.id===e?c(n({},u),{totalContacted:u.totalContacted+t,totalConverted:u.totalConverted+s,successCount:i?u.successCount+1:u.successCount}):u)),this.saveTemplates()}getTemplate(e){let t=this._templates().find(s=>s.id===e);return t||B.find(s=>s.id===e)}getSuccessRate(e){return e.totalContacted===0?0:Math.round(e.totalConverted/e.totalContacted*100)}searchTemplates(e){let t=e.toLowerCase();return[...this._templates(),...B].filter(i=>i.name.toLowerCase().includes(t)||i.description?.toLowerCase().includes(t))}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var He=class o{constructor(){this.taskService=l(Te);this.templateService=l(X);this._analysis=r(null);this.analysis=this._analysis.asReadonly();this.lastAnalysisTime=0;this.CACHE_DURATION=300*1e3;this.analyzeHistory()}async analyzeHistory(){let e=Date.now();if(this._analysis()&&e-this.lastAnalysisTime<this.CACHE_DURATION)return this._analysis();let t=this.taskService.tasks(),s=t.filter(f=>f.status==="completed"),i={totalTasks:t.length,successfulTasks:s.filter(f=>f.stats.converted>0).length,avgConversionRate:0,byGoal:{},bestHours:[],topConfigs:[]},a=s.reduce((f,w)=>f+w.stats.contacted,0),u=s.reduce((f,w)=>f+w.stats.converted,0);i.avgConversionRate=a>0?u/a*100:0;let m=["conversion","retention","engagement","support"];for(let f of m){let w=s.filter(M=>M.goalType===f),j=w.reduce((M,x)=>M+x.stats.contacted,0),O=w.reduce((M,x)=>M+x.stats.converted,0),N=new Map;w.forEach(M=>{let x=N.get(M.executionMode)||{contacted:0,converted:0};N.set(M.executionMode,{contacted:x.contacted+M.stats.contacted,converted:x.converted+M.stats.converted})});let me="hybrid",he=0;N.forEach((M,x)=>{let V=M.contacted>0?M.converted/M.contacted:0;V>he&&(he=V,me=x)});let Z=new Map;w.forEach(M=>{M.roleConfig?.forEach(x=>{let V=Z.get(x.roleType)||0;Z.set(x.roleType,V+(M.stats.converted>0?1:0))})});let ve=Array.from(Z.entries()).sort((M,x)=>x[1]-M[1]).slice(0,3).map(([M])=>M);i.byGoal[f]={count:w.length,avgConversionRate:j>0?O/j*100:0,bestExecutionMode:me,bestRoles:ve.length>0?ve:E[f].suggestedRoles}}let y=new Array(24).fill(0),S=new Array(24).fill(0);s.forEach(f=>{let w=new Date(f.createdAt).getHours();y[w]++,f.stats.converted>0&&S[w]++});let p=y.map((f,w)=>({hour:w,rate:f>0?S[w]/f:0}));i.bestHours=p.sort((f,w)=>w.rate-f.rate).slice(0,3).map(f=>f.hour);let _=new Map;return s.forEach(f=>{let w=f.roleConfig?.map(N=>N.roleType).sort().join(",")||"",j=`${f.goalType}|${f.executionMode}|${w}`,O=_.get(j)||{goalType:f.goalType,executionMode:f.executionMode,roles:f.roleConfig?.map(N=>N.roleType)||[],contacted:0,converted:0,count:0};_.set(j,c(n({},O),{contacted:O.contacted+f.stats.contacted,converted:O.converted+f.stats.converted,count:O.count+1}))}),i.topConfigs=Array.from(_.values()).filter(f=>f.count>=2).map(f=>({goalType:f.goalType,executionMode:f.executionMode,roles:f.roles,conversionRate:f.contacted>0?f.converted/f.contacted*100:0,sampleSize:f.count})).sort((f,w)=>w.conversionRate-f.conversionRate).slice(0,5),this._analysis.set(i),this.lastAnalysisTime=e,i}getRecommendations(){let e=[],t=this._analysis();if(!t||t.totalTasks<3)return e.push({id:"new-user-conversion",type:"goal",title:"\u958B\u59CB\u60A8\u7684\u7B2C\u4E00\u500B\u8F49\u5316\u4EFB\u52D9",description:"\u300C\u4FC3\u9032\u9996\u55AE\u300D\u662F\u6700\u5E38\u7528\u7684\u71DF\u92B7\u76EE\u6A19",confidence:80,reason:"\u57FA\u65BC\u7CFB\u7D71\u9ED8\u8A8D\u63A8\u85A6",action:{label:"\u5275\u5EFA\u4EFB\u52D9",data:{goalType:"conversion"}}}),e;if(t.topConfigs.length>0){let a=t.topConfigs[0];e.push({id:"best-config",type:"goal",title:"\u4F7F\u7528\u60A8\u7684\u6700\u4F73\u914D\u7F6E",description:`${E[a.goalType].label} + ${this.getModeLabel(a.executionMode)}`,confidence:Math.min(90,50+a.sampleSize*10),reason:`\u6B77\u53F2\u8F49\u5316\u7387 ${a.conversionRate.toFixed(1)}%\uFF08${a.sampleSize} \u6B21\u4EFB\u52D9\uFF09`,action:{label:"\u4F7F\u7528\u6B64\u914D\u7F6E",data:a}})}let i=Object.entries(t.byGoal).filter(([a,u])=>u.count>=2).sort((a,u)=>u[1].avgConversionRate-a[1].avgConversionRate)[0];if(i){let[a,u]=i;e.push({id:"best-goal",type:"goal",title:`${E[a].label} \u8868\u73FE\u6700\u4F73`,description:`\u5E73\u5747\u8F49\u5316\u7387 ${u.avgConversionRate.toFixed(1)}%`,confidence:Math.min(85,40+u.count*5),reason:`\u57FA\u65BC ${u.count} \u6B21\u6B77\u53F2\u4EFB\u52D9\u5206\u6790`})}if(t.bestHours.length>0){let a=t.bestHours.map(u=>`${u}:00`).join("\u3001");e.push({id:"best-timing",type:"timing",title:"\u6700\u4F73\u555F\u52D5\u6642\u6BB5",description:a,confidence:70,reason:"\u9019\u4E9B\u6642\u6BB5\u7684\u4EFB\u52D9\u6210\u529F\u7387\u8F03\u9AD8"})}return e}getSuggestionForGoal(e){let s=this._analysis()?.byGoal[e],i=E[e];return!s||s.count<2?{goalType:e,executionMode:i.suggestedMode,suggestedRoles:i.suggestedRoles,intentThreshold:70,audienceSource:"recent",reason:"\u57FA\u65BC\u7CFB\u7D71\u9ED8\u8A8D\u63A8\u85A6",expectedConversionRate:15}:{goalType:e,executionMode:s.bestExecutionMode,suggestedRoles:s.bestRoles,intentThreshold:60,audienceSource:"tags",reason:`\u57FA\u65BC ${s.count} \u6B21\u6B77\u53F2\u4EFB\u52D9\u5206\u6790`,expectedConversionRate:Math.round(s.avgConversionRate)}}getNextBestAction(){let t=this.taskService.tasks().filter(a=>a.status==="running");if(t.length===0){let a=this._analysis();if(a&&a.topConfigs.length>0){let u=a.topConfigs[0];return{goalType:u.goalType,reason:`\u60A8\u7684\u300C${E[u.goalType].label}\u300D\u4EFB\u52D9\u6B77\u53F2\u8868\u73FE\u6700\u4F73`}}return{goalType:"conversion",reason:"\u958B\u59CB\u4E00\u500B\u65B0\u7684\u8F49\u5316\u4EFB\u52D9"}}let s=new Set(t.map(a=>a.goalType)),i=["conversion","retention","engagement","support"].filter(a=>!s.has(a));if(i.length>0){let a=this._analysis();if(a){let u=i.filter(m=>a.byGoal[m]?.count>0).sort((m,y)=>a.byGoal[y].avgConversionRate-a.byGoal[m].avgConversionRate)[0];if(u)return{goalType:u,reason:`\u88DC\u5145\u4E00\u500B\u300C${E[u].label}\u300D\u4EFB\u52D9\u4EE5\u8986\u84CB\u66F4\u591A\u5834\u666F`}}}return null}getModeLabel(e){return{scripted:"\u5287\u672C\u6A21\u5F0F",hybrid:"\u6DF7\u5408\u6A21\u5F0F",scriptless:"\u7121\u5287\u672C\u6A21\u5F0F"}[e]}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var qe=class o{constructor(){this.ipc=l(v);this._logs=r([]);this.logs=this._logs.asReadonly();this._isLive=r(!0);this.isLive=this._isLive.asReadonly();this._filter=r({});this.filter=this._filter.asReadonly();this.MAX_LOGS=1e3;this.filteredLogs=d(()=>{let e=this._logs(),t=this._filter();return e.filter(s=>{if(t.taskId&&s.taskId!==t.taskId||t.level&&s.level!==t.level||t.category&&s.category!==t.category)return!1;if(t.search){let i=t.search.toLowerCase();if(!s.message.toLowerCase().includes(i)&&!s.category.toLowerCase().includes(i))return!1}return!(t.startTime&&s.timestamp<t.startTime||t.endTime&&s.timestamp>t.endTime)})});this.logsByTask=d(()=>{let e=this._logs(),t=new Map;return e.forEach(s=>{t.has(s.taskId)||t.set(s.taskId,[]),t.get(s.taskId).push(s)}),t});this.stats=d(()=>{let e=this._logs();return{total:e.length,debug:e.filter(t=>t.level==="debug").length,info:e.filter(t=>t.level==="info").length,success:e.filter(t=>t.level==="success").length,warning:e.filter(t=>t.level==="warning").length,error:e.filter(t=>t.level==="error").length}});this.setupIpcListeners()}setupIpcListeners(){this.ipc.on("execution-log",e=>{this._isLive()&&this.addLog(e)}),this.ipc.on("execution-logs-batch",e=>{this._isLive()&&e.forEach(t=>this.addLog(t))})}addLog(e){let t=c(n({},e),{id:`log-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:new Date().toISOString()});this._logs.update(s=>{let i=[t,...s];return i.length>this.MAX_LOGS?i.slice(0,this.MAX_LOGS):i})}debug(e,t,s,i){this.addLog({taskId:e,level:"debug",category:t,message:s,details:i})}info(e,t,s,i){this.addLog({taskId:e,level:"info",category:t,message:s,details:i})}success(e,t,s,i){this.addLog({taskId:e,level:"success",category:t,message:s,details:i})}warning(e,t,s,i){this.addLog({taskId:e,level:"warning",category:t,message:s,details:i})}error(e,t,s,i){this.addLog({taskId:e,level:"error",category:t,message:s,details:i})}setFilter(e){this._filter.set(e)}updateFilter(e){this._filter.update(t=>n(n({},t),e))}clearFilter(){this._filter.set({})}toggleLive(){this._isLive.update(e=>!e)}setLive(e){this._isLive.set(e)}clearLogs(){this._logs.set([])}clearTaskLogs(e){this._logs.update(t=>t.filter(s=>s.taskId!==e))}getTaskLogs(e){return this._logs().filter(t=>t.taskId===e)}exportLogs(e="json"){let t=this.filteredLogs(),s,i,a;if(e==="json")s=JSON.stringify(t,null,2),i=`execution-logs-${new Date().toISOString().split("T")[0]}.json`,a="application/json";else{let S=["\u6642\u9593","\u4EFB\u52D9ID","\u7D1A\u5225","\u985E\u5225","\u6D88\u606F"],p=t.map(_=>[_.timestamp,_.taskId,_.level,_.category,`"${_.message.replace(/"/g,'""')}"`].join(","));s=[S.join(","),...p].join(`
`),i=`execution-logs-${new Date().toISOString().split("T")[0]}.csv`,a="text/csv"}let u=new Blob([s],{type:a}),m=URL.createObjectURL(u),y=document.createElement("a");y.href=m,y.download=i,y.click(),URL.revokeObjectURL(m)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var it={timeout:3e4,retries:3,retryDelay:1e3,cache:!1,cacheDuration:6e4,showError:!0,showLoading:!1},Ke=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._isLoading=r(!1);this.isLoading=this._isLoading.asReadonly();this._pendingRequests=r(0);this.pendingRequests=this._pendingRequests.asReadonly();this.cache=new Map;this.pendingPromises=new Map}async request(e,t,s={}){let i=n(n({},it),s),a=`${e}:${JSON.stringify(t)}`;if(i.cache){let m=this.getFromCache(a);if(m)return{success:!0,data:m}}if(this.pendingPromises.has(a))return this.pendingPromises.get(a);let u=this.executeRequest(e,t,i,a);this.pendingPromises.set(a,u);try{return await u}finally{this.pendingPromises.delete(a)}}async executeRequest(e,t,s,i){this._pendingRequests.update(m=>m+1),s.showLoading&&this._isLoading.set(!0);let a;for(let m=0;m<=s.retries;m++)try{let y=await this.sendIpcRequest(e,t,s.timeout);return y.success&&s.cache&&this.setCache(i,y.data,s.cacheDuration),y}catch(y){a=y,m<s.retries&&await this.delay(s.retryDelay*(m+1))}let u={success:!1,error:{code:"REQUEST_FAILED",message:a?.message||"\u8ACB\u6C42\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u91CD\u8A66",details:a}};return s.showError&&this.toast.error(u.error.message),u}sendIpcRequest(e,t,s){return new Promise((i,a)=>{let u=setTimeout(()=>{a(new Error("\u8ACB\u6C42\u8D85\u6642"))},s);this.ipc.invoke(e,t).then(m=>{clearTimeout(u),typeof m=="object"&&"success"in m?i(m):i({success:!0,data:m})}).catch(m=>{clearTimeout(u),a(m)}).finally(()=>{this._pendingRequests.update(m=>Math.max(0,m-1)),this._pendingRequests()===0&&this._isLoading.set(!1)})})}getFromCache(e){let t=this.cache.get(e);return t?Date.now()-t.timestamp>t.duration?(this.cache.delete(e),null):t.data:null}setCache(e,t,s){this.cache.set(e,{data:t,timestamp:Date.now(),duration:s})}clearCache(e){if(!e){this.cache.clear();return}let t=new RegExp(e);for(let s of this.cache.keys())t.test(s)&&this.cache.delete(s)}async preload(e,t){await this.request(e,t,{cache:!0,showError:!1})}async get(e,t,s){return this.request(e,n({action:"get"},t),n({cache:!0},s))}async post(e,t,s){return this.request(e,n({action:"create"},t),n({cache:!1},s))}async put(e,t,s){return this.request(e,n({action:"update"},t),n({cache:!1},s))}async delete(e,t,s){return this.request(e,n({action:"delete"},t),n({cache:!1},s))}delay(e){return new Promise(t=>setTimeout(t,e))}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var ze=class o{constructor(){this.ipc=l(v);this.toast=l(h);this._state=r("disconnected");this.state=this._state.asReadonly();this.isConnected=d(()=>this._state()==="connected");this._reconnectAttempts=r(0);this.reconnectAttempts=this._reconnectAttempts.asReadonly();this._lastHeartbeat=r(null);this.lastHeartbeat=this._lastHeartbeat.asReadonly();this.subscriptions=new Map;this.HEARTBEAT_INTERVAL=3e4;this.RECONNECT_DELAY=5e3;this.MAX_RECONNECT_ATTEMPTS=10;this.setupIpcListeners(),this.connect()}ngOnDestroy(){this.disconnect()}setupIpcListeners(){this.ipc.on("realtime:data",e=>{this.handleRealtimeData(e.type,e.data)}),this.ipc.on("realtime:state",e=>{this._state.set(e),e==="connected"?(this._reconnectAttempts.set(0),this.startHeartbeat(),this.resubscribeAll()):e==="disconnected"&&(this.stopHeartbeat(),this.scheduleReconnect())}),this.ipc.on("realtime:heartbeat",()=>{this._lastHeartbeat.set(new Date)}),this.ipc.on("realtime:error",e=>{console.error("Realtime error:",e),e.code==="AUTH_FAILED"&&this.toast.error("\u5BE6\u6642\u9023\u63A5\u8A8D\u8B49\u5931\u6557")})}connect(){this._state()==="connecting"||this._state()==="connected"||(this._state.set("connecting"),this.ipc.send("realtime:connect",{}))}disconnect(){this.stopHeartbeat(),this.clearReconnectTimeout(),this.ipc.send("realtime:disconnect",{}),this._state.set("disconnected")}subscribe(e,t,s){let i=`sub-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,a={id:i,type:e,callback:t,options:s};return this.subscriptions.set(i,a),this.isConnected()&&this.sendSubscription(a),i}unsubscribe(e){let t=this.subscriptions.get(e);t&&(this.subscriptions.delete(e),this.isConnected()&&this.ipc.send("realtime:unsubscribe",{id:e,type:t.type}))}unsubscribeAll(){for(let e of this.subscriptions.keys())this.unsubscribe(e)}sendSubscription(e){this.ipc.send("realtime:subscribe",{id:e.id,type:e.type,filter:e.options?.filter})}resubscribeAll(){for(let e of this.subscriptions.values())this.sendSubscription(e)}handleRealtimeData(e,t){for(let s of this.subscriptions.values())if(s.type===e){if(s.options?.filter){let i=s.options.filter,a=!0;for(let[u,m]of Object.entries(i))if(t[u]!==m){a=!1;break}if(!a)continue}try{s.callback(t)}catch(i){console.error("Subscription callback error:",i)}}}startHeartbeat(){this.stopHeartbeat(),this.heartbeatInterval=setInterval(()=>{this.isConnected()&&this.ipc.send("realtime:heartbeat",{})},this.HEARTBEAT_INTERVAL)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=void 0)}scheduleReconnect(){if(this._reconnectAttempts()>=this.MAX_RECONNECT_ATTEMPTS){this.toast.error("\u7121\u6CD5\u5EFA\u7ACB\u5BE6\u6642\u9023\u63A5\uFF0C\u8ACB\u6AA2\u67E5\u7DB2\u7D61");return}this.clearReconnectTimeout();let e=this.RECONNECT_DELAY*Math.pow(1.5,this._reconnectAttempts());this.reconnectTimeout=setTimeout(()=>{this._reconnectAttempts.update(t=>t+1),this._state.set("reconnecting"),this.connect()},e)}clearReconnectTimeout(){this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}subscribeTaskStatus(e,t){return this.subscribe("task:status",t,{filter:{taskId:e}})}subscribeTaskStats(e,t){return this.subscribe("task:stats",t,{filter:{taskId:e}})}subscribeTaskLogs(e,t){return this.subscribe("task:log",t,{filter:{taskId:e}})}subscribeAllTaskLogs(e){return this.subscribe("task:log",e)}subscribeNewMessages(e){return this.subscribe("message:new",e)}subscribeSystemStatus(e){return this.subscribe("system:status",e)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var We=class o{constructor(){this.ipc=l(v);this.aiService=l(Me);this._isGenerating=r(!1);this.isGenerating=this._isGenerating.asReadonly();this._recentResults=r([]);this.recentResults=this._recentResults.asReadonly();this._savedTemplates=r([]);this.savedTemplates=this._savedTemplates.asReadonly();this.systemTemplates=[{id:"sys-greeting-1",name:"\u53CB\u597D\u554F\u5019",type:"greeting",style:"friendly",template:"\u55E8 {customerName}\uFF01\u6211\u662F{productName}\u7684{role}\u3002\u770B\u5230\u60A8\u5C0D\u6211\u5011\u7522\u54C1\u6709\u8208\u8DA3\uFF0C\u60F3\u4E86\u89E3\u66F4\u591A\u55CE\uFF1F\u{1F60A}",variables:["customerName","productName","role"],examples:["\u55E8 \u738B\u5148\u751F\uFF01\u6211\u662F\u667A\u80FD\u884C\u92B7\u52A9\u624B\u7684\u7522\u54C1\u9867\u554F\u3002\u770B\u5230\u60A8\u5C0D\u6211\u5011\u7522\u54C1\u6709\u8208\u8DA3\uFF0C\u60F3\u4E86\u89E3\u66F4\u591A\u55CE\uFF1F\u{1F60A}"],isSystem:!0},{id:"sys-greeting-2",name:"\u5C08\u696D\u958B\u5834",type:"greeting",style:"professional",template:"\u60A8\u597D\uFF0C{customerName}\u3002\u6211\u662F{company}\u7684{role}\uFF0C\u5F88\u9AD8\u8208\u70BA\u60A8\u670D\u52D9\u3002\u8ACB\u554F\u6709\u4EC0\u9EBC\u53EF\u4EE5\u5E6B\u52A9\u60A8\u7684\u55CE\uFF1F",variables:["customerName","company","role"],examples:["\u60A8\u597D\uFF0C\u5F35\u7D93\u7406\u3002\u6211\u662FABC\u516C\u53F8\u7684\u696D\u52D9\u9867\u554F\uFF0C\u5F88\u9AD8\u8208\u70BA\u60A8\u670D\u52D9\u3002\u8ACB\u554F\u6709\u4EC0\u9EBC\u53EF\u4EE5\u5E6B\u52A9\u60A8\u7684\u55CE\uFF1F"],isSystem:!0},{id:"sys-objection-1",name:"\u50F9\u683C\u7570\u8B70",type:"objection",style:"empathetic",template:"\u5B8C\u5168\u7406\u89E3\u60A8\u7684\u8003\u616E\uFF01\u5F88\u591A\u5BA2\u6236\u4E00\u958B\u59CB\u4E5F\u6709\u540C\u6A23\u7684\u60F3\u6CD5\u3002\u4E0D\u904E\u5BE6\u969B\u4F7F\u7528\u5F8C\uFF0C\u4ED6\u5011\u767C\u73FE{benefit}\uFF0C\u6295\u8CC7\u56DE\u5831\u5176\u5BE6\u5F88\u53EF\u89C0\u3002\u8981\u4E0D\u6211\u5206\u4EAB\u5E7E\u500B\u6210\u529F\u6848\u4F8B\u7D66\u60A8\u770B\u770B\uFF1F",variables:["benefit"],examples:["\u5B8C\u5168\u7406\u89E3\u60A8\u7684\u8003\u616E\uFF01\u5F88\u591A\u5BA2\u6236\u4E00\u958B\u59CB\u4E5F\u6709\u540C\u6A23\u7684\u60F3\u6CD5\u3002\u4E0D\u904E\u5BE6\u969B\u4F7F\u7528\u5F8C\uFF0C\u4ED6\u5011\u767C\u73FE\u6548\u7387\u63D0\u5347\u4E863\u500D\uFF0C\u6295\u8CC7\u56DE\u5831\u5176\u5BE6\u5F88\u53EF\u89C0\u3002\u8981\u4E0D\u6211\u5206\u4EAB\u5E7E\u500B\u6210\u529F\u6848\u4F8B\u7D66\u60A8\u770B\u770B\uFF1F"],isSystem:!0},{id:"sys-closing-1",name:"\u9650\u6642\u512A\u60E0",type:"closing",style:"urgent",template:"\u5C0D\u4E86\uFF0C\u73FE\u5728\u6B63\u597D\u6709{promotion}\u6D3B\u52D5\uFF0C{deadline}\u622A\u6B62\uFF01\u9019\u500B\u6642\u5019\u5165\u624B\u771F\u7684\u5F88\u5212\u7B97\u3002\u9700\u8981\u6211\u5E6B\u60A8\u9396\u5B9A\u540D\u984D\u55CE\uFF1F",variables:["promotion","deadline"],examples:["\u5C0D\u4E86\uFF0C\u73FE\u5728\u6B63\u597D\u6709\u5E74\u7D42\u7279\u60E0\u6D3B\u52D5\uFF0C\u672C\u6708\u5E95\u622A\u6B62\uFF01\u9019\u500B\u6642\u5019\u5165\u624B\u771F\u7684\u5F88\u5212\u7B97\u3002\u9700\u8981\u6211\u5E6B\u60A8\u9396\u5B9A\u540D\u984D\u55CE\uFF1F"],isSystem:!0},{id:"sys-followup-1",name:"\u6EAB\u67D4\u8DDF\u9032",type:"follow_up",style:"friendly",template:"\u55E8 {customerName}\uFF0C\u597D\u4E45\u4E0D\u898B\uFF01\u4E0A\u6B21\u804A\u5230{topic}\uFF0C\u4E0D\u77E5\u9053\u60A8\u5F8C\u4F86\u8003\u616E\u5F97\u600E\u9EBC\u6A23\u4E86\uFF1F\u6709\u4EFB\u4F55\u554F\u984C\u90FD\u53EF\u4EE5\u96A8\u6642\u554F\u6211\u54E6\uFF5E",variables:["customerName","topic"],examples:["\u55E8 \u674E\u5C0F\u59D0\uFF0C\u597D\u4E45\u4E0D\u898B\uFF01\u4E0A\u6B21\u804A\u5230\u5347\u7D1A\u65B9\u6848\uFF0C\u4E0D\u77E5\u9053\u60A8\u5F8C\u4F86\u8003\u616E\u5F97\u600E\u9EBC\u6A23\u4E86\uFF1F\u6709\u4EFB\u4F55\u554F\u984C\u90FD\u53EF\u4EE5\u96A8\u6642\u554F\u6211\u54E6\uFF5E"],isSystem:!0},{id:"sys-retention-1",name:"\u633D\u56DE\u6D41\u5931",type:"retention",style:"empathetic",template:"{customerName}\uFF0C\u597D\u4E45\u6C92\u770B\u5230\u60A8\u4E86\uFF0C\u6709\u9EDE\u60F3\u5FF5\u5462\uFF01\u662F\u4E0D\u662F\u6700\u8FD1\u592A\u5FD9\u4E86\uFF1F\u6211\u5011\u6700\u8FD1\u63A8\u51FA\u4E86{newFeature}\uFF0C\u89BA\u5F97\u7279\u5225\u9069\u5408\u60A8\uFF0C\u8981\u4E0D\u8981\u4F86\u770B\u770B\uFF1F",variables:["customerName","newFeature"],examples:["\u738B\u5148\u751F\uFF0C\u597D\u4E45\u6C92\u770B\u5230\u60A8\u4E86\uFF0C\u6709\u9EDE\u60F3\u5FF5\u5462\uFF01\u662F\u4E0D\u662F\u6700\u8FD1\u592A\u5FD9\u4E86\uFF1F\u6211\u5011\u6700\u8FD1\u63A8\u51FA\u4E86\u667A\u80FD\u5831\u8868\u529F\u80FD\uFF0C\u89BA\u5F97\u7279\u5225\u9069\u5408\u60A8\uFF0C\u8981\u4E0D\u8981\u4F86\u770B\u770B\uFF1F"],isSystem:!0}];this.loadSavedTemplates()}async generate(e){this._isGenerating.set(!0);try{let t=e.options?.count||3,s=[],i=this.buildPrompt(e),a=await this.ipc.invoke("ai-generate-text",{prompt:i,maxTokens:e.options?.maxLength||200,count:t});if(a.success&&a.texts){for(let u of a.texts){let m={id:`copy-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,text:this.postProcess(u,e),type:e.type,style:e.style||"friendly",score:this.evaluateQuality(u,e),tags:this.extractTags(e),createdAt:new Date().toISOString()};s.push(m)}this._recentResults.update(u=>[...s,...u].slice(0,50))}else{let u=this.getTemplatesForType(e.type);for(let m of u.slice(0,t)){let y={id:`copy-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,text:this.applyTemplate(m,e.context||{}),type:e.type,style:m.style,score:70,tags:["\u6A21\u677F"],createdAt:new Date().toISOString()};s.push(y)}}return s}finally{this._isGenerating.set(!1)}}async optimize(e,t){this._isGenerating.set(!0);try{let s=`\u8ACB\u5C07\u4EE5\u4E0B\u8A71\u8853\u512A\u5316\u70BA${this.getStyleDescription(t)}\u98A8\u683C\uFF0C\u4FDD\u6301\u539F\u610F\u4F46\u66F4\u6709\u5438\u5F15\u529B\uFF1A

\u539F\u6587\uFF1A${e}

\u512A\u5316\u5F8C\uFF1A`,i=await this.ipc.invoke("ai-generate-text",{prompt:s,maxTokens:300,count:1});return i.success&&i.texts?.[0]?i.texts[0]:e}finally{this._isGenerating.set(!1)}}async suggestReply(e,t){return this.generate({type:"reply",style:"friendly",context:{previousMessages:[e,...t?.previousMessages||[]]},options:{count:3}})}getAllTemplates(){return[...this.systemTemplates,...this._savedTemplates()]}getTemplatesForType(e){return this.getAllTemplates().filter(t=>t.type===e)}saveTemplate(e){let t=c(n({},e),{id:`tpl-${Date.now()}`,isSystem:!1});this._savedTemplates.update(s=>[...s,t]),this.persistTemplates()}deleteTemplate(e){this._savedTemplates.update(t=>t.filter(s=>s.id!==e)),this.persistTemplates()}applyTemplate(e,t){let s=e.template;for(let[i,a]of Object.entries(t))s=s.replace(new RegExp(`{${i}}`,"g"),a||"");return s=s.replace(/\{[^}]+\}/g,""),s.trim()}buildPrompt(e){let t={greeting:"\u751F\u6210\u958B\u5834\u767D/\u554F\u5019\u8A9E",reply:"\u751F\u6210\u56DE\u8986\u6D88\u606F",follow_up:"\u751F\u6210\u8DDF\u9032\u6D88\u606F",objection:"\u751F\u6210\u7570\u8B70\u8655\u7406\u8A71\u8853",closing:"\u751F\u6210\u4FC3\u6210\u6210\u4EA4\u8A71\u8853",retention:"\u751F\u6210\u633D\u56DE\u5BA2\u6236\u8A71\u8853"},s=e.style?`\u98A8\u683C\u8981\u6C42\uFF1A${this.getStyleDescription(e.style)}`:"",i=`\u4F5C\u70BA\u5C08\u696D\u7684\u92B7\u552E\u8A71\u8853\u5C08\u5BB6\uFF0C\u8ACB${t[e.type]}\u3002

${s}

`;return e.context?.productName&&(i+=`\u7522\u54C1/\u670D\u52D9\uFF1A${e.context.productName}
`),e.context?.customerName&&(i+=`\u5BA2\u6236\u7A31\u547C\uFF1A${e.context.customerName}
`),e.context?.previousMessages?.length&&(i+=`
\u5C0D\u8A71\u4E0A\u4E0B\u6587\uFF1A
${e.context.previousMessages.join(`
`)}
`),e.context?.objection&&(i+=`
\u5BA2\u6236\u7570\u8B70\uFF1A${e.context.objection}
`),e.context?.goal&&(i+=`
\u76EE\u6A19\uFF1A${e.context.goal}
`),i+=`
\u8981\u6C42\uFF1A
1. \u81EA\u7136\u53E3\u8A9E\u5316\uFF0C\u4E0D\u8981\u592A\u751F\u786C
2. \u7C21\u6F54\u6709\u529B\uFF0C\u4E0D\u8981\u592A\u9577
3. \u6709\u89AA\u548C\u529B\uFF0C\u8B93\u5BA2\u6236\u611F\u5230\u8212\u9069
${e.options?.includeEmoji?"4. \u9069\u7576\u4F7F\u7528\u8868\u60C5\u7B26\u865F":""}

\u8ACB\u76F4\u63A5\u7D66\u51FA\u8A71\u8853\uFF0C\u4E0D\u9700\u8981\u89E3\u91CB\uFF1A`,i}getStyleDescription(e){return{professional:"\u5C08\u696D\u6B63\u5F0F\uFF0C\u7528\u8A5E\u7CBE\u6E96\uFF0C\u7D66\u4EBA\u4FE1\u8CF4\u611F",friendly:"\u89AA\u5207\u53CB\u597D\uFF0C\u50CF\u670B\u53CB\u804A\u5929\u4E00\u6A23\u81EA\u7136",casual:"\u8F15\u9B06\u96A8\u610F\uFF0C\u53E3\u8A9E\u5316\uFF0C\u4E0D\u62D8\u8B39",urgent:"\u5E36\u6709\u9069\u5EA6\u7DCA\u8FEB\u611F\uFF0C\u4FC3\u9032\u6C7A\u7B56",empathetic:"\u5BCC\u6709\u540C\u7406\u5FC3\uFF0C\u7406\u89E3\u5BA2\u6236\u8655\u5883"}[e]}postProcess(e,t){let s=e.trim();return s.startsWith('"')&&s.endsWith('"')&&(s=s.slice(1,-1)),t.context?.customerName&&(s=s.replace(/\{customerName\}/g,t.context.customerName)),t.context?.productName&&(s=s.replace(/\{productName\}/g,t.context.productName)),s}evaluateQuality(e,t){let s=70;return e.length>=20&&e.length<=200&&(s+=10),t.options?.includeEmoji&&/[\u{1F300}-\u{1F9FF}]/u.test(e)&&(s+=5),(e.includes("\uFF1F")||e.includes("?"))&&(s+=5),t.context?.customerName&&e.includes(t.context.customerName)&&(s+=5),Math.min(100,s)}extractTags(e){let t=[e.type];return e.style&&t.push(e.style),e.options?.includeEmoji&&t.push("emoji"),e.context?.productName&&t.push("\u7522\u54C1\u76F8\u95DC"),t}loadSavedTemplates(){try{let e=localStorage.getItem("copywriting_templates");e&&this._savedTemplates.set(JSON.parse(e))}catch(e){console.error("Failed to load templates:",e)}}persistTemplates(){localStorage.setItem("copywriting_templates",JSON.stringify(this._savedTemplates()))}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Ye=class o{constructor(){this._isActive=r(!1);this.isActive=this._isActive.asReadonly();this._currentTour=r(null);this.currentTour=this._currentTour.asReadonly();this._currentStepIndex=r(0);this.currentStepIndex=this._currentStepIndex.asReadonly();this._progress=r(new Map);this.currentStep=d(()=>{let e=this._currentTour(),t=this._currentStepIndex();return e?.steps[t]||null});this.totalSteps=d(()=>this._currentTour()?.steps.length||0);this.progressPercent=d(()=>{let e=this.totalSteps();return e===0?0:Math.round(this._currentStepIndex()/e*100)});this.tours=[{id:"welcome",name:"\u6B61\u8FCE\u4F7F\u7528",description:"\u5FEB\u901F\u4E86\u89E3\u7CFB\u7D71\u7684\u6838\u5FC3\u529F\u80FD",trigger:"first_visit",version:1,steps:[{id:"welcome-intro",title:"\u6B61\u8FCE\u4F7F\u7528\u667A\u80FD\u71DF\u92B7\u7CFB\u7D71\uFF01 \u{1F389}",description:"\u9019\u662F\u60A8\u7684\u667A\u80FD\u71DF\u92B7\u52A9\u624B\uFF0C\u8B93\u6211\u5011\u82B12\u5206\u9418\u5FEB\u901F\u4E86\u89E3\u6838\u5FC3\u529F\u80FD\u3002",position:"center",skipable:!0},{id:"welcome-accounts",title:"1. \u6DFB\u52A0\u5E33\u865F",description:"\u9996\u5148\uFF0C\u60A8\u9700\u8981\u6DFB\u52A0 Telegram \u5E33\u865F\u3002\u9EDE\u64CA\u9019\u88E1\u958B\u59CB\u6DFB\u52A0\u60A8\u7684\u7B2C\u4E00\u500B\u5E33\u865F\u3002",target:'[data-tour="accounts"]',position:"bottom",actionLabel:"\u4E86\u89E3\u4E86"},{id:"welcome-marketing",title:"2. \u71DF\u92B7\u4EFB\u52D9\u4E2D\u5FC3",description:"\u9019\u662F\u60A8\u7684\u71DF\u92B7\u4EFB\u52D9\u6307\u63EE\u4E2D\u5FC3\u3002\u9078\u64C7\u76EE\u6A19\u3001\u914D\u7F6E AI\uFF0C\u4E00\u9375\u555F\u52D5\u71DF\u92B7\u4EFB\u52D9\u3002",target:'[data-tour="marketing-hub"]',position:"bottom",actionLabel:"\u4E0B\u4E00\u6B65"},{id:"welcome-roles",title:"3. \u89D2\u8272\u8CC7\u6E90\u5EAB",description:"\u9019\u88E1\u7BA1\u7406 AI \u89D2\u8272\u548C\u5287\u672C\u3002\u7CFB\u7D71\u9810\u8A2D\u4E8650+\u5C08\u696D\u89D2\u8272\uFF0C\u60A8\u4E5F\u53EF\u4EE5\u81EA\u5B9A\u7FA9\u3002",target:'[data-tour="role-library"]',position:"bottom",actionLabel:"\u4E0B\u4E00\u6B65"},{id:"welcome-ai",title:"4. \u667A\u80FD\u5F15\u64CE",description:"\u914D\u7F6E AI \u6A21\u578B\u3001\u77E5\u8B58\u5EAB\u548C\u4EBA\u683C\u98A8\u683C\u3002\u5EFA\u8B70\u5148\u5B8C\u6210\u9019\u88E1\u7684\u914D\u7F6E\u3002",target:'[data-tour="ai-engine"]',position:"bottom",actionLabel:"\u4E0B\u4E00\u6B65"},{id:"welcome-done",title:"\u6E96\u5099\u5C31\u7DD2\uFF01 \u{1F680}",description:`\u60A8\u5DF2\u4E86\u89E3\u57FA\u672C\u529F\u80FD\u3002\u5EFA\u8B70\u5148\u6DFB\u52A0\u5E33\u865F\uFF0C\u7136\u5F8C\u5617\u8A66\u5275\u5EFA\u60A8\u7684\u7B2C\u4E00\u500B\u71DF\u92B7\u4EFB\u52D9\u3002

\u96A8\u6642\u53EF\u4EE5\u5728\u8A2D\u7F6E\u4E2D\u91CD\u65B0\u67E5\u770B\u5F15\u5C0E\u3002`,position:"center",actionLabel:"\u958B\u59CB\u4F7F\u7528"}]},{id:"create-task",name:"\u5275\u5EFA\u71DF\u92B7\u4EFB\u52D9",description:"\u5B78\u7FD2\u5982\u4F55\u5275\u5EFA\u548C\u914D\u7F6E\u71DF\u92B7\u4EFB\u52D9",trigger:"manual",version:1,steps:[{id:"task-goal",title:"\u9078\u64C7\u71DF\u92B7\u76EE\u6A19",description:"\u9996\u5148\u9078\u64C7\u60A8\u8981\u9054\u6210\u7684\u76EE\u6A19\u3002\u4E0D\u540C\u76EE\u6A19\u6703\u6709\u4E0D\u540C\u7684 AI \u7B56\u7565\u3002",target:".goal-selector",position:"bottom"},{id:"task-audience",title:"\u9078\u64C7\u76EE\u6A19\u5BA2\u7FA4",description:"\u6307\u5B9A\u9019\u6B21\u4EFB\u52D9\u8981\u89F8\u9054\u7684\u5BA2\u6236\u3002\u53EF\u4EE5\u6309\u6A19\u7C64\u3001\u7FA4\u7D44\u6216\u610F\u5411\u5206\u6578\u7BE9\u9078\u3002",target:".audience-selector",position:"bottom"},{id:"task-config",title:"\u78BA\u8A8D AI \u914D\u7F6E",description:"AI \u6703\u6839\u64DA\u76EE\u6A19\u81EA\u52D5\u63A8\u85A6\u914D\u7F6E\uFF0C\u60A8\u4E5F\u53EF\u4EE5\u624B\u52D5\u8ABF\u6574\u3002",target:".config-panel",position:"left"},{id:"task-launch",title:"\u555F\u52D5\u4EFB\u52D9",description:"\u78BA\u8A8D\u7121\u8AA4\u5F8C\uFF0C\u9EDE\u64CA\u555F\u52D5\u6309\u9215\u3002AI \u6703\u958B\u59CB\u81EA\u52D5\u57F7\u884C\u71DF\u92B7\u4EFB\u52D9\u3002",target:".launch-button",position:"top"}]},{id:"ai-config",name:"\u914D\u7F6E AI \u5F15\u64CE",description:"\u5B78\u7FD2\u5982\u4F55\u914D\u7F6E AI \u6A21\u578B\u548C\u77E5\u8B58\u5EAB",trigger:"manual",version:1,steps:[{id:"ai-model",title:"\u9078\u64C7 AI \u6A21\u578B",description:"\u9078\u64C7\u8981\u4F7F\u7528\u7684 AI \u6A21\u578B\u3002GPT-4 \u6548\u679C\u6700\u597D\uFF0CGPT-3.5 \u6210\u672C\u6700\u4F4E\u3002",target:'[data-tour="ai-model"]',position:"bottom"},{id:"ai-apikey",title:"\u914D\u7F6E API Key",description:"\u8F38\u5165\u60A8\u7684 OpenAI \u6216\u5176\u4ED6 AI \u670D\u52D9\u7684 API Key\u3002",target:'[data-tour="api-key"]',position:"bottom"},{id:"ai-knowledge",title:"\u6DFB\u52A0\u77E5\u8B58\u5EAB",description:"\u4E0A\u50B3\u7522\u54C1\u8CC7\u6599\u3001FAQ \u7B49\u6587\u6A94\uFF0CAI \u6703\u5B78\u7FD2\u9019\u4E9B\u77E5\u8B58\u4F86\u56DE\u7B54\u5BA2\u6236\u554F\u984C\u3002",target:'[data-tour="knowledge-base"]',position:"right"},{id:"ai-persona",title:"\u8A2D\u7F6E AI \u4EBA\u683C",description:"\u8ABF\u6574 AI \u7684\u8AAA\u8A71\u98A8\u683C\u548C\u4EBA\u683C\u7279\u9EDE\uFF0C\u8B93\u56DE\u8986\u66F4\u81EA\u7136\u3002",target:'[data-tour="ai-persona"]',position:"bottom"}]}];this.loadProgress(),this.checkAutoStart()}startTour(e){let t=this.tours.find(i=>i.id===e);if(!t)return;this._currentTour.set(t),this._currentStepIndex.set(0),this._isActive.set(!0);let s=t.steps[0];s.beforeShow?.(),this.highlightTarget(s.target)}nextStep(){let e=this._currentTour();if(!e)return;this.currentStep()?.afterComplete?.();let s=this._currentStepIndex()+1;if(s>=e.steps.length)this.completeTour();else{this._currentStepIndex.set(s);let i=e.steps[s];i.beforeShow?.(),this.highlightTarget(i.target)}}prevStep(){let e=this._currentStepIndex()-1;if(e<0)return;this._currentStepIndex.set(e);let t=this._currentTour()?.steps[e];t&&(t.beforeShow?.(),this.highlightTarget(t.target))}goToStep(e){let t=this._currentTour();if(!t||e<0||e>=t.steps.length)return;this._currentStepIndex.set(e);let s=t.steps[e];s.beforeShow?.(),this.highlightTarget(s.target)}skipTour(){let e=this._currentTour();e&&(this.updateProgress(e.id,{tourId:e.id,currentStep:this._currentStepIndex(),completed:!1,skipped:!0,version:e.version}),this.closeTour())}completeTour(){let e=this._currentTour();e&&(this.updateProgress(e.id,{tourId:e.id,currentStep:e.steps.length,completed:!0,skipped:!1,completedAt:new Date().toISOString(),version:e.version}),this.closeTour())}closeTour(){this.clearHighlight(),this._isActive.set(!1),this._currentTour.set(null),this._currentStepIndex.set(0)}isCompleted(e){return this._progress().get(e)?.completed||!1}resetTour(e){this._progress.update(t=>{let s=new Map(t);return s.delete(e),s}),this.saveProgress()}resetAll(){this._progress.set(new Map),this.saveProgress()}getAvailableTours(){return this.tours}checkAutoStart(){for(let e of this.tours){if(e.trigger!=="first_visit")continue;let t=this._progress().get(e.id);if(!t||t.version!==e.version&&!t.completed){setTimeout(()=>this.startTour(e.id),1e3);break}}}updateProgress(e,t){this._progress.update(s=>{let i=new Map(s);return i.set(e,t),i}),this.saveProgress()}highlightTarget(e){if(this.clearHighlight(),!e)return;let t=document.querySelector(e);t&&(t.classList.add("onboarding-highlight"),t.scrollIntoView({behavior:"smooth",block:"center"}))}clearHighlight(){document.querySelectorAll(".onboarding-highlight").forEach(e=>{e.classList.remove("onboarding-highlight")})}loadProgress(){try{let e=localStorage.getItem("onboarding_progress");if(e){let t=JSON.parse(e);this._progress.set(new Map(Object.entries(t)))}}catch(e){console.error("Failed to load onboarding progress:",e)}}saveProgress(){let e=Object.fromEntries(this._progress());localStorage.setItem("onboarding_progress",JSON.stringify(e))}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};var rt={primary:"#8b5cf6",secondary:"#06b6d4",accent:"#ec4899",background:"#0f172a",surface:"#1e293b",text:"#f8fafc",textMuted:"#94a3b8",border:"#334155",success:"#10b981",warning:"#f59e0b",error:"#ef4444"},nt={primary:"#7c3aed",secondary:"#0891b2",accent:"#db2777",background:"#ffffff",surface:"#f8fafc",text:"#0f172a",textMuted:"#64748b",border:"#e2e8f0",success:"#059669",warning:"#d97706",error:"#dc2626"},pe=[{id:"default-dark",name:"\u9ED8\u8A8D\u6697\u8272",mode:"dark",colors:{}},{id:"default-light",name:"\u9ED8\u8A8D\u4EAE\u8272",mode:"light",colors:{}},{id:"midnight",name:"\u5348\u591C\u85CD",mode:"dark",colors:{primary:"#3b82f6",secondary:"#8b5cf6",background:"#0c1222",surface:"#162032"}},{id:"forest",name:"\u68EE\u6797\u7DA0",mode:"dark",colors:{primary:"#10b981",secondary:"#14b8a6",accent:"#22c55e",background:"#0a1410",surface:"#132820"}},{id:"sunset",name:"\u65E5\u843D\u6A59",mode:"dark",colors:{primary:"#f97316",secondary:"#fb923c",accent:"#ef4444",background:"#1c1210",surface:"#2a1f1a"}},{id:"ocean",name:"\u6D77\u6D0B",mode:"light",colors:{primary:"#0ea5e9",secondary:"#06b6d4",background:"#f0f9ff",surface:"#e0f2fe"}}],Xe=class o{constructor(){this._mode=r("dark");this.mode=this._mode.asReadonly();this._activePreset=r("default-dark");this.activePreset=this._activePreset.asReadonly();this._customColors=r({});this.customColors=this._customColors.asReadonly();this.isDark=d(()=>{let e=this._mode();return e==="system"?this.getSystemPreference()==="dark":e==="dark"});this.currentColors=d(()=>{let e=this.isDark()?rt:nt,t=this.getPresetColors(),s=this._customColors();return n(n(n({},e),t),s)});this.presets=d(()=>pe);this.loadSettings(),this.setupSystemListener(),fe(()=>{this.applyTheme()})}setMode(e){this._mode.set(e),this.saveSettings()}toggle(){let e=this._mode();e==="system"?this._mode.set(this.isDark()?"light":"dark"):this._mode.set(e==="dark"?"light":"dark"),this.saveSettings()}applyPreset(e){let t=pe.find(s=>s.id===e);t&&(this._activePreset.set(e),this._mode.set(t.mode),this._customColors.set({}),this.saveSettings())}setCustomColor(e,t){this._customColors.update(s=>c(n({},s),{[e]:t})),this.saveSettings()}resetCustomColors(){this._customColors.set({}),this.saveSettings()}getCssVariables(){let e=this.currentColors();return Object.entries(e).map(([t,s])=>`--theme-${this.camelToKebab(t)}: ${s};`).join(`
`)}getPresetColors(){return pe.find(t=>t.id===this._activePreset())?.colors||{}}getSystemPreference(){return window.matchMedia?.("(prefers-color-scheme: dark)").matches?"dark":"light"}setupSystemListener(){window.matchMedia?.("(prefers-color-scheme: dark)").addEventListener("change",()=>{this._mode()==="system"&&this.applyTheme()})}applyTheme(){let e=document.documentElement,t=this.currentColors();this.isDark()?(e.classList.add("dark"),e.classList.remove("light")):(e.classList.add("light"),e.classList.remove("dark"));for(let[i,a]of Object.entries(t))e.style.setProperty(`--theme-${this.camelToKebab(i)}`,a);let s=document.querySelector('meta[name="theme-color"]');s&&s.setAttribute("content",t.background)}camelToKebab(e){return e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}loadSettings(){try{let e=localStorage.getItem("theme_settings");if(e){let t=JSON.parse(e);this._mode.set(t.mode||"dark"),this._activePreset.set(t.preset||"default-dark"),this._customColors.set(t.customColors||{})}}catch(e){console.error("Failed to load theme settings:",e)}}saveSettings(){localStorage.setItem("theme_settings",JSON.stringify({mode:this._mode(),preset:this._activePreset(),customColors:this._customColors()}))}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}};export{I as a,Ze as b,ut as c,T as d,ee as e,te as f,et as g,De as h,K as i,z as j,G as k,W as l,Y as m,U as n,ue as o,F as p,Ne as q,Ee as r,ie as s,re as t,Fe as u,ge as v,Je as w,Pe as x,Oe as y};
