import{a as L}from"./chunk-3V3KVMT4.js";import{Aa as r,Ab as h,Eb as N,Fb as A,Gb as R,M as V,Na as O,Q as q,R as M,Sa as g,Sb as $,Vb as m,W as _,X as x,a as z,b as T,eb as d,fb as i,ga as b,gb as n,hb as F,lb as C,lc as w,mc as S,nb as f,pb as s,qc as E,tb as Q,ub as P,vb as y,xb as o,yb as p,zb as v}from"./chunk-YLSLTE5F.js";var k=class l{constructor(t){this.ipc=t;this._quotaPacks=b([]);this.quotaPacks=this._quotaPacks.asReadonly();this._myPackages=b([]);this.myPackages=this._myPackages.asReadonly();this._bills=b([]);this.bills=this._bills.asReadonly();this._overageInfo=b(null);this.overageInfo=this._overageInfo.asReadonly();this._freezeStatus=b(null);this.freezeStatus=this._freezeStatus.asReadonly();this._loading=b(!1);this.loading=this._loading.asReadonly();this.hasActivePackages=m(()=>this._myPackages().length>0);this.isFrozen=m(()=>this._freezeStatus()?.frozen??!1);this.unpaidBills=m(()=>this._bills().filter(t=>t.status==="pending"));this.totalOverageCharge=m(()=>{let t=this._overageInfo();return t?Object.values(t).reduce((e,a)=>e+(a.charge||0),0):0})}async loadQuotaPacks(){this._loading.set(!0);try{let t=await this.ipc.invoke("get-quota-packs",{});t?.success&&t?.data?.packs&&this._quotaPacks.set(t.data.packs)}catch(t){console.error("Failed to load quota packs:",t)}finally{this._loading.set(!1)}}async purchasePack(t,e="balance"){try{let a=await this.ipc.invoke("purchase-quota-pack",{pack_id:t,payment_method:e});return a?.success&&await this.loadMyPackages(),a||{success:!1,error:"\u672A\u77E5\u932F\u8AA4"}}catch(a){return console.error("Failed to purchase pack:",a),{success:!1,error:String(a)}}}async loadMyPackages(t=!0){try{let e=await this.ipc.invoke("get-my-packages",{active_only:t});e?.success&&e?.data?.packages&&this._myPackages.set(e.data.packages)}catch(e){console.error("Failed to load my packages:",e)}}async loadBills(t,e,a=50){try{let c={limit:a};t&&(c.status=t),e&&(c.type=e);let u=await this.ipc.invoke("get-user-bills",c);u?.success&&u?.data?.bills&&this._bills.set(u.data.bills)}catch(c){console.error("Failed to load bills:",c)}}async payBill(t,e="balance"){try{let a=await this.ipc.invoke("pay-bill",{bill_id:t,payment_method:e});return a?.success&&(await this.loadBills(),await this.loadFreezeStatus()),a||{success:!1,error:"\u672A\u77E5\u932F\u8AA4"}}catch(a){return console.error("Failed to pay bill:",a),{success:!1,error:String(a)}}}async loadOverageInfo(){try{let t=await this.ipc.invoke("get-overage-info",{});t?.success&&t?.data&&this._overageInfo.set(t.data)}catch(t){console.error("Failed to load overage info:",t)}}async loadFreezeStatus(){try{let t=await this.ipc.invoke("get-freeze-status",{});t?.success&&t?.data&&this._freezeStatus.set(t.data)}catch(t){console.error("Failed to load freeze status:",t)}}formatPrice(t){return`\xA5${(t/100).toFixed(2)}`}getPackTypeIcon(t){return{messages:"\u{1F4AC}",ai_calls:"\u{1F916}",accounts:"\u{1F4F1}",combo:"\u{1F381}"}[t]||"\u{1F4E6}"}getBillStatusLabel(t){return{pending:{text:"\u5F85\u652F\u4ED8",color:"#f59e0b"},paid:{text:"\u5DF2\u652F\u4ED8",color:"#22c55e"},failed:{text:"\u652F\u4ED8\u5931\u6557",color:"#ef4444"},cancelled:{text:"\u5DF2\u53D6\u6D88",color:"#6b7280"},refunded:{text:"\u5DF2\u9000\u6B3E",color:"#8b5cf6"}}[t]||{text:t,color:"#666"}}async refresh(){await Promise.all([this.loadQuotaPacks(),this.loadMyPackages(),this.loadBills(),this.loadOverageInfo(),this.loadFreezeStatus()])}static{this.\u0275fac=function(e){return new(e||l)(q(L))}}static{this.\u0275prov=V({token:l,factory:l.\u0275fac,providedIn:"root"})}};function H(l,t){if(l&1&&(i(0,"div",21)(1,"span",22),o(2),n(),i(3,"span",23),o(4),n(),i(5,"span",24),o(6),n()()),l&2){let e=t.$implicit,a=s(3);r(2),p(a.getQuotaIcon(e.type)),r(2),h("",e.remaining,"/",e.total),r(2),p(a.getQuotaLabel(e.type))}}function J(l,t){if(l&1&&(i(0,"div",13)(1,"div",14)(2,"span",15),o(3,"\u{1F4E6}"),n(),i(4,"span",16),o(5),n()(),i(6,"div",17),g(7,H,7,4,"div",18),n(),i(8,"div",19)(9,"span",20),o(10),n()()()),l&2){let e=t.$implicit,a=s(2);r(5),p(e.pack_name),r(2),d("ngForOf",a.getQuotaItems(e.remaining)),r(3),v(" ",a.formatExpiry(e.expires_at)," ")}}function K(l,t){if(l&1&&(i(0,"section",10)(1,"h3"),o(2,"\u6211\u7684\u914D\u984D\u5305"),n(),i(3,"div",11),g(4,J,11,3,"div",12),n()()),l&2){let e=s();r(4),d("ngForOf",e.myPackages())}}function X(l,t){if(l&1){let e=C();i(0,"button",25),f("click",function(){let c=_(e).$implicit,u=s();return x(u.selectedType.set(c.value))}),o(1),n()}if(l&2){let e=t.$implicit,a=s();y("active",a.selectedType()===e.value),r(),h(" ",e.icon," ",e.label," ")}}function Z(l,t){l&1&&(i(0,"div",37),o(1,"\u71B1\u92B7"),n())}function ee(l,t){if(l&1&&(i(0,"div",38)(1,"span",22),o(2),n(),i(3,"span",39),o(4),n(),i(5,"span",24),o(6),n()()),l&2){let e=t.$implicit,a=s(2);r(2),p(a.getQuotaIcon(e.type)),r(2),v("+",e.amount),r(2),p(a.getQuotaLabel(e.type))}}function te(l,t){if(l&1){let e=C();i(0,"div",26),f("click",function(){let c=_(e).$implicit,u=s();return x(u.selectPack(c))}),g(1,Z,2,0,"div",27),i(2,"div",28)(3,"span",29),o(4),n(),i(5,"h4"),o(6),n()(),i(7,"div",30),g(8,ee,7,3,"div",31),n(),i(9,"p",32),o(10),n(),i(11,"div",33)(12,"span",34),o(13),n(),i(14,"span",35),o(15),n()(),i(16,"button",36),f("click",function(c){let u=_(e).$implicit;return s().openPurchaseDialog(u),x(c.stopPropagation())}),o(17," \u7ACB\u5373\u8CFC\u8CB7 "),n()()}if(l&2){let e=t.$implicit,a=s();y("featured",e.featured),r(),d("ngIf",e.featured),r(3),p(a.billing.getPackTypeIcon(e.type)),r(2),p(e.name),r(2),d("ngForOf",a.getPackQuotas(e)),r(2),p(e.description),r(3),p(a.billing.formatPrice(e.price)),r(2),v("\u6709\u6548\u671F ",e.validity_days," \u5929")}}function ne(l,t){if(l&1&&(i(0,"div",54)(1,"div",55)(2,"span",56),o(3),n(),i(4,"div",57)(5,"span",58),o(6),n(),i(7,"span",59),o(8),n()()(),i(9,"div",60)(10,"span"),o(11,"\u50F9\u683C"),n(),i(12,"span",61),o(13),n()(),i(14,"div",62)(15,"span"),o(16,"\u6709\u6548\u671F"),n(),i(17,"span"),o(18),n()()()),l&2){let e=s(2);r(3),p(e.billing.getPackTypeIcon(e.selectedPack().type)),r(3),p(e.selectedPack().name),r(2),p(e.selectedPack().description),r(5),p(e.billing.formatPrice(e.selectedPack().price)),r(5),v("",e.selectedPack().validity_days," \u5929")}}function ie(l,t){if(l&1){let e=C();i(0,"div",40),f("click",function(){_(e);let c=s();return x(c.showPurchaseDialog.set(!1))}),i(1,"div",41),f("click",function(c){return _(e),x(c.stopPropagation())}),i(2,"h3"),o(3,"\u78BA\u8A8D\u8CFC\u8CB7"),n(),g(4,ne,19,5,"div",42),i(5,"div",43)(6,"h4"),o(7,"\u9078\u64C7\u652F\u4ED8\u65B9\u5F0F"),n(),i(8,"div",44)(9,"label",45)(10,"input",46),f("change",function(){_(e);let c=s();return x(c.paymentMethod.set("balance"))}),n(),i(11,"span",47),o(12,"\u{1F4B0}"),n(),i(13,"span",48),o(14,"\u9918\u984D\u652F\u4ED8"),n()(),i(15,"label",45)(16,"input",49),f("change",function(){_(e);let c=s();return x(c.paymentMethod.set("alipay"))}),n(),i(17,"span",47),o(18,"\u{1F499}"),n(),i(19,"span",48),o(20,"\u652F\u4ED8\u5BF6"),n()(),i(21,"label",45)(22,"input",50),f("change",function(){_(e);let c=s();return x(c.paymentMethod.set("wechat"))}),n(),i(23,"span",47),o(24,"\u{1F49A}"),n(),i(25,"span",48),o(26,"\u5FAE\u4FE1\u652F\u4ED8"),n()()()(),i(27,"div",51)(28,"button",52),f("click",function(){_(e);let c=s();return x(c.showPurchaseDialog.set(!1))}),o(29,"\u53D6\u6D88"),n(),i(30,"button",53),f("click",function(){_(e);let c=s();return x(c.confirmPurchase())}),o(31),n()()()()}if(l&2){let e=s();r(4),d("ngIf",e.selectedPack()),r(5),y("selected",e.paymentMethod()==="balance"),r(),d("checked",e.paymentMethod()==="balance"),r(5),y("selected",e.paymentMethod()==="alipay"),r(),d("checked",e.paymentMethod()==="alipay"),r(5),y("selected",e.paymentMethod()==="wechat"),r(),d("checked",e.paymentMethod()==="wechat"),r(8),d("disabled",e.isPurchasing()),r(),v(" ",e.isPurchasing()?"\u8655\u7406\u4E2D...":"\u78BA\u8A8D\u652F\u4ED8"," ")}}function ae(l,t){l&1&&(i(0,"div",63)(1,"span",64),o(2,"\u2713"),n(),i(3,"span"),o(4,"\u8CFC\u8CB7\u6210\u529F\uFF01\u914D\u984D\u5DF2\u6DFB\u52A0"),n()())}var D=class l{constructor(){this.billing=M(k);this.selectedType=b("all");this.selectedPack=b(null);this.showPurchaseDialog=b(!1);this.paymentMethod=b("balance");this.isPurchasing=b(!1);this.showSuccess=b(!1);this.packTypes=[{value:"all",label:"\u5168\u90E8",icon:"\u{1F4E6}"},{value:"messages",label:"\u6D88\u606F\u5305",icon:"\u{1F4AC}"},{value:"ai_calls",label:"AI \u5305",icon:"\u{1F916}"},{value:"combo",label:"\u7D44\u5408\u5305",icon:"\u{1F381}"},{value:"accounts",label:"\u5E33\u865F\u5305",icon:"\u{1F4F1}"}];this.quotaIcons={daily_messages:"\u{1F4AC}",ai_calls:"\u{1F916}",tg_accounts:"\u{1F4F1}",groups:"\u{1F465}"};this.quotaLabels={daily_messages:"\u6BCF\u65E5\u6D88\u606F",ai_calls:"AI \u8ABF\u7528",tg_accounts:"TG \u5E33\u865F",groups:"\u7FA4\u7D44\u6578"};this.myPackages=m(()=>this.billing.myPackages());this.filteredPacks=m(()=>{let t=this.billing.quotaPacks(),e=this.selectedType();return e==="all"?t:t.filter(a=>a.type===e)})}ngOnInit(){this.billing.loadQuotaPacks(),this.billing.loadMyPackages()}getQuotaIcon(t){return this.quotaIcons[t]||"\u{1F4CA}"}getQuotaLabel(t){return this.quotaLabels[t]||t}getQuotaItems(t){return Object.entries(t).map(([e,a])=>({type:e,remaining:a,total:a}))}getPackQuotas(t){return Object.entries(t.quotas).map(([e,a])=>({type:e,amount:a}))}formatExpiry(t){try{let e=new Date(t),a=new Date,c=Math.ceil((e.getTime()-a.getTime())/(1e3*60*60*24));return c<0?"\u5DF2\u904E\u671F":c===0?"\u4ECA\u65E5\u5230\u671F":c===1?"\u660E\u65E5\u5230\u671F":`${c} \u5929\u5F8C\u5230\u671F`}catch{return""}}selectPack(t){this.selectedPack.set(t)}openPurchaseDialog(t){this.selectedPack.set(t),this.showPurchaseDialog.set(!0)}async confirmPurchase(){let t=this.selectedPack();if(!t)return;this.isPurchasing.set(!0);let e=await this.billing.purchasePack(t.id,this.paymentMethod());this.isPurchasing.set(!1),e.success?(this.showPurchaseDialog.set(!1),this.showSuccess.set(!0),setTimeout(()=>{this.showSuccess.set(!1)},3e3)):alert(e.error||"\u8CFC\u8CB7\u5931\u6557")}static{this.\u0275fac=function(e){return new(e||l)}}static{this.\u0275cmp=O({type:l,selectors:[["app-quota-pack-store"]],decls:16,vars:5,consts:[[1,"pack-store"],[1,"store-header"],["class","my-packages",4,"ngIf"],[1,"available-packs"],[1,"type-filter"],[3,"active","click",4,"ngFor","ngForOf"],[1,"packs-grid"],["class","pack-card",3,"featured","click",4,"ngFor","ngForOf"],["class","dialog-overlay",3,"click",4,"ngIf"],["class","success-toast",4,"ngIf"],[1,"my-packages"],[1,"packages-list"],["class","package-card",4,"ngFor","ngForOf"],[1,"package-card"],[1,"package-header"],[1,"package-icon"],[1,"package-name"],[1,"package-quotas"],["class","quota-item",4,"ngFor","ngForOf"],[1,"package-footer"],[1,"expires"],[1,"quota-item"],[1,"quota-icon"],[1,"quota-value"],[1,"quota-label"],[3,"click"],[1,"pack-card",3,"click"],["class","featured-badge",4,"ngIf"],[1,"pack-header"],[1,"pack-icon"],[1,"pack-quotas"],["class","quota-row",4,"ngFor","ngForOf"],[1,"pack-desc"],[1,"pack-footer"],[1,"pack-price"],[1,"pack-validity"],[1,"buy-btn",3,"click"],[1,"featured-badge"],[1,"quota-row"],[1,"quota-amount"],[1,"dialog-overlay",3,"click"],[1,"dialog-content",3,"click"],["class","purchase-summary",4,"ngIf"],[1,"payment-methods"],[1,"method-options"],[1,"method-option"],["type","radio","name","payment","value","balance",3,"change","checked"],[1,"method-icon"],[1,"method-label"],["type","radio","name","payment","value","alipay",3,"change","checked"],["type","radio","name","payment","value","wechat",3,"change","checked"],[1,"dialog-actions"],[1,"btn-cancel",3,"click"],[1,"btn-confirm",3,"click","disabled"],[1,"purchase-summary"],[1,"pack-preview"],[1,"icon"],[1,"info"],[1,"name"],[1,"desc"],[1,"price-row"],[1,"price"],[1,"validity-row"],[1,"success-toast"],[1,"success-icon"]],template:function(e,a){e&1&&(i(0,"div",0)(1,"header",1)(2,"h2"),o(3,"\u914D\u984D\u5305\u5546\u5E97"),n(),i(4,"p"),o(5,"\u8CFC\u8CB7\u984D\u5916\u914D\u984D\uFF0C\u7A81\u7834\u9650\u5236"),n()(),g(6,K,5,1,"section",2),i(7,"section",3)(8,"h3"),o(9,"\u53EF\u8CFC\u8CB7\u914D\u984D\u5305"),n(),i(10,"div",4),g(11,X,2,4,"button",5),n(),i(12,"div",6),g(13,te,18,9,"div",7),n()(),g(14,ie,32,12,"div",8)(15,ae,5,0,"div",9),n()),e&2&&(r(6),d("ngIf",a.myPackages().length>0),r(5),d("ngForOf",a.packTypes),r(2),d("ngForOf",a.filteredPacks()),r(),d("ngIf",a.showPurchaseDialog()),r(),d("ngIf",a.showSuccess()))},dependencies:[E,w,S],styles:[".pack-store[_ngcontent-%COMP%]{padding:24px;max-width:1200px;margin:0 auto}.store-header[_ngcontent-%COMP%]{text-align:center;margin-bottom:32px}.store-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:28px;font-weight:700;margin:0 0 8px}.store-header[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--text-secondary, #888);margin:0}.my-packages[_ngcontent-%COMP%]{margin-bottom:32px}.my-packages[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%], .available-packs[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:18px;margin-bottom:16px}.packages-list[_ngcontent-%COMP%]{display:flex;gap:16px;overflow-x:auto;padding-bottom:8px}.package-card[_ngcontent-%COMP%]{min-width:200px;padding:16px;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:12px}.package-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;margin-bottom:12px}.package-icon[_ngcontent-%COMP%]{font-size:24px}.package-name[_ngcontent-%COMP%]{font-weight:600}.package-quotas[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px}.quota-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-size:13px}.package-footer[_ngcontent-%COMP%]{margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color, #333)}.expires[_ngcontent-%COMP%]{font-size:12px;color:var(--text-secondary, #888)}.type-filter[_ngcontent-%COMP%]{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}.type-filter[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:8px 16px;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:20px;color:var(--text-secondary, #888);font-size:13px;cursor:pointer;transition:all .2s}.type-filter[_ngcontent-%COMP%]   button.active[_ngcontent-%COMP%]{background:var(--primary, #3b82f6);border-color:var(--primary, #3b82f6);color:#fff}.packs-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px}.pack-card[_ngcontent-%COMP%]{position:relative;padding:24px;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:16px;cursor:pointer;transition:all .3s}.pack-card[_ngcontent-%COMP%]:hover{transform:translateY(-4px);box-shadow:0 8px 24px #0003}.pack-card.featured[_ngcontent-%COMP%]{border-color:var(--primary, #3b82f6);background:linear-gradient(135deg,#3b82f61a,#8b5cf61a)}.featured-badge[_ngcontent-%COMP%]{position:absolute;top:-10px;right:16px;padding:4px 12px;background:linear-gradient(135deg,#f59e0b,#ef4444);border-radius:12px;font-size:12px;font-weight:600;color:#fff}.pack-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;margin-bottom:16px}.pack-icon[_ngcontent-%COMP%]{font-size:32px}.pack-header[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0;font-size:18px}.pack-quotas[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}.quota-row[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px}.quota-amount[_ngcontent-%COMP%]{font-weight:600;color:#22c55e}.quota-label[_ngcontent-%COMP%]{color:var(--text-secondary, #888);font-size:13px}.pack-desc[_ngcontent-%COMP%]{font-size:13px;color:var(--text-secondary, #888);margin:0 0 16px}.pack-footer[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.pack-price[_ngcontent-%COMP%]{font-size:24px;font-weight:700;color:var(--primary, #3b82f6)}.pack-validity[_ngcontent-%COMP%]{font-size:12px;color:var(--text-muted, #666)}.buy-btn[_ngcontent-%COMP%]{width:100%;padding:12px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border:none;border-radius:8px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}.buy-btn[_ngcontent-%COMP%]:hover{transform:translateY(-2px);box-shadow:0 4px 12px #3b82f64d}.dialog-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#000000b3;display:flex;align-items:center;justify-content:center;z-index:1000}.dialog-content[_ngcontent-%COMP%]{background:var(--bg-primary, #0f0f0f);border-radius:16px;padding:24px;min-width:400px}.dialog-content[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 20px}.purchase-summary[_ngcontent-%COMP%]{margin-bottom:20px}.pack-preview[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg-secondary, #1a1a1a);border-radius:12px;margin-bottom:16px}.pack-preview[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{font-size:36px}.pack-preview[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{display:block;font-weight:600}.pack-preview[_ngcontent-%COMP%]   .desc[_ngcontent-%COMP%]{font-size:12px;color:var(--text-secondary, #888)}.price-row[_ngcontent-%COMP%], .validity-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;padding:8px 0}.price[_ngcontent-%COMP%]{font-size:20px;font-weight:700;color:var(--primary, #3b82f6)}.payment-methods[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{font-size:14px;margin:0 0 12px;color:var(--text-secondary, #888)}.method-options[_ngcontent-%COMP%]{display:flex;gap:12px}.method-option[_ngcontent-%COMP%]{flex:1;padding:12px;background:var(--bg-secondary, #1a1a1a);border:2px solid var(--border-color, #333);border-radius:8px;cursor:pointer;text-align:center;transition:all .2s}.method-option[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{display:none}.method-option.selected[_ngcontent-%COMP%]{border-color:var(--primary, #3b82f6)}.method-icon[_ngcontent-%COMP%]{display:block;font-size:24px;margin-bottom:4px}.method-label[_ngcontent-%COMP%]{font-size:12px}.dialog-actions[_ngcontent-%COMP%]{display:flex;gap:12px;margin-top:24px}.btn-cancel[_ngcontent-%COMP%], .btn-confirm[_ngcontent-%COMP%]{flex:1;padding:12px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer}.btn-cancel[_ngcontent-%COMP%]{background:transparent;border:1px solid var(--border-color, #333);color:var(--text-primary, #fff)}.btn-confirm[_ngcontent-%COMP%]{background:linear-gradient(135deg,#3b82f6,#8b5cf6);border:none;color:#fff}.btn-confirm[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.success-toast[_ngcontent-%COMP%]{position:fixed;bottom:24px;left:50%;transform:translate(-50%);display:flex;align-items:center;gap:12px;padding:16px 24px;background:#22c55e;border-radius:12px;color:#fff;font-weight:600;animation:_ngcontent-%COMP%_slideUp .3s ease}@keyframes _ngcontent-%COMP%_slideUp{0%{transform:translate(-50%) translateY(20px);opacity:0}to{transform:translate(-50%) translateY(0);opacity:1}}.success-icon[_ngcontent-%COMP%]{font-size:20px}"],changeDetection:0})}};function oe(l,t){if(l&1&&(i(0,"p",11),o(1),n()),l&2){let e=s(2);r(),v("\u9810\u8A08\u89E3\u51CD\u6642\u9593\uFF1A",e.unfreezeTime())}}function re(l,t){if(l&1){let e=C();i(0,"div",6)(1,"span",7),o(2,"\u26A0\uFE0F"),n(),i(3,"div",8)(4,"h4"),o(5,"\u914D\u984D\u5DF2\u51CD\u7D50"),n(),i(6,"p"),o(7),n(),g(8,oe,2,1,"p",9),n(),i(9,"button",10),f("click",function(){_(e);let c=s();return x(c.payUnpaidBills())}),o(10,"\u7ACB\u5373\u652F\u4ED8"),n()()}if(l&2){let e=s();r(7),p(e.freezeReason()),r(),d("ngIf",e.unfreezeTime())}}function le(l,t){if(l&1&&(i(0,"span",14),o(1),n()),l&2){let e=s().$implicit;r(),p(e.badge())}}function ce(l,t){if(l&1){let e=C();i(0,"button",12),f("click",function(){let c=_(e).$implicit,u=s();return x(u.activeTab.set(c.value))}),o(1),g(2,le,2,1,"span",13),n()}if(l&2){let e=t.$implicit,a=s();y("active",a.activeTab()===e.value),r(),h(" ",e.icon," ",e.label," "),r(),d("ngIf",e.badge&&e.badge()>0)}}function se(l,t){if(l&1&&(i(0,"span",41),o(1),n()),l&2){let e=s().$implicit;r(),v("+\u914D\u984D\u5305 ",e.pack_bonus)}}function de(l,t){if(l&1&&(i(0,"span",42),o(1),n()),l&2){let e=s().$implicit;r(),v("\u8D85\u984D ",e.overage)}}function pe(l,t){if(l&1&&(i(0,"div",43),o(1),n()),l&2){let e=s().$implicit,a=s(3);r(),v(" \u9810\u8A08\u8CBB\u7528\uFF1A",a.billing.formatPrice(e.charge)," ")}}function ge(l,t){if(l&1&&(i(0,"div",28)(1,"div",29)(2,"span",30),o(3),n(),i(4,"span",31),o(5),n()(),i(6,"div",32),F(7,"div",33)(8,"div",34)(9,"div",35),n(),i(10,"div",36)(11,"span",37),o(12),n(),g(13,se,2,1,"span",38)(14,de,2,1,"span",39),n(),g(15,pe,2,1,"div",40),n()),l&2){let e=t.$implicit,a=s(3);r(3),p(a.getQuotaIcon(e.type)),r(2),p(a.getQuotaLabel(e.type)),r(2),P("width",e.basePercent,"%"),r(),P("width",e.packPercent,"%"),r(),P("width",e.overagePercent,"%"),r(3),v("\u57FA\u790E ",e.base_limit),r(),d("ngIf",e.pack_bonus>0),r(),d("ngIf",e.overage>0),r(),d("ngIf",e.charge>0)}}function ue(l,t){if(l&1&&(i(0,"section",25)(1,"h3"),o(2,"\u8D85\u984D\u4F7F\u7528\u60C5\u6CC1"),n(),i(3,"div",26),g(4,ge,16,12,"div",27),n()()),l&2){let e=s(2);r(4),d("ngForOf",e.overageItems())}}function me(l,t){if(l&1){let e=C();i(0,"button",48),f("click",function(){_(e);let c=s().$implicit,u=s(3);return x(u.payBill(c))}),o(1," \u652F\u4ED8 "),n()}}function _e(l,t){if(l&1&&(i(0,"tr")(1,"td"),o(2),n(),i(3,"td"),o(4),n(),i(5,"td"),o(6),n(),i(7,"td")(8,"span",46),o(9),n()(),i(10,"td"),g(11,me,2,0,"button",47),n()()),l&2){let e=t.$implicit,a=s(3);r(2),p(a.formatDate(e.created_at)),r(2),p(e.description),r(),y("refund",e.amount<0),r(),h(" ",(e.amount<0,""),"",a.billing.formatPrice(a.Math.abs(e.amount))," "),r(2),P("background",a.billing.getBillStatusLabel(e.status).color),r(),v(" ",a.billing.getBillStatusLabel(e.status).text," "),r(2),d("ngIf",e.status==="pending")}}function xe(l,t){if(l&1&&(i(0,"div",44)(1,"table")(2,"thead")(3,"tr")(4,"th"),o(5,"\u65E5\u671F"),n(),i(6,"th"),o(7,"\u63CF\u8FF0"),n(),i(8,"th"),o(9,"\u91D1\u984D"),n(),i(10,"th"),o(11,"\u72C0\u614B"),n(),i(12,"th"),o(13,"\u64CD\u4F5C"),n()()(),i(14,"tbody"),g(15,_e,12,10,"tr",45),n()()()),l&2){let e=s(2);r(15),d("ngForOf",e.recentBills())}}function fe(l,t){l&1&&(i(0,"div",49)(1,"span",50),o(2,"\u{1F4DD}"),n(),i(3,"p"),o(4,"\u66AB\u7121\u8CEC\u55AE\u8A18\u9304"),n()())}function be(l,t){if(l&1&&(i(0,"div",15)(1,"div",16)(2,"div",17)(3,"span",18),o(4,"\u{1F4E6}"),n(),i(5,"div",19)(6,"span",20),o(7),n(),i(8,"span",21),o(9,"\u6709\u6548\u914D\u984D\u5305"),n()()(),i(10,"div",17)(11,"span",18),o(12,"\u{1F4B3}"),n(),i(13,"div",19)(14,"span",20),o(15),n(),i(16,"span",21),o(17,"\u5F85\u652F\u4ED8\u8CEC\u55AE"),n()()(),i(18,"div",17)(19,"span",18),o(20,"\u{1F4C8}"),n(),i(21,"div",19)(22,"span",20),o(23),n(),i(24,"span",21),o(25,"\u672C\u6708\u8D85\u984D\u8CBB\u7528"),n()()(),i(26,"div",17)(27,"span",18),o(28,"\u{1F4B0}"),n(),i(29,"div",19)(30,"span",20),o(31),n(),i(32,"span",21),o(33,"\u7D2F\u8A08\u6D88\u8CBB"),n()()()(),g(34,ue,5,1,"section",22),i(35,"section",23)(36,"h3"),o(37,"\u6700\u8FD1\u8CEC\u55AE"),n(),g(38,xe,16,1,"div",24)(39,fe,5,0,"ng-template",null,0,$),n()()),l&2){let e=Q(40),a=s();r(7),p(a.activePackagesCount()),r(8),p(a.unpaidBillsCount()),r(8),p(a.billing.formatPrice(a.totalOverage())),r(8),p(a.billing.formatPrice(a.totalSpent())),r(3),d("ngIf",a.overageInfo()),r(4),d("ngIf",a.recentBills().length>0)("ngIfElse",e)}}function ve(l,t){l&1&&(i(0,"div",15),F(1,"app-quota-pack-store"),n())}function Ce(l,t){if(l&1){let e=C();i(0,"button",71),f("click",function(){_(e);let c=s().$implicit,u=s(2);return x(u.payBill(c))}),o(1," \u7ACB\u5373\u652F\u4ED8 "),n()}}function ye(l,t){if(l&1&&(i(0,"div",61)(1,"div",62)(2,"span",63),o(3),n(),i(4,"span",64),o(5),n()(),i(6,"div",65),o(7),n(),i(8,"div",66)(9,"span",67),o(10),n(),i(11,"span",68),o(12),n()(),i(13,"div",69),o(14),n(),g(15,Ce,2,0,"button",70),n()),l&2){let e=t.$implicit,a=s(2);r(3),p(a.getBillTypeIcon(e.billing_type)),r(2),v("",e.id.slice(0,12),"..."),r(2),p(e.description),r(2),y("refund",e.amount<0),r(),h(" ",e.amount>=0?"+":"","",a.billing.formatPrice(e.amount)," "),r(),P("color",a.billing.getBillStatusLabel(e.status).color),r(),v(" ",a.billing.getBillStatusLabel(e.status).text," "),r(2),p(a.formatDate(e.created_at)),r(),d("ngIf",e.status==="pending")}}function he(l,t){if(l&1){let e=C();i(0,"div",15)(1,"section",51)(2,"div",52)(3,"select",53),R("valueChange",function(c){_(e);let u=s();return A(u.billFilter,c)||(u.billFilter=c),x(c)}),f("change",function(){_(e);let c=s();return x(c.loadFilteredBills())}),i(4,"option",54),o(5,"\u5168\u90E8"),n(),i(6,"option",55),o(7,"\u5F85\u652F\u4ED8"),n(),i(8,"option",56),o(9,"\u5DF2\u652F\u4ED8"),n(),i(10,"option",57),o(11,"\u5DF2\u9000\u6B3E"),n()(),i(12,"button",58),f("click",function(){_(e);let c=s();return x(c.refreshBills())}),o(13," \u{1F504} \u5237\u65B0 "),n()(),i(14,"div",59),g(15,ye,16,12,"div",60),n()()()}if(l&2){let e=s();r(3),N("value",e.billFilter),r(12),d("ngForOf",e.allBills())}}var U=class l{constructor(){this.billing=M(k);this.Math=Math;this.activeTab=b("overview");this.billFilter="";this.tabs=[{value:"overview",label:"\u6982\u89BD",icon:"\u{1F4CA}",badge:void 0},{value:"packages",label:"\u914D\u984D\u5305",icon:"\u{1F4E6}",badge:void 0},{value:"bills",label:"\u8CEC\u55AE",icon:"\u{1F4B3}",badge:()=>this.unpaidBillsCount()}];this.quotaIcons={daily_messages:"\u{1F4AC}",ai_calls:"\u{1F916}"};this.quotaLabels={daily_messages:"\u6BCF\u65E5\u6D88\u606F",ai_calls:"AI \u8ABF\u7528"};this.isFrozen=m(()=>this.billing.freezeStatus()?.frozen??!1);this.freezeReason=m(()=>this.billing.freezeStatus()?.reason??"");this.unfreezeTime=m(()=>{let t=this.billing.freezeStatus()?.unfreeze_at;return t?this.formatDate(t):""});this.activePackagesCount=m(()=>this.billing.myPackages().length);this.unpaidBillsCount=m(()=>this.billing.unpaidBills().length);this.totalOverage=m(()=>this.billing.totalOverageCharge());this.totalSpent=m(()=>this.billing.bills().filter(t=>t.status==="paid"&&t.amount>0).reduce((t,e)=>t+e.amount,0));this.overageInfo=m(()=>this.billing.overageInfo());this.overageItems=m(()=>{let t=this.overageInfo();return t?Object.entries(t).map(([e,a])=>{let c=a.used,u=Math.min(a.base_limit,c),B=Math.min(a.pack_bonus,Math.max(0,c-a.base_limit)),W=a.overage,I=Math.max(c,a.total_limit)||1;return T(z({type:e},a),{basePercent:u/I*100,packPercent:B/I*100,overagePercent:W/I*100})}):[]});this.recentBills=m(()=>this.billing.bills().slice(0,5));this.allBills=m(()=>this.billing.bills())}ngOnInit(){this.billing.refresh()}getQuotaIcon(t){return this.quotaIcons[t]||"\u{1F4CA}"}getQuotaLabel(t){return this.quotaLabels[t]||t}getBillTypeIcon(t){return{subscription:"\u{1F4C5}",overage:"\u{1F4C8}",quota_pack:"\u{1F4E6}",refund:"\u21A9\uFE0F"}[t]||"\u{1F4B3}"}formatDate(t){try{return new Date(t).toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return t}}async payBill(t){let e=await this.billing.payBill(t.id);e.success||alert(e.error||"\u652F\u4ED8\u5931\u6557")}async payUnpaidBills(){let t=this.billing.unpaidBills();for(let e of t)await this.billing.payBill(e.id)}loadFilteredBills(){this.billing.loadBills(this.billFilter||void 0)}refreshBills(){this.billing.loadBills()}static{this.\u0275fac=function(e){return new(e||l)}}static{this.\u0275cmp=O({type:l,selectors:[["app-billing-view"]],decls:7,vars:5,consts:[["noBills",""],[1,"billing-view"],["class","freeze-warning",4,"ngIf"],[1,"tabs"],[3,"active","click",4,"ngFor","ngForOf"],["class","tab-content",4,"ngIf"],[1,"freeze-warning"],[1,"warning-icon"],[1,"warning-content"],["class","unfreeze-time",4,"ngIf"],[1,"pay-btn",3,"click"],[1,"unfreeze-time"],[3,"click"],["class","badge",4,"ngIf"],[1,"badge"],[1,"tab-content"],[1,"stats-grid"],[1,"stat-card"],[1,"stat-icon"],[1,"stat-info"],[1,"stat-value"],[1,"stat-label"],["class","overage-section",4,"ngIf"],[1,"recent-bills"],["class","bills-table",4,"ngIf","ngIfElse"],[1,"overage-section"],[1,"overage-list"],["class","overage-item",4,"ngFor","ngForOf"],[1,"overage-item"],[1,"overage-header"],[1,"quota-icon"],[1,"quota-name"],[1,"usage-bar"],[1,"usage-base"],[1,"usage-pack"],[1,"usage-overage"],[1,"usage-legend"],[1,"legend-item","base"],["class","legend-item pack",4,"ngIf"],["class","legend-item overage",4,"ngIf"],["class","overage-charge",4,"ngIf"],[1,"legend-item","pack"],[1,"legend-item","overage"],[1,"overage-charge"],[1,"bills-table"],[4,"ngFor","ngForOf"],[1,"status-badge"],["class","action-btn",3,"click",4,"ngIf"],[1,"action-btn",3,"click"],[1,"empty-state"],[1,"empty-icon"],[1,"all-bills"],[1,"bills-filter"],[3,"valueChange","change","value"],["value",""],["value","pending"],["value","paid"],["value","refunded"],[1,"refresh-btn",3,"click"],[1,"bills-list"],["class","bill-card",4,"ngFor","ngForOf"],[1,"bill-card"],[1,"bill-header"],[1,"bill-type"],[1,"bill-id"],[1,"bill-desc"],[1,"bill-footer"],[1,"bill-amount"],[1,"bill-status"],[1,"bill-date"],["class","pay-bill-btn",3,"click",4,"ngIf"],[1,"pay-bill-btn",3,"click"]],template:function(e,a){e&1&&(i(0,"div",1),g(1,re,11,2,"div",2),i(2,"div",3),g(3,ce,3,5,"button",4),n(),g(4,be,41,7,"div",5)(5,ve,2,0,"div",5)(6,he,16,2,"div",5),n()),e&2&&(r(),d("ngIf",a.isFrozen()),r(2),d("ngForOf",a.tabs),r(),d("ngIf",a.activeTab()==="overview"),r(),d("ngIf",a.activeTab()==="packages"),r(),d("ngIf",a.activeTab()==="bills"))},dependencies:[E,w,S,D],styles:['.billing-view[_ngcontent-%COMP%]{padding:24px;max-width:1200px;margin:0 auto}.freeze-warning[_ngcontent-%COMP%]{display:flex;align-items:center;gap:16px;padding:16px 24px;background:linear-gradient(135deg,#ef444433,#f59e0b33);border:1px solid #ef4444;border-radius:12px;margin-bottom:24px}.warning-icon[_ngcontent-%COMP%]{font-size:32px}.warning-content[_ngcontent-%COMP%]{flex:1}.warning-content[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0 0 4px;color:#ef4444}.warning-content[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:14px;color:var(--text-secondary, #888)}.pay-btn[_ngcontent-%COMP%]{padding:12px 24px;background:#ef4444;border:none;border-radius:8px;color:#fff;font-weight:600;cursor:pointer}.tabs[_ngcontent-%COMP%]{display:flex;gap:8px;margin-bottom:24px;border-bottom:1px solid var(--border-color, #333);padding-bottom:12px}.tabs[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:10px 20px;background:transparent;border:none;color:var(--text-secondary, #888);font-size:14px;cursor:pointer;border-radius:8px;transition:all .2s;position:relative}.tabs[_ngcontent-%COMP%]   button.active[_ngcontent-%COMP%]{background:var(--bg-secondary, #1a1a1a);color:var(--text-primary, #fff)}.badge[_ngcontent-%COMP%]{position:absolute;top:2px;right:2px;min-width:18px;height:18px;padding:0 6px;background:#ef4444;border-radius:9px;font-size:11px;font-weight:600;color:#fff}.stats-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px}.stat-card[_ngcontent-%COMP%]{display:flex;align-items:center;gap:16px;padding:20px;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:12px}.stat-icon[_ngcontent-%COMP%]{font-size:32px}.stat-value[_ngcontent-%COMP%]{display:block;font-size:24px;font-weight:700}.stat-label[_ngcontent-%COMP%]{font-size:13px;color:var(--text-secondary, #888)}.overage-section[_ngcontent-%COMP%]{margin-bottom:32px}.overage-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%], .recent-bills[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:18px;margin:0 0 16px}.overage-list[_ngcontent-%COMP%]{display:grid;gap:16px}.overage-item[_ngcontent-%COMP%]{padding:16px;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:12px}.overage-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;margin-bottom:12px}.quota-icon[_ngcontent-%COMP%]{font-size:20px}.usage-bar[_ngcontent-%COMP%]{height:8px;background:var(--bg-tertiary, #2a2a2a);border-radius:4px;overflow:hidden;display:flex}.usage-base[_ngcontent-%COMP%]{height:100%;background:#3b82f6}.usage-pack[_ngcontent-%COMP%]{height:100%;background:#22c55e}.usage-overage[_ngcontent-%COMP%]{height:100%;background:#ef4444}.usage-legend[_ngcontent-%COMP%]{display:flex;gap:16px;margin-top:8px;font-size:12px}.legend-item[_ngcontent-%COMP%]:before{content:"";display:inline-block;width:8px;height:8px;border-radius:2px;margin-right:4px}.legend-item.base[_ngcontent-%COMP%]:before{background:#3b82f6}.legend-item.pack[_ngcontent-%COMP%]:before{background:#22c55e}.legend-item.overage[_ngcontent-%COMP%]:before{background:#ef4444}.overage-charge[_ngcontent-%COMP%]{margin-top:8px;font-size:13px;color:#ef4444;font-weight:600}.bills-table[_ngcontent-%COMP%]{overflow-x:auto}table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{padding:12px;text-align:left;border-bottom:1px solid var(--border-color, #333)}th[_ngcontent-%COMP%]{color:var(--text-secondary, #888);font-weight:500;font-size:13px}td.refund[_ngcontent-%COMP%]{color:#22c55e}.status-badge[_ngcontent-%COMP%]{display:inline-block;padding:4px 8px;border-radius:4px;font-size:12px;color:#fff}.action-btn[_ngcontent-%COMP%]{padding:6px 12px;background:var(--primary, #3b82f6);border:none;border-radius:4px;color:#fff;font-size:12px;cursor:pointer}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:48px;color:var(--text-secondary, #888)}.empty-icon[_ngcontent-%COMP%]{font-size:48px;display:block;margin-bottom:12px}.bills-filter[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-bottom:16px}.bills-filter[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]{padding:8px 16px;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:8px;color:var(--text-primary, #fff)}.refresh-btn[_ngcontent-%COMP%]{padding:8px 16px;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:8px;color:var(--text-primary, #fff);cursor:pointer}.bills-list[_ngcontent-%COMP%]{display:grid;gap:16px}.bill-card[_ngcontent-%COMP%]{padding:16px;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:12px}.bill-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-bottom:8px}.bill-type[_ngcontent-%COMP%]{font-size:20px}.bill-id[_ngcontent-%COMP%]{font-size:12px;color:var(--text-muted, #666);font-family:monospace}.bill-desc[_ngcontent-%COMP%]{font-size:14px;margin-bottom:12px}.bill-footer[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.bill-amount[_ngcontent-%COMP%]{font-size:20px;font-weight:700}.bill-amount.refund[_ngcontent-%COMP%]{color:#22c55e}.bill-date[_ngcontent-%COMP%]{font-size:12px;color:var(--text-muted, #666);margin-top:8px}.pay-bill-btn[_ngcontent-%COMP%]{width:100%;margin-top:12px;padding:10px;background:var(--primary, #3b82f6);border:none;border-radius:8px;color:#fff;font-weight:600;cursor:pointer}'],changeDetection:0})}};export{U as BillingViewComponent};
