{
  "version": 3,
  "sources": ["src/services/automation-workflow.service.ts", "src/services/marketing-analytics.service.ts"],
  "sourcesContent": ["/**\r\n * è‡ªå‹•åŒ–å·¥ä½œæµæœå‹™\r\n * Automation Workflow Service\r\n * \r\n * ğŸ†• Phase 1ï¼šå…¨éˆè·¯æ™ºèƒ½ç‡ŸéŠ·è‡ªå‹•åŒ–\r\n * \r\n * åŠŸèƒ½ï¼š\r\n * - ç›£æ§é—œéµè©è§¸ç™¼ â†’ AI ç­–åŠƒ\r\n * - AI ç­–åŠƒå®Œæˆ â†’ ç§èŠåŸ·è¡Œ\r\n * - èˆˆè¶£ä¿¡è™Ÿè­˜åˆ¥ â†’ å»ºç¾¤è§¸ç™¼\r\n * - å·¥ä½œæµç‹€æ…‹ç®¡ç†\r\n */\r\n\r\nimport { Injectable, signal, computed, inject } from '@angular/core';\r\nimport { ElectronIpcService } from '../electron-ipc.service';\r\nimport { ToastService } from '../toast.service';\r\nimport { UnifiedContactsService } from './unified-contacts.service';\r\n\r\n// ============ é¡å‹å®šç¾© ============\r\n\r\n/** å·¥ä½œæµå®šç¾© */\r\nexport interface AutomationWorkflow {\r\n  id: string;\r\n  name: string;\r\n  enabled: boolean;\r\n  trigger: WorkflowTrigger;\r\n  steps: WorkflowStep[];\r\n  config: WorkflowConfig;\r\n  stats: WorkflowStats;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\n/** è§¸ç™¼æ¢ä»¶ */\r\nexport interface WorkflowTrigger {\r\n  type: 'keyword_match' | 'user_action' | 'schedule' | 'manual';\r\n  groupIds?: number[];           // ç›£æ§çš„ç¾¤çµ„\r\n  keywordSetIds?: number[];      // é—œéµè©é›†\r\n  minIntentScore?: number;       // æœ€ä½æ„å‘åˆ†\r\n  cooldownMinutes?: number;      // åŒç”¨æˆ¶å†·å»æ™‚é–“\r\n  excludeContacted?: boolean;    // æ’é™¤å·²è¯ç¹«\r\n  excludeBlacklist?: boolean;    // æ’é™¤é»‘åå–®\r\n}\r\n\r\n/** å·¥ä½œæµæ­¥é©Ÿ */\r\nexport interface WorkflowStep {\r\n  id: string;\r\n  type: 'evaluate' | 'plan' | 'private_chat' | 'detect_interest' | 'create_group' | 'group_marketing' | 'record';\r\n  name: string;\r\n  config: Record<string, any>;\r\n  nextOnSuccess?: string;\r\n  nextOnFail?: string;\r\n}\r\n\r\n/** å·¥ä½œæµé…ç½® */\r\nexport interface WorkflowConfig {\r\n  marketingGoal: string;         // ç‡ŸéŠ·ç›®æ¨™\r\n  roleCount: number | 'auto';    // è§’è‰²æ•¸é‡\r\n  accountSelection: 'auto' | 'manual';\r\n  selectedAccountIds?: number[];\r\n  firstContactDelay: { min: number; max: number };  // é¦–æ¬¡æ¥è§¸å»¶é²ï¼ˆåˆ†é˜ï¼‰\r\n  interestSignals: string[];     // èˆˆè¶£ä¿¡è™Ÿé—œéµè©\r\n  groupNameTemplate?: string;    // ç¾¤åæ¨¡æ¿\r\n}\r\n\r\n/** å·¥ä½œæµçµ±è¨ˆ */\r\nexport interface WorkflowStats {\r\n  totalTriggers: number;\r\n  todayTriggers: number;\r\n  activeExecutions: number;\r\n  conversions: number;\r\n  lastTriggeredAt?: Date;\r\n}\r\n\r\n/** å·¥ä½œæµåŸ·è¡Œå¯¦ä¾‹ */\r\nexport interface WorkflowExecution {\r\n  id: string;\r\n  workflowId: string;\r\n  targetUserId: string;\r\n  targetUserName: string;\r\n  targetUserPhone?: string;\r\n  currentStep: string;\r\n  status: 'pending' | 'running' | 'paused' | 'completed' | 'failed' | 'cancelled';\r\n  stepResults: Record<string, StepResult>;\r\n  aiPlanResult?: any;\r\n  sessionId?: string;           // å”ä½œæœƒè©± ID\r\n  groupId?: string;             // å‰µå»ºçš„ç¾¤çµ„ ID\r\n  startedAt: Date;\r\n  updatedAt: Date;\r\n  completedAt?: Date;\r\n  outcome?: 'converted' | 'interested' | 'neutral' | 'rejected' | 'no_response';\r\n}\r\n\r\n/** æ­¥é©Ÿçµæœ */\r\nexport interface StepResult {\r\n  status: 'success' | 'failed' | 'skipped';\r\n  data?: any;\r\n  error?: string;\r\n  timestamp: Date;\r\n}\r\n\r\n/** èˆˆè¶£ä¿¡è™Ÿ */\r\nexport interface InterestSignal {\r\n  type: 'price_inquiry' | 'product_detail' | 'purchase_intent' | 'positive_feedback' | 'comparison';\r\n  keyword: string;\r\n  confidence: number;\r\n  message: string;\r\n  detectedAt: Date;\r\n}\r\n\r\n// ============ é è¨­èˆˆè¶£ä¿¡è™Ÿé—œéµè© ============\r\n\r\nconst DEFAULT_INTEREST_SIGNALS: Record<string, string[]> = {\r\n  price_inquiry: ['å¤šå°‘éŒ¢', 'ä»€éº¼åƒ¹æ ¼', 'åƒ¹æ ¼', 'è²»ç”¨', 'æ”¶è²»', 'æ€éº¼æ”¶', 'å ±åƒ¹'],\r\n  product_detail: ['æ€éº¼ç”¨', 'æœ‰ä»€éº¼åŠŸèƒ½', 'è©³ç´°ä»‹ç´¹', 'äº†è§£ä¸€ä¸‹', 'èƒ½åšä»€éº¼'],\r\n  purchase_intent: ['æ€éº¼è²·', 'åœ¨å“ªè²·', 'æˆ‘è¦', 'æˆ‘æƒ³è²·', 'ä¸‹å–®', 'ä»˜æ¬¾', 'è³¼è²·'],\r\n  positive_feedback: ['ä¸éŒ¯', 'æŒºå¥½', 'å¯ä»¥', 'è¡Œ', 'å¥½çš„', 'æ„Ÿèˆˆè¶£'],\r\n  comparison: ['æ¯”', 'å°æ¯”', 'å€åˆ¥', 'å·®åˆ¥', 'å“ªå€‹å¥½']\r\n};\r\n\r\n// ============ é è¨­å·¥ä½œæµ ============\r\n\r\nconst DEFAULT_WORKFLOW: AutomationWorkflow = {\r\n  id: 'default_marketing',\r\n  name: 'æ™ºèƒ½ç‡ŸéŠ·å·¥ä½œæµ',\r\n  enabled: false,\r\n  trigger: {\r\n    type: 'keyword_match',\r\n    minIntentScore: 60,\r\n    cooldownMinutes: 1440,  // 24å°æ™‚\r\n    excludeContacted: true,\r\n    excludeBlacklist: true\r\n  },\r\n  steps: [\r\n    { id: 'evaluate', type: 'evaluate', name: 'ç”¨æˆ¶è©•ä¼°', config: {}, nextOnSuccess: 'plan' },\r\n    { id: 'plan', type: 'plan', name: 'AI ç­–åŠƒ', config: {}, nextOnSuccess: 'private_chat' },\r\n    { id: 'private_chat', type: 'private_chat', name: 'ç§èŠå”ä½œ', config: {}, nextOnSuccess: 'detect_interest' },\r\n    { id: 'detect_interest', type: 'detect_interest', name: 'èˆˆè¶£æª¢æ¸¬', config: {}, nextOnSuccess: 'create_group', nextOnFail: 'record' },\r\n    { id: 'create_group', type: 'create_group', name: 'è‡ªå‹•å»ºç¾¤', config: {}, nextOnSuccess: 'group_marketing' },\r\n    { id: 'group_marketing', type: 'group_marketing', name: 'çµ„ç¾¤ç‡ŸéŠ·', config: {}, nextOnSuccess: 'record' },\r\n    { id: 'record', type: 'record', name: 'è¨˜éŒ„çµæœ', config: {} }\r\n  ],\r\n  config: {\r\n    marketingGoal: 'ä¿ƒé€²æˆäº¤',\r\n    roleCount: 'auto',\r\n    accountSelection: 'auto',\r\n    firstContactDelay: { min: 5, max: 15 },\r\n    interestSignals: ['price_inquiry', 'purchase_intent', 'positive_feedback']\r\n  },\r\n  stats: {\r\n    totalTriggers: 0,\r\n    todayTriggers: 0,\r\n    activeExecutions: 0,\r\n    conversions: 0\r\n  },\r\n  createdAt: new Date(),\r\n  updatedAt: new Date()\r\n};\r\n\r\n@Injectable({ providedIn: 'root' })\r\nexport class AutomationWorkflowService {\r\n  private readonly ipc = inject(ElectronIpcService);\r\n  private readonly toast = inject(ToastService);\r\n  private readonly contacts = inject(UnifiedContactsService);\r\n  \r\n  // ============ ç‹€æ…‹ ============\r\n  \r\n  private readonly STORAGE_KEY = 'automationWorkflows';\r\n  \r\n  // å·¥ä½œæµåˆ—è¡¨\r\n  private _workflows = signal<AutomationWorkflow[]>([DEFAULT_WORKFLOW]);\r\n  workflows = this._workflows.asReadonly();\r\n  \r\n  // åŸ·è¡Œä¸­çš„å¯¦ä¾‹\r\n  private _executions = signal<Map<string, WorkflowExecution>>(new Map());\r\n  executions = computed(() => Array.from(this._executions().values()));\r\n  \r\n  // æ´»èºåŸ·è¡Œæ•¸\r\n  activeExecutionCount = computed(() => \r\n    this.executions().filter(e => e.status === 'running' || e.status === 'pending').length\r\n  );\r\n  \r\n  // ç”¨æˆ¶å†·å»è¨˜éŒ„ (userId -> lastTriggerTime)\r\n  private userCooldowns = new Map<string, Date>();\r\n  \r\n  // IPC æ¸…ç†å‡½æ•¸\r\n  private ipcCleanups: (() => void)[] = [];\r\n  \r\n  constructor() {\r\n    this.loadFromStorage();\r\n    this.setupEventListeners();\r\n    \r\n    console.log('[AutomationWorkflow] æœå‹™å·²åˆå§‹åŒ–');\r\n  }\r\n  \r\n  // ============ äº‹ä»¶ç›£è½ ============\r\n  \r\n  private setupEventListeners(): void {\r\n    // ç›£è½é—œéµè©åŒ¹é…äº‹ä»¶\r\n    const cleanup1 = this.ipc.on('keyword-matched', (data: any) => {\r\n      this.handleKeywordMatch(data);\r\n    });\r\n    this.ipcCleanups.push(cleanup1);\r\n    \r\n    // ç›£è¯ç”¨æˆ¶æ•ç²äº‹ä»¶\r\n    const cleanup2 = this.ipc.on('lead-captured', (data: any) => {\r\n      this.handleLeadCaptured(data);\r\n    });\r\n    this.ipcCleanups.push(cleanup2);\r\n    \r\n    // ç›£è½ç§èŠæ¶ˆæ¯ï¼ˆç”¨æ–¼èˆˆè¶£ä¿¡è™Ÿæª¢æ¸¬ï¼‰\r\n    const cleanup3 = this.ipc.on('private-message-received', (data: any) => {\r\n      this.handlePrivateMessage(data);\r\n    });\r\n    this.ipcCleanups.push(cleanup3);\r\n    \r\n    // ç›£è½å”ä½œæœƒè©±å®Œæˆ\r\n    const cleanup4 = this.ipc.on('collaboration-session-completed', (data: any) => {\r\n      this.handleSessionCompleted(data);\r\n    });\r\n    this.ipcCleanups.push(cleanup4);\r\n  }\r\n  \r\n  // ============ äº‹ä»¶è™•ç† ============\r\n  \r\n  /**\r\n   * è™•ç†é—œéµè©åŒ¹é…äº‹ä»¶\r\n   */\r\n  private handleKeywordMatch(data: {\r\n    keyword: string;\r\n    groupUrl: string;\r\n    groupName: string;\r\n    userId: string;\r\n    username: string;\r\n    firstName: string;\r\n    messagePreview: string;\r\n    timestamp: string;\r\n  }): void {\r\n    console.log('[AutomationWorkflow] æ”¶åˆ°é—œéµè©åŒ¹é…:', data);\r\n    \r\n    // æª¢æŸ¥æ˜¯å¦æœ‰å•Ÿç”¨çš„å·¥ä½œæµ\r\n    const enabledWorkflows = this._workflows().filter(w => w.enabled && w.trigger.type === 'keyword_match');\r\n    \r\n    if (enabledWorkflows.length === 0) {\r\n      console.log('[AutomationWorkflow] ç„¡å•Ÿç”¨çš„å·¥ä½œæµï¼Œè·³é');\r\n      return;\r\n    }\r\n    \r\n    for (const workflow of enabledWorkflows) {\r\n      this.tryTriggerWorkflow(workflow, data);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * å˜—è©¦è§¸ç™¼å·¥ä½œæµ\r\n   */\r\n  private async tryTriggerWorkflow(workflow: AutomationWorkflow, userData: any): Promise<void> {\r\n    const userId = userData.userId;\r\n    \r\n    // æª¢æŸ¥å†·å»\r\n    if (this.isUserInCooldown(userId, workflow.trigger.cooldownMinutes || 1440)) {\r\n      console.log(`[AutomationWorkflow] ç”¨æˆ¶ ${userId} åœ¨å†·å»æœŸå…§ï¼Œè·³é`);\r\n      return;\r\n    }\r\n    \r\n    // æª¢æŸ¥æ˜¯å¦å·²æœ‰é€²è¡Œä¸­çš„åŸ·è¡Œ\r\n    const existingExecution = this.executions().find(\r\n      e => e.targetUserId === userId && (e.status === 'running' || e.status === 'pending')\r\n    );\r\n    if (existingExecution) {\r\n      console.log(`[AutomationWorkflow] ç”¨æˆ¶ ${userId} å·²æœ‰é€²è¡Œä¸­çš„å·¥ä½œæµï¼Œè·³é`);\r\n      return;\r\n    }\r\n    \r\n    // è©•ä¼°ç”¨æˆ¶æ„å‘åˆ†\r\n    const intentScore = this.evaluateUserIntent(userData);\r\n    const minScore = workflow.trigger.minIntentScore || 60;\r\n    \r\n    if (intentScore < minScore) {\r\n      console.log(`[AutomationWorkflow] ç”¨æˆ¶æ„å‘åˆ† ${intentScore} < ${minScore}ï¼Œè·³é`);\r\n      return;\r\n    }\r\n    \r\n    // å‰µå»ºåŸ·è¡Œå¯¦ä¾‹\r\n    const execution = this.createExecution(workflow, userData, intentScore);\r\n    \r\n    // æ›´æ–°å†·å»è¨˜éŒ„\r\n    this.userCooldowns.set(userId, new Date());\r\n    \r\n    // æ›´æ–°çµ±è¨ˆ\r\n    this.updateWorkflowStats(workflow.id, 'trigger');\r\n    \r\n    // é–‹å§‹åŸ·è¡Œ\r\n    this.toast.success(`ğŸš€ è‡ªå‹•è§¸ç™¼å·¥ä½œæµï¼š${workflow.name}`);\r\n    console.log(`[AutomationWorkflow] é–‹å§‹åŸ·è¡Œå·¥ä½œæµ: ${workflow.name}ï¼Œç›®æ¨™ç”¨æˆ¶: ${userData.username || userId}`);\r\n    \r\n    // å»¶é²å¾Œé–‹å§‹ï¼ˆé¿å…å¤ªæ©Ÿæ¢°åŒ–ï¼‰\r\n    const delay = this.getRandomDelay(workflow.config.firstContactDelay);\r\n    console.log(`[AutomationWorkflow] å°‡åœ¨ ${delay} ç§’å¾Œé–‹å§‹åŸ·è¡Œ`);\r\n    \r\n    setTimeout(() => {\r\n      this.executeWorkflow(execution.id);\r\n    }, delay * 1000);\r\n  }\r\n  \r\n  /**\r\n   * è™•ç†ç”¨æˆ¶æ•ç²äº‹ä»¶\r\n   */\r\n  private handleLeadCaptured(data: any): void {\r\n    console.log('[AutomationWorkflow] æ”¶åˆ°ç”¨æˆ¶æ•ç²äº‹ä»¶:', data);\r\n    // å¯ç”¨æ–¼æ›´æ–°åŸ·è¡Œç‹€æ…‹æˆ–è§¸ç™¼å¾ŒçºŒæ­¥é©Ÿ\r\n  }\r\n  \r\n  /**\r\n   * è™•ç†ç§èŠæ¶ˆæ¯ï¼ˆèˆˆè¶£ä¿¡è™Ÿæª¢æ¸¬ï¼‰\r\n   */\r\n  private handlePrivateMessage(data: {\r\n    userId: string;\r\n    message: string;\r\n    fromUser: boolean;\r\n  }): void {\r\n    if (!data.fromUser) return;  // åªåˆ†æç”¨æˆ¶æ¶ˆæ¯\r\n    \r\n    // æŸ¥æ‰¾è©²ç”¨æˆ¶çš„æ´»èºåŸ·è¡Œ\r\n    const execution = this.executions().find(\r\n      e => e.targetUserId === data.userId && e.status === 'running' && e.currentStep === 'private_chat'\r\n    );\r\n    \r\n    if (!execution) return;\r\n    \r\n    // æª¢æ¸¬èˆˆè¶£ä¿¡è™Ÿ\r\n    const signal = this.detectInterestSignal(data.message);\r\n    \r\n    if (signal) {\r\n      console.log(`[AutomationWorkflow] æª¢æ¸¬åˆ°èˆˆè¶£ä¿¡è™Ÿ:`, signal);\r\n      \r\n      // æ›´æ–°åŸ·è¡Œç‹€æ…‹\r\n      this.updateExecutionStep(execution.id, 'detect_interest', {\r\n        status: 'success',\r\n        data: signal,\r\n        timestamp: new Date()\r\n      });\r\n      \r\n      // å¦‚æœæ˜¯å¼·è³¼è²·æ„å‘ï¼Œè§¸ç™¼å»ºç¾¤\r\n      if (signal.type === 'purchase_intent' || signal.type === 'price_inquiry') {\r\n        this.toast.info(`ğŸ¯ æª¢æ¸¬åˆ°è³¼è²·æ„å‘ï¼æº–å‚™è‡ªå‹•å»ºç¾¤...`);\r\n        this.advanceToStep(execution.id, 'create_group');\r\n      }\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * è™•ç†å”ä½œæœƒè©±å®Œæˆ\r\n   */\r\n  private handleSessionCompleted(data: {\r\n    sessionId: string;\r\n    outcome: string;\r\n    targetUserId: string;\r\n  }): void {\r\n    // æŸ¥æ‰¾å°æ‡‰çš„åŸ·è¡Œ\r\n    const execution = this.executions().find(e => e.sessionId === data.sessionId);\r\n    \r\n    if (execution) {\r\n      this.updateExecution(execution.id, {\r\n        outcome: data.outcome as any,\r\n        status: 'completed',\r\n        completedAt: new Date()\r\n      });\r\n      \r\n      if (data.outcome === 'converted') {\r\n        this.updateWorkflowStats(execution.workflowId, 'conversion');\r\n      }\r\n    }\r\n  }\r\n  \r\n  // ============ å·¥ä½œæµåŸ·è¡Œ ============\r\n  \r\n  /**\r\n   * åŸ·è¡Œå·¥ä½œæµ\r\n   */\r\n  async executeWorkflow(executionId: string): Promise<void> {\r\n    const execution = this._executions().get(executionId);\r\n    if (!execution) return;\r\n    \r\n    const workflow = this._workflows().find(w => w.id === execution.workflowId);\r\n    if (!workflow) return;\r\n    \r\n    // æ›´æ–°ç‹€æ…‹ç‚ºé‹è¡Œä¸­\r\n    this.updateExecution(executionId, { status: 'running' });\r\n    \r\n    // ç²å–ç•¶å‰æ­¥é©Ÿ\r\n    const currentStep = workflow.steps.find(s => s.id === execution.currentStep);\r\n    if (!currentStep) return;\r\n    \r\n    console.log(`[AutomationWorkflow] åŸ·è¡Œæ­¥é©Ÿ: ${currentStep.name}`);\r\n    \r\n    try {\r\n      // æ ¹æ“šæ­¥é©Ÿé¡å‹åŸ·è¡Œ\r\n      const result = await this.executeStep(execution, currentStep, workflow);\r\n      \r\n      // è¨˜éŒ„çµæœ\r\n      this.updateExecutionStep(executionId, currentStep.id, result);\r\n      \r\n      // æ±ºå®šä¸‹ä¸€æ­¥\r\n      const nextStepId = result.status === 'success' ? currentStep.nextOnSuccess : currentStep.nextOnFail;\r\n      \r\n      if (nextStepId) {\r\n        this.advanceToStep(executionId, nextStepId);\r\n      } else {\r\n        // å·¥ä½œæµå®Œæˆ\r\n        this.updateExecution(executionId, { \r\n          status: 'completed',\r\n          completedAt: new Date()\r\n        });\r\n        console.log(`[AutomationWorkflow] å·¥ä½œæµåŸ·è¡Œå®Œæˆ: ${executionId}`);\r\n      }\r\n    } catch (error: any) {\r\n      console.error(`[AutomationWorkflow] æ­¥é©ŸåŸ·è¡Œå¤±æ•—:`, error);\r\n      this.updateExecutionStep(executionId, currentStep.id, {\r\n        status: 'failed',\r\n        error: error.message,\r\n        timestamp: new Date()\r\n      });\r\n      this.updateExecution(executionId, { status: 'failed' });\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * åŸ·è¡Œå–®å€‹æ­¥é©Ÿ\r\n   */\r\n  private async executeStep(execution: WorkflowExecution, step: WorkflowStep, workflow: AutomationWorkflow): Promise<StepResult> {\r\n    switch (step.type) {\r\n      case 'evaluate':\r\n        // ç”¨æˆ¶è©•ä¼°å·²åœ¨è§¸ç™¼æ™‚å®Œæˆ\r\n        return { status: 'success', timestamp: new Date() };\r\n        \r\n      case 'plan':\r\n        // è§¸ç™¼ AI ç­–åŠƒ\r\n        return await this.executeAiPlanStep(execution, workflow);\r\n        \r\n      case 'private_chat':\r\n        // é–‹å§‹ç§èŠå”ä½œ\r\n        return await this.executePrivateChatStep(execution, workflow);\r\n        \r\n      case 'detect_interest':\r\n        // èˆˆè¶£æª¢æ¸¬æ˜¯è¢«å‹•çš„ï¼Œé€™è£¡åªæ˜¯ç­‰å¾…\r\n        return { status: 'success', timestamp: new Date() };\r\n        \r\n      case 'create_group':\r\n        // è‡ªå‹•å»ºç¾¤\r\n        return await this.executeCreateGroupStep(execution, workflow);\r\n        \r\n      case 'group_marketing':\r\n        // çµ„ç¾¤ç‡ŸéŠ·\r\n        return await this.executeGroupMarketingStep(execution, workflow);\r\n        \r\n      case 'record':\r\n        // è¨˜éŒ„çµæœ\r\n        return this.executeRecordStep(execution);\r\n        \r\n      default:\r\n        return { status: 'skipped', timestamp: new Date() };\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * åŸ·è¡Œ AI ç­–åŠƒæ­¥é©Ÿ\r\n   */\r\n  private async executeAiPlanStep(execution: WorkflowExecution, workflow: AutomationWorkflow): Promise<StepResult> {\r\n    return new Promise((resolve) => {\r\n      const goal = workflow.config.marketingGoal || 'ä¿ƒé€²æˆäº¤';\r\n      \r\n      console.log(`[AutomationWorkflow] èª¿ç”¨ AI ç­–åŠƒï¼Œç›®æ¨™: ${goal}`);\r\n      \r\n      // ç™¼é€ AI ç­–åŠƒè«‹æ±‚\r\n      this.ipc.send('multi-role:ai-plan', {\r\n        goal,\r\n        targetUsers: [{\r\n          id: execution.targetUserId,\r\n          username: execution.targetUserName\r\n        }],\r\n        autoExecute: true,\r\n        workflowExecutionId: execution.id\r\n      });\r\n      \r\n      // ç›£è½çµæœ\r\n      const cleanup = this.ipc.on('multi-role:ai-plan-result', (data: any) => {\r\n        cleanup();\r\n        \r\n        if (data.success) {\r\n          // ä¿å­˜ç­–åŠƒçµæœåˆ°åŸ·è¡Œå¯¦ä¾‹\r\n          this.updateExecution(execution.id, { aiPlanResult: data });\r\n          resolve({ status: 'success', data, timestamp: new Date() });\r\n        } else {\r\n          resolve({ status: 'failed', error: data.error, timestamp: new Date() });\r\n        }\r\n      });\r\n      \r\n      // è¶…æ™‚è™•ç†\r\n      setTimeout(() => {\r\n        cleanup();\r\n        resolve({ status: 'failed', error: 'ç­–åŠƒè¶…æ™‚', timestamp: new Date() });\r\n      }, 60000);\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * åŸ·è¡Œç§èŠå”ä½œæ­¥é©Ÿ\r\n   */\r\n  private async executePrivateChatStep(execution: WorkflowExecution, workflow: AutomationWorkflow): Promise<StepResult> {\r\n    console.log(`[AutomationWorkflow] é–‹å§‹ç§èŠå”ä½œï¼Œç›®æ¨™ç”¨æˆ¶: ${execution.targetUserName}`);\r\n    \r\n    // ç™¼é€é–‹å§‹ç§èŠå”ä½œè«‹æ±‚\r\n    this.ipc.send('multi-role:start-private-collaboration', {\r\n      targetUserId: execution.targetUserId,\r\n      targetUserName: execution.targetUserName,\r\n      aiPlanResult: execution.aiPlanResult,\r\n      workflowExecutionId: execution.id\r\n    });\r\n    \r\n    // ç§èŠæ˜¯é•·æ™‚é–“é‹è¡Œçš„ï¼Œé€™è£¡åªæ¨™è¨˜é–‹å§‹\r\n    return { status: 'success', timestamp: new Date() };\r\n  }\r\n  \r\n  /**\r\n   * åŸ·è¡Œå»ºç¾¤æ­¥é©Ÿ\r\n   */\r\n  private async executeCreateGroupStep(execution: WorkflowExecution, workflow: AutomationWorkflow): Promise<StepResult> {\r\n    return new Promise((resolve) => {\r\n      const groupName = (workflow.config.groupNameTemplate || 'VIP æœå‹™ç¾¤ - {user}')\r\n        .replace('{user}', execution.targetUserName);\r\n      \r\n      console.log(`[AutomationWorkflow] è‡ªå‹•å»ºç¾¤: ${groupName}`);\r\n      \r\n      this.ipc.send('multi-role:auto-create-group', {\r\n        groupName,\r\n        targetUserId: execution.targetUserId,\r\n        workflowExecutionId: execution.id\r\n      });\r\n      \r\n      const cleanup = this.ipc.on('multi-role:group-created', (data: any) => {\r\n        cleanup();\r\n        \r\n        if (data.success) {\r\n          this.updateExecution(execution.id, { groupId: data.groupId });\r\n          this.toast.success(`âœ… å·²è‡ªå‹•å‰µå»ºç¾¤çµ„: ${groupName}`);\r\n          resolve({ status: 'success', data, timestamp: new Date() });\r\n        } else {\r\n          resolve({ status: 'failed', error: data.error, timestamp: new Date() });\r\n        }\r\n      });\r\n      \r\n      setTimeout(() => {\r\n        cleanup();\r\n        resolve({ status: 'failed', error: 'å»ºç¾¤è¶…æ™‚', timestamp: new Date() });\r\n      }, 120000);\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * åŸ·è¡Œçµ„ç¾¤ç‡ŸéŠ·æ­¥é©Ÿ\r\n   */\r\n  private async executeGroupMarketingStep(execution: WorkflowExecution, workflow: AutomationWorkflow): Promise<StepResult> {\r\n    if (!execution.groupId) {\r\n      return { status: 'skipped', timestamp: new Date() };\r\n    }\r\n    \r\n    console.log(`[AutomationWorkflow] é–‹å§‹çµ„ç¾¤ç‡ŸéŠ·ï¼Œç¾¤çµ„: ${execution.groupId}`);\r\n    \r\n    this.ipc.send('multi-role:start-group-collaboration', {\r\n      groupId: execution.groupId,\r\n      aiPlanResult: execution.aiPlanResult,\r\n      workflowExecutionId: execution.id\r\n    });\r\n    \r\n    return { status: 'success', timestamp: new Date() };\r\n  }\r\n  \r\n  /**\r\n   * åŸ·è¡Œè¨˜éŒ„æ­¥é©Ÿ\r\n   */\r\n  private executeRecordStep(execution: WorkflowExecution): StepResult {\r\n    console.log(`[AutomationWorkflow] è¨˜éŒ„åŸ·è¡Œçµæœ:`, execution);\r\n    \r\n    // æ›´æ–°çµ±ä¸€é€šè¨ŠéŒ„ä¸­çš„ç”¨æˆ¶ç‹€æ…‹\r\n    // this.contacts.updateContact(execution.targetUserId, { ... });\r\n    \r\n    return { status: 'success', timestamp: new Date() };\r\n  }\r\n  \r\n  // ============ è¼”åŠ©æ–¹æ³• ============\r\n  \r\n  /**\r\n   * è©•ä¼°ç”¨æˆ¶æ„å‘åˆ†\r\n   */\r\n  private evaluateUserIntent(userData: any): number {\r\n    let score = 50;  // åŸºç¤åˆ†\r\n    \r\n    // é—œéµè©åŠ åˆ†\r\n    const message = userData.messagePreview?.toLowerCase() || '';\r\n    \r\n    if (message.includes('åƒ¹æ ¼') || message.includes('å¤šå°‘éŒ¢')) score += 20;\r\n    if (message.includes('æ€éº¼è²·') || message.includes('è³¼è²·')) score += 25;\r\n    if (message.includes('äº†è§£') || message.includes('ä»‹ç´¹')) score += 10;\r\n    if (message.includes('æ€¥') || message.includes('é¦¬ä¸Š')) score += 15;\r\n    \r\n    return Math.min(100, score);\r\n  }\r\n  \r\n  /**\r\n   * æª¢æ¸¬èˆˆè¶£ä¿¡è™Ÿï¼ˆé—œéµè©åŒ¹é…ï¼‰\r\n   */\r\n  private detectInterestSignal(message: string): InterestSignal | null {\r\n    const lowerMessage = message.toLowerCase();\r\n    \r\n    // 1. é¦–å…ˆç”¨é—œéµè©åŒ¹é…\r\n    for (const [type, keywords] of Object.entries(DEFAULT_INTEREST_SIGNALS)) {\r\n      for (const keyword of keywords) {\r\n        if (lowerMessage.includes(keyword)) {\r\n          return {\r\n            type: type as InterestSignal['type'],\r\n            keyword,\r\n            confidence: 0.8,\r\n            message,\r\n            detectedAt: new Date()\r\n          };\r\n        }\r\n      }\r\n    }\r\n    \r\n    return null;\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• Phase2: AI å¢å¼·èˆˆè¶£ä¿¡è™Ÿæª¢æ¸¬\r\n   * ä½¿ç”¨ AI åˆ†ææ¶ˆæ¯èªç¾©ï¼Œè­˜åˆ¥æ›´è¤‡é›œçš„è³¼è²·æ„å‘\r\n   */\r\n  async detectInterestSignalWithAI(message: string, conversationHistory: string[] = []): Promise<InterestSignal | null> {\r\n    // é¦–å…ˆå˜—è©¦é—œéµè©åŒ¹é…ï¼ˆå¿«é€Ÿï¼‰\r\n    const quickMatch = this.detectInterestSignal(message);\r\n    if (quickMatch && quickMatch.confidence >= 0.8) {\r\n      return quickMatch;\r\n    }\r\n    \r\n    // å°æ–¼ä¸ç¢ºå®šçš„æƒ…æ³ï¼Œä½¿ç”¨ AI åˆ†æ\r\n    return new Promise((resolve) => {\r\n      const context = conversationHistory.slice(-5).join('\\n');\r\n      \r\n      this.ipc.send('ai:analyze-interest', {\r\n        message,\r\n        context,\r\n        analysisType: 'interest_signal'\r\n      });\r\n      \r\n      const cleanup = this.ipc.on('ai:analyze-interest-result', (data: any) => {\r\n        cleanup();\r\n        \r\n        if (data.success && data.hasInterest) {\r\n          resolve({\r\n            type: this.mapAISignalType(data.signalType),\r\n            keyword: data.keyPhrase || message.substring(0, 20),\r\n            confidence: data.confidence || 0.7,\r\n            message,\r\n            detectedAt: new Date()\r\n          });\r\n        } else {\r\n          resolve(null);\r\n        }\r\n      });\r\n      \r\n      // è¶…æ™‚å›é€€åˆ°é—œéµè©çµæœ\r\n      setTimeout(() => {\r\n        cleanup();\r\n        resolve(quickMatch);\r\n      }, 5000);\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * æ˜ å°„ AI ä¿¡è™Ÿé¡å‹\r\n   */\r\n  private mapAISignalType(aiType: string): InterestSignal['type'] {\r\n    const mapping: Record<string, InterestSignal['type']> = {\r\n      'price': 'price_inquiry',\r\n      'buying': 'purchase_intent',\r\n      'positive': 'positive_feedback',\r\n      'detail': 'product_detail',\r\n      'compare': 'comparison'\r\n    };\r\n    return mapping[aiType] || 'positive_feedback';\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• Phase2: åˆ†æå°è©±éšæ®µ\r\n   * åˆ¤æ–·ç•¶å‰å°è©±è™•æ–¼å“ªå€‹éŠ·å”®éšæ®µ\r\n   */\r\n  analyzeConversationStage(messages: { fromUser: boolean; text: string }[]): {\r\n    stage: 'awareness' | 'interest' | 'consideration' | 'intent' | 'purchase';\r\n    confidence: number;\r\n    nextAction: string;\r\n  } {\r\n    const userMessages = messages.filter(m => m.fromUser).map(m => m.text.toLowerCase());\r\n    const lastUserMessage = userMessages[userMessages.length - 1] || '';\r\n    \r\n    // è³¼è²·éšæ®µæª¢æ¸¬\r\n    if (this.containsAny(lastUserMessage, ['æ€éº¼ä»˜æ¬¾', 'ä¸‹å–®', 'è³¼è²·', 'ä»˜éŒ¢', 'è½‰å¸³'])) {\r\n      return { stage: 'purchase', confidence: 0.9, nextAction: 'æä¾›ä»˜æ¬¾æ–¹å¼' };\r\n    }\r\n    \r\n    // æ„å‘éšæ®µ\r\n    if (this.containsAny(lastUserMessage, ['å¤šå°‘éŒ¢', 'åƒ¹æ ¼', 'å„ªæƒ ', 'æŠ˜æ‰£', 'ä¾¿å®œ'])) {\r\n      return { stage: 'intent', confidence: 0.85, nextAction: 'å ±åƒ¹ä¸¦å¼·èª¿åƒ¹å€¼' };\r\n    }\r\n    \r\n    // è€ƒæ…®éšæ®µ\r\n    if (this.containsAny(lastUserMessage, ['æœ‰ä»€éº¼', 'èƒ½åšä»€éº¼', 'åŠŸèƒ½', 'è©³ç´°', 'äº†è§£'])) {\r\n      return { stage: 'consideration', confidence: 0.8, nextAction: 'è©³ç´°ä»‹ç´¹ç”¢å“' };\r\n    }\r\n    \r\n    // èˆˆè¶£éšæ®µ\r\n    if (this.containsAny(lastUserMessage, ['ä¸éŒ¯', 'å¯ä»¥', 'æŒºå¥½', 'æ„Ÿèˆˆè¶£'])) {\r\n      return { stage: 'interest', confidence: 0.7, nextAction: 'æŒ–æ˜éœ€æ±‚' };\r\n    }\r\n    \r\n    // èªçŸ¥éšæ®µ\r\n    return { stage: 'awareness', confidence: 0.6, nextAction: 'å»ºç«‹ä¿¡ä»»' };\r\n  }\r\n  \r\n  /**\r\n   * è¼”åŠ©ï¼šæª¢æŸ¥æ˜¯å¦åŒ…å«ä»»ä¸€é—œéµè©\r\n   */\r\n  private containsAny(text: string, keywords: string[]): boolean {\r\n    return keywords.some(k => text.includes(k));\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• Phase2: è¨ˆç®—è½‰åŒ–æ¦‚ç‡\r\n   */\r\n  calculateConversionProbability(execution: WorkflowExecution): number {\r\n    let probability = 0.3;  // åŸºç¤æ¦‚ç‡\r\n    \r\n    const stepResults = execution.stepResults;\r\n    \r\n    // AI ç­–åŠƒæˆåŠŸ +10%\r\n    if (stepResults['plan']?.status === 'success') {\r\n      probability += 0.1;\r\n    }\r\n    \r\n    // ç§èŠé–‹å§‹ +15%\r\n    if (stepResults['private_chat']?.status === 'success') {\r\n      probability += 0.15;\r\n    }\r\n    \r\n    // æª¢æ¸¬åˆ°èˆˆè¶£ä¿¡è™Ÿ +25%\r\n    if (stepResults['detect_interest']?.status === 'success') {\r\n      probability += 0.25;\r\n      \r\n      // å¦‚æœæ˜¯è³¼è²·æ„å‘ä¿¡è™Ÿï¼Œé¡å¤– +15%\r\n      const signal = stepResults['detect_interest']?.data as InterestSignal;\r\n      if (signal?.type === 'purchase_intent' || signal?.type === 'price_inquiry') {\r\n        probability += 0.15;\r\n      }\r\n    }\r\n    \r\n    // å»ºç¾¤æˆåŠŸ +10%\r\n    if (stepResults['create_group']?.status === 'success') {\r\n      probability += 0.1;\r\n    }\r\n    \r\n    return Math.min(0.95, probability);\r\n  }\r\n  \r\n  /**\r\n   * æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦åœ¨å†·å»æœŸ\r\n   */\r\n  private isUserInCooldown(userId: string, cooldownMinutes: number): boolean {\r\n    const lastTrigger = this.userCooldowns.get(userId);\r\n    if (!lastTrigger) return false;\r\n    \r\n    const cooldownMs = cooldownMinutes * 60 * 1000;\r\n    return Date.now() - lastTrigger.getTime() < cooldownMs;\r\n  }\r\n  \r\n  /**\r\n   * ç²å–éš¨æ©Ÿå»¶é²\r\n   */\r\n  private getRandomDelay(range: { min: number; max: number }): number {\r\n    return Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;\r\n  }\r\n  \r\n  /**\r\n   * å‰µå»ºåŸ·è¡Œå¯¦ä¾‹\r\n   */\r\n  private createExecution(workflow: AutomationWorkflow, userData: any, intentScore: number): WorkflowExecution {\r\n    const execution: WorkflowExecution = {\r\n      id: `exec_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n      workflowId: workflow.id,\r\n      targetUserId: userData.userId,\r\n      targetUserName: userData.username || userData.firstName || 'User',\r\n      currentStep: workflow.steps[0].id,\r\n      status: 'pending',\r\n      stepResults: {},\r\n      startedAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    this._executions.update(map => {\r\n      const newMap = new Map(map);\r\n      newMap.set(execution.id, execution);\r\n      return newMap;\r\n    });\r\n    \r\n    return execution;\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°åŸ·è¡Œå¯¦ä¾‹\r\n   */\r\n  private updateExecution(id: string, updates: Partial<WorkflowExecution>): void {\r\n    this._executions.update(map => {\r\n      const newMap = new Map(map);\r\n      const execution = newMap.get(id);\r\n      if (execution) {\r\n        newMap.set(id, { ...execution, ...updates, updatedAt: new Date() });\r\n      }\r\n      return newMap;\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°åŸ·è¡Œæ­¥é©Ÿçµæœ\r\n   */\r\n  private updateExecutionStep(executionId: string, stepId: string, result: StepResult): void {\r\n    this._executions.update(map => {\r\n      const newMap = new Map(map);\r\n      const execution = newMap.get(executionId);\r\n      if (execution) {\r\n        newMap.set(executionId, {\r\n          ...execution,\r\n          stepResults: { ...execution.stepResults, [stepId]: result },\r\n          updatedAt: new Date()\r\n        });\r\n      }\r\n      return newMap;\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * æ¨é€²åˆ°ä¸‹ä¸€æ­¥\r\n   */\r\n  private advanceToStep(executionId: string, nextStepId: string): void {\r\n    this.updateExecution(executionId, { currentStep: nextStepId });\r\n    \r\n    // å»¶é²åŸ·è¡Œä¸‹ä¸€æ­¥\r\n    setTimeout(() => {\r\n      this.executeWorkflow(executionId);\r\n    }, 1000);\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°å·¥ä½œæµçµ±è¨ˆ\r\n   */\r\n  private updateWorkflowStats(workflowId: string, type: 'trigger' | 'conversion'): void {\r\n    this._workflows.update(workflows => \r\n      workflows.map(w => {\r\n        if (w.id !== workflowId) return w;\r\n        \r\n        return {\r\n          ...w,\r\n          stats: {\r\n            ...w.stats,\r\n            totalTriggers: w.stats.totalTriggers + (type === 'trigger' ? 1 : 0),\r\n            todayTriggers: w.stats.todayTriggers + (type === 'trigger' ? 1 : 0),\r\n            conversions: w.stats.conversions + (type === 'conversion' ? 1 : 0),\r\n            lastTriggeredAt: type === 'trigger' ? new Date() : w.stats.lastTriggeredAt\r\n          },\r\n          updatedAt: new Date()\r\n        };\r\n      })\r\n    );\r\n    \r\n    this.saveToStorage();\r\n  }\r\n  \r\n  // ============ å…¬é–‹ API ============\r\n  \r\n  /**\r\n   * å•Ÿç”¨/ç¦ç”¨å·¥ä½œæµ\r\n   */\r\n  toggleWorkflow(id: string, enabled: boolean): void {\r\n    this._workflows.update(workflows =>\r\n      workflows.map(w => w.id === id ? { ...w, enabled, updatedAt: new Date() } : w)\r\n    );\r\n    \r\n    this.saveToStorage();\r\n    this.toast.success(enabled ? 'âœ… å·¥ä½œæµå·²å•Ÿç”¨' : 'â¸ï¸ å·¥ä½œæµå·²æš«åœ');\r\n  }\r\n  \r\n  /**\r\n   * æ‰‹å‹•è§¸ç™¼å·¥ä½œæµï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰\r\n   */\r\n  manualTrigger(workflowId: string, targetUser: { userId: string; username: string }): void {\r\n    const workflow = this._workflows().find(w => w.id === workflowId);\r\n    if (!workflow) {\r\n      this.toast.error('æ‰¾ä¸åˆ°å·¥ä½œæµ');\r\n      return;\r\n    }\r\n    \r\n    this.tryTriggerWorkflow(workflow, {\r\n      ...targetUser,\r\n      messagePreview: 'æ‰‹å‹•è§¸ç™¼',\r\n      manual: true\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * å–æ¶ˆåŸ·è¡Œ\r\n   */\r\n  cancelExecution(id: string): void {\r\n    this.updateExecution(id, { status: 'cancelled', completedAt: new Date() });\r\n    this.toast.info('å·²å–æ¶ˆå·¥ä½œæµåŸ·è¡Œ');\r\n  }\r\n  \r\n  /**\r\n   * ç²å–åŸ·è¡Œè©³æƒ…\r\n   */\r\n  getExecution(id: string): WorkflowExecution | undefined {\r\n    return this._executions().get(id);\r\n  }\r\n  \r\n  // ============ æŒä¹…åŒ– ============\r\n  \r\n  private saveToStorage(): void {\r\n    try {\r\n      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this._workflows()));\r\n    } catch (e) {\r\n      console.error('[AutomationWorkflow] ä¿å­˜å¤±æ•—:', e);\r\n    }\r\n  }\r\n  \r\n  private loadFromStorage(): void {\r\n    try {\r\n      const saved = localStorage.getItem(this.STORAGE_KEY);\r\n      if (saved) {\r\n        const workflows = JSON.parse(saved);\r\n        this._workflows.set(workflows.map((w: any) => ({\r\n          ...w,\r\n          createdAt: new Date(w.createdAt),\r\n          updatedAt: new Date(w.updatedAt),\r\n          stats: {\r\n            ...w.stats,\r\n            lastTriggeredAt: w.stats.lastTriggeredAt ? new Date(w.stats.lastTriggeredAt) : undefined\r\n          }\r\n        })));\r\n      }\r\n    } catch (e) {\r\n      console.error('[AutomationWorkflow] è¼‰å…¥å¤±æ•—:', e);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æ¸…ç†\r\n   */\r\n  destroy(): void {\r\n    this.ipcCleanups.forEach(cleanup => cleanup());\r\n  }\r\n}\r\n", "/**\r\n * ç‡ŸéŠ·æ•¸æ“šåˆ†ææœå‹™\r\n * Marketing Analytics Service\r\n * \r\n * ğŸ†• P2 éšæ®µï¼šæ•¸æ“šé©…å‹•å„ªåŒ–\r\n * \r\n * è·è²¬ï¼š\r\n * - è§’è‰²çµ„åˆæ•ˆæœçµ±è¨ˆ\r\n * - ç”¨æˆ¶ç•«åƒåˆ†æ\r\n * - è½‰åŒ–æ¼æ–—è¿½è¹¤\r\n * - ç‡ŸéŠ·å ±è¡¨ç”Ÿæˆ\r\n */\r\n\r\nimport { Injectable, signal, computed, inject } from '@angular/core';\r\nimport { ElectronIpcService } from '../electron-ipc.service';\r\n\r\n// ============ é¡å‹å®šç¾© ============\r\n\r\n// ç‡ŸéŠ·æœƒè©±è¨˜éŒ„\r\nexport interface MarketingSession {\r\n  id: string;\r\n  startTime: Date;\r\n  endTime?: Date;\r\n  \r\n  // ç›®æ¨™ç”¨æˆ¶\r\n  targetUserId: string;\r\n  targetUserName: string;\r\n  targetUserProfile?: UserProfile;\r\n  \r\n  // è§’è‰²é…ç½®\r\n  roleCombo: RoleCombo;\r\n  \r\n  // å°è©±çµ±è¨ˆ\r\n  totalMessages: number;\r\n  userMessages: number;\r\n  roleMessages: number;\r\n  avgResponseTime: number;  // æ¯«ç§’\r\n  \r\n  // éšæ®µè¿½è¹¤\r\n  stagesReached: string[];\r\n  finalStage: string;\r\n  \r\n  // çµæœ\r\n  outcome: 'converted' | 'interested' | 'neutral' | 'rejected' | 'no_response' | 'ongoing';\r\n  conversionValue?: number;  // æˆäº¤é‡‘é¡\r\n  \r\n  // è©•åˆ†\r\n  interestScore: number;     // ç”¨æˆ¶èˆˆè¶£åº¦ 0-100\r\n  engagementScore: number;   // äº’å‹•åƒèˆ‡åº¦ 0-100\r\n  \r\n  // æ¨™ç±¤\r\n  tags: string[];\r\n  notes?: string;\r\n}\r\n\r\n// è§’è‰²çµ„åˆ\r\nexport interface RoleCombo {\r\n  id: string;\r\n  name: string;\r\n  roles: {\r\n    roleId: string;\r\n    roleName: string;\r\n    roleType: string;\r\n    accountPhone: string;\r\n  }[];\r\n  hash: string;  // ç”¨æ–¼å¿«é€Ÿæ¯”å°ç›¸åŒçµ„åˆ\r\n}\r\n\r\n// ç”¨æˆ¶ç•«åƒ\r\nexport interface UserProfile {\r\n  userId: string;\r\n  \r\n  // åŸºæœ¬ä¿¡æ¯\r\n  name?: string;\r\n  username?: string;\r\n  \r\n  // è¡Œç‚ºç‰¹å¾µ\r\n  responseSpeed: 'fast' | 'normal' | 'slow';  // å›è¦†é€Ÿåº¦\r\n  messageLength: 'short' | 'medium' | 'long';  // æ¶ˆæ¯é•·åº¦åå¥½\r\n  activeHours: number[];  // æ´»èºæ™‚æ®µ\r\n  \r\n  // èˆˆè¶£æ¨™ç±¤\r\n  interests: string[];\r\n  painPoints: string[];\r\n  objections: string[];\r\n  \r\n  // è³¼è²·æ„å‘\r\n  intentLevel: 'high' | 'medium' | 'low' | 'unknown';\r\n  pricesSensitivity: 'high' | 'medium' | 'low';\r\n  \r\n  // æ­·å²çµ±è¨ˆ\r\n  totalSessions: number;\r\n  totalMessages: number;\r\n  lastContactTime?: Date;\r\n  \r\n  // æ¨™ç±¤\r\n  tags: string[];\r\n  \r\n  updatedAt: Date;\r\n}\r\n\r\n// è§’è‰²çµ„åˆçµ±è¨ˆ\r\nexport interface RoleComboStats {\r\n  comboId: string;\r\n  comboName: string;\r\n  roles: string[];\r\n  \r\n  // ä½¿ç”¨çµ±è¨ˆ\r\n  totalSessions: number;\r\n  \r\n  // æ•ˆæœçµ±è¨ˆ\r\n  conversions: number;\r\n  conversionRate: number;  // è½‰åŒ–ç‡\r\n  avgInterestScore: number;\r\n  avgEngagementScore: number;\r\n  avgSessionDuration: number;  // åˆ†é˜\r\n  avgMessageCount: number;\r\n  \r\n  // éšæ®µåˆ°é”ç‡\r\n  stageReachRates: Record<string, number>;\r\n  \r\n  // è¶¨å‹¢\r\n  trend: 'up' | 'down' | 'stable';\r\n  lastUsed: Date;\r\n}\r\n\r\n// æ—¥å ±æ•¸æ“š\r\nexport interface DailyReport {\r\n  date: string;  // YYYY-MM-DD\r\n  \r\n  // åŸºç¤çµ±è¨ˆ\r\n  totalSessions: number;\r\n  newUsers: number;\r\n  activeUsers: number;\r\n  \r\n  // è½‰åŒ–çµ±è¨ˆ\r\n  conversions: number;\r\n  conversionRate: number;\r\n  totalRevenue: number;\r\n  \r\n  // æ¶ˆæ¯çµ±è¨ˆ\r\n  totalMessages: number;\r\n  avgResponseTime: number;\r\n  \r\n  // å¸³è™Ÿä½¿ç”¨\r\n  accountUsage: {\r\n    phone: string;\r\n    sessions: number;\r\n    messages: number;\r\n  }[];\r\n  \r\n  // æœ€ä½³è§’è‰²çµ„åˆ\r\n  topRoleCombos: {\r\n    comboName: string;\r\n    conversions: number;\r\n    rate: number;\r\n  }[];\r\n  \r\n  // ç”¨æˆ¶æ¼æ–—\r\n  funnel: {\r\n    stage: string;\r\n    count: number;\r\n    rate: number;\r\n  }[];\r\n}\r\n\r\n// é€±æœŸå°æ¯”\r\nexport interface PeriodComparison {\r\n  current: {\r\n    sessions: number;\r\n    conversions: number;\r\n    revenue: number;\r\n  };\r\n  previous: {\r\n    sessions: number;\r\n    conversions: number;\r\n    revenue: number;\r\n  };\r\n  changes: {\r\n    sessions: number;  // ç™¾åˆ†æ¯”è®ŠåŒ–\r\n    conversions: number;\r\n    revenue: number;\r\n  };\r\n}\r\n\r\n// ============ æœå‹™å¯¦ç¾ ============\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MarketingAnalyticsService {\r\n  private ipc = inject(ElectronIpcService);\r\n  \r\n  // æ•¸æ“šå­˜å„²\r\n  private _sessions = signal<MarketingSession[]>([]);\r\n  private _userProfiles = signal<Map<string, UserProfile>>(new Map());\r\n  private _roleComboStats = signal<Map<string, RoleComboStats>>(new Map());\r\n  \r\n  // è¨ˆç®—å±¬æ€§\r\n  sessions = this._sessions.asReadonly();\r\n  userProfiles = computed(() => Array.from(this._userProfiles().values()));\r\n  roleComboStats = computed(() => Array.from(this._roleComboStats().values()));\r\n  \r\n  // ç¸½é«”çµ±è¨ˆ\r\n  totalStats = computed(() => {\r\n    const sessions = this._sessions();\r\n    const conversions = sessions.filter(s => s.outcome === 'converted').length;\r\n    \r\n    return {\r\n      totalSessions: sessions.length,\r\n      conversions,\r\n      conversionRate: sessions.length > 0 ? (conversions / sessions.length * 100) : 0,\r\n      avgInterestScore: this.calcAverage(sessions.map(s => s.interestScore)),\r\n      avgEngagementScore: this.calcAverage(sessions.map(s => s.engagementScore)),\r\n      totalRevenue: sessions.reduce((sum, s) => sum + (s.conversionValue || 0), 0)\r\n    };\r\n  });\r\n  \r\n  // ä»Šæ—¥çµ±è¨ˆ\r\n  todayStats = computed(() => {\r\n    const today = new Date().toISOString().split('T')[0];\r\n    const todaySessions = this._sessions().filter(s => \r\n      s.startTime.toISOString().split('T')[0] === today\r\n    );\r\n    const conversions = todaySessions.filter(s => s.outcome === 'converted').length;\r\n    \r\n    return {\r\n      sessions: todaySessions.length,\r\n      conversions,\r\n      conversionRate: todaySessions.length > 0 ? (conversions / todaySessions.length * 100) : 0,\r\n      revenue: todaySessions.reduce((sum, s) => sum + (s.conversionValue || 0), 0)\r\n    };\r\n  });\r\n  \r\n  // æœ€ä½³è§’è‰²çµ„åˆ\r\n  topRoleCombos = computed(() => {\r\n    const stats = Array.from(this._roleComboStats().values());\r\n    return stats\r\n      .filter(s => s.totalSessions >= 3)  // è‡³å°‘ 3 æ¬¡ä½¿ç”¨\r\n      .sort((a, b) => b.conversionRate - a.conversionRate)\r\n      .slice(0, 5);\r\n  });\r\n  \r\n  private readonly STORAGE_KEY = 'marketingAnalytics';\r\n  \r\n  constructor() {\r\n    this.loadFromStorage();\r\n    this.initializeListeners();\r\n  }\r\n  \r\n  /**\r\n   * åˆå§‹åŒ–ç›£è½å™¨\r\n   */\r\n  private initializeListeners() {\r\n    // ç›£è½å”ä½œæœƒè©±çµæŸäº‹ä»¶\r\n    this.ipc.on('collaboration:session-ended', (data: any) => {\r\n      this.recordSession(data);\r\n    });\r\n    \r\n    // ç›£è½ç”¨æˆ¶æ¶ˆæ¯ï¼ˆç”¨æ–¼æ›´æ–°ç•«åƒï¼‰\r\n    this.ipc.on('collaboration:user-message', (data: any) => {\r\n      this.updateUserProfile(data.userId, data.message);\r\n    });\r\n  }\r\n  \r\n  // ============ æœƒè©±è¨˜éŒ„ ============\r\n  \r\n  /**\r\n   * è¨˜éŒ„ç‡ŸéŠ·æœƒè©±\r\n   */\r\n  recordSession(data: {\r\n    sessionId: string;\r\n    targetUserId: string;\r\n    targetUserName: string;\r\n    roles: { roleId: string; roleName: string; roleType: string; accountPhone: string }[];\r\n    messages: { role: string; content: string; timestamp: Date; isUser: boolean }[];\r\n    outcome: MarketingSession['outcome'];\r\n    conversionValue?: number;\r\n    interestScore: number;\r\n    stagesReached: string[];\r\n    finalStage: string;\r\n  }) {\r\n    // å‰µå»ºè§’è‰²çµ„åˆ\r\n    const roleCombo = this.createRoleCombo(data.roles);\r\n    \r\n    // è¨ˆç®—çµ±è¨ˆæ•¸æ“š\r\n    const userMessages = data.messages.filter(m => m.isUser);\r\n    const roleMessages = data.messages.filter(m => !m.isUser);\r\n    \r\n    const session: MarketingSession = {\r\n      id: data.sessionId,\r\n      startTime: data.messages[0]?.timestamp || new Date(),\r\n      endTime: data.messages[data.messages.length - 1]?.timestamp,\r\n      targetUserId: data.targetUserId,\r\n      targetUserName: data.targetUserName,\r\n      roleCombo,\r\n      totalMessages: data.messages.length,\r\n      userMessages: userMessages.length,\r\n      roleMessages: roleMessages.length,\r\n      avgResponseTime: this.calcAvgResponseTime(data.messages),\r\n      stagesReached: data.stagesReached,\r\n      finalStage: data.finalStage,\r\n      outcome: data.outcome,\r\n      conversionValue: data.conversionValue,\r\n      interestScore: data.interestScore,\r\n      engagementScore: this.calcEngagementScore(data.messages),\r\n      tags: this.extractSessionTags(data)\r\n    };\r\n    \r\n    // ä¿å­˜æœƒè©±\r\n    this._sessions.update(sessions => [...sessions, session]);\r\n    \r\n    // æ›´æ–°è§’è‰²çµ„åˆçµ±è¨ˆ\r\n    this.updateRoleComboStats(roleCombo, session);\r\n    \r\n    // ä¿å­˜åˆ°å­˜å„²\r\n    this.saveToStorage();\r\n    \r\n    console.log(`[Analytics] è¨˜éŒ„æœƒè©±: ${session.id}, çµæœ: ${session.outcome}`);\r\n    \r\n    return session;\r\n  }\r\n  \r\n  /**\r\n   * å‰µå»ºè§’è‰²çµ„åˆæ¨™è­˜\r\n   */\r\n  private createRoleCombo(roles: { roleId: string; roleName: string; roleType: string; accountPhone: string }[]): RoleCombo {\r\n    const sortedRoles = [...roles].sort((a, b) => a.roleId.localeCompare(b.roleId));\r\n    const hash = sortedRoles.map(r => r.roleType).join('_');\r\n    const name = sortedRoles.map(r => r.roleName).join(' + ');\r\n    \r\n    return {\r\n      id: `combo_${hash}`,\r\n      name,\r\n      roles: sortedRoles,\r\n      hash\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°è§’è‰²çµ„åˆçµ±è¨ˆ\r\n   */\r\n  private updateRoleComboStats(combo: RoleCombo, session: MarketingSession) {\r\n    const statsMap = this._roleComboStats();\r\n    const existing = statsMap.get(combo.id);\r\n    \r\n    const isConversion = session.outcome === 'converted';\r\n    \r\n    if (existing) {\r\n      // æ›´æ–°ç¾æœ‰çµ±è¨ˆ\r\n      const newTotal = existing.totalSessions + 1;\r\n      const newConversions = existing.conversions + (isConversion ? 1 : 0);\r\n      \r\n      const updated: RoleComboStats = {\r\n        ...existing,\r\n        totalSessions: newTotal,\r\n        conversions: newConversions,\r\n        conversionRate: (newConversions / newTotal) * 100,\r\n        avgInterestScore: (existing.avgInterestScore * existing.totalSessions + session.interestScore) / newTotal,\r\n        avgEngagementScore: (existing.avgEngagementScore * existing.totalSessions + session.engagementScore) / newTotal,\r\n        avgMessageCount: (existing.avgMessageCount * existing.totalSessions + session.totalMessages) / newTotal,\r\n        lastUsed: new Date()\r\n      };\r\n      \r\n      // è¨ˆç®—è¶¨å‹¢ï¼ˆç°¡åŒ–ç‰ˆï¼šèˆ‡ä¸Šæ¬¡æ¯”è¼ƒï¼‰\r\n      updated.trend = session.interestScore > existing.avgInterestScore ? 'up' : \r\n                      session.interestScore < existing.avgInterestScore ? 'down' : 'stable';\r\n      \r\n      this._roleComboStats.update(m => {\r\n        const newMap = new Map(m);\r\n        newMap.set(combo.id, updated);\r\n        return newMap;\r\n      });\r\n    } else {\r\n      // å‰µå»ºæ–°çµ±è¨ˆ\r\n      const newStats: RoleComboStats = {\r\n        comboId: combo.id,\r\n        comboName: combo.name,\r\n        roles: combo.roles.map(r => r.roleName),\r\n        totalSessions: 1,\r\n        conversions: isConversion ? 1 : 0,\r\n        conversionRate: isConversion ? 100 : 0,\r\n        avgInterestScore: session.interestScore,\r\n        avgEngagementScore: session.engagementScore,\r\n        avgSessionDuration: 0,\r\n        avgMessageCount: session.totalMessages,\r\n        stageReachRates: {},\r\n        trend: 'stable',\r\n        lastUsed: new Date()\r\n      };\r\n      \r\n      this._roleComboStats.update(m => {\r\n        const newMap = new Map(m);\r\n        newMap.set(combo.id, newStats);\r\n        return newMap;\r\n      });\r\n    }\r\n  }\r\n  \r\n  // ============ ç”¨æˆ¶ç•«åƒ ============\r\n  \r\n  /**\r\n   * æ›´æ–°ç”¨æˆ¶ç•«åƒ\r\n   */\r\n  updateUserProfile(userId: string, message: string) {\r\n    const existing = this._userProfiles().get(userId);\r\n    \r\n    // åˆ†ææ¶ˆæ¯ç‰¹å¾µ\r\n    const msgLength = message.length;\r\n    const lengthCategory = msgLength < 20 ? 'short' : msgLength > 100 ? 'long' : 'medium';\r\n    \r\n    // æå–èˆˆè¶£å’Œç—›é»\r\n    const interests = this.extractInterests(message);\r\n    const painPoints = this.extractPainPoints(message);\r\n    const objections = this.extractObjections(message);\r\n    \r\n    if (existing) {\r\n      // æ›´æ–°ç¾æœ‰ç•«åƒ\r\n      const updated: UserProfile = {\r\n        ...existing,\r\n        totalMessages: existing.totalMessages + 1,\r\n        interests: [...new Set([...existing.interests, ...interests])].slice(0, 10),\r\n        painPoints: [...new Set([...existing.painPoints, ...painPoints])].slice(0, 5),\r\n        objections: [...new Set([...existing.objections, ...objections])].slice(0, 5),\r\n        lastContactTime: new Date(),\r\n        updatedAt: new Date()\r\n      };\r\n      \r\n      // æ›´æ–°æ¶ˆæ¯é•·åº¦åå¥½\r\n      updated.messageLength = lengthCategory as 'short' | 'medium' | 'long';\r\n      \r\n      this._userProfiles.update(m => {\r\n        const newMap = new Map(m);\r\n        newMap.set(userId, updated);\r\n        return newMap;\r\n      });\r\n    } else {\r\n      // å‰µå»ºæ–°ç•«åƒ\r\n      const newProfile: UserProfile = {\r\n        userId,\r\n        responseSpeed: 'normal',\r\n        messageLength: lengthCategory as 'short' | 'medium' | 'long',\r\n        activeHours: [new Date().getHours()],\r\n        interests,\r\n        painPoints,\r\n        objections,\r\n        intentLevel: 'unknown',\r\n        pricesSensitivity: 'medium',\r\n        totalSessions: 1,\r\n        totalMessages: 1,\r\n        lastContactTime: new Date(),\r\n        tags: [],\r\n        updatedAt: new Date()\r\n      };\r\n      \r\n      this._userProfiles.update(m => {\r\n        const newMap = new Map(m);\r\n        newMap.set(userId, newProfile);\r\n        return newMap;\r\n      });\r\n    }\r\n    \r\n    this.saveToStorage();\r\n  }\r\n  \r\n  /**\r\n   * æå–èˆˆè¶£é»\r\n   */\r\n  private extractInterests(message: string): string[] {\r\n    const interests: string[] = [];\r\n    const lowerMsg = message.toLowerCase();\r\n    \r\n    const keywords = {\r\n      'æ”¯ä»˜': 'æ”¯ä»˜è§£æ±ºæ–¹æ¡ˆ',\r\n      'æ”¶æ¬¾': 'æ”¶æ¬¾æœå‹™',\r\n      'è·¨å¢ƒ': 'è·¨å¢ƒæ¥­å‹™',\r\n      'è²»ç‡': 'åƒ¹æ ¼æ•æ„Ÿ',\r\n      'å®‰å…¨': 'å®‰å…¨éœ€æ±‚',\r\n      'é€Ÿåº¦': 'æ•ˆç‡éœ€æ±‚',\r\n      'ç©©å®š': 'ç©©å®šæ€§éœ€æ±‚'\r\n    };\r\n    \r\n    Object.entries(keywords).forEach(([key, interest]) => {\r\n      if (lowerMsg.includes(key)) {\r\n        interests.push(interest);\r\n      }\r\n    });\r\n    \r\n    return interests;\r\n  }\r\n  \r\n  /**\r\n   * æå–ç—›é»\r\n   */\r\n  private extractPainPoints(message: string): string[] {\r\n    const painPoints: string[] = [];\r\n    const lowerMsg = message.toLowerCase();\r\n    \r\n    if (lowerMsg.includes('è²´') || lowerMsg.includes('è²»ç‡é«˜')) {\r\n      painPoints.push('è²»ç‡å•é¡Œ');\r\n    }\r\n    if (lowerMsg.includes('æ…¢') || lowerMsg.includes('ç­‰å¾…')) {\r\n      painPoints.push('æ•ˆç‡å•é¡Œ');\r\n    }\r\n    if (lowerMsg.includes('æ“”å¿ƒ') || lowerMsg.includes('é¢¨éšª')) {\r\n      painPoints.push('å®‰å…¨é¡§æ…®');\r\n    }\r\n    if (lowerMsg.includes('è¤‡é›œ') || lowerMsg.includes('éº»ç…©')) {\r\n      painPoints.push('æ“ä½œè¤‡é›œ');\r\n    }\r\n    \r\n    return painPoints;\r\n  }\r\n  \r\n  /**\r\n   * æå–ç•°è­°\r\n   */\r\n  private extractObjections(message: string): string[] {\r\n    const objections: string[] = [];\r\n    const lowerMsg = message.toLowerCase();\r\n    \r\n    if (lowerMsg.includes('ä¸éœ€è¦') || lowerMsg.includes('ä¸ç”¨')) {\r\n      objections.push('ç„¡éœ€æ±‚');\r\n    }\r\n    if (lowerMsg.includes('å†è€ƒæ…®') || lowerMsg.includes('å†èªª')) {\r\n      objections.push('éœ€è¦è€ƒæ…®');\r\n    }\r\n    if (lowerMsg.includes('å¤ªè²´') || lowerMsg.includes('ä¾¿å®œ')) {\r\n      objections.push('åƒ¹æ ¼ç•°è­°');\r\n    }\r\n    if (lowerMsg.includes('ä¸ä¿¡') || lowerMsg.includes('é¨™')) {\r\n      objections.push('ä¿¡ä»»å•é¡Œ');\r\n    }\r\n    \r\n    return objections;\r\n  }\r\n  \r\n  /**\r\n   * ç²å–ç”¨æˆ¶ç•«åƒ\r\n   */\r\n  getUserProfile(userId: string): UserProfile | undefined {\r\n    return this._userProfiles().get(userId);\r\n  }\r\n  \r\n  // ============ å ±è¡¨ç”Ÿæˆ ============\r\n  \r\n  /**\r\n   * ç”Ÿæˆæ—¥å ±\r\n   */\r\n  generateDailyReport(date?: string): DailyReport {\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n    const sessions = this._sessions().filter(s => \r\n      s.startTime.toISOString().split('T')[0] === targetDate\r\n    );\r\n    \r\n    const conversions = sessions.filter(s => s.outcome === 'converted');\r\n    const uniqueUsers = new Set(sessions.map(s => s.targetUserId));\r\n    \r\n    // å¸³è™Ÿä½¿ç”¨çµ±è¨ˆ\r\n    const accountUsage = new Map<string, { sessions: number; messages: number }>();\r\n    sessions.forEach(s => {\r\n      s.roleCombo.roles.forEach(r => {\r\n        const existing = accountUsage.get(r.accountPhone) || { sessions: 0, messages: 0 };\r\n        existing.sessions++;\r\n        existing.messages += s.roleMessages / s.roleCombo.roles.length;\r\n        accountUsage.set(r.accountPhone, existing);\r\n      });\r\n    });\r\n    \r\n    // è§’è‰²çµ„åˆçµ±è¨ˆ\r\n    const comboStats = new Map<string, { name: string; conversions: number; total: number }>();\r\n    sessions.forEach(s => {\r\n      const existing = comboStats.get(s.roleCombo.id) || { name: s.roleCombo.name, conversions: 0, total: 0 };\r\n      existing.total++;\r\n      if (s.outcome === 'converted') existing.conversions++;\r\n      comboStats.set(s.roleCombo.id, existing);\r\n    });\r\n    \r\n    // æ¼æ–—çµ±è¨ˆ\r\n    const stages = ['opening', 'building_trust', 'discovering_needs', 'presenting_value', 'handling_objections', 'closing', 'follow_up'];\r\n    const stageCounts = stages.map(stage => ({\r\n      stage,\r\n      count: sessions.filter(s => s.stagesReached.includes(stage)).length\r\n    }));\r\n    \r\n    return {\r\n      date: targetDate,\r\n      totalSessions: sessions.length,\r\n      newUsers: uniqueUsers.size,\r\n      activeUsers: uniqueUsers.size,\r\n      conversions: conversions.length,\r\n      conversionRate: sessions.length > 0 ? (conversions.length / sessions.length * 100) : 0,\r\n      totalRevenue: sessions.reduce((sum, s) => sum + (s.conversionValue || 0), 0),\r\n      totalMessages: sessions.reduce((sum, s) => sum + s.totalMessages, 0),\r\n      avgResponseTime: this.calcAverage(sessions.map(s => s.avgResponseTime)),\r\n      accountUsage: Array.from(accountUsage.entries()).map(([phone, stats]) => ({\r\n        phone,\r\n        ...stats\r\n      })),\r\n      topRoleCombos: Array.from(comboStats.values())\r\n        .sort((a, b) => b.conversions - a.conversions)\r\n        .slice(0, 5)\r\n        .map(c => ({\r\n          comboName: c.name,\r\n          conversions: c.conversions,\r\n          rate: c.total > 0 ? (c.conversions / c.total * 100) : 0\r\n        })),\r\n      funnel: stageCounts.map((sc, idx) => ({\r\n        stage: sc.stage,\r\n        count: sc.count,\r\n        rate: sessions.length > 0 ? (sc.count / sessions.length * 100) : 0\r\n      }))\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * ç”Ÿæˆé€±æœŸå°æ¯”\r\n   */\r\n  generatePeriodComparison(days: number = 7): PeriodComparison {\r\n    const now = new Date();\r\n    const currentStart = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);\r\n    const previousStart = new Date(currentStart.getTime() - days * 24 * 60 * 60 * 1000);\r\n    \r\n    const currentSessions = this._sessions().filter(s => \r\n      s.startTime >= currentStart && s.startTime < now\r\n    );\r\n    const previousSessions = this._sessions().filter(s => \r\n      s.startTime >= previousStart && s.startTime < currentStart\r\n    );\r\n    \r\n    const current = {\r\n      sessions: currentSessions.length,\r\n      conversions: currentSessions.filter(s => s.outcome === 'converted').length,\r\n      revenue: currentSessions.reduce((sum, s) => sum + (s.conversionValue || 0), 0)\r\n    };\r\n    \r\n    const previous = {\r\n      sessions: previousSessions.length,\r\n      conversions: previousSessions.filter(s => s.outcome === 'converted').length,\r\n      revenue: previousSessions.reduce((sum, s) => sum + (s.conversionValue || 0), 0)\r\n    };\r\n    \r\n    return {\r\n      current,\r\n      previous,\r\n      changes: {\r\n        sessions: previous.sessions > 0 ? ((current.sessions - previous.sessions) / previous.sessions * 100) : 0,\r\n        conversions: previous.conversions > 0 ? ((current.conversions - previous.conversions) / previous.conversions * 100) : 0,\r\n        revenue: previous.revenue > 0 ? ((current.revenue - previous.revenue) / previous.revenue * 100) : 0\r\n      }\r\n    };\r\n  }\r\n  \r\n  // ============ æ¨è–¦åŠŸèƒ½ ============\r\n  \r\n  /**\r\n   * æ¨è–¦è§’è‰²çµ„åˆ\r\n   */\r\n  recommendRoleCombo(targetProfile?: UserProfile): RoleComboStats | null {\r\n    const stats = Array.from(this._roleComboStats().values());\r\n    \r\n    if (stats.length === 0) return null;\r\n    \r\n    // åŸºç¤æ’åºï¼šè½‰åŒ–ç‡\r\n    let sorted = stats\r\n      .filter(s => s.totalSessions >= 2)\r\n      .sort((a, b) => b.conversionRate - a.conversionRate);\r\n    \r\n    // å¦‚æœæœ‰ç”¨æˆ¶ç•«åƒï¼Œå¯ä»¥é€²ä¸€æ­¥å„ªåŒ–æ¨è–¦\r\n    if (targetProfile) {\r\n      // æ ¹æ“šç”¨æˆ¶ç‰¹å¾µèª¿æ•´æ¨è–¦\r\n      // TODO: å¯¦ç¾æ›´è¤‡é›œçš„æ¨è–¦é‚è¼¯\r\n    }\r\n    \r\n    return sorted[0] || null;\r\n  }\r\n  \r\n  // ============ è¼”åŠ©æ–¹æ³• ============\r\n  \r\n  private calcAverage(values: number[]): number {\r\n    if (values.length === 0) return 0;\r\n    return values.reduce((sum, v) => sum + v, 0) / values.length;\r\n  }\r\n  \r\n  private calcAvgResponseTime(messages: { timestamp: Date; isUser: boolean }[]): number {\r\n    let totalTime = 0;\r\n    let count = 0;\r\n    \r\n    for (let i = 1; i < messages.length; i++) {\r\n      if (messages[i].isUser && !messages[i - 1].isUser) {\r\n        // ç”¨æˆ¶å›è¦†æ™‚é–“\r\n        totalTime += new Date(messages[i].timestamp).getTime() - new Date(messages[i - 1].timestamp).getTime();\r\n        count++;\r\n      }\r\n    }\r\n    \r\n    return count > 0 ? totalTime / count : 0;\r\n  }\r\n  \r\n  private calcEngagementScore(messages: { isUser: boolean; content: string }[]): number {\r\n    const userMsgs = messages.filter(m => m.isUser);\r\n    if (userMsgs.length === 0) return 0;\r\n    \r\n    let score = 0;\r\n    \r\n    // åŸºæ–¼ç”¨æˆ¶å›è¦†æ•¸é‡\r\n    score += Math.min(userMsgs.length * 10, 40);\r\n    \r\n    // åŸºæ–¼ç”¨æˆ¶æ¶ˆæ¯é•·åº¦\r\n    const avgLength = userMsgs.reduce((sum, m) => sum + m.content.length, 0) / userMsgs.length;\r\n    score += Math.min(avgLength / 5, 30);\r\n    \r\n    // åŸºæ–¼å•é¡Œæ•¸é‡ï¼ˆå•è™Ÿï¼‰\r\n    const questions = userMsgs.filter(m => m.content.includes('?') || m.content.includes('ï¼Ÿ')).length;\r\n    score += Math.min(questions * 10, 30);\r\n    \r\n    return Math.min(score, 100);\r\n  }\r\n  \r\n  private extractSessionTags(data: any): string[] {\r\n    const tags: string[] = [];\r\n    \r\n    if (data.outcome === 'converted') tags.push('æˆäº¤');\r\n    if (data.interestScore >= 80) tags.push('é«˜æ„å‘');\r\n    if (data.stagesReached.includes('closing')) tags.push('åˆ°é”æˆäº¤éšæ®µ');\r\n    \r\n    return tags;\r\n  }\r\n  \r\n  // ============ æŒä¹…åŒ– ============\r\n  \r\n  private saveToStorage() {\r\n    const data = {\r\n      sessions: this._sessions(),\r\n      userProfiles: Array.from(this._userProfiles().entries()),\r\n      roleComboStats: Array.from(this._roleComboStats().entries()),\r\n      savedAt: Date.now()\r\n    };\r\n    \r\n    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));\r\n  }\r\n  \r\n  private loadFromStorage() {\r\n    try {\r\n      const stored = localStorage.getItem(this.STORAGE_KEY);\r\n      if (!stored) return;\r\n      \r\n      const data = JSON.parse(stored);\r\n      \r\n      // æ¢å¾©æœƒè©±ï¼ˆè½‰æ›æ—¥æœŸï¼‰\r\n      if (data.sessions) {\r\n        const sessions = data.sessions.map((s: any) => ({\r\n          ...s,\r\n          startTime: new Date(s.startTime),\r\n          endTime: s.endTime ? new Date(s.endTime) : undefined\r\n        }));\r\n        this._sessions.set(sessions);\r\n      }\r\n      \r\n      // æ¢å¾©ç”¨æˆ¶ç•«åƒ\r\n      if (data.userProfiles) {\r\n        const map = new Map<string, UserProfile>(data.userProfiles.map((e: any) => [\r\n          e[0],\r\n          { ...e[1], updatedAt: new Date(e[1].updatedAt), lastContactTime: e[1].lastContactTime ? new Date(e[1].lastContactTime) : undefined }\r\n        ]));\r\n        this._userProfiles.set(map);\r\n      }\r\n      \r\n      // æ¢å¾©è§’è‰²çµ„åˆçµ±è¨ˆ\r\n      if (data.roleComboStats) {\r\n        const map = new Map<string, RoleComboStats>(data.roleComboStats.map((e: any) => [\r\n          e[0],\r\n          { ...e[1], lastUsed: new Date(e[1].lastUsed) }\r\n        ]));\r\n        this._roleComboStats.set(map);\r\n      }\r\n      \r\n      console.log('[Analytics] å·²å¾å­˜å„²æ¢å¾©æ•¸æ“š');\r\n    } catch (e) {\r\n      console.error('[Analytics] æ¢å¾©æ•¸æ“šå¤±æ•—:', e);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æ¸…é™¤æ‰€æœ‰æ•¸æ“š\r\n   */\r\n  clearAllData() {\r\n    this._sessions.set([]);\r\n    this._userProfiles.set(new Map());\r\n    this._roleComboStats.set(new Map());\r\n    localStorage.removeItem(this.STORAGE_KEY);\r\n    console.log('[Analytics] å·²æ¸…é™¤æ‰€æœ‰æ•¸æ“š');\r\n  }\r\n  \r\n  /**\r\n   * å°å‡ºæ•¸æ“š\r\n   */\r\n  exportData(): string {\r\n    return JSON.stringify({\r\n      sessions: this._sessions(),\r\n      userProfiles: Array.from(this._userProfiles().entries()),\r\n      roleComboStats: Array.from(this._roleComboStats().entries()),\r\n      exportedAt: new Date().toISOString()\r\n    }, null, 2);\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["signal"]
}
