{
  "version": 3,
  "sources": ["src/core/api.service.ts", "src/core/auth-events.service.ts", "src/core/auth.service.ts"],
  "sourcesContent": ["/**\r\n * TG-Matrix çµ±ä¸€ API æœå‹™\r\n * \r\n * å„ªåŒ–è¨­è¨ˆï¼š\r\n * 1. è‡ªå‹•æª¢æ¸¬ç’°å¢ƒï¼ˆElectron vs Webï¼‰\r\n * 2. çµ±ä¸€çš„è«‹æ±‚/éŸ¿æ‡‰æ¥å£\r\n * 3. è‡ªå‹•é‡è©¦å’ŒéŒ¯èª¤è™•ç†\r\n * 4. è«‹æ±‚ç·©å­˜å’Œå»é‡\r\n * 5. WebSocket å¯¦æ™‚é€šè¨Šæ”¯æŒ\r\n */\r\n\r\nimport { Injectable, inject, signal, computed } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\nimport { Observable, Subject, BehaviorSubject, from, of, throwError } from 'rxjs';\r\nimport { map, catchError, retry, shareReplay, tap, timeout } from 'rxjs/operators';\r\n\r\n// ç’°å¢ƒé…ç½®\r\nexport interface ApiConfig {\r\n  mode: 'ipc' | 'http';\r\n  baseUrl?: string;\r\n  wsUrl?: string;\r\n  timeout?: number;\r\n  retries?: number;\r\n}\r\n\r\n// API éŸ¿æ‡‰æ ¼å¼\r\nexport interface ApiResponse<T = any> {\r\n  success: boolean;\r\n  data?: T;\r\n  error?: string;\r\n  message?: string;\r\n  request_id?: string;\r\n}\r\n\r\n// WebSocket æ¶ˆæ¯æ ¼å¼\r\nexport interface WsMessage {\r\n  type: 'event' | 'response' | 'error';\r\n  event?: string;\r\n  data?: any;\r\n  request_id?: string;\r\n  timestamp?: string;\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ApiService {\r\n  private http = inject(HttpClient);\r\n  \r\n  // ç’°å¢ƒæª¢æ¸¬\r\n  private _isElectron = signal<boolean>(this.detectElectron());\r\n  private _isConnected = signal<boolean>(false);\r\n  private _config = signal<ApiConfig>(this.getDefaultConfig());\r\n  \r\n  // WebSocket\r\n  private ws: WebSocket | null = null;\r\n  private wsReconnectTimer: any = null;\r\n  private wsMessageSubject = new Subject<WsMessage>();\r\n  private pendingRequests = new Map<string, { resolve: Function; reject: Function }>();\r\n  \r\n  // è«‹æ±‚ç·©å­˜\r\n  private cache = new Map<string, { data: any; timestamp: number }>();\r\n  private cacheTimeout = 30000; // 30 ç§’ç·©å­˜\r\n  \r\n  // è«‹æ±‚å»é‡\r\n  private inflightRequests = new Map<string, Promise<any>>();\r\n  \r\n  // å…¬é–‹ç‹€æ…‹\r\n  readonly isElectron = computed(() => this._isElectron());\r\n  readonly isConnected = computed(() => this._isConnected());\r\n  readonly mode = computed(() => this._config().mode);\r\n  \r\n  // äº‹ä»¶æµ\r\n  readonly events$ = this.wsMessageSubject.asObservable();\r\n  \r\n  constructor() {\r\n    this.init();\r\n  }\r\n  \r\n  // ==================== åˆå§‹åŒ– ====================\r\n  \r\n  private init(): void {\r\n    console.log(`[ApiService] Initializing in ${this._config().mode} mode`);\r\n    \r\n    if (this._config().mode === 'http') {\r\n      this.connectWebSocket();\r\n    }\r\n    \r\n    // æ¸¬è©¦é€£æ¥\r\n    this.healthCheck().then(ok => {\r\n      this._isConnected.set(ok);\r\n      console.log(`[ApiService] Connection status: ${ok ? 'connected' : 'disconnected'}`);\r\n    });\r\n  }\r\n  \r\n  private detectElectron(): boolean {\r\n    return !!(window as any).electron || !!(window as any).require;\r\n  }\r\n  \r\n  private getDefaultConfig(): ApiConfig {\r\n    // å„ªå…ˆå¾ç’°å¢ƒè®Šé‡ç²å–\r\n    const envMode = (window as any).__API_MODE__ || 'auto';\r\n    const envBaseUrl = (window as any).__API_BASE_URL__;\r\n    \r\n    if (envMode === 'http' || envBaseUrl) {\r\n      return {\r\n        mode: 'http',\r\n        baseUrl: envBaseUrl || this.detectApiUrl(),\r\n        wsUrl: this.detectWsUrl(),\r\n        timeout: 30000,\r\n        retries: 2\r\n      };\r\n    }\r\n    \r\n    if (this.detectElectron()) {\r\n      return {\r\n        mode: 'ipc',\r\n        timeout: 30000,\r\n        retries: 2\r\n      };\r\n    }\r\n    \r\n    // Web ç’°å¢ƒé»˜èªä½¿ç”¨ HTTP\r\n    return {\r\n      mode: 'http',\r\n      baseUrl: this.detectApiUrl(),\r\n      wsUrl: this.detectWsUrl(),\r\n      timeout: 30000,\r\n      retries: 2\r\n    };\r\n  }\r\n  \r\n  private detectApiUrl(): string {\r\n    // é–‹ç™¼ç’°å¢ƒ\r\n    if (window.location.hostname === 'localhost' && window.location.port === '4200') {\r\n      return 'http://localhost:8000';\r\n    }\r\n    // ç”Ÿç”¢ç’°å¢ƒ - åŒæº\r\n    return `${window.location.protocol}//${window.location.host}`;\r\n  }\r\n  \r\n  private detectWsUrl(): string {\r\n    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\r\n    if (window.location.hostname === 'localhost' && window.location.port === '4200') {\r\n      return 'ws://localhost:8000/ws';\r\n    }\r\n    return `${protocol}//${window.location.host}/ws`;\r\n  }\r\n  \r\n  // ==================== æ ¸å¿ƒè«‹æ±‚æ–¹æ³• ====================\r\n  \r\n  /**\r\n   * åŸ·è¡Œå‘½ä»¤ - æ ¸å¿ƒæ–¹æ³•\r\n   * è‡ªå‹•é¸æ“‡ IPC æˆ– HTTP\r\n   */\r\n  async command<T = any>(cmd: string, payload: any = {}): Promise<ApiResponse<T>> {\r\n    const requestKey = `${cmd}:${JSON.stringify(payload)}`;\r\n    \r\n    // è«‹æ±‚å»é‡\r\n    if (this.inflightRequests.has(requestKey)) {\r\n      return this.inflightRequests.get(requestKey)!;\r\n    }\r\n    \r\n    const promise = this._executeCommand<T>(cmd, payload);\r\n    this.inflightRequests.set(requestKey, promise);\r\n    \r\n    try {\r\n      const result = await promise;\r\n      return result;\r\n    } finally {\r\n      this.inflightRequests.delete(requestKey);\r\n    }\r\n  }\r\n  \r\n  private async _executeCommand<T>(cmd: string, payload: any): Promise<ApiResponse<T>> {\r\n    if (this._config().mode === 'ipc') {\r\n      return this.ipcCommand(cmd, payload);\r\n    } else {\r\n      return this.httpCommand(cmd, payload);\r\n    }\r\n  }\r\n  \r\n  // ==================== IPC æ¨¡å¼ ====================\r\n  \r\n  private async ipcCommand<T>(cmd: string, payload: any): Promise<ApiResponse<T>> {\r\n    const electron = (window as any).electron;\r\n    if (!electron?.ipcRenderer) {\r\n      throw new Error('Electron IPC not available');\r\n    }\r\n    \r\n    try {\r\n      const result = await electron.ipcRenderer.invoke(cmd, payload);\r\n      return this.normalizeResponse(result);\r\n    } catch (error: any) {\r\n      return { success: false, error: error.message || 'IPC error' };\r\n    }\r\n  }\r\n  \r\n  // ==================== HTTP æ¨¡å¼ ====================\r\n  \r\n  private async httpCommand<T>(cmd: string, payload: any): Promise<ApiResponse<T>> {\r\n    const config = this._config();\r\n    const url = `${config.baseUrl}/api/command`;\r\n    \r\n    // ğŸ”§ ç²å–èªè­‰ Token\r\n    const token = localStorage.getItem('tgm_access_token');\r\n    const headers: HeadersInit = {\r\n      'Content-Type': 'application/json',\r\n    };\r\n    if (token) {\r\n      headers['Authorization'] = `Bearer ${token}`;\r\n    }\r\n    \r\n    try {\r\n      const response = await fetch(url, {\r\n        method: 'POST',\r\n        headers,\r\n        body: JSON.stringify({ command: cmd, payload })\r\n      });\r\n      \r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n      }\r\n      \r\n      const result = await response.json();\r\n      return this.normalizeResponse(result);\r\n    } catch (error: any) {\r\n      // è‡ªå‹•é‡è©¦\r\n      if (config.retries && config.retries > 0) {\r\n        console.warn(`[ApiService] Retrying command: ${cmd}`);\r\n        const newConfig = { ...config, retries: config.retries - 1 };\r\n        this._config.set(newConfig);\r\n        return this.httpCommand(cmd, payload);\r\n      }\r\n      \r\n      return { success: false, error: error.message || 'HTTP error' };\r\n    }\r\n  }\r\n  \r\n  private normalizeResponse<T>(result: any): ApiResponse<T> {\r\n    if (typeof result === 'object' && result !== null) {\r\n      if ('success' in result) {\r\n        return result;\r\n      }\r\n      return { success: true, data: result };\r\n    }\r\n    return { success: true, data: result as T };\r\n  }\r\n  \r\n  // ==================== WebSocket ====================\r\n  \r\n  private connectWebSocket(): void {\r\n    const wsUrl = this._config().wsUrl;\r\n    if (!wsUrl) return;\r\n    \r\n    try {\r\n      this.ws = new WebSocket(wsUrl);\r\n      \r\n      this.ws.onopen = () => {\r\n        console.log('[ApiService] WebSocket connected');\r\n        this._isConnected.set(true);\r\n        if (this.wsReconnectTimer) {\r\n          clearTimeout(this.wsReconnectTimer);\r\n          this.wsReconnectTimer = null;\r\n        }\r\n      };\r\n      \r\n      this.ws.onmessage = (event) => {\r\n        try {\r\n          const message = JSON.parse(event.data) as WsMessage;\r\n          \r\n          // è™•ç†è«‹æ±‚éŸ¿æ‡‰\r\n          if (message.request_id && this.pendingRequests.has(message.request_id)) {\r\n            const { resolve } = this.pendingRequests.get(message.request_id)!;\r\n            this.pendingRequests.delete(message.request_id);\r\n            resolve(message);\r\n          }\r\n          \r\n          // å»£æ’­äº‹ä»¶\r\n          this.wsMessageSubject.next(message);\r\n        } catch (e) {\r\n          console.error('[ApiService] WebSocket message parse error', e);\r\n        }\r\n      };\r\n      \r\n      this.ws.onclose = () => {\r\n        console.log('[ApiService] WebSocket disconnected');\r\n        this._isConnected.set(false);\r\n        this.scheduleReconnect();\r\n      };\r\n      \r\n      this.ws.onerror = (error) => {\r\n        console.error('[ApiService] WebSocket error', error);\r\n      };\r\n    } catch (e) {\r\n      console.error('[ApiService] WebSocket connection failed', e);\r\n      this.scheduleReconnect();\r\n    }\r\n  }\r\n  \r\n  private scheduleReconnect(): void {\r\n    if (this.wsReconnectTimer) return;\r\n    \r\n    this.wsReconnectTimer = setTimeout(() => {\r\n      console.log('[ApiService] Attempting WebSocket reconnection...');\r\n      this.wsReconnectTimer = null;\r\n      this.connectWebSocket();\r\n    }, 5000);\r\n  }\r\n  \r\n  /**\r\n   * é€šé WebSocket ç™¼é€å‘½ä»¤\r\n   */\r\n  async wsCommand<T>(cmd: string, payload: any = {}): Promise<ApiResponse<T>> {\r\n    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {\r\n      // é™ç´šåˆ° HTTP\r\n      return this.httpCommand(cmd, payload);\r\n    }\r\n    \r\n    const requestId = crypto.randomUUID();\r\n    \r\n    return new Promise((resolve, reject) => {\r\n      this.pendingRequests.set(requestId, { resolve, reject });\r\n      \r\n      // è¶…æ™‚è™•ç†\r\n      setTimeout(() => {\r\n        if (this.pendingRequests.has(requestId)) {\r\n          this.pendingRequests.delete(requestId);\r\n          reject(new Error('WebSocket request timeout'));\r\n        }\r\n      }, this._config().timeout || 30000);\r\n      \r\n      this.ws!.send(JSON.stringify({\r\n        command: cmd,\r\n        payload,\r\n        request_id: requestId\r\n      }));\r\n    });\r\n  }\r\n  \r\n  // ==================== ä¾¿æ·æ–¹æ³• ====================\r\n  \r\n  /**\r\n   * å¥åº·æª¢æŸ¥\r\n   */\r\n  async healthCheck(): Promise<boolean> {\r\n    try {\r\n      const result = await this.command('get-initial-state');\r\n      return result.success;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * å¸¶ç·©å­˜çš„è«‹æ±‚\r\n   */\r\n  async cachedCommand<T>(cmd: string, payload: any = {}, ttl: number = this.cacheTimeout): Promise<ApiResponse<T>> {\r\n    const cacheKey = `${cmd}:${JSON.stringify(payload)}`;\r\n    const cached = this.cache.get(cacheKey);\r\n    \r\n    if (cached && Date.now() - cached.timestamp < ttl) {\r\n      return { success: true, data: cached.data };\r\n    }\r\n    \r\n    const result = await this.command<T>(cmd, payload);\r\n    \r\n    if (result.success && result.data) {\r\n      this.cache.set(cacheKey, { data: result.data, timestamp: Date.now() });\r\n    }\r\n    \r\n    return result;\r\n  }\r\n  \r\n  /**\r\n   * æ¸…é™¤ç·©å­˜\r\n   */\r\n  clearCache(pattern?: string): void {\r\n    if (pattern) {\r\n      for (const key of this.cache.keys()) {\r\n        if (key.includes(pattern)) {\r\n          this.cache.delete(key);\r\n        }\r\n      }\r\n    } else {\r\n      this.cache.clear();\r\n    }\r\n  }\r\n  \r\n  // ==================== å¸¸ç”¨ API å¿«æ·æ–¹æ³• ====================\r\n  \r\n  // å¸³è™Ÿ\r\n  getAccounts() { return this.cachedCommand('get-accounts'); }\r\n  addAccount(data: any) { return this.command('add-account', data); }\r\n  loginAccount(id: string | number) { return this.command('login-account', { id }); }\r\n  logoutAccount(id: string | number) { return this.command('logout-account', { id }); }\r\n  \r\n  // èªè­‰\r\n  sendCode(phone: string, apiId?: string, apiHash?: string) {\r\n    return this.command('send-code', { phone, apiId, apiHash });\r\n  }\r\n  verifyCode(phone: string, code: string, phoneCodeHash: string) {\r\n    return this.command('verify-code', { phone, code, phoneCodeHash });\r\n  }\r\n  \r\n  // API æ†‘è­‰\r\n  getCredentials() { return this.cachedCommand('get-api-credentials'); }\r\n  addCredential(data: any) { return this.command('add-api-credential', data); }\r\n  getRecommendedCredential() { return this.cachedCommand('get-api-recommendation'); }\r\n  \r\n  // ç›£æ§\r\n  getMonitoringStatus() { return this.command('get-monitoring-status'); }\r\n  startMonitoring(config?: any) { return this.command('start-monitoring', config); }\r\n  stopMonitoring() { return this.command('stop-monitoring'); }\r\n  \r\n  // åˆå§‹ç‹€æ…‹\r\n  getInitialState() { return this.cachedCommand('get-initial-state', {}, 5000); }\r\n  \r\n  // è¨­ç½®\r\n  getSettings() { return this.cachedCommand('get-settings'); }\r\n  saveSettings(settings: any) {\r\n    this.clearCache('get-settings');\r\n    return this.command('save-settings', settings);\r\n  }\r\n}\r\n", "/**\r\n * èªè­‰äº‹ä»¶æœå‹™\r\n * \r\n * ğŸ†• çµ±ä¸€èªè­‰äº‹ä»¶ç¸½ç·š\r\n * è§£æ±ºå¤šå€‹ AuthService ç‹€æ…‹ä¸åŒæ­¥çš„å•é¡Œ\r\n * \r\n * è¨­è¨ˆåŸå‰‡ï¼š\r\n * 1. å–®ä¸€äº‹ä»¶æº - æ‰€æœ‰èªè­‰äº‹ä»¶é€šéæ­¤æœå‹™å»£æ’­\r\n * 2. è§£è€¦ä¾è³´ - é¿å…æœå‹™é–“å¾ªç’°ä¾è³´\r\n * 3. äº‹ä»¶é©…å‹• - ä½¿ç”¨ RxJS Subject å»£æ’­äº‹ä»¶\r\n */\r\n\r\nimport { Injectable } from '@angular/core';\r\nimport { Subject, Observable } from 'rxjs';\r\n\r\n// èªè­‰äº‹ä»¶é¡å‹\r\nexport type AuthEventType = \r\n  | 'login'           // ç™»å…¥æˆåŠŸ\r\n  | 'logout'          // ç™»å‡º\r\n  | 'session_expired' // æœƒè©±éæœŸ\r\n  | 'token_refresh'   // Token åˆ·æ–°\r\n  | 'user_update';    // ç”¨æˆ¶ä¿¡æ¯æ›´æ–°\r\n\r\n// èªè­‰äº‹ä»¶æ•¸æ“š\r\nexport interface AuthEvent {\r\n  type: AuthEventType;\r\n  payload?: any;\r\n  timestamp: number;\r\n}\r\n\r\n// Token å­˜å„²éµ - é›†ä¸­ç®¡ç†\r\nexport const AUTH_STORAGE_KEYS = {\r\n  ACCESS_TOKEN: 'tgm_access_token',\r\n  REFRESH_TOKEN: 'tgm_refresh_token',\r\n  AUTH_TOKEN: 'tgm_auth_token',  // èˆŠç‰ˆå…¼å®¹\r\n  USER: 'tgm_user',\r\n  SESSION_ID: 'tgm_session_id',\r\n  REMEMBER_ME: 'tgm_remember_me'  // ğŸ†• è¨˜ä½ç™»å…¥ç‹€æ…‹\r\n} as const;\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthEventsService {\r\n  // èªè­‰äº‹ä»¶ä¸»é¡Œ\r\n  private _authEvents = new Subject<AuthEvent>();\r\n  \r\n  // å…¬é–‹çš„äº‹ä»¶æµ\r\n  readonly authEvents$: Observable<AuthEvent> = this._authEvents.asObservable();\r\n  \r\n  /**\r\n   * å»£æ’­ç™»å…¥äº‹ä»¶\r\n   */\r\n  emitLogin(payload?: any): void {\r\n    this._authEvents.next({\r\n      type: 'login',\r\n      payload,\r\n      timestamp: Date.now()\r\n    });\r\n    console.log('[AuthEvents] Login event emitted');\r\n  }\r\n  \r\n  /**\r\n   * å»£æ’­ç™»å‡ºäº‹ä»¶\r\n   */\r\n  emitLogout(): void {\r\n    this._authEvents.next({\r\n      type: 'logout',\r\n      timestamp: Date.now()\r\n    });\r\n    console.log('[AuthEvents] Logout event emitted');\r\n  }\r\n  \r\n  /**\r\n   * å»£æ’­æœƒè©±éæœŸäº‹ä»¶\r\n   */\r\n  emitSessionExpired(): void {\r\n    this._authEvents.next({\r\n      type: 'session_expired',\r\n      timestamp: Date.now()\r\n    });\r\n    console.log('[AuthEvents] Session expired event emitted');\r\n  }\r\n  \r\n  /**\r\n   * å»£æ’­ Token åˆ·æ–°äº‹ä»¶\r\n   */\r\n  emitTokenRefresh(newToken: string): void {\r\n    this._authEvents.next({\r\n      type: 'token_refresh',\r\n      payload: { token: newToken },\r\n      timestamp: Date.now()\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * å»£æ’­ç”¨æˆ¶ä¿¡æ¯æ›´æ–°äº‹ä»¶\r\n   */\r\n  emitUserUpdate(user: any): void {\r\n    this._authEvents.next({\r\n      type: 'user_update',\r\n      payload: { user },\r\n      timestamp: Date.now()\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * æ¸…é™¤æ‰€æœ‰èªè­‰ç›¸é—œçš„ localStorage\r\n   * é›†ä¸­å¼ç®¡ç†ï¼Œç¢ºä¿å¾¹åº•æ¸…é™¤\r\n   */\r\n  clearAllAuthStorage(): void {\r\n    console.log('[AuthEvents] Clearing all auth storage');\r\n    Object.values(AUTH_STORAGE_KEYS).forEach(key => {\r\n      localStorage.removeItem(key);\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * ç²å–ç•¶å‰ Tokenï¼ˆå¾ localStorageï¼‰\r\n   */\r\n  getStoredToken(): string | null {\r\n    return localStorage.getItem(AUTH_STORAGE_KEYS.ACCESS_TOKEN) \r\n        || localStorage.getItem(AUTH_STORAGE_KEYS.AUTH_TOKEN);\r\n  }\r\n  \r\n  /**\r\n   * ç²å–å­˜å„²çš„ç”¨æˆ¶ä¿¡æ¯\r\n   */\r\n  getStoredUser(): any | null {\r\n    try {\r\n      const userJson = localStorage.getItem(AUTH_STORAGE_KEYS.USER);\r\n      return userJson ? JSON.parse(userJson) : null;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n}\r\n", "/**\r\n * TG-Matrix èªè­‰æœå‹™\r\n * \r\n * å„ªåŒ–è¨­è¨ˆï¼š\r\n * 1. çµ±ä¸€çš„èªè­‰ç‹€æ…‹ç®¡ç†\r\n * 2. Token è‡ªå‹•åˆ·æ–°\r\n * 3. è¨­å‚™ç®¡ç†\r\n * 4. é›¢ç·šæ”¯æŒ\r\n */\r\n\r\nimport { Injectable, inject, signal, computed, effect, OnDestroy } from '@angular/core';\r\nimport { Router } from '@angular/router';\r\nimport { Subscription } from 'rxjs';\r\nimport { ApiService } from './api.service';\r\nimport { AuthEventsService, AUTH_STORAGE_KEYS } from './auth-events.service';\r\n\r\n// ç”¨æˆ¶æ¨¡å‹\r\nexport interface User {\r\n  id: string;\r\n  email: string;\r\n  username: string;\r\n  display_name: string;\r\n  avatar_url: string;\r\n  role: string;\r\n  subscription_tier: string;\r\n  max_accounts: number;\r\n  is_active: boolean;\r\n  is_verified: boolean;\r\n  two_factor_enabled: boolean;\r\n  created_at: string;\r\n  last_login_at: string;\r\n  // ğŸ†• é‚€è«‹ç›¸é—œå­—æ®µ\r\n  invite_code?: string;\r\n  inviteCode?: string;\r\n  invited_count?: number;\r\n}\r\n\r\n// èªè­‰ç‹€æ…‹\r\nexport interface AuthState {\r\n  user: User | null;\r\n  isAuthenticated: boolean;\r\n  isLoading: boolean;\r\n  accessToken: string | null;\r\n  refreshToken: string | null;\r\n}\r\n\r\n// ç™»å…¥è«‹æ±‚\r\nexport interface LoginRequest {\r\n  email: string;\r\n  password: string;\r\n  remember?: boolean;\r\n  device_name?: string;\r\n}\r\n\r\n// è¨»å†Šè«‹æ±‚\r\nexport interface RegisterRequest {\r\n  email: string;\r\n  password: string;\r\n  username?: string;\r\n  display_name?: string;\r\n}\r\n\r\n// Token å­˜å„²éµï¼ˆä½¿ç”¨é›†ä¸­å®šç¾©ï¼‰\r\nconst TOKEN_KEYS = AUTH_STORAGE_KEYS;\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthService implements OnDestroy {\r\n  private api = inject(ApiService);\r\n  private router = inject(Router);\r\n  private authEvents = inject(AuthEventsService);\r\n  \r\n  // äº‹ä»¶è¨‚é–±\r\n  private eventSubscription: Subscription | null = null;\r\n  \r\n  // ç‹€æ…‹ä¿¡è™Ÿ\r\n  private _user = signal<User | null>(null);\r\n  private _isLoading = signal<boolean>(false);\r\n  private _accessToken = signal<string | null>(null);\r\n  private _refreshToken = signal<string | null>(null);\r\n  \r\n  // Token åˆ·æ–°å®šæ™‚å™¨\r\n  private refreshTimer: any = null;\r\n  \r\n  // å…¬é–‹çš„è¨ˆç®—å±¬æ€§\r\n  readonly user = computed(() => this._user());\r\n  // ğŸ”§ ä¿®å¾©ï¼šåªéœ€è¦ Token å­˜åœ¨å³å¯èªç‚ºå·²èªè­‰ï¼ˆuser å¯ä»¥å»¶é²åŠ è¼‰ï¼‰\r\n  readonly isAuthenticated = computed(() => !!this._accessToken());\r\n  readonly isLoading = computed(() => this._isLoading());\r\n  readonly accessToken = computed(() => this._accessToken());\r\n  \r\n  // è¨‚é–±ä¿¡æ¯\r\n  readonly subscriptionTier = computed(() => this._user()?.subscription_tier || 'free');\r\n  readonly maxAccounts = computed(() => this._user()?.max_accounts || 3);\r\n  readonly isPro = computed(() => ['pro', 'enterprise'].includes(this.subscriptionTier()));\r\n  \r\n  // æœƒå“¡ç­‰ç´šï¼ˆå…¼å®¹èˆŠæ¥å£ï¼‰\r\n  readonly membershipLevel = computed(() => {\r\n    const tier = this.subscriptionTier();\r\n    const tierMap: Record<string, string> = {\r\n      'free': 'bronze',\r\n      'basic': 'silver',\r\n      'pro': 'gold',\r\n      'enterprise': 'diamond'\r\n    };\r\n    return tierMap[tier] || 'bronze';\r\n  });\r\n  \r\n  \r\n  // ğŸ”§ æ¨™è¨˜æ˜¯å¦å·²å®Œæˆåˆå§‹åŒ–ï¼Œé¿å… effect åœ¨åˆå§‹åŒ–æ™‚åˆªé™¤ localStorage\r\n  private _initialized = false;\r\n  \r\n  constructor() {\r\n    // åˆå§‹åŒ–æ™‚æ¢å¾©ç‹€æ…‹\r\n    this.restoreSession();\r\n    this._initialized = true;\r\n    \r\n    // ğŸ†• è¨‚é–±èªè­‰äº‹ä»¶ï¼ˆè™•ç†ä¾†è‡ªå…¶ä»–æœå‹™çš„ç™»å‡ºé€šçŸ¥ï¼‰\r\n    this.eventSubscription = this.authEvents.authEvents$.subscribe(event => {\r\n      if (event.type === 'logout') {\r\n        console.log('[CoreAuthService] Received logout event, clearing state');\r\n        this.clearAuthStateInternal();\r\n      }\r\n    });\r\n    \r\n    // Token è®ŠåŒ–æ™‚è‡ªå‹•ä¿å­˜ - ğŸ”§ ä¿®å¾©ï¼šåªåœ¨åˆå§‹åŒ–å¾Œæ‰åŸ·è¡Œåˆªé™¤æ“ä½œ\r\n    effect(() => {\r\n      const token = this._accessToken();\r\n      if (token) {\r\n        localStorage.setItem(TOKEN_KEYS.ACCESS_TOKEN, token);\r\n      } else if (this._initialized) {\r\n        // ğŸ”§ åªæœ‰åœ¨åˆå§‹åŒ–å®Œæˆå¾Œï¼Œæ‰åˆªé™¤ localStorage\r\n        // é¿å…åœ¨æ§‹é€ å‡½æ•¸ä¸­å› ç‚ºåˆå§‹å€¼ null è€Œåˆªé™¤å·²ä¿å­˜çš„ Token\r\n        localStorage.removeItem(TOKEN_KEYS.ACCESS_TOKEN);\r\n      }\r\n    });\r\n    \r\n    effect(() => {\r\n      const token = this._refreshToken();\r\n      if (token) {\r\n        localStorage.setItem(TOKEN_KEYS.REFRESH_TOKEN, token);\r\n      } else if (this._initialized) {\r\n        localStorage.removeItem(TOKEN_KEYS.REFRESH_TOKEN);\r\n      }\r\n    });\r\n    \r\n    effect(() => {\r\n      const user = this._user();\r\n      if (user) {\r\n        localStorage.setItem(TOKEN_KEYS.USER, JSON.stringify(user));\r\n      } else if (this._initialized) {\r\n        localStorage.removeItem(TOKEN_KEYS.USER);\r\n      }\r\n    });\r\n  }\r\n  \r\n  ngOnDestroy(): void {\r\n    this.eventSubscription?.unsubscribe();\r\n  }\r\n  \r\n  // ==================== å…¬é–‹æ–¹æ³• ====================\r\n  \r\n  /**\r\n   * ç”¨æˆ¶è¨»å†Š\r\n   */\r\n  async register(request: RegisterRequest): Promise<{ success: boolean; error?: string }> {\r\n    this._isLoading.set(true);\r\n    \r\n    try {\r\n      const result = await this.api.command<any>('user-register', request);\r\n      \r\n      if (result.success && result.data) {\r\n        this.setAuthState(result.data);\r\n        return { success: true };\r\n      }\r\n      \r\n      return { success: false, error: result.error || 'è¨»å†Šå¤±æ•—' };\r\n    } catch (e: any) {\r\n      return { success: false, error: e.message || 'è¨»å†Šå¤±æ•—' };\r\n    } finally {\r\n      this._isLoading.set(false);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ç”¨æˆ¶ç™»å…¥\r\n   */\r\n  async login(request: LoginRequest): Promise<{ success: boolean; error?: string }> {\r\n    this._isLoading.set(true);\r\n    \r\n    try {\r\n      // èª¿ç”¨ HTTP API\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/login`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          email: request.email,\r\n          password: request.password,\r\n          device_name: request.device_name || this.getDeviceName(),\r\n          remember: request.remember || false // ğŸ†• å‚³éè¨˜ä½ç™»å…¥é¸é …\r\n        })\r\n      });\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (result.success && result.data) {\r\n        // ğŸ†• ä¿å­˜è¨˜ä½ç‹€æ…‹\r\n        if (request.remember) {\r\n          localStorage.setItem('tgm_remember_me', 'true');\r\n        } else {\r\n          localStorage.removeItem('tgm_remember_me');\r\n        }\r\n        \r\n        this.setAuthState(result.data);\r\n        this.scheduleTokenRefresh();\r\n        return { success: true };\r\n      }\r\n      \r\n      return { success: false, error: result.error || 'ç™»å…¥å¤±æ•—' };\r\n    } catch (e: any) {\r\n      return { success: false, error: e.message || 'ç™»å…¥å¤±æ•—' };\r\n    } finally {\r\n      this._isLoading.set(false);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ç²å– Telegram OAuth é…ç½®\r\n   */\r\n  async getTelegramConfig(): Promise<{ enabled: boolean; bot_username?: string; bot_id?: string }> {\r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/oauth/telegram/config`);\r\n      const result = await response.json();\r\n      \r\n      if (result.success && result.data) {\r\n        return result.data;\r\n      }\r\n      \r\n      return { enabled: false };\r\n    } catch (e) {\r\n      console.error('Failed to get Telegram config:', e);\r\n      return { enabled: false };\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Telegram OAuth ç™»å…¥\r\n   */\r\n  async telegramLogin(authData: any): Promise<{ success: boolean; error?: string }> {\r\n    this._isLoading.set(true);\r\n    \r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/oauth/telegram`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(authData)\r\n      });\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (result.success) {\r\n        // è¨­ç½®èªè­‰ç‹€æ…‹\r\n        this.setAuthState({\r\n          user: result.user,\r\n          access_token: result.access_token,\r\n          refresh_token: result.refresh_token\r\n        });\r\n        this.scheduleTokenRefresh();\r\n        return { success: true };\r\n      }\r\n      \r\n      return { success: false, error: result.error || 'Telegram ç™»å…¥å¤±æ•—' };\r\n    } catch (e: any) {\r\n      return { success: false, error: e.message || 'Telegram ç™»å…¥å¤±æ•—' };\r\n    } finally {\r\n      this._isLoading.set(false);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ç™»å‡º\r\n   */\r\n  async logout(): Promise<void> {\r\n    try {\r\n      const token = this._accessToken();\r\n      if (token) {\r\n        await fetch(`${this.getApiBaseUrl()}/api/v1/auth/logout`, {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            'Authorization': `Bearer ${token}`\r\n          }\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.error('Logout error:', e);\r\n    } finally {\r\n      // ğŸ†• å»£æ’­ç™»å‡ºäº‹ä»¶ï¼Œé€šçŸ¥æ‰€æœ‰è¨‚é–±è€…\r\n      this.authEvents.emitLogout();\r\n      // æ¸…é™¤æœ¬æœå‹™ç‹€æ…‹\r\n      this.clearAuthStateInternal();\r\n      // ğŸ”§ ä¿®å¾©ï¼šä½¿ç”¨æ­£ç¢ºçš„ç™»å…¥é é¢è·¯å¾‘\r\n      this.router.navigate(['/auth/login']);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * è«‹æ±‚å¯†ç¢¼é‡ç½®\r\n   */\r\n  async forgotPassword(email: string): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/forgot-password`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ email })\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return { success: result.success, error: result.error };\r\n    } catch (e: any) {\r\n      return { success: false, error: e.message };\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * é‡ç½®å¯†ç¢¼\r\n   */\r\n  async resetPassword(token: string, password: string): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/reset-password`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ token, password })\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return { success: result.success, error: result.error };\r\n    } catch (e: any) {\r\n      return { success: false, error: e.message };\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * é©—è­‰éƒµç®±ï¼ˆé€šé Tokenï¼‰\r\n   */\r\n  async verifyEmail(token: string): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/verify-email`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ token })\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return { success: result.success, error: result.error };\r\n    } catch (e: any) {\r\n      return { success: false, error: e.message };\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * é©—è­‰éƒµç®±ï¼ˆé€šéé©—è­‰ç¢¼ï¼‰\r\n   */\r\n  async verifyEmailByCode(email: string, code: string): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/verify-email-code`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ email, code })\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return { success: result.success, error: result.error };\r\n    } catch (e: any) {\r\n      return { success: false, error: e.message };\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * é‡æ–°ç™¼é€é©—è­‰éƒµä»¶\r\n   */\r\n  async resendVerificationEmail(): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n      const token = this._accessToken();\r\n      if (!token) {\r\n        return { success: false, error: 'æœªç™»å…¥' };\r\n      }\r\n      \r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/send-verification`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`\r\n        }\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return { success: result.success, error: result.error };\r\n    } catch (e: any) {\r\n      return { success: false, error: e.message };\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * åˆ·æ–° Token\r\n   */\r\n  async refreshAccessToken(): Promise<boolean> {\r\n    const refreshToken = this._refreshToken();\r\n    if (!refreshToken) {\r\n      return false;\r\n    }\r\n    \r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/refresh`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ refresh_token: refreshToken })\r\n      });\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (result.success && result.data) {\r\n        this._accessToken.set(result.data.access_token);\r\n        this._refreshToken.set(result.data.refresh_token);\r\n        this.scheduleTokenRefresh();\r\n        return true;\r\n      }\r\n      \r\n      return false;\r\n    } catch (e) {\r\n      console.error('Token refresh error:', e);\r\n      return false;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ç²å–ç•¶å‰ç”¨æˆ¶ä¿¡æ¯\r\n   * ğŸ”§ å„ªåŒ–ï¼šåŒæ™‚æª¢æŸ¥ Signal å’Œ localStorageï¼Œç¢ºä¿ Token ç¸½èƒ½è¢«è®€å–\r\n   */\r\n  async fetchCurrentUser(): Promise<User | null> {\r\n    // ğŸ”§ ä¿®å¾©ï¼šåŒæ™‚æª¢æŸ¥ Signal å’Œ localStorage\r\n    const token = this._accessToken() || localStorage.getItem(TOKEN_KEYS.ACCESS_TOKEN);\r\n    if (!token) {\r\n      console.log('[AuthService] fetchCurrentUser: No token available');\r\n      return null;\r\n    }\r\n    \r\n    // ç¢ºä¿ Signal åŒæ­¥ï¼ˆé˜²æ­¢ä¸ä¸€è‡´ï¼‰\r\n    if (!this._accessToken() && token) {\r\n      this._accessToken.set(token);\r\n    }\r\n    \r\n    try {\r\n      console.log('[AuthService] fetchCurrentUser: Fetching user info...');\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/me`, {\r\n        headers: { 'Authorization': `Bearer ${token}` }\r\n      });\r\n      \r\n      // ğŸ”§ è™•ç†é 200 éŸ¿æ‡‰\r\n      if (!response.ok) {\r\n        console.warn(`[AuthService] fetchCurrentUser: HTTP ${response.status}`);\r\n        if (response.status === 401) {\r\n          // Token ç„¡æ•ˆï¼Œæ¸…é™¤èªè­‰ç‹€æ…‹\r\n          console.warn('[AuthService] Token invalid, clearing session');\r\n          // ä¸ç›´æ¥æ¸…é™¤ï¼Œè®“èª¿ç”¨è€…æ±ºå®šå¦‚ä½•è™•ç†\r\n        }\r\n        return null;\r\n      }\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (result.success && result.data) {\r\n        console.log('[AuthService] fetchCurrentUser: Success', result.data.username);\r\n        this._user.set(result.data);\r\n        // ğŸ”§ åŒæ­¥æ›´æ–° localStorageï¼ˆç¢ºä¿ä¸€è‡´æ€§ï¼‰\r\n        localStorage.setItem(TOKEN_KEYS.USER, JSON.stringify(result.data));\r\n        return result.data;\r\n      }\r\n      \r\n      console.warn('[AuthService] fetchCurrentUser: API returned', result);\r\n      return null;\r\n    } catch (e) {\r\n      console.error('[AuthService] fetchCurrentUser error:', e);\r\n      return null;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æ›´æ–°ç”¨æˆ¶ä¿¡æ¯\r\n   */\r\n  async updateProfile(updates: Partial<User>): Promise<{ success: boolean; error?: string }> {\r\n    const token = this._accessToken();\r\n    if (!token) {\r\n      return { success: false, error: 'æœªç™»å…¥' };\r\n    }\r\n    \r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/me`, {\r\n        method: 'PUT',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`\r\n        },\r\n        body: JSON.stringify(updates)\r\n      });\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (result.success) {\r\n        // æ›´æ–°æœ¬åœ°ç”¨æˆ¶ä¿¡æ¯\r\n        const currentUser = this._user();\r\n        if (currentUser) {\r\n          this._user.set({ ...currentUser, ...updates });\r\n        }\r\n        return { success: true };\r\n      }\r\n      \r\n      return { success: false, error: result.error };\r\n    } catch (e: any) {\r\n      return { success: false, error: e.message };\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ä¿®æ”¹å¯†ç¢¼\r\n   */\r\n  async changePassword(oldPassword: string, newPassword: string): Promise<{ success: boolean; error?: string }> {\r\n    const token = this._accessToken();\r\n    if (!token) {\r\n      return { success: false, error: 'æœªç™»å…¥' };\r\n    }\r\n    \r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/change-password`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`\r\n        },\r\n        body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return { success: result.success, error: result.error };\r\n    } catch (e: any) {\r\n      return { success: false, error: e.message };\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ç²å–æœƒè©±åˆ—è¡¨\r\n   */\r\n  /**\r\n   * ğŸ†• Phase 4: ç²å–ç”¨æˆ¶æ‰€æœ‰è¨­å‚™\r\n   */\r\n  async getSessions(): Promise<any[]> {\r\n    const token = this._accessToken();\r\n    if (!token) return [];\r\n    \r\n    try {\r\n      // ä½¿ç”¨æ–°çš„è¨­å‚™ç®¡ç† API\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/devices`, {\r\n        headers: { 'Authorization': `Bearer ${token}` }\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return result.success ? (result.data?.devices || []) : [];\r\n    } catch (e) {\r\n      return [];\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æ’¤éŠ·æœƒè©±\r\n   */\r\n  /**\r\n   * ğŸ†• Phase 4: æ’¤éŠ·æŒ‡å®šè¨­å‚™æœƒè©±\r\n   */\r\n  async revokeSession(sessionId: string): Promise<boolean> {\r\n    const token = this._accessToken();\r\n    if (!token) return false;\r\n    \r\n    try {\r\n      // ä½¿ç”¨æ–°çš„è¨­å‚™ç®¡ç† API\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/devices/${sessionId}`, {\r\n        method: 'DELETE',\r\n        headers: { 'Authorization': `Bearer ${token}` }\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return result.success;\r\n    } catch (e) {\r\n      return false;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ğŸ†• Phase 4: ç™»å‡ºé™¤ç•¶å‰è¨­å‚™å¤–çš„æ‰€æœ‰è¨­å‚™\r\n   */\r\n  async revokeAllOtherSessions(): Promise<number> {\r\n    const token = this._accessToken();\r\n    if (!token) return 0;\r\n    \r\n    try {\r\n      // ç²å–ç•¶å‰æœƒè©± IDï¼ˆå¦‚æœæœ‰ä¿å­˜çš„è©±ï¼‰\r\n      const currentSessionId = localStorage.getItem('tgm_session_id') || '';\r\n      \r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/devices/revoke-all`, {\r\n        method: 'POST',\r\n        headers: { \r\n          'Authorization': `Bearer ${token}`,\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ current_session_id: currentSessionId })\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return result.success ? (result.revoked_count || 0) : 0;\r\n    } catch (e) {\r\n      return 0;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æª¢æŸ¥åŠŸèƒ½æ¬Šé™\r\n   */\r\n  hasFeature(feature: string): boolean {\r\n    const tier = this.subscriptionTier();\r\n    const featureMap: Record<string, string[]> = {\r\n      'free': ['basic_monitoring', 'basic_ai'],\r\n      'basic': ['basic_monitoring', 'basic_ai', 'templates'],\r\n      'pro': ['basic_monitoring', 'basic_ai', 'templates', 'full_monitoring', 'advanced_ai', 'team', 'api_access'],\r\n      'enterprise': ['all']\r\n    };\r\n    \r\n    const allowedFeatures = featureMap[tier] || [];\r\n    return allowedFeatures.includes('all') || allowedFeatures.includes(feature);\r\n  }\r\n  \r\n  /**\r\n   * ç²å–èªè­‰ Header\r\n   * ğŸ”§ ä¿®å¾©ï¼šåŒæ™‚æª¢æŸ¥ Signal å’Œ localStorageï¼Œç¢ºä¿ Token ç¸½èƒ½è¢«è®€å–\r\n   */\r\n  getAuthHeaders(): Record<string, string> {\r\n    const token = this._accessToken() || localStorage.getItem('tgm_access_token');\r\n    if (token) {\r\n      return { 'Authorization': `Bearer ${token}` };\r\n    }\r\n    return {};\r\n  }\r\n  \r\n  // ==================== ğŸ†• è¨­å‚™ç®¡ç† ====================\r\n  \r\n  /**\r\n   * ç²å–æ‰€æœ‰ç¶å®šè¨­å‚™\r\n   */\r\n  async getDevices(): Promise<any[]> {\r\n    const token = this._accessToken();\r\n    if (!token) return [];\r\n    \r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/devices`, {\r\n        headers: { 'Authorization': `Bearer ${token}` }\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return result.success ? (result.data?.devices || result.devices || []) : [];\r\n    } catch (e) {\r\n      console.error('Failed to get devices:', e);\r\n      return [];\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ç¶å®šæ–°è¨­å‚™\r\n   */\r\n  async bindDevice(deviceCode: string, deviceName: string): Promise<{ success: boolean; message: string }> {\r\n    const token = this._accessToken();\r\n    if (!token) {\r\n      return { success: false, message: 'æœªç™»å…¥' };\r\n    }\r\n    \r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/devices`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`\r\n        },\r\n        body: JSON.stringify({ device_code: deviceCode, device_name: deviceName })\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return { success: result.success, message: result.message || (result.success ? 'ç¶å®šæˆåŠŸ' : 'ç¶å®šå¤±æ•—') };\r\n    } catch (e: any) {\r\n      return { success: false, message: e.message || 'ç¶å®šå¤±æ•—' };\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * è§£ç¶è¨­å‚™\r\n   */\r\n  async unbindDevice(deviceId: string | number): Promise<{ success: boolean; message: string }> {\r\n    const token = this._accessToken();\r\n    if (!token) {\r\n      return { success: false, message: 'æœªç™»å…¥' };\r\n    }\r\n    \r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/devices/${deviceId}`, {\r\n        method: 'DELETE',\r\n        headers: { 'Authorization': `Bearer ${token}` }\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return { success: result.success, message: result.message || (result.success ? 'è§£ç¶æˆåŠŸ' : 'è§£ç¶å¤±æ•—') };\r\n    } catch (e: any) {\r\n      return { success: false, message: e.message || 'è§£ç¶å¤±æ•—' };\r\n    }\r\n  }\r\n  \r\n  // ==================== ğŸ†• æœƒå“¡ç®¡ç† ====================\r\n  \r\n  /**\r\n   * ç²å–ä½¿ç”¨çµ±è¨ˆ\r\n   */\r\n  async getUsageStats(): Promise<any> {\r\n    const token = this._accessToken();\r\n    if (!token) return null;\r\n    \r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/usage-stats`, {\r\n        headers: { 'Authorization': `Bearer ${token}` }\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return result.success ? result.data : null;\r\n    } catch (e) {\r\n      console.error('Failed to get usage stats:', e);\r\n      return null;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * æ¿€æ´»å¡å¯†ï¼ˆçºŒè²»/å‡ç´šæœƒå“¡ï¼‰\r\n   */\r\n  async activateLicense(licenseKey: string): Promise<{ success: boolean; message: string; data?: any }> {\r\n    const token = this._accessToken();\r\n    if (!token) {\r\n      return { success: false, message: 'æœªç™»å…¥' };\r\n    }\r\n    \r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/license/activate`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`\r\n        },\r\n        body: JSON.stringify({ license_key: licenseKey })\r\n      });\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (result.success) {\r\n        // æ›´æ–°ç”¨æˆ¶ä¿¡æ¯\r\n        await this.fetchCurrentUser();\r\n        // å»£æ’­ç”¨æˆ¶æ›´æ–°äº‹ä»¶\r\n        this.authEvents.emitUserUpdate(this._user());\r\n      }\r\n      \r\n      return { \r\n        success: result.success, \r\n        message: result.message || (result.success ? 'æ¿€æ´»æˆåŠŸ' : 'æ¿€æ´»å¤±æ•—'),\r\n        data: result.data \r\n      };\r\n    } catch (e: any) {\r\n      return { success: false, message: e.message || 'æ¿€æ´»å¤±æ•—' };\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * ç²å–é‚€è«‹çå‹µä¿¡æ¯\r\n   */\r\n  async getInviteRewards(): Promise<{ inviteCode: string; invitedCount: number; rewardDays: number }> {\r\n    const token = this._accessToken();\r\n    const user = this._user();\r\n    \r\n    const defaultResult = {\r\n      inviteCode: user?.invite_code || user?.inviteCode || '',\r\n      invitedCount: 0,\r\n      rewardDays: 0\r\n    };\r\n    \r\n    if (!token) return defaultResult;\r\n    \r\n    try {\r\n      const response = await fetch(`${this.getApiBaseUrl()}/api/v1/auth/invite-rewards`, {\r\n        headers: { 'Authorization': `Bearer ${token}` }\r\n      });\r\n      \r\n      const result = await response.json();\r\n      return result.success ? {\r\n        inviteCode: result.data?.invite_code || defaultResult.inviteCode,\r\n        invitedCount: result.data?.invited_count || 0,\r\n        rewardDays: result.data?.reward_days || 0\r\n      } : defaultResult;\r\n    } catch (e) {\r\n      return defaultResult;\r\n    }\r\n  }\r\n  \r\n  // ==================== ç§æœ‰æ–¹æ³• ====================\r\n  \r\n  private setAuthState(data: any): void {\r\n    if (data.user) {\r\n      this._user.set(data.user);\r\n      // ğŸ”§ åŒæ­¥ä¿å­˜åˆ° localStorageï¼ˆé¿å… effect ç•°æ­¥å°è‡´é é¢åˆ·æ–°å‰æœªä¿å­˜ï¼‰\r\n      localStorage.setItem(TOKEN_KEYS.USER, JSON.stringify(data.user));\r\n    }\r\n    if (data.access_token) {\r\n      this._accessToken.set(data.access_token);\r\n      // ğŸ”§ åŒæ­¥ä¿å­˜åˆ° localStorage\r\n      localStorage.setItem(TOKEN_KEYS.ACCESS_TOKEN, data.access_token);\r\n    }\r\n    if (data.refresh_token) {\r\n      this._refreshToken.set(data.refresh_token);\r\n      // ğŸ”§ åŒæ­¥ä¿å­˜åˆ° localStorage\r\n      localStorage.setItem(TOKEN_KEYS.REFRESH_TOKEN, data.refresh_token);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * è¨­ç½®æœƒè©±ï¼ˆå…¬é–‹æ–¹æ³•ï¼‰\r\n   * ğŸ†• ç”¨æ–¼ç™»å…¥æˆåŠŸå¾Œç›´æ¥è¨­ç½®èªè­‰ç‹€æ…‹\r\n   */\r\n  setSession(data: { access_token?: string; refresh_token?: string; user?: any; session_id?: string }): void {\r\n    console.log('[AuthService] setSession called:', {\r\n      hasAccessToken: !!data.access_token,\r\n      hasRefreshToken: !!data.refresh_token,\r\n      hasUser: !!data.user\r\n    });\r\n    \r\n    // å…ˆç›´æ¥ä¿å­˜åˆ° localStorageï¼ˆç¢ºä¿æŒä¹…åŒ–ï¼‰\r\n    if (data.access_token) {\r\n      localStorage.setItem(TOKEN_KEYS.ACCESS_TOKEN, data.access_token);\r\n      this._accessToken.set(data.access_token);\r\n    }\r\n    if (data.refresh_token) {\r\n      localStorage.setItem(TOKEN_KEYS.REFRESH_TOKEN, data.refresh_token);\r\n      this._refreshToken.set(data.refresh_token);\r\n    }\r\n    if (data.user) {\r\n      localStorage.setItem(TOKEN_KEYS.USER, JSON.stringify(data.user));\r\n      this._user.set(data.user);\r\n    }\r\n    if (data.session_id) {\r\n      localStorage.setItem(TOKEN_KEYS.SESSION_ID, data.session_id);\r\n    }\r\n    \r\n    // ğŸ†• å»£æ’­ç™»å…¥äº‹ä»¶\r\n    this.authEvents.emitLogin(data);\r\n    \r\n    console.log('[AuthService] setSession complete, isAuthenticated:', this.isAuthenticated());\r\n  }\r\n  \r\n  /**\r\n   * æ¸…é™¤æœƒè©±ï¼ˆå…¬é–‹æ–¹æ³•ï¼‰\r\n   * ç”¨æ–¼èªè­‰å®ˆè¡›ç™¼ç¾ç„¡æ•ˆç‹€æ…‹æ™‚æ¸…ç†\r\n   * ğŸ†• åŒæ™‚å»£æ’­äº‹ä»¶é€šçŸ¥å…¶ä»–æœå‹™\r\n   */\r\n  clearSession(): void {\r\n    this.authEvents.emitLogout();\r\n    this.clearAuthStateInternal();\r\n  }\r\n  \r\n  /**\r\n   * å…§éƒ¨æ¸…é™¤ç‹€æ…‹ï¼ˆä¸ç™¼é€äº‹ä»¶ï¼Œé¿å…å¾ªç’°ï¼‰\r\n   */\r\n  private clearAuthStateInternal(): void {\r\n    this._user.set(null);\r\n    this._accessToken.set(null);\r\n    this._refreshToken.set(null);\r\n    \r\n    if (this.refreshTimer) {\r\n      clearTimeout(this.refreshTimer);\r\n      this.refreshTimer = null;\r\n    }\r\n    \r\n    // ğŸ†• ä½¿ç”¨é›†ä¸­å¼æ¸…é™¤æ–¹æ³•\r\n    this.authEvents.clearAllAuthStorage();\r\n  }\r\n  \r\n  /**\r\n   * @deprecated ä½¿ç”¨ clearAuthStateInternal ä»£æ›¿\r\n   */\r\n  private clearAuthState(): void {\r\n    this.clearAuthStateInternal();\r\n  }\r\n  \r\n  private restoreSession(): void {\r\n    try {\r\n      const accessToken = localStorage.getItem(TOKEN_KEYS.ACCESS_TOKEN);\r\n      const refreshToken = localStorage.getItem(TOKEN_KEYS.REFRESH_TOKEN);\r\n      const userJson = localStorage.getItem(TOKEN_KEYS.USER);\r\n      \r\n      console.log('[Auth] restoreSession - accessToken:', !!accessToken, 'refreshToken:', !!refreshToken, 'user:', !!userJson);\r\n      \r\n      // ğŸ†• P0: é©—è­‰ Token æ ¼å¼æœ‰æ•ˆæ€§\r\n      if (accessToken && !this.isValidTokenFormat(accessToken)) {\r\n        console.warn('[Auth] Invalid token format, clearing session');\r\n        this.clearAuthState();\r\n        return;\r\n      }\r\n      \r\n      if (accessToken) {\r\n        console.log('[Auth] Setting accessToken signal');\r\n        this._accessToken.set(accessToken);\r\n      }\r\n      if (refreshToken) {\r\n        this._refreshToken.set(refreshToken);\r\n      }\r\n      if (userJson) {\r\n        try {\r\n          this._user.set(JSON.parse(userJson));\r\n          console.log('[Auth] User restored from localStorage');\r\n        } catch {\r\n          console.warn('[Auth] Invalid user JSON, clearing');\r\n          this.clearAuthState();\r\n          return;\r\n        }\r\n      }\r\n      \r\n      // ğŸ”§ ä¿®å¾©ï¼šToken æœ‰æ•ˆæ€§æœƒåœ¨å¯¦éš› API è«‹æ±‚æ™‚ç”±å¾Œç«¯é©—è­‰\r\n      console.log('[Auth] Session restored successfully');\r\n      \r\n      // ğŸ”§ å„ªåŒ–ï¼šå¦‚æœæœ‰ Token ä½†æ²’æœ‰ç”¨æˆ¶ä¿¡æ¯ï¼Œç«‹å³ç²å–ï¼ˆä¸ç­‰å¾…ï¼‰\r\n      if (accessToken && !userJson) {\r\n        console.log('[Auth] Token exists but no user info, fetching immediately...');\r\n        // ä½¿ç”¨ queueMicrotask ç¢ºä¿åœ¨æ§‹é€ å‡½æ•¸å®Œæˆå¾ŒåŸ·è¡Œ\r\n        queueMicrotask(() => {\r\n          if (this._accessToken()) {\r\n            this.fetchCurrentUser().then(user => {\r\n              if (user) {\r\n                console.log('[Auth] User info fetched successfully:', user.username);\r\n              } else {\r\n                console.warn('[Auth] Failed to fetch user info');\r\n              }\r\n            }).catch(e => {\r\n              console.warn('[Auth] Error fetching user info:', e);\r\n            });\r\n          }\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.error('Restore session error:', e);\r\n      this.clearAuthState();\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * é©—è­‰ Token æ ¼å¼æ˜¯å¦æœ‰æ•ˆï¼ˆJWT æ ¼å¼æª¢æŸ¥ï¼‰\r\n   */\r\n  private isValidTokenFormat(token: string): boolean {\r\n    if (!token || token.length < 20) return false;\r\n    \r\n    // JWT æ‡‰è©²æœ‰ 3 å€‹éƒ¨åˆ†ç”¨ . åˆ†éš”\r\n    const parts = token.split('.');\r\n    if (parts.length !== 3) return false;\r\n    \r\n    try {\r\n      // å˜—è©¦è§£æ payloadï¼ˆè™•ç† URL-safe Base64ï¼‰\r\n      const payload = JSON.parse(this.base64UrlDecode(parts[1]));\r\n      \r\n      // æª¢æŸ¥æ˜¯å¦éæœŸ\r\n      if (payload.exp && Date.now() >= payload.exp * 1000) {\r\n        console.warn('[Auth] Token expired');\r\n        return false;\r\n      }\r\n      \r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * è§£ç¢¼ URL-safe Base64ï¼ˆè™•ç†å¾Œç«¯ JWT ç·¨ç¢¼ï¼‰\r\n   */\r\n  private base64UrlDecode(str: string): string {\r\n    // å°‡ URL-safe å­—ç¬¦æ›¿æ›å›æ¨™æº– Base64\r\n    let base64 = str.replace(/-/g, '+').replace(/_/g, '/');\r\n    // è£œé½Š padding\r\n    while (base64.length % 4) {\r\n      base64 += '=';\r\n    }\r\n    return atob(base64);\r\n  }\r\n  \r\n  private scheduleTokenRefresh(): void {\r\n    if (this.refreshTimer) {\r\n      clearTimeout(this.refreshTimer);\r\n    }\r\n    \r\n    // ğŸ†• æ ¹æ“š\"è¨˜ä½æˆ‘\"ç‹€æ…‹èª¿æ•´åˆ·æ–°é–“éš”\r\n    const rememberMe = localStorage.getItem('tgm_remember_me') === 'true';\r\n    // æ™®é€šï¼š55 åˆ†é˜åˆ·æ–°ï¼Œè¨˜ä½æˆ‘ï¼š23 å°æ™‚åˆ·æ–°ï¼ˆå‡è¨­å¾Œç«¯ Token æœ‰æ•ˆæœŸ 1 å°æ™‚/24 å°æ™‚ï¼‰\r\n    const refreshIn = rememberMe ? 23 * 60 * 60 * 1000 : 55 * 60 * 1000;\r\n    \r\n    console.log(`[AuthService] Scheduling token refresh in ${refreshIn / 60000} minutes (rememberMe: ${rememberMe})`);\r\n    \r\n    this.refreshTimer = setTimeout(() => {\r\n      this.refreshAccessToken();\r\n    }, refreshIn);\r\n  }\r\n  \r\n  private getApiBaseUrl(): string {\r\n    // é–‹ç™¼ç’°å¢ƒ\r\n    if (window.location.hostname === 'localhost' && window.location.port === '4200') {\r\n      return 'http://localhost:8000';\r\n    }\r\n    // ç”Ÿç”¢ç’°å¢ƒ\r\n    return '';\r\n  }\r\n  \r\n  private getDeviceName(): string {\r\n    const ua = navigator.userAgent;\r\n    if (ua.includes('Windows')) return 'Windows Browser';\r\n    if (ua.includes('Mac')) return 'Mac Browser';\r\n    if (ua.includes('Linux')) return 'Linux Browser';\r\n    if (ua.includes('iPhone') || ua.includes('iPad')) return 'iOS Browser';\r\n    if (ua.includes('Android')) return 'Android Browser';\r\n    return 'Web Browser';\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
