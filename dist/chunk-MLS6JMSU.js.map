{
  "version": 3,
  "sources": ["src/services/quota.service.ts"],
  "sourcesContent": ["/**\r\n * ÈÖçÈ°çÊúçÂãô\r\n * \r\n * Êèê‰æõÂâçÁ´ØÈÖçÈ°çÊ™¢Êü•„ÄÅÈ°ØÁ§∫ÂíåÂëäË≠¶ÂäüËÉΩ\r\n */\r\n\r\nimport { Injectable, signal, computed } from '@angular/core';\r\nimport { ElectronIpcService } from '../electron-ipc.service';\r\n\r\nexport interface QuotaInfo {\r\n  allowed: boolean;\r\n  quota_type: string;\r\n  status: 'ok' | 'warning' | 'critical' | 'exceeded' | 'unlimited';\r\n  limit: number;\r\n  used: number;\r\n  reserved: number;\r\n  remaining: number;\r\n  percentage: number;\r\n  reset_at: string | null;\r\n  message: string;\r\n  upgrade_suggestion: string;\r\n  unlimited: boolean;\r\n}\r\n\r\nexport interface QuotaSummary {\r\n  user_id: string;\r\n  tier: string;\r\n  tier_name: string;\r\n  quotas: Record<string, QuotaInfo>;\r\n  alerts: Array<{\r\n    type: string;\r\n    quota_type: string;\r\n    message: string;\r\n    percentage: number;\r\n  }>;\r\n  has_warnings: boolean;\r\n  has_exceeded: boolean;\r\n}\r\n\r\nexport interface MembershipLevel {\r\n  level: string;\r\n  name: string;\r\n  name_en: string;\r\n  icon: string;\r\n  color: string;\r\n  order: number;\r\n  quotas: Record<string, number>;\r\n  prices: Record<string, number>;\r\n  features: string[];\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class QuotaService {\r\n  // ÈÖçÈ°çÊëòË¶Å\r\n  private _quotaSummary = signal<QuotaSummary | null>(null);\r\n  readonly quotaSummary = this._quotaSummary.asReadonly();\r\n  \r\n  // ÊúÉÂì°Á≠âÁ¥öÂàóË°®\r\n  private _levels = signal<MembershipLevel[]>([]);\r\n  readonly levels = this._levels.asReadonly();\r\n  \r\n  // ÈÖçÈ°çÂëäË≠¶\r\n  private _alerts = signal<Array<{ id: number; quota_type: string; message: string; acknowledged: boolean }>>([]);\r\n  readonly alerts = this._alerts.asReadonly();\r\n  \r\n  // Âä†ËºâÁãÄÊÖã\r\n  private _loading = signal(false);\r\n  readonly loading = this._loading.asReadonly();\r\n  \r\n  // Ë®àÁÆóÂ±¨ÊÄß\r\n  readonly currentTier = computed(() => this._quotaSummary()?.tier || 'bronze');\r\n  readonly currentTierName = computed(() => this._quotaSummary()?.tier_name || 'ÈùíÈäÖÊà∞Â£´');\r\n  readonly hasWarnings = computed(() => this._quotaSummary()?.has_warnings || false);\r\n  readonly hasExceeded = computed(() => this._quotaSummary()?.has_exceeded || false);\r\n  readonly unacknowledgedAlerts = computed(() => \r\n    this._alerts().filter(a => !a.acknowledged).length\r\n  );\r\n  \r\n  // ÈÖçÈ°çÈ°ØÁ§∫ÂêçÁ®±\r\n  private quotaDisplayNames: Record<string, string> = {\r\n    tg_accounts: 'TG Â∏≥Ëôü',\r\n    daily_messages: 'ÊØèÊó•Ê∂àÊÅØ',\r\n    ai_calls: 'AI Ë™øÁî®',\r\n    devices: 'Ë®≠ÂÇôÊï∏',\r\n    groups: 'Áæ§ÁµÑÊï∏',\r\n    keyword_sets: 'ÈóúÈçµË©ûÈõÜ',\r\n    auto_reply_rules: 'Ëá™ÂãïÂõûË¶Ü',\r\n    scheduled_tasks: 'ÂÆöÊôÇ‰ªªÂãô',\r\n  };\r\n\r\n  constructor(private ipc: ElectronIpcService) {}\r\n\r\n  /**\r\n   * Âä†ËºâÈÖçÈ°çÊëòË¶Å\r\n   */\r\n  async loadQuotaSummary(): Promise<void> {\r\n    this._loading.set(true);\r\n    try {\r\n      const response = await this.ipc.invoke('get-quota-status', {});\r\n      if (response?.success && response?.data) {\r\n        this._quotaSummary.set(response.data);\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load quota summary:', error);\r\n    } finally {\r\n      this._loading.set(false);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Ê™¢Êü•ÁâπÂÆöÈÖçÈ°ç\r\n   */\r\n  async checkQuota(quotaType: string, amount: number = 1): Promise<QuotaInfo | null> {\r\n    try {\r\n      const response = await this.ipc.invoke('check-quota', { quota_type: quotaType, amount });\r\n      if (response?.success && response?.data) {\r\n        return response.data;\r\n      }\r\n      return null;\r\n    } catch (error) {\r\n      console.error('Failed to check quota:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Âä†ËºâÈÖçÈ°çÂëäË≠¶\r\n   */\r\n  async loadAlerts(): Promise<void> {\r\n    try {\r\n      const response = await this.ipc.invoke('get-quota-alerts', {});\r\n      if (response?.success && response?.data?.alerts) {\r\n        this._alerts.set(response.data.alerts);\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load alerts:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Á¢∫Ë™çÂëäË≠¶\r\n   */\r\n  async acknowledgeAlert(alertId: number): Promise<boolean> {\r\n    try {\r\n      const response = await this.ipc.invoke('acknowledge-quota-alert', { alert_id: alertId });\r\n      if (response?.success) {\r\n        // Êõ¥Êñ∞Êú¨Âú∞ÁãÄÊÖã\r\n        this._alerts.update(alerts => \r\n          alerts.map(a => a.id === alertId ? { ...a, acknowledged: true } : a)\r\n        );\r\n        return true;\r\n      }\r\n      return false;\r\n    } catch (error) {\r\n      console.error('Failed to acknowledge alert:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Âä†ËºâÊúÉÂì°Á≠âÁ¥öÂàóË°®\r\n   */\r\n  async loadMembershipLevels(): Promise<void> {\r\n    try {\r\n      const response = await this.ipc.invoke('get-membership-levels', {});\r\n      if (response?.success && response?.data?.levels) {\r\n        this._levels.set(response.data.levels);\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load membership levels:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Áç≤ÂèñÈÖçÈ°ç‰ø°ÊÅØ\r\n   */\r\n  getQuotaInfo(quotaType: string): QuotaInfo | null {\r\n    const summary = this._quotaSummary();\r\n    return summary?.quotas?.[quotaType] || null;\r\n  }\r\n\r\n  /**\r\n   * Áç≤ÂèñÈÖçÈ°çÈ°ØÁ§∫ÂêçÁ®±\r\n   */\r\n  getQuotaDisplayName(quotaType: string): string {\r\n    return this.quotaDisplayNames[quotaType] || quotaType;\r\n  }\r\n\r\n  /**\r\n   * Ê†ºÂºèÂåñÈÖçÈ°çÂÄº\r\n   */\r\n  formatQuotaValue(value: number): string {\r\n    if (value === -1) return '‚àû';\r\n    if (value >= 1000000) return `${(value / 1000000).toFixed(1)}M`;\r\n    if (value >= 1000) return `${(value / 1000).toFixed(1)}K`;\r\n    return value.toString();\r\n  }\r\n\r\n  /**\r\n   * Áç≤ÂèñÁãÄÊÖãÈ°èËâ≤\r\n   */\r\n  getStatusColor(status: string): string {\r\n    const colors: Record<string, string> = {\r\n      ok: '#22c55e',\r\n      warning: '#f59e0b',\r\n      critical: '#ef4444',\r\n      exceeded: '#dc2626',\r\n      unlimited: '#8b5cf6',\r\n    };\r\n    return colors[status] || '#666';\r\n  }\r\n\r\n  /**\r\n   * Áç≤ÂèñÁãÄÊÖãÂúñÊ®ô\r\n   */\r\n  getStatusIcon(status: string): string {\r\n    const icons: Record<string, string> = {\r\n      ok: '‚úì',\r\n      warning: '‚ö†Ô∏è',\r\n      critical: '‚ö°',\r\n      exceeded: 'üö´',\r\n      unlimited: '‚àû',\r\n    };\r\n    return icons[status] || '';\r\n  }\r\n\r\n  /**\r\n   * Áç≤ÂèñÂçáÁ¥öÈÅ∏È†Ö\r\n   */\r\n  getUpgradeOptions(): MembershipLevel[] {\r\n    const currentTier = this.currentTier();\r\n    const levels = this._levels();\r\n    \r\n    const currentOrder = levels.find(l => l.level === currentTier)?.order ?? 0;\r\n    return levels.filter(l => l.order > currentOrder);\r\n  }\r\n\r\n  /**\r\n   * ÊòØÂê¶ÂèØ‰ª•Âü∑Ë°åÊìç‰ΩúÔºàÂü∫ÊñºÈÖçÈ°çÔºâ\r\n   */\r\n  canPerformAction(quotaType: string, amount: number = 1): boolean {\r\n    const info = this.getQuotaInfo(quotaType);\r\n    if (!info) return true; // ÁÑ°Ê≥ïÁç≤Âèñ‰ø°ÊÅØÊôÇÂÖÅË®±\r\n    if (info.unlimited) return true;\r\n    return info.remaining >= amount;\r\n  }\r\n\r\n  /**\r\n   * Âà∑Êñ∞ÊâÄÊúâÈÖçÈ°çÊï∏Êìö\r\n   */\r\n  async refresh(): Promise<void> {\r\n    await Promise.all([\r\n      this.loadQuotaSummary(),\r\n      this.loadAlerts(),\r\n    ]);\r\n  }\r\n\r\n  /**\r\n   * Áç≤ÂèñÈÖçÈ°ç‰ΩøÁî®Ë∂®Âã¢Êï∏Êìö\r\n   */\r\n  async loadTrendData(period: '7d' | '30d' | '90d' = '7d', types: string[] = ['daily_messages', 'ai_calls']): Promise<{\r\n    labels: string[];\r\n    datasets: { name: string; data: number[]; color: string }[];\r\n  } | null> {\r\n    try {\r\n      const response = await this.ipc.invoke('get-quota-trend', {\r\n        period,\r\n        types: types.join(',')\r\n      });\r\n      if (response?.success && response?.data) {\r\n        return response.data;\r\n      }\r\n      return null;\r\n    } catch (error) {\r\n      console.error('Failed to load trend data:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Áç≤ÂèñÈÖçÈ°ç‰ΩøÁî®Ê≠∑Âè≤\r\n   */\r\n  async loadHistory(limit: number = 50, offset: number = 0, type?: string): Promise<{\r\n    history: Array<{\r\n      date: string;\r\n      quota_type: string;\r\n      quota_name: string;\r\n      used: number;\r\n      limit: number;\r\n      percentage: number;\r\n      change: number;\r\n    }>;\r\n    has_more: boolean;\r\n  } | null> {\r\n    try {\r\n      const params: any = { limit, offset };\r\n      if (type) params.type = type;\r\n      \r\n      const response = await this.ipc.invoke('get-quota-history', params);\r\n      if (response?.success && response?.data) {\r\n        return response.data;\r\n      }\r\n      return null;\r\n    } catch (error) {\r\n      console.error('Failed to load history:', error);\r\n      return null;\r\n    }\r\n  }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;AAsDM,IAAO,eAAP,MAAO,cAAY;EAsCvB,YAAoB,KAAuB;AAAvB,SAAA,MAAA;AApCZ,SAAA,gBAAgB,OAA4B,MAAI,GAAA,YAAA,CAAA,EAAA,WAAA,gBAAA,CAAA,IAAA,CAAA,CAAA;AAC/C,SAAA,eAAe,KAAK,cAAc,WAAU;AAG7C,SAAA,UAAU,OAA0B,CAAA,GAAE,GAAA,YAAA,CAAA,EAAA,WAAA,UAAA,CAAA,IAAA,CAAA,CAAA;AACrC,SAAA,SAAS,KAAK,QAAQ,WAAU;AAGjC,SAAA,UAAU,OAA0F,CAAA,GAAE,GAAA,YAAA,CAAA,EAAA,WAAA,UAAA,CAAA,IAAA,CAAA,CAAA;AACrG,SAAA,SAAS,KAAK,QAAQ,WAAU;AAGjC,SAAA,WAAW,OAAO,OAAK,GAAA,YAAA,CAAA,EAAA,WAAA,WAAA,CAAA,IAAA,CAAA,CAAA;AACtB,SAAA,UAAU,KAAK,SAAS,WAAU;AAGlC,SAAA,cAAc,SAAS,MAAM,KAAK,cAAa,GAAI,QAAQ,UAAQ,GAAA,YAAA,CAAA,EAAA,WAAA,cAAA,CAAA,IAAA,CAAA,CAAA;AACnE,SAAA,kBAAkB,SAAS,MAAM,KAAK,cAAa,GAAI,aAAa,4BAAM,GAAA,YAAA,CAAA,EAAA,WAAA,kBAAA,CAAA,IAAA,CAAA,CAAA;AAC1E,SAAA,cAAc,SAAS,MAAM,KAAK,cAAa,GAAI,gBAAgB,OAAK,GAAA,YAAA,CAAA,EAAA,WAAA,cAAA,CAAA,IAAA,CAAA,CAAA;AACxE,SAAA,cAAc,SAAS,MAAM,KAAK,cAAa,GAAI,gBAAgB,OAAK,GAAA,YAAA,CAAA,EAAA,WAAA,cAAA,CAAA,IAAA,CAAA,CAAA;AACxE,SAAA,uBAAuB,SAAS,MACvC,KAAK,QAAO,EAAG,OAAO,OAAK,CAAC,EAAE,YAAY,EAAE,QAAM,GAAA,YAAA,CAAA,EAAA,WAAA,uBAAA,CAAA,IAAA,CAAA,CAAA;AAI5C,SAAA,oBAA4C;MAClD,aAAa;MACb,gBAAgB;MAChB,UAAU;MACV,SAAS;MACT,QAAQ;MACR,cAAc;MACd,kBAAkB;MAClB,iBAAiB;;EAG2B;;;;EAK9C,MAAM,mBAAgB;AACpB,SAAK,SAAS,IAAI,IAAI;AACtB,QAAI;AACF,YAAM,WAAW,MAAM,KAAK,IAAI,OAAO,oBAAoB,CAAA,CAAE;AAC7D,UAAI,UAAU,WAAW,UAAU,MAAM;AACvC,aAAK,cAAc,IAAI,SAAS,IAAI;MACtC;IACF,SAAS,OAAO;AACd,cAAQ,MAAM,iCAAiC,KAAK;IACtD;AACE,WAAK,SAAS,IAAI,KAAK;IACzB;EACF;;;;EAKA,MAAM,WAAW,WAAmB,SAAiB,GAAC;AACpD,QAAI;AACF,YAAM,WAAW,MAAM,KAAK,IAAI,OAAO,eAAe,EAAE,YAAY,WAAW,OAAM,CAAE;AACvF,UAAI,UAAU,WAAW,UAAU,MAAM;AACvC,eAAO,SAAS;MAClB;AACA,aAAO;IACT,SAAS,OAAO;AACd,cAAQ,MAAM,0BAA0B,KAAK;AAC7C,aAAO;IACT;EACF;;;;EAKA,MAAM,aAAU;AACd,QAAI;AACF,YAAM,WAAW,MAAM,KAAK,IAAI,OAAO,oBAAoB,CAAA,CAAE;AAC7D,UAAI,UAAU,WAAW,UAAU,MAAM,QAAQ;AAC/C,aAAK,QAAQ,IAAI,SAAS,KAAK,MAAM;MACvC;IACF,SAAS,OAAO;AACd,cAAQ,MAAM,0BAA0B,KAAK;IAC/C;EACF;;;;EAKA,MAAM,iBAAiB,SAAe;AACpC,QAAI;AACF,YAAM,WAAW,MAAM,KAAK,IAAI,OAAO,2BAA2B,EAAE,UAAU,QAAO,CAAE;AACvF,UAAI,UAAU,SAAS;AAErB,aAAK,QAAQ,OAAO,YAClB,OAAO,IAAI,OAAK,EAAE,OAAO,UAAU,iCAAK,IAAL,EAAQ,cAAc,KAAI,KAAK,CAAC,CAAC;AAEtE,eAAO;MACT;AACA,aAAO;IACT,SAAS,OAAO;AACd,cAAQ,MAAM,gCAAgC,KAAK;AACnD,aAAO;IACT;EACF;;;;EAKA,MAAM,uBAAoB;AACxB,QAAI;AACF,YAAM,WAAW,MAAM,KAAK,IAAI,OAAO,yBAAyB,CAAA,CAAE;AAClE,UAAI,UAAU,WAAW,UAAU,MAAM,QAAQ;AAC/C,aAAK,QAAQ,IAAI,SAAS,KAAK,MAAM;MACvC;IACF,SAAS,OAAO;AACd,cAAQ,MAAM,qCAAqC,KAAK;IAC1D;EACF;;;;EAKA,aAAa,WAAiB;AAC5B,UAAM,UAAU,KAAK,cAAa;AAClC,WAAO,SAAS,SAAS,SAAS,KAAK;EACzC;;;;EAKA,oBAAoB,WAAiB;AACnC,WAAO,KAAK,kBAAkB,SAAS,KAAK;EAC9C;;;;EAKA,iBAAiB,OAAa;AAC5B,QAAI,UAAU;AAAI,aAAO;AACzB,QAAI,SAAS;AAAS,aAAO,IAAI,QAAQ,KAAS,QAAQ,CAAC,CAAC;AAC5D,QAAI,SAAS;AAAM,aAAO,IAAI,QAAQ,KAAM,QAAQ,CAAC,CAAC;AACtD,WAAO,MAAM,SAAQ;EACvB;;;;EAKA,eAAe,QAAc;AAC3B,UAAM,SAAiC;MACrC,IAAI;MACJ,SAAS;MACT,UAAU;MACV,UAAU;MACV,WAAW;;AAEb,WAAO,OAAO,MAAM,KAAK;EAC3B;;;;EAKA,cAAc,QAAc;AAC1B,UAAM,QAAgC;MACpC,IAAI;MACJ,SAAS;MACT,UAAU;MACV,UAAU;MACV,WAAW;;AAEb,WAAO,MAAM,MAAM,KAAK;EAC1B;;;;EAKA,oBAAiB;AACf,UAAM,cAAc,KAAK,YAAW;AACpC,UAAM,SAAS,KAAK,QAAO;AAE3B,UAAM,eAAe,OAAO,KAAK,OAAK,EAAE,UAAU,WAAW,GAAG,SAAS;AACzE,WAAO,OAAO,OAAO,OAAK,EAAE,QAAQ,YAAY;EAClD;;;;EAKA,iBAAiB,WAAmB,SAAiB,GAAC;AACpD,UAAM,OAAO,KAAK,aAAa,SAAS;AACxC,QAAI,CAAC;AAAM,aAAO;AAClB,QAAI,KAAK;AAAW,aAAO;AAC3B,WAAO,KAAK,aAAa;EAC3B;;;;EAKA,MAAM,UAAO;AACX,UAAM,QAAQ,IAAI;MAChB,KAAK,iBAAgB;MACrB,KAAK,WAAU;KAChB;EACH;;;;EAKA,MAAM,cAAc,SAA+B,MAAM,QAAkB,CAAC,kBAAkB,UAAU,GAAC;AAIvG,QAAI;AACF,YAAM,WAAW,MAAM,KAAK,IAAI,OAAO,mBAAmB;QACxD;QACA,OAAO,MAAM,KAAK,GAAG;OACtB;AACD,UAAI,UAAU,WAAW,UAAU,MAAM;AACvC,eAAO,SAAS;MAClB;AACA,aAAO;IACT,SAAS,OAAO;AACd,cAAQ,MAAM,8BAA8B,KAAK;AACjD,aAAO;IACT;EACF;;;;EAKA,MAAM,YAAY,QAAgB,IAAI,SAAiB,GAAG,MAAa;AAYrE,QAAI;AACF,YAAM,SAAc,EAAE,OAAO,OAAM;AACnC,UAAI;AAAM,eAAO,OAAO;AAExB,YAAM,WAAW,MAAM,KAAK,IAAI,OAAO,qBAAqB,MAAM;AAClE,UAAI,UAAU,WAAW,UAAU,MAAM;AACvC,eAAO,SAAS;MAClB;AACA,aAAO;IACT,SAAS,OAAO;AACd,cAAQ,MAAM,2BAA2B,KAAK;AAC9C,aAAO;IACT;EACF;;;uCA/PW,eAAY,mBAAA,kBAAA,CAAA;IAAA;EAAA;;4EAAZ,eAAY,SAAZ,cAAY,WAAA,YAFX,OAAM,CAAA;EAAA;;;sEAEP,cAAY,CAAA;UAHxB;WAAW;MACV,YAAY;KACb;;;",
  "names": []
}
