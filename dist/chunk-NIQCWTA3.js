import{c as T}from"./chunk-WBAYANUQ.js";import{a as O}from"./chunk-ZJK56S5Y.js";import{a as j}from"./chunk-43M2OKI7.js";import{a as A}from"./chunk-3V3KVMT4.js";import{M as R,R as _,Vb as C,a as c,b as S,ga as I}from"./chunk-YLSLTE5F.js";var U={expert:{icon:"\u{1F468}\u200D\u{1F4BC}",label:"\u7522\u54C1\u5C08\u5BB6",description:"\u5C08\u696D\u7684\u7522\u54C1\u9867\u554F\uFF0C\u8A73\u7D30\u89E3\u7B54\u554F\u984C",defaultStyle:"professional",defaultPrompt:"\u4F60\u662F\u4E00\u4F4D\u8CC7\u6DF1\u7522\u54C1\u5C08\u5BB6\uFF0C\u67095\u5E74\u884C\u696D\u7D93\u9A57\u3002\u4F60\u7684\u7279\u9EDE\u662F\u5C08\u696D\u3001\u8010\u5FC3\u3001\u5584\u65BC\u7528\u6848\u4F8B\u8AAA\u660E\u554F\u984C\u3002"},satisfied_customer:{icon:"\u{1F60A}",label:"\u6EFF\u610F\u8001\u5BA2\u6236",description:"\u771F\u8AA0\u5206\u4EAB\u4F7F\u7528\u9AD4\u9A57\u7684\u8001\u5BA2\u6236",defaultStyle:"friendly",defaultPrompt:"\u4F60\u662F\u4E00\u4F4D\u4F7F\u7528\u7522\u54C1\u534A\u5E74\u7684\u6EFF\u610F\u5BA2\u6236\u3002\u4F60\u6703\u771F\u8AA0\u5206\u4EAB\u81EA\u5DF1\u7684\u4F7F\u7528\u9AD4\u9A57\uFF0C\u89E3\u7B54\u65B0\u4EBA\u7591\u616E\u3002"},support:{icon:"\u{1F469}\u200D\u{1F4BB}",label:"\u5BA2\u670D\u52A9\u7406",description:"\u71B1\u60C5\u7684\u5BA2\u670D\uFF0C\u8655\u7406\u8A02\u55AE\u552E\u5F8C",defaultStyle:"enthusiastic",defaultPrompt:"\u4F60\u662F\u4E00\u4F4D\u71B1\u60C5\u7684\u5BA2\u670D\u52A9\u7406\u3002\u4F60\u5FEB\u901F\u97FF\u61C9\u3001\u89E3\u6C7A\u554F\u984C\uFF0C\u8655\u7406\u8A02\u55AE\u548C\u552E\u5F8C\u652F\u6301\u3002"},manager:{icon:"\u{1F454}",label:"\u7D93\u7406",description:"\u6709\u6C7A\u7B56\u6B0A\u7684\u7BA1\u7406\u4EBA\u54E1",defaultStyle:"professional",defaultPrompt:"\u4F60\u662F\u7522\u54C1\u7D93\u7406\uFF0C\u6709\u4E00\u5B9A\u6C7A\u7B56\u6B0A\u3002\u4F60\u53EF\u4EE5\u7D66\u4E88\u7279\u5225\u512A\u60E0\u6216\u505A\u51FA\u627F\u8AFE\u3002"},newbie:{icon:"\u{1F64B}",label:"\u597D\u5947\u65B0\u4EBA",description:"\u5C0D\u7522\u54C1\u611F\u8208\u8DA3\u7684\u65B0\u7528\u6236",defaultStyle:"curious",defaultPrompt:"\u4F60\u662F\u4E00\u500B\u5C0D\u7522\u54C1\u611F\u8208\u8DA3\u7684\u65B0\u4EBA\uFF0C\u6703\u554F\u4E00\u4E9B\u57FA\u790E\u554F\u984C\uFF0C\u5F15\u5C0E\u5C08\u5BB6\u89E3\u7B54\u3002"},hesitant:{icon:"\u{1F914}",label:"\u7336\u8C6B\u8005",description:"\u6709\u9867\u616E\u4F46\u88AB\u8AAA\u670D\u7684\u7528\u6236",defaultStyle:"careful",defaultPrompt:"\u4F60\u4E00\u958B\u59CB\u6709\u9867\u616E\uFF0C\u4F46\u88AB\u5C08\u5BB6\u548C\u8001\u5BA2\u6236\u8AAA\u670D\u5F8C\u6C7A\u5B9A\u8CFC\u8CB7\uFF0C\u5206\u4EAB\u4F60\u88AB\u8AAA\u670D\u7684\u904E\u7A0B\u3002"},custom:{icon:"\u{1F3AD}",label:"\u81EA\u5B9A\u7FA9\u89D2\u8272",description:"\u6839\u64DA\u9700\u8981\u81EA\u5B9A\u7FA9\u7684\u89D2\u8272",defaultStyle:"friendly",defaultPrompt:""}},$={roles:[],scripts:[],autoGroupSettings:{enabled:!0,nameTemplate:"VIP\u5C08\u5C6C\u670D\u52D9\u7FA4 - {\u5BA2\u6236\u540D}",inviteMessageTemplate:"\u70BA\u4E86\u66F4\u597D\u5730\u670D\u52D9\u60A8\uFF0C\u6211\u5011\u7279\u5225\u5EFA\u7ACB\u4E86VIP\u7FA4\uFF0C\u6709\u5C08\u5BB6\u548C\u8001\u7528\u6236\u53EF\u4EE5\u89E3\u7B54\u60A8\u7684\u554F\u984C\uFF01",maxConcurrentGroups:5,autoCloseAfterDays:7},defaultTriggerConditions:{intentScoreThreshold:70,minConversationRounds:3,requirePriceInquiry:!1},aiSettings:{useAICenter:!0,coordinationMode:"sequential",maxAIResponseTime:30}};var M=[{id:"gemini",name:"Google Gemini",icon:"\u2728",description:"\u8C37\u6B4C\u6700\u65B0 AI \u6A21\u578B\uFF0C\u5FEB\u901F\u4E14\u591A\u8A9E\u8A00\u652F\u6301",requiresApiKey:!0,baseUrl:"https://generativelanguage.googleapis.com/v1beta",models:[{id:"gemini-1.5-pro",name:"Gemini 1.5 Pro",description:"\u5F37\u5927\u7684\u591A\u6A21\u614B\u6A21\u578B",contextLength:2e6,pricePerMToken:3.5,capabilities:["text","vision","code","reasoning"]},{id:"gemini-1.5-flash",name:"Gemini 1.5 Flash",description:"\u5FEB\u901F\u9AD8\u6548\u7684\u8F15\u91CF\u6A21\u578B",contextLength:1e6,pricePerMToken:.075,capabilities:["text","vision","code"]},{id:"gemini-2.0-flash-exp",name:"Gemini 2.0 Flash (\u5BE6\u9A57)",description:"\u6700\u65B0\u5BE6\u9A57\u7248\u672C",contextLength:1e6,pricePerMToken:0,capabilities:["text","vision","code","reasoning"]}]},{id:"openai",name:"OpenAI",icon:"\u{1F916}",description:"ChatGPT \u80CC\u5F8C\u7684 AI \u6A21\u578B",requiresApiKey:!0,baseUrl:"https://api.openai.com/v1",models:[{id:"gpt-4o",name:"GPT-4o",description:"\u6700\u65B0\u65D7\u8266\u6A21\u578B",contextLength:128e3,pricePerMToken:5,capabilities:["text","vision","code","reasoning"]},{id:"gpt-4o-mini",name:"GPT-4o Mini",description:"\u7D93\u6FDF\u5BE6\u60E0\u7684\u5C0F\u578B\u6A21\u578B",contextLength:128e3,pricePerMToken:.15,capabilities:["text","vision","code"]},{id:"gpt-4-turbo",name:"GPT-4 Turbo",description:"\u9AD8\u6027\u80FD\u6A21\u578B",contextLength:128e3,pricePerMToken:10,capabilities:["text","vision","code","reasoning"]},{id:"o1-preview",name:"o1 Preview",description:"\u6DF1\u5EA6\u63A8\u7406\u6A21\u578B",contextLength:128e3,pricePerMToken:15,capabilities:["text","code","reasoning","math"]}]},{id:"claude",name:"Anthropic Claude",icon:"\u{1F9E0}",description:"\u5B89\u5168\u53EF\u9760\u7684 AI \u52A9\u624B",requiresApiKey:!0,baseUrl:"https://api.anthropic.com/v1",models:[{id:"claude-3-5-sonnet-20241022",name:"Claude 3.5 Sonnet",description:"\u6700\u4F73\u7D9C\u5408\u6027\u80FD",contextLength:2e5,pricePerMToken:3,capabilities:["text","vision","code","reasoning"]},{id:"claude-3-opus-20240229",name:"Claude 3 Opus",description:"\u6700\u5F37\u63A8\u7406\u80FD\u529B",contextLength:2e5,pricePerMToken:15,capabilities:["text","vision","code","reasoning"]},{id:"claude-3-haiku-20240307",name:"Claude 3 Haiku",description:"\u5FEB\u901F\u8F15\u91CF",contextLength:2e5,pricePerMToken:.25,capabilities:["text","vision","code"]}]},{id:"deepseek",name:"DeepSeek",icon:"\u{1F50D}",description:"\u9AD8\u6027\u50F9\u6BD4\u7684\u4E2D\u570B AI \u6A21\u578B",requiresApiKey:!0,baseUrl:"https://api.deepseek.com",models:[{id:"deepseek-chat",name:"DeepSeek Chat",description:"\u901A\u7528\u5C0D\u8A71\u6A21\u578B",contextLength:64e3,pricePerMToken:.14,capabilities:["text","code"]},{id:"deepseek-coder",name:"DeepSeek Coder",description:"\u5C08\u696D\u7DE8\u7A0B\u6A21\u578B",contextLength:64e3,pricePerMToken:.14,capabilities:["code","text"]}]},{id:"ollama",name:"Ollama (\u672C\u5730)",icon:"\u{1F999}",description:"\u672C\u5730\u904B\u884C\uFF0C\u5B8C\u5168\u96B1\u79C1",requiresApiKey:!1,baseUrl:"http://localhost:11434",models:[{id:"llama3.2",name:"Llama 3.2",description:"Meta \u6700\u65B0\u958B\u6E90\u6A21\u578B",contextLength:128e3,capabilities:["text","code"]},{id:"qwen2.5",name:"Qwen 2.5",description:"\u963F\u91CC\u901A\u7FA9\u5343\u554F",contextLength:128e3,capabilities:["text","code","reasoning"]},{id:"mistral",name:"Mistral",description:"\u6B50\u6D32\u958B\u6E90\u6A21\u578B",contextLength:32e3,capabilities:["text","code"]},{id:"codellama",name:"Code Llama",description:"\u5C08\u696D\u7DE8\u7A0B\u6A21\u578B",contextLength:16e3,capabilities:["code"]}]}],w=class y{constructor(){this._config=I({provider:"gemini",model:"gemini-1.5-flash",apiKey:"",temperature:.7,maxTokens:2048,topP:.9,systemPrompt:""});this.config=this._config.asReadonly();this._isConnected=I(!1);this.isConnected=this._isConnected.asReadonly();this._usage=I({totalTokens:0,totalCalls:0,totalCost:0});this.usage=this._usage.asReadonly();this.providers=M;this.currentProvider=C(()=>M.find(e=>e.id===this._config().provider));this.currentModel=C(()=>this.currentProvider()?.models.find(e=>e.id===this._config().model));this.availableModels=C(()=>this.currentProvider()?.models||[]);this.loadConfig()}setConfig(e){this._config.update(t=>c(c({},t),e)),this.saveConfig()}setProvider(e){let t=M.find(n=>n.id===e);t&&this.setConfig({provider:e,model:t.models[0]?.id||"",baseUrl:t.baseUrl})}setModel(e){this.setConfig({model:e})}async testConnection(){try{return(await this.chat([{role:"user",content:'Hello, please respond with "OK".'}])).content?(this._isConnected.set(!0),{success:!0,message:"\u9023\u63A5\u6210\u529F\uFF01"}):{success:!1,message:"\u7121\u97FF\u61C9"}}catch(e){return this._isConnected.set(!1),{success:!1,message:e.message||"\u9023\u63A5\u5931\u6557"}}}async chat(e,t){let n=c(c({},this._config()),t);if(!n.baseUrl||n.baseUrl.startsWith("/")){let s=M.find(o=>o.id===n.provider);s?.baseUrl&&(n.baseUrl=s.baseUrl,console.log(`[AIProvider] \u4F7F\u7528\u63D0\u4F9B\u5546\u9ED8\u8A8D baseUrl: ${n.baseUrl}`))}if(!n.baseUrl)throw new Error(`\u672A\u914D\u7F6E ${n.provider} \u7684 API \u7AEF\u9EDE`);if(n.provider!=="ollama"&&!n.apiKey)throw new Error(`\u672A\u914D\u7F6E ${n.provider} \u7684 API Key`);switch(console.log(`[AIProvider] \u8ABF\u7528 ${n.provider}/${n.model}, baseUrl: ${n.baseUrl}`),n.provider){case"gemini":return this.chatGemini(e,n);case"openai":return this.chatOpenAI(e,n);case"claude":return this.chatClaude(e,n);case"deepseek":return this.chatDeepSeek(e,n);case"ollama":return this.chatOllama(e,n);default:throw new Error(`Unsupported provider: ${n.provider}`)}}async*chatStream(e,t){let n=c(c({},this._config()),t),o=(await this.chat(e,t)).content.split("");for(let i of o)yield i,await new Promise(a=>setTimeout(a,20))}async chatGemini(e,t){let n=`${t.baseUrl}/models/${t.model}:generateContent?key=${t.apiKey}`;console.log(`[AIProvider] Gemini URL: ${n.replace(t.apiKey,"***")}`);let s=e.filter(g=>g.role!=="system").map(g=>({role:g.role==="user"?"user":"model",parts:[{text:g.content}]})),o=e.find(g=>g.role==="system"),i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:s,systemInstruction:o?{parts:[{text:o.content}]}:void 0,generationConfig:{temperature:t.temperature,maxOutputTokens:t.maxTokens,topP:t.topP}})});if(!(i.headers.get("content-type")||"").includes("application/json")){let g=await i.text();throw console.error("[AIProvider] Gemini \u8FD4\u56DE\u975E JSON \u97FF\u61C9:",g.substring(0,200)),new Error(`Gemini API \u8FD4\u56DE\u932F\u8AA4\u683C\u5F0F (${i.status}): \u53EF\u80FD\u662F URL \u914D\u7F6E\u932F\u8AA4`)}if(!i.ok){let g=await i.json();throw new Error(g.error?.message||`Gemini API error: ${i.status}`)}let r=await i.json(),u=r.candidates?.[0]?.content?.parts?.[0]?.text||"";return this.updateUsage(r.usageMetadata?.promptTokenCount||0,r.usageMetadata?.candidatesTokenCount||0,t),{content:u,usage:{promptTokens:r.usageMetadata?.promptTokenCount||0,completionTokens:r.usageMetadata?.candidatesTokenCount||0,totalTokens:r.usageMetadata?.totalTokenCount||0},model:t.model,finishReason:r.candidates?.[0]?.finishReason||"stop"}}async chatOpenAI(e,t){let n=`${t.baseUrl}/chat/completions`;console.log(`[AIProvider] OpenAI URL: ${n}`);let s=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify({model:t.model,messages:e,temperature:t.temperature,max_tokens:t.maxTokens,top_p:t.topP})});if(!(s.headers.get("content-type")||"").includes("application/json")){let r=await s.text();throw console.error("[AIProvider] OpenAI \u8FD4\u56DE\u975E JSON \u97FF\u61C9:",r.substring(0,200)),new Error(`OpenAI API \u8FD4\u56DE\u932F\u8AA4\u683C\u5F0F (${s.status}): \u53EF\u80FD\u662F URL \u914D\u7F6E\u932F\u8AA4`)}if(!s.ok){let r=await s.json();throw new Error(r.error?.message||`OpenAI API error: ${s.status}`)}let i=await s.json(),a=i.choices?.[0]?.message?.content||"";return this.updateUsage(i.usage?.prompt_tokens||0,i.usage?.completion_tokens||0,t),{content:a,usage:{promptTokens:i.usage?.prompt_tokens||0,completionTokens:i.usage?.completion_tokens||0,totalTokens:i.usage?.total_tokens||0},model:t.model,finishReason:i.choices?.[0]?.finish_reason||"stop"}}async chatClaude(e,t){let n=`${t.baseUrl}/messages`;console.log(`[AIProvider] Claude URL: ${n}`);let s=e.find(g=>g.role==="system"),o=e.filter(g=>g.role!=="system"),i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":t.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:t.model,max_tokens:t.maxTokens,system:s?.content,messages:o.map(g=>({role:g.role,content:g.content}))})});if(!(i.headers.get("content-type")||"").includes("application/json")){let g=await i.text();throw console.error("[AIProvider] Claude \u8FD4\u56DE\u975E JSON \u97FF\u61C9:",g.substring(0,200)),new Error(`Claude API \u8FD4\u56DE\u932F\u8AA4\u683C\u5F0F (${i.status}): \u53EF\u80FD\u662F URL \u914D\u7F6E\u932F\u8AA4`)}if(!i.ok){let g=await i.json();throw new Error(g.error?.message||`Claude API error: ${i.status}`)}let r=await i.json(),u=r.content?.[0]?.text||"";return this.updateUsage(r.usage?.input_tokens||0,r.usage?.output_tokens||0,t),{content:u,usage:{promptTokens:r.usage?.input_tokens||0,completionTokens:r.usage?.output_tokens||0,totalTokens:(r.usage?.input_tokens||0)+(r.usage?.output_tokens||0)},model:t.model,finishReason:r.stop_reason||"stop"}}async chatDeepSeek(e,t){let n=`${t.baseUrl}/chat/completions`;console.log(`[AIProvider] DeepSeek URL: ${n}`);let s=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify({model:t.model,messages:e,temperature:t.temperature,max_tokens:t.maxTokens,top_p:t.topP})});if(!(s.headers.get("content-type")||"").includes("application/json")){let r=await s.text();throw console.error("[AIProvider] DeepSeek \u8FD4\u56DE\u975E JSON \u97FF\u61C9:",r.substring(0,200)),new Error(`DeepSeek API \u8FD4\u56DE\u932F\u8AA4\u683C\u5F0F (${s.status}): \u53EF\u80FD\u662F URL \u914D\u7F6E\u932F\u8AA4`)}if(!s.ok){let r=await s.json();throw new Error(r.error?.message||`DeepSeek API error: ${s.status}`)}let i=await s.json(),a=i.choices?.[0]?.message?.content||"";return this.updateUsage(i.usage?.prompt_tokens||0,i.usage?.completion_tokens||0,t),{content:a,usage:{promptTokens:i.usage?.prompt_tokens||0,completionTokens:i.usage?.completion_tokens||0,totalTokens:i.usage?.total_tokens||0},model:t.model,finishReason:i.choices?.[0]?.finish_reason||"stop"}}async chatOllama(e,t){let n=`${t.baseUrl||"http://localhost:11434"}/api/chat`,s=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t.model,messages:e,options:{temperature:t.temperature,num_predict:t.maxTokens,top_p:t.topP},stream:!1})});if(!s.ok)throw new Error("Ollama connection failed. Make sure Ollama is running.");let o=await s.json();return{content:o.message?.content||"",usage:{promptTokens:o.prompt_eval_count||0,completionTokens:o.eval_count||0,totalTokens:(o.prompt_eval_count||0)+(o.eval_count||0)},model:t.model,finishReason:"stop"}}updateUsage(e,t,n){let s=this.currentModel(),o=s?.pricePerMToken?(e+t)/1e6*s.pricePerMToken:0;this._usage.update(i=>({totalTokens:i.totalTokens+e+t,totalCalls:i.totalCalls+1,totalCost:i.totalCost+o}))}loadConfig(){try{let e=localStorage.getItem("tg-matrix-ai-config");e&&this._config.set(JSON.parse(e));let t=localStorage.getItem("tg-matrix-ai-usage");t&&this._usage.set(JSON.parse(t))}catch(e){console.error("Failed to load AI config:",e)}}saveConfig(){try{localStorage.setItem("tg-matrix-ai-config",JSON.stringify(this._config())),localStorage.setItem("tg-matrix-ai-usage",JSON.stringify(this._usage()))}catch(e){console.error("Failed to save AI config:",e)}}resetUsage(){this._usage.set({totalTokens:0,totalCalls:0,totalCost:0}),this.saveConfig()}estimateTokens(e){let t=(e.match(/[\u4e00-\u9fff]/g)||[]).length,n=e.length-t;return Math.ceil(t/1.5+n/4)}static{this.\u0275fac=function(t){return new(t||y)}}static{this.\u0275prov=R({token:y,factory:y.\u0275fac,providedIn:"root"})}};var H=`\u4F60\u662F\u4E00\u500B\u5C08\u696D\u7684\u92B7\u552E\u610F\u5716\u5206\u6790\u5C08\u5BB6\u3002\u5206\u6790\u7528\u6236\u6D88\u606F\u4E26\u8B58\u5225\u5176\u610F\u5716\u3002

\u8ACB\u6309\u4EE5\u4E0B JSON \u683C\u5F0F\u56DE\u8986\uFF08\u4E0D\u8981\u5305\u542B\u4EFB\u4F55\u5176\u4ED6\u6587\u5B57\uFF09\uFF1A
{
  "intent": "\u610F\u5716\u985E\u578B",
  "confidence": 0.0-1.0,
  "subIntents": ["\u5B50\u610F\u57161", "\u5B50\u610F\u57162"],
  "keywords": ["\u95DC\u9375\u8A5E1", "\u95DC\u9375\u8A5E2"],
  "sentiment": "positive/neutral/negative",
  "urgency": "low/medium/high",
  "suggestedAction": "\u5EFA\u8B70\u7684\u4E0B\u4E00\u6B65\u52D5\u4F5C"
}

\u610F\u5716\u985E\u578B\u5FC5\u9808\u662F\u4EE5\u4E0B\u4E4B\u4E00\uFF1A
- purchase_intent: \u6709\u8CFC\u8CB7\u610F\u5411\uFF08\u8A62\u554F\u5982\u4F55\u8CFC\u8CB7\u3001\u4E0B\u55AE\u3001\u4ED8\u6B3E\u7B49\uFF09
- price_inquiry: \u8A62\u554F\u50F9\u683C\uFF08\u591A\u5C11\u9322\u3001\u8CBB\u7528\u3001\u512A\u60E0\u7B49\uFF09
- product_question: \u7522\u54C1\u554F\u984C\uFF08\u529F\u80FD\u3001\u7279\u6027\u3001\u4F7F\u7528\u65B9\u6CD5\u7B49\uFF09
- complaint: \u62B1\u6028\u6216\u4E0D\u6EFF
- general_chat: \u4E00\u822C\u804A\u5929
- negative_sentiment: \u8CA0\u9762\u60C5\u7DD2
- high_value: \u9AD8\u50F9\u503C\u5BA2\u6236\u4FE1\u865F
- urgent: \u7DCA\u6025\u9700\u6C42`,k=class y{constructor(){this.aiProvider=_(w);this.conversations=I(new Map);this.cache=new Map;this.CACHE_TTL=6e4}async recognizeIntent(e,t,n=!0){let s=this.getCacheKey(e,t),o=this.cache.get(s);if(o&&Date.now()-o.timestamp<this.CACHE_TTL)return o.result;let i=[{role:"system",content:H}];if(t&&n){let a=this.getContext(t);if(a&&a.messages.length>0){let r=a.messages.slice(-5);i.push({role:"user",content:`\u5C0D\u8A71\u6B77\u53F2\uFF1A
${r.map(u=>`[${u.role}]: ${u.content}`).join(`
`)}

\u8ACB\u5206\u6790\u6700\u65B0\u6D88\u606F\u7684\u610F\u5716\u3002`})}}i.push({role:"user",content:`\u7528\u6236\u6D88\u606F\uFF1A${e}`});try{let a=await this.aiProvider.chat(i,{temperature:.3,maxTokens:500}),r=this.parseIntentResponse(a.content,e);return this.cache.set(s,{result:r,timestamp:Date.now()}),t&&this.updateContext(t,e,"user",r),r}catch(a){return console.error("Intent recognition failed:",a),this.fallbackRecognition(e)}}parseIntentResponse(e,t){try{let n=e.match(/\{[\s\S]*\}/);if(n){let s=JSON.parse(n[0]);return{intent:this.validateIntent(s.intent),confidence:Math.min(1,Math.max(0,s.confidence||.5)),subIntents:s.subIntents||[],keywords:s.keywords||[],sentiment:s.sentiment||"neutral",urgency:s.urgency||"medium",suggestedAction:s.suggestedAction||"",rawAnalysis:e}}}catch(n){console.warn("Failed to parse intent response:",n)}return this.fallbackRecognition(t)}validateIntent(e){return["purchase_intent","price_inquiry","product_question","complaint","general_chat","negative_sentiment","high_value","urgent"].includes(e)?e:"general_chat"}fallbackRecognition(e){let t=e.toLowerCase(),n="general_chat",s=.5,o="neutral",i="medium",a=[],r=["\u8CFC\u8CB7","\u4E0B\u55AE","\u8CB7","\u600E\u9EBC\u8CB7","\u4ED8\u6B3E","\u8A02\u8CFC","buy","purchase","order"];r.some(h=>t.includes(h))&&(n="purchase_intent",s=.85,i="high",a.push(...r.filter(h=>t.includes(h))));let u=["\u50F9\u683C","\u591A\u5C11\u9322","\u8CBB\u7528","\u50F9\u9322","\u512A\u60E0","\u6298\u6263","price","cost","discount"];u.some(h=>t.includes(h))&&(n="price_inquiry",s=.8,a.push(...u.filter(h=>t.includes(h))));let g=["\u600E\u9EBC","\u5982\u4F55","\u4EC0\u9EBC","\u80FD\u4E0D\u80FD","\u53EF\u4EE5","\u529F\u80FD","how","what","can"];g.some(h=>t.includes(h))&&(n==="general_chat"&&(n="product_question",s=.7),a.push(...g.filter(h=>t.includes(h))));let f=["\u4E0D\u597D","\u5DEE","\u721B","\u9A19","\u5783\u573E","\u9000\u6B3E","bad","terrible","refund"];return f.some(h=>t.includes(h))&&(o="negative",f.filter(h=>t.includes(h)).length>=2&&(n="negative_sentiment",s=.8)),["\u597D","\u68D2","\u8B9A","\u8B1D\u8B1D","\u611F\u8B1D","great","thanks","good"].some(h=>t.includes(h))&&(o="positive"),["\u6025","\u99AC\u4E0A","\u7ACB\u523B","\u73FE\u5728","urgent","immediately","now","asap"].some(h=>t.includes(h))&&(i="high",n==="general_chat"&&(n="urgent",s=.75)),{intent:n,confidence:s,subIntents:[],keywords:a,sentiment:o,urgency:i,suggestedAction:this.getSuggestedAction(n)}}getSuggestedAction(e){return{purchase_intent:"\u63D0\u4F9B\u8CFC\u8CB7\u93C8\u63A5\u6216\u806F\u7E6B\u65B9\u5F0F\uFF0C\u6E96\u5099\u4FC3\u6210\u4EA4\u6613",price_inquiry:"\u63D0\u4F9B\u50F9\u683C\u4FE1\u606F\u548C\u512A\u60E0\u65B9\u6848",product_question:"\u8A73\u7D30\u89E3\u7B54\u7522\u54C1\u76F8\u95DC\u554F\u984C",complaint:"\u8868\u9054\u6B49\u610F\uFF0C\u4E86\u89E3\u5177\u9AD4\u554F\u984C\uFF0C\u63D0\u4F9B\u89E3\u6C7A\u65B9\u6848",general_chat:"\u53CB\u597D\u56DE\u61C9\uFF0C\u5617\u8A66\u5F15\u5C0E\u5230\u7522\u54C1\u8A71\u984C",negative_sentiment:"\u8F49\u4EBA\u5DE5\u8655\u7406\uFF0C\u907F\u514D\u81EA\u52D5\u56DE\u8986",high_value:"\u91CD\u9EDE\u8DDF\u9032\uFF0C\u63D0\u4F9BVIP\u670D\u52D9",urgent:"\u512A\u5148\u8655\u7406\uFF0C\u5FEB\u901F\u56DE\u61C9"}[e]||"\u7E7C\u7E8C\u5C0D\u8A71"}getCacheKey(e,t){return`${t||"anonymous"}_${e.substring(0,100)}`}getContext(e){return this.conversations().get(e)}createContext(e){let t={id:`conv_${Date.now()}`,userId:e,messages:[],currentStage:"initial",intentHistory:[],totalScore:0,createdAt:new Date,updatedAt:new Date};return this.conversations.update(n=>{let s=new Map(n);return s.set(e,t),s}),t}updateContext(e,t,n,s){let o=this.conversations().get(e);o||(o=this.createContext(e));let i={role:n,content:t,timestamp:new Date,intent:s};s&&n==="user"&&(o.intentHistory.push(s.intent),o.totalScore+=this.getIntentScore(s),o.currentStage=this.determineStage(o)),o.messages.push(i),o.updatedAt=new Date,this.conversations.update(a=>{let r=new Map(a);return r.set(e,c({},o)),r})}getIntentScore(e){let n={purchase_intent:30,price_inquiry:20,product_question:10,high_value:25,urgent:15,general_chat:5,complaint:-10,negative_sentiment:-20}[e.intent]||0;return Math.round(n*e.confidence)}determineStage(e){let{totalScore:t,intentHistory:n}=e;return n.includes("purchase_intent")?"closing":n.includes("price_inquiry")?"negotiating":t>=30||n.includes("high_value")?"interested":e.messages.length>2?"exploring":"initial"}clearContext(e){this.conversations.update(t=>{let n=new Map(t);return n.delete(e),n})}getIntentScore4User(e){return this.conversations().get(e)?.totalScore||0}shouldHandoffToHuman(e){let t=this.conversations().get(e);return t?!!(t.currentStage==="closing"||t.intentHistory.includes("negative_sentiment")||t.intentHistory.includes("complaint")||t.totalScore>=50):!1}static{this.\u0275fac=function(t){return new(t||y)}}static{this.\u0275prov=R({token:y,factory:y.\u0275fac,providedIn:"root"})}};var G=y=>{let e="";return y.rolePrompt?e+=y.rolePrompt+`

`:e+=`\u4F60\u662F\u4E00\u4F4D\u5C08\u696D\u7684\u92B7\u552E\u9867\u554F\uFF0C\u540D\u53EB${y.roleName||"\u5C0F\u52A9\u624B"}\u3002`,e+={professional:"\u4FDD\u6301\u5C08\u696D\u3001\u6B63\u5F0F\u7684\u8A9E\u8ABF\uFF0C\u4F7F\u7528\u884C\u696D\u8853\u8A9E\uFF0C\u6CE8\u91CD\u908F\u8F2F\u548C\u6578\u64DA\u3002",friendly:"\u4FDD\u6301\u53CB\u597D\u3001\u89AA\u5207\u7684\u8A9E\u8ABF\uFF0C\u50CF\u670B\u53CB\u4E00\u6A23\u4EA4\u6D41\uFF0C\u8B93\u5BA2\u6236\u611F\u5230\u8212\u9069\u3002",casual:"\u4F7F\u7528\u8F15\u9B06\u3001\u96A8\u610F\u7684\u8A9E\u8ABF\uFF0C\u53EF\u4EE5\u958B\u9069\u7576\u7684\u73A9\u7B11\uFF0C\u71DF\u9020\u8F15\u9B06\u6C1B\u570D\u3002",enthusiastic:"\u4FDD\u6301\u71B1\u60C5\u3001\u7A4D\u6975\u7684\u8A9E\u8ABF\uFF0C\u8868\u73FE\u51FA\u5C0D\u7522\u54C1\u548C\u5BA2\u6236\u7684\u71B1\u611B\u3002",direct:"\u76F4\u63A5\u3001\u7C21\u6F54\u5730\u56DE\u7B54\u554F\u984C\uFF0C\u4E0D\u7E5E\u5F4E\u5B50\uFF0C\u9AD8\u6548\u6E9D\u901A\u3002"}[y.style]+`

`,e+={short:"\u56DE\u8986\u8981\u7C21\u77ED\u7CBE\u7149\uFF0C\u901A\u5E381-2\u53E5\u8A71\u3002",medium:"\u56DE\u8986\u9069\u4E2D\uFF0C\u901A\u5E383-5\u53E5\u8A71\uFF0C\u5305\u542B\u5FC5\u8981\u7684\u4FE1\u606F\u3002",long:"\u53EF\u4EE5\u8A73\u7D30\u56DE\u8986\uFF0C\u5305\u542B\u5145\u5206\u7684\u89E3\u91CB\u548C\u4F8B\u5B50\u3002"}[y.responseLength]+`

`,y.emojiFrequency!=="none"?e+={low:"\u53EF\u4EE5\u5076\u723E\u4F7F\u7528\u8868\u60C5\u7B26\u865F\uFF0C\u4F46\u8981\u7BC0\u5236\u3002",medium:"\u9069\u7576\u4F7F\u7528\u8868\u60C5\u7B26\u865F\u4F86\u589E\u52A0\u89AA\u548C\u529B\u3002",high:"\u5927\u91CF\u4F7F\u7528\u8868\u60C5\u7B26\u865F\uFF0C\u8B93\u5C0D\u8A71\u66F4\u6D3B\u6F51\u3002"}[y.emojiFrequency]+`

`:e+=`\u4E0D\u8981\u4F7F\u7528\u4EFB\u4F55\u8868\u60C5\u7B26\u865F\u3002

`,y.businessContext&&(e+=`\u696D\u52D9\u80CC\u666F\uFF1A
${y.businessContext}

`),e+=`\u91CD\u8981\u898F\u5247\uFF1A
1. \u6C38\u9060\u4E0D\u8981\u8AAA\u81EA\u5DF1\u662F AI \u6216\u6A5F\u5668\u4EBA
2. \u4E0D\u8981\u4F7F\u7528 markdown \u683C\u5F0F
3. \u76F4\u63A5\u56DE\u8986\uFF0C\u4E0D\u8981\u52A0\u4EFB\u4F55\u524D\u7DB4\u5982"\u56DE\u8986\uFF1A"
4. \u5982\u679C\u4E0D\u78BA\u5B9A\uFF0C\u53EF\u4EE5\u8AAA"\u8B93\u6211\u78BA\u8A8D\u4E00\u4E0B"\u800C\u4E0D\u662F\u7DE8\u9020\u4FE1\u606F
5. \u4FDD\u6301\u5C0D\u8A71\u81EA\u7136\u6D41\u66A2`,e},E=class y{constructor(){this.aiProvider=_(w);this.intentService=_(k);this.aiCenter=_(T);this.stats=I({totalConversations:0,totalReplies:0,avgResponseTime:0,handoffCount:0,conversionCount:0});this.conversationStats=this.stats.asReadonly()}async generateReply(e,t){let n=Date.now(),s=await this.intentService.recognizeIntent(e,t.userId,!0),o=await this.checkSmartRules(s,t.userId),i=this.checkHandoff(s,o,t.userId),a=this.aiCenter.strategy(),r="",u=!1;if(t.useKnowledgeBase!==!1){let p=this.aiCenter.activeKnowledgeBase();p&&(r=this.buildKnowledgeContext(p,e,s),u=r.length>0)}let f=[{role:"system",content:G({style:t.styleOverride||a.style,roleName:t.roleName,rolePrompt:t.rolePrompt,businessContext:r,emojiFrequency:a.emojiFrequency,responseLength:a.responseLength})}],l=this.intentService.getContext(t.userId);if(l&&l.messages.length>0){let p=l.messages.slice(-6);for(let x of p)f.push({role:x.role==="user"?"user":"assistant",content:x.content})}f.push({role:"user",content:e});let v="",h=0,d="";try{let p=await this.aiProvider.chat(f,{temperature:t.temperature??a.style==="casual"?.8:.7,maxTokens:t.maxTokens??(a.responseLength==="long"?500:200)});v=p.content,h=p.usage.totalTokens,d=p.model}catch(p){console.error("Failed to generate reply:",p),v=this.getFallbackReply(s)}v=this.postProcessReply(v,s,t),this.intentService.updateContext(t.userId,v,"assistant");let m=this.calculateDelay(v,s),b=Date.now()-n;return this.updateStats(b,i.shouldHandoff),{content:v,intent:s,shouldHandoff:i.shouldHandoff,handoffReason:i.reason,triggeredRules:o,suggestedFollowUp:this.getSuggestedFollowUp(s),delay:m,metadata:{modelUsed:d,tokensUsed:h,processingTime:b,knowledgeUsed:u}}}async generateMultiRoleReply(e,t,n){return this.generateReply(e,S(c({},n),{roleName:t.roleName,rolePrompt:t.rolePrompt}))}async checkSmartRules(e,t){let n=this.aiCenter.activeRules(),s=[],i=this.intentService.getContext(t)?.messages.filter(a=>a.role==="user").length||0;for(let a of n)a.triggerIntent===e.intent&&(a.triggerConditions.intentScore&&e.confidence<a.triggerConditions.intentScore||a.triggerConditions.conversationRounds&&i<a.triggerConditions.conversationRounds||a.triggerConditions.keywordMatch&&!a.triggerConditions.keywordMatch.some(u=>e.keywords.includes(u))||s.push(a));return s.sort((a,r)=>r.priority-a.priority)}checkHandoff(e,t,n){let s=t.find(o=>o.actions.notifyHuman);return s?{shouldHandoff:!0,reason:`\u898F\u5247\u89F8\u767C\uFF1A${s.name}`}:e.intent==="purchase_intent"&&e.confidence>.8?{shouldHandoff:!0,reason:"\u9AD8\u8CFC\u8CB7\u610F\u5411\uFF0C\u5EFA\u8B70\u4EBA\u5DE5\u8DDF\u9032"}:e.intent==="negative_sentiment"||e.sentiment==="negative"?{shouldHandoff:!0,reason:"\u8CA0\u9762\u60C5\u7DD2\uFF0C\u9700\u8981\u4EBA\u5DE5\u8655\u7406"}:this.intentService.shouldHandoffToHuman(n)?{shouldHandoff:!0,reason:"\u5C0D\u8A71\u5206\u6790\u5EFA\u8B70\u8F49\u4EBA\u5DE5"}:{shouldHandoff:!1}}buildKnowledgeContext(e,t,n){if(!e||!e.items||e.items.length===0)return"";let s=e.items.filter(o=>o.isActive?n.intent==="price_inquiry"&&o.category==="sales"||n.intent==="product_question"&&o.category==="product"||n.intent==="complaint"&&o.category==="objection"?!0:o.keywords&&o.keywords.length>0?o.keywords.some(i=>t.toLowerCase().includes(i.toLowerCase())):!1:!1).slice(0,3);return s.length===0?"":`\u76F8\u95DC\u7522\u54C1\u77E5\u8B58\uFF1A
`+s.map(o=>`- ${o.title}\uFF1A${o.content}`).join(`
`)}postProcessReply(e,t,n){let s=e.trim();return s=s.replace(/^(回覆[：:]\s*|Reply[：:]\s*)/i,""),s=s.replace(/\*\*/g,""),s=s.replace(/\*/g,""),s=s.replace(/`/g,""),s=s.replace(/#{1,6}\s/g,""),n.userName&&Math.random()<.3&&!s.includes(n.userName)&&(s=`${n.userName}\uFF0C${s}`),s}getFallbackReply(e){let t={purchase_intent:["\u611F\u8B1D\u60A8\u7684\u8208\u8DA3\uFF01\u8ACB\u554F\u60A8\u60F3\u4E86\u89E3\u54EA\u500B\u65B9\u6848\u5462\uFF1F","\u592A\u597D\u4E86\uFF01\u6211\u53EF\u4EE5\u70BA\u60A8\u8A73\u7D30\u4ECB\u7D39\u8CFC\u8CB7\u6D41\u7A0B\u3002"],price_inquiry:["\u95DC\u65BC\u50F9\u683C\uFF0C\u6211\u5011\u6709\u591A\u7A2E\u65B9\u6848\u53EF\u4EE5\u9078\u64C7\uFF0C\u65B9\u4FBF\u544A\u8A34\u6211\u60A8\u7684\u9700\u6C42\u55CE\uFF1F","\u50F9\u683C\u65B9\u9762\uFF0C\u6211\u53EF\u4EE5\u6839\u64DA\u60A8\u7684\u9700\u6C42\u7D66\u51FA\u6700\u9069\u5408\u7684\u65B9\u6848\u3002"],product_question:["\u9019\u662F\u500B\u597D\u554F\u984C\uFF01\u8B93\u6211\u70BA\u60A8\u8A73\u7D30\u8AAA\u660E\u3002","\u611F\u8B1D\u60A8\u7684\u8A62\u554F\uFF0C\u6211\u4F86\u70BA\u60A8\u89E3\u7B54\u3002"],complaint:["\u975E\u5E38\u62B1\u6B49\u7D66\u60A8\u5E36\u4F86\u4E0D\u4FBF\uFF0C\u8B93\u6211\u4E86\u89E3\u4E00\u4E0B\u5177\u9AD4\u60C5\u6CC1\u3002","\u6211\u7406\u89E3\u60A8\u7684\u5FC3\u60C5\uFF0C\u8ACB\u544A\u8A34\u6211\u5177\u9AD4\u554F\u984C\uFF0C\u6211\u6703\u76E1\u529B\u5E6B\u60A8\u89E3\u6C7A\u3002"],general_chat:["\u611F\u8B1D\u60A8\u7684\u8A0A\u606F\uFF01\u6709\u4EC0\u9EBC\u6211\u53EF\u4EE5\u5E6B\u60A8\u7684\u55CE\uFF1F","\u60A8\u597D\uFF01\u8ACB\u554F\u6709\u4EC0\u9EBC\u554F\u984C\u60F3\u4E86\u89E3\u55CE\uFF1F"],negative_sentiment:["\u6211\u7406\u89E3\u60A8\u7684\u5FC3\u60C5\u3002\u8ACB\u554F\u5177\u9AD4\u662F\u4EC0\u9EBC\u554F\u984C\u5462\uFF1F","\u611F\u8B1D\u60A8\u7684\u53CD\u994B\uFF0C\u6211\u5011\u6703\u8A8D\u771F\u5C0D\u5F85\u3002"],high_value:["\u611F\u8B1D\u60A8\u7684\u4FE1\u4EFB\uFF01\u6211\u6703\u70BA\u60A8\u63D0\u4F9B\u6700\u597D\u7684\u670D\u52D9\u3002","\u975E\u5E38\u9AD8\u8208\u70BA\u60A8\u670D\u52D9\uFF01"],urgent:["\u6536\u5230\uFF0C\u6211\u99AC\u4E0A\u70BA\u60A8\u8655\u7406\uFF01","\u597D\u7684\uFF0C\u6211\u7ACB\u523B\u5E6B\u60A8\u89E3\u6C7A\uFF01"]},n=t[e.intent]||t.general_chat;return n[Math.floor(Math.random()*n.length)]}getSuggestedFollowUp(e){return{price_inquiry:"\u53EF\u4EE5\u554F\u5BA2\u6236\u7684\u5177\u9AD4\u9700\u6C42\u548C\u9810\u7B97",product_question:"\u53EF\u4EE5\u554F\u5BA2\u6236\u662F\u5426\u9084\u6709\u5176\u4ED6\u554F\u984C",purchase_intent:"\u53EF\u4EE5\u63D0\u4F9B\u4ED8\u6B3E\u65B9\u5F0F\u548C\u512A\u60E0\u4FE1\u606F"}[e.intent]}calculateDelay(e,t){let n=30+Math.random()*30,o=e.length*.1;return t.urgency==="high"&&(n=10+Math.random()*10),Math.round(n+o)}updateStats(e,t){this.stats.update(n=>({totalConversations:n.totalConversations,totalReplies:n.totalReplies+1,avgResponseTime:(n.avgResponseTime*n.totalReplies+e)/(n.totalReplies+1),handoffCount:n.handoffCount+(t?1:0),conversionCount:n.conversionCount}))}startConversation(e){this.intentService.createContext(e),this.stats.update(t=>S(c({},t),{totalConversations:t.totalConversations+1}))}endConversation(e,t=!1){this.intentService.clearContext(e),t&&this.stats.update(n=>S(c({},n),{conversionCount:n.conversionCount+1}))}getConversation(e){return this.intentService.getContext(e)}getUserIntentScore(e){return this.intentService.getIntentScore4User(e)}static{this.\u0275fac=function(t){return new(t||y)}}static{this.\u0275prov=R({token:y,factory:y.\u0275fac,providedIn:"root"})}};var D=class y{constructor(){this.aiCenter=_(T);this.conversationEngine=_(E);this.ipc=_(A);this.config=I($);this.activeGroups=I([]);this.roles=C(()=>this.config().roles);this.scripts=C(()=>this.config().scripts);this.activeGroupCount=C(()=>this.activeGroups().filter(e=>e.status==="running").length);this.availableRoles=C(()=>this.config().roles.filter(e=>e.isActive&&e.boundAccountId));this.roleTypeMeta=U}addRole(e){let t=`role_${Date.now()}`,n=e.type||"custom",s=U[n],o={id:t,name:e.name||s.label,type:n,boundAccountId:e.boundAccountId,boundAccountPhone:e.boundAccountPhone,personality:{description:e.personality?.description||s.description,speakingStyle:e.personality?.speakingStyle||s.defaultStyle,traits:e.personality?.traits||[],background:e.personality?.background},aiConfig:c({useGlobalAI:!0,customPrompt:s.defaultPrompt,responseLength:"medium",emojiFrequency:"low",typingSpeed:"medium"},e.aiConfig),responsibilities:e.responsibilities||[],isActive:!0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return this.config.update(i=>S(c({},i),{roles:[...i.roles,o]})),this.ipc.send("multi-role-add-role",o),t}updateRole(e,t){this.config.update(n=>S(c({},n),{roles:n.roles.map(s=>s.id===e?S(c(c({},s),t),{updatedAt:new Date().toISOString()}):s)})),this.ipc.send("multi-role-update-role",c({id:e},t))}deleteRole(e){this.config.update(t=>S(c({},t),{roles:t.roles.filter(n=>n.id!==e)})),this.ipc.send("multi-role-delete-role",{id:e})}bindAccountToRole(e,t,n){this.updateRole(e,{boundAccountId:t,boundAccountPhone:n})}unbindAccountFromRole(e){this.updateRole(e,{boundAccountId:void 0,boundAccountPhone:void 0})}addScript(e){let t=`script_${Date.now()}`,n={id:t,name:e.name||"\u65B0\u5287\u672C",description:e.description||"",scenario:e.scenario||"custom",requiredRoles:e.requiredRoles||["expert","satisfied_customer"],minRoleCount:e.minRoleCount||2,stages:e.stages||[],stats:{useCount:0,successCount:0,avgDuration:0,conversionRate:0},isActive:!0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return this.config.update(s=>S(c({},s),{scripts:[...s.scripts,n]})),this.ipc.send("multi-role-add-script",n),t}updateScript(e,t){this.config.update(n=>S(c({},n),{scripts:n.scripts.map(s=>s.id===e?S(c(c({},s),t),{updatedAt:new Date().toISOString()}):s)})),this.ipc.send("multi-role-update-script",c({id:e},t))}deleteScript(e){this.config.update(t=>S(c({},t),{scripts:t.scripts.filter(n=>n.id!==e)})),this.ipc.send("multi-role-delete-script",{id:e})}addStageToScript(e,t){this.config.update(n=>S(c({},n),{scripts:n.scripts.map(s=>s.id!==e?s:S(c({},s),{stages:[...s.stages,t],updatedAt:new Date().toISOString()}))}))}async createCollaborationGroup(e){let t=this.config().scripts.find(r=>r.id===e.scriptId);if(!t)return null;let n=this.config().roles.filter(r=>e.roleIds.includes(r.id));if(n.length<t.minRoleCount||this.activeGroups().filter(r=>r.status==="creating"||r.status==="inviting"||r.status==="running").length>=this.config().autoGroupSettings.maxConcurrentGroups)return null;let i=this.config().autoGroupSettings.nameTemplate.replace("{\u5BA2\u6236\u540D}",e.targetCustomer.firstName||e.targetCustomer.username||"VIP\u5BA2\u6236"),a={id:`collab_${Date.now()}`,groupTitle:i,targetCustomer:e.targetCustomer,participants:n.map(r=>({roleId:r.id,roleName:r.name,accountId:r.boundAccountId,accountPhone:r.boundAccountPhone})),scriptId:e.scriptId,scriptName:t.name,status:"creating",messagesSent:0,customerMessages:0,createdAt:new Date().toISOString()};return this.activeGroups.update(r=>[...r,a]),a}updateGroupStatus(e,t){this.activeGroups.update(n=>n.map(s=>s.id===e?S(c({},s),{status:t}):s))}completeGroup(e,t){this.activeGroups.update(n=>n.map(s=>s.id===e?S(c({},s),{status:"completed",outcome:t,completedAt:new Date().toISOString()}):s))}async startScriptExecution(e){let t=this.activeGroups().find(s=>s.id===e);if(!t||t.status!=="running")return!1;let n=this.config().scripts.find(s=>s.id===t.scriptId);return!n||n.stages.length===0?!1:(this.activeGroups.update(s=>s.map(o=>o.id===e?S(c({},o),{currentStageId:n.stages[0].id,currentStageOrder:0}):o)),!0)}async executeStage(e,t){let n=this.config().roles;for(let s of t.messages){let o=n.find(r=>r.id===s.roleId);if(!o)continue;let i=s.timing.delayAfterPrevious;if(s.timing.randomDelay){let{min:r,max:u}=s.timing.randomDelay;i+=Math.floor(Math.random()*(u-r+1))+r}await new Promise(r=>setTimeout(r,i*1e3));let a;s.content.type==="text"?(a=s.content.text||"",s.content.variables&&(a=a.replace("{\u5BA2\u6236\u540D}",e.targetCustomer.firstName||e.targetCustomer.username||"VIP\u5BA2\u6236").replace("{\u7FA4\u540D}",e.groupTitle))):s.content.type==="ai_generate"?a=(await this.conversationEngine.generateMultiRoleReply(s.content.aiPrompt||"\u8ACB\u6839\u64DA\u7576\u524D\u5C0D\u8A71\u4E0A\u4E0B\u6587\u751F\u6210\u5408\u9069\u7684\u56DE\u8986",{roleId:o.id,roleName:o.name,rolePrompt:o.aiConfig.customPrompt||"",personality:o.personality.description},{userId:e.targetCustomer.id,userName:e.targetCustomer.firstName||e.targetCustomer.username,sourceGroup:e.telegramGroupId||e.id})).content:a=s.content.text||"",console.log(`[MultiRole] ${o.name}: ${a}`),this.activeGroups.update(r=>r.map(u=>u.id===e.id?S(c({},u),{messagesSent:u.messagesSent+1}):u))}}updateAutoGroupSettings(e){this.config.update(t=>S(c({},t),{autoGroupSettings:c(c({},t.autoGroupSettings),e)}))}updateTriggerConditions(e){this.config.update(t=>S(c({},t),{defaultTriggerConditions:c(c({},t.defaultTriggerConditions),e)}))}updateAISettings(e){this.config.update(t=>S(c({},t),{aiSettings:c(c({},t.aiSettings),e)}))}exportConfig(){return JSON.stringify(this.config(),null,2)}importConfig(e){try{let t=JSON.parse(e);return this.config.set(t),!0}catch{return!1}}resetToDefault(){this.config.set($),this.activeGroups.set([])}static{this.\u0275fac=function(t){return new(t||y)}}static{this.\u0275prov=R({token:y,factory:y.\u0275fac,providedIn:"root"})}};var K=1,L=class y{constructor(){this.ipc=_(A);this.toast=_(j);this.multiRoleService=_(D);this.accountService=_(O);this._currentExecution=I(null);this.currentExecution=C(()=>this._currentExecution());this._executions=I([]);this.executions=C(()=>this._executions());this._isProcessing=I(!1);this.isProcessing=C(()=>this._isProcessing());this._executionMode=I("hybrid");this.executionMode=C(()=>this._executionMode());this._accountMatches=I([]);this.accountMatches=C(()=>this._accountMatches());this.queueProgress=C(()=>{let e=this._currentExecution();return e?.queue?{total:e.queue.totalUsers,processed:e.queue.processedUsers,current:e.queue.currentUser,pending:e.queue.pendingUsers.length,completed:e.queue.completedUsers,progress:e.queue.totalUsers>0?Math.round(e.queue.processedUsers/e.queue.totalUsers*100):0}:null});this.analysisInterval=10;this.defaultScriptlessConfig={enabled:!1,maxTurns:50,autoAdjustInterval:10,targetConversionSignals:["\u600E\u9EBC\u8CB7","\u5728\u54EA\u8CB7","\u591A\u5C11\u9322","\u60F3\u8CB7","\u4E0B\u55AE","\u4ED8\u6B3E"],exitConditions:{maxSilenceMinutes:60,negativeThreshold:30,successSignals:["\u8CB7\u4E86","\u5DF2\u4ED8\u6B3E","\u6210\u4EA4","\u8B1D\u8B1D","\u6536\u5230"]}};this.intentTemplates={sales_conversion:{keywords:["\u6210\u4EA4","\u8CFC\u8CB7","\u4E0B\u55AE","\u4ED8\u8CBB","\u8F49\u5316","\u8CB7","\u8A02\u55AE","\u4ED8\u6B3E","\u71DF\u92B7","\u92B7\u552E","\u63A8\u5EE3","\u652F\u4ED8","\u4EE3\u6536","\u4EE3\u4ED8","\u7522\u54C1","\u670D\u52D9","\u5BA2\u6236","\u7528\u6236","\u8208\u8DA3","\u5408\u4F5C","\u696D\u52D9","\u958B\u767C","\u62D3\u5C55","\u7C3D\u7D04"],description:"\u4FC3\u9032\u6F5B\u5728\u5BA2\u6236\u5B8C\u6210\u8CFC\u8CB7",defaultRoles:[{id:"friendly_member",name:"\u71B1\u5FC3\u7FA4\u53CB",icon:"\u{1F604}",type:"atmosphere",purpose:"\u6D3B\u8E8D\u6C23\u6C1B\uFF0C\u81EA\u7136\u5F15\u5165\u8A71\u984C",personality:"\u71B1\u60C5\u958B\u6717\uFF0C\u611B\u5206\u4EAB\uFF0C\u597D\u5947\u5FC3\u5F37",speakingStyle:"\u53E3\u8A9E\u5316\uFF0C\u5E36\u8868\u60C5\u7B26\u865F\uFF0C\u50CF\u670B\u53CB\u804A\u5929",entryTiming:"\u958B\u5834\u548C\u6C23\u6C1B\u51B7\u5834\u6642",sampleMessages:["\u5927\u5BB6\u65E9\u5B89\uFF01\u4ECA\u5929\u5929\u6C23\u771F\u597D\uFF5E","\u54C8\u54C8\u9019\u500B\u6709\u610F\u601D\uFF0C\u6211\u4E5F\u9047\u5230\u904E","\u5C0D\u4E86\uFF0C\u6700\u8FD1\u6709\u4EBA\u7528\u904EXX\u55CE\uFF1F\u60F3\u807D\u807D\u610F\u898B"]},{id:"loyal_customer",name:"\u8001\u7528\u6236",icon:"\u2764\uFE0F",type:"endorsement",purpose:"\u5206\u4EAB\u771F\u5BE6\u4F7F\u7528\u9AD4\u9A57\uFF0C\u5EFA\u7ACB\u4FE1\u4EFB",personality:"\u771F\u8AA0\u53EF\u9760\uFF0C\u6A02\u65BC\u52A9\u4EBA",speakingStyle:"\u5E73\u5BE6\u81EA\u7136\uFF0C\u5206\u4EAB\u500B\u4EBA\u7D93\u6B77",entryTiming:"\u8A71\u984C\u8F49\u5230\u7522\u54C1\u76F8\u95DC\u6642",sampleMessages:["\u6211\u7528\u4E86\u5927\u6982\u4E09\u500B\u6708\u5427\uFF0C\u611F\u89BA\u9084\u4E0D\u932F","\u4E00\u958B\u59CB\u4E5F\u662F\u670B\u53CB\u63A8\u85A6\u7684\uFF0C\u6C92\u60F3\u5230\u771F\u7684\u597D\u7528","\u8AAA\u5BE6\u8A71\u525B\u958B\u59CB\u4E5F\u6709\u9EDE\u7336\u8C6B\uFF0C\u5F8C\u4F86\u89BA\u5F97\u503C\u5F97"]},{id:"sales_expert",name:"\u9867\u554F\u5C08\u5BB6",icon:"\u{1F4BC}",type:"professional",purpose:"\u5C08\u696D\u89E3\u7B54\uFF0C\u4FC3\u6210\u6210\u4EA4",personality:"\u5C08\u696D\u53EF\u9760\uFF0C\u8010\u5FC3\u7D30\u7DFB",speakingStyle:"\u5C08\u696D\u4F46\u4E0D\u751F\u786C\uFF0C\u6709\u89AA\u548C\u529B",entryTiming:"\u5BA2\u6236\u8868\u73FE\u51FA\u660E\u78BA\u8208\u8DA3\u6642",sampleMessages:["\u9019\u500B\u554F\u984C\u554F\u5F97\u597D\uFF0C\u6211\u4F86\u8A73\u7D30\u8AAA\u660E\u4E00\u4E0B","\u6839\u64DA\u60A8\u7684\u9700\u6C42\uFF0C\u6211\u5EFA\u8B70...","\u73FE\u5728\u6B63\u597D\u6709\u6D3B\u52D5\uFF0C\u53EF\u4EE5\u4E86\u89E3\u4E00\u4E0B"]}],defaultPhases:[{id:"phase_1",name:"\u6C1B\u570D\u71DF\u9020",duration:"1-2\u5929",goal:"\u5EFA\u7ACB\u5B58\u5728\u611F\uFF0C\u6D3B\u8E8D\u7FA4\u6C23\u6C1B",tactics:["\u65E5\u5E38\u554F\u5019","\u5206\u4EAB\u8DA3\u4E8B","\u53C3\u8207\u8A0E\u8AD6"],rolesFocus:["friendly_member"],successIndicators:["\u7FA4\u6D3B\u8E8D\u5EA6\u63D0\u5347","\u6709\u4EBA\u56DE\u8986\u4E92\u52D5"]},{id:"phase_2",name:"\u8A71\u984C\u5F15\u5165",duration:"1-2\u5929",goal:"\u81EA\u7136\u5F15\u5165\u7522\u54C1\u76F8\u95DC\u8A71\u984C",tactics:["\u5834\u666F\u5206\u4EAB","\u75DB\u9EDE\u8A0E\u8AD6","\u7D93\u9A57\u4EA4\u6D41"],rolesFocus:["friendly_member","loyal_customer"],successIndicators:["\u76EE\u6A19\u5BA2\u6236\u53C3\u8207\u8A0E\u8AD6","\u63D0\u53CA\u7522\u54C1\u76F8\u95DC\u9700\u6C42"]},{id:"phase_3",name:"\u50F9\u503C\u5C55\u793A",duration:"1-2\u5929",goal:"\u5C55\u793A\u7522\u54C1\u50F9\u503C\uFF0C\u5EFA\u7ACB\u4FE1\u4EFB",tactics:["\u4F7F\u7528\u9AD4\u9A57\u5206\u4EAB","\u6548\u679C\u898B\u8B49","\u5C08\u696D\u89E3\u7B54"],rolesFocus:["loyal_customer","sales_expert"],successIndicators:["\u5BA2\u6236\u8A62\u554F\u8A73\u60C5","\u8208\u8DA3\u5EA6\u4E0A\u5347"]},{id:"phase_4",name:"\u4FC3\u6210\u6210\u4EA4",duration:"\u9748\u6D3B",goal:"\u628A\u63E1\u6642\u6A5F\uFF0C\u4FC3\u6210\u8CFC\u8CB7",tactics:["\u512A\u60E0\u544A\u77E5","\u9650\u6642\u523A\u6FC0","\u7570\u8B70\u8655\u7406"],rolesFocus:["sales_expert"],successIndicators:["\u5BA2\u6236\u8A62\u50F9","\u9054\u6210\u8CFC\u8CB7"]}]},churn_recovery:{keywords:["\u6D41\u5931","\u633D\u56DE","\u56DE\u4F86","\u518D\u6B21","\u91CD\u65B0","\u8001\u5BA2\u6236","\u7E8C\u8CBB"],description:"\u633D\u56DE\u6D41\u5931\u6216\u6C89\u9ED8\u7684\u8001\u5BA2\u6236",defaultRoles:[{id:"callback_agent",name:"\u56DE\u8A2A\u5C08\u54E1",icon:"\u{1F4DE}",type:"care",purpose:"\u771F\u8AA0\u95DC\u61F7\uFF0C\u4E86\u89E3\u96E2\u958B\u539F\u56E0",personality:"\u6EAB\u6696\u771F\u8AA0\uFF0C\u5584\u65BC\u50BE\u807D",speakingStyle:"\u89AA\u5207\u95DC\u61F7\uFF0C\u4E0D\u6025\u8E81",entryTiming:"\u958B\u5834",sampleMessages:["\u597D\u4E45\u6C92\u806F\u7E6B\u4E86\uFF0C\u6700\u8FD1\u600E\u9EBC\u6A23\uFF1F","\u60F3\u8D77\u60A8\u4E86\uFF0C\u7279\u610F\u4F86\u554F\u5019\u4E00\u4E0B","\u4E4B\u524D\u7528\u8457\u9084\u9806\u5229\u55CE\uFF1F\u6709\u4EC0\u9EBC\u53EF\u4EE5\u5E6B\u5FD9\u7684\uFF1F"]},{id:"customer_success",name:"\u5BA2\u6236\u6210\u529F",icon:"\u{1F3AF}",type:"solution",purpose:"\u89E3\u6C7A\u554F\u984C\uFF0C\u5C55\u793A\u6539\u9032",personality:"\u5C08\u696D\u8CA0\u8CAC\uFF0C\u7A4D\u6975\u4E3B\u52D5",speakingStyle:"\u554F\u984C\u5C0E\u5411\uFF0C\u63D0\u4F9B\u65B9\u6848",entryTiming:"\u5BA2\u6236\u8AAA\u51FA\u96E2\u958B\u539F\u56E0\u5F8C",sampleMessages:["\u611F\u8B1D\u60A8\u7684\u53CD\u994B\uFF0C\u9019\u500B\u554F\u984C\u6211\u5011\u5DF2\u7D93\u512A\u5316\u4E86","\u91DD\u5C0D\u9019\u500B\u60C5\u6CC1\uFF0C\u6211\u5011\u73FE\u5728\u6709\u65B0\u7684\u89E3\u6C7A\u65B9\u6848","\u4F86\uFF0C\u6211\u5E6B\u60A8\u770B\u770B\u73FE\u5728\u600E\u9EBC\u8655\u7406\u6700\u597D"]},{id:"vip_manager",name:"VIP\u7D93\u7406",icon:"\u{1F451}",type:"retention",purpose:"\u9AD8\u5C64\u51FA\u9762\uFF0C\u8AA0\u610F\u633D\u7559",personality:"\u6709\u6B0A\u5A01\u4F46\u89AA\u548C\uFF0C\u8AA0\u610F\u5341\u8DB3",speakingStyle:"\u6B63\u5F0F\u4F46\u4E0D\u751F\u786C\uFF0C\u5C55\u73FE\u8AA0\u610F",entryTiming:"\u9700\u8981\u7279\u5225\u512A\u60E0\u6216\u6C7A\u7B56\u6642",sampleMessages:["\u6211\u662FVIP\u7D93\u7406\uFF0C\u7279\u610F\u4F86\u8DDF\u60A8\u804A\u804A","\u60A8\u662F\u6211\u5011\u7684\u91CD\u8981\u5BA2\u6236\uFF0C\u9019\u500B\u512A\u60E0\u662F\u5C08\u9580\u70BA\u60A8\u7533\u8ACB\u7684","\u6709\u4EC0\u9EBC\u9867\u616E\u90FD\u53EF\u4EE5\u8AAA\uFF0C\u6211\u5011\u4E00\u5B9A\u76E1\u529B\u89E3\u6C7A"]}],defaultPhases:[{id:"phase_1",name:"\u95DC\u61F7\u56DE\u8A2A",duration:"1\u5929",goal:"\u771F\u8AA0\u554F\u5019\uFF0C\u4E86\u89E3\u8FD1\u6CC1",tactics:["\u554F\u5019","\u95DC\u5FC3","\u50BE\u807D"],rolesFocus:["callback_agent"],successIndicators:["\u5BA2\u6236\u56DE\u8986","\u8AAA\u51FA\u96E2\u958B\u539F\u56E0"]},{id:"phase_2",name:"\u554F\u984C\u89E3\u6C7A",duration:"1-2\u5929",goal:"\u91DD\u5C0D\u554F\u984C\u63D0\u4F9B\u65B9\u6848",tactics:["\u554F\u984C\u78BA\u8A8D","\u65B9\u6848\u63D0\u4F9B","\u6539\u9032\u8AAA\u660E"],rolesFocus:["customer_success"],successIndicators:["\u5BA2\u6236\u8A8D\u53EF\u6539\u9032","\u9858\u610F\u518D\u8A66"]},{id:"phase_3",name:"\u8AA0\u610F\u633D\u7559",duration:"\u9748\u6D3B",goal:"\u63D0\u4F9B\u512A\u60E0\uFF0C\u4FC3\u6210\u56DE\u6B78",tactics:["\u5C08\u5C6C\u512A\u60E0","VIP\u5F85\u9047","\u627F\u8AFE\u4FDD\u969C"],rolesFocus:["vip_manager"],successIndicators:["\u5BA2\u6236\u540C\u610F\u56DE\u6B78","\u7E8C\u8CBB\u6210\u529F"]}]},community_activation:{keywords:["\u6D3B\u8E8D","\u793E\u7FA4","\u6C23\u6C1B","\u4E92\u52D5","\u8A0E\u8AD6","\u51B7\u6E05","\u5E36\u52D5"],description:"\u63D0\u5347\u793E\u7FA4\u6D3B\u8E8D\u5EA6\u548C\u7528\u6236\u7C98\u6027",defaultRoles:[{id:"community_host",name:"\u793E\u7FA4\u7BA1\u5BB6",icon:"\u{1F3E0}",type:"host",purpose:"\u767C\u8D77\u8A71\u984C\uFF0C\u7DAD\u8B77\u79E9\u5E8F",personality:"\u71B1\u60C5\u8CA0\u8CAC\uFF0C\u6709\u7D44\u7E54\u80FD\u529B",speakingStyle:"\u89AA\u5207\u6709\u5E8F\uFF0C\u5F15\u5C0E\u8A0E\u8AD6",entryTiming:"\u958B\u5834\u548C\u8A71\u984C\u8F49\u63DB\u6642",sampleMessages:["\u65E9\u5B89\u5404\u4F4D\uFF01\u65B0\u7684\u4E00\u5929\u958B\u59CB\u4E86\uFF5E","\u4ECA\u5929\u4F86\u804A\u804AXXX\uFF0C\u5927\u5BB6\u600E\u9EBC\u770B\uFF1F","\u611F\u8B1D\u5206\u4EAB\uFF01\u9084\u6709\u5176\u4ED6\u60F3\u6CD5\u55CE\uFF1F"]},{id:"active_member_1",name:"\u6D3B\u8E8D\u7FA4\u53CBA",icon:"\u{1F917}",type:"participant",purpose:"\u7A4D\u6975\u4E92\u52D5\uFF0C\u5E36\u52D5\u6C23\u6C1B",personality:"\u5916\u5411\u6D3B\u6F51\uFF0C\u611B\u5206\u4EAB",speakingStyle:"\u8F15\u9B06\u96A8\u610F\uFF0C\u591A\u7528\u8868\u60C5",entryTiming:"\u8A71\u984C\u767C\u8D77\u5F8C\u7A4D\u6975\u97FF\u61C9",sampleMessages:["\u9019\u500B\u8A71\u984C\u6211\u6709\u8A71\u8AAA\uFF01","\u54C8\u54C8\u78BA\u5BE6\u662F\u9019\u6A23","\u6211\u4E5F\u6709\u985E\u4F3C\u7684\u7D93\u6B77\uFF5E"]},{id:"active_member_2",name:"\u6D3B\u8E8D\u7FA4\u53CBB",icon:"\u{1F60E}",type:"participant",purpose:"\u88DC\u5145\u89C0\u9EDE\uFF0C\u5EF6\u7E8C\u8A0E\u8AD6",personality:"\u5E7D\u9ED8\u98A8\u8DA3\uFF0C\u898B\u89E3\u7368\u5230",speakingStyle:"\u6709\u8DA3\u6709\u6599\uFF0C\u5076\u723E\u6296\u6A5F\u9748",entryTiming:"\u8A0E\u8AD6\u9032\u884C\u4E2D\u88DC\u5145",sampleMessages:["\u6A13\u4E0A\u8AAA\u5F97\u5C0D\uFF0C\u6211\u88DC\u5145\u4E00\u9EDE","\u63DB\u500B\u89D2\u5EA6\u60F3\u60F3...","\u9019\u8B93\u6211\u60F3\u8D77\u4E00\u500B\u6709\u610F\u601D\u7684\u4E8B"]},{id:"opinion_leader",name:"\u610F\u898B\u9818\u8896",icon:"\u{1F3A4}",type:"expert",purpose:"\u8F38\u51FA\u50F9\u503C\uFF0C\u7E3D\u7D50\u89C0\u9EDE",personality:"\u5C08\u696D\u6B0A\u5A01\uFF0C\u6709\u6DF1\u5EA6",speakingStyle:"\u6709\u898B\u5730\uFF0C\u80FD\u7E3D\u7D50\u63D0\u5347",entryTiming:"\u8A0E\u8AD6\u9700\u8981\u7E3D\u7D50\u6216\u5347\u83EF\u6642",sampleMessages:["\u770B\u4E86\u5927\u5BB6\u7684\u8A0E\u8AD6\uFF0C\u6211\u4F86\u7E3D\u7D50\u4E00\u4E0B","\u9019\u500B\u554F\u984C\u7684\u95DC\u9375\u5728\u65BC...","\u5206\u4EAB\u4E00\u500B\u6211\u7684\u601D\u8003\u6846\u67B6"]}],defaultPhases:[{id:"phase_1",name:"\u8A71\u984C\u767C\u8D77",duration:"\u6301\u7E8C",goal:"\u767C\u8D77\u6709\u50F9\u503C\u7684\u8A0E\u8AD6\u8A71\u984C",tactics:["\u71B1\u9EDE\u8A71\u984C","\u7D93\u9A57\u5206\u4EAB","\u554F\u984C\u8A0E\u8AD6"],rolesFocus:["community_host"],successIndicators:["\u6709\u4EBA\u53C3\u8207\u8A0E\u8AD6"]},{id:"phase_2",name:"\u4E92\u52D5\u97FF\u61C9",duration:"\u6301\u7E8C",goal:"\u5E36\u52D5\u8A0E\u8AD6\u6C1B\u570D",tactics:["\u7A4D\u6975\u56DE\u8986","\u88DC\u5145\u89C0\u9EDE","\u8868\u9054\u8A8D\u540C"],rolesFocus:["active_member_1","active_member_2"],successIndicators:["\u591A\u4EBA\u53C3\u8207","\u8A0E\u8AD6\u6DF1\u5165"]},{id:"phase_3",name:"\u50F9\u503C\u8F38\u51FA",duration:"\u9069\u6642",goal:"\u7E3D\u7D50\u8A0E\u8AD6\u50F9\u503C",tactics:["\u89C0\u9EDE\u7E3D\u7D50","\u7D93\u9A57\u63D0\u7149","\u77E5\u8B58\u5206\u4EAB"],rolesFocus:["opinion_leader"],successIndicators:["\u7372\u5F97\u8A8D\u53EF","\u88AB\u6536\u85CF\u8F49\u767C"]}]},customer_support:{keywords:["\u552E\u5F8C","\u554F\u984C","\u6295\u8A34","\u6545\u969C","\u4E0D\u6EFF","\u89E3\u6C7A","\u8655\u7406","\u9000"],description:"\u9AD8\u6548\u8655\u7406\u5BA2\u6236\u552E\u5F8C\u554F\u984C",defaultRoles:[{id:"cs_agent",name:"\u5BA2\u670D\u5C08\u54E1",icon:"\u{1F3A7}",type:"frontline",purpose:"\u5FEB\u901F\u97FF\u61C9\uFF0C\u8A18\u9304\u554F\u984C",personality:"\u8010\u5FC3\u7D30\u7DFB\uFF0C\u614B\u5EA6\u597D",speakingStyle:"\u79AE\u8C8C\u5C08\u696D\uFF0C\u8868\u9054\u6B49\u610F",entryTiming:"\u554F\u984C\u51FA\u73FE\u6642\u7ACB\u5373\u97FF\u61C9",sampleMessages:["\u60A8\u597D\uFF0C\u975E\u5E38\u62B1\u6B49\u7D66\u60A8\u5E36\u4F86\u4E0D\u4FBF\uFF01","\u8ACB\u554F\u5177\u9AD4\u662F\u4EC0\u9EBC\u554F\u984C\u5462\uFF1F\u6211\u4F86\u5E6B\u60A8\u8655\u7406","\u6211\u5DF2\u7D93\u8A18\u9304\u4E0B\u4F86\u4E86\uFF0C\u99AC\u4E0A\u70BA\u60A8\u8DDF\u9032"]},{id:"tech_support",name:"\u6280\u8853\u652F\u6301",icon:"\u{1F527}",type:"technical",purpose:"\u6280\u8853\u6392\u67E5\uFF0C\u89E3\u6C7A\u554F\u984C",personality:"\u5C08\u696D\u56B4\u8B39\uFF0C\u908F\u8F2F\u6E05\u6670",speakingStyle:"\u6280\u8853\u5C08\u696D\u4F46\u6613\u61C2",entryTiming:"\u9700\u8981\u6280\u8853\u89E3\u7B54\u6642",sampleMessages:["\u6839\u64DA\u60A8\u63CF\u8FF0\u7684\u60C5\u6CC1\uFF0C\u8ACB\u60A8\u5617\u8A66\u4EE5\u4E0B\u6B65\u9A5F","\u9019\u500B\u554F\u984C\u6211\u4F86\u770B\u4E00\u4E0B\uFF0C\u7A0D\u7B49","\u627E\u5230\u539F\u56E0\u4E86\uFF0C\u662F\u56E0\u70BAXXX\uFF0C\u89E3\u6C7A\u65B9\u6848\u662F..."]},{id:"satisfaction_manager",name:"\u6EFF\u610F\u5EA6\u7D93\u7406",icon:"\u{1F60A}",type:"recovery",purpose:"\u78BA\u8A8D\u6EFF\u610F\uFF0C\u88DC\u511F\u633D\u56DE",personality:"\u6EAB\u6696\u771F\u8AA0\uFF0C\u6709\u8AA0\u610F",speakingStyle:"\u771F\u8AA0\u9053\u6B49\uFF0C\u7A4D\u6975\u88DC\u511F",entryTiming:"\u554F\u984C\u89E3\u6C7A\u5F8C",sampleMessages:["\u554F\u984C\u89E3\u6C7A\u4E86\u55CE\uFF1F\u7D66\u60A8\u9020\u6210\u4E0D\u4FBF\u771F\u7684\u5F88\u62B1\u6B49","\u70BA\u8868\u6B49\u610F\uFF0C\u6211\u5011\u70BA\u60A8\u7533\u8ACB\u4E86\u4E00\u4EFD\u5C0F\u79AE\u7269","\u4EE5\u5F8C\u6709\u4EFB\u4F55\u554F\u984C\u90FD\u53EF\u4EE5\u96A8\u6642\u627E\u6211"]}],defaultPhases:[{id:"phase_1",name:"\u5FEB\u901F\u97FF\u61C9",duration:"\u7ACB\u5373",goal:"\u7B2C\u4E00\u6642\u9593\u97FF\u61C9\uFF0C\u5B89\u64AB\u60C5\u7DD2",tactics:["\u8868\u9054\u6B49\u610F","\u78BA\u8A8D\u554F\u984C","\u8868\u793A\u91CD\u8996"],rolesFocus:["cs_agent"],successIndicators:["\u5BA2\u6236\u60C5\u7DD2\u7DE9\u548C"]},{id:"phase_2",name:"\u554F\u984C\u89E3\u6C7A",duration:"\u76E1\u5FEB",goal:"\u6392\u67E5\u4E26\u89E3\u6C7A\u554F\u984C",tactics:["\u6280\u8853\u6392\u67E5","\u63D0\u4F9B\u65B9\u6848","\u78BA\u8A8D\u89E3\u6C7A"],rolesFocus:["tech_support"],successIndicators:["\u554F\u984C\u89E3\u6C7A"]},{id:"phase_3",name:"\u6EFF\u610F\u78BA\u8A8D",duration:"\u554F\u984C\u89E3\u6C7A\u5F8C",goal:"\u78BA\u8A8D\u6EFF\u610F\uFF0C\u9069\u7576\u88DC\u511F",tactics:["\u78BA\u8A8D\u6EFF\u610F","\u88DC\u511F\u633D\u56DE","\u5EFA\u7ACB\u597D\u611F"],rolesFocus:["satisfaction_manager"],successIndicators:["\u5BA2\u6236\u6EFF\u610F","\u597D\u8A55\u53CD\u994B"]}]},brand_promotion:{keywords:["\u63A8\u5EE3","\u54C1\u724C","\u5BA3\u50B3","\u77E5\u540D\u5EA6","\u66DD\u5149","\u50B3\u64AD"],description:"\u63D0\u5347\u54C1\u724C\u77E5\u540D\u5EA6\u548C\u597D\u611F\u5EA6",defaultRoles:[{id:"brand_ambassador",name:"\u54C1\u724C\u5927\u4F7F",icon:"\u{1F3C6}",type:"promotion",purpose:"\u50B3\u64AD\u54C1\u724C\u50F9\u503C",personality:"\u5C08\u696D\u81EA\u4FE1\uFF0C\u6709\u611F\u67D3\u529B",speakingStyle:"\u7A4D\u6975\u6B63\u9762\uFF0C\u6709\u865F\u53EC\u529B",entryTiming:"\u54C1\u724C\u76F8\u95DC\u8A71\u984C",sampleMessages:["\u9019\u500B\u54C1\u724C\u6211\u4E00\u76F4\u95DC\u6CE8\uFF0C\u7406\u5FF5\u5F88\u597D","\u4ED6\u5011\u5BB6\u7684\u54C1\u8CEA\u78BA\u5BE6\u6C92\u8A71\u8AAA"]}],defaultPhases:[{id:"phase_1",name:"\u54C1\u724C\u66DD\u5149",duration:"\u6301\u7E8C",goal:"\u81EA\u7136\u50B3\u64AD\u54C1\u724C",tactics:["\u50F9\u503C\u5206\u4EAB","\u6545\u4E8B\u8B1B\u8FF0"],rolesFocus:["brand_ambassador"],successIndicators:["\u88AB\u8A0E\u8AD6","\u597D\u8A55"]}]},lead_nurturing:{keywords:["\u57F9\u80B2","\u6F5B\u5BA2","\u8DDF\u9032","\u9810\u71B1","\u6559\u80B2"],description:"\u57F9\u80B2\u6F5B\u5728\u5BA2\u6236\uFF0C\u63D0\u5347\u8CFC\u8CB7\u610F\u9858",defaultRoles:[{id:"content_sharer",name:"\u5167\u5BB9\u9054\u4EBA",icon:"\u{1F4DA}",type:"education",purpose:"\u5206\u4EAB\u6709\u50F9\u503C\u5167\u5BB9",personality:"\u77E5\u8B58\u8C50\u5BCC\uFF0C\u6A02\u65BC\u5206\u4EAB",speakingStyle:"\u6709\u6599\u6709\u8DA3\uFF0C\u4E0D\u8AAA\u6559",entryTiming:"\u6301\u7E8C",sampleMessages:["\u5206\u4EAB\u4E00\u500B\u5F88\u6709\u7528\u7684\u65B9\u6CD5","\u9019\u7BC7\u6587\u7AE0\u5BEB\u5F97\u592A\u597D\u4E86"]}],defaultPhases:[{id:"phase_1",name:"\u50F9\u503C\u8F38\u51FA",duration:"\u6301\u7E8C",goal:"\u901A\u904E\u5167\u5BB9\u5EFA\u7ACB\u4FE1\u4EFB",tactics:["\u77E5\u8B58\u5206\u4EAB","\u6848\u4F8B\u5206\u6790"],rolesFocus:["content_sharer"],successIndicators:["\u88AB\u95DC\u6CE8","\u4E3B\u52D5\u8A62\u554F"]}]},custom:{keywords:[],description:"\u81EA\u5B9A\u7FA9\u76EE\u6A19",defaultRoles:[{id:"account_manager",name:"\u5BA2\u6236\u7D93\u7406",icon:"\u{1F4BC}",type:"account_manager",purpose:"\u4E86\u89E3\u9700\u6C42\uFF0C\u5EFA\u7ACB\u95DC\u4FC2",personality:"\u5C08\u696D\u53CB\u597D\uFF0C\u5584\u65BC\u50BE\u807D",speakingStyle:"\u5C08\u696D\u4F46\u4E0D\u751F\u786C\uFF0C\u50CF\u670B\u53CB\u822C\u4EA4\u6D41",entryTiming:"\u9996\u6B21\u63A5\u89F8\u548C\u91CD\u8981\u7BC0\u9EDE",sampleMessages:["\u60A8\u597D\uFF01\u6211\u662F\u60A8\u7684\u5C08\u5C6C\u5BA2\u6236\u7D93\u7406","\u8ACB\u554F\u6709\u4EC0\u9EBC\u53EF\u4EE5\u5E6B\u5230\u60A8\u7684\u55CE\uFF1F","\u6709\u4EFB\u4F55\u554F\u984C\u90FD\u53EF\u4EE5\u96A8\u6642\u554F\u6211"]},{id:"solution_expert",name:"\u65B9\u6848\u5C08\u5BB6",icon:"\u{1F4CB}",type:"professional",purpose:"\u63D0\u4F9B\u5C08\u696D\u65B9\u6848\u548C\u5EFA\u8B70",personality:"\u5C08\u696D\u6B0A\u5A01\uFF0C\u6709\u6DF1\u5EA6",speakingStyle:"\u6E05\u6670\u7C21\u6F54\uFF0C\u91CD\u9EDE\u7A81\u51FA",entryTiming:"\u5BA2\u6236\u6709\u5177\u9AD4\u9700\u6C42\u6642",sampleMessages:["\u6839\u64DA\u60A8\u7684\u60C5\u6CC1\uFF0C\u6211\u5EFA\u8B70...","\u9019\u500B\u65B9\u6848\u53EF\u4EE5\u6EFF\u8DB3\u60A8\u7684\u9700\u6C42","\u8B93\u6211\u4F86\u8A73\u7D30\u8AAA\u660E\u4E00\u4E0B"]}],defaultPhases:[{id:"phase_1",name:"\u4E86\u89E3\u9700\u6C42",duration:"1-2\u5929",goal:"\u5EFA\u7ACB\u806F\u7E6B\uFF0C\u4E86\u89E3\u5BA2\u6236\u9700\u6C42",tactics:["\u958B\u5834\u554F\u5019","\u9700\u6C42\u6316\u6398"],rolesFocus:["account_manager"],successIndicators:["\u5BA2\u6236\u56DE\u8986","\u8AAA\u51FA\u9700\u6C42"]},{id:"phase_2",name:"\u63D0\u4F9B\u65B9\u6848",duration:"1-2\u5929",goal:"\u6839\u64DA\u9700\u6C42\u63D0\u4F9B\u5B9A\u5236\u65B9\u6848",tactics:["\u65B9\u6848\u4ECB\u7D39","\u50F9\u503C\u8AAA\u660E"],rolesFocus:["solution_expert"],successIndicators:["\u5BA2\u6236\u8A8D\u53EF","\u8A62\u554F\u7D30\u7BC0"]},{id:"phase_3",name:"\u4FC3\u6210\u8F49\u5316",duration:"\u9748\u6D3B",goal:"\u89E3\u7B54\u7591\u616E\uFF0C\u4FC3\u6210\u6210\u4EA4",tactics:["\u7570\u8B70\u8655\u7406","\u512A\u60E0\u4FC3\u55AE"],rolesFocus:["account_manager"],successIndicators:["\u5BA2\u6236\u540C\u610F","\u6210\u4EA4"]}]}};this.conversionSignals={high:["\u600E\u9EBC\u8CB7","\u591A\u5C11\u9322","\u50F9\u683C","\u4ED8\u6B3E","\u4E0B\u55AE","\u60F3\u8CB7","\u8CFC\u8CB7","\u8A02\u8CFC","\u4ED8\u8CBB","\u652F\u4ED8"],medium:["\u6709\u8208\u8DA3","\u60F3\u4E86\u89E3","\u4ECB\u7D39\u4E00\u4E0B","\u8A73\u7D30\u8AAA\u8AAA","\u767C\u7D66\u6211","\u6709\u4EC0\u9EBC\u512A\u60E0","\u600E\u9EBC\u4F7F\u7528"],positive:["\u4E0D\u932F","\u633A\u597D","\u6709\u9053\u7406","\u53EF\u4EE5","\u597D\u7684","\u8B1D\u8B1D","\u611F\u8B1D"],negative:["\u4E0D\u9700\u8981","\u4E0D\u7528\u4E86","\u4E0D\u611F\u8208\u8DA3","\u5225\u6253\u64FE","\u53D6\u95DC","\u62C9\u9ED1","\u9A37\u64FE"],converted:["\u8CB7\u4E86","\u5DF2\u4ED8\u6B3E","\u4ED8\u597D\u4E86","\u4E0B\u55AE\u4E86","\u6210\u4EA4","\u8A02\u597D\u4E86"]};this.setupMessageAnalysisListener()}forceUpdateExecution(e){this._currentExecution.set(c({},e)),this.persistExecution(e)}persistExecution(e){try{this.ipc.send("ai-execution:save",{id:e.id,executionType:e.chatScenario||"private",status:e.status,mode:e.mode,goal:e.goal,targetUsers:JSON.stringify(e.targetUsers||[]),roleAccounts:JSON.stringify(e.accountMatches||[]),groupId:e.groupConfig?.groupId,groupName:e.groupConfig?.groupId?`\u7FA4\u7D44 ${e.groupConfig.groupId}`:void 0,messageHistory:JSON.stringify(e.messageHistory||[]),stats:JSON.stringify(e.stats||{})})}catch(t){console.warn("[DynamicEngine] \u6301\u4E45\u5316\u57F7\u884C\u72C0\u614B\u5931\u6557:",t)}}async restoreExecutions(){try{console.log("[DynamicEngine] \u{1F504} \u5617\u8A66\u6062\u5FA9\u57F7\u884C\u72C0\u614B...");let e=await this.ipc.invoke("ai-execution:get-active");if(e&&e.executions&&e.executions.length>0){console.log(`[DynamicEngine] \u627E\u5230 ${e.executions.length} \u500B\u6D3B\u8E8D\u57F7\u884C`);for(let t of e.executions){let n={id:t.id,status:t.status==="running"?"executing":t.status,goal:t.goal||"",mode:t.mode||"hybrid",chatScenario:t.executionType||"private",targetUsers:JSON.parse(t.targetUsers||"[]"),accountMatches:JSON.parse(t.roleAccounts||"[]"),messageHistory:JSON.parse(t.messageHistory||"[]"),stats:JSON.parse(t.stats||"{}"),intent:{type:"sales_conversion",confidence:80,goal:t.goal||"",targetAudience:"\u6F5B\u5728\u5BA2\u6236",urgency:"medium",suggestedDuration:"1-2\u9031"},strategy:{id:"restored_strategy",name:"\u6062\u5FA9\u7B56\u7565",description:"\u5F9E\u6578\u64DA\u5EAB\u6062\u5FA9\u7684\u57F7\u884C\u7B56\u7565",phases:[],adjustmentRules:[],constraints:{maxDailyMessages:20,maxConsecutiveFromSameRole:3,minIntervalSeconds:30,maxIntervalSeconds:300,activeHours:{start:8,end:22},toneGuidelines:["\u53CB\u597D","\u5C08\u696D"],forbiddenTopics:[]}},roles:[],groupConfig:t.groupId?{groupId:t.groupId,chatScenario:"group"}:void 0};this._currentExecution.set(n),this._executions.update(s=>[n,...s.filter(o=>o.id!==n.id)]),console.log(`[DynamicEngine] \u2705 \u5DF2\u6062\u5FA9\u57F7\u884C: ${n.id}`)}this.toast.info(`\u{1F504} \u5DF2\u6062\u5FA9 ${e.executions.length} \u500B\u9032\u884C\u4E2D\u7684\u4EFB\u52D9`)}else console.log("[DynamicEngine] \u6C92\u6709\u9700\u8981\u6062\u5FA9\u7684\u57F7\u884C")}catch(e){console.warn("[DynamicEngine] \u6062\u5FA9\u57F7\u884C\u72C0\u614B\u5931\u6557:",e)}}setupMessageAnalysisListener(){this.ipc.on("collab:new-message",async e=>{let t=this._currentExecution();if(!t||t.status!=="running")return;let n={role:e.role||"customer",content:e.content,timestamp:new Date().toISOString(),isFromCustomer:e.isFromCustomer??!0};t.messageHistory=[...t.messageHistory||[],n],this._currentExecution.set(c({},t));let s=t.messageHistory?.length||0;s>0&&s%this.analysisInterval===0&&(console.log(`[DynamicEngine] \u89F8\u767C\u7B2C ${t.stats.analysisCount+1} \u6B21\u5206\u6790 (${s} \u689D\u6D88\u606F)`),await this.performDynamicAnalysis(t)),t.mode==="scriptless"&&e.isFromCustomer&&await this.checkConversionSignals(t,e.content)}),this.ipc.on("collab:customer-reply",async e=>{let t=this._currentExecution();t&&(t.stats.responsesReceived++,this._currentExecution.set(c({},t)),t.conversionFunnel?.currentStage==="contact"&&this.updateConversionStage(t,"response",e.content))})}async smartMatchAccountsToRoles(e,t){return this.smartMatchAccountsToRolesEnhanced(e,t,{})}async smartMatchAccountsToRolesEnhanced(e,t,n){let{allowMultiRole:s=!1,allowOffline:o=!1}=n,i=this.accountService.accounts(),a=i.filter(d=>d.status==="Online"),r={AI:1,Sender:2,Listener:3},u=a.sort((d,m)=>(r[d.role]||99)-(r[m.role]||99));if(console.log(`[DynamicEngine] \u{1F50D} Phase 3 \u5E33\u865F\u7BE9\u9078: \u5728\u7DDA ${a.length} \u500B, \u5168\u90E8\u53EF\u7528\u65BC\u591A\u89D2\u8272`),console.log("[DynamicEngine] \u{1F50D} \u53EF\u7528\u5E33\u865F\u660E\u7D30:",u.map(d=>`${d.phone}(${d.role})`)),u.length===0&&o&&(u=i.filter(d=>d.status==="Offline"&&!d.status.toLowerCase().includes("error")&&!d.status.toLowerCase().includes("banned")),u.length>0&&console.log("[DynamicEngine] \u964D\u7D1A: \u4F7F\u7528\u96E2\u7DDA\u5E33\u865F\uFF08\u9700\u8981\u5148\u9023\u7DDA\uFF09")),u.length===0)return console.log("[DynamicEngine] \u7121\u53EF\u7528\u5E33\u865F"),[];let g=[],f=new Set,l=new Map,v=!s;v&&console.log("[DynamicEngine] \u{1F512} \u56B4\u683C\u6A21\u5F0F\uFF1A\u4E00\u5E33\u865F\u4E00\u89D2\u8272");for(let d of e){let m=null;for(let b of u){if(v&&f.has(b.id)){console.log(`[DynamicEngine] \u23ED\uFE0F \u8DF3\u904E\u5DF2\u4F7F\u7528\u5E33\u865F: ${b.phone}`);continue}let x=(l.get(b.id)||0)*20,{score:N,reasons:q}=this.calculateAccountRoleMatch(b,d,t),F=Math.max(0,N-x);(!m||F>m.score)&&(m={account:b,score:F,reasons:q})}if(m&&m.score>=10){f.add(m.account.id),l.set(m.account.id,(l.get(m.account.id)||0)+1);let b=this.analyzeAccountFeatures(m.account),p=l.get(m.account.id)||1;g.push({accountId:m.account.id,accountPhone:m.account.phone,accountName:m.account.name||m.account.phone,roleId:d.id,roleName:d.name,roleIcon:d.icon,matchScore:m.score,matchReasons:p>1?[...m.reasons,`\u4E00\u865F\u591A\u89D2 (${p} \u89D2\u8272)`]:m.reasons,accountFeatures:b})}else if(m)console.log(`[DynamicEngine] \u26A1 \u5F37\u5236\u5206\u914D\u4F4E\u5206\u5E33\u865F: ${m.account.phone} (\u5206\u6578: ${m.score})`),f.add(m.account.id),l.set(m.account.id,(l.get(m.account.id)||0)+1),g.push({accountId:m.account.id,accountPhone:m.account.phone,accountName:m.account.name||m.account.phone,roleId:d.id,roleName:d.name,roleIcon:d.icon,matchScore:m.score,matchReasons:[...m.reasons,"\u5F37\u5236\u5206\u914D(\u5206\u6578\u8F03\u4F4E)"],accountFeatures:this.analyzeAccountFeatures(m.account)});else if(s&&u.length>0){let b=u[0];l.set(b.id,(l.get(b.id)||0)+1);let p=l.get(b.id)||1;g.push({accountId:b.id,accountPhone:b.phone,accountName:b.name||b.phone,roleId:d.id,roleName:d.name,roleIcon:d.icon,matchScore:30,matchReasons:["\u81EA\u52D5\u5206\u914D",`\u4E00\u865F\u591A\u89D2 (${p} \u89D2\u8272)`],accountFeatures:this.analyzeAccountFeatures(b)})}}this._accountMatches.set(g);let h=i.filter(d=>d.status==="Online"&&!g.some(m=>m.accountId===d.id));return console.log("[DynamicEngine] \u2705 \u667A\u80FD\u5339\u914D\u7D50\u679C:",g.length,"\u500B\u5E33\u865F"),g.forEach(d=>{console.log(`  - ${d.accountPhone} \u2192 ${d.roleName} (\u5206\u6578: ${d.matchScore})`)}),h.length>0&&(console.log("[DynamicEngine] \u26A0\uFE0F \u672A\u4F7F\u7528\u7684\u5728\u7DDA\u5E33\u865F:",h.length,"\u500B"),h.forEach(d=>{let m=d.role==="Listener"?"\u76E3\u63A7\u865F(\u4FDD\u7559\u7528\u65BC\u76E3\u63A7)":f.has(d.id)?"\u5DF2\u5206\u914D\u5176\u4ED6\u89D2\u8272":"\u5339\u914D\u5206\u6578\u4E0D\u8DB3";console.log(`  - ${d.phone} (${d.role}): ${m}`)})),g}calculateAccountRoleMatch(e,t,n){let s=50,o=[];e.status==="Online"&&(s+=10,o.push("\u5E33\u865F\u5728\u7DDA"));let i=this.analyzeNameStyle(e.name),a=this.getRoleExpectedStyle(t.type);return i===a?(s+=20,o.push(`\u540D\u7A31\u98A8\u683C\u5339\u914D (${i})`)):i==="neutral"&&(s+=10,o.push("\u540D\u7A31\u98A8\u683C\u4E2D\u6027\uFF0C\u9069\u61C9\u6027\u5F37")),t.type==="professional"&&this.looksLikeProfessional(e)&&(s+=15,o.push("\u5E33\u865F\u770B\u8D77\u4F86\u5C08\u696D")),t.type==="endorsement"&&this.looksLikeFriendly(e)&&(s+=15,o.push("\u5E33\u865F\u770B\u8D77\u4F86\u89AA\u548C")),t.type==="atmosphere"&&this.looksLikeCasual(e)&&(s+=15,o.push("\u5E33\u865F\u770B\u8D77\u4F86\u8F15\u9B06")),{score:Math.min(100,s),reasons:o}}analyzeAccountFeatures(e){return{profileStyle:this.analyzeNameStyle(e.name),activityLevel:"medium",successRate:0,responseRate:0}}analyzeNameStyle(e){let t=(e||"").toLowerCase();return["manager","director","expert","consultant","\u7D93\u7406","\u9867\u554F","\u5C08\u5BB6","\u7E3D\u76E3"].some(i=>t.includes(i))?"professional":["\u5C0F","\u963F","\u54E5","\u59D0","\u5BF6","\u840C","happy","sunny","sweet"].some(i=>t.includes(i))?"friendly":["cool","chill","\u61F6","\u96A8","random","just"].some(i=>t.includes(i))?"casual":"neutral"}getRoleExpectedStyle(e){return{professional:"professional",endorsement:"friendly",atmosphere:"casual",care:"friendly",solution:"professional",retention:"professional",host:"friendly",participant:"casual",expert:"professional"}[e]||"neutral"}looksLikeProfessional(e){let t=(e.name||"").toLowerCase();return t.includes("manager")||t.includes("\u7D93\u7406")||t.includes("\u9867\u554F")||t.includes("director")||t.includes("\u7E3D\u76E3")}looksLikeFriendly(e){let t=(e.name||"").toLowerCase();return t.includes("\u5C0F")||t.includes("\u963F")||t.includes("\u59D0")||t.includes("happy")||t.includes("sunny")}looksLikeCasual(e){let t=(e.name||"").toLowerCase();return t.includes("cool")||t.includes("chill")||t.length<=3}setExecutionMode(e){this._executionMode.set(e),console.log("[DynamicEngine] \u57F7\u884C\u6A21\u5F0F\u8A2D\u7F6E\u70BA:",e)}async startFromOnePhrase(e,t="hybrid",n,s){if(!e.trim())return this.toast.error("\u8ACB\u8F38\u5165\u60A8\u7684\u76EE\u6A19"),null;this._isProcessing.set(!0),this._executionMode.set(t);let o=s?.chatScenario||"private";console.log(`[DynamicEngine] \u555F\u52D5\u6A21\u5F0F: ${t}, \u5834\u666F: ${o}`);try{let i=await this.analyzeIntent(e),a=this.generateStrategy(i),r=this.recommendRoles(i);console.log("[DynamicEngine] \u{1F50D} \u63A8\u85A6\u89D2\u8272:",r?.length,r);let u=!n||n.length<=1;u&&(console.log("[DynamicEngine] \u{1F512} \u79C1\u804A\u6A21\u5F0F\uFF1A\u9650\u5236\u70BA\u55AE\u4E00\u89D2\u8272"),r=r.slice(0,K),this.toast.info("\u{1F4AC} \u79C1\u804A\u6A21\u5F0F\uFF1A\u4F7F\u7528\u55AE\u4E00\u89D2\u8272\u8207\u76EE\u6A19\u7528\u6236\u5C0D\u8A71"));let g=await this.smartMatchAccountsToRoles(r,i);if(console.log("[DynamicEngine] \u{1F50D} \u5E33\u865F\u5339\u914D\u7D50\u679C:",g?.length,g),g.length<r.length){let p=r.length-g.length;if(console.warn(`[DynamicEngine] \u26A0\uFE0F \u5E33\u865F\u4E0D\u8DB3\uFF1A\u9700\u8981 ${r.length} \u500B\uFF0C\u53EA\u6709 ${g.length} \u500B`),this.toast.warning(`\u26A0\uFE0F \u5E33\u865F\u4E0D\u8DB3\uFF01\u9700\u8981\u518D\u767B\u5165 ${p} \u500B\u5E33\u865F\u624D\u80FD\u5B8C\u6574\u57F7\u884C\u591A\u89D2\u8272\u5354\u4F5C`),!u&&g.length===0)return this.toast.error("\u274C \u6C92\u6709\u53EF\u7528\u5E33\u865F\uFF0C\u7121\u6CD5\u555F\u52D5\u3002\u8ACB\u5148\u6DFB\u52A0\u4E26\u767B\u5165\u5E33\u865F\u3002"),null;r=r.slice(0,Math.max(1,g.length))}let f=r.map(p=>{let x=g.find(N=>N.roleId===p.id);return x?S(c({},p),{accountId:x.accountId,accountPhone:x.accountPhone}):p}),l=n?.map(p=>({id:p.telegramId||p.id,telegramId:p.telegramId||p.id,username:p.username,firstName:p.firstName,lastName:p.lastName,intentScore:p.intentScore,source:p.source}));l&&l.length>0&&(console.log("[DynamicEngine] \u{1F3AF} \u683C\u5F0F\u5316\u76EE\u6A19\u7528\u6236:"),l.forEach(p=>{console.log(`  - ${p.firstName||p.username||"unknown"}: id=${p.id}, telegramId=${p.telegramId}`)}));let v=l?.map(p=>String(p.id))||[],h=v.length>0?{totalUsers:v.length,processedUsers:0,currentUserIndex:0,currentUser:l?.[0]?{id:String(l[0].id),name:l[0].firstName||l[0].username||String(l[0].id),startTime:new Date().toISOString()}:void 0,completedUsers:[],pendingUsers:v.slice(1)}:void 0,d={id:`exec_${Date.now()}`,status:"planning",goal:e,intent:i,strategy:a,roles:f,mode:t,accountMatches:g,targetUsers:l,scriptlessConfig:t==="scriptless"?S(c({},this.defaultScriptlessConfig),{enabled:!0}):void 0,conversionFunnel:{currentStage:"contact",stageHistory:[{stage:"contact",enteredAt:new Date().toISOString(),messageCount:0}],keyMoments:[]},queue:h,groupConfig:o==="group"?{groupId:s?.groupId,roleAccounts:s?.roleAccounts,chatScenario:"group"}:void 0,chatScenario:o,stats:{startTime:new Date().toISOString(),messagesSent:0,responsesReceived:0,currentPhase:0,interestScore:0,lastAnalysis:null,analysisCount:0,rolesSwitchCount:0,autoAdjustments:0},messageHistory:[]};this._currentExecution.set(d),this._executions.update(p=>[d,...p]),this.persistExecution(d);let m=t==="scriptless"?"\u7121\u5287\u672C":t==="scripted"?"\u5287\u672C":"\u6DF7\u5408",b=l?.length||0;return this.toast.success(`AI \u5DF2\u7406\u89E3\u60A8\u7684\u76EE\u6A19\uFF0C${m}\u6A21\u5F0F\u6E96\u5099\u5C31\u7DD2\uFF0C\u5339\u914D\u4E86 ${g.length} \u500B\u5E33\u865F${b>0?`\uFF0C\u76EE\u6A19 ${b} \u500B\u7528\u6236`:""}`),l&&l.length>0&&setTimeout(()=>{this.beginPrivateChatExecution(d)},1500),d}catch(i){return this.toast.error("\u7B56\u5283\u5931\u6557\uFF0C\u8ACB\u91CD\u8A66"),console.error("[DynamicEngine] Start failed:",i),null}finally{this._isProcessing.set(!1)}}async startWithMarketingStrategy(e,t){this._isProcessing.set(!0);try{console.log("[DynamicEngine] \u63A5\u6536 AI \u71DF\u92B7\u7B56\u7565:",t);let n={type:"sales_conversion",confidence:90,goal:`\u5728${t.industry}\u884C\u696D\uFF0C\u4FC3\u9032${t.targetAudience}\u6210\u4EA4`,targetAudience:t.targetAudience,productType:t.industry,urgency:"medium",suggestedDuration:"3-5\u5929"},s=this.generateEnhancedStrategy(n,t),o=this.recommendRoles(n),i={id:`exec_${Date.now()}`,status:"planning",goal:e,intent:n,strategy:s,roles:o,mode:"hybrid",stats:{startTime:new Date().toISOString(),messagesSent:0,responsesReceived:0,currentPhase:0,interestScore:0,lastAnalysis:null,analysisCount:0,rolesSwitchCount:0,autoAdjustments:0},marketingData:t};return this._currentExecution.set(i),this._executions.update(a=>[i,...a]),this.toast.success("\u{1F916} AI \u5DF2\u6574\u5408\u71DF\u92B7\u7B56\u7565\uFF0C\u6E96\u5099\u57F7\u884C\u6700\u512A\u65B9\u6848\uFF01"),i}catch(n){return this.toast.error("\u7B56\u7565\u6574\u5408\u5931\u6557\uFF0C\u8ACB\u91CD\u8A66"),console.error("[DynamicEngine] Marketing strategy start failed:",n),null}finally{this._isProcessing.set(!1)}}generateEnhancedStrategy(e,t){let n=this.generateStrategy(e);return S(c({},n),{name:`${t.industry} - AI \u71DF\u92B7\u7B56\u7565`,description:`\u91DD\u5C0D\u300C${t.targetAudience}\u300D\u7684\u667A\u80FD\u71DF\u92B7\u7B56\u7565\uFF0C\u4F7F\u7528\u95DC\u9375\u8A5E\uFF1A${t.keywords.highIntent.slice(0,3).join("\u3001")}`,messageTemplates:t.messageTemplates,keywords:t.keywords})}async analyzeIntent(e){let t=e.toLowerCase(),n="custom",s=0;for(let[i,a]of Object.entries(this.intentTemplates)){let r=a.keywords.filter(u=>t.includes(u)).length;r>s&&(s=r,n=i)}let o=this.intentTemplates[n];return{type:n,confidence:Math.min(95,50+s*15),goal:n==="custom"?e:o.description,targetAudience:this.extractTargetAudience(t),productType:this.extractProductType(t),urgency:this.determineUrgency(t),suggestedDuration:this.suggestDuration(n)}}generateStrategy(e){let t=this.intentTemplates[e.type];return{id:`strategy_${Date.now()}`,name:`${e.goal} - \u52D5\u614B\u7B56\u7565`,description:`AI \u6839\u64DA\u300C${e.goal}\u300D\u81EA\u52D5\u751F\u6210\u7684\u52D5\u614B\u57F7\u884C\u7B56\u7565`,phases:t.defaultPhases,adjustmentRules:this.generateAdjustmentRules(e),constraints:{maxDailyMessages:50,maxConsecutiveFromSameRole:3,minIntervalSeconds:60,maxIntervalSeconds:300,activeHours:{start:9,end:22},toneGuidelines:["\u53CB\u597D\u81EA\u7136","\u4E0D\u904E\u5EA6\u63A8\u92B7","\u50CF\u670B\u53CB\u804A\u5929"],forbiddenTopics:["\u653F\u6CBB","\u654F\u611F\u8A71\u984C"]}}}recommendRoles(e){return this.intentTemplates[e.type].defaultRoles}generateAdjustmentRules(e){return[{trigger:"\u5BA2\u6236\u60C5\u7DD2\u8CA0\u9762",condition:{type:"sentiment",threshold:30},action:"\u66AB\u505C\u63A8\u92B7\uFF0C\u5207\u63DB\u5230\u95DC\u61F7\u6A21\u5F0F"},{trigger:"\u5BA2\u6236\u8A62\u554F\u50F9\u683C",condition:{type:"keyword",keywords:["\u591A\u5C11\u9322","\u50F9\u683C","\u8CBB\u7528","\u8CB4\u4E0D\u8CB4"]},action:"\u9019\u662F\u6210\u4EA4\u4FE1\u865F\uFF01\u5F15\u5165\u92B7\u552E\u5C08\u5BB6"},{trigger:"\u5BA2\u6236\u63D0\u5230\u7AF6\u54C1",condition:{type:"keyword",keywords:["\u5176\u4ED6","\u5225\u5BB6","\u7AF6\u54C1","\u5C0D\u6BD4"]},action:"\u5F15\u5165\u5C0D\u6BD4\u5206\u6790\uFF0C\u7A81\u51FA\u512A\u52E2"},{trigger:"\u5C0D\u8A71\u6C89\u9ED8",condition:{type:"silence",threshold:3600},action:"\u767C\u8D77\u65B0\u8A71\u984C\u6216\u63DB\u89D2\u8272\u6D3B\u8E8D"},{trigger:"\u8208\u8DA3\u5EA6\u4E0A\u5347",condition:{type:"interest",threshold:70},action:"\u53EF\u4EE5\u958B\u59CB\u50F9\u503C\u5C55\u793A\u548C\u4FC3\u55AE"}]}async analyzeConversation(e){let t=e.filter(r=>r.isFromCustomer),n=e.length>0?t.length/e.length*100:0,s=this.analyzeSentiment(t),o=this.extractInterests(t),i=this.calculateReadiness(t,s),a=this.generateSuggestions(s,i,o);return{timestamp:new Date().toISOString(),messageCount:e.length,userProfile:{engagementLevel:n>50?"high":n>20?"medium":"low",sentiment:s,interests:o,objections:this.extractObjections(t),readinessScore:i},conversationQuality:{responseRate:n,avgResponseTime:0,topicEngagement:{}},suggestions:a}}async generateNextMessage(e){if(!e.strategy||e.roles.length===0)return null;let t=e.stats.lastAnalysis,s=e.strategy.phases[e.stats.currentPhase]?.rolesFocus||[],o=e.roles.find(r=>s.includes(r.id))||e.roles[0],i="casual";t&&(t.userProfile.readinessScore>70?i="close":t.userProfile.objections.length>0?i="objection_handling":t.userProfile.engagementLevel==="high"&&(i="value"));let a=o.sampleMessages[Math.floor(Math.random()*o.sampleMessages.length)];return{role:o,content:a,type:i}}generateTopicSuggestions(){let t=new Date().getHours(),n=[];return t>=6&&t<10?n.push({type:"casual",content:"\u65E9\u5B89\u554F\u5019\uFF0C\u804A\u804A\u4ECA\u5929\u7684\u8A08\u5283",context:"\u65E9\u6668\u9069\u5408\u8F15\u9B06\u554F\u5019",suitableRoles:["friendly_member","community_host"]}):t>=11&&t<13?n.push({type:"life",content:"\u5348\u9910\u8A71\u984C\uFF0C\u804A\u804A\u7F8E\u98DF",context:"\u5348\u9910\u6642\u9593\u8A71\u984C",suitableRoles:["active_member_1","active_member_2"]}):t>=18&&t<20&&n.push({type:"casual",content:"\u4E0B\u73ED\u8A71\u984C\uFF0C\u804A\u804A\u4ECA\u5929\u7684\u8DA3\u4E8B",context:"\u665A\u9593\u8F15\u9B06\u804A\u5929",suitableRoles:["friendly_member"]}),n.push({type:"news",content:"\u6700\u8FD1\u7684\u71B1\u9EDE\u65B0\u805E\u8A0E\u8AD6",context:"\u53EF\u4EE5\u7D50\u5408\u7522\u54C1\u5834\u666F",suitableRoles:["opinion_leader","community_host"]}),n}getConversionFunnelStats(){let e=this._executions(),t={contact:0,response:0,interest:0,intent:0,conversion:0},n={contact:[],response:[],interest:[],intent:[],conversion:[]},s={};for(let f of e){if(!f.conversionFunnel)continue;t[f.conversionFunnel.currentStage]++;let l=f.conversionFunnel.stageHistory;for(let v=0;v<l.length-1;v++){let h=l[v],d=l[v+1],m=new Date(d.enteredAt).getTime()-new Date(h.enteredAt).getTime();n[h.stage]?.push(m/1e3/60)}for(let v of f.conversionFunnel.keyMoments)s[v.trigger]=(s[v.trigger]||0)+1}let o=["contact","response","interest","intent","conversion"],i=e.length||1,a=i,r=o.map(f=>{let l=t[f],v=Math.round(a/i*100);return a=a-l+t[f],{stage:f,count:l,rate:v}}),u={};for(let[f,l]of Object.entries(n))u[f]=l.length>0?Math.round(l.reduce((v,h)=>v+h,0)/l.length):0;let g=Object.entries(s).map(([f,l])=>({trigger:f,count:l})).sort((f,l)=>l.count-f.count).slice(0,10);return{totalExecutions:e.length,funnelData:r,avgTimePerStage:u,topKeyMoments:g}}recordKeyMoment(e,t,n){let s=this._executions().find(o=>o.id===e);!s||!s.conversionFunnel||(s.conversionFunnel.keyMoments.push({message:t,trigger:n,stage:s.conversionFunnel.currentStage,timestamp:new Date().toISOString()}),this._executions.update(o=>o.map(i=>i.id===e?s:i)),this._currentExecution()?.id===e&&this._currentExecution.set(c({},s)),console.log(`[DynamicEngine] \u8A18\u9304\u95DC\u9375\u6642\u523B: ${n} - ${t.substring(0,30)}...`))}getExecutionReport(e){let t=this._executions().find(l=>l.id===e);if(!t)return null;let n=new Date(t.stats.startTime),o=(t.status==="completed"?new Date:new Date).getTime()-n.getTime(),i=Math.round(o/1e3/60),a={},r={};for(let l of t.messageHistory||[])l.isFromCustomer||(a[l.role]=(a[l.role]||0)+1);let u=t.roles.map(l=>({roleId:l.id,roleName:l.name,messageCount:a[l.id]||0,responseRate:a[l.id]>0?Math.round((r[l.id]||0)/a[l.id]*100):0})),g=(t.conversionFunnel?.stageHistory||[]).map((l,v,h)=>{let d=h[v+1],m=d?Math.round((new Date(d.enteredAt).getTime()-new Date(l.enteredAt).getTime())/1e3/60):0;return{stage:l.stage,enteredAt:l.enteredAt,duration:m>0?`${m} \u5206\u9418`:"\u9032\u884C\u4E2D"}}),f="\u9032\u884C\u4E2D";return t.status==="completed"&&(t.conversionFunnel?.currentStage==="conversion"?f="\u2705 \u8F49\u5316\u6210\u529F":t.stats.interestScore<30?f="\u274C \u672A\u8F49\u5316 - \u8208\u8DA3\u5EA6\u4F4E":f="\u23F8\uFE0F \u672A\u8F49\u5316 - \u5F85\u8DDF\u9032"),{summary:{goal:t.goal,mode:t.mode,duration:i>60?`${Math.floor(i/60)} \u5C0F\u6642 ${i%60} \u5206\u9418`:`${i} \u5206\u9418`,messagesSent:t.stats.messagesSent,responsesReceived:t.stats.responsesReceived,analysisCount:t.stats.analysisCount,finalInterestScore:t.stats.interestScore,outcome:f},rolePerformance:u,funnelProgress:g,keyMoments:t.conversionFunnel?.keyMoments||[],aiAdjustments:[]}}getOverallStats(){let e=this._executions(),t=e.filter(r=>r.status==="completed"),n=t.filter(r=>r.conversionFunnel?.currentStage==="conversion"),s=e.reduce((r,u)=>r+u.stats.messagesSent,0),o=e.reduce((r,u)=>r+u.stats.interestScore,0),i={};for(let r of e)i[r.mode]=(i[r.mode]||0)+1;let a={};for(let r of e){let u=r.goal.substring(0,20);a[u]=(a[u]||0)+1}return{totalExecutions:e.length,completedExecutions:t.length,conversionRate:t.length>0?Math.round(n.length/t.length*100):0,avgMessagesPerExecution:e.length>0?Math.round(s/e.length):0,avgInterestScore:e.length>0?Math.round(o/e.length):0,modeDistribution:Object.entries(i).map(([r,u])=>({mode:r,count:u})),topGoals:Object.entries(a).map(([r,u])=>({goal:r,count:u})).sort((r,u)=>u.count-r.count).slice(0,5)}}extractTargetAudience(e){return e.includes("\u7FA4")?"\u7FA4\u6210\u54E1":e.includes("\u5BA2\u6236")?"\u6F5B\u5728\u5BA2\u6236":e.includes("\u8001")?"\u8001\u5BA2\u6236":"\u76EE\u6A19\u7528\u6236"}extractProductType(e){return e.includes("\u8AB2\u7A0B")||e.includes("\u6559\u80B2")?"\u6559\u80B2\u8AB2\u7A0B":e.includes("\u7522\u54C1")?"\u5BE6\u9AD4\u7522\u54C1":e.includes("\u670D\u52D9")?"\u670D\u52D9\u985E":"\u7522\u54C1/\u670D\u52D9"}determineUrgency(e){return e.includes("\u99AC\u4E0A")||e.includes("\u7ACB\u5373")||e.includes("\u4ECA\u5929")?"high":e.includes("\u76E1\u5FEB")||e.includes("\u9019\u9031")?"medium":"low"}suggestDuration(e){return{sales_conversion:"3-7\u5929",churn_recovery:"1-3\u5929",community_activation:"\u6301\u7E8C\u9032\u884C",customer_support:"\u5373\u6642\u8655\u7406",brand_promotion:"\u6301\u7E8C\u9032\u884C",lead_nurturing:"2-4\u9031",custom:"\u6839\u64DA\u60C5\u6CC1\u8ABF\u6574"}[e]}analyzeSentiment(e){let t=e.map(a=>a.content).join(" "),n=["\u597D","\u68D2","\u559C\u6B61","\u8B1D\u8B1D","\u611F\u8B1D","\u8B9A","\u4E0D\u932F"],s=["\u4E0D\u597D","\u5DEE","\u5931\u671B","\u751F\u6C23","\u6295\u8A34","\u9000","\u721B"],o=n.filter(a=>t.includes(a)).length,i=s.filter(a=>t.includes(a)).length;return o>i?"positive":i>o?"negative":"neutral"}extractInterests(e){let t=[],n=e.map(s=>s.content).join(" ");return(n.includes("\u50F9\u683C")||n.includes("\u591A\u5C11\u9322"))&&t.push("\u50F9\u683C\u654F\u611F"),(n.includes("\u6548\u679C")||n.includes("\u6709\u7528\u55CE"))&&t.push("\u6548\u679C\u95DC\u6CE8"),(n.includes("\u600E\u9EBC\u7528")||n.includes("\u4F7F\u7528"))&&t.push("\u4F7F\u7528\u65B9\u6CD5"),t}extractObjections(e){let t=[],n=e.map(s=>s.content).join(" ");return(n.includes("\u592A\u8CB4")||n.includes("\u8CB4\u4E86"))&&t.push("\u50F9\u683C\u9867\u616E"),(n.includes("\u6C92\u7528")||n.includes("\u4E0D\u9700\u8981"))&&t.push("\u9700\u6C42\u4E0D\u660E\u78BA"),(n.includes("\u8003\u616E")||n.includes("\u518D\u8AAA"))&&t.push("\u6C7A\u7B56\u7336\u8C6B"),t}calculateReadiness(e,t){let n=30,s=e.map(o=>o.content).join(" ");return(s.includes("\u600E\u9EBC\u8CB7")||s.includes("\u5728\u54EA\u8CB7"))&&(n+=30),(s.includes("\u591A\u5C11\u9322")||s.includes("\u50F9\u683C"))&&(n+=20),(s.includes("\u6709\u6D3B\u52D5\u55CE")||s.includes("\u512A\u60E0"))&&(n+=15),t==="positive"&&(n+=10),(s.includes("\u4E0D\u9700\u8981")||s.includes("\u4E0D\u7528\u4E86"))&&(n-=20),t==="negative"&&(n-=15),Math.max(0,Math.min(100,n))}generateSuggestions(e,t,n){let s="continue",o="friendly_member",i="\u7E7C\u7E8C\u8F15\u9B06\u804A\u5929",a="\u4FDD\u6301\u53CB\u597D",r="\u5C0D\u8A71\u9032\u884C\u6B63\u5E38";return t>70?(s="close",o="sales_expert",i="\u7522\u54C1\u50F9\u503C\u548C\u512A\u60E0",a="\u53EF\u4EE5\u66F4\u76F4\u63A5",r="\u5BA2\u6236\u6E96\u5099\u5EA6\u9AD8\uFF0C\u53EF\u4EE5\u4FC3\u55AE"):e==="negative"?(s="pause",o="cs_agent",i="\u95DC\u5FC3\u548C\u50BE\u807D",a="\u66F4\u52A0\u6EAB\u548C\u8010\u5FC3",r="\u5BA2\u6236\u60C5\u7DD2\u8CA0\u9762\uFF0C\u9700\u8981\u95DC\u61F7"):n.includes("\u50F9\u683C\u654F\u611F")&&(s="escalate",o="sales_expert",i="\u50F9\u503C\u512A\u5148\uFF0C\u518D\u8AC7\u50F9\u683C",r="\u5BA2\u6236\u95DC\u6CE8\u50F9\u683C\uFF0C\u9700\u8981\u5F37\u8ABF\u50F9\u503C"),{nextAction:s,recommendedRole:o,topicSuggestion:i,toneAdjustment:a,reasoning:r}}async performDynamicAnalysis(e){if(!e.messageHistory||e.messageHistory.length===0)return;console.log("[DynamicEngine] \u57F7\u884C\u52D5\u614B\u5206\u6790...");let t=e.messageHistory.slice(-this.analysisInterval),n=await this.analyzeConversation(t);e.stats.lastAnalysis=n,e.stats.analysisCount++,e.stats.interestScore=n.userProfile.readinessScore;let s=this.makeAutoAdjustment(e,n);s.shouldAdjust&&(e.stats.autoAdjustments++,this.toast.info(`\u{1F4CA} \u7B2C ${e.stats.analysisCount} \u6B21\u5206\u6790: ${s.reason}`),this.ipc.send("ai-team:adjust-strategy",{executionId:e.id,adjustment:s})),this.updateFunnelFromAnalysis(e,n),this._currentExecution.set(c({},e)),this._executions.update(o=>o.map(i=>i.id===e.id?e:i))}makeAutoAdjustment(e,t){let{suggestions:n,userProfile:s}=t;if(s.readinessScore>70&&e.strategy){let o=Math.min(e.stats.currentPhase+1,e.strategy.phases.length-1);if(o>e.stats.currentPhase)return{shouldAdjust:!0,action:"advance_phase",reason:`\u5BA2\u6236\u8208\u8DA3\u5EA6 ${s.readinessScore}%\uFF0C\u63A8\u9032\u5230\u4FC3\u55AE\u968E\u6BB5`,newPhase:o}}return s.sentiment==="negative"?{shouldAdjust:!0,action:"switch_role",reason:"\u5BA2\u6236\u60C5\u7DD2\u8CA0\u9762\uFF0C\u5207\u63DB\u5230\u95DC\u61F7\u6A21\u5F0F",newRole:"cs_agent"}:s.engagementLevel==="low"&&e.stats.messagesSent>5?{shouldAdjust:!0,action:"activate_atmosphere",reason:"\u4E92\u52D5\u5EA6\u4F4E\uFF0C\u5F15\u5165\u6D3B\u8E8D\u89D2\u8272",newRole:"friendly_member"}:s.objections.includes("\u50F9\u683C\u9867\u616E")?{shouldAdjust:!0,action:"handle_objection",reason:"\u5BA2\u6236\u6709\u50F9\u683C\u9867\u616E\uFF0C\u5F15\u5165\u5C08\u5BB6\u8655\u7406",newRole:"sales_expert"}:{shouldAdjust:!1,action:"continue",reason:"\u4FDD\u6301\u7576\u524D\u7B56\u7565"}}updateFunnelFromAnalysis(e,t){if(!e.conversionFunnel)return;let{readinessScore:n,interests:s}=t.userProfile,o=e.conversionFunnel.currentStage;o==="response"&&s.length>0?this.updateConversionStage(e,"interest","\u5BA2\u6236\u8868\u73FE\u51FA\u8208\u8DA3"):o==="interest"&&n>60?this.updateConversionStage(e,"intent","\u5BA2\u6236\u6709\u8CFC\u8CB7\u610F\u5411"):o==="intent"&&n>85&&this.updateConversionStage(e,"conversion","\u5373\u5C07\u6210\u4EA4")}updateConversionStage(e,t,n){if(!e.conversionFunnel)return;let s=e.messageHistory?.length||0;e.conversionFunnel.currentStage=t,e.conversionFunnel.stageHistory.push({stage:t,enteredAt:new Date().toISOString(),messageCount:s}),e.conversionFunnel.keyMoments.push({message:n,trigger:`\u9032\u5165 ${t} \u968E\u6BB5`,stage:t,timestamp:new Date().toISOString()}),console.log(`[DynamicEngine] \u8F49\u5316\u6F0F\u6597: ${t}`,n)}detectConversionSignal(e){let t=e.toLowerCase();for(let n of this.conversionSignals.converted)if(t.includes(n))return{hasSignal:!0,signalType:"converted",matchedKeyword:n,score:100};for(let n of this.conversionSignals.high)if(t.includes(n))return{hasSignal:!0,signalType:"high",matchedKeyword:n,score:85};for(let n of this.conversionSignals.medium)if(t.includes(n))return{hasSignal:!0,signalType:"medium",matchedKeyword:n,score:60};for(let n of this.conversionSignals.positive)if(t.includes(n))return{hasSignal:!0,signalType:"positive",matchedKeyword:n,score:40};for(let n of this.conversionSignals.negative)if(t.includes(n))return{hasSignal:!0,signalType:"negative",matchedKeyword:n,score:-30};return{hasSignal:!1,signalType:null,matchedKeyword:null,score:0}}handleConversionSignal(e,t,n){switch(console.log("[DynamicEngine] \u{1F3AF} \u8F49\u5316\u4FE1\u865F:",n),e.conversionFunnel&&e.conversionFunnel.keyMoments.push({message:t.text,trigger:`${n.signalType}: ${n.matchedKeyword}`,stage:n.signalType||"unknown",timestamp:new Date().toISOString()}),n.signalType){case"converted":this.toast.success(`\u{1F389} \u5BA2\u6236 ${t.firstName||"\u7528\u6236"} \u5DF2\u6210\u4EA4\uFF01`),this.updateConversionStage(e,"conversion",t.text),this.completeCurrentUser&&this.completeCurrentUser("converted");break;case"high":this.toast.success(`\u{1F3AF} \u9AD8\u8F49\u5316\u4FE1\u865F\uFF01${t.firstName||"\u7528\u6236"}: "${n.matchedKeyword}"`),this.updateConversionStage(e,"intent",t.text),this.ipc.send("ai-team:conversion-signal",{executionId:e.id,userId:t.userId,userName:t.firstName||t.username,signal:n.matchedKeyword,signalType:n.signalType,score:n.score});break;case"medium":this.updateConversionStage(e,"interest",t.text);break;case"positive":e.conversionFunnel?.currentStage==="contact"&&this.updateConversionStage(e,"response",t.text);break;case"negative":this.toast.warning(`\u26A0\uFE0F \u5BA2\u6236 ${t.firstName||"\u7528\u6236"} \u8868\u9054\u4E86\u62D2\u7D55\u610F\u5411`);break}this._currentExecution.set(c({},e))}updateIntentScore(e,t){let n=this.detectConversionSignal(t);n.score!==0&&(e.stats.interestScore=Math.max(0,Math.min(100,(e.stats.interestScore||0)+n.score)),this._currentExecution.set(c({},e)))}async checkConversionSignals(e,t){if(!e.scriptlessConfig)return;let n=t.toLowerCase();e.scriptlessConfig.targetConversionSignals.some(i=>n.includes(i))&&(console.log("[DynamicEngine] \u6AA2\u6E2C\u5230\u8F49\u5316\u4FE1\u865F:",t),e.conversionFunnel?.keyMoments.push({message:t,trigger:"\u8F49\u5316\u4FE1\u865F",stage:"conversion_signal",timestamp:new Date().toISOString()}),this.ipc.send("ai-team:conversion-signal",{executionId:e.id,signal:t,recommendedRole:"sales_expert"}),this.toast.success("\u{1F3AF} \u6AA2\u6E2C\u5230\u8F49\u5316\u4FE1\u865F\uFF01\u6B63\u5728\u5B89\u6392\u92B7\u552E\u5C08\u5BB6\u8DDF\u9032...")),e.scriptlessConfig.exitConditions.successSignals.some(i=>n.includes(i))&&(console.log("[DynamicEngine] \u6AA2\u6E2C\u5230\u6210\u529F\u4FE1\u865F:",t),this.updateConversionStage(e,"conversion",t),this.toast.success("\u{1F389} \u606D\u559C\uFF01\u5BA2\u6236\u5DF2\u8F49\u5316\u6210\u529F\uFF01")),this._currentExecution.set(c({},e))}async generateScriptlessMessage(e){if(e.mode!=="scriptless"||!e.scriptlessConfig?.enabled)return null;let t=e.stats.lastAnalysis,n=e.messageHistory||[],s=e.stats.currentPhase,o=this.selectRoleForScriptless(e,t);if(!o)return null;let i=this.buildScriptlessPrompt(e,o,n);return new Promise(a=>{this.ipc.send("ai-team:generate-scriptless-message",{executionId:e.id,roleId:o.id,roleName:o.name,rolePersonality:o.personality,roleSpeakingStyle:o.speakingStyle,prompt:i,context:{goal:e.goal,intent:e.intent,messageCount:n.length,interestScore:e.stats.interestScore,currentStage:e.conversionFunnel?.currentStage}}),this.ipc.once("ai-team:scriptless-message-generated",r=>{r.executionId===e.id?a({roleId:o.id,roleName:o.name,content:r.content,reasoning:r.reasoning||"\u6839\u64DA\u4E0A\u4E0B\u6587\u81EA\u52D5\u751F\u6210"}):a(null)}),setTimeout(()=>a(null),3e4)})}selectRoleForScriptless(e,t){if(e.roles.length===0)return null;if(t?.suggestions.recommendedRole){let a=e.roles.find(r=>r.id===t.suggestions.recommendedRole);if(a)return a}let n=(e.messageHistory||[]).slice(-3).filter(a=>!a.isFromCustomer).map(a=>a.role),s=n[n.length-1];if(n.filter(a=>a===s).length>=3){let a=e.roles.filter(r=>r.id!==s);if(a.length>0)return a[Math.floor(Math.random()*a.length)]}let i=e.conversionFunnel?.currentStage;if(i==="interest"||i==="intent"){let a=e.roles.find(r=>r.type==="professional");if(a)return a}return e.roles[0]}buildScriptlessPrompt(e,t,n){let o=n.slice(-20).map(r=>`${r.isFromCustomer?"\u3010\u5BA2\u6236\u3011":`\u3010${r.role}\u3011`}: ${r.content}`).join(`
`),i=e.conversionFunnel?.currentStage||"contact",a={contact:"\u5EFA\u7ACB\u806F\u7E6B\uFF0C\u81EA\u7136\u958B\u5834",response:"\u4FDD\u6301\u4E92\u52D5\uFF0C\u4E86\u89E3\u9700\u6C42",interest:"\u6DF1\u5165\u4ECB\u7D39\uFF0C\u5F37\u8ABF\u50F9\u503C",intent:"\u8655\u7406\u7570\u8B70\uFF0C\u63A8\u52D5\u6C7A\u7B56",conversion:"\u4FC3\u6210\u6210\u4EA4\uFF0C\u78BA\u8A8D\u8A02\u55AE"};return`\u4F60\u662F ${t.name}\uFF0C${t.personality}\u3002

\u3010\u8AAA\u8A71\u98A8\u683C\u3011
${t.speakingStyle}

\u3010\u7576\u524D\u76EE\u6A19\u3011
${e.goal}

\u3010\u7576\u524D\u968E\u6BB5\u3011
${i} - ${a[i]||"\u7E7C\u7E8C\u5C0D\u8A71"}

\u3010\u5BA2\u6236\u8208\u8DA3\u5EA6\u3011
${e.stats.interestScore}/100

\u3010\u5C0D\u8A71\u6B77\u53F2\u3011
${o||"\uFF08\u66AB\u7121\u5C0D\u8A71\uFF09"}

\u3010\u4EFB\u52D9\u3011
\u4F5C\u70BA ${t.name}\uFF0C\u6839\u64DA\u4E0A\u4E0B\u6587\u751F\u6210\u4E00\u689D\u81EA\u7136\u7684\u56DE\u8986\u3002
- \u4FDD\u6301\u89D2\u8272\u4EBA\u8A2D
- \u63A8\u9032\u5C0D\u8A71\u76EE\u6A19
- \u4E0D\u8981\u751F\u786C\u63A8\u92B7
- \u50CF\u771F\u4EBA\u804A\u5929\u4E00\u6A23\u81EA\u7136
- \u55AE\u689D\u6D88\u606F\u4E0D\u8D85\u904E 100 \u5B57

\u8ACB\u76F4\u63A5\u8F38\u51FA\u6D88\u606F\u5167\u5BB9\uFF0C\u4E0D\u8981\u6709\u4EFB\u4F55\u524D\u7DB4\u6216\u89E3\u91CB\uFF1A`}confirmAndStart(e){let t=this._executions().find(n=>n.id===e);return t?(t.status="running",this._currentExecution.set(t),this._executions.update(n=>n.map(s=>s.id===e?t:s)),this.toast.success("AI \u5718\u968A\u5DF2\u958B\u59CB\u5DE5\u4F5C\uFF01"),this.startBackendExecution(t),!0):!1}beginPrivateChatExecution(e){if(!e.targetUsers||e.targetUsers.length===0){this.toast.warning("\u6C92\u6709\u76EE\u6A19\u7528\u6236\uFF0C\u7121\u6CD5\u958B\u59CB\u79C1\u804A");return}e.status="running",this._currentExecution.set(c({},e)),console.log("[DynamicEngine] \u{1F680} \u958B\u59CB\u79C1\u804A\u57F7\u884C:",{executionId:e.id,targetUsers:e.targetUsers.length,mode:e.mode,roles:e.roles?.length}),this.startBackendExecution(e),this.sendFirstMessageToAllUsers(e),this.toast.success(`\u{1F680} \u958B\u59CB\u79C1\u804A\u8F49\u5316\uFF01\u76EE\u6A19\uFF1A${e.targetUsers.length} \u4EBA`)}async sendFirstMessageToAllUsers(e){let t=e.targetUsers||[],n=e.accountMatches||[];if(t.length===0){console.log("[DynamicEngine] \u7121\u76EE\u6A19\u7528\u6236");return}if(n.length===0){this.toast.error("\u7121\u53EF\u7528\u5E33\u865F\u767C\u9001\u6D88\u606F");return}console.log(`[DynamicEngine] \u{1F504} \u4E26\u884C\u767C\u9001\u9996\u689D\u6D88\u606F\u7D66 ${t.length} \u500B\u76EE\u6A19\u7528\u6236`);for(let s=0;s<t.length;s++){let o=t[s],i=n[s%n.length],a=o.firstName||o.username||o.id;console.log(`[DynamicEngine] \u{1F4E4} \u767C\u9001\u7D66\u7528\u6236 ${s+1}/${t.length}: ${a}`),this.sendFirstMessageToUser(e,o,i,s),s<t.length-1&&await new Promise(r=>setTimeout(r,100+Math.random()*200))}this.toast.info(`\u{1F4E4} \u5DF2\u767C\u9001\u9996\u689D\u6D88\u606F\u7D66 ${t.length} \u500B\u76EE\u6A19\u7528\u6236`)}async sendFirstMessageToUser(e,t,n,s){let o=t.firstName||t.username||t.id,i=t.telegramId||t.id,a=await this.generateFirstTouchMessage(e,{id:i,name:o});a&&(this.ipc.send("ai-team:send-private-message",{executionId:e.id,accountId:n.accountId,accountPhone:n.accountPhone,roleId:n.roleId,roleName:n.roleName,targetUserId:i,targetUserName:o,content:a,isFirstTouch:!0,userIndex:s}),e.messageHistory||(e.messageHistory=[]),e.messageHistory.push({role:n.roleName,content:a,timestamp:new Date().toISOString(),isFromCustomer:!1}),e.stats.messagesSent++,this._currentExecution.set(c({},e)),console.log(`[DynamicEngine] \u2713 \u9996\u689D\u6D88\u606F\u5DF2\u767C\u9001\u7D66 ${o}:`,a.substring(0,50)+"..."))}async sendFirstMessage(e){let t=e.queue?.currentUser;if(!t){console.log("[DynamicEngine] \u7121\u7576\u524D\u76EE\u6A19\u7528\u6236");return}let n=e.roles?.[0],s=e.accountMatches?.find(i=>i.roleId===n?.id)||e.accountMatches?.[0];if(!s){this.toast.error("\u7121\u53EF\u7528\u5E33\u865F\u767C\u9001\u6D88\u606F");return}let o=await this.generateFirstTouchMessage(e,t);o&&(this.ipc.send("ai-team:send-private-message",{executionId:e.id,accountId:s.accountId,accountPhone:s.accountPhone,roleId:s.roleId,roleName:s.roleName,targetUserId:t.id,targetUserName:t.name,content:o,isFirstTouch:!0}),e.messageHistory||(e.messageHistory=[]),e.messageHistory.push({role:s.roleName,content:o,timestamp:new Date().toISOString(),isFromCustomer:!1}),e.stats.messagesSent++,this._currentExecution.set(c({},e)),console.log("[DynamicEngine] \u9996\u689D\u6D88\u606F\u5DF2\u767C\u9001:",o.substring(0,50)+"..."))}async generateFirstTouchMessage(e,t){return e.marketingData?.messageTemplates?.firstTouch?e.marketingData.messageTemplates.firstTouch.replace("{name}",t.name).replace("{goal}",e.goal):new Promise(n=>{let s=`\u4F60\u662F\u4E00\u500B\u5C08\u696D\u7684\u5BA2\u6236\u7D93\u7406\uFF0C\u9700\u8981\u4E3B\u52D5\u806F\u7E6B\u4E00\u4F4D\u6F5B\u5728\u5BA2\u6236\u3002

\u76EE\u6A19\uFF1A${e.goal}
\u5BA2\u6236\u540D\u7A31\uFF1A${t.name}

\u8ACB\u751F\u6210\u4E00\u689D\u7C21\u77ED\u3001\u53CB\u597D\u3001\u81EA\u7136\u7684\u9996\u6B21\u554F\u5019\u6D88\u606F\u3002\u8981\u6C42\uFF1A
1. \u4E0D\u8981\u592A\u92B7\u552E\u5316\uFF0C\u50CF\u670B\u53CB\u4E00\u6A23\u6253\u62DB\u547C
2. \u53EF\u4EE5\u63D0\u53CA\u5C0D\u65B9\u53EF\u80FD\u611F\u8208\u8DA3\u7684\u8A71\u984C
3. \u7C21\u77ED\uFF081-2\u53E5\u8A71\uFF09
4. \u5F15\u8D77\u5C0D\u65B9\u56DE\u8986\u7684\u8208\u8DA3

\u76F4\u63A5\u8F38\u51FA\u6D88\u606F\u5167\u5BB9\uFF1A`;this.ipc.send("ai:generate-text",{prompt:s,maxTokens:100,callback:"ai-team:first-message-generated"});let o=setTimeout(()=>{let a=`\u60A8\u597D\uFF01\u6211\u662F${e.roles?.[0]?.name||"\u5BA2\u6236\u7D93\u7406"}\uFF0C\u6CE8\u610F\u5230\u60A8\u53EF\u80FD\u5C0D\u6211\u5011\u7684\u670D\u52D9\u611F\u8208\u8DA3\uFF0C\u65B9\u4FBF\u804A\u804A\u55CE\uFF1F`;n(a)},5e3),i=this.ipc.on("ai-team:first-message-generated",a=>{clearTimeout(o),i(),n(a.text||"\u60A8\u597D\uFF01\u8ACB\u554F\u6709\u4EC0\u9EBC\u53EF\u4EE5\u5E6B\u60A8\u7684\u55CE\uFF1F")})})}startBackendExecution(e){console.log("[DynamicEngine] \u555F\u52D5\u5F8C\u7AEF\u57F7\u884C:",e.id,"\u6A21\u5F0F:",e.mode),console.log("[DynamicEngine] \u{1F50D} \u8ABF\u8A66 - roles:",e.roles?.length,e.roles),console.log("[DynamicEngine] \u{1F50D} \u8ABF\u8A66 - accountMatches:",e.accountMatches?.length,e.accountMatches),console.log("[DynamicEngine] \u{1F50D} \u8ABF\u8A66 - targetUsers:",e.targetUsers?.length),this.ipc.send("ai-team:start-execution",{executionId:e.id,goal:e.goal,intent:e.intent,strategy:e.strategy,roles:e.roles,marketingData:e.marketingData,mode:e.mode,accountMatches:e.accountMatches,scriptlessConfig:e.scriptlessConfig,analysisInterval:this.analysisInterval,targetUsers:e.targetUsers}),this.setupExecutionListeners(e.id),e.mode==="scriptless"&&this.startScriptlessLoop(e)}async startScriptlessLoop(e){console.log("[DynamicEngine] \u555F\u52D5\u7121\u5287\u672C\u6A21\u5F0F\u5C0D\u8A71\u5FAA\u74B0");let t=await this.generateScriptlessMessage(e);t&&(this.ipc.send("ai-team:send-scriptless-message",{executionId:e.id,roleId:t.roleId,content:t.content}),e.stats.messagesSent++,this._currentExecution.set(c({},e)))}setupExecutionListeners(e){this.ipc.on("ai-team:message-sent",t=>{t.executionId===e&&this.updateExecutionStats(e,{messagesSent:t.totalSent})}),this.ipc.on("ai-team:response-received",t=>{t.executionId===e&&this.updateExecutionStats(e,{responsesReceived:t.totalResponses,interestScore:t.interestScore})}),this.ipc.on("ai-team:phase-changed",t=>{t.executionId===e&&(this.updateExecutionStats(e,{currentPhase:t.phase}),this.toast.info(`\u{1F4CA} \u9032\u5165\u968E\u6BB5 ${t.phase+1}: ${t.phaseName}`))}),this.ipc.on("ai-team:execution-completed",t=>{t.executionId===e&&(this.updateExecutionStatus(e,"completed"),this.toast.success(`\u{1F389} \u4EFB\u52D9\u5B8C\u6210\uFF01\u767C\u9001 ${t.totalSent} \u689D\u6D88\u606F\uFF0C\u6536\u5230 ${t.totalResponses} \u500B\u56DE\u8986`))}),this.ipc.on("ai-team:customer-reply",async t=>{if(t.executionId===e){console.log("[DynamicEngine] \u6536\u5230\u5BA2\u6236\u56DE\u8986:",t.firstName,t.text?.substring(0,50)),this.updateExecutionStats(e,{responsesReceived:t.totalResponses});let n=this._currentExecution();if(n){n.messageHistory||(n.messageHistory=[]),n.messageHistory.push({role:"customer",content:t.text,timestamp:new Date().toISOString(),isFromCustomer:!0}),this._currentExecution.set(c({},n));let s=this.detectConversionSignal(t.text);s.hasSignal&&this.handleConversionSignal(n,t,s),this.updateIntentScore(n,t.text)}this.toast.info(`\u{1F4AC} \u5BA2\u6236 ${t.firstName||t.username} \u56DE\u8986\u4E86\u6D88\u606F`)}}),this.ipc.on("ai-team:trigger-next-message",async t=>{if(t.executionId===e){console.log("[DynamicEngine] \u89F8\u767C\u4E0B\u4E00\u689D\u6D88\u606F:",t.customerName);let n=this._currentExecution();if(!n||n.status!=="running"||n.mode==="scripted")return;let s=15e3+Math.random()*3e4;console.log(`[DynamicEngine] \u64EC\u4EBA\u5316\u5EF6\u9072 ${(s/1e3).toFixed(1)} \u79D2\u5F8C\u56DE\u8986`),await new Promise(g=>setTimeout(g,s));let o=this._currentExecution();if(!o||o.status!=="running")return;let i=o.messageHistory?.length||0;i>0&&i%this.analysisInterval===0&&await this.performDynamicAnalysis(o);let a=this.selectRoleForAutoReply(o,t.customerMessage),r=o.accountMatches?.find(g=>g.roleId===a?.id)||o.accountMatches?.[0];if(!r){console.log("[DynamicEngine] \u7121\u53EF\u7528\u5E33\u865F\u767C\u9001\u56DE\u8986");return}let u=await this.generateScriptlessMessage(o);u&&(this.ipc.send("ai-team:send-private-message",{executionId:o.id,accountId:r.accountId,accountPhone:r.accountPhone,roleId:r.roleId,roleName:r.roleName,targetUserId:t.customerId,targetUserName:t.customerName,content:u.content,isFirstTouch:!1}),o.messageHistory||(o.messageHistory=[]),o.messageHistory.push({role:r.roleName,content:u.content,timestamp:new Date().toISOString(),isFromCustomer:!1}),o.stats.messagesSent++,this._currentExecution.set(c({},o)))}}),this.ipc.on("ai-team:private-message-sent",t=>{t.executionId===e&&t.success&&console.log("[DynamicEngine] \u2705 \u79C1\u804A\u767C\u9001\u6210\u529F:",t.targetUserName)})}selectRoleForAutoReply(e,t){let n=e.roles||[];if(n.length===0)return;if(n.length===1)return n[0];let s=t?.toLowerCase()||"";if(s.includes("\u591A\u5C11\u9322")||s.includes("\u50F9\u683C")||s.includes("\u8CB7")||s.includes("\u4ED8\u6B3E"))return n.find(r=>r.name.includes("\u670D\u52D9")||r.name.includes("\u5C08\u54E1"))||n[0];if(s.includes("\u600E\u9EBC")||s.includes("\u5982\u4F55")||s.includes("\u4EC0\u9EBC"))return n.find(r=>r.name.includes("\u5C08\u5BB6")||r.name.includes("\u9867\u554F"))||n[0];let o=(e.messageHistory||[]).filter(r=>!r.isFromCustomer).slice(-3).map(r=>r.role),i=o[o.length-1],a=n.filter(r=>r.name!==i);return a.length>0?a[Math.floor(Math.random()*a.length)]:n[0]}updateExecutionStats(e,t){let n=this._executions().find(s=>s.id===e);n&&(n.stats=c(c({},n.stats),t),this._executions.update(s=>s.map(o=>o.id===e?n:o)),this._currentExecution()?.id===e&&this._currentExecution.set(n))}pauseExecution(e){return this.updateExecutionStatus(e,"paused")}resumeExecution(e){return this.updateExecutionStatus(e,"running")}stopExecution(e){return this.updateExecutionStatus(e,"completed")}updateExecutionStatus(e,t){let n=this._executions().find(s=>s.id===e);return n?(n.status=t,this._executions.update(s=>s.map(o=>o.id===e?n:o)),this._currentExecution()?.id===e&&this._currentExecution.set(n),!0):!1}completeCurrentUser(e){let t=this._currentExecution();if(!t?.queue?.currentUser)return!1;let n=t.queue.currentUser,s=new Date(n.startTime).getTime(),o=Math.round((Date.now()-s)/1e3);return t.queue.completedUsers.push({id:n.id,name:n.name,result:e,messagesExchanged:t.messageHistory?.length||0,duration:o}),t.queue.processedUsers++,this.ipc.send("ai-team:user-completed",{executionId:t.id,userId:n.id,result:e,duration:o}),this.moveToNextUser()}moveToNextUser(){let e=this._currentExecution();if(!e?.queue||!e.targetUsers)return!1;let t=e.queue.pendingUsers.shift();if(!t)return this.toast.success(`\u{1F389} \u6240\u6709 ${e.queue.totalUsers} \u500B\u76EE\u6A19\u7528\u6236\u8655\u7406\u5B8C\u7562\uFF01`),e.queue.currentUser=void 0,this._currentExecution.set(c({},e)),this.ipc.send("ai-team:queue-completed",{executionId:e.id,stats:{total:e.queue.totalUsers,completed:e.queue.completedUsers.length,results:this.calculateQueueResults(e.queue.completedUsers)}}),!1;let n=e.targetUsers.find(s=>String(s.id)===t);return n?(e.queue.currentUserIndex++,e.queue.currentUser={id:t,name:n.firstName||n.username||t,startTime:new Date().toISOString()},e.messageHistory=[],e.conversionFunnel={currentStage:"contact",stageHistory:[{stage:"contact",enteredAt:new Date().toISOString(),messageCount:0}],keyMoments:[]},this._currentExecution.set(c({},e)),this.ipc.send("ai-team:next-user",{executionId:e.id,userId:t,userName:e.queue.currentUser.name,userIndex:e.queue.currentUserIndex,remaining:e.queue.pendingUsers.length}),this.toast.info(`\u{1F4CB} \u958B\u59CB\u8655\u7406\u7B2C ${e.queue.currentUserIndex+1}/${e.queue.totalUsers} \u500B\u7528\u6236\uFF1A${e.queue.currentUser.name}`),!0):!1}skipCurrentUser(){return this.completeCurrentUser("no_response")}calculateQueueResults(e){let t={converted:0,interested:0,neutral:0,rejected:0,no_response:0};return e.forEach(n=>{t[n.result]!==void 0&&t[n.result]++}),t}static{this.\u0275fac=function(t){return new(t||y)}}static{this.\u0275prov=R({token:y,factory:y.\u0275fac,providedIn:"root"})}};export{U as a,w as b,k as c,E as d,D as e,L as f};
