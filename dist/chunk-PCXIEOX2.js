import{a as Z}from"./chunk-VSSEQNUC.js";import{e as G,g as W,h as z,j as B}from"./chunk-IOZ6RGE3.js";import{a as $,b as H,c as K,d as j,e as q,f as Y,g as X,p as V,t as J}from"./chunk-3FNGYHNZ.js";import{b as Q}from"./chunk-LSISMS55.js";import{o as F}from"./chunk-HDSZBSQ2.js";import{Eb as P,Fb as S,Gb as E,J as N,La as U,O as _,Vb as m,Ya as C,Za as w,a as I,b as R,cb as f,da as d,db as o,eb as r,fb as x,nb as k,pb as L,xa as a,xb as s,yb as g,zb as y}from"./chunk-XBIFDY2N.js";var A={COOKIE_NAME:"csrf_token",HEADER_NAME:"X-CSRF-Token",STORAGE_KEY:"tgm_csrf_token"},u={MAX_ATTEMPTS:5,LOCKOUT_DURATION:300,ATTEMPT_WINDOW:900,STORAGE_KEY:"tgm_login_attempts"},T=class c{constructor(){this._csrfToken=d("");this.csrfToken=m(()=>this._csrfToken());this._isLocked=d(!1);this._lockoutRemaining=d(0);this._attemptCount=d(0);this.isLocked=m(()=>this._isLocked());this.lockoutRemaining=m(()=>this._lockoutRemaining());this.attemptCount=m(()=>this._attemptCount());this.attemptsLeft=m(()=>Math.max(0,u.MAX_ATTEMPTS-this._attemptCount()));this.refreshCsrfToken()}refreshCsrfToken(){let e=this.getCookie(A.COOKIE_NAME);e&&this._csrfToken.set(e)}getCsrfToken(){return this._csrfToken()}getCsrfHeaders(){let e=this.getCsrfToken();return e?{[A.HEADER_NAME]:e}:{}}async secureFetch(e,n={}){let t=new Headers(n.headers),i=this.getCsrfToken();i&&t.set(A.HEADER_NAME,i),t.has("Content-Type")||t.set("Content-Type","application/json");let l=await fetch(e,R(I({},n),{headers:t,credentials:"include"}));return this.refreshCsrfToken(),l}canAttemptLogin(){let e=this.getLockoutData(),n=Date.now();if(e.lockedUntil>n){let i=Math.ceil((e.lockedUntil-n)/1e3);return this._isLocked.set(!0),this._lockoutRemaining.set(i),{allowed:!1,message:`\u767B\u5165\u5617\u8A66\u6B21\u6578\u904E\u591A\uFF0C\u8ACB ${this.formatDuration(i)} \u5F8C\u518D\u8A66`,waitSeconds:i}}this._isLocked.set(!1),this._lockoutRemaining.set(0);let t=this.getRecentAttempts(e.attempts);if(this._attemptCount.set(t.length),t.length>=u.MAX_ATTEMPTS){let i=n+u.LOCKOUT_DURATION*1e3;this.setLockout(i,e.attempts);let l=u.LOCKOUT_DURATION;return this._isLocked.set(!0),this._lockoutRemaining.set(l),{allowed:!1,message:`\u767B\u5165\u5617\u8A66\u6B21\u6578\u904E\u591A\uFF0C\u8ACB ${this.formatDuration(l)} \u5F8C\u518D\u8A66`,waitSeconds:l}}return{allowed:!0}}recordLoginAttempt(e,n){let t=this.getLockoutData();t.attempts.push({timestamp:Date.now(),success:e,email:n}),t.attempts=this.getRecentAttempts(t.attempts),e&&(t.lockedUntil=0,t.attempts=[]),this.saveLockoutData(t),this._attemptCount.set(t.attempts.filter(i=>!i.success).length)}clearLoginLimit(){localStorage.removeItem(u.STORAGE_KEY),this._isLocked.set(!1),this._lockoutRemaining.set(0),this._attemptCount.set(0)}getRecentAttempts(e){let n=Date.now()-u.ATTEMPT_WINDOW*1e3;return e.filter(t=>t.timestamp>n&&!t.success)}getLockoutData(){try{let e=localStorage.getItem(u.STORAGE_KEY);if(e)return JSON.parse(e)}catch(e){console.error("Failed to parse lockout data:",e)}return{lockedUntil:0,attempts:[]}}saveLockoutData(e){localStorage.setItem(u.STORAGE_KEY,JSON.stringify(e))}setLockout(e,n){this.saveLockoutData({lockedUntil:e,attempts:n})}sanitizeHtml(e){let n=document.createElement("div");return n.textContent=e,n.innerHTML}isUrlSafe(e){return!e||e.toLowerCase().startsWith("javascript:")||e.toLowerCase().startsWith("data:")&&!e.toLowerCase().startsWith("data:image/")?!1:!!(e.startsWith("/")||e.startsWith("http://")||e.startsWith("https://"))}escapeHtml(e){let n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,t=>n[t])}getCookie(e){let n=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return n?decodeURIComponent(n[2]):null}formatDuration(e){return e<60?`${e} \u79D2`:`${Math.ceil(e/60)} \u5206\u9418`}startLockoutCountdown(e){let n=setInterval(()=>{let t=this._lockoutRemaining();if(t<=0){clearInterval(n),this._isLocked.set(!1),e?.(0);return}this._lockoutRemaining.update(i=>i-1),e?.(t-1)},1e3);return()=>clearInterval(n)}static{this.\u0275fac=function(n){return new(n||c)}}static{this.\u0275prov=N({token:c,factory:c.\u0275fac,providedIn:"root"})}};function ne(c,e){if(c&1&&(o(0,"div",3)(1,"span",28),s(2,"\u{1F512}"),r(),o(3,"div",29)(4,"span",30),s(5,"\u5E33\u865F\u66AB\u6642\u9396\u5B9A"),r(),o(6,"span",31),s(7),r()()()),c&2){let n=L();a(7),y("\u8ACB\u7B49\u5F85 ",n.lockoutRemaining()," \u79D2\u5F8C\u91CD\u8A66")}}function oe(c,e){if(c&1&&(o(0,"div",4)(1,"span",32),s(2,"\u26A0\uFE0F"),r(),o(3,"span"),s(4),r()()),c&2){let n=L();a(4),g(n.error())}}function ie(c,e){if(c&1&&(x(0,"span",33),o(1,"span"),s(2),r()),c&2){let n=L();a(2),g(n.t("auth.loggingIn"))}}function re(c,e){if(c&1&&(o(0,"span"),s(1),r()),c&2){let n=L();a(),g(n.t("auth.login"))}}function ae(c,e){c&1&&x(0,"span",24)}function se(c,e){c&1&&(o(0,"span",22),s(1,"\u2708\uFE0F"),r())}var ee=class c{constructor(){this.authService=_(Z);this.router=_(W);this.route=_(G);this.i18n=_(Q);this.security=_(T);this.email="";this.password="";this.rememberMe=!1;this.showPassword=d(!1);this.isLoading=d(!1);this.telegramLoading=d(!1);this.error=d(null);this.isLocked=m(()=>this.security.isLocked());this.lockoutRemaining=m(()=>this.security.lockoutRemaining());this.attemptsLeft=m(()=>this.security.attemptsLeft());this.telegramBotUsername="";this.lockoutCleanup=null}ngOnInit(){this.checkLoginLimit()}ngOnDestroy(){this.lockoutCleanup?.()}checkLoginLimit(){let e=this.security.canAttemptLogin();e.allowed||(this.error.set(e.message||""),this.lockoutCleanup=this.security.startLockoutCountdown(n=>{n<=0&&this.error.set(null)}))}t(e){return this.i18n.t(e)}async onSubmit(){if(!this.email||!this.password)return;let e=this.security.canAttemptLogin();if(!e.allowed){this.error.set(e.message||"");return}this.isLoading.set(!0),this.error.set(null);try{let n=await this.authService.login({email:this.email,password:this.password,remember:this.rememberMe});if(n.success){this.security.recordLoginAttempt(!0,this.email);let t=this.route.snapshot.queryParams.returnUrl||"/";this.router.navigateByUrl(t)}else{this.security.recordLoginAttempt(!1,this.email);let t=this.security.attemptsLeft(),i=n.error||this.t("auth.loginFailed");t>0&&t<=3&&(i+=` (\u5269\u9918 ${t} \u6B21\u5617\u8A66\u6A5F\u6703)`),this.error.set(i),this.checkLoginLimit()}}catch(n){this.security.recordLoginAttempt(!1,this.email),this.error.set(n.message||this.t("auth.loginFailed")),this.checkLoginLimit()}finally{this.isLoading.set(!1)}}async socialLogin(e){e==="telegram"?await this.telegramLogin():e==="google"&&await this.googleLogin()}async googleLogin(){this.isLoading.set(!0),this.error.set(null);try{let n=await(await fetch("/api/v1/oauth/google/config")).json();if(!n.success||!n.data?.enabled){this.error.set("Google \u767B\u5165\u529F\u80FD\u5373\u5C07\u63A8\u51FA\uFF0C\u8ACB\u4F7F\u7528\u5176\u4ED6\u65B9\u5F0F\u767B\u5165");return}this.openGoogleLoginPopup()}catch(e){console.error("Google login error:",e),this.error.set("Google \u767B\u5165\u529F\u80FD\u5373\u5C07\u63A8\u51FA\uFF0C\u8ACB\u4F7F\u7528\u5176\u4ED6\u65B9\u5F0F\u767B\u5165")}finally{this.isLoading.set(!1)}}openGoogleLoginPopup(){let n=`${window.location.origin}/api/v1/oauth/google/callback`,t=`/api/v1/oauth/google/authorize?callback=${encodeURIComponent(n)}`,i=550,l=600,M=window.screenX+(window.outerWidth-i)/2,D=window.screenY+(window.outerHeight-l)/2,b=window.open(t,"GoogleAuth",`width=${i},height=${l},left=${M},top=${D},toolbar=no,menubar=no,scrollbars=yes`),h=async p=>{p.data&&p.data.type==="google_auth"?(window.removeEventListener("message",h),b?.close(),await this.handleGoogleAuth(p.data.auth)):p.data&&p.data.type==="google_auth_error"&&(window.removeEventListener("message",h),b?.close(),this.error.set(p.data.error||"Google \u767B\u5165\u5931\u6557"),this.isLoading.set(!1))};window.addEventListener("message",h);let v=setInterval(()=>{b?.closed&&(clearInterval(v),window.removeEventListener("message",h),this.isLoading.set(!1))},500)}async handleGoogleAuth(e){this.isLoading.set(!0);try{if(e.access_token&&e.user){localStorage.setItem("tgm_access_token",e.access_token),e.refresh_token&&localStorage.setItem("tgm_refresh_token",e.refresh_token),localStorage.setItem("tgm_user",JSON.stringify(e.user));let n=this.route.snapshot.queryParams.returnUrl||"/";window.location.href=n}else this.error.set("Google \u767B\u5165\u5931\u6557\uFF1A\u7121\u6548\u7684\u8A8D\u8B49\u6578\u64DA")}catch(n){this.error.set(n.message||"Google \u767B\u5165\u5931\u6557")}finally{this.isLoading.set(!1)}}async telegramLogin(){this.telegramLoading.set(!0),this.error.set(null);try{let e=await this.authService.getTelegramConfig();if(!e.enabled||!e.bot_username){this.error.set("Telegram \u767B\u5165\u672A\u914D\u7F6E");return}this.telegramBotUsername=e.bot_username,this.openTelegramLoginPopup()}catch(e){console.error("Telegram login error:",e),this.error.set(e.message||"Telegram \u767B\u5165\u5931\u6557")}finally{this.telegramLoading.set(!1)}}openTelegramLoginPopup(){let e=this.telegramBotUsername,n=window.location.origin,t=`${n}/auth/telegram-callback`,i=`https://oauth.telegram.org/auth?bot_id=${e}&origin=${encodeURIComponent(n)}&request_access=write&return_to=${encodeURIComponent(t)}`,l=550,M=470,D=window.screenX+(window.outerWidth-l)/2,b=window.screenY+(window.outerHeight-M)/2,h=window.open(i,"TelegramAuth",`width=${l},height=${M},left=${D},top=${b},toolbar=no,menubar=no,scrollbars=no`),v=async O=>{O.origin===window.location.origin&&O.data&&O.data.type==="telegram_auth"&&(window.removeEventListener("message",v),h?.close(),await this.handleTelegramAuth(O.data.auth))};window.addEventListener("message",v);let p=setInterval(()=>{h?.closed&&(clearInterval(p),window.removeEventListener("message",v),this.telegramLoading.set(!1))},500)}async handleTelegramAuth(e){this.telegramLoading.set(!0);try{let n=await this.authService.telegramLogin(e);if(n.success){let t=this.route.snapshot.queryParams.returnUrl||"/";this.router.navigateByUrl(t)}else this.error.set(n.error||"Telegram \u767B\u5165\u5931\u6557")}catch(n){this.error.set(n.message||"Telegram \u767B\u5165\u5931\u6557")}finally{this.telegramLoading.set(!1)}}static{this.\u0275fac=function(n){return new(n||c)}}static{this.\u0275cmp=U({type:c,selectors:[["app-login"]],decls:53,vars:25,consts:[[1,"login-page"],[1,"page-title"],[1,"page-subtitle"],[1,"lockout-alert"],[1,"error-alert"],[1,"login-form",3,"ngSubmit"],[1,"form-group"],["for","email"],[1,"input-wrapper"],[1,"input-icon"],["type","email","id","email","name","email","required","","autocomplete","email",3,"ngModelChange","ngModel","placeholder","disabled"],["for","password"],["id","password","name","password","required","","autocomplete","current-password",3,"ngModelChange","type","ngModel","placeholder","disabled"],["type","button",1,"toggle-password",3,"click"],[1,"form-options"],[1,"checkbox-label"],["type","checkbox","name","rememberMe",3,"ngModelChange","ngModel"],["routerLink","/auth/forgot-password",1,"forgot-link"],["type","submit",1,"submit-btn",3,"disabled"],[1,"divider"],[1,"social-login"],[1,"social-btn","google",3,"click","disabled"],[1,"social-icon"],[1,"social-btn","telegram",3,"click","disabled"],[1,"loading-spinner","small"],["id","telegram-login-widget",2,"display","none"],[1,"register-link"],["routerLink","/auth/register"],[1,"lockout-icon"],[1,"lockout-content"],[1,"lockout-title"],[1,"lockout-time"],[1,"error-icon"],[1,"loading-spinner"]],template:function(n,t){n&1&&(o(0,"div",0)(1,"h2",1),s(2),r(),o(3,"p",2),s(4),r(),C(5,ne,8,1,"div",3),C(6,oe,5,1,"div",4),o(7,"form",5),k("ngSubmit",function(){return t.onSubmit()}),o(8,"div",6)(9,"label",7),s(10),r(),o(11,"div",8)(12,"span",9),s(13,"\u{1F4E7}"),r(),o(14,"input",10),E("ngModelChange",function(l){return S(t.email,l)||(t.email=l),l}),r()()(),o(15,"div",6)(16,"label",11),s(17),r(),o(18,"div",8)(19,"span",9),s(20,"\u{1F512}"),r(),o(21,"input",12),E("ngModelChange",function(l){return S(t.password,l)||(t.password=l),l}),r(),o(22,"button",13),k("click",function(){return t.showPassword.set(!t.showPassword())}),s(23),r()()(),o(24,"div",14)(25,"label",15)(26,"input",16),E("ngModelChange",function(l){return S(t.rememberMe,l)||(t.rememberMe=l),l}),r(),o(27,"span"),s(28),r()(),o(29,"a",17),s(30),r()(),o(31,"button",18),C(32,ie,3,1)(33,re,2,1,"span"),r()(),o(34,"div",19)(35,"span"),s(36),r()(),o(37,"div",20)(38,"button",21),k("click",function(){return t.socialLogin("google")}),o(39,"span",22),s(40,"G"),r(),o(41,"span"),s(42,"Google"),r()(),o(43,"button",23),k("click",function(){return t.socialLogin("telegram")}),C(44,ae,1,0,"span",24)(45,se,2,0,"span",22),o(46,"span"),s(47,"Telegram"),r()()(),x(48,"div",25),o(49,"p",26),s(50),o(51,"a",27),s(52),r()()()),n&2&&(a(2),g(t.t("auth.welcomeBack")),a(2),g(t.t("auth.loginSubtitle")),a(),w(t.isLocked()?5:-1),a(),w(t.error()&&!t.isLocked()?6:-1),a(4),g(t.t("auth.email")),a(4),P("ngModel",t.email),f("placeholder",t.t("auth.emailPlaceholder"))("disabled",t.isLoading()),a(3),g(t.t("auth.password")),a(4),f("type",t.showPassword()?"text":"password"),P("ngModel",t.password),f("placeholder",t.t("auth.passwordPlaceholder"))("disabled",t.isLoading()),a(2),y(" ",t.showPassword()?"\u{1F648}":"\u{1F441}\uFE0F"," "),a(3),P("ngModel",t.rememberMe),a(2),g(t.t("auth.rememberMe")),a(2),y(" ",t.t("auth.forgotPassword")," "),a(),f("disabled",t.isLoading()||!t.email||!t.password||t.isLocked()),a(),w(t.isLoading()?32:33),a(4),g(t.t("auth.or")),a(2),f("disabled",t.isLoading()),a(5),f("disabled",t.telegramLoading()),a(),w(t.telegramLoading()?44:45),a(6),y(" ",t.t("auth.noAccount")," "),a(2),g(t.t("auth.registerNow")))},dependencies:[F,J,X,H,$,K,j,V,Y,q,B,z],styles:['.login-page[_ngcontent-%COMP%]{color:var(--text-primary, #fff)}.page-title[_ngcontent-%COMP%]{font-size:1.75rem;font-weight:700;margin-bottom:.5rem}.page-subtitle[_ngcontent-%COMP%]{color:var(--text-secondary, #888);margin-bottom:2rem}.error-alert[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;padding:.875rem 1rem;background:#ef44441a;border:1px solid rgba(239,68,68,.3);border-radius:8px;color:#f87171;margin-bottom:1.5rem;font-size:.875rem}.lockout-alert[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:1rem 1.25rem;background:#fb923c1a;border:1px solid rgba(251,146,60,.3);border-radius:8px;color:#fb923c;margin-bottom:1.5rem}.lockout-icon[_ngcontent-%COMP%]{font-size:1.5rem}.lockout-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.lockout-title[_ngcontent-%COMP%]{font-weight:600;font-size:.9rem}.lockout-time[_ngcontent-%COMP%]{font-size:.8rem;opacity:.8}.login-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.25rem}.form-group[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-size:.875rem;font-weight:500;color:var(--text-secondary, #aaa)}.input-wrapper[_ngcontent-%COMP%]{position:relative;display:flex;align-items:center}.input-icon[_ngcontent-%COMP%]{position:absolute;left:1rem;font-size:1rem;opacity:.5}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;padding:.875rem 1rem .875rem 2.75rem;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:8px;color:var(--text-primary, #fff);font-size:1rem;transition:all .2s ease}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--primary, #3b82f6);box-shadow:0 0 0 3px #3b82f61a}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]::placeholder{color:var(--text-muted, #666)}.toggle-password[_ngcontent-%COMP%]{position:absolute;right:1rem;background:none;border:none;cursor:pointer;font-size:1rem;opacity:.5;transition:opacity .2s}.toggle-password[_ngcontent-%COMP%]:hover{opacity:1}.form-options[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;font-size:.875rem}.checkbox-label[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;cursor:pointer;color:var(--text-secondary, #aaa)}.checkbox-label[_ngcontent-%COMP%]   input[type=checkbox][_ngcontent-%COMP%]{width:16px;height:16px;accent-color:var(--primary, #3b82f6)}.forgot-link[_ngcontent-%COMP%]{color:var(--primary, #3b82f6);text-decoration:none;transition:color .2s}.forgot-link[_ngcontent-%COMP%]:hover{color:var(--primary-hover, #60a5fa);text-decoration:underline}.submit-btn[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:.5rem;padding:.875rem 1.5rem;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border:none;border-radius:8px;color:#fff;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s ease;margin-top:.5rem}.submit-btn[_ngcontent-%COMP%]:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px #3b82f64d}.submit-btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.loading-spinner[_ngcontent-%COMP%]{width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.divider[_ngcontent-%COMP%]{display:flex;align-items:center;margin:1.5rem 0;color:var(--text-muted, #666);font-size:.875rem}.divider[_ngcontent-%COMP%]:before, .divider[_ngcontent-%COMP%]:after{content:"";flex:1;height:1px;background:var(--border-color, #333)}.divider[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{padding:0 1rem}.social-login[_ngcontent-%COMP%]{display:flex;gap:1rem}.social-btn[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1rem;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:8px;color:var(--text-primary, #fff);font-size:.875rem;cursor:pointer;transition:all .2s ease}.social-btn[_ngcontent-%COMP%]:hover{background:var(--bg-tertiary, #252525);border-color:var(--border-hover, #444)}.social-btn.google[_ngcontent-%COMP%]   .social-icon[_ngcontent-%COMP%]{color:#ea4335;font-weight:700}.social-btn.telegram[_ngcontent-%COMP%]   .social-icon[_ngcontent-%COMP%]{color:#08c}.loading-spinner.small[_ngcontent-%COMP%]{width:14px;height:14px;border-width:2px}.register-link[_ngcontent-%COMP%]{text-align:center;margin-top:1.5rem;color:var(--text-secondary, #888);font-size:.875rem}.register-link[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{color:var(--primary, #3b82f6);text-decoration:none;font-weight:500}.register-link[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]:hover{text-decoration:underline}'],changeDetection:0})}};export{ee as LoginComponent};
