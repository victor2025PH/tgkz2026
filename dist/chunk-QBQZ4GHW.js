import{a as Q}from"./chunk-VSSEQNUC.js";import{e as U,g as F,h as G,j as z}from"./chunk-IOZ6RGE3.js";import{a as B,b as j,c as H,d as K,e as q,f as V,g as Y,p as X,t as $}from"./chunk-3FNGYHNZ.js";import{b as J}from"./chunk-ET36GW2V.js";import{o as W}from"./chunk-HDSZBSQ2.js";import{Eb as L,Fb as M,Gb as x,J as A,La as R,O as f,T as D,U as I,Vb as m,Ya as _,Za as b,a as S,b as E,cb as C,da as d,db as i,eb as a,fb as y,jb as N,nb as k,pb as u,xa as s,xb as l,yb as g,zb as v}from"./chunk-XBIFDY2N.js";var T={COOKIE_NAME:"csrf_token",HEADER_NAME:"X-CSRF-Token",STORAGE_KEY:"tgm_csrf_token"},p={MAX_ATTEMPTS:5,LOCKOUT_DURATION:300,ATTEMPT_WINDOW:900,STORAGE_KEY:"tgm_login_attempts"},O=class r{constructor(){this._csrfToken=d("");this.csrfToken=m(()=>this._csrfToken());this._isLocked=d(!1);this._lockoutRemaining=d(0);this._attemptCount=d(0);this.isLocked=m(()=>this._isLocked());this.lockoutRemaining=m(()=>this._lockoutRemaining());this.attemptCount=m(()=>this._attemptCount());this.attemptsLeft=m(()=>Math.max(0,p.MAX_ATTEMPTS-this._attemptCount()));this.refreshCsrfToken()}refreshCsrfToken(){let e=this.getCookie(T.COOKIE_NAME);e&&this._csrfToken.set(e)}getCsrfToken(){return this._csrfToken()}getCsrfHeaders(){let e=this.getCsrfToken();return e?{[T.HEADER_NAME]:e}:{}}async secureFetch(e,t={}){let n=new Headers(t.headers),o=this.getCsrfToken();o&&n.set(T.HEADER_NAME,o),n.has("Content-Type")||n.set("Content-Type","application/json");let c=await fetch(e,E(S({},t),{headers:n,credentials:"include"}));return this.refreshCsrfToken(),c}canAttemptLogin(){let e=this.getLockoutData(),t=Date.now();if(e.lockedUntil>t){let o=Math.ceil((e.lockedUntil-t)/1e3);return this._isLocked.set(!0),this._lockoutRemaining.set(o),{allowed:!1,message:`\u767B\u5165\u5617\u8A66\u6B21\u6578\u904E\u591A\uFF0C\u8ACB ${this.formatDuration(o)} \u5F8C\u518D\u8A66`,waitSeconds:o}}this._isLocked.set(!1),this._lockoutRemaining.set(0);let n=this.getRecentAttempts(e.attempts);if(this._attemptCount.set(n.length),n.length>=p.MAX_ATTEMPTS){let o=t+p.LOCKOUT_DURATION*1e3;this.setLockout(o,e.attempts);let c=p.LOCKOUT_DURATION;return this._isLocked.set(!0),this._lockoutRemaining.set(c),{allowed:!1,message:`\u767B\u5165\u5617\u8A66\u6B21\u6578\u904E\u591A\uFF0C\u8ACB ${this.formatDuration(c)} \u5F8C\u518D\u8A66`,waitSeconds:c}}return{allowed:!0}}recordLoginAttempt(e,t){let n=this.getLockoutData();n.attempts.push({timestamp:Date.now(),success:e,email:t}),n.attempts=this.getRecentAttempts(n.attempts),e&&(n.lockedUntil=0,n.attempts=[]),this.saveLockoutData(n),this._attemptCount.set(n.attempts.filter(o=>!o.success).length)}clearLoginLimit(){localStorage.removeItem(p.STORAGE_KEY),this._isLocked.set(!1),this._lockoutRemaining.set(0),this._attemptCount.set(0)}getRecentAttempts(e){let t=Date.now()-p.ATTEMPT_WINDOW*1e3;return e.filter(n=>n.timestamp>t&&!n.success)}getLockoutData(){try{let e=localStorage.getItem(p.STORAGE_KEY);if(e)return JSON.parse(e)}catch(e){console.error("Failed to parse lockout data:",e)}return{lockedUntil:0,attempts:[]}}saveLockoutData(e){localStorage.setItem(p.STORAGE_KEY,JSON.stringify(e))}setLockout(e,t){this.saveLockoutData({lockedUntil:e,attempts:t})}sanitizeHtml(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}isUrlSafe(e){return!e||e.toLowerCase().startsWith("javascript:")||e.toLowerCase().startsWith("data:")&&!e.toLowerCase().startsWith("data:image/")?!1:!!(e.startsWith("/")||e.startsWith("http://")||e.startsWith("https://"))}escapeHtml(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,n=>t[n])}getCookie(e){let t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?decodeURIComponent(t[2]):null}formatDuration(e){return e<60?`${e} \u79D2`:`${Math.ceil(e/60)} \u5206\u9418`}startLockoutCountdown(e){let t=setInterval(()=>{let n=this._lockoutRemaining();if(n<=0){clearInterval(t),this._isLocked.set(!1),e?.(0);return}this._lockoutRemaining.update(o=>o-1),e?.(n-1)},1e3);return()=>clearInterval(t)}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=A({token:r,factory:r.\u0275fac,providedIn:"root"})}};function ie(r,e){if(r&1&&(i(0,"div",3)(1,"span",25),l(2,"\u{1F512}"),a(),i(3,"div",26)(4,"span",27),l(5,"\u5E33\u865F\u66AB\u6642\u9396\u5B9A"),a(),i(6,"span",28),l(7),a()()()),r&2){let t=u();s(7),v("\u8ACB\u7B49\u5F85 ",t.lockoutRemaining()," \u79D2\u5F8C\u91CD\u8A66")}}function re(r,e){if(r&1&&(i(0,"div",4)(1,"span",29),l(2,"\u26A0\uFE0F"),a(),i(3,"span"),l(4),a()()),r&2){let t=u();s(4),g(t.error())}}function ae(r,e){if(r&1&&(y(0,"span",30),i(1,"span"),l(2),a()),r&2){let t=u();s(2),g(t.t("auth.loggingIn"))}}function se(r,e){if(r&1&&(i(0,"span"),l(1),a()),r&2){let t=u();s(),g(t.t("auth.login"))}}function le(r,e){r&1&&(i(0,"div",21),y(1,"div",31),a())}function ce(r,e){if(r&1&&(y(0,"span",33),i(1,"span"),l(2),a()),r&2){let t=u(2);s(2),g(t.t("auth.loadingTelegram"))}}function ge(r,e){if(r&1&&(i(0,"span",34),l(1,"\u2708\uFE0F"),a(),i(2,"span"),l(3),a()),r&2){let t=u(2);s(3),g(t.t("auth.loginWithTelegram"))}}function de(r,e){if(r&1){let t=N();i(0,"button",32),k("click",function(){D(t);let o=u();return I(o.initTelegramWidget())}),_(1,ce,3,1)(2,ge,4,1),a()}if(r&2){let t=u();C("disabled",t.telegramLoading()),s(),b(t.telegramLoading()?1:2)}}var Z=class r{constructor(){this.authService=f(Q);this.router=f(F);this.route=f(U);this.i18n=f(J);this.security=f(O);this.email="";this.password="";this.rememberMe=!1;this.showPassword=d(!1);this.isLoading=d(!1);this.telegramLoading=d(!1);this.telegramWidgetReady=d(!1);this.error=d(null);this.isLocked=m(()=>this.security.isLocked());this.lockoutRemaining=m(()=>this.security.lockoutRemaining());this.attemptsLeft=m(()=>this.security.attemptsLeft());this.telegramBotUsername="";this.telegramBotId="";this.lockoutCleanup=null}ngOnInit(){this.checkLoginLimit()}ngOnDestroy(){this.lockoutCleanup?.()}checkLoginLimit(){let e=this.security.canAttemptLogin();e.allowed||(this.error.set(e.message||""),this.lockoutCleanup=this.security.startLockoutCountdown(t=>{t<=0&&this.error.set(null)}))}t(e){return this.i18n.t(e)}async onSubmit(){if(!this.email||!this.password)return;let e=this.security.canAttemptLogin();if(!e.allowed){this.error.set(e.message||"");return}this.isLoading.set(!0),this.error.set(null);try{let t=await this.authService.login({email:this.email,password:this.password,remember:this.rememberMe});if(t.success){this.security.recordLoginAttempt(!0,this.email);let n=this.route.snapshot.queryParams.returnUrl||"/";this.router.navigateByUrl(n)}else{this.security.recordLoginAttempt(!1,this.email);let n=this.security.attemptsLeft(),o=t.error||this.t("auth.loginFailed");n>0&&n<=3&&(o+=` (\u5269\u9918 ${n} \u6B21\u5617\u8A66\u6A5F\u6703)`),this.error.set(o),this.checkLoginLimit()}}catch(t){this.security.recordLoginAttempt(!1,this.email),this.error.set(t.message||this.t("auth.loginFailed")),this.checkLoginLimit()}finally{this.isLoading.set(!1)}}async socialLogin(e){e==="telegram"?await this.initTelegramWidget():e==="google"&&await this.googleLogin()}async googleLogin(){this.isLoading.set(!0),this.error.set(null);try{let t=await(await fetch("/api/v1/oauth/google/config")).json();if(!t.success||!t.data?.enabled){this.error.set(this.t("auth.googleNotAvailable"));return}this.openGoogleLoginPopup()}catch(e){console.error("Google login error:",e),this.error.set(this.t("auth.googleNotAvailable"))}finally{this.isLoading.set(!1)}}openGoogleLoginPopup(){let t=`${window.location.origin}/api/v1/oauth/google/callback`,n=`/api/v1/oauth/google/authorize?callback=${encodeURIComponent(t)}`,o=550,c=600,ee=window.screenX+(window.outerWidth-o)/2,te=window.screenY+(window.outerHeight-c)/2,P=window.open(n,"GoogleAuth",`width=${o},height=${c},left=${ee},top=${te},toolbar=no,menubar=no,scrollbars=yes`),w=async h=>{h.data&&h.data.type==="google_auth"?(window.removeEventListener("message",w),P?.close(),await this.handleGoogleAuth(h.data.auth)):h.data&&h.data.type==="google_auth_error"&&(window.removeEventListener("message",w),P?.close(),this.error.set(h.data.error||"Google \u767B\u5165\u5931\u6557"),this.isLoading.set(!1))};window.addEventListener("message",w);let ne=setInterval(()=>{P?.closed&&(clearInterval(ne),window.removeEventListener("message",w),this.isLoading.set(!1))},500)}async handleGoogleAuth(e){this.isLoading.set(!0);try{if(e.access_token&&e.user){localStorage.setItem("tgm_access_token",e.access_token),e.refresh_token&&localStorage.setItem("tgm_refresh_token",e.refresh_token),localStorage.setItem("tgm_user",JSON.stringify(e.user));let t=this.route.snapshot.queryParams.returnUrl||"/";window.location.href=t}else this.error.set("Google \u767B\u5165\u5931\u6557\uFF1A\u7121\u6548\u7684\u8A8D\u8B49\u6578\u64DA")}catch(t){this.error.set(t.message||"Google \u767B\u5165\u5931\u6557")}finally{this.isLoading.set(!1)}}async initTelegramWidget(){this.telegramLoading.set(!0),this.error.set(null);try{let e=await this.authService.getTelegramConfig();if(!e.enabled||!e.bot_username){this.error.set(this.t("auth.telegramNotConfigured"));return}this.telegramBotUsername=e.bot_username,this.telegramBotId=e.bot_id||"",window.onTelegramAuth=t=>{console.log("Telegram auth callback:",t),this.handleTelegramAuth(t)},await this.loadTelegramWidgetScript(),this.telegramWidgetReady.set(!0)}catch(e){console.error("Telegram widget init error:",e),this.error.set(e.message||"Telegram \u8F09\u5165\u5931\u6557")}finally{this.telegramLoading.set(!1)}}loadTelegramWidgetScript(){return new Promise((e,t)=>{if(document.getElementById("telegram-widget-script")){e();return}let n=document.getElementById("telegram-login-widget");if(!n){t(new Error("Widget container not found"));return}n.innerHTML="";let o=document.createElement("script");o.id="telegram-widget-script",o.src="https://telegram.org/js/telegram-widget.js?22",o.async=!0,o.setAttribute("data-telegram-login",this.telegramBotUsername),o.setAttribute("data-size","large"),o.setAttribute("data-radius","8"),o.setAttribute("data-onauth","onTelegramAuth(user)"),o.setAttribute("data-request-access","write"),o.onload=()=>{console.log("Telegram widget script loaded"),e()},o.onerror=()=>{t(new Error("Failed to load Telegram widget"))},n.appendChild(o)})}async handleTelegramAuth(e){this.telegramLoading.set(!0);try{let t=await this.authService.telegramLogin(e);if(t.success){let n=this.route.snapshot.queryParams.returnUrl||"/";this.router.navigateByUrl(n)}else this.error.set(t.error||"Telegram \u767B\u5165\u5931\u6557")}catch(t){this.error.set(t.message||"Telegram \u767B\u5165\u5931\u6557")}finally{this.telegramLoading.set(!1)}}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275cmp=R({type:r,selectors:[["app-login"]],decls:44,vars:23,consts:[[1,"login-page"],[1,"page-title"],[1,"page-subtitle"],[1,"lockout-alert"],[1,"error-alert"],[1,"login-form",3,"ngSubmit"],[1,"form-group"],["for","email"],[1,"input-wrapper"],[1,"input-icon"],["type","email","id","email","name","email","required","","autocomplete","email",3,"ngModelChange","ngModel","placeholder","disabled"],["for","password"],["id","password","name","password","required","","autocomplete","current-password",3,"ngModelChange","type","ngModel","placeholder","disabled"],["type","button",1,"toggle-password",3,"click"],[1,"form-options"],[1,"checkbox-label"],["type","checkbox","name","rememberMe",3,"ngModelChange","ngModel"],["routerLink","/auth/forgot-password",1,"forgot-link"],["type","submit",1,"submit-btn",3,"disabled"],[1,"divider"],[1,"social-login"],[1,"telegram-widget-container"],[1,"social-btn","telegram","full-width",3,"disabled"],[1,"register-link"],["routerLink","/auth/register"],[1,"lockout-icon"],[1,"lockout-content"],[1,"lockout-title"],[1,"lockout-time"],[1,"error-icon"],[1,"loading-spinner"],["id","telegram-login-widget"],[1,"social-btn","telegram","full-width",3,"click","disabled"],[1,"loading-spinner","small"],[1,"social-icon"]],template:function(t,n){t&1&&(i(0,"div",0)(1,"h2",1),l(2),a(),i(3,"p",2),l(4),a(),_(5,ie,8,1,"div",3),_(6,re,5,1,"div",4),i(7,"form",5),k("ngSubmit",function(){return n.onSubmit()}),i(8,"div",6)(9,"label",7),l(10),a(),i(11,"div",8)(12,"span",9),l(13,"\u{1F4E7}"),a(),i(14,"input",10),x("ngModelChange",function(c){return M(n.email,c)||(n.email=c),c}),a()()(),i(15,"div",6)(16,"label",11),l(17),a(),i(18,"div",8)(19,"span",9),l(20,"\u{1F512}"),a(),i(21,"input",12),x("ngModelChange",function(c){return M(n.password,c)||(n.password=c),c}),a(),i(22,"button",13),k("click",function(){return n.showPassword.set(!n.showPassword())}),l(23),a()()(),i(24,"div",14)(25,"label",15)(26,"input",16),x("ngModelChange",function(c){return M(n.rememberMe,c)||(n.rememberMe=c),c}),a(),i(27,"span"),l(28),a()(),i(29,"a",17),l(30),a()(),i(31,"button",18),_(32,ae,3,1)(33,se,2,1,"span"),a()(),i(34,"div",19)(35,"span"),l(36),a()(),i(37,"div",20),_(38,le,2,0,"div",21)(39,de,3,2,"button",22),a(),i(40,"p",23),l(41),i(42,"a",24),l(43),a()()()),t&2&&(s(2),g(n.t("auth.welcomeBack")),s(2),g(n.t("auth.loginSubtitle")),s(),b(n.isLocked()?5:-1),s(),b(n.error()&&!n.isLocked()?6:-1),s(4),g(n.t("auth.email")),s(4),L("ngModel",n.email),C("placeholder",n.t("auth.emailPlaceholder"))("disabled",n.isLoading()),s(3),g(n.t("auth.password")),s(4),C("type",n.showPassword()?"text":"password"),L("ngModel",n.password),C("placeholder",n.t("auth.passwordPlaceholder"))("disabled",n.isLoading()),s(2),v(" ",n.showPassword()?"\u{1F648}":"\u{1F441}\uFE0F"," "),s(3),L("ngModel",n.rememberMe),s(2),g(n.t("auth.rememberMe")),s(2),v(" ",n.t("auth.forgotPassword")," "),s(),C("disabled",n.isLoading()||!n.email||!n.password||n.isLocked()),s(),b(n.isLoading()?32:33),s(4),g(n.t("auth.or")),s(2),b(n.telegramWidgetReady()?38:39),s(3),v(" ",n.t("auth.noAccount")," "),s(2),g(n.t("auth.registerNow")))},dependencies:[W,$,Y,j,B,H,K,X,V,q,z,G],styles:['.login-page[_ngcontent-%COMP%]{color:var(--text-primary, #fff)}.page-title[_ngcontent-%COMP%]{font-size:1.75rem;font-weight:700;margin-bottom:.5rem}.page-subtitle[_ngcontent-%COMP%]{color:var(--text-secondary, #888);margin-bottom:2rem}.error-alert[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;padding:.875rem 1rem;background:#ef44441a;border:1px solid rgba(239,68,68,.3);border-radius:8px;color:#f87171;margin-bottom:1.5rem;font-size:.875rem}.lockout-alert[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:1rem 1.25rem;background:#fb923c1a;border:1px solid rgba(251,146,60,.3);border-radius:8px;color:#fb923c;margin-bottom:1.5rem}.lockout-icon[_ngcontent-%COMP%]{font-size:1.5rem}.lockout-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.lockout-title[_ngcontent-%COMP%]{font-weight:600;font-size:.9rem}.lockout-time[_ngcontent-%COMP%]{font-size:.8rem;opacity:.8}.login-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.25rem}.form-group[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-size:.875rem;font-weight:500;color:var(--text-secondary, #aaa)}.input-wrapper[_ngcontent-%COMP%]{position:relative;display:flex;align-items:center}.input-icon[_ngcontent-%COMP%]{position:absolute;left:1rem;font-size:1rem;opacity:.5}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;padding:.875rem 1rem .875rem 2.75rem;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:8px;color:var(--text-primary, #fff);font-size:1rem;transition:all .2s ease}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--primary, #3b82f6);box-shadow:0 0 0 3px #3b82f61a}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]::placeholder{color:var(--text-muted, #666)}.toggle-password[_ngcontent-%COMP%]{position:absolute;right:1rem;background:none;border:none;cursor:pointer;font-size:1rem;opacity:.5;transition:opacity .2s}.toggle-password[_ngcontent-%COMP%]:hover{opacity:1}.form-options[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;font-size:.875rem}.checkbox-label[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;cursor:pointer;color:var(--text-secondary, #aaa)}.checkbox-label[_ngcontent-%COMP%]   input[type=checkbox][_ngcontent-%COMP%]{width:16px;height:16px;accent-color:var(--primary, #3b82f6)}.forgot-link[_ngcontent-%COMP%]{color:var(--primary, #3b82f6);text-decoration:none;transition:color .2s}.forgot-link[_ngcontent-%COMP%]:hover{color:var(--primary-hover, #60a5fa);text-decoration:underline}.submit-btn[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:.5rem;padding:.875rem 1.5rem;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border:none;border-radius:8px;color:#fff;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s ease;margin-top:.5rem}.submit-btn[_ngcontent-%COMP%]:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px #3b82f64d}.submit-btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.loading-spinner[_ngcontent-%COMP%]{width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.divider[_ngcontent-%COMP%]{display:flex;align-items:center;margin:1.5rem 0;color:var(--text-muted, #666);font-size:.875rem}.divider[_ngcontent-%COMP%]:before, .divider[_ngcontent-%COMP%]:after{content:"";flex:1;height:1px;background:var(--border-color, #333)}.divider[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{padding:0 1rem}.social-login[_ngcontent-%COMP%]{display:flex;gap:1rem}.social-btn[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1rem;background:var(--bg-secondary, #1a1a1a);border:1px solid var(--border-color, #333);border-radius:8px;color:var(--text-primary, #fff);font-size:.875rem;cursor:pointer;transition:all .2s ease}.social-btn[_ngcontent-%COMP%]:hover{background:var(--bg-tertiary, #252525);border-color:var(--border-hover, #444)}.social-btn.google[_ngcontent-%COMP%]   .social-icon[_ngcontent-%COMP%]{color:#ea4335;font-weight:700}.social-btn.telegram[_ngcontent-%COMP%]   .social-icon[_ngcontent-%COMP%]{color:#08c}.social-btn.full-width[_ngcontent-%COMP%]{width:100%;flex:none}.social-btn.telegram[_ngcontent-%COMP%]{background:linear-gradient(135deg,#08c,#0077b5);border-color:#08c}.social-btn.telegram[_ngcontent-%COMP%]:hover{background:linear-gradient(135deg,#09d,#08c)}.telegram-widget-container[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;min-height:48px;width:100%}.telegram-widget-container[_ngcontent-%COMP%]   iframe[_ngcontent-%COMP%]{border-radius:8px!important}#telegram-login-widget[_ngcontent-%COMP%]{display:flex;justify-content:center}.loading-spinner.small[_ngcontent-%COMP%]{width:14px;height:14px;border-width:2px}.register-link[_ngcontent-%COMP%]{text-align:center;margin-top:1.5rem;color:var(--text-secondary, #888);font-size:.875rem}.register-link[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{color:var(--primary, #3b82f6);text-decoration:none;font-weight:500}.register-link[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]:hover{text-decoration:underline}'],changeDetection:0})}};export{Z as LoginComponent};
