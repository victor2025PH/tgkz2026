import{a as m}from"./chunk-3V3KVMT4.js";import{M as c,Q as d,Vb as s,a as l,b as u,ga as n}from"./chunk-YLSLTE5F.js";var g=class o{constructor(e){this.ipc=e;this._quotaSummary=n(null);this.quotaSummary=this._quotaSummary.asReadonly();this._levels=n([]);this.levels=this._levels.asReadonly();this._alerts=n([]);this.alerts=this._alerts.asReadonly();this._loading=n(!1);this.loading=this._loading.asReadonly();this.currentTier=s(()=>this._quotaSummary()?.tier||"bronze");this.currentTierName=s(()=>this._quotaSummary()?.tier_name||"\u9752\u9285\u6230\u58EB");this.hasWarnings=s(()=>this._quotaSummary()?.has_warnings||!1);this.hasExceeded=s(()=>this._quotaSummary()?.has_exceeded||!1);this.unacknowledgedAlerts=s(()=>this._alerts().filter(e=>!e.acknowledged).length);this.quotaDisplayNames={tg_accounts:"TG \u5E33\u865F",daily_messages:"\u6BCF\u65E5\u6D88\u606F",ai_calls:"AI \u8ABF\u7528",devices:"\u8A2D\u5099\u6578",groups:"\u7FA4\u7D44\u6578",keyword_sets:"\u95DC\u9375\u8A5E\u96C6",auto_reply_rules:"\u81EA\u52D5\u56DE\u8986",scheduled_tasks:"\u5B9A\u6642\u4EFB\u52D9"};this._refreshDebounce=null;this.ipc.on("quota-updated",(t,r)=>{this._refreshDebounce&&clearTimeout(this._refreshDebounce),this._refreshDebounce=setTimeout(()=>{this._refreshDebounce=null,this.loadQuotaSummary()},500)})}async loadQuotaSummary(){this._loading.set(!0);try{let e=await this.ipc.invoke("get-quota-status",{});e?.success&&e?.data&&this._quotaSummary.set(e.data)}catch(e){console.error("Failed to load quota summary:",e)}finally{this._loading.set(!1)}}async checkQuota(e,t=1){try{let r=await this.ipc.invoke("check-quota",{quota_type:e,amount:t});return r?.success&&r?.data?r.data:null}catch(r){return console.error("Failed to check quota:",r),null}}async loadAlerts(){try{let e=await this.ipc.invoke("get-quota-alerts",{});e?.success&&e?.data?.alerts&&this._alerts.set(e.data.alerts)}catch(e){console.error("Failed to load alerts:",e)}}async acknowledgeAlert(e){try{return(await this.ipc.invoke("acknowledge-quota-alert",{alert_id:e}))?.success?(this._alerts.update(r=>r.map(a=>a.id===e?u(l({},a),{acknowledged:!0}):a)),!0):!1}catch(t){return console.error("Failed to acknowledge alert:",t),!1}}async loadMembershipLevels(){try{let e=await this.ipc.invoke("get-membership-levels",{});e?.success&&e?.data?.levels&&this._levels.set(e.data.levels)}catch(e){console.error("Failed to load membership levels:",e)}}getQuotaInfo(e){return this._quotaSummary()?.quotas?.[e]||null}getQuotaDisplayName(e){return this.quotaDisplayNames[e]||e}formatQuotaValue(e){return e===-1?"\u221E":e>=1e6?`${(e/1e6).toFixed(1)}M`:e>=1e3?`${(e/1e3).toFixed(1)}K`:e.toString()}getStatusColor(e){return{ok:"#22c55e",warning:"#f59e0b",critical:"#ef4444",exceeded:"#dc2626",unlimited:"#8b5cf6"}[e]||"#666"}getStatusIcon(e){return{ok:"\u2713",warning:"\u26A0\uFE0F",critical:"\u26A1",exceeded:"\u{1F6AB}",unlimited:"\u221E"}[e]||""}getUpgradeOptions(){let e=this.currentTier(),t=this._levels(),r=t.find(a=>a.level===e)?.order??0;return t.filter(a=>a.order>r)}canPerformAction(e,t=1){let r=this.getQuotaInfo(e);return!r||r.unlimited?!0:r.remaining>=t}async refresh(){await Promise.all([this.loadQuotaSummary(),this.loadAlerts()])}async loadTrendData(e="7d",t=["daily_messages","ai_calls"]){try{let r=await this.ipc.invoke("get-quota-trend",{period:e,types:t.join(",")});return r?.success&&r?.data?r.data:null}catch(r){return console.error("Failed to load trend data:",r),null}}async loadHistory(e=50,t=0,r){try{let a={limit:e,offset:t};r&&(a.type=r);let i=await this.ipc.invoke("get-quota-history",a);return i?.success&&i?.data?i.data:null}catch(a){return console.error("Failed to load history:",a),null}}static{this.\u0275fac=function(t){return new(t||o)(d(m))}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};export{g as a};
