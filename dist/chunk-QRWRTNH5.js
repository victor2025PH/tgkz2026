import{a as y}from"./chunk-A22KDSKM.js";import{b}from"./chunk-7LTHB4NI.js";import{a as w}from"./chunk-5HHK7KPZ.js";import{M as v,R as h,Zb as p,a as g,b as m,ga as f}from"./chunk-PDD6YQ47.js";var x={price_inquiry:["\u591A\u5C11\u9322","\u4EC0\u9EBC\u50F9\u683C","\u50F9\u683C","\u8CBB\u7528","\u6536\u8CBB","\u600E\u9EBC\u6536","\u5831\u50F9"],product_detail:["\u600E\u9EBC\u7528","\u6709\u4EC0\u9EBC\u529F\u80FD","\u8A73\u7D30\u4ECB\u7D39","\u4E86\u89E3\u4E00\u4E0B","\u80FD\u505A\u4EC0\u9EBC"],purchase_intent:["\u600E\u9EBC\u8CB7","\u5728\u54EA\u8CB7","\u6211\u8981","\u6211\u60F3\u8CB7","\u4E0B\u55AE","\u4ED8\u6B3E","\u8CFC\u8CB7"],positive_feedback:["\u4E0D\u932F","\u633A\u597D","\u53EF\u4EE5","\u884C","\u597D\u7684","\u611F\u8208\u8DA3"],comparison:["\u6BD4","\u5C0D\u6BD4","\u5340\u5225","\u5DEE\u5225","\u54EA\u500B\u597D"]},C={id:"default_marketing",name:"\u667A\u80FD\u71DF\u92B7\u5DE5\u4F5C\u6D41",enabled:!1,trigger:{type:"keyword_match",minIntentScore:60,cooldownMinutes:1440,excludeContacted:!0,excludeBlacklist:!0},steps:[{id:"evaluate",type:"evaluate",name:"\u7528\u6236\u8A55\u4F30",config:{},nextOnSuccess:"plan"},{id:"plan",type:"plan",name:"AI \u7B56\u5283",config:{},nextOnSuccess:"private_chat"},{id:"private_chat",type:"private_chat",name:"\u79C1\u804A\u5354\u4F5C",config:{},nextOnSuccess:"detect_interest"},{id:"detect_interest",type:"detect_interest",name:"\u8208\u8DA3\u6AA2\u6E2C",config:{},nextOnSuccess:"create_group",nextOnFail:"record"},{id:"create_group",type:"create_group",name:"\u81EA\u52D5\u5EFA\u7FA4",config:{},nextOnSuccess:"group_marketing"},{id:"group_marketing",type:"group_marketing",name:"\u7D44\u7FA4\u71DF\u92B7",config:{},nextOnSuccess:"record"},{id:"record",type:"record",name:"\u8A18\u9304\u7D50\u679C",config:{}}],config:{marketingGoal:"\u4FC3\u9032\u6210\u4EA4",roleCount:"auto",accountSelection:"auto",firstContactDelay:{min:5,max:15},interestSignals:["price_inquiry","purchase_intent","positive_feedback"]},stats:{totalTriggers:0,todayTriggers:0,activeExecutions:0,conversions:0},createdAt:new Date,updatedAt:new Date},k=class d{constructor(){this.ipc=h(w);this.toast=h(b);this.contacts=h(y);this.STORAGE_KEY="automationWorkflows";this._workflows=f([C]);this.workflows=this._workflows.asReadonly();this._executions=f(new Map);this.executions=p(()=>Array.from(this._executions().values()));this.activeExecutionCount=p(()=>this.executions().filter(e=>e.status==="running"||e.status==="pending").length);this.userCooldowns=new Map;this.ipcCleanups=[];this.loadFromStorage(),this.setupEventListeners(),console.log("[AutomationWorkflow] \u670D\u52D9\u5DF2\u521D\u59CB\u5316")}setupEventListeners(){let e=this.ipc.on("keyword-matched",o=>{this.handleKeywordMatch(o)});this.ipcCleanups.push(e);let s=this.ipc.on("lead-captured",o=>{this.handleLeadCaptured(o)});this.ipcCleanups.push(s);let t=this.ipc.on("private-message-received",o=>{this.handlePrivateMessage(o)});this.ipcCleanups.push(t);let n=this.ipc.on("collaboration-session-completed",o=>{this.handleSessionCompleted(o)});this.ipcCleanups.push(n)}handleKeywordMatch(e){console.log("[AutomationWorkflow] \u6536\u5230\u95DC\u9375\u8A5E\u5339\u914D:",e);let s=this._workflows().filter(t=>t.enabled&&t.trigger.type==="keyword_match");if(s.length===0){console.log("[AutomationWorkflow] \u7121\u555F\u7528\u7684\u5DE5\u4F5C\u6D41\uFF0C\u8DF3\u904E");return}for(let t of s)this.tryTriggerWorkflow(t,e)}async tryTriggerWorkflow(e,s){let t=s.userId;if(this.isUserInCooldown(t,e.trigger.cooldownMinutes||1440)){console.log(`[AutomationWorkflow] \u7528\u6236 ${t} \u5728\u51B7\u537B\u671F\u5167\uFF0C\u8DF3\u904E`);return}if(this.executions().find(c=>c.targetUserId===t&&(c.status==="running"||c.status==="pending"))){console.log(`[AutomationWorkflow] \u7528\u6236 ${t} \u5DF2\u6709\u9032\u884C\u4E2D\u7684\u5DE5\u4F5C\u6D41\uFF0C\u8DF3\u904E`);return}let o=this.evaluateUserIntent(s),r=e.trigger.minIntentScore||60;if(o<r){console.log(`[AutomationWorkflow] \u7528\u6236\u610F\u5411\u5206 ${o} < ${r}\uFF0C\u8DF3\u904E`);return}let a=this.createExecution(e,s,o);this.userCooldowns.set(t,new Date),this.updateWorkflowStats(e.id,"trigger"),this.toast.success(`\u{1F680} \u81EA\u52D5\u89F8\u767C\u5DE5\u4F5C\u6D41\uFF1A${e.name}`),console.log(`[AutomationWorkflow] \u958B\u59CB\u57F7\u884C\u5DE5\u4F5C\u6D41: ${e.name}\uFF0C\u76EE\u6A19\u7528\u6236: ${s.username||t}`);let l=this.getRandomDelay(e.config.firstContactDelay);console.log(`[AutomationWorkflow] \u5C07\u5728 ${l} \u79D2\u5F8C\u958B\u59CB\u57F7\u884C`),setTimeout(()=>{this.executeWorkflow(a.id)},l*1e3)}handleLeadCaptured(e){console.log("[AutomationWorkflow] \u6536\u5230\u7528\u6236\u6355\u7372\u4E8B\u4EF6:",e)}handlePrivateMessage(e){if(!e.fromUser)return;let s=this.executions().find(n=>n.targetUserId===e.userId&&n.status==="running"&&n.currentStep==="private_chat");if(!s)return;let t=this.detectInterestSignal(e.message);t&&(console.log("[AutomationWorkflow] \u6AA2\u6E2C\u5230\u8208\u8DA3\u4FE1\u865F:",t),this.updateExecutionStep(s.id,"detect_interest",{status:"success",data:t,timestamp:new Date}),(t.type==="purchase_intent"||t.type==="price_inquiry")&&(this.toast.info("\u{1F3AF} \u6AA2\u6E2C\u5230\u8CFC\u8CB7\u610F\u5411\uFF01\u6E96\u5099\u81EA\u52D5\u5EFA\u7FA4..."),this.advanceToStep(s.id,"create_group")))}handleSessionCompleted(e){let s=this.executions().find(t=>t.sessionId===e.sessionId);s&&(this.updateExecution(s.id,{outcome:e.outcome,status:"completed",completedAt:new Date}),e.outcome==="converted"&&this.updateWorkflowStats(s.workflowId,"conversion"))}async executeWorkflow(e){let s=this._executions().get(e);if(!s)return;let t=this._workflows().find(o=>o.id===s.workflowId);if(!t)return;this.updateExecution(e,{status:"running"});let n=t.steps.find(o=>o.id===s.currentStep);if(n){console.log(`[AutomationWorkflow] \u57F7\u884C\u6B65\u9A5F: ${n.name}`);try{let o=await this.executeStep(s,n,t);this.updateExecutionStep(e,n.id,o);let r=o.status==="success"?n.nextOnSuccess:n.nextOnFail;r?this.advanceToStep(e,r):(this.updateExecution(e,{status:"completed",completedAt:new Date}),console.log(`[AutomationWorkflow] \u5DE5\u4F5C\u6D41\u57F7\u884C\u5B8C\u6210: ${e}`))}catch(o){console.error("[AutomationWorkflow] \u6B65\u9A5F\u57F7\u884C\u5931\u6557:",o),this.updateExecutionStep(e,n.id,{status:"failed",error:o.message,timestamp:new Date}),this.updateExecution(e,{status:"failed"})}}}async executeStep(e,s,t){switch(s.type){case"evaluate":return{status:"success",timestamp:new Date};case"plan":return await this.executeAiPlanStep(e,t);case"private_chat":return await this.executePrivateChatStep(e,t);case"detect_interest":return{status:"success",timestamp:new Date};case"create_group":return await this.executeCreateGroupStep(e,t);case"group_marketing":return await this.executeGroupMarketingStep(e,t);case"record":return this.executeRecordStep(e);default:return{status:"skipped",timestamp:new Date}}}async executeAiPlanStep(e,s){return new Promise(t=>{let n=s.config.marketingGoal||"\u4FC3\u9032\u6210\u4EA4";console.log(`[AutomationWorkflow] \u8ABF\u7528 AI \u7B56\u5283\uFF0C\u76EE\u6A19: ${n}`),this.ipc.send("multi-role:ai-plan",{goal:n,targetUsers:[{id:e.targetUserId,username:e.targetUserName}],autoExecute:!0,workflowExecutionId:e.id});let o=this.ipc.on("multi-role:ai-plan-result",r=>{o(),r.success?(this.updateExecution(e.id,{aiPlanResult:r}),t({status:"success",data:r,timestamp:new Date})):t({status:"failed",error:r.error,timestamp:new Date})});setTimeout(()=>{o(),t({status:"failed",error:"\u7B56\u5283\u8D85\u6642",timestamp:new Date})},6e4)})}async executePrivateChatStep(e,s){return console.log(`[AutomationWorkflow] \u958B\u59CB\u79C1\u804A\u5354\u4F5C\uFF0C\u76EE\u6A19\u7528\u6236: ${e.targetUserName}`),this.ipc.send("multi-role:start-private-collaboration",{targetUserId:e.targetUserId,targetUserName:e.targetUserName,aiPlanResult:e.aiPlanResult,workflowExecutionId:e.id}),{status:"success",timestamp:new Date}}async executeCreateGroupStep(e,s){return new Promise(t=>{let n=(s.config.groupNameTemplate||"VIP \u670D\u52D9\u7FA4 - {user}").replace("{user}",e.targetUserName);console.log(`[AutomationWorkflow] \u81EA\u52D5\u5EFA\u7FA4: ${n}`),this.ipc.send("multi-role:auto-create-group",{groupName:n,targetUserId:e.targetUserId,workflowExecutionId:e.id});let o=this.ipc.on("multi-role:group-created",r=>{o(),r.success?(this.updateExecution(e.id,{groupId:r.groupId}),this.toast.success(`\u2705 \u5DF2\u81EA\u52D5\u5275\u5EFA\u7FA4\u7D44: ${n}`),t({status:"success",data:r,timestamp:new Date})):t({status:"failed",error:r.error,timestamp:new Date})});setTimeout(()=>{o(),t({status:"failed",error:"\u5EFA\u7FA4\u8D85\u6642",timestamp:new Date})},12e4)})}async executeGroupMarketingStep(e,s){return e.groupId?(console.log(`[AutomationWorkflow] \u958B\u59CB\u7D44\u7FA4\u71DF\u92B7\uFF0C\u7FA4\u7D44: ${e.groupId}`),this.ipc.send("multi-role:start-group-collaboration",{groupId:e.groupId,aiPlanResult:e.aiPlanResult,workflowExecutionId:e.id}),{status:"success",timestamp:new Date}):{status:"skipped",timestamp:new Date}}executeRecordStep(e){return console.log("[AutomationWorkflow] \u8A18\u9304\u57F7\u884C\u7D50\u679C:",e),{status:"success",timestamp:new Date}}evaluateUserIntent(e){let s=50,t=e.messagePreview?.toLowerCase()||"";return(t.includes("\u50F9\u683C")||t.includes("\u591A\u5C11\u9322"))&&(s+=20),(t.includes("\u600E\u9EBC\u8CB7")||t.includes("\u8CFC\u8CB7"))&&(s+=25),(t.includes("\u4E86\u89E3")||t.includes("\u4ECB\u7D39"))&&(s+=10),(t.includes("\u6025")||t.includes("\u99AC\u4E0A"))&&(s+=15),Math.min(100,s)}detectInterestSignal(e){let s=e.toLowerCase();for(let[t,n]of Object.entries(x))for(let o of n)if(s.includes(o))return{type:t,keyword:o,confidence:.8,message:e,detectedAt:new Date};return null}async detectInterestSignalWithAI(e,s=[]){let t=this.detectInterestSignal(e);return t&&t.confidence>=.8?t:new Promise(n=>{let o=s.slice(-5).join(`
`);this.ipc.send("ai:analyze-interest",{message:e,context:o,analysisType:"interest_signal"});let r=this.ipc.on("ai:analyze-interest-result",a=>{r(),a.success&&a.hasInterest?n({type:this.mapAISignalType(a.signalType),keyword:a.keyPhrase||e.substring(0,20),confidence:a.confidence||.7,message:e,detectedAt:new Date}):n(null)});setTimeout(()=>{r(),n(t)},5e3)})}mapAISignalType(e){return{price:"price_inquiry",buying:"purchase_intent",positive:"positive_feedback",detail:"product_detail",compare:"comparison"}[e]||"positive_feedback"}analyzeConversationStage(e){let s=e.filter(n=>n.fromUser).map(n=>n.text.toLowerCase()),t=s[s.length-1]||"";return this.containsAny(t,["\u600E\u9EBC\u4ED8\u6B3E","\u4E0B\u55AE","\u8CFC\u8CB7","\u4ED8\u9322","\u8F49\u5E33"])?{stage:"purchase",confidence:.9,nextAction:"\u63D0\u4F9B\u4ED8\u6B3E\u65B9\u5F0F"}:this.containsAny(t,["\u591A\u5C11\u9322","\u50F9\u683C","\u512A\u60E0","\u6298\u6263","\u4FBF\u5B9C"])?{stage:"intent",confidence:.85,nextAction:"\u5831\u50F9\u4E26\u5F37\u8ABF\u50F9\u503C"}:this.containsAny(t,["\u6709\u4EC0\u9EBC","\u80FD\u505A\u4EC0\u9EBC","\u529F\u80FD","\u8A73\u7D30","\u4E86\u89E3"])?{stage:"consideration",confidence:.8,nextAction:"\u8A73\u7D30\u4ECB\u7D39\u7522\u54C1"}:this.containsAny(t,["\u4E0D\u932F","\u53EF\u4EE5","\u633A\u597D","\u611F\u8208\u8DA3"])?{stage:"interest",confidence:.7,nextAction:"\u6316\u6398\u9700\u6C42"}:{stage:"awareness",confidence:.6,nextAction:"\u5EFA\u7ACB\u4FE1\u4EFB"}}containsAny(e,s){return s.some(t=>e.includes(t))}calculateConversionProbability(e){let s=.3,t=e.stepResults;if(t.plan?.status==="success"&&(s+=.1),t.private_chat?.status==="success"&&(s+=.15),t.detect_interest?.status==="success"){s+=.25;let n=t.detect_interest?.data;(n?.type==="purchase_intent"||n?.type==="price_inquiry")&&(s+=.15)}return t.create_group?.status==="success"&&(s+=.1),Math.min(.95,s)}isUserInCooldown(e,s){let t=this.userCooldowns.get(e);if(!t)return!1;let n=s*60*1e3;return Date.now()-t.getTime()<n}getRandomDelay(e){return Math.floor(Math.random()*(e.max-e.min+1))+e.min}createExecution(e,s,t){let n={id:`exec_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,workflowId:e.id,targetUserId:s.userId,targetUserName:s.username||s.firstName||"User",currentStep:e.steps[0].id,status:"pending",stepResults:{},startedAt:new Date,updatedAt:new Date};return this._executions.update(o=>{let r=new Map(o);return r.set(n.id,n),r}),n}updateExecution(e,s){this._executions.update(t=>{let n=new Map(t),o=n.get(e);return o&&n.set(e,m(g(g({},o),s),{updatedAt:new Date})),n})}updateExecutionStep(e,s,t){this._executions.update(n=>{let o=new Map(n),r=o.get(e);return r&&o.set(e,m(g({},r),{stepResults:m(g({},r.stepResults),{[s]:t}),updatedAt:new Date})),o})}advanceToStep(e,s){this.updateExecution(e,{currentStep:s}),setTimeout(()=>{this.executeWorkflow(e)},1e3)}updateWorkflowStats(e,s){this._workflows.update(t=>t.map(n=>n.id!==e?n:m(g({},n),{stats:m(g({},n.stats),{totalTriggers:n.stats.totalTriggers+(s==="trigger"?1:0),todayTriggers:n.stats.todayTriggers+(s==="trigger"?1:0),conversions:n.stats.conversions+(s==="conversion"?1:0),lastTriggeredAt:s==="trigger"?new Date:n.stats.lastTriggeredAt}),updatedAt:new Date}))),this.saveToStorage()}toggleWorkflow(e,s){this._workflows.update(t=>t.map(n=>n.id===e?m(g({},n),{enabled:s,updatedAt:new Date}):n)),this.saveToStorage(),this.toast.success(s?"\u2705 \u5DE5\u4F5C\u6D41\u5DF2\u555F\u7528":"\u23F8\uFE0F \u5DE5\u4F5C\u6D41\u5DF2\u66AB\u505C")}manualTrigger(e,s){let t=this._workflows().find(n=>n.id===e);if(!t){this.toast.error("\u627E\u4E0D\u5230\u5DE5\u4F5C\u6D41");return}this.tryTriggerWorkflow(t,m(g({},s),{messagePreview:"\u624B\u52D5\u89F8\u767C",manual:!0}))}cancelExecution(e){this.updateExecution(e,{status:"cancelled",completedAt:new Date}),this.toast.info("\u5DF2\u53D6\u6D88\u5DE5\u4F5C\u6D41\u57F7\u884C")}getExecution(e){return this._executions().get(e)}saveToStorage(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this._workflows()))}catch(e){console.error("[AutomationWorkflow] \u4FDD\u5B58\u5931\u6557:",e)}}loadFromStorage(){try{let e=localStorage.getItem(this.STORAGE_KEY);if(e){let s=JSON.parse(e);this._workflows.set(s.map(t=>m(g({},t),{createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt),stats:m(g({},t.stats),{lastTriggeredAt:t.stats.lastTriggeredAt?new Date(t.stats.lastTriggeredAt):void 0})})))}}catch(e){console.error("[AutomationWorkflow] \u8F09\u5165\u5931\u6557:",e)}}destroy(){this.ipcCleanups.forEach(e=>e())}static{this.\u0275fac=function(s){return new(s||d)}}static{this.\u0275prov=v({token:d,factory:d.\u0275fac,providedIn:"root"})}};var _=class d{constructor(){this.ipc=h(w);this._sessions=f([]);this._userProfiles=f(new Map);this._roleComboStats=f(new Map);this.sessions=this._sessions.asReadonly();this.userProfiles=p(()=>Array.from(this._userProfiles().values()));this.roleComboStats=p(()=>Array.from(this._roleComboStats().values()));this.totalStats=p(()=>{let e=this._sessions(),s=e.filter(t=>t.outcome==="converted").length;return{totalSessions:e.length,conversions:s,conversionRate:e.length>0?s/e.length*100:0,avgInterestScore:this.calcAverage(e.map(t=>t.interestScore)),avgEngagementScore:this.calcAverage(e.map(t=>t.engagementScore)),totalRevenue:e.reduce((t,n)=>t+(n.conversionValue||0),0)}});this.todayStats=p(()=>{let e=new Date().toISOString().split("T")[0],s=this._sessions().filter(n=>n.startTime.toISOString().split("T")[0]===e),t=s.filter(n=>n.outcome==="converted").length;return{sessions:s.length,conversions:t,conversionRate:s.length>0?t/s.length*100:0,revenue:s.reduce((n,o)=>n+(o.conversionValue||0),0)}});this.topRoleCombos=p(()=>Array.from(this._roleComboStats().values()).filter(s=>s.totalSessions>=3).sort((s,t)=>t.conversionRate-s.conversionRate).slice(0,5));this.STORAGE_KEY="marketingAnalytics";this.loadFromStorage(),this.initializeListeners()}initializeListeners(){this.ipc.on("collaboration:session-ended",e=>{this.recordSession(e)}),this.ipc.on("collaboration:user-message",e=>{this.updateUserProfile(e.userId,e.message)})}recordSession(e){let s=this.createRoleCombo(e.roles),t=e.messages.filter(r=>r.isUser),n=e.messages.filter(r=>!r.isUser),o={id:e.sessionId,startTime:e.messages[0]?.timestamp||new Date,endTime:e.messages[e.messages.length-1]?.timestamp,targetUserId:e.targetUserId,targetUserName:e.targetUserName,roleCombo:s,totalMessages:e.messages.length,userMessages:t.length,roleMessages:n.length,avgResponseTime:this.calcAvgResponseTime(e.messages),stagesReached:e.stagesReached,finalStage:e.finalStage,outcome:e.outcome,conversionValue:e.conversionValue,interestScore:e.interestScore,engagementScore:this.calcEngagementScore(e.messages),tags:this.extractSessionTags(e)};return this._sessions.update(r=>[...r,o]),this.updateRoleComboStats(s,o),this.saveToStorage(),console.log(`[Analytics] \u8A18\u9304\u6703\u8A71: ${o.id}, \u7D50\u679C: ${o.outcome}`),o}createRoleCombo(e){let s=[...e].sort((o,r)=>o.roleId.localeCompare(r.roleId)),t=s.map(o=>o.roleType).join("_"),n=s.map(o=>o.roleName).join(" + ");return{id:`combo_${t}`,name:n,roles:s,hash:t}}updateRoleComboStats(e,s){let n=this._roleComboStats().get(e.id),o=s.outcome==="converted";if(n){let r=n.totalSessions+1,a=n.conversions+(o?1:0),l=m(g({},n),{totalSessions:r,conversions:a,conversionRate:a/r*100,avgInterestScore:(n.avgInterestScore*n.totalSessions+s.interestScore)/r,avgEngagementScore:(n.avgEngagementScore*n.totalSessions+s.engagementScore)/r,avgMessageCount:(n.avgMessageCount*n.totalSessions+s.totalMessages)/r,lastUsed:new Date});l.trend=s.interestScore>n.avgInterestScore?"up":s.interestScore<n.avgInterestScore?"down":"stable",this._roleComboStats.update(c=>{let i=new Map(c);return i.set(e.id,l),i})}else{let r={comboId:e.id,comboName:e.name,roles:e.roles.map(a=>a.roleName),totalSessions:1,conversions:o?1:0,conversionRate:o?100:0,avgInterestScore:s.interestScore,avgEngagementScore:s.engagementScore,avgSessionDuration:0,avgMessageCount:s.totalMessages,stageReachRates:{},trend:"stable",lastUsed:new Date};this._roleComboStats.update(a=>{let l=new Map(a);return l.set(e.id,r),l})}}updateUserProfile(e,s){let t=this._userProfiles().get(e),n=s.length,o=n<20?"short":n>100?"long":"medium",r=this.extractInterests(s),a=this.extractPainPoints(s),l=this.extractObjections(s);if(t){let c=m(g({},t),{totalMessages:t.totalMessages+1,interests:[...new Set([...t.interests,...r])].slice(0,10),painPoints:[...new Set([...t.painPoints,...a])].slice(0,5),objections:[...new Set([...t.objections,...l])].slice(0,5),lastContactTime:new Date,updatedAt:new Date});c.messageLength=o,this._userProfiles.update(i=>{let u=new Map(i);return u.set(e,c),u})}else{let c={userId:e,responseSpeed:"normal",messageLength:o,activeHours:[new Date().getHours()],interests:r,painPoints:a,objections:l,intentLevel:"unknown",pricesSensitivity:"medium",totalSessions:1,totalMessages:1,lastContactTime:new Date,tags:[],updatedAt:new Date};this._userProfiles.update(i=>{let u=new Map(i);return u.set(e,c),u})}this.saveToStorage()}extractInterests(e){let s=[],t=e.toLowerCase();return Object.entries({\u652F\u4ED8:"\u652F\u4ED8\u89E3\u6C7A\u65B9\u6848",\u6536\u6B3E:"\u6536\u6B3E\u670D\u52D9",\u8DE8\u5883:"\u8DE8\u5883\u696D\u52D9",\u8CBB\u7387:"\u50F9\u683C\u654F\u611F",\u5B89\u5168:"\u5B89\u5168\u9700\u6C42",\u901F\u5EA6:"\u6548\u7387\u9700\u6C42",\u7A69\u5B9A:"\u7A69\u5B9A\u6027\u9700\u6C42"}).forEach(([o,r])=>{t.includes(o)&&s.push(r)}),s}extractPainPoints(e){let s=[],t=e.toLowerCase();return(t.includes("\u8CB4")||t.includes("\u8CBB\u7387\u9AD8"))&&s.push("\u8CBB\u7387\u554F\u984C"),(t.includes("\u6162")||t.includes("\u7B49\u5F85"))&&s.push("\u6548\u7387\u554F\u984C"),(t.includes("\u64D4\u5FC3")||t.includes("\u98A8\u96AA"))&&s.push("\u5B89\u5168\u9867\u616E"),(t.includes("\u8907\u96DC")||t.includes("\u9EBB\u7169"))&&s.push("\u64CD\u4F5C\u8907\u96DC"),s}extractObjections(e){let s=[],t=e.toLowerCase();return(t.includes("\u4E0D\u9700\u8981")||t.includes("\u4E0D\u7528"))&&s.push("\u7121\u9700\u6C42"),(t.includes("\u518D\u8003\u616E")||t.includes("\u518D\u8AAA"))&&s.push("\u9700\u8981\u8003\u616E"),(t.includes("\u592A\u8CB4")||t.includes("\u4FBF\u5B9C"))&&s.push("\u50F9\u683C\u7570\u8B70"),(t.includes("\u4E0D\u4FE1")||t.includes("\u9A19"))&&s.push("\u4FE1\u4EFB\u554F\u984C"),s}getUserProfile(e){return this._userProfiles().get(e)}generateDailyReport(e){let s=e||new Date().toISOString().split("T")[0],t=this._sessions().filter(i=>i.startTime.toISOString().split("T")[0]===s),n=t.filter(i=>i.outcome==="converted"),o=new Set(t.map(i=>i.targetUserId)),r=new Map;t.forEach(i=>{i.roleCombo.roles.forEach(u=>{let S=r.get(u.accountPhone)||{sessions:0,messages:0};S.sessions++,S.messages+=i.roleMessages/i.roleCombo.roles.length,r.set(u.accountPhone,S)})});let a=new Map;t.forEach(i=>{let u=a.get(i.roleCombo.id)||{name:i.roleCombo.name,conversions:0,total:0};u.total++,i.outcome==="converted"&&u.conversions++,a.set(i.roleCombo.id,u)});let c=["opening","building_trust","discovering_needs","presenting_value","handling_objections","closing","follow_up"].map(i=>({stage:i,count:t.filter(u=>u.stagesReached.includes(i)).length}));return{date:s,totalSessions:t.length,newUsers:o.size,activeUsers:o.size,conversions:n.length,conversionRate:t.length>0?n.length/t.length*100:0,totalRevenue:t.reduce((i,u)=>i+(u.conversionValue||0),0),totalMessages:t.reduce((i,u)=>i+u.totalMessages,0),avgResponseTime:this.calcAverage(t.map(i=>i.avgResponseTime)),accountUsage:Array.from(r.entries()).map(([i,u])=>g({phone:i},u)),topRoleCombos:Array.from(a.values()).sort((i,u)=>u.conversions-i.conversions).slice(0,5).map(i=>({comboName:i.name,conversions:i.conversions,rate:i.total>0?i.conversions/i.total*100:0})),funnel:c.map((i,u)=>({stage:i.stage,count:i.count,rate:t.length>0?i.count/t.length*100:0}))}}generatePeriodComparison(e=7){let s=new Date,t=new Date(s.getTime()-e*24*60*60*1e3),n=new Date(t.getTime()-e*24*60*60*1e3),o=this._sessions().filter(c=>c.startTime>=t&&c.startTime<s),r=this._sessions().filter(c=>c.startTime>=n&&c.startTime<t),a={sessions:o.length,conversions:o.filter(c=>c.outcome==="converted").length,revenue:o.reduce((c,i)=>c+(i.conversionValue||0),0)},l={sessions:r.length,conversions:r.filter(c=>c.outcome==="converted").length,revenue:r.reduce((c,i)=>c+(i.conversionValue||0),0)};return{current:a,previous:l,changes:{sessions:l.sessions>0?(a.sessions-l.sessions)/l.sessions*100:0,conversions:l.conversions>0?(a.conversions-l.conversions)/l.conversions*100:0,revenue:l.revenue>0?(a.revenue-l.revenue)/l.revenue*100:0}}}recommendRoleCombo(e){let s=Array.from(this._roleComboStats().values());return s.length===0?null:s.filter(n=>n.totalSessions>=2).sort((n,o)=>o.conversionRate-n.conversionRate)[0]||null}calcAverage(e){return e.length===0?0:e.reduce((s,t)=>s+t,0)/e.length}calcAvgResponseTime(e){let s=0,t=0;for(let n=1;n<e.length;n++)e[n].isUser&&!e[n-1].isUser&&(s+=new Date(e[n].timestamp).getTime()-new Date(e[n-1].timestamp).getTime(),t++);return t>0?s/t:0}calcEngagementScore(e){let s=e.filter(r=>r.isUser);if(s.length===0)return 0;let t=0;t+=Math.min(s.length*10,40);let n=s.reduce((r,a)=>r+a.content.length,0)/s.length;t+=Math.min(n/5,30);let o=s.filter(r=>r.content.includes("?")||r.content.includes("\uFF1F")).length;return t+=Math.min(o*10,30),Math.min(t,100)}extractSessionTags(e){let s=[];return e.outcome==="converted"&&s.push("\u6210\u4EA4"),e.interestScore>=80&&s.push("\u9AD8\u610F\u5411"),e.stagesReached.includes("closing")&&s.push("\u5230\u9054\u6210\u4EA4\u968E\u6BB5"),s}saveToStorage(){let e={sessions:this._sessions(),userProfiles:Array.from(this._userProfiles().entries()),roleComboStats:Array.from(this._roleComboStats().entries()),savedAt:Date.now()};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}loadFromStorage(){try{let e=localStorage.getItem(this.STORAGE_KEY);if(!e)return;let s=JSON.parse(e);if(s.sessions){let t=s.sessions.map(n=>m(g({},n),{startTime:new Date(n.startTime),endTime:n.endTime?new Date(n.endTime):void 0}));this._sessions.set(t)}if(s.userProfiles){let t=new Map(s.userProfiles.map(n=>[n[0],m(g({},n[1]),{updatedAt:new Date(n[1].updatedAt),lastContactTime:n[1].lastContactTime?new Date(n[1].lastContactTime):void 0})]));this._userProfiles.set(t)}if(s.roleComboStats){let t=new Map(s.roleComboStats.map(n=>[n[0],m(g({},n[1]),{lastUsed:new Date(n[1].lastUsed)})]));this._roleComboStats.set(t)}console.log("[Analytics] \u5DF2\u5F9E\u5B58\u5132\u6062\u5FA9\u6578\u64DA")}catch(e){console.error("[Analytics] \u6062\u5FA9\u6578\u64DA\u5931\u6557:",e)}}clearAllData(){this._sessions.set([]),this._userProfiles.set(new Map),this._roleComboStats.set(new Map),localStorage.removeItem(this.STORAGE_KEY),console.log("[Analytics] \u5DF2\u6E05\u9664\u6240\u6709\u6578\u64DA")}exportData(){return JSON.stringify({sessions:this._sessions(),userProfiles:Array.from(this._userProfiles().entries()),roleComboStats:Array.from(this._roleComboStats().entries()),exportedAt:new Date().toISOString()},null,2)}static{this.\u0275fac=function(s){return new(s||d)}}static{this.\u0275prov=v({token:d,factory:d.\u0275fac,providedIn:"root"})}};export{k as a,_ as b};
