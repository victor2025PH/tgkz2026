import{c as w}from"./chunk-K5SU4RX2.js";import{M as p,R as f,Zb as u,a as l,b as m,g,ga as h}from"./chunk-PDD6YQ47.js";var y=class d{constructor(){this.http=f(w);this._isElectron=h(this.detectElectron());this._isConnected=h(!1);this._config=h(this.getDefaultConfig());this.ws=null;this.wsReconnectTimer=null;this.wsMessageSubject=new g;this.pendingRequests=new Map;this.cache=new Map;this.cacheTimeout=3e4;this.inflightRequests=new Map;this.isElectron=u(()=>this._isElectron());this.isConnected=u(()=>this._isConnected());this.mode=u(()=>this._config().mode);this.events$=this.wsMessageSubject.asObservable();this.init()}init(){console.log(`[ApiService] Initializing in ${this._config().mode} mode`),this._config().mode==="http"&&this.connectWebSocket(),this.healthCheck().then(e=>{this._isConnected.set(e),console.log(`[ApiService] Connection status: ${e?"connected":"disconnected"}`)})}detectElectron(){return!!window.electron||!!window.require}getDefaultConfig(){let e=window.__API_MODE__||"auto",t=window.__API_BASE_URL__;return e==="http"||t?{mode:"http",baseUrl:t||this.detectApiUrl(),wsUrl:this.detectWsUrl(),timeout:3e4,retries:2}:this.detectElectron()?{mode:"ipc",timeout:3e4,retries:2}:{mode:"http",baseUrl:this.detectApiUrl(),wsUrl:this.detectWsUrl(),timeout:3e4,retries:2}}detectApiUrl(){return window.location.hostname==="localhost"&&window.location.port==="4200"?"http://localhost:8000":`${window.location.protocol}//${window.location.host}`}detectWsUrl(){let e=window.location.protocol==="https:"?"wss:":"ws:";return window.location.hostname==="localhost"&&window.location.port==="4200"?"ws://localhost:8000/ws":`${e}//${window.location.host}/ws`}async command(e,t={}){let s=`${e}:${JSON.stringify(t)}`;if(this.inflightRequests.has(s))return this.inflightRequests.get(s);let r=this._executeCommand(e,t);this.inflightRequests.set(s,r);try{return await r}finally{this.inflightRequests.delete(s)}}async _executeCommand(e,t){return this._config().mode==="ipc"?this.ipcCommand(e,t):this.httpCommand(e,t)}async ipcCommand(e,t){let s=window.electron;if(!s?.ipcRenderer)throw new Error("Electron IPC not available");try{let r=await s.ipcRenderer.invoke(e,t);return this.normalizeResponse(r)}catch(r){return{success:!1,error:r.message||"IPC error"}}}async httpCommand(e,t){let s=this._config(),r=`${s.baseUrl}/api/command`,i=localStorage.getItem("tgm_access_token"),o={"Content-Type":"application/json"};i&&(o.Authorization=`Bearer ${i}`);try{let n=await fetch(r,{method:"POST",headers:o,body:JSON.stringify({command:e,payload:t})});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);let a=await n.json();return this.normalizeResponse(a)}catch(n){if(s.retries&&s.retries>0){console.warn(`[ApiService] Retrying command: ${e}`);let a=m(l({},s),{retries:s.retries-1});return this._config.set(a),this.httpCommand(e,t)}return{success:!1,error:n.message||"HTTP error"}}}normalizeResponse(e){return typeof e=="object"&&e!==null?"success"in e?e:{success:!0,data:e}:{success:!0,data:e}}connectWebSocket(){let e=this._config().wsUrl;if(e)try{this.ws=new WebSocket(e),this.ws.onopen=()=>{console.log("[ApiService] WebSocket connected"),this._isConnected.set(!0),this.wsReconnectTimer&&(clearTimeout(this.wsReconnectTimer),this.wsReconnectTimer=null)},this.ws.onmessage=t=>{try{let s=JSON.parse(t.data);if(s.request_id&&this.pendingRequests.has(s.request_id)){let{resolve:r}=this.pendingRequests.get(s.request_id);this.pendingRequests.delete(s.request_id),r(s)}this.wsMessageSubject.next(s)}catch(s){console.error("[ApiService] WebSocket message parse error",s)}},this.ws.onclose=()=>{console.log("[ApiService] WebSocket disconnected"),this._isConnected.set(!1),this.scheduleReconnect()},this.ws.onerror=t=>{console.error("[ApiService] WebSocket error",t)}}catch(t){console.error("[ApiService] WebSocket connection failed",t),this.scheduleReconnect()}}scheduleReconnect(){this.wsReconnectTimer||(this.wsReconnectTimer=setTimeout(()=>{console.log("[ApiService] Attempting WebSocket reconnection..."),this.wsReconnectTimer=null,this.connectWebSocket()},5e3))}async wsCommand(e,t={}){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return this.httpCommand(e,t);let s=crypto.randomUUID();return new Promise((r,i)=>{this.pendingRequests.set(s,{resolve:r,reject:i}),setTimeout(()=>{this.pendingRequests.has(s)&&(this.pendingRequests.delete(s),i(new Error("WebSocket request timeout")))},this._config().timeout||3e4),this.ws.send(JSON.stringify({command:e,payload:t,request_id:s}))})}async healthCheck(){try{return(await this.command("get-initial-state")).success}catch{return!1}}async cachedCommand(e,t={},s=this.cacheTimeout){let r=`${e}:${JSON.stringify(t)}`,i=this.cache.get(r);if(i&&Date.now()-i.timestamp<s)return{success:!0,data:i.data};let o=await this.command(e,t);return o.success&&o.data&&this.cache.set(r,{data:o.data,timestamp:Date.now()}),o}clearCache(e){if(e)for(let t of this.cache.keys())t.includes(e)&&this.cache.delete(t);else this.cache.clear()}async get(e,t){let s=this._config(),r=e.startsWith("http")?e:`${s.baseUrl}${e}`;if(t?.cache!==!1){let n=this.cache.get(r);if(n&&Date.now()-n.timestamp<(t?.ttl||this.cacheTimeout))return{success:!0,data:n.data}}let i=localStorage.getItem("tgm_access_token"),o={"Content-Type":"application/json"};i&&(o.Authorization=`Bearer ${i}`);try{let n=await fetch(r,{method:"GET",headers:o});if(!n.ok){if(n.status===401)return console.warn("[ApiService] 401 Unauthorized - clearing auth and redirecting"),this.handleUnauthorized(),{success:!1,error:"\u767B\u9304\u5DF2\u904E\u671F\uFF0C\u8ACB\u91CD\u65B0\u767B\u9304"};let c=await n.json().catch(()=>({}));return{success:!1,error:c.error||c.message||`HTTP ${n.status}: ${n.statusText}`}}let a=await n.json();return t?.cache!==!1&&a.success!==!1&&this.cache.set(r,{data:a.data||a,timestamp:Date.now()}),this.normalizeResponse(a)}catch(n){return console.error(`[ApiService] GET ${e} error:`,n),{success:!1,error:n.message||"Network error"}}}handleUnauthorized(){console.warn("[ApiService] 401 Unauthorized - Token may be expired or invalid"),console.warn("[ApiService] Please try logging out and logging back in"),window.dispatchEvent(new CustomEvent("auth:unauthorized",{detail:{message:"\u767B\u9304\u5DF2\u904E\u671F\uFF0C\u8ACB\u91CD\u65B0\u767B\u9304"}}))}async post(e,t={}){let s=this._config(),r=e.startsWith("http")?e:`${s.baseUrl}${e}`,i=localStorage.getItem("tgm_access_token"),o={"Content-Type":"application/json"};i&&(o.Authorization=`Bearer ${i}`);try{let n=await fetch(r,{method:"POST",headers:o,body:JSON.stringify(t)});if(!n.ok){if(n.status===401)return console.warn("[ApiService] 401 Unauthorized on POST - clearing auth and redirecting"),this.handleUnauthorized(),{success:!1,error:"\u767B\u9304\u5DF2\u904E\u671F\uFF0C\u8ACB\u91CD\u65B0\u767B\u9304"};let c=await n.json().catch(()=>({}));return{success:!1,error:c.error||c.message||`HTTP ${n.status}: ${n.statusText}`}}let a=await n.json();return this.normalizeResponse(a)}catch(n){return console.error(`[ApiService] POST ${e} error:`,n),{success:!1,error:n.message||"Network error"}}}getAccounts(){return this.cachedCommand("get-accounts")}addAccount(e){return this.command("add-account",e)}loginAccount(e){return this.command("login-account",{id:e})}logoutAccount(e){return this.command("logout-account",{id:e})}sendCode(e,t,s){return this.command("send-code",{phone:e,apiId:t,apiHash:s})}verifyCode(e,t,s){return this.command("verify-code",{phone:e,code:t,phoneCodeHash:s})}getCredentials(){return this.cachedCommand("get-api-credentials")}addCredential(e){return this.command("add-api-credential",e)}getRecommendedCredential(){return this.cachedCommand("get-api-recommendation")}getMonitoringStatus(){return this.command("get-monitoring-status")}startMonitoring(e){return this.command("start-monitoring",e)}stopMonitoring(){return this.command("stop-monitoring")}getInitialState(){return this.cachedCommand("get-initial-state",{},5e3)}getSettings(){return this.cachedCommand("get-settings")}saveSettings(e){return this.clearCache("get-settings"),this.command("save-settings",e)}static{this.\u0275fac=function(t){return new(t||d)}}static{this.\u0275prov=p({token:d,factory:d.\u0275fac,providedIn:"root"})}};export{y as a};
