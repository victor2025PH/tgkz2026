import{c as y,g as w}from"./chunk-IOZ6RGE3.js";import{J as d,O as h,Vb as o,a as l,b as p,da as a,fa as g,g as f}from"./chunk-XBIFDY2N.js";var m=class u{constructor(){this.http=h(y);this._isElectron=a(this.detectElectron());this._isConnected=a(!1);this._config=a(this.getDefaultConfig());this.ws=null;this.wsReconnectTimer=null;this.wsMessageSubject=new f;this.pendingRequests=new Map;this.cache=new Map;this.cacheTimeout=3e4;this.inflightRequests=new Map;this.isElectron=o(()=>this._isElectron());this.isConnected=o(()=>this._isConnected());this.mode=o(()=>this._config().mode);this.events$=this.wsMessageSubject.asObservable();this.init()}init(){console.log(`[ApiService] Initializing in ${this._config().mode} mode`),this._config().mode==="http"&&this.connectWebSocket(),this.healthCheck().then(e=>{this._isConnected.set(e),console.log(`[ApiService] Connection status: ${e?"connected":"disconnected"}`)})}detectElectron(){return!!window.electron||!!window.require}getDefaultConfig(){let e=window.__API_MODE__||"auto",t=window.__API_BASE_URL__;return e==="http"||t?{mode:"http",baseUrl:t||this.detectApiUrl(),wsUrl:this.detectWsUrl(),timeout:3e4,retries:2}:this.detectElectron()?{mode:"ipc",timeout:3e4,retries:2}:{mode:"http",baseUrl:this.detectApiUrl(),wsUrl:this.detectWsUrl(),timeout:3e4,retries:2}}detectApiUrl(){return window.location.hostname==="localhost"&&window.location.port==="4200"?"http://localhost:8000":`${window.location.protocol}//${window.location.host}`}detectWsUrl(){let e=window.location.protocol==="https:"?"wss:":"ws:";return window.location.hostname==="localhost"&&window.location.port==="4200"?"ws://localhost:8000/ws":`${e}//${window.location.host}/ws`}async command(e,t={}){let s=`${e}:${JSON.stringify(t)}`;if(this.inflightRequests.has(s))return this.inflightRequests.get(s);let r=this._executeCommand(e,t);this.inflightRequests.set(s,r);try{return await r}finally{this.inflightRequests.delete(s)}}async _executeCommand(e,t){return this._config().mode==="ipc"?this.ipcCommand(e,t):this.httpCommand(e,t)}async ipcCommand(e,t){let s=window.electron;if(!s?.ipcRenderer)throw new Error("Electron IPC not available");try{let r=await s.ipcRenderer.invoke(e,t);return this.normalizeResponse(r)}catch(r){return{success:!1,error:r.message||"IPC error"}}}async httpCommand(e,t){let s=this._config(),r=`${s.baseUrl}/api/command`;try{let n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:e,payload:t})});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);let c=await n.json();return this.normalizeResponse(c)}catch(n){if(s.retries&&s.retries>0){console.warn(`[ApiService] Retrying command: ${e}`);let c=p(l({},s),{retries:s.retries-1});return this._config.set(c),this.httpCommand(e,t)}return{success:!1,error:n.message||"HTTP error"}}}normalizeResponse(e){return typeof e=="object"&&e!==null?"success"in e?e:{success:!0,data:e}:{success:!0,data:e}}connectWebSocket(){let e=this._config().wsUrl;if(e)try{this.ws=new WebSocket(e),this.ws.onopen=()=>{console.log("[ApiService] WebSocket connected"),this._isConnected.set(!0),this.wsReconnectTimer&&(clearTimeout(this.wsReconnectTimer),this.wsReconnectTimer=null)},this.ws.onmessage=t=>{try{let s=JSON.parse(t.data);if(s.request_id&&this.pendingRequests.has(s.request_id)){let{resolve:r}=this.pendingRequests.get(s.request_id);this.pendingRequests.delete(s.request_id),r(s)}this.wsMessageSubject.next(s)}catch(s){console.error("[ApiService] WebSocket message parse error",s)}},this.ws.onclose=()=>{console.log("[ApiService] WebSocket disconnected"),this._isConnected.set(!1),this.scheduleReconnect()},this.ws.onerror=t=>{console.error("[ApiService] WebSocket error",t)}}catch(t){console.error("[ApiService] WebSocket connection failed",t),this.scheduleReconnect()}}scheduleReconnect(){this.wsReconnectTimer||(this.wsReconnectTimer=setTimeout(()=>{console.log("[ApiService] Attempting WebSocket reconnection..."),this.wsReconnectTimer=null,this.connectWebSocket()},5e3))}async wsCommand(e,t={}){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return this.httpCommand(e,t);let s=crypto.randomUUID();return new Promise((r,n)=>{this.pendingRequests.set(s,{resolve:r,reject:n}),setTimeout(()=>{this.pendingRequests.has(s)&&(this.pendingRequests.delete(s),n(new Error("WebSocket request timeout")))},this._config().timeout||3e4),this.ws.send(JSON.stringify({command:e,payload:t,request_id:s}))})}async healthCheck(){try{return(await this.command("get-initial-state")).success}catch{return!1}}async cachedCommand(e,t={},s=this.cacheTimeout){let r=`${e}:${JSON.stringify(t)}`,n=this.cache.get(r);if(n&&Date.now()-n.timestamp<s)return{success:!0,data:n.data};let c=await this.command(e,t);return c.success&&c.data&&this.cache.set(r,{data:c.data,timestamp:Date.now()}),c}clearCache(e){if(e)for(let t of this.cache.keys())t.includes(e)&&this.cache.delete(t);else this.cache.clear()}getAccounts(){return this.cachedCommand("get-accounts")}addAccount(e){return this.command("add-account",e)}loginAccount(e){return this.command("login-account",{id:e})}logoutAccount(e){return this.command("logout-account",{id:e})}sendCode(e,t,s){return this.command("send-code",{phone:e,apiId:t,apiHash:s})}verifyCode(e,t,s){return this.command("verify-code",{phone:e,code:t,phoneCodeHash:s})}getCredentials(){return this.cachedCommand("get-api-credentials")}addCredential(e){return this.command("add-api-credential",e)}getRecommendedCredential(){return this.cachedCommand("get-api-recommendation")}getMonitoringStatus(){return this.command("get-monitoring-status")}startMonitoring(e){return this.command("start-monitoring",e)}stopMonitoring(){return this.command("stop-monitoring")}getInitialState(){return this.cachedCommand("get-initial-state",{},5e3)}getSettings(){return this.cachedCommand("get-settings")}saveSettings(e){return this.clearCache("get-settings"),this.command("save-settings",e)}static{this.\u0275fac=function(t){return new(t||u)}}static{this.\u0275prov=d({token:u,factory:u.\u0275fac,providedIn:"root"})}};var i={ACCESS:"tgm_access_token",REFRESH:"tgm_refresh_token",USER:"tgm_user"},v=class u{constructor(){this.api=h(m);this.router=h(w);this._user=a(null);this._isLoading=a(!1);this._accessToken=a(null);this._refreshToken=a(null);this.refreshTimer=null;this.user=o(()=>this._user());this.isAuthenticated=o(()=>!!this._user()&&!!this._accessToken());this.isLoading=o(()=>this._isLoading());this.accessToken=o(()=>this._accessToken());this.subscriptionTier=o(()=>this._user()?.subscription_tier||"free");this.maxAccounts=o(()=>this._user()?.max_accounts||3);this.isPro=o(()=>["pro","enterprise"].includes(this.subscriptionTier()));this.membershipLevel=o(()=>{let e=this.subscriptionTier();return{free:"bronze",basic:"silver",pro:"gold",enterprise:"diamond"}[e]||"bronze"});this.restoreSession(),g(()=>{let e=this._accessToken();e?localStorage.setItem(i.ACCESS,e):localStorage.removeItem(i.ACCESS)}),g(()=>{let e=this._refreshToken();e?localStorage.setItem(i.REFRESH,e):localStorage.removeItem(i.REFRESH)}),g(()=>{let e=this._user();e?localStorage.setItem(i.USER,JSON.stringify(e)):localStorage.removeItem(i.USER)})}async register(e){this._isLoading.set(!0);try{let t=await this.api.command("user-register",e);return t.success&&t.data?(this.setAuthState(t.data),{success:!0}):{success:!1,error:t.error||"\u8A3B\u518A\u5931\u6557"}}catch(t){return{success:!1,error:t.message||"\u8A3B\u518A\u5931\u6557"}}finally{this._isLoading.set(!1)}}async login(e){this._isLoading.set(!0);try{let s=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e.email,password:e.password,device_name:e.device_name||this.getDeviceName()})})).json();return s.success&&s.data?(this.setAuthState(s.data),this.scheduleTokenRefresh(),{success:!0}):{success:!1,error:s.error||"\u767B\u5165\u5931\u6557"}}catch(t){return{success:!1,error:t.message||"\u767B\u5165\u5931\u6557"}}finally{this._isLoading.set(!1)}}async getTelegramConfig(){try{let t=await(await fetch(`${this.getApiBaseUrl()}/api/v1/oauth/telegram/config`)).json();return t.success&&t.data?t.data:{enabled:!1}}catch(e){return console.error("Failed to get Telegram config:",e),{enabled:!1}}}async telegramLogin(e){this._isLoading.set(!0);try{let s=await(await fetch(`${this.getApiBaseUrl()}/api/v1/oauth/telegram`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return s.success?(this.setAuthState({user:s.user,access_token:s.access_token,refresh_token:s.refresh_token}),this.scheduleTokenRefresh(),{success:!0}):{success:!1,error:s.error||"Telegram \u767B\u5165\u5931\u6557"}}catch(t){return{success:!1,error:t.message||"Telegram \u767B\u5165\u5931\u6557"}}finally{this._isLoading.set(!1)}}async logout(){try{let e=this._accessToken();e&&await fetch(`${this.getApiBaseUrl()}/api/v1/auth/logout`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}})}catch(e){console.error("Logout error:",e)}finally{this.clearAuthState(),this.router.navigate(["/login"])}}async forgotPassword(e){try{let s=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/forgot-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})})).json();return{success:s.success,error:s.error}}catch(t){return{success:!1,error:t.message}}}async resetPassword(e,t){try{let r=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/reset-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e,password:t})})).json();return{success:r.success,error:r.error}}catch(s){return{success:!1,error:s.message}}}async verifyEmail(e){try{let s=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/verify-email`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})})).json();return{success:s.success,error:s.error}}catch(t){return{success:!1,error:t.message}}}async verifyEmailByCode(e,t){try{let r=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/verify-email-code`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,code:t})})).json();return{success:r.success,error:r.error}}catch(s){return{success:!1,error:s.message}}}async resendVerificationEmail(){try{let e=this._accessToken();if(!e)return{success:!1,error:"\u672A\u767B\u5165"};let s=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/send-verification`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}})).json();return{success:s.success,error:s.error}}catch(e){return{success:!1,error:e.message}}}async refreshAccessToken(){let e=this._refreshToken();if(!e)return!1;try{let s=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})})).json();return s.success&&s.data?(this._accessToken.set(s.data.access_token),this._refreshToken.set(s.data.refresh_token),this.scheduleTokenRefresh(),!0):!1}catch(t){return console.error("Token refresh error:",t),!1}}async fetchCurrentUser(){let e=this._accessToken();if(!e)return null;try{let s=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/me`,{headers:{Authorization:`Bearer ${e}`}})).json();return s.success&&s.data?(this._user.set(s.data),s.data):null}catch(t){return console.error("Fetch user error:",t),null}}async updateProfile(e){let t=this._accessToken();if(!t)return{success:!1,error:"\u672A\u767B\u5165"};try{let r=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/me`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(e)})).json();if(r.success){let n=this._user();return n&&this._user.set(l(l({},n),e)),{success:!0}}return{success:!1,error:r.error}}catch(s){return{success:!1,error:s.message}}}async changePassword(e,t){let s=this._accessToken();if(!s)return{success:!1,error:"\u672A\u767B\u5165"};try{let n=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/change-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({old_password:e,new_password:t})})).json();return{success:n.success,error:n.error}}catch(r){return{success:!1,error:r.message}}}async getSessions(){let e=this._accessToken();if(!e)return[];try{let s=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/sessions`,{headers:{Authorization:`Bearer ${e}`}})).json();return s.success?s.data:[]}catch{return[]}}async revokeSession(e){let t=this._accessToken();if(!t)return!1;try{return(await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/sessions/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})).json()).success}catch{return!1}}hasFeature(e){let t=this.subscriptionTier(),r={free:["basic_monitoring","basic_ai"],basic:["basic_monitoring","basic_ai","templates"],pro:["basic_monitoring","basic_ai","templates","full_monitoring","advanced_ai","team","api_access"],enterprise:["all"]}[t]||[];return r.includes("all")||r.includes(e)}getAuthHeaders(){let e=this._accessToken();return e?{Authorization:`Bearer ${e}`}:{}}setAuthState(e){e.user&&this._user.set(e.user),e.access_token&&this._accessToken.set(e.access_token),e.refresh_token&&this._refreshToken.set(e.refresh_token)}clearSession(){this.clearAuthState()}clearAuthState(){this._user.set(null),this._accessToken.set(null),this._refreshToken.set(null),this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),localStorage.removeItem(i.ACCESS),localStorage.removeItem(i.REFRESH),localStorage.removeItem(i.USER)}restoreSession(){try{let e=localStorage.getItem(i.ACCESS),t=localStorage.getItem(i.REFRESH),s=localStorage.getItem(i.USER);if(e&&!this.isValidTokenFormat(e)){console.warn("[Auth] Invalid token format, clearing session"),this.clearAuthState();return}if(e&&this._accessToken.set(e),t&&this._refreshToken.set(t),s)try{this._user.set(JSON.parse(s))}catch{console.warn("[Auth] Invalid user JSON, clearing"),this.clearAuthState();return}e&&this.fetchCurrentUser().then(r=>{r||(t?this.refreshAccessToken().catch(()=>{console.warn("[Auth] Token refresh failed, clearing session"),this.clearAuthState(),window.location.pathname!=="/auth/login"&&this.router.navigate(["/auth/login"])}):(console.warn("[Auth] No valid token, clearing session"),this.clearAuthState(),window.location.pathname!=="/auth/login"&&this.router.navigate(["/auth/login"])))}).catch(()=>{console.warn("[Auth] Token validation failed"),this.clearAuthState()})}catch(e){console.error("Restore session error:",e),this.clearAuthState()}}isValidTokenFormat(e){if(!e||e.length<20)return!1;let t=e.split(".");if(t.length!==3)return!1;try{let s=JSON.parse(atob(t[1]));return s.exp&&Date.now()>=s.exp*1e3?(console.warn("[Auth] Token expired"),!1):!0}catch{return!1}}scheduleTokenRefresh(){this.refreshTimer&&clearTimeout(this.refreshTimer);let e=3300*1e3;this.refreshTimer=setTimeout(()=>{this.refreshAccessToken()},e)}getApiBaseUrl(){return window.location.hostname==="localhost"&&window.location.port==="4200"?"http://localhost:8000":""}getDeviceName(){let e=navigator.userAgent;return e.includes("Windows")?"Windows Browser":e.includes("Mac")?"Mac Browser":e.includes("Linux")?"Linux Browser":e.includes("iPhone")||e.includes("iPad")?"iOS Browser":e.includes("Android")?"Android Browser":"Web Browser"}static{this.\u0275fac=function(t){return new(t||u)}}static{this.\u0275prov=d({token:u,factory:u.\u0275fac,providedIn:"root"})}};export{v as a};
