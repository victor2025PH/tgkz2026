import{e as f}from"./chunk-PHWS6WVI.js";import{a as v}from"./chunk-GQQBGSXN.js";import{a as _,b as y}from"./chunk-BBG7G54H.js";import{M as p,R as l,Vb as a,a as u,b as m,ga as o,ia as h}from"./chunk-YLSLTE5F.js";var i=_,S=class g{constructor(){this.api=l(v);this.router=l(f);this.authEvents=l(y);this.eventSubscription=null;this._user=o(null);this._isLoading=o(!1);this._accessToken=o(null);this._refreshToken=o(null);this.refreshTimer=null;this._pendingFetchUser=null;this._devices=o([]);this._usageStats=o(null);this.user=a(()=>this._user());this.isAuthenticated=a(()=>!!this._accessToken());this.isLoading=a(()=>this._isLoading());this.accessToken=a(()=>this._accessToken());this.devices=a(()=>this._devices());this.usageStats=a(()=>this._usageStats());this.subscriptionTier=a(()=>this._user()?.subscription_tier||this._user()?.membershipLevel||"free");this.maxAccounts=a(()=>this._user()?.max_accounts||3);this.isPro=a(()=>["pro","enterprise","gold","diamond","star","king"].includes(this.subscriptionTier()));this.membershipLevel=a(()=>{let e=this._user(),s=e?.membershipLevel||e?.subscription_tier||"free";return{free:"bronze",basic:"silver",pro:"gold",enterprise:"diamond",bronze:"bronze",silver:"silver",gold:"gold",diamond:"diamond",star:"star",king:"king"}[s]||"bronze"});this._initialized=!1;this.restoreSession(),this._initialized=!0,this.eventSubscription=this.authEvents.authEvents$.subscribe(e=>{e.type==="logout"?(console.log("[CoreAuthService] Received logout event, clearing state"),this.clearAuthStateInternal()):e.type==="user_update"&&e.payload?.user&&(console.log("[CoreAuthService] Received user_update event, syncing user data"),this._user.set(e.payload.user),localStorage.setItem(i.USER,JSON.stringify(e.payload.user)))}),h(()=>{let e=this._accessToken();e?localStorage.setItem(i.ACCESS_TOKEN,e):this._initialized&&localStorage.removeItem(i.ACCESS_TOKEN)}),h(()=>{let e=this._refreshToken();e?localStorage.setItem(i.REFRESH_TOKEN,e):this._initialized&&localStorage.removeItem(i.REFRESH_TOKEN)}),h(()=>{let e=this._user();e?localStorage.setItem(i.USER,JSON.stringify(e)):this._initialized&&localStorage.removeItem(i.USER)})}ngOnDestroy(){this.eventSubscription?.unsubscribe()}async register(e){this._isLoading.set(!0);try{let s=await this.api.command("user-register",e);return s.success&&s.data?(this.setAuthState(s.data),{success:!0}):{success:!1,error:s.error||"\u8A3B\u518A\u5931\u6557"}}catch(s){return{success:!1,error:s.message||"\u8A3B\u518A\u5931\u6557"}}finally{this._isLoading.set(!1)}}async login(e){this._isLoading.set(!0);try{let t=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e.email,password:e.password,device_name:e.device_name||this.getDeviceName(),remember:e.remember||!1})})).json();return t.success&&t.data?(e.remember?localStorage.setItem("tgm_remember_me","true"):localStorage.removeItem("tgm_remember_me"),this.setAuthState(t.data),this.scheduleTokenRefresh(),{success:!0}):{success:!1,error:t.error||"\u767B\u5165\u5931\u6557"}}catch(s){return{success:!1,error:s.message||"\u767B\u5165\u5931\u6557"}}finally{this._isLoading.set(!1)}}async getTelegramConfig(){try{let s=await(await fetch(`${this.getApiBaseUrl()}/api/v1/oauth/telegram/config`)).json();return s.success&&s.data?s.data:{enabled:!1}}catch(e){return console.error("Failed to get Telegram config:",e),{enabled:!1}}}async telegramLogin(e){this._isLoading.set(!0);try{let t=await(await fetch(`${this.getApiBaseUrl()}/api/v1/oauth/telegram`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return t.success?(this.setAuthState({user:t.user,access_token:t.access_token,refresh_token:t.refresh_token}),this.scheduleTokenRefresh(),{success:!0}):{success:!1,error:t.error||"Telegram \u767B\u5165\u5931\u6557"}}catch(s){return{success:!1,error:s.message||"Telegram \u767B\u5165\u5931\u6557"}}finally{this._isLoading.set(!1)}}async logout(){try{let e=this._accessToken();e&&await fetch(`${this.getApiBaseUrl()}/api/v1/auth/logout`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}})}catch(e){console.error("Logout error:",e)}finally{this.authEvents.emitLogout(),this.clearAuthStateInternal(),this.router.navigate(["/auth/login"])}}async forgotPassword(e){try{let t=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/forgot-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})})).json();return{success:t.success,error:t.error}}catch(s){return{success:!1,error:s.message}}}async resetPassword(e,s){try{let r=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/reset-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e,password:s})})).json();return{success:r.success,error:r.error}}catch(t){return{success:!1,error:t.message}}}async verifyEmail(e){try{let t=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/verify-email`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})})).json();return{success:t.success,error:t.error}}catch(s){return{success:!1,error:s.message}}}async verifyEmailByCode(e,s){try{let r=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/verify-email-code`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,code:s})})).json();return{success:r.success,error:r.error}}catch(t){return{success:!1,error:t.message}}}async resendVerificationEmail(){try{let e=this._accessToken();if(!e)return{success:!1,error:"\u672A\u767B\u5165"};let t=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/send-verification`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}})).json();return{success:t.success,error:t.error}}catch(e){return{success:!1,error:e.message}}}async refreshAccessToken(){let e=this._refreshToken();if(!e)return!1;try{let t=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})})).json();return t.success&&t.data?(this._accessToken.set(t.data.access_token),this._refreshToken.set(t.data.refresh_token),this.scheduleTokenRefresh(),!0):!1}catch(s){return console.error("Token refresh error:",s),!1}}async fetchCurrentUser(){if(this._pendingFetchUser)return console.log("[AuthService] fetchCurrentUser: Reusing pending request"),this._pendingFetchUser;let e=this._fetchCurrentUserInternal();this._pendingFetchUser=e;try{return await e}finally{this._pendingFetchUser=null}}async _fetchCurrentUserInternal(){let e=this._accessToken()||localStorage.getItem(i.ACCESS_TOKEN);if(!e)return console.log("[AuthService] fetchCurrentUser: No token available"),null;!this._accessToken()&&e&&this._accessToken.set(e);try{console.log("[AuthService] fetchCurrentUser: Fetching user info...");let s=await fetch(`${this.getApiBaseUrl()}/api/v1/auth/me`,{headers:{Authorization:`Bearer ${e}`}});if(!s.ok)return console.warn(`[AuthService] fetchCurrentUser: HTTP ${s.status}`),s.status===401&&console.warn("[AuthService] Token invalid, clearing session"),null;let t=await s.json();if(t.success&&t.data){let r=u({},t.data);return!r.displayName&&r.display_name&&(r.displayName=r.display_name),(!r.display_name||r.display_name.trim()==="")&&(r.display_name=r.telegram_first_name||r.username||"\u7528\u6236",r.displayName=r.display_name),!r.telegramId&&r.telegram_id&&(r.telegramId=r.telegram_id),console.log("[AuthService] fetchCurrentUser: Success",r.username,"displayName:",r.displayName),this._user.set(r),localStorage.setItem(i.USER,JSON.stringify(r)),this.authEvents.emitUserUpdate(r),r}return console.warn("[AuthService] fetchCurrentUser: API returned",t),null}catch(s){return console.error("[AuthService] fetchCurrentUser error:",s),null}}async forceRefreshUser(){return console.log("[AuthService] forceRefreshUser: \u5F37\u5236\u5237\u65B0\u7528\u6236\u6578\u64DA"),this.fetchCurrentUser()}async updateProfile(e){let s=this._accessToken();if(!s)return{success:!1,error:"\u672A\u767B\u5165"};try{let r=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/me`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify(e)})).json();if(r.success){let n=this._user();return n&&this._user.set(u(u({},n),e)),{success:!0}}return{success:!1,error:r.error}}catch(t){return{success:!1,error:t.message}}}async changePassword(e,s){let t=this._accessToken();if(!t)return{success:!1,error:"\u672A\u767B\u5165"};try{let n=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/change-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({old_password:e,new_password:s})})).json();return{success:n.success,error:n.error}}catch(r){return{success:!1,error:r.message}}}async getSessions(){let e=this._accessToken();if(!e)return[];try{let t=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/devices`,{headers:{Authorization:`Bearer ${e}`}})).json();return t.success?t.data?.devices||[]:[]}catch{return[]}}async revokeSession(e){let s=this._accessToken();if(!s)return!1;try{return(await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/devices/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${s}`}})).json()).success}catch{return!1}}async revokeAllOtherSessions(){let e=this._accessToken();if(!e)return 0;try{let s=localStorage.getItem("tgm_session_id")||"",r=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/devices/revoke-all`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({current_session_id:s})})).json();return r.success&&r.revoked_count||0}catch{return 0}}hasFeature(e){let s=this.subscriptionTier(),r={free:["basic_monitoring","basic_ai"],basic:["basic_monitoring","basic_ai","templates"],pro:["basic_monitoring","basic_ai","templates","full_monitoring","advanced_ai","team","api_access"],enterprise:["all"]}[s]||[];return r.includes("all")||r.includes(e)}getAuthHeaders(){let e=this._accessToken()||localStorage.getItem("tgm_access_token");return e?{Authorization:`Bearer ${e}`}:{}}async getDevices(){let e=this._accessToken();if(!e)return[];try{let t=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/devices`,{headers:{Authorization:`Bearer ${e}`}})).json();return t.success?t.data?.devices||t.devices||[]:[]}catch(s){return console.error("Failed to get devices:",s),[]}}async bindDevice(e,s){let t=this._accessToken();if(!t)return{success:!1,message:"\u672A\u767B\u5165"};try{let n=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/devices`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({device_code:e,device_name:s})})).json();return{success:n.success,message:n.message||(n.success?"\u7D81\u5B9A\u6210\u529F":"\u7D81\u5B9A\u5931\u6557")}}catch(r){return{success:!1,message:r.message||"\u7D81\u5B9A\u5931\u6557"}}}async unbindDevice(e){let s=this._accessToken();if(!s)return{success:!1,message:"\u672A\u767B\u5165"};try{let r=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/devices/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${s}`}})).json();return{success:r.success,message:r.message||(r.success?"\u89E3\u7D81\u6210\u529F":"\u89E3\u7D81\u5931\u6557")}}catch(t){return{success:!1,message:t.message||"\u89E3\u7D81\u5931\u6557"}}}async updateEmail(e,s){let t=this._accessToken();if(!t)return{success:!1,message:"\u8ACB\u5148\u767B\u5165"};try{let n=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/me`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({email:e,password:s})})).json();if(n.success){let c=this._user();if(c){let d=m(u({},c),{email:e});this._user.set(d),localStorage.setItem(i.USER,JSON.stringify(d)),this.authEvents.emitUserUpdate(d)}return{success:!0,message:"\u90F5\u7BB1\u66F4\u65B0\u6210\u529F"}}return{success:!1,message:n.error||n.message||"\u90F5\u7BB1\u66F4\u65B0\u5931\u6557"}}catch(r){return{success:!1,message:r.message||"\u4FEE\u6539\u90F5\u7BB1\u5931\u6557"}}}async updateDisplayName(e){let s=this._accessToken();if(!s)return{success:!1,message:"\u8ACB\u5148\u767B\u5165"};try{let r=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/me`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({display_name:e})})).json();if(r.success){let n=this._user();if(n){let c=m(u({},n),{display_name:e,displayName:e});this._user.set(c),localStorage.setItem(i.USER,JSON.stringify(c)),this.authEvents.emitUserUpdate(c)}return{success:!0,message:"\u986F\u793A\u540D\u7A31\u66F4\u65B0\u6210\u529F"}}return{success:!1,message:r.error||r.message||"\u986F\u793A\u540D\u7A31\u66F4\u65B0\u5931\u6557"}}catch(t){return{success:!1,message:t.message||"\u4FEE\u6539\u986F\u793A\u540D\u7A31\u5931\u6557"}}}async renewMembership(e){let s=await this.activateLicense(e);return{success:s.success,message:s.message,newExpires:s.data?.expiresAt}}async getUsageStats(){let e=this._accessToken();if(!e)return null;try{let t=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/usage-stats`,{headers:{Authorization:`Bearer ${e}`}})).json();return t.success&&t.data?(this._usageStats.set(t.data),t.data):t.success&&t.stats?(this._usageStats.set(t.stats),t.stats):null}catch(s){return console.error("Failed to get usage stats:",s),null}}async loadUsageStats(){await this.getUsageStats()}async loadDevices(){let e=await this.getDevices();return this._devices.set(e),e}async activateLicense(e){let s=this._accessToken();if(!s)return{success:!1,message:"\u672A\u767B\u5165"};try{let r=await(await fetch(`${this.getApiBaseUrl()}/api/v1/license/activate`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({license_key:e})})).json();return r.success&&(await this.fetchCurrentUser(),this.authEvents.emitUserUpdate(this._user())),{success:r.success,message:r.message||(r.success?"\u6FC0\u6D3B\u6210\u529F":"\u6FC0\u6D3B\u5931\u6557"),data:r.data}}catch(t){return{success:!1,message:t.message||"\u6FC0\u6D3B\u5931\u6557"}}}async getInviteRewards(){let e=this._accessToken(),s=this._user(),t={inviteCode:s?.invite_code||s?.inviteCode||"",invitedCount:0,rewardDays:0};if(!e)return t;try{let n=await(await fetch(`${this.getApiBaseUrl()}/api/v1/auth/invite-rewards`,{headers:{Authorization:`Bearer ${e}`}})).json();return n.success?{inviteCode:n.data?.invite_code||t.inviteCode,invitedCount:n.data?.invited_count||0,rewardDays:n.data?.reward_days||0}:t}catch{return t}}setAuthState(e){e.user&&(this._user.set(e.user),localStorage.setItem(i.USER,JSON.stringify(e.user))),e.access_token&&(this._accessToken.set(e.access_token),localStorage.setItem(i.ACCESS_TOKEN,e.access_token)),e.refresh_token&&(this._refreshToken.set(e.refresh_token),localStorage.setItem(i.REFRESH_TOKEN,e.refresh_token))}setSession(e){console.log("[AuthService] setSession called:",{hasAccessToken:!!e.access_token,hasRefreshToken:!!e.refresh_token,hasUser:!!e.user}),e.access_token&&(localStorage.setItem(i.ACCESS_TOKEN,e.access_token),this._accessToken.set(e.access_token)),e.refresh_token&&(localStorage.setItem(i.REFRESH_TOKEN,e.refresh_token),this._refreshToken.set(e.refresh_token)),e.user&&(localStorage.setItem(i.USER,JSON.stringify(e.user)),this._user.set(e.user)),e.session_id&&localStorage.setItem(i.SESSION_ID,e.session_id),this.authEvents.emitLogin(e),console.log("[AuthService] setSession complete, isAuthenticated:",this.isAuthenticated())}clearSession(){this.authEvents.emitLogout(),this.clearAuthStateInternal()}clearAuthStateInternal(){this._user.set(null),this._accessToken.set(null),this._refreshToken.set(null),this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),this.authEvents.clearAllAuthStorage()}clearAuthState(){this.clearAuthStateInternal()}restoreSession(){try{let e=localStorage.getItem(i.ACCESS_TOKEN),s=localStorage.getItem(i.REFRESH_TOKEN),t=localStorage.getItem(i.USER);if(console.log("[Auth] restoreSession - accessToken:",!!e,"refreshToken:",!!s,"user:",!!t),e&&!this.isValidTokenFormat(e)){console.warn("[Auth] Invalid token format, clearing session"),this.clearAuthState();return}if(e&&(console.log("[Auth] Setting accessToken signal"),this._accessToken.set(e)),s&&this._refreshToken.set(s),t)try{let r=JSON.parse(t);!r.displayName&&r.display_name&&(r.displayName=r.display_name),(!r.display_name||(r.display_name||"").trim()==="")&&(r.display_name=r.telegram_first_name||r.username||"\u7528\u6236",r.displayName=r.display_name),!r.telegramId&&r.telegram_id&&(r.telegramId=r.telegram_id),this._user.set(r),console.log("[Auth] User restored from localStorage, displayName:",r.displayName||r.display_name)}catch{console.warn("[Auth] Invalid user JSON, clearing"),this.clearAuthState();return}console.log("[Auth] Session restored successfully"),e&&!t&&(console.log("[Auth] Token exists but no user info, fetching immediately..."),queueMicrotask(()=>{this._accessToken()&&this.fetchCurrentUser().then(r=>{r?console.log("[Auth] User info fetched successfully:",r.username):console.warn("[Auth] Failed to fetch user info")}).catch(r=>{console.warn("[Auth] Error fetching user info:",r)})}))}catch(e){console.error("Restore session error:",e),this.clearAuthState()}}isValidTokenFormat(e){if(!e||e.length<20)return!1;let s=e.split(".");if(s.length!==3)return!1;try{let t=JSON.parse(this.base64UrlDecode(s[1]));return t.exp&&Date.now()>=t.exp*1e3?(console.warn("[Auth] Token expired"),!1):!0}catch{return!1}}base64UrlDecode(e){let s=e.replace(/-/g,"+").replace(/_/g,"/");for(;s.length%4;)s+="=";return atob(s)}scheduleTokenRefresh(){this.refreshTimer&&clearTimeout(this.refreshTimer);let e=localStorage.getItem("tgm_remember_me")==="true",s=e?1380*60*1e3:3300*1e3;console.log(`[AuthService] Scheduling token refresh in ${s/6e4} minutes (rememberMe: ${e})`),this.refreshTimer=setTimeout(()=>{this.refreshAccessToken()},s)}getApiBaseUrl(){return window.location.hostname==="localhost"&&window.location.port==="4200"?"http://localhost:8000":""}getDeviceName(){let e=navigator.userAgent;return e.includes("Windows")?"Windows Browser":e.includes("Mac")?"Mac Browser":e.includes("Linux")?"Linux Browser":e.includes("iPhone")||e.includes("iPad")?"iOS Browser":e.includes("Android")?"Android Browser":"Web Browser"}static{this.\u0275fac=function(s){return new(s||g)}}static{this.\u0275prov=p({token:g,factory:g.\u0275fac,providedIn:"root"})}};export{S as a};
