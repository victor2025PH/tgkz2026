# AI 未真正啟用、儀表盤顯示全自動、登錄後需重設、測試僅變綠 — 優化方案

## 一、現象與訴求

1. **監控與回覆已通，但回覆不是 AI**：群內關鍵詞能觸發回覆，但發出去的是模板/固定文案，不是 AI 生成的消息，即「AI 並沒有啟用」。
2. **儀表盤「AI 聊天」顯示全自動**：與實際「未用 AI 回覆」矛盾，造成誤解。
3. **每次登錄 AI 連接都要重新設置**：本地 AI 的 URL、默認、模型用途等，登出再登入或換設備後丟失或未恢復。
4. **點「測試 AI 鏈接」只是按鈕變綠**：沒有明確說明「已可正常生成回覆」，也不知道如何驗證 AI 能真正回覆。

以下為根因梳理與優化方案（僅方案，不涉及具體代碼修改步驟）。

---

## 二、根因梳理

### 2.1 為什麼回覆不是 AI 消息？

實際發送 AI 回覆的鏈路依賴兩點：

- **意願**：`ai_settings` 裡 `auto_chat_enabled = 1` 且 `auto_chat_mode = 'full'`（全自動），儀表盤的「全自動」正是讀這裡，所以會顯示「全自動」。
- **能力**：生成內容時必須能拿到「日常對話」用的 AI 模型（端點、key 等）。這來自 **模型用途分配**：`ai_settings` 中 `model_usage` 的 `dailyChat` 欄位要指向某個已配置的模型 ID；後端再根據該 ID 從 `ai_models` 取端點並調用。

因此可能出現：

- 用戶在「引擎概覽」開了全自動 → 儀表盤正確顯示「全自動」。
- 但在「模型配置」裡：
  - **沒有**在「模型用途分配」中為「日常對話」選擇模型（下拉仍是「選擇模型」），或  
  - 有選過，但 **model_usage 未按用戶持久化 / 未在回調上下文中按用戶讀取**，  
則生成回覆時拿不到「日常對話」對應的模型，就會走模板/固定文案，看起來就像「AI 沒有啟用」。

此外，在 **多租戶** 下，若後端讀取 `model_usage` 時 **沒有帶當前 user_id**（例如只按 `key = 'model_usage'` 查 `ai_settings`），會讀到錯的用戶或空，同樣導致「有全自動、無 AI 模型」→ 回覆不是 AI。

### 2.2 為什麼「AI 聊天」顯示全自動？

儀表盤的「AI 聊天」狀態來自 **get-system-status** 等接口，讀的是 `ai_settings` 的：

- `auto_chat_enabled`
- `auto_chat_mode`（`'full'` 即顯示為全自動）

這表示的是**用戶的意願設置**（我要全自動），而不是**當前是否具備可用的 AI 模型**。因此會出現：  
「全自動」= 開，但「日常對話」未配模型或模型未正確加載 → 顯示全自動，實際卻無法用 AI 回覆。

### 2.3 為什麼每次登錄 AI 連接都要重新設置？

可能原因包括：

- **按用戶存儲/加載不完整**：模型列表、默認模型、模型用途分配（`model_usage`）存庫時帶了 user_id，但登錄後加載時（例如首屏或智能引擎入口）**未帶當前用戶**（cookie/token 未就緒或接口未傳 tenant），導致讀到空或錯的用戶數據，表現為「又要重設」。
- **加載時機**：登錄後首屏若在「認證未完全生效」時就請求模型/用途，後端用錯了 user_id 或未認證，返回空；用戶再手動打開智能引擎才帶上用戶，此時再設一次才生效。
- **前端只展示、未在進入時強刷**：若進入智能引擎時沒有強制用當前用戶拉一次「模型列表 + 模型用途」，可能沿用舊緩存（例如上一個用戶或空），看起來像「登錄後又要重設」。

### 2.4 為什麼點「測試 AI 鏈接」只是按鈕變綠？

當前「測試」邏輯多半只做了 **連通性檢查**（例如對配置的 URL 發一次 HTTP 請求，成功則標記為已連接、按鈕/狀態變綠），並**沒有**：

- 發送一條**真實的測試對話**（例如固定 prompt）到該端點；
- 展示**返回的 AI 回覆內容**。

因此用戶只能得到「能連上」的反饋，無法確認「該模型能否正常生成可用的回覆」，也無法區分「連通但模型報錯/格式不對」等情況。

---

## 三、優化方案（思路）

### 3.1 讓「回覆是 AI」：確保日常對話一定有模型

- **後端**  
  - 生成 AI 回覆時，取「日常對話」模型的邏輯必須 **按當前用戶** 讀取：  
    從 `ai_settings` 取 `model_usage` 時 **必須帶 user_id**（例如 `WHERE user_id = ? AND key = 'model_usage'`），避免多租戶下讀錯或讀空。  
  - 若 `model_usage.dailyChat` 為空，可 **回退**：先看是否有默認模型（is_default），若有則用默認模型作為日常對話模型，減少「已配模型但沒選用途」導致的不發 AI 的情況。

- **前端**  
  - 在「模型配置」頁，若用戶已添加並測試過模型，但 **「日常對話」仍為「選擇模型」**，應有明顯提示：例如「請為「日常對話」選擇一個模型，否則觸發規則不會使用 AI 回覆」，並可一鍵將當前默認模型設為日常對話。

- **保存與加載**  
  - 保存「模型用途分配」時，必須寫入當前用戶的 `ai_settings`（user_id + key `model_usage`）；  
  - 進入智能引擎時，用當前用戶拉取「模型列表」的同時拉取「模型用途」，並在登錄後首屏/智能引擎入口 **確保帶上登入態** 再請求，避免登錄後仍讀到空。

### 3.2 讓儀表盤「全自動」與實際能力一致

- **狀態分層**  
  - **意願**：仍用 `ai_settings.auto_chat_enabled` + `auto_chat_mode`，表示用戶選擇「全自動」。  
  - **能力**：在 get-system-status（或單獨接口）中增加一項，例如 `ai_can_reply: true/false`，條件為：當前用戶存在「日常對話」可用模型（有 model_usage.dailyChat 且對應模型存在且已連接，或存在默認模型且已連接）。

- **展示**  
  - 儀表盤「AI 聊天」在顯示「全自動」時，若 `ai_can_reply === false`，應有輔助說明或弱提示：例如「已設為全自動，但尚未配置可用 AI 模型，目前回覆將使用模板」或「請在智能引擎 → 模型配置 中為「日常對話」選擇模型」，避免用戶以為「全自動 = 已經在用 AI」。

### 3.3 登錄後不再重設：持久化與加載時序

- **存儲**  
  - 模型列表、默認模型、模型用途均按 **user_id** 存（ai_models、ai_settings.model_usage）；  
  - 本地 AI 的 URL、測試狀態等已在 ai_models 中按 user_id 存儲，確保寫入時帶當前登入用戶。

- **加載**  
  - 所有「我的 AI 配置」接口（模型列表、模型用途、AI 設置）在 **認證中間件** 中解析當前用戶，並只返回該用戶數據；  
  - 登錄成功後，前端在 **拿到登入態之後** 再請求上述接口（或延遲 200–300ms 再拉），避免首請求未帶 token 導致空數據；  
  - 進入智能引擎頁時 **強制用當前用戶** 拉一次「模型列表 + 模型用途」，不依賴首屏緩存，避免切菜單或二次進入仍顯示空。

- **可選**  
  - 若存在「僅在本地保存、未同步到後端」的路徑（例如只寫 localStorage 或未點「保存設置」），需在文檔或 UI 上明確：**登錄態下的配置需點「保存設置」才會在下次登錄恢復**；必要時在離開頁面或切換前提示未保存。

### 3.4 「測試 AI 鏈接」能驗證「可回覆」

- **現狀**  
  - 僅做連通性檢查（例如 GET/POST 到端點，看是否 200），按鈕變綠 = 連通，**不驗證**是否真的能拿到 AI 生成內容。

- **優化**  
  - **兩級測試**（可並存）：  
    1. **連通性測試**（保留）：當前邏輯，快速反饋「端點可達」。  
    2. **回覆能力測試**：  
       - 對該模型發送一條 **固定測試 prompt**（例如「請用一句話介紹你自己」）；  
       - 調用與真實回覆相同的生成接口（或同一端點），取得返回文本；  
       - 在 UI 上展示：「測試回覆：xxx」，並標記「已連接且可正常生成回覆」。  
  - 按鈕/狀態建議：  
    - 僅連通：顯示「已連接」或按鈕綠；  
    - 連通 + 回覆測試通過：顯示「已連接，可回覆」或明確文案「測試回覆成功」，用戶一眼可知「鏈接上且能回覆」。

- **可選**  
  - 在智能引擎或幫助中提供 **「發送測試消息」**：在配置好「日常對話」模型後，用戶可輸入一句話，系統用當前配置的日常對話模型生成一條回覆並展示，用於端到端自檢。

---

## 四、實施優先級建議

| 優先級 | 內容 | 預期效果 |
|--------|------|----------|
| P0 | 後端讀取 model_usage 時帶 user_id；無 dailyChat 時回退默認模型 | 多用戶下用對模型；減少「已配模型卻不發 AI」 |
| P0 | 前端進入智能引擎時強制拉取「模型列表 + 模型用途」；保存用途時寫入當前用戶 | 登錄後/切菜單後不再「又要重設」；用途持久化正確 |
| P1 | 儀表盤增加 ai_can_reply，並在「全自動」但無能力時給提示 | 「全自動」與「實際能 AI 回覆」一致，減少誤解 |
| P1 | 「測試 AI 鏈接」增加「回覆能力測試」並展示測試回覆內容 | 用戶能確認「已連接且可回覆」 |
| P2 | 模型配置頁在「日常對話」未選時給提示 + 可一鍵用默認模型填充 | 降低配置遺漏率 |

按上述順序實施後，再配合既有「AI 未持久化與群監控未觸發」文檔中的登錄/租戶要點，可系統性解決：回覆不是 AI、全自動與實際不符、登錄重設、測試只變綠等問題。

---

## 五、本輪實施結果與優化

### 5.1 已實施內容

| 優先級 | 內容 | 文件/位置 |
|--------|------|-----------|
| P0 | **get_model_for_usage 按 user_id 查 model_usage**；無 dailyChat 時回退當前用戶的默認模型（is_default=1）或任一可用模型 | `backend/ai_auto_chat.py` |
| P0 | 進入智能引擎時同時調用 **loadModelsFromBackend + loadModelUsageFromBackend**；loadModelUsageFromBackend 支持後端 **model_usage** 單一對象或分散鍵 | `src/ai-center/ai-center.component.ts`、`src/ai-center/ai-center.service.ts` |
| P1 | **get-system-status** 增加 **ai.canReply**（日常對話有已連接模型或默認模型已連接）；**全自動但無能力**時加入警告 **AI_FULL_BUT_NO_MODEL**；儀表盤展示該警告並提供「前往智能引擎」按鈕 | `backend/domain/automation/monitoring_handlers_impl.py`、`src/views/dashboard-view.component.ts` |
| P1 | 測試成功時 Toast 明確區分「**已連接，可正常生成回覆**」並展示 **測試回覆** 預覽（後端已有 responsePreview，前端優化文案與展示） | `src/ai-center/ai-center.service.ts` |
| P2 | 模型配置頁當「日常對話」未選且存在默認模型時，顯示提示 + **「用默認模型填充」** 按鈕，一鍵寫入並保存 | `src/ai-center/ai-center.component.ts` |

### 5.2 在方案基礎上的細化與優化

- **回退鏈**：get_model_for_usage 在無該用途時先查 **is_default=1**，再查 **任一可用模型**，避免「有模型但未勾選用途」時仍能發 AI 回覆。
- **ai_can_reply 與默認模型**：canReply 計算時若 model_usage.dailyChat 為空，則用當前用戶的默認模型判斷 is_connected，與後端生成回覆的回退邏輯一致。
- **模型用途加載**：REST 返回的 ai_settings 可能為單一 key `model_usage`（對象），前端 getSettings 後同時兼容 **model_usage** 與 **model_usage_intent/model_usage_chat/model_usage_script**，避免只存一種格式時加載不到。
- **導航**：儀表盤「前往智能引擎」使用 `navigateTo('ai-engine')`，在 viewMap 中映射為 `aiCenter`，與現有導航一致。

### 5.3 小結

- **回覆是 AI**：多租戶下按 user_id 讀 model_usage；無 dailyChat 時用默認/任一模型，觸發規則與問候能拿到模型並生成 AI 回覆。
- **全自動與能力一致**：儀表盤可顯示「全自動但尚未配置可用 AI 模型」的警告，減少誤解。
- **登錄後少重設**：進入智能引擎必拉模型列表 + 模型用途，且支持後端兩種存儲格式。
- **測試反饋**：成功時 Toast 區分「已連接，可正常生成回覆」並展示測試回覆預覽；「日常對話」未選時有提示與一鍵填充。

---

## 六、下一階段建議

1. **驗證**  
   - 多用戶下：A 用戶配置日常對話模型、B 用戶未配置，確認各自觸發規則回覆是否為 AI、儀表盤警告是否按用戶出現。  
   - 登錄後直接進入智能引擎，確認模型列表與「日常對話」是否為當前用戶且無需重設。

2. **可選**  
   - 若需更強「可回覆」驗證：在智能引擎或幫助中提供 **「發送測試消息」** 入口，用戶輸入一句話，用當前日常對話模型生成一條回覆並展示，用於端到端自檢。  
   - 若保存「模型用途」除 REST 外仍有 IPC 路徑，確保 IPC 路徑也帶當前 user_id，與 REST 行為一致。
