# TG-AI智控王 v2.0 升級說明

## 🎉 重要更新

### 品牌統一
- 項目統一命名為 **TG-AI智控王**
- 新卡密前綴: `TGAI-` (兼容舊版 `TGM-`)
- 管理後台全面換新

### 六級王者榮耀風格會員系統

| 等級 | 名稱 | 圖標 | 月價格 |
|------|------|------|--------|
| bronze | 青銅戰士 | ⚔️ | 免費 |
| silver | 白銀精英 | 🥈 | ¥49 |
| gold | 黃金大師 | 🥇 | ¥99 |
| diamond | 鑽石王牌 | 💎 | ¥199 |
| star | 星耀傳說 | 🌟 | ¥399 |
| king | 榮耀王者 | 👑 | ¥999 |

### 新卡密格式

```
TGAI-[等級][時長]-[XXXX]-[XXXX]-[XXXX]

等級代碼:
  B = 白銀精英 (Silver)
  G = 黃金大師 (Gold)
  D = 鑽石王牌 (Diamond)
  S = 星耀傳說 (Star)
  K = 榮耀王者 (King)

時長代碼:
  1 = 周卡 (7天)
  2 = 月卡 (30天)
  3 = 季卡 (90天)
  Y = 年卡 (365天)
  L = 終身

示例:
  TGAI-G2-A1B2-C3D4-E5F6  (黃金月卡)
  TGAI-K1-XXXX-XXXX-XXXX  (王者周卡)
  TGAI-DY-XXXX-XXXX-XXXX  (鑽石年卡)
```

---

## 🗄️ 數據庫重構

### 新增數據表

1. **users** - 完整用戶信息
   - 邀請碼、邀請統計
   - 會員等級、到期時間
   - 餘額、消費統計

2. **licenses** - 卡密管理
   - 新增時長類型字段
   - 批次管理

3. **orders** - 訂單管理
   - 支付網關集成
   - 優惠券支持

4. **referrals** - 邀請獎勵記錄
   - 邀請人、被邀請人
   - 獎勵類型和金額

5. **user_quotas** - 用戶配額
   - 每日使用量追蹤

6. **usage_logs** - 使用日誌

7. **devices** - 設備管理

8. **settings** - 系統設置

9. **admins** - 管理員表

10. **admin_logs** - 操作日誌

11. **announcements** - 公告管理

12. **coupons** - 優惠券

13. **stats_daily** - 每日統計

---

## 🎁 邀請獎勵系統

### 獎勵規則

**註冊獎勵:**
- 邀請者: +3 天會員
- 被邀請者: +1 天會員

**首次付費獎勵:**
| 被邀請者購買等級 | 邀請者獎勵 |
|------------------|------------|
| 白銀 | 7天 + ¥5 |
| 黃金 | 15天 + ¥10 |
| 鑽石 | 30天 + ¥20 |
| 星耀 | 45天 + ¥40 |
| 王者 | 60天 + ¥100 |

**重複付費返傭:**
- 被邀請者每次付費，邀請者獲得 **10%** 返傭

---

## 📊 配額系統

每個會員等級都有對應的配額限制:

| 配額類型 | 青銅 | 白銀 | 黃金 | 鑽石 | 星耀 | 王者 |
|----------|------|------|------|------|------|------|
| TG帳號數 | 1 | 3 | 10 | 30 | 100 | 無限 |
| 日消息量 | 50 | 500 | 2000 | 10000 | 50000 | 無限 |
| 日AI調用 | 10 | 100 | 500 | 2000 | 10000 | 無限 |
| 設備數 | 1 | 2 | 3 | 5 | 10 | 無限 |
| 群組數 | 3 | 20 | 100 | 500 | 2000 | 無限 |
| 自動回覆 | 5 | 20 | 50 | 100 | 500 | 無限 |

---

## 🖥️ 管理後台新功能

### 新增頁面
- **邀請管理** - 查看邀請記錄和排行榜
- **公告管理** - 發布系統公告
- **配額配置** - 查看各等級配額設置

### 功能增強
- 用戶詳情頁 - 查看完整用戶資料
- 手動續費 - 支持選擇升級等級
- 封禁/解封用戶
- 卡密批量導出
- 操作日誌追蹤

---

## 🔧 API 更新

### 新增 API

**用戶 API:**
- `POST /api/user/register` - 用戶註冊
- `GET /api/user/profile` - 獲取用戶資料
- `GET /api/user/quota` - 獲取配額信息

**邀請 API:**
- `GET /api/invite/info` - 獲取邀請信息
- `GET /api/invite/list` - 獲取邀請列表

**管理 API:**
- `GET /api/admin/users/{user_id}` - 用戶詳情
- `POST /api/admin/users/{user_id}/ban` - 封禁用戶
- `GET /api/admin/referrals` - 邀請記錄
- `GET /api/admin/referral-stats` - 邀請統計
- `GET /api/admin/announcements` - 公告列表
- `POST /api/admin/announcements` - 創建公告
- `GET /api/admin/quotas` - 配額配置

---

## 🚀 部署步驟

### 1. 更新代碼
```bash
cd /opt/tg-matrix-server
git pull origin main
```

### 2. 更新 Python 依賴
```bash
source venv/bin/activate
pip install -r backend/requirements.txt
```

### 3. 初始化新數據庫
```bash
python backend/license_server.py init
```

> ⚠️ 注意: 新數據庫文件為 `tgai_server.db`，舊數據需要手動遷移

### 4. 重啟服務
```bash
sudo systemctl restart tg-matrix-license
```

### 5. 驗證
```bash
curl http://localhost:8080/api/health
```

---

## 📝 遷移注意事項

1. **數據庫遷移**: 新版使用 `tgai_server.db`，舊版數據在 `license_server.db`

2. **卡密兼容**: 新版同時支持 `TGAI-` 和 `TGM-` 格式卡密

3. **API 兼容**: 舊版 API 仍然可用，建議逐步遷移到新 API

4. **管理員密碼**: 默認管理員 `admin` / `admin888`，請及時修改

---

## 📞 聯繫支持

如有問題，請聯繫技術支持。
