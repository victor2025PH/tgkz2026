# 手動部署命令 - 服務器重新部署指南

> **更新日期**: 2026-02-05  
> **服務器**: 165.154.210.154  
> **用戶**: ubuntu

---

## 一、問題原因說明

### 您遇到的情況

| 頁面 | 錯誤 | 原因 |
|------|------|------|
| **主站登錄** (tgw.usdt2026.cc) | "Not Found" | API 運行在 fallback 模式，`/api/v1/auth/me` 等認證接口返回 404 |
| **管理後台** (/admin/) | "登錄失敗" | 認證接口不可用或憑證錯誤 |

### 根本原因

後端 API 的完整 `http_server` 啟動失敗（可能為模塊導入錯誤），系統降級到 `fallback_server`，該模式**不包含**認證相關路由，導致登錄功能無法使用。

---

## 二、新文件是否已同步？

### 檢查與推送 GitHub

**在本地項目目錄執行：**

```powershell
# 1. 查看未提交的改動
git status

# 2. 添加所有改動（如需要）
git add .

# 3. 提交
git commit -m "fix: 修復構建與部署"

# 4. 推送到 GitHub（會觸發自動部署）
git push origin main
```

**說明**：推送到 `main` 後，GitHub Actions 會自動執行部署；若未配置 SSH 密鑰或工作流失敗，則需手動部署。

---

## 三、手動部署到服務器

### 方式 A：SSH 登錄後在服務器上操作

```bash
# 1. SSH 登錄（密碼: TgMatrix2026! 或您設定的密碼）
ssh ubuntu@165.154.210.154

# 2. 進入項目目錄
cd /opt/tg-matrix

# 3. 從 GitHub 拉取最新代碼
git pull origin main

# 4. 重建並重啟 API 容器（解決依賴與代碼更新）
sudo docker compose build --no-cache api
sudo docker compose up -d --force-recreate api

# 5. 重建並重啟 Web 容器（確保前端靜態文件更新）
sudo docker compose up -d --force-recreate web

# 6. 等待約 15 秒後檢查狀態
sleep 15
sudo docker compose ps

# 7. 查看 API 日誌（確認是否仍為 fallback 模式）
sudo docker compose logs api --tail=50
```

### 方式 B：本地構建後通過 rsync 上傳（需本機已安裝 rsync）

```powershell
# 在本地項目根目錄執行（Windows PowerShell）

# 1. 構建前端
npm run build:saas

# 2. 使用 rsync 上傳（需先配置 SSH 密鑰或輸入密碼）
# 若無 rsync，可改用 scp 或 WinSCP
rsync -avz --delete `
  --exclude '.git' --exclude 'node_modules' --exclude '__pycache__' `
  --exclude 'data/' --exclude '.env' `
  -e "ssh" `
  ./ ubuntu@165.154.210.154:/opt/tg-matrix/

# 3. SSH 到服務器重啟服務
ssh ubuntu@165.154.210.154 "cd /opt/tg-matrix && sudo docker compose up -d --force-recreate web api"
```

### 方式 C：一鍵腳本（僅適用 License Server / 管理後台後端）

`deploy\one-click-deploy.bat` 部署的是 **License Server**（`/opt/tg-matrix-server`），不是主站 API。主站 API 部署在 `/opt/tg-matrix`。

---

## 四、部署後驗證

```bash
# 在服務器上執行

# 1. 檢查容器狀態（應為 Up）
sudo docker compose -f /opt/tg-matrix/docker-compose.yml ps

# 2. 測試 API 健康檢查
curl -s http://localhost:8000/health
curl -s http://localhost/api/health

# 3. 測試認證接口（若仍 404 則表示 fallback 模式未修復）
curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v1/auth/me
# 期望: 401（未授權）而非 404
```

---

## 五、若登錄仍失敗

若重新部署後主站仍顯示 "Not Found"，則問題在於 **API 代碼**（http_server 導入失敗），而不是部署流程。需要：

1. 在服務器上查看 API 啟動日誌，確認 ImportError 詳情：
   ```bash
   sudo docker compose logs api 2>&1 | head -100
   ```

2. 根據日誌排查並修復後端模塊導入問題（如 wallet、admin、auth 等）。

3. 管理後台默認帳號：用戶名 `admin`，密碼需在後端或環境變量中配置；若忘記密碼，需在後端數據庫或配置中重置。

---

## 六、快速命令匯總（複製使用）

```bash
# === 在服務器上執行（SSH 登錄後）===
cd /opt/tg-matrix
git pull origin main
sudo docker compose build --no-cache api
sudo docker compose up -d --force-recreate web api
sleep 15
sudo docker compose ps
sudo docker compose logs api --tail=30
```
