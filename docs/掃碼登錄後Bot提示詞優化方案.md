# 掃碼登錄後 Bot 提示詞優化方案

## 一、問題描述

用戶在完成掃碼登錄（或網頁/客戶端已登入）後，在 Telegram 與「TG智控王」機器人互動時，Bot 仍多次發送 **「❌ 登錄失敗」**，並附帶「服務器內部錯誤」或「Token 狀態無效: confirmed」等文案。**實際上登錄已成功**，造成：

- 用戶困惑：以為沒登上去，反覆重試或聯繫客服
- 信任感下降：產品顯得不可靠
- 客服與輿情成本上升

根因可歸為兩類（實施時需在代碼中對齊）：

1. **狀態語義處理錯誤**  
   當 Token 已為「已確認」（confirmed）時，後端或 Bot 仍將該狀態當作「無效」或「失敗」，返回錯誤碼/錯誤文案，Bot 再統一用「登錄失敗」模板展示，導致「已登入」被呈現為失敗。

2. **重複操作未做冪等與區分**  
   用戶對同一登錄請求重複點擊「確認登入」或多次發送帶 token 的 `/start` 時，後端未對「已確認」做冪等處理，直接返回「Token 狀態無效: confirmed」，Bot 未區分「重複確認」與「真正失敗」，一律顯示為登錄失敗。

本方案從**開發工程師、市場經理、用戶**三個視角對 Bot 的 UI/UX 與功能做優化，**僅給方案與實施要點，不涉及具體代碼**。

---

## 二、開發工程師視角（可維護性、正確性、邊界清晰）

### 2.1 狀態與接口語義

| 要點 | 方案建議 |
|------|----------|
| **confirm 接口冪等** | 對「確認登入」接口：若 Token 狀態已是 `confirmed`，視為**成功**並返回 `success: true` 及友好文案（如「您已登入」），不再返回「Token 狀態無效: confirmed」或任何會觸發「登錄失敗」的錯誤。 |
| **錯誤與「已登入」分離** | 後端明確區分：① 真實失敗（token 不存在、過期、伺服器異常）；② 已登入/重複確認。② 不應走「登錄失敗」分支，Bot 不應發送「❌ 登錄失敗」或把技術錯誤原文展示給用戶。 |
| **GET 查詢狀態** | 若前端/Bot 先 GET 查詢 Token 狀態再決定是否發送確認：當狀態為 `confirmed` 時，應直接返回成功語義與用戶數據，並在 Bot 側發送「登錄成功」類消息，不再發送確認按鈕或失敗提示。 |

### 2.2 Bot 側邏輯與文案來源

| 要點 | 方案建議 |
|------|----------|
| **以業務結果驅動文案** | Bot 根據後端返回的**業務結果**（成功/已登入/失敗）選擇模板，而不是僅根據 HTTP 狀態碼或「有無 error 字段」判斷。例如：後端返回「已登入」專用碼或 `success: true` + `already_confirmed: true` 時，Bot 只發「登錄成功」或「您已登入」類提示。 |
| **錯誤文案不直接暴露技術細節** | 向用戶展示的錯誤訊息應為**本地化、可理解的短句**（如「登錄請求已過期，請返回網頁重新掃碼」），不直接暴露「Token 狀態無效: confirmed」等技術用語。技術細節僅寫入日誌或內部監控。 |
| **日誌與監控** | 對「Token 已為 confirmed 時的二次請求」打 **info** 日誌（如「Token already confirmed, treating as success」），與真實錯誤（token 不存在、過期、5xx）區分，便於排查與統計。 |

### 2.3 實施優先級（工程）

1. **P0**：後端 confirm 接口對「已確認」做冪等，返回成功語義；Bot 收到該結果時只發「登錄成功」類消息。  
2. **P1**：Bot 與後端約定「已登入/重複確認」的返回形狀，統一走成功分支；錯誤分支僅用於真實失敗，且錯誤文案經本地化/白名單。  
3. **P2**：可選——GET 查詢狀態接口在 `confirmed` 時返回明確欄位（如 `already_logged_in: true`），Bot 據此發送「您已登入，無需重複操作」等單一提示，減少重複消息。

---

## 三、市場經理視角（信任、轉化、客服與輿情）

### 3.1 用戶感知與信任

| 要點 | 方案建議 |
|------|----------|
| **成功即成功** | 只要登錄在系統側已成功，用戶在 Bot 中應看到**明確的成功反饋**（如「✅ 登錄成功」），絕不出現「登錄失敗」或技術錯誤原文，避免「明明登上了卻說失敗」的負面體驗。 |
| **可操作錯誤提示** | 真實失敗時，提示應簡短、可操作：如「登錄請求已過期，請返回網頁重新掃碼」「暫時無法完成，請稍後再試或聯繫客服」，不展示原始技術錯誤，減少恐慌與誤解。 |
| **重複操作不當成失敗** | 用戶重複點擊「確認」或多次發送連結時，應視為「已登入」或「無需重複操作」，用一條中性/正向提示即可，不發送「登錄失敗」。 |

### 3.2 文案與品牌

| 要點 | 方案建議 |
|------|----------|
| **成功文案統一、正向** | 成功/已登入類消息：統一使用「✅ 登錄成功」等正向標題，可配一句短說明（如「瀏覽器頁面將自動跳轉」），語氣一致、不帶技術術語。 |
| **錯誤文案中性、可尋助** | 失敗類消息：保持「請重新嘗試或聯繫客服」等中性結尾，錯誤原因用一句**用戶可理解**的短語（過期、繁忙、網路問題等），不暴露「Token 狀態無效」「confirmed」等。 |
| **可選：減少重複打擾** | 若同一 Token 多次觸發 Bot 消息，可考慮：首次成功後發送一條成功提示；後續同一 Token 的請求可回覆「您已登入，無需重複操作」或僅回一條簡短提示，避免刷屏。 |

### 3.3 實施優先級（市場）

1. **P0**：消除「已登入卻顯示登錄失敗」的狀況，確保成功與失敗語義與用戶感知一致。  
2. **P1**：所有對外錯誤文案經產品/運營審核，統一為可理解、可操作、不暴露技術細節。  
3. **P2**：可選——在幫助或首次使用說明中簡短寫明「若您已在網頁完成登入，Bot 會提示登錄成功，無需重複點擊」，降低重複操作與困惑。

---

## 四、用戶視角（可發現性、理解成本、不困惑）

### 4.1 預期與實際一致

| 要點 | 方案建議 |
|------|----------|
| **掃碼/點確認後的反饋** | 用戶預期：要麼看到「登錄成功」並在網頁/客戶端繼續使用，要麼看到明確的失敗原因與下一步（如「請返回網頁重新掃碼」）。不應出現「登錄失敗」卻實際已登入的情況。 |
| **重複操作的反饋** | 用戶可能多次點擊「確認登入」或重發連結。預期：要麼提示「您已登入」，要麼「無需重複操作」，不應出現多條「登錄失敗」或技術錯誤。 |
| **錯誤時知道下一步** | 若真的失敗，用戶應能從文案中知道「該做什麼」（重新掃碼、稍後再試、聯繫客服），而不是看到技術術語後不知道如何處理。 |

### 4.2 訊息簡潔、不刷屏

| 要點 | 方案建議 |
|------|----------|
| **同一流程不重複發失敗** | 同一登錄流程中，若後端已判定為成功或「已登入」，Bot 只發一條成功類消息，不因重複回調或重試而發多條「登錄失敗」。 |
| **成功/已登入一條說清** | 成功或「已登入」時，用一條消息說清結果即可（可含「瀏覽器將自動跳轉」或「無需重複操作」），避免多條相似消息造成困惑。 |

### 4.3 實施優先級（用戶）

1. **P0**：登錄成功時只看到成功提示，登錄失敗時只看到可理解的失敗提示，且兩者不互串。  
2. **P1**：重複操作得到單一、友好回覆，不刷屏、不技術術語。  
3. **P2**：可選——在 Bot 內提供簡短幫助（如 /help）說明「若已登入可忽略重複提示」，降低不安。

---

## 五、統一實施要點（跨視角）

| 序號 | 要點 | 說明 |
|------|------|------|
| 1 | **後端 confirm 冪等** | Token 狀態為 `confirmed` 時，確認接口返回成功語義，不返回「Token 狀態無效: confirmed」等會觸發「登錄失敗」的錯誤。 |
| 2 | **Bot 以業務結果選文案** | 根據後端返回的「成功/已登入/失敗」選擇對應模板；「已登入」與「成功」均走成功類消息，不發「❌ 登錄失敗」。 |
| 3 | **錯誤文案白名單/本地化** | 對外錯誤訊息僅使用預定義、用戶可理解的短句，不把後端原始錯誤字符串直接展示給用戶。 |
| 4 | **日誌區分「已確認」與真實錯誤** | 便於排查與監控，且不影響用戶可見文案。 |
| 5 | **可選：GET 狀態為 confirmed 時直接成功** | 查詢狀態若為已確認，直接返回成功與用戶數據，Bot 發送成功提示，必要時可不再發送確認按鈕，減少重複點擊。 |

---

## 六、預期效果

- **開發**：狀態語義清晰、接口冪等、錯誤與「已登入」分離，日誌可追溯，易維護。  
- **市場**：用戶感知與實際一致，信任感提升；錯誤提示可操作、不暴露技術細節，有利於品牌與客服。  
- **用戶**：掃碼或點擊確認後，要麼看到明確成功，要麼看到可理解的失敗與下一步；不再出現「實際已登入卻顯示登錄失敗」的困惑。

實施時建議先做 **P0**（後端冪等 + Bot 成功/失敗分支與文案分離），再按需做 P1/P2（文案審核、重複操作提示、幫助說明等）。

---

## 七、實施結果與本輪優化（已完成）

### 7.1 已實施內容

| 項 | 位置 | 說明 |
|----|------|------|
| **後端 confirm 冪等** | `backend/auth/login_token.py` | `confirm_token()`：當狀態為 `confirmed` 時直接返回 `(True, None)` 並打 info 日誌，不再返回「Token 狀態無效: confirmed」。 |
| **非 PENDING 錯誤語義** | 同上 | 當狀態為 `expired` / `cancelled` 時返回用戶可理解短句（如「登錄請求已過期，請返回網頁重新掃碼」「登錄已取消，請重新發起登入」），過期分支文案統一為「登錄請求已過期，請返回網頁重新掃碼」。 |
| **成功消息：歡迎詞 + 功能簡介** | `backend/telegram/bot_handler.py` | 三語 `login_success` 擴充為：成功句 + 瀏覽器跳轉說明 + 簡短歡迎（歡迎使用 TG 智控王）+ 三條功能點（群組管理、AI 營銷、任務自動化）。 |
| **錯誤文案友好化** | 同上 | 新增 `_user_friendly_login_error()`：將「Token 狀態無效: confirmed」等技術錯誤映射為 `login_already_done` / `login_error_generic` 的本地化短句；所有發送 `login_failed` 的入口均改為使用友好化後的文案。 |
| **i18n 新增鍵** | 同上 | 新增 `login_already_done`、`login_error_generic`（繁中/简中/英），供錯誤映射與未來「已登入」專用提示使用。 |

### 7.2 在方案基礎上的再優化

1. **錯誤分支全面白名單化**  
   方案建議「錯誤文案經本地化/白名單」，實施時改為**集中映射**：所有來自後端的錯誤在展示前經 `_user_friendly_login_error()` 處理，避免任何路徑遺漏技術用語（含 confirm 回調、自動確認、GET 後 400 等）。

2. **非 PENDING 狀態細分**  
   方案僅要求「已確認冪等」，實施時一併區分 `expired` / `cancelled`，返回明確、可操作的短句，減少「登錄請求無效」等籠統說法。

3. **成功消息一條說清**  
   方案 P2 有「可選：減少重複打擾」。實施時將「歡迎詞 + 功能簡介」直接合入**一條** `login_success` 消息（成功 + 跳轉 + 歡迎 + 三點功能），避免再發第二條歡迎造成刷屏，同時滿足「登錄成功後加簡短歡迎與功能介紹」的需求。

4. **日誌語義**  
   `confirm_token` 在已確認時打 `Login token already confirmed (idempotent): ...`，便於與真實錯誤區分，利於監控與排查。

### 7.3 未改動部分（與方案一致）

- GET 查詢狀態為 `confirmed` 時，Bot 已發送成功消息並 return，不發確認按鈕（原有邏輯保留）。  
- 未新增 GET 接口的 `already_logged_in` 欄位（P2 可選）。  
- /help 未擴寫「若已登入可忽略重複提示」（P2 可選）。

---

## 八、下一階段建議（實施與改進）

### 8.1 建議實施項

| 優先級 | 項 | 說明 |
|--------|----|------|
| **P1** | **回歸與真機驗證** | 覆蓋：掃碼/Deep Link 首次登入 → 成功消息含歡迎與三點功能；同一 token 再次 /start 或再次點「確認」→ 僅一條成功提示、無「登錄失敗」；過期/取消 token → 顯示友好錯誤、無技術用語。 |
| **P1** | **/help 補充一句** | 在現有幫助中加一句（三語）：若您已在網頁完成登入，Bot 會提示登錄成功，無需重複點擊。 |
| **P2** | **GET 返回 already_logged_in（可選）** | 若需前端/Bot 區分「首次確認」與「已登入再次打開」，可在 GET login-token 的 `data` 中增加 `already_logged_in: true`，Bot 可據此發「您已登入，無需重複操作」單句（目前重複時已發與首次相同的成功消息，體驗可接受）。 |
| **P2** | **文案審核** | 將當前對外 Bot 文案（成功/失敗/過期/取消/幫助）交產品或運營做一輪審核，統一語氣與品牌表述。 |

### 8.2 可做的改進

- **監控與告警**：對 `confirm_token` 的「已確認冪等」日誌做簡單統計（如按日計數），與真實失敗次數分開，便於觀察重複操作比例與異常。  
- **可訪問性**：若 Bot 消息在無障礙環境中使用，可檢查當前成功/錯誤消息是否足夠簡短、結構清晰（目前為單段文本 + 列表，已相對簡潔）。  
- **A/B 或迭代**：若後續要區分「首次登入」與「已登入」的提示語，可在此基礎上增加 `already_logged_in` 與對應短句，而不影響現有成功流程。
