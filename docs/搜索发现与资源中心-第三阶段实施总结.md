# 搜索发现与资源中心 — 第三阶段实施总结

## 一、本次实施内容（5 大功能）

---

### H1: 搜索结果智能去重 — 多来源合并

**后端** (`handlers_impl.py`)：
- 新增 `_smart_merge_results()` 方法 — 100 行核心算法
- **合并策略**：
  - 主键匹配：`username`（标准化、去 @、小写）
  - 次级匹配：`telegram_id`
  - 合并时取最优数据：最大 member_count、最完整描述、最高评分
  - 可达性取最优：public > invite_only > id_only > unknown
  - 记录所有来源到 `sources[]` 数组
- 位于排序完成后、统计之前执行
- 日志报告合并数量

**前端** (`search-discovery.component.ts`)：
- `DiscoveredResource` 接口新增 `sources?: string[]`
- 列表项和详情弹窗支持多来源合并显示
- 多来源结果显示 `🔗 多源` 和 `🔗 多来源交叉验证` 标签
- `search-results` / `search-batch` 事件数据映射 `sources` 字段

---

### H2: 资源中心标签系统

**SavedResourcesService** (`saved-resources.service.ts`)：
- 新增 `tags?: string[]` 字段
- 标签 CRUD 方法：`addTag()`, `removeTag()`, `getTags()`, `getByTag()`
- 标签持久化到 `localStorage`
- `allTags` 信号 — 自动汇总所有已用标签

**前端 UI** (`search-discovery.component.ts`)：
- 标签编辑器弹窗：
  - 已有标签展示 + 一键删除
  - 自由输入新标签（回车添加）
  - 10 个预设快速标签（区块链、电商、金融、社交、新闻、技术、营销、游戏、NFT、DeFi）
- 资源中心 header 标签筛选栏（仅有标签时显示）
- 列表项上 `🏷️` 标签管理按钮（仅已收藏显示）
- 列表项 metadata 行显示标签 chips
- `filteredResources` 支持按标签过滤

---

### M1: 搜索历史智能推荐

**后端** (`search_history_service.py`)：
- 新增 `get_keyword_suggestions()` — 4 层推荐策略：
  1. **匹配推荐**：与当前输入模糊匹配的历史关键词
  2. **最近搜索**：按时间降序
  3. **高频搜索**：按搜索次数降序
  4. **共现推荐**：搜过 A 的人也搜了 B（基于同帐号 24h 内搜索关联）
- 每条推荐包含 `type`、`freq`、`total_results`

**后端** (`search_handlers_impl.py` + `main.py`)：
- 新增 `handle_get_keyword_suggestions` IPC handler
- 已注册到 handler registry

**前端** (`search-discovery.component.ts`)：
- 搜索输入框 `(input)` 事件绑定 300ms 防抖请求推荐
- 智能推荐下拉面板：
  - 类型标签（相关/热门/最近）
  - 历史结果数量显示
  - 点击推荐词直接搜索
- 与现有"最近搜索"和"热门搜索"区域共存

---

### M2: 资源健康监测

**后端** (`resource_handlers_impl.py` + `main.py`)：
- 新增 `handle_check_resources_health` — 批量验证资源可达性
- 逻辑：对每个资源通过 Telegram API `get_chat()` 验证
- 健康状态枚举：`healthy` / `private` / `deleted` / `banned` / `error` / `no_identifier`
- 限制：最多 50 个，每个 5s 超时，间隔 0.5s 防 FloodWait
- 每 10 个发送进度日志
- 已注册到 handler registry

**前端** (`search-discovery.component.ts`)：
- 资源中心 header 新增 `🏥 健康检查` 按钮
- 检查完毕后：
  - toast 显示统计（健康/异常数量）
  - 自动更新资源的 `accessibility` 和 `member_count`
  - 异常资源标记 `_healthStatus` / `_healthError`

---

### M3: 导出格式增强

**前端** (`search-discovery.component.ts`)：
- `exportResults()` 重写为支持 `csv` / `json` 双格式
- CSV 新增字段：可达性、邀请链接、标签、状态、收藏
- JSON 格式：结构化 JSON，含完整字段
- 导出按钮改为下拉菜单（CSV / JSON 选择）
- 文件名包含关键词和日期

---

## 二、超出原方案的额外优化

| 优化项 | 说明 |
|--------|------|
| 多来源交叉验证标识 | 同时被 Telegram+Jiso 发现的群组显示 `🔗 多源` 标签，增加可信度 |
| 共现推荐算法 | 搜索推荐不只基于历史频率，还基于同帐号 24h 内的搜索关联 |
| 健康检查自动更新数据 | 检查完毕后自动更新成员数和可达性，不只是报告状态 |
| 标签预设与自由输入并存 | 既有预设快速标签，也支持完全自定义标签 |
| 导出含标签和多来源 | 导出数据包含标签和合并来源信息 |

---

## 三、改动文件清单

| 文件 | 类型 | 改动 |
|------|------|------|
| `backend/domain/groups/handlers_impl.py` | 后端 | `_smart_merge_results` 智能去重 |
| `backend/search_history_service.py` | 后端 | `get_keyword_suggestions` 推荐算法 |
| `backend/domain/search/search_handlers_impl.py` | 后端 | 新增 `handle_get_keyword_suggestions` |
| `backend/domain/search/resource_handlers_impl.py` | 后端 | 新增 `handle_check_resources_health` |
| `backend/main.py` | 后端 | 注册 2 个新 handler |
| `src/search-discovery/search-discovery.component.ts` | 前端 | 标签/推荐/健康/导出/去重 UI |
| `src/services/saved-resources.service.ts` | 前端 | 标签管理系统 |

---

## 四、第四阶段建议

### 高优先级

| 功能 | 说明 |
|------|------|
| **搜索结果持久化浏览** | 搜索结果自动保存到后端，支持跨会话浏览历史搜索结果 |
| **标签系统后端持久化** | 当前标签存 localStorage，需迁移到后端 discovered_resources 表 |
| **群组画像增强** | 基于成员增长趋势、活跃度等维度为群组生成画像评分 |

### 中优先级

| 功能 | 说明 |
|------|------|
| 定时健康检查 | 每日自动检查收藏资源健康，异常自动标记 |
| 搜索结果对比 | 同关键词不同时间段搜索结果的 diff 对比 |
| 标签统计分析 | 按标签统计加入率、成员数分布等 |
| 智能标签建议 | 基于群组描述/关键词自动推荐标签 |

### 低优先级

| 功能 | 说明 |
|------|------|
| 搜索满意度追踪 | 搜索后行为埋点（点击率、加入率、收藏率） |
| 协作分享 | 将收藏列表导出为可分享的链接 |
| 自定义导出模板 | 用户可配置导出字段和格式 |

### 技术债务

| 项目 | 说明 |
|------|------|
| `_smart_merge_results` 性能优化 | 当前 O(n) 单遍合并，大数据量时考虑分块 |
| 健康检查并发 | 当前串行检查，可改为有限并发（semaphore=3） |
| 搜索推荐缓存 | 推荐结果可加前端短期缓存减少 IPC 频率 |
