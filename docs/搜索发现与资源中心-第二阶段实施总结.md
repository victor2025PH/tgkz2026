# 搜索发现与资源中心 — 第二阶段实施总结

## 一、本次实施内容

### H1: 加入失败精确错误处理（前端+后端）

**后端改进** (`config_exec_mixin.py`)：
- `_get_friendly_join_error` 方法增强为 **带 error_code 的结构化错误映射**
- 新增 8 种错误类型：`INVITE_PENDING`（等待审核）、`ADMIN_REQUIRED`、`TOO_MANY_CHANNELS`、`GROUP_FULL`、`USER_BANNED` 等
- 所有错误返回格式：`[ERROR_CODE] 友好提示文本`

**后端改进** (`handlers_impl.py`)：
- `join-and-monitor-complete` 失败事件中新增 `error_code` 字段
- 同时返回 `resourceId`/`username`/`telegramId` 便于前端精确匹配

**前端改进** (`search-discovery.component.ts`)：
- 新增 `showJoinError(errorCode, errorMsg)` 方法
- 根据不同 error_code 显示对应的 toast 类型：
  - `INVITE_PENDING` → info（已发送申请，等待审核）
  - `USER_BANNED` → error（建议换帐号）
  - `FLOOD_WAIT` → warning（系统自动重试）
  - `CHANNEL_PRIVATE` → warning（需要邀请链接）

---

### H2: Jiso 结果预验证 + 可达性标记

**后端改进** (`handlers_impl.py`)：
1. **accessibility 标记**：搜索结果返回前，根据数据自动标记每个结果：
   - `public`：有 username
   - `invite_only`：有邀请链接（`/+` 或 `joinchat`）
   - `id_only`：只有 telegram_id
   - `unknown`：信息不完整

2. **轻量 ResolveUsername 验证**：
   - 对 Jiso 来源中有 username 的结果，取第一个可用 Telegram client
   - 批量调用 `get_chat(username)` 验证（限时 3s/个，最多 20 个）
   - 验证成功：自动补全真实 telegram_id 和 member_count
   - 验证失败：标记 `accessibility: 'unknown'`
   - 日志输出验证统计

---

### M1: 搜索结果缓存

**后端改进** (`handlers_impl.py`)：
- 模块级 `_search_cache` 字典，key 为 `keyword|source1|source2`
- TTL = 300 秒（5 分钟）
- 缓存命中时直接返回，跳过所有搜索逻辑
- 支持 `force_refresh` 参数强制刷新
- 自动清理过期缓存，防止内存泄漏

**前端改进** (`search-discovery.component.ts`)：
- 新增 `forceRefreshSearch()` 方法和 `🔄 强制刷新` 按钮
- 搜索结果 2 秒内返回自动识别为缓存命中
- UI 显示 `📋 缓存` 标签
- toast 提示区分缓存/实时结果

---

### M2: 资源中心批量操作增强

**前端改进** (`search-discovery.component.ts`)：
- 资源中心模式下新增 `📤 导出` 和 `🗑️ 清空收藏` 按钮
- 批量选择面板新增 `🗑️ 取消收藏` 按钮（仅资源中心模式显示）
- `batchUnsaveSelected()`：取消选中项的收藏
- `batchUnsaveAll()`：清空全部收藏（带 confirm 确认）

---

### M3: 资源中心后端 API 持久化

**前端改进** (`saved-resources.service.ts` 全面重写)：
- **双层持久化架构**：
  - Layer 1: localStorage（快速首屏渲染、离线备份）
  - Layer 2: 后端 IPC API（`save-resource`、`unsave-resource`、`get-resources`）
- **首次加载流程**：先 localStorage → 再异步加载后端 → 智能合并
- **合并策略**：后端为主，本地独有项自动同步到后端
- 新增 `removeAll()`、`refresh()` 方法
- 新增 `backendSynced`、`syncing` 状态信号

---

## 二、超出原始方案的额外优化

| 优化项 | 说明 |
|--------|------|
| 缓存命中指示器 | 搜索结果区显示 `📋 缓存` 标签，用户可见 |
| 强制刷新按钮 | 一键忽略缓存重新搜索 |
| error_code 结构化传递 | 前后端通过 code 精确区分错误类型，而非文本匹配 |
| 验证成功自动补全数据 | Jiso 验证通过的群组自动补全真实 ID 和成员数 |
| 本地→后端自动同步 | 本地独有的收藏自动同步到后端，避免数据丢失 |

---

## 三、改动文件清单

| 文件 | 类型 | 改动范围 |
|------|------|----------|
| `backend/service/config_exec_mixin.py` | 后端 | `_get_friendly_join_error` 增强 |
| `backend/domain/groups/handlers_impl.py` | 后端 | 缓存逻辑 + Jiso 验证 + error_code |
| `src/search-discovery/search-discovery.component.ts` | 前端 | 缓存 UI + 错误处理 + 批量操作 |
| `src/services/saved-resources.service.ts` | 前端 | 全面重写为双层持久化 |

---

## 四、下一阶段建议

### 第三阶段优先级

| 优先级 | 功能 | 说明 |
|--------|------|------|
| **高** | 搜索结果智能去重 | 同一群组不同来源的结果智能合并（基于 username 或 telegram_id） |
| **高** | 资源中心分类/标签系统 | 用户可给收藏打标签（如"区块链"、"电商"），支持按标签筛选 |
| **中** | 搜索历史智能推荐 | 基于历史搜索词推荐相关关键词 |
| **中** | 资源健康监测 | 定期检查已收藏资源是否仍然有效（群组是否被封等） |
| **中** | 搜索结果导出增强 | 支持导出 Excel/JSON 格式，含群组详情和可达性标记 |
| **低** | 搜索满意度埋点 | 用户搜索后的行为追踪（点击率、加入率） |
| **低** | Onboarding Tour | 首次使用时的引导流程 |

### 技术债务

| 项目 | 说明 |
|------|------|
| 缓存策略优化 | 当前是简单 TTL，可升级为 LRU + 分级缓存 |
| 错误重试机制 | 对 TIMEOUT/FLOOD_WAIT 错误自动重试 |
| 后端 API 规范化 | 统一 save-resource/unsave-resource 的返回格式 |
