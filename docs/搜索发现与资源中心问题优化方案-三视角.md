# 搜索发现与资源中心问题优化方案（三视角）

## 一、问题清单

用户反馈了以下几个关联问题，逐一分析并给出优化方案。

| # | 问题 | 现象 | 截图对应 |
|---|------|------|----------|
| P1 | 资源中心没有数据 | 资源中心首屏显示「还没有收藏资源」，新用户不知道怎么才能有数据 | 截图 1 |
| P2 | 搜索时弹出「请求超时（15秒）」提示 | 搜索关键词后右上角弹出超时警告，但实际搜索仍在后台继续 | 截图 2 |
| P3 | 搜索进度不透明 | 用户看到「搜索中…」但不知道搜到了哪些渠道、进度如何 | 截图 2 |
| P4 | 群组详情无 Telegram ID、无公开连结 | 群组详情弹窗显示 Telegram ID「需加入获取」、无公开连结 | 截图 3 |
| P5 | 无 ID 无连结的群组无法加入 | 点「加入群组」时因缺少 username 和 telegram_id 被拦截，提示「无法加入：缺少群组标识」 | 截图 3 |
| P6 | 无效/不可达群组仍出现在搜索结果中 | 搜索到的群组既不能查看详情也不能加入，但仍然展示在列表中 | 截图 2+3 |

---

## 二、原因分析

### P1：资源中心没有数据

- **根因**：资源中心展示的是「已收藏」资源（`SavedResourcesService` + localStorage），新用户从未在搜索发现中收藏过任何群组，因此列表为空。
- **设计缺陷**：空状态只有一句「还没有收藏资源」和一个跳转按钮，缺乏对新用户的引导——不知道「收藏」是什么概念、从哪里收藏、为什么要来资源中心。

### P2：搜索弹出「请求超时（15秒）」

- **根因**：前端心跳机制（`startHeartbeatCheck`）每 5 秒检查一次，如果超过 `HEARTBEAT_TIMEOUT_MS`（当前约 15 秒）未收到 `search-batch` 或 `search-progress` 事件，就会触发 `handleSearchTimeout()`，弹出「搜索超时，请稍后重试」的 toast。
- **实际情况**：后端多渠道搜索是异步并行的——Telegram 官方搜索超时 30 秒、Jiso 中文搜索超时 90 秒。某些渠道响应慢时，前端 15 秒内未收到进度就判定超时，但后端仍在搜索中，后续结果还会陆续返回。
- **误导**：用户看到「超时」以为搜索失败了，实际上只是某个渠道尚未返回结果。

### P3：搜索进度不透明

- **根因**：前端只展示一个笼统的「🔄 搜索中…」和一行进度文字（如「官方搜索找到 N 个结果，正在继续搜索…」），没有分渠道的进度条或状态指示器。用户无法判断哪些渠道已完成、哪些还在搜索、总共还需要多久。
- **后端支持不足**：后端通过 `search-batch` 发送批量结果，但没有统一的「每个渠道状态」事件（如「Telegram 已完成」「Jiso 搜索中」「TGStat 未启用」）。

### P4 + P5：群组无 Telegram ID、无公开连结、无法加入

- **根因**：Jiso（中文搜索引擎）返回的群组数据中，`telegram_id` 可为 `null`，`username` 可为空，`link` 可能是 invite link（如 `https://t.me/+hash`）或为空。
- **前端数据映射问题**：后端返回的 `link` 字段没有正确映射到前端 `DiscoveredResource` 的 `invite_link` 字段。
- **加入逻辑缺陷**：`openJoinDialog()` 和 `executeJoin()` 仅检查 `username` 和 `telegram_id`，不考虑 `invite_link`。即使群组有合法的邀请链接，也无法用来加入。
- **后端 `handle_join_resource`**：构建 `group_url` 时只用 `username` 或 `telegram_id`，不接受 `invite_link`。但底层的 `telegram_client.join_group()` 实际上支持 invite link（如 `+hash` 或 `joinchat/hash`）。

### P6：无效/不可达群组仍展示

- **根因**：后端搜索各渠道时没有对结果做「可达性/有效性」验证，所有返回的结果都原样发给前端。
- **Jiso 数据质量**：Jiso 是第三方索引，其收录的群组可能已被删除、设为私有、或仅有邀请链接入口，但 Jiso 仍保留其索引记录。
- **前端无过滤**：默认展示全部结果，虽然有 `filterHasId` 筛选项但默认未开启，且用户不知道这个筛选器的用途。

---

## 三、开发工程师视角

### 3.1 P1 — 资源中心空状态优化

| 方向 | 建议 | 说明 |
|------|------|------|
| 空状态丰富化 | 空状态不只是一句话+按钮，应包含：① 图文引导（3 步流程：搜索→收藏→管理）；② 快捷搜索入口（内嵌轻量搜索框或热门关键词）；③ 示例/推荐资源（如果有公共推荐库） | 降低用户「不知道怎么用」的门槛 |
| 首次使用引导 | 新用户首次进入资源中心时，弹出引导气泡或步骤向导（Onboarding Tour）：「第一步：去搜索发现搜索群组 → 第二步：点击收藏 → 第三步：回到资源中心管理」 | 只在首次进入时展示，localStorage 记录已引导 |
| 自动预填 | 若用户在搜索发现已有搜索历史但未收藏，资源中心空状态可提示「您最近搜索了 XX，去收藏看看？」 | 用搜索历史降低冷启动成本 |

### 3.2 P2 — 超时提示改为真实进度

| 方向 | 建议 | 说明 |
|------|------|------|
| 取消「超时」toast | 删除或大幅放宽 `HEARTBEAT_TIMEOUT_MS`（建议 ≥ 90 秒，与 Jiso 超时对齐）；不再弹出「搜索超时」警告 | 当前 15 秒太短，多渠道搜索正常就需要 30-90 秒 |
| 改为渠道级状态 | 后端每个渠道搜索开始和完成时发送事件（如 `search-source-status: { source: 'telegram', status: 'completed', count: 5 }`），前端据此展示每个渠道的实时状态 | 用户看到的是「Telegram ✅ 5 个、中文搜索 🔄 搜索中、TGStat ⏸ 未启用」而不是「搜索中…」 |
| 心跳改为进度检查 | 心跳不再触发「超时」，而是检查「是否有新进度」；若所有渠道均已返回结果或超时，自动结束搜索状态 | 避免误报超时 |
| 长时间无进度的友好提示 | 若某渠道超过 30 秒未返回，展示「XX 渠道响应较慢，请耐心等待…」而非「超时」 | 降低用户焦虑，不打断搜索流程 |

### 3.3 P3 — 搜索进度透明化

| 方向 | 建议 | 说明 |
|------|------|------|
| 多渠道进度条 | 在搜索结果区顶部增加渠道进度条组件：每个启用的渠道一行（或一个 chip），展示状态（等待中/搜索中/已完成 N 个/失败） | 让用户清楚知道每个渠道的情况 |
| 后端事件标准化 | 统一事件格式：`search-progress: { source, status, found_count, elapsed_ms }`；在每个渠道开始、获得结果、完成、失败时各发一次 | 前端据此驱动进度 UI |
| 总进度计算 | 前端根据「已完成渠道数 / 总渠道数」计算总进度百分比，展示在顶部进度条 | 给用户一个全局预期 |
| 渐进式结果展示 | 每收到一批 `search-batch` 就即时追加到列表，而非等所有渠道完成 | 当前已做，可加强——在结果区标注「来自 XX 渠道」的标签 |

### 3.4 P4 + P5 — 支持 invite_link 加入

| 方向 | 建议 | 说明 |
|------|------|------|
| 数据映射修复 | 后端 Jiso 搜索结果中 `link` 字段正确映射为 `invite_link`（或同时保留 `link` 和 `invite_link`）；前端 `DiscoveredResource` 接口增加 `link` 字段并与 `invite_link` 统一 | 确保邀请链接不丢失 |
| 加入逻辑扩展 | `openJoinDialog()` 和 `executeJoin()` 的判断条件改为：`username || telegram_id || invite_link`；前端发送 `join-resource` 时增加 `invite_link` 字段 | 支持三种方式加入 |
| 后端支持 invite_link | `handle_join_resource` 在构建 `group_url` 时：优先用 `username`（公开群组），其次用 `invite_link`（私有群组），最后用 `telegram_id` | 底层 `telegram_client.join_group()` 已支持 invite link 格式 |
| 详情弹窗优化 | Telegram ID 显示为「需加入获取」时，改为更明确的文案：「加入后自动获取」或「私有群组（仅可通过邀请链接加入）」；若有 invite_link，显示「有邀请链接，可加入」 | 减少用户困惑 |

### 3.5 P6 — 搜索结果有效性过滤

| 方向 | 建议 | 说明 |
|------|------|------|
| 可达性标记 | 每条搜索结果增加 `accessibility` 字段：`public`（有 username）、`invite_only`（有 invite_link 无 username）、`unknown`（既无 username 也无 invite_link 也无 telegram_id） | 前端据此展示不同样式和可操作性 |
| 默认过滤策略 | 默认隐藏 `accessibility: unknown` 的结果（三项标识都没有的群组）；或将其放到列表末尾并置灰标注「该群组信息不完整，可能无法加入」 | 避免用户看到大量「不可操作」的结果 |
| 后端预验证（可选） | 对 Jiso 返回的结果，用 Telegram API 做轻量验证（如 `ResolveUsername`），标记不可达的群组为 `invalid` | 增加延迟但提高结果质量；可作为可选高级筛选 |
| 前端筛选增强 | 增加「仅显示可加入」筛选项（默认开启），过滤掉缺少所有标识的群组 | 用户也可关闭此筛选以查看全部原始结果 |
| 「不可加入」标记 | 对无法加入的群组，在卡片和详情弹窗上明确标注「信息不完整，暂无法加入」，加入按钮置灰并给 tooltip 说明原因 | 比弹 toast「无法加入：缺少群组标识」更友好 |

---

## 四、市场经理视角

### 4.1 P1 — 资源中心冷启动与价值感知

| 方向 | 建议 | 说明 |
|------|------|------|
| 空状态不等于无价值 | 资源中心空状态应传达「这里是你的资源资产库，收藏后统一管理」的价值，而不仅仅是「没有数据」 | 用户第一次进入时就应理解这个页面的核心作用 |
| 新手引导话术 | 「3 步开始管理资源：① 去搜索发现找群组 → ② 收藏你感兴趣的 → ③ 在这里统一管理、批量操作」 | 降低认知门槛，形成操作闭环 |
| 推荐/热门资源 | 若平台有公共群组推荐库或热门关键词，可在空状态区域展示「推荐群组」或「热门搜索词」，一键搜索 | 给新用户一个起点，减少「不知道搜什么」的卡顿 |
| 首次收藏庆祝 | 用户第一次从搜索发现收藏群组后，资源中心弹出「恭喜，你的第一个资源已入库！」的引导 | 强化「收藏→资源中心」的动线认知 |

### 4.2 P2 + P3 — 搜索体验与信任感

| 方向 | 建议 | 说明 |
|------|------|------|
| 绝对避免「超时/失败」类负面提示 | 搜索是核心功能，任何「超时」「失败」「错误」的提示都会打击用户信心；应改为积极正向的进度反馈 | 「正在从 4 个渠道搜索中…」比「请求超时」好 100 倍 |
| 多渠道是差异化卖点 | 「同时从 Telegram 官方、中文搜索、TGStat、本地索引 4 大渠道搜索」——这是产品优势，应在搜索进度 UI 中凸显 | 让用户感受到平台的搜索能力和覆盖面 |
| 渐进式满足 | 先展示已返回的结果（如 Telegram 官方秒级返回），让用户先看先操作；其他渠道结果陆续追加 | 用户不会干等，体验更流畅 |
| 搜索耗时合理化 | 在 UI 中说明「搜索最多需要 1-2 分钟以覆盖所有渠道」，让用户有合理预期 | 避免用户以为「超过 10 秒就是坏了」 |

### 4.3 P4 + P5 + P6 — 搜索结果质量与信任

| 方向 | 建议 | 说明 |
|------|------|------|
| 搜索结果 = 产品口碑 | 搜索出「不能用」的群组，用户会质疑平台数据质量和产品可靠性 | 宁可少展示，不可展示无法操作的废数据 |
| 结果分层展示 | 「可直接加入」的排前面、高亮；「需邀请链接加入」的其次；「信息不完整」的折叠或隐藏 | 让用户优先看到最有价值、最可操作的结果 |
| 数据来源标注 | 每条结果标注来源（如「官方搜索」「中文搜索」「本地索引」），让用户理解不同来源的数据质量差异 | 中文搜索（Jiso）的数据可能不如官方精准，标注来源是管理预期的有效手段 |
| 竞品对比优势 | 即使有些群组信息不全，平台仍能搜索到——这本身是能力的体现；关键是要**标注清楚**而非让用户自己碰壁 | 「信息不完整（来自第三方索引）」比什么都不说要好 |

### 4.4 运营与反馈闭环

| 方向 | 建议 | 说明 |
|------|------|------|
| 搜索无结果/低质量结果反馈 | 提供「反馈：搜索结果不准确」入口，收集用户反馈用于优化搜索算法和数据源 | 持续改进搜索质量 |
| 搜索满意度埋点 | 统计：搜索→收藏转化率、搜索→加入转化率、「无法加入」的出现频次 | 用数据驱动优化优先级 |
| 帮助文档/FAQ | 「为什么有些群组无法加入？」「什么是邀请链接？」——常见问题主动回答 | 减少客服压力，提升用户自助能力 |

---

## 五、用户视角

### 5.1 P1 — 「资源中心一片空白，不知道怎么用」

| 用户期望 | 优化建议 | 说明 |
|----------|----------|------|
| 进入资源中心就能看到有用的东西 | 空状态给出清晰的引导流程图，而不只是「没有数据」 | 用户不应该需要猜测如何使用 |
| 知道「收藏」从哪里来 | 空状态明确说「在搜索发现中搜索并点击⭐收藏，资源就会出现在这里」 | 建立「搜索发现→收藏→资源中心」的心智模型 |
| 不想在两个页面切来切去 | 资源中心提供「快速添加」入口（内嵌搜索或一键跳转） | 减少页面跳转成本 |

### 5.2 P2 + P3 — 「搜索说超时了，到底搜没搜到？」

| 用户期望 | 优化建议 | 说明 |
|----------|----------|------|
| 搜索时知道在干嘛 | 展示每个渠道的搜索状态（✅ 完成 / 🔄 搜索中 / ❌ 失败），而不是只有「搜索中…」 | 透明的进度给用户安全感 |
| 不要吓我说「超时」 | 不弹「超时」或「失败」类提示；如果某个渠道确实失败了，在渠道状态上标注即可，不影响其他渠道结果 | 「超时」会让用户以为整个搜索都失败了 |
| 先看到已有结果 | 第一个渠道返回结果就开始展示，不用等所有渠道 | 当前已部分实现（search-batch），但超时 toast 打断了体验 |
| 知道还要等多久 | 展示大致进度（如 2/4 渠道已完成）或「预计还需 XX 秒」 | 给用户明确预期 |

### 5.3 P4 + P5 — 「搜到了群组但加入不了」

| 用户期望 | 优化建议 | 说明 |
|----------|----------|------|
| 搜到的群组应该能操作 | 能加入的就显示「加入」按钮；不能加入的要提前告知原因，而不是点了才报错 | 减少无效操作和挫败感 |
| 告诉我为什么不能加入 | 明确标注：「私有群组，需邀请链接」「群组信息不完整」等 | 比「无法加入：缺少群组标识」更易理解 |
| 如果有邀请链接就让我用 | 若群组有 invite_link，用它来加入；不要因为没有 username 就拒绝 | 很多私有群组只有邀请链接 |
| 无效的就别展示 | 如果一个群组既没有 ID、没有用户名、也没有邀请链接，完全不可操作——不要展示出来浪费我的时间 | 展示不可操作的结果是对用户的干扰 |

### 5.4 P6 — 「搜索结果质量差」

| 用户期望 | 优化建议 | 说明 |
|----------|----------|------|
| 搜到的都是有用的 | 默认过滤掉完全不可操作的群组；可加入的排在前面 | 优先展示高质量、可操作的结果 |
| 知道来源和可信度 | 每条结果标注来源渠道（官方/中文/TGStat/本地） | 用户可以据此判断数据可信度 |
| 能自己筛选 | 提供「仅显示可加入」的筛选开关（默认开启） | 需要看全部结果的高级用户可以关闭 |

---

## 六、方案汇总与优先级

### 第一优先级（P0 — 立即修复，影响核心体验）

| # | 问题 | 方案 | 工作量 |
|---|------|------|--------|
| 1 | 搜索弹出「超时」误导 | 删除或大幅放宽心跳超时阈值（≥ 90s）；移除 `handleSearchTimeout` 中的 toast；改为在渠道进度上标注「响应较慢」 | 小 |
| 2 | 加入不支持 invite_link | 前端 `joinResource` 增加 `invite_link` 字段传递；后端 `handle_join_resource` 支持 invite_link 作为 `group_url`；数据映射 `link → invite_link` | 中 |
| 3 | 不可操作群组展示在列表 | 默认隐藏三项标识（username / telegram_id / invite_link）全部为空的结果；或在卡片上置灰标注不可操作 | 小 |

### 第二优先级（P1 — 尽快优化，提升体验质量）

| # | 问题 | 方案 | 工作量 |
|---|------|------|--------|
| 4 | 搜索进度不透明 | 后端发送渠道级进度事件；前端增加多渠道进度 UI 组件（chip 或进度条） | 中 |
| 5 | 群组详情文案不清 | 「需加入获取」改为「私有群组（加入后自动获取）」或「信息来自第三方索引」 | 小 |
| 6 | 搜索结果分层排序 | 按可达性排序：public > invite_only > unknown；增加「仅显示可加入」筛选 | 中 |

### 第三优先级（P2 — 体验增强，提升用户引导）

| # | 问题 | 方案 | 工作量 |
|---|------|------|--------|
| 7 | 资源中心空状态单薄 | 丰富空状态：流程引导图、快捷搜索入口、最近搜索提示 | 中 |
| 8 | 新用户首次引导 | Onboarding Tour 或引导气泡，首次进入时展示 | 中 |
| 9 | 数据来源标注 | 每条搜索结果显示来源 chip（官方 / 中文 / TGStat / 本地） | 小 |
| 10 | 搜索满意度与反馈 | 增加「搜索结果不准确？反馈给我们」入口；埋点统计搜索→加入转化率 | 小 |

---

## 七、技术方案要点（不含代码）

### 7.1 超时机制改造

```
当前流程：
搜索开始 → 心跳每 5s 检查 → 15s 无进度 → toast「超时」→ 结束搜索状态

改造后流程：
搜索开始 → 后端按渠道发送 search-source-status 事件
          → 前端按渠道更新状态 UI（✅/🔄/⚠️）
          → 所有渠道完成或超时 → 结束搜索状态
          → 若某渠道超过 30s 无响应 → 该渠道标注「响应较慢」（不弹 toast）
          → 若所有渠道均超时 → 展示「搜索未返回结果，请重试」（内联提示，非 toast）
```

### 7.2 invite_link 支持链路

```
当前链路：
搜索结果 → {username, telegram_id} → join-resource → handle_join_resource → group_url(username 或 telegram_id)

改造后链路：
搜索结果 → {username, telegram_id, invite_link} → join-resource → handle_join_resource
  → 优先用 username (https://t.me/xxx)
  → 其次用 invite_link (https://t.me/+hash)
  → 最后用 telegram_id (数字 ID)
  → telegram_client.join_group(group_url)
```

### 7.3 搜索结果可达性分层

```
分层规则：
- public：有 username → 可直接加入，绿色标记
- invite_only：无 username 但有 invite_link → 可通过邀请链接加入，蓝色标记
- id_only：无 username 无 invite_link 但有 telegram_id → 可能可加入（取决于群组类型），黄色标记
- unknown：三项全无 → 不可操作，灰色标记或默认隐藏

默认排序：public → invite_only → id_only → unknown
默认筛选：隐藏 unknown
```

### 7.4 后端搜索事件标准化

```
事件类型           触发时机                          payload
search-start      搜索开始                          { keyword, sources: [...] }
search-source-status  每个渠道状态变化时              { source, status: 'searching'|'completed'|'failed'|'timeout', count, elapsed_ms }
search-batch      每批结果返回时                     { source, results: [...], total_so_far }
search-complete   所有渠道结束                       { total_count, by_source: {...} }
```

---

## 八、预期效果

| 问题 | 改造前 | 改造后 |
|------|--------|--------|
| 资源中心空状态 | 一句话 + 跳转按钮，新用户茫然 | 流程引导 + 快捷入口，新用户知道怎么用 |
| 搜索超时提示 | 弹出「搜索超时」toast，误以为失败 | 渠道级进度展示，无误导性 toast |
| 搜索进度 | 「搜索中…」一行文字 | 多渠道状态（✅🔄⚠️），总进度百分比 |
| 无 ID 群组加入 | 「无法加入：缺少群组标识」 | 用 invite_link 加入，或明确标注原因 |
| 无效群组展示 | 展示在列表，点了才知道不能操作 | 默认隐藏或置灰标注，减少无效操作 |

---

## 九、风险与注意事项

| 风险 | 缓解 |
|------|------|
| 放宽超时后搜索状态长时间不结束 | 后端为每个渠道设硬性超时（Telegram 30s、Jiso 90s），并在超时后发送 `status: 'timeout'`；前端收到所有渠道终态后自动结束 |
| invite_link 过期或无效导致加入失败 | 加入失败时捕获异常，提示「邀请链接已过期或无效」，而非通用错误 |
| 隐藏 unknown 结果导致用户觉得「搜不到东西」 | 在列表底部展示「还有 N 个信息不完整的结果」折叠区域，可展开查看 |
| Jiso 数据质量不稳定 | 长期可考虑对 Jiso 结果做后端缓存验证（定期重新检查群组有效性），短期先做前端分层标注 |

---

*文档版本：v1.0*
*日期：2025-02-12*
