# 智能引擎 / 知识大脑 / AI 中心 — 导航与结构优化方案（详细版）

## 一、现状分析（详尽）

### 1.1 当前架构总览

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 侧边栏 (app.component.html)                                                              │
│ ┌─ AI 智能 ───────────────────────────────────────────────────────────────────────────┐ │
│ │  ├─ 知识大脑 (可展开) ──→ changeView('knowledge-brain'|'knowledge-manage'|'knowledge-gaps') │
│ │  │    ├─ 总览    ──→ /ai-engine/overview                                               │ │
│ │  │    ├─ 知识管理 ──→ /ai-engine/knowledge                                              │ │
│ │  │    └─ 知识缺口 ──→ /ai-engine/gaps                                                   │ │
│ │  └─ AI 中心 ──→ changeView('ai-center') ──→ /ai-engine                                │ │
│ └──────────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 内容区 (AiCenterViewComponent → AICenterComponent)                                       │
│ 路由: /ai-engine | /ai-engine/overview | /ai-engine/knowledge | /ai-engine/gaps         │
│ 标题: 智能引擎設置                                                                        │
│ ┌─ 一级 Tab ──────────────────────────────────────────────────────────────────────────┐ │
│ │  引擎概覽 | 模型配置 | 人格風格 | 知识大脑 | 使用統計                                    │ │
│ └──────────────────────────────────────────────────────────────────────────────────────┘ │
│ 当「知识大脑」Tab 激活时：                                                                │
│ ┌─ 二级 Tab ──────────────────────────────────────────────────────────────────────────┐ │
│ │  总览 | 知识管理 | 知识缺口                                                             │ │
│ └──────────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 涉及文件与数据流

| 区域 | 文件路径 | 职责 |
|------|----------|------|
| 侧栏结构 | `src/app.component.html` L774–831 | 渲染「知识大脑」可展开菜单、「AI 中心」菜单项 |
| 侧栏逻辑 | `src/app.component.ts` L1888–1896, L1893–1896 | `toggleKnowledgeMenu`, `isKnowledgeView`, `knowledgeMenuExpanded` |
| 路由定义 | `src/app.routes.ts` L189–218, L318–326 | 路由路径、`VIEW_ROUTE_MAP`（view → route） |
| 路由→视图反查 | `src/app.component.ts` L2556–2568 | `NavigationEnd` 时用 `VIEW_ROUTE_MAP` 反查 url→view，同步 `currentView` |
| 视图组件 | `src/views/ai-center-view.component.ts` | 根据 `route.data.enginePanel` 设置 `initialTab` / `initialKnowledgeSub` |
| 主内容 | `src/ai-center/ai-center.component.ts` L939–996, L1159–1166, L2145–2177 | 一级/二级 Tab、`VIEW_TAB_MAP`、effect 同步路由 |
| 导航桥接 | `src/services/nav-bridge.service.ts` L21–22, L121–122 | `LegacyView` 类型、`isValidLegacyView` 白名单 |
| 国际化 | `src/assets/i18n/*.json` | `menu.knowledgeBrain`, `menu.overview`, `menu.knowledgeManagement`, `menu.knowledgeGaps`, `aiCenter`, `aiIntelligence` |

### 1.3 当前路由与视图映射

| 侧栏点击 | changeView 参数 | 路由 | route.data.enginePanel | 一级 Tab | 二级 Tab |
|----------|-----------------|------|------------------------|----------|----------|
| 知识大脑 > 总览 | knowledge-brain | /ai-engine/overview | overview | knowledge | overview |
| 知识大脑 > 知识管理 | knowledge-manage | /ai-engine/knowledge | knowledge | knowledge | manage |
| 知识大脑 > 知识缺口 | knowledge-gaps | /ai-engine/gaps | gaps | knowledge | gaps |
| AI 中心 | ai-center | /ai-engine | default | quick | - |

### 1.4 问题根因归纳

1. **双重入口**：侧栏「知识大脑」与「AI 中心」为两个入口，但都进入同一页面 `/ai-engine`，仅 Tab 不同。
2. **子项重复**：总览/知识管理/知识缺口 同时出现在侧栏（知识大脑子项）和内容区（知识大脑 Tab 的子 Tab）。
3. **高亮分散**：`/ai-engine/overview` 等路由反查得到 `knowledge-brain`，侧栏高亮「知识大脑」；`/ai-engine` 反查得到 `ai-center`，高亮「AI 中心」，造成「同一页面、两个高亮项」的错觉。
4. **命名混用**：侧栏用「AI 中心」，页面标题用「智能引擎設置」，对外话术不统一。

---

## 二、目标结构（优化后）

### 2.1 侧栏结构（目标）

```
┌─ AI 智能 ───────────────────────────────────────────────────┐
│  └─ 智能引擎 (单一项，无子菜单)                                │
│      → changeView('ai-engine') → /ai-engine                  │
│      → 任意 /ai-engine/* 均高亮此项                            │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 内容区结构（保持不变）

```
┌─ 智能引擎設置 ──────────────────────────────────────────────┐
│ 一级 Tab: 引擎概覽 | 模型配置 | 人格風格 | 知识大脑 | 使用統計  │
│ 知识大脑 激活时: 总览 | 知识管理 | 知识缺口                    │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 访问路径（优化后）

| 用户操作 | 路径 |
|----------|------|
| 从侧栏进入智能引擎 | 点击「智能引擎」→ `/ai-engine`（默认 Tab：引擎概覽） |
| 进入知识大脑总览 | 侧栏进智能引擎 → 点击「知识大脑」Tab → 点击「总览」子 Tab；或直接访问 `/ai-engine/overview`（深链） |
| 进入知识管理 | 同上，或直接 `/ai-engine/knowledge` |
| 进入知识缺口 | 同上，或直接 `/ai-engine/gaps` |

---

## 三、分阶段实施计划

### 阶段 0：准备（预研与依赖）

| 序号 | 任务 | 产出 | 预估 |
|------|------|------|------|
| 0.1 | 梳理所有引用 `knowledge-brain`、`knowledge-manage`、`knowledge-gaps` 的代码位置 | 引用清单 | 0.5h |
| 0.2 | 确认「知识缺口」角标（`ragBrainService.gapsCount()`）的展示位置 | 需迁移至内容区 Tab 或仪表板 | 0.5h |
| 0.3 | 检查快捷鍵、命令面板、仪表板快捷入口等是否跳转到上述 view | 需更新为 `ai-engine` 或保留 `/ai-engine/overview` 等路径 | 0.5h |

### 阶段 1：侧栏简化

| 序号 | 任务 | 具体操作 | 涉及文件 | 验收标准 |
|------|------|----------|----------|----------|
| 1.1 | 移除「知识大脑」及其子项 | 删除 `app.component.html` 中 L774–819 的 `knowledge-menu` 整块（含主项和子项） | `src/app.component.html` | 侧栏「AI 智能」下仅剩一项 |
| 1.2 | 将「AI 中心」改名为「智能引擎」或保留「AI 中心」 | 调整 `t('aiCenter')` 或新增 `t('menu.aiEngine')`，修改模板中的显示文案 | `app.component.html`, `i18n/*.json` | 侧栏显示「智能引擎」或统一命名 |
| 1.3 | 统一点击行为 | 将原「AI 中心」的 `changeView('ai-center')` 改为 `changeView('ai-engine')` | `src/app.component.html` | 点击后导航到 `/ai-engine` |
| 1.4 | 移除 `toggleKnowledgeMenu`、`isKnowledgeView`、`knowledgeMenuExpanded` | 删除或简化相关逻辑 | `src/app.component.ts` | 无引用、无报错 |
| 1.5 | 知识缺口角标迁移 | 若角标原在侧栏「知识缺口」旁，迁移至「智能引擎」主项旁或内容区「知识大脑」Tab 旁 | `app.component.html`, `ai-center.component` | 角标仍可见且位置合理 |

### 阶段 2：路由与视图映射

| 序号 | 任务 | 具体操作 | 涉及文件 | 验收标准 |
|------|------|----------|----------|----------|
| 2.1 | 统一高亮逻辑 | 当 URL 为 `/ai-engine` 或 `/ai-engine/*` 时，`currentView` 设置为 `ai-engine`（或 `ai-center`） | `src/app.component.ts` Router 订阅逻辑 | 任意 `/ai-engine/*` 下侧栏仅高亮「智能引擎」 |
| 2.2 | 路由反查逻辑 | 调整 `VIEW_ROUTE_MAP` 反查：对 `/ai-engine`、`/ai-engine/overview`、`/ai-engine/knowledge`、`/ai-engine/gaps` 均返回 `ai-engine` | `app.component.ts` 或引入 `ROUTE_VIEW_MAP` 反向映射 | 刷新、前进/后退后高亮正确 |
| 2.3 | VIEW_ROUTE_MAP 精简 | 保留 `ai-engine`→`/ai-engine`；`knowledge-brain`、`knowledge-manage`、`knowledge-gaps` 可保留用于深链（内部仍可能用到），或改为都映射到 `/ai-engine` 并在路由中处理 | `src/app.routes.ts` | 深链 `/ai-engine/overview` 等仍可访问 |
| 2.4 | changeView 入口清理 | 移除所有对 `knowledge-brain`、`knowledge-manage`、`knowledge-gaps` 的 `changeView` 调用（侧栏已删）；其他入口（如快捷操作）改为 `ai-engine` 或直接 `router.navigate(['/ai-engine/overview'])` | 全局搜索 | 无侧栏调用，其他入口行为正确 |

### 阶段 3：Tab 与 URL 双向同步

| 序号 | 任务 | 具体操作 | 涉及文件 | 验收标准 |
|------|------|----------|----------|----------|
| 3.1 | Tab 切换更新 URL | 在 `ai-center.component` 中，当用户点击一级/二级 Tab 时，调用 `router.navigate` 或 `router.navigateByUrl` 更新 URL（使用 `replaceUrl: true` 避免历史堆积） | `src/ai-center/ai-center.component.ts` | 点击 Tab 后 URL 变化，可刷新保持 |
| 3.2 | URL 变化更新 Tab | 已由 `ai-center-view` 的 `route.data` 和 `initialTab`/`initialKnowledgeSub` 实现，确认 effect 与 ngOnInit 逻辑正确 | `ai-center-view.component`, `ai-center.component` | 直接访问 `/ai-engine/gaps` 时 Tab 正确 |
| 3.3 | 移除 NavBridge 对 knowledge-* 的依赖 | `ai-center` 内部不再依赖 `currentView === 'knowledge-*'` 决定 Tab，仅依赖路由 `enginePanel` | `ai-center.component.ts` | 路由为唯一数据源 |

### 阶段 4：跨模块引用更新

| 序号 | 任务 | 具体操作 | 涉及文件 | 验收标准 |
|------|------|----------|----------|----------|
| 4.1 | 命令面板 / 快捷操作 | 将跳转到「知识大脑」「知识管理」「知识缺口」的入口改为「智能引擎」或具体路径 `/ai-engine/overview` 等 | `command-palette`, `quick-workflow` 等 | 点击后进入正确页面 |
| 4.2 | 仪表板快捷入口 | 检查 `dashboard-view` 等对 `ai-center` 的引用 | `dashboard-view.component.ts` | 链接有效 |
| 4.3 | 新手引导 / Onboarding | 更新 `onboarding.service` 中的 target、step 描述 | `src/services/onboarding.service.ts` | 引导指向正确元素 |
| 4.4 | NavBridgeService | 从 `LegacyView` 和 `isValidLegacyView` 中移除或保留 `knowledge-brain` 等（若深链仍通过 router 实现可移除） | `nav-bridge.service.ts` | 类型与校验一致 |
| 4.5 | 其他服务 | `ai-marketing-assistant` 的 `navigateEvent.emit('ai-center')` 等改为 `ai-engine` 或路径 | 全局搜索 | 无死链 |

### 阶段 5：国际化与文案

| 序号 | 任务 | 具体操作 | 涉及文件 | 验收标准 |
|------|------|----------|----------|----------|
| 5.1 | 新增/调整 i18n key | 如需「智能引擎」独立于「AI 中心」，新增 `menu.aiEngine`；否则沿用 `aiCenter` | `zh-CN.json`, `zh-TW.json`, `en.json` | 多语言一致 |
| 5.2 | 文档与帮助 | 更新帮助文档中「如何进入知识大脑」的说明，统一为「智能引擎 → 知识大脑 Tab」 | 内部文档/帮助中心 | 用户可按文档操作 |

### 阶段 6：测试与验证

| 序号 | 任务 | 具体操作 | 验收标准 |
|------|------|----------|----------|
| 6.1 | 功能测试 | 侧栏点击「智能引擎」→ 进入引擎概覽；切换至知识大脑 Tab → 总览/知识管理/知识缺口；直接访问 `/ai-engine/gaps` | 功能正常 |
| 6.2 | 高亮测试 | 在 `/ai-engine`、`/ai-engine/overview`、`/ai-engine/knowledge`、`/ai-engine/gaps` 下侧栏高亮一致 | 仅「智能引擎」高亮 |
| 6.3 | 刷新/前进后退 | 在知识缺口页刷新、浏览器后退 | 状态保持、高亮正确 |
| 6.4 | 深链分享 | 复制 `/ai-engine/gaps` 在新标签打开 | 直达知识缺口 |
| 6.5 | 角标 | 存在知识缺口时，角标在预期位置显示 | 可见且不冗余 |
| 6.6 | 回归 | 引擎概覽、模型配置、人格風格、使用統計、知识管理、知识缺口内所有操作 | 无功能回退 |

---

## 四、关键逻辑变更说明

### 4.1 路由→视图反查（currentView 同步）

**现状**：`Object.entries(VIEW_ROUTE_MAP).find(([, route]) => route === url)` 精确匹配，`/ai-engine/overview` → `knowledge-brain`，`/ai-engine` → 多值时取第一个。

**目标**：所有 `/ai-engine`、`/ai-engine/overview`、`/ai-engine/knowledge`、`/ai-engine/gaps` 均映射为 `ai-engine`（或统一使用的 `ai-center`）。

**实现选项**：

- **选项 A**：在 Router 订阅逻辑中增加判断：若 `url.startsWith('/ai-engine')`，则 `currentView.set('ai-engine')`，不再依赖 `VIEW_ROUTE_MAP` 反查。
- **选项 B**：新增 `ROUTE_VIEW_MAP`（route → view），对 `/ai-engine`、`/ai-engine/overview` 等均设为 `ai-engine`，反查时优先匹配最长路径，再回退到 `/ai-engine`。

### 4.2 知识缺口角标

**现状**：`ragBrainService.gapsCount() > 0` 时在侧栏「知识缺口」旁显示角标。

**迁移方案**：

- **方案 A**：在侧栏「智能引擎」主项旁显示角标（表示「智能引擎内有待处理项」）。
- **方案 B**：移除侧栏角标，仅在内容区「知识大脑」Tab 或「知识缺口」子 Tab 旁显示。
- **方案 C**：在仪表板或通知中心展示，侧栏不再展示。

推荐 **方案 A** 或 **方案 B**，兼顾可见性与简洁。

### 4.3 Tab 切换与 URL 同步

**当前**：`ai-center-view` 通过 `route.data.enginePanel` 设置 `initialTab`/`initialKnowledgeSub`，`ai-center` 的 effect 响应；但 Tab 点击未主动更新 URL。

**补充**：在 `ai-center.component` 的 Tab 点击逻辑中：

- 点击「知识大脑」且子 Tab 为「总览」→ `router.navigate(['/ai-engine/overview'], { replaceUrl: true })`
- 同理：知识管理 → `/ai-engine/knowledge`，知识缺口 → `/ai-engine/gaps`
- 点击「引擎概覽」等 → `/ai-engine`（或 `/ai-engine?tab=quick` 若采用 query 方案）

---

## 五、风险与回滚

### 5.1 风险

| 风险 | 影响 | 缓解 |
|------|------|------|
| 深链失效 | 旧书签/分享链接 `/ai-engine/overview` 等若被改或重定向错误 | 保持路由不变，仅改侧栏和 view 映射 |
| 外部引用 | 其他系统或文档链接到 `/ai-center` | 保留 `ai-center` → `ai-engine` 重定向 |
| 用户习惯 | 习惯从侧栏直接进「知识大脑」的用户需多一步 | 提供引导提示，或在「智能引擎」首页增加「知识大脑」快捷卡片 |

### 5.2 回滚条件

- 侧栏改动的回滚：恢复 `knowledge-menu` 结构及 `changeView` 调用。
- 路由/高亮回滚：恢复原 `VIEW_ROUTE_MAP` 反查逻辑。
- 建议：使用 feature flag 或分支，先小范围灰度。

---

## 六、成功指标

| 指标 | 目标 | 测量方式 |
|------|------|----------|
| 导航重复消除 | 侧栏「AI 智能」下仅 1 个可点击项 | 代码/UI 审查 |
| 路径唯一性 | 总览/知识管理/知识缺口仅有内容区 Tab 入口（侧栏已移除） | 代码审查 |
| 高亮一致性 | 任意 `/ai-engine/*` 下侧栏高亮相同 | 手动测试 |
| 深链可用 | `/ai-engine/overview`、`/ai-engine/gaps` 等可正常访问 | 手动测试 |
| 无功能回退 | 引擎概覽、知识管理、知识缺口等核心功能正常 | 回归测试 |

---

## 七、与其它模块的一致性

建议对照以下模块的导航模式，确保「智能引擎」与其一致：

| 模块 | 侧栏结构 | 内容区 |
|------|----------|--------|
| 帳號管理 | 帳號列表 / 添加帳號 / API 憑證（可多个或分组） | 单页或 Tab |
| 營銷任務中心 | 快速啟動 / 任務列表 / 效果監控 | 单页 Tab |
| 觸發監控 | 監控群組 / 關鍵詞集 / 觸發規則 等 | 单页 Tab |
| 智能引擎（优化后） | **智能引擎**（单一项） | 引擎概覽 / 模型配置 / 人格風格 / 知识大脑 / 使用統計 |

若「帳號管理」等为「侧栏多子项 → 内容区对应子页」，则「智能引擎」采用「侧栏单入口 → 内容区多 Tab」属于合理差异，因智能引擎子功能较多，用 Tab 更合适。需在团队内统一约定并文档化。

---

## 八、附录：引用清单（待确认）

以下为 grep 结果的引用汇总，实施时需逐一确认是否需修改：

| 文件 | 引用 | 建议 |
|------|------|------|
| `app.component.ts` | View 类型、`isKnowledgeView`、`changeView` | 移除/简化 `isKnowledgeView`，View 类型可保留 `ai-engine` |
| `app.component.html` | 知识大脑菜单、AI 中心 | 删除知识大脑块，改 AI 中心为智能引擎 |
| `app.routes.ts` | VIEW_ROUTE_MAP | 见阶段 2 |
| `nav-bridge.service.ts` | LegacyView、isValidLegacyView | 视深链策略决定是否保留 knowledge-* |
| `ai-center.component.ts` | VIEW_TAB_MAP、currentView | 改为仅依赖路由 |
| `smart-marketing-hub.component.ts` | `navigate-to` /ai-center | 可保留（重定向到 ai-engine） |
| `auth.guard.ts` | `ai-center` | 可保留，权限以功能为准 |
| `quick-workflow.component.ts` | `actionView: 'ai-center'` | 改为 `ai-engine` 或路径 |
| `ai-marketing-assistant.component.ts` | `navigateEvent.emit('ai-center')` | 改为 `ai-engine` |
| `keyboard-shortcuts.service.ts` | `router.navigate(['/ai-engine'])` | 可保留 |
| `marketing-state.service.ts` | `path: '/ai-center'` | 可保留（会重定向） |
| `app.config.ts` | `ai-center` path | 可保留 |
| `dashboard-view.component.ts` | `ai-center` | 可保留 |
| `unified-nav.service.ts` | knowledge-hub、ai-engine 等 | 若使用 UnifiedNav 需同步调整 |

---

## 九、实施记录（2026-02-11）

### 9.1 已完成修改

| 阶段 | 修改内容 | 文件 |
|------|----------|------|
| 1 | 侧栏：移除知识大脑块，保留「智能引擎」单入口；知识缺口角标迁移至主项旁 | app.component.html |
| 1 | 新增 `isAiEngineView()`，移除 `toggleKnowledgeMenu`、`isKnowledgeView`、`knowledgeMenuExpanded` | app.component.ts |
| 1 | 新增 i18n `menu.aiEngine`（zh-CN/zh-TW/en） | i18n/*.json, i18n.service.ts |
| 2 | 路由订阅：`/ai-engine`、`/ai-engine/*` 统一设置 `currentView='ai-engine'` | app.component.ts |
| 2 | 路由反查改用 `path` 匹配（忽略 query），避免 query 导致匹配失败 | app.component.ts |
| 2 | View 类型新增 `ai-engine`；AI_NOT_ENABLED、refreshRagStats 改用 `isAiEngineView()` | app.component.ts |
| 3 | Tab 切换：`selectTab`、`selectKnowledgeSubTab` 同步 URL | ai-center.component.ts |
| 3 | 一级 Tab：quick→`/ai-engine`，models/persona/stats→`/ai-engine?tab=X`，knowledge→`/ai-engine/overview` | ai-center.component.ts |
| 3 | 二级 Tab：overview→`/ai-engine/overview`，manage→`/ai-engine/knowledge`，gaps→`/ai-engine/gaps` | ai-center.component.ts |
| 3 | ai-center-view：`setPanelFromRoute` 增加 query 参数 `tab` 解析 | ai-center-view.component.ts |
| 4 | 跨模块：quick-workflow、ai-marketing-assistant、smart-marketing-hub、marketing-state 改为 ai-engine | 多个文件 |
| 4 | NavBridge：LegacyView 与 isValidLegacyView 增加 `ai-engine` | nav-bridge.service.ts |
| 4 | UnifiedNav：ai-engine 模块增加 `ai-engine` 视图，defaultView 设为 `ai-engine` | unified-nav.service.ts |

### 9.2 方案外优化

1. **角标位置**：知识缺口角标保留在「智能引擎」主项旁，避免用户遗漏待处理项。
2. **Tab 与 URL 同步**：一级 Tab 除 knowledge 外，使用 `?tab=` 支持 quick/models/persona/stats 的刷新与分享。
3. **路由反查**：使用 `path` 而非完整 `url` 做反查，避免 query 参数导致匹配失败。
4. **数据 tour 属性**：侧栏入口保留 `data-tour="ai-engine"`，保证新手引导可用。
5. **queryParams 订阅**：`ai-center-view` 订阅 `queryParams`，确保通过 query 切换 Tab 时正确更新。

### 9.3 后续建议

- 若需按「知识大脑」做转化或使用报表，建议以 `module=knowledge_brain` 等维度打点。
- 若需灰度发布，可先恢复 `knowledge-menu` 的 feature flag，再逐步切换。

---

*文档版本：v1.1 | 实施完成，含实施记录与优化*
