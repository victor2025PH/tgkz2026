# 服務器文件架構與路徑說明

## 一、當前部署結構（/opt/tg-matrix）

代碼與數據分離：**數據目錄 `data` 在項目根路徑下**，不在 `backend` 下。

```
/opt/tg-matrix/
├── backend/          # 後端代碼（Python）
├── dist/             # 前端靜態資源（Nginx 託管）
├── data/             # 數據目錄（持久化，Docker 掛載）
│   ├── tgmatrix.db   # 主業務庫（帳號、監控、關鍵詞等）
│   ├── auth.db       # 認證庫（用戶、登錄）
│   ├── wallet.db     # 錢包
│   ├── system.db     # 系統配置
│   ├── sessions/     # Telegram 帳號會話文件
│   ├── avatars/      # 頭像
│   ├── backups/      # 備份
│   ├── logs/         # 日誌
│   ├── multi_role/
│   └── tenants/
├── docker-compose.yml
├── nginx.conf
└── ...
```

## 二、正確路徑對照

| 用途 | 服務器路徑 | 容器內路徑 (api 服務) |
|------|------------|------------------------|
| 數據根目錄 | `/opt/tg-matrix/data/` | `/app/data/` |
| 帳號數據庫 | `/opt/tg-matrix/data/tgmatrix.db` | `/app/data/tgmatrix.db` |
| 會話目錄 | `/opt/tg-matrix/data/sessions/` | `/app/sessions/`（掛載自 `data/sessions`） |
| 日誌目錄 | `/opt/tg-matrix/data/logs/` | `/app/logs/` |
| 認證庫 | `/opt/tg-matrix/data/auth.db` | `/app/data/auth.db` |

說明：

- `docker-compose.yml` 中 api 服務的掛載為：
  - `./data:/app/data`
  - `./data/sessions:/app/sessions`
  - `./data/logs:/app/logs`
- 後端通過 `TG_DATA_DIR` 或默認 `BASE_DIR/data` 解析數據目錄；容器內 `BASE_DIR` 為 `/app`，因此實際使用 `/app/data`，對應宿主機 `/opt/tg-matrix/data`。

## 三、為什麼帳號登錄後不顯示

### 原因：多租戶過濾 + 歷史數據未綁定用戶

1. **SaaS 模式下按「所屬用戶」過濾帳號**  
   登錄後獲取帳號列表時，後端會根據當前登錄用戶的 `user_id`（JWT 的 `sub`）過濾，只返回 `owner_user_id = 當前用戶ID` 的帳號。

2. **歷史帳號的 `owner_user_id` 可能為空或為舊值**  
   - 早期或遷移前創建的帳號：`owner_user_id` 可能為 `NULL`。  
   - Electron 或本地模式創建的帳號：可能為 `'local_user'`。  
   - 與當前 Web 登錄用戶的 UUID 不一致的，都不會再被查出來。

3. **結果**  
   查詢條件為 `WHERE owner_user_id = ?`（當前用戶 ID），歷史帳號不滿足條件，所以列表為空，表現為「登錄後帳號不顯示」。

### 解決方式

- **方案 A（推薦）：代碼兼容歷史數據**  
  在「按當前用戶過濾」的同時，把「未綁定」的歷史帳號也歸為當前用戶可見（僅在 SaaS 模式下、當前用戶登錄時）：  
  查詢改為：當前用戶的帳號 **或** `owner_user_id IS NULL OR owner_user_id = '' OR owner_user_id = 'local_user'`。  
  這樣舊數據無需手動改庫即可重新顯示。

- **方案 B：數據庫遷移**  
  寫一次性腳本，把現有帳號的 `owner_user_id` 更新為指定用戶 ID（例如第一個管理員），使這些帳號屬於該用戶，登錄後即可看到。

- **方案 C：權限與進程**  
  確認 `tgmatrix.db` 等文件權限與運行 API 的進程用戶一致（例如容器內多為 root），避免因無法讀庫導致查詢為空。

---

文檔中「正確路徑」以當前 `docker-compose` 與後端配置為準；若日後改動掛載或環境變量，請同步更新此說明。
