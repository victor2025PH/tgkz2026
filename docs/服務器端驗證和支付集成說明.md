# TG-Matrix æœå‹™å™¨ç«¯é©—è­‰å’Œæ”¯ä»˜é›†æˆèªªæ˜

> **ç‰ˆæœ¬**: 1.0.4  
> **æ›´æ–°æ—¥æœŸ**: 2026å¹´1æœˆ11æ—¥

---

## ğŸ“Š ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        TG-Matrix å®¢æˆ¶ç«¯                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  MembershipService  â†â†’  LicenseClientService               â”‚ â”‚
â”‚  â”‚       â†“                        â†“                            â”‚ â”‚
â”‚  â”‚  æœ¬åœ°å­˜å„² (é›¢ç·š)           æœå‹™å™¨ API (åœ¨ç·š)                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â†“                       â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  License Server â”‚      â”‚  Payment Gateway â”‚
         â”‚   (Python API)  â”‚      â”‚  (æ”¯ä»˜å¯¶/å¾®ä¿¡ç­‰)  â”‚
         â”‚                 â”‚      â”‚                  â”‚
         â”‚ - å¡å¯†é©—è­‰      â”‚      â”‚ - å‰µå»ºè¨‚å–®       â”‚
         â”‚ - æ¿€æ´»/ç¶å®š     â”‚      â”‚ - æ”¯ä»˜å›èª¿       â”‚
         â”‚ - å¿ƒè·³æª¢æ¸¬      â”‚      â”‚ - ç‹€æ…‹æŸ¥è©¢       â”‚
         â”‚ - çµ±è¨ˆåˆ†æ      â”‚      â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ æœå‹™å™¨ç«¯ API

### ç«¯é»åˆ—è¡¨

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/api/license/validate` | POST | é©—è­‰å¡å¯†ï¼ˆä¸æ¿€æ´»ï¼‰ |
| `/api/license/activate` | POST | æ¿€æ´»å¡å¯† |
| `/api/license/heartbeat` | POST | å¿ƒè·³æª¢æ¸¬ |
| `/api/stats` | GET | ç²å–çµ±è¨ˆæ•¸æ“š |
| `/api/payment/create` | POST | å‰µå»ºæ”¯ä»˜è¨‚å–® |
| `/api/payment/callback` | POST | æ”¯ä»˜å›èª¿ |
| `/api/health` | GET | å¥åº·æª¢æŸ¥ |

### API è©³ç´°èªªæ˜

#### 1. é©—è­‰å¡å¯†

```http
POST /api/license/validate
Content-Type: application/json

{
  "license_key": "TGM-V-XXXX-XXXX-XXXX"
}
```

**éŸ¿æ‡‰**:
```json
{
  "success": true,
  "message": "å¡å¯†æœ‰æ•ˆ",
  "data": {
    "level": "vip",
    "duration_days": 30,
    "status": "unused"
  }
}
```

#### 2. æ¿€æ´»å¡å¯†

```http
POST /api/license/activate
Content-Type: application/json

{
  "license_key": "TGM-V-XXXX-XXXX-XXXX",
  "machine_id": "mid-xxxx-xxxx",
  "email": "user@example.com"
}
```

**éŸ¿æ‡‰**:
```json
{
  "success": true,
  "message": "æ¿€æ´»æˆåŠŸï¼Œæœ‰æ•ˆæœŸè‡³ 2026-02-11",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "level": "vip",
    "expires_at": "2026-02-11T00:00:00",
    "duration_days": 30
  }
}
```

#### 3. å¿ƒè·³æª¢æ¸¬

```http
POST /api/license/heartbeat
Content-Type: application/json

{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "usage": {
    "todayMessages": 50,
    "todayAiCalls": 20
  }
}
```

**éŸ¿æ‡‰**:
```json
{
  "success": true,
  "message": "å¿ƒè·³æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "level": "vip",
    "expires_at": "2026-02-11T00:00:00",
    "status": "used"
  }
}
```

---

## ğŸ’³ æ”¯ä»˜é›†æˆ

### æ”¯æŒçš„æ”¯ä»˜æ–¹å¼

| æ”¯ä»˜æ–¹å¼ | ä»£ç¢¼ | èªªæ˜ |
|----------|------|------|
| æ”¯ä»˜å¯¶ | `alipay` | ä¸­åœ‹å¤§é™¸ |
| å¾®ä¿¡æ”¯ä»˜ | `wechat` | ä¸­åœ‹å¤§é™¸ |
| Stripe | `stripe` | åœ‹éš›ä¿¡ç”¨å¡ |
| USDT | `usdt` | åŠ å¯†è²¨å¹£ (TRC20) |

### USDT æ”¯ä»˜é…ç½®

```python
# license_server.py ä¸­é…ç½® USDT éŒ¢åŒ…åœ°å€
usdt_address = "TYourTRC20WalletAddressHere"  # æ›¿æ›ç‚ºå¯¦éš› TRC20 éŒ¢åŒ…åœ°å€
usdt_rate = 7.2  # USDT å…Œäººæ°‘å¹£åŒ¯ç‡
```

**æ”¯æŒçš„åŠ å¯†è²¨å¹£æ”¯ä»˜ç¶²é—œ**ï¼š
- CoinPayments
- NOWPayments
- Coinbase Commerce
- BTCPay Server (è‡ªæ‰˜ç®¡)

### ç”¢å“åƒ¹æ ¼è¡¨

| ç”¢å“ ID | åç¨± | åƒ¹æ ¼ | ç­‰ç´š | å¤©æ•¸ |
|---------|------|------|------|------|
| `vip_week` | VIP å‘¨å¡ | Â¥49 | vip | 7 |
| `vip_month` | VIP æœˆå¡ | Â¥99 | vip | 30 |
| `vip_quarter` | VIP å­£å¡ | Â¥249 | vip | 90 |
| `vip_year` | VIP å¹´å¡ | Â¥699 | vip | 365 |
| `svip_month` | SVIP æœˆå¡ | Â¥299 | svip | 30 |
| `svip_year` | SVIP å¹´å¡ | Â¥1999 | svip | 365 |
| `mvp_month` | MVP æœˆå¡ | Â¥999 | mvp | 30 |
| `mvp_year` | MVP å¹´å¡ | Â¥6999 | mvp | 365 |

### æ”¯ä»˜æµç¨‹

```
1. ç”¨æˆ¶é¸æ“‡ç”¢å“
       â†“
2. å®¢æˆ¶ç«¯èª¿ç”¨ /api/payment/create
       â†“
3. æœå‹™å™¨å‰µå»ºè¨‚å–®ï¼Œè¿”å› payment_url
       â†“
4. ç”¨æˆ¶è·³è½‰åˆ°æ”¯ä»˜é é¢å®Œæˆæ”¯ä»˜
       â†“
5. æ”¯ä»˜ç¶²é—œå›èª¿ /api/payment/callback
       â†“
6. æœå‹™å™¨ç”Ÿæˆå¡å¯†ä¸¦è‡ªå‹•æ¿€æ´»
       â†“
7. å®¢æˆ¶ç«¯è¼ªè©¢æª¢æŸ¥ç‹€æ…‹ï¼Œç²å–å¡å¯†
```

---

## ğŸ“ æ–‡ä»¶èªªæ˜

### å¾Œç«¯

| æ–‡ä»¶ | èªªæ˜ |
|------|------|
| `backend/license_server.py` | å¡å¯†é©—è­‰æœå‹™å™¨ |
| `backend/license_generator.py` | å¡å¯†ç”Ÿæˆå·¥å…· |
| `backend/membership.py` | æœ¬åœ°æœƒå“¡é©—è­‰ |

### å‰ç«¯

| æ–‡ä»¶ | èªªæ˜ |
|------|------|
| `src/license-client.service.ts` | æœå‹™å™¨é€šä¿¡å®¢æˆ¶ç«¯ |
| `src/payment.component.ts` | æ”¯ä»˜å°è©±æ¡†çµ„ä»¶ |
| `src/membership-stats.component.ts` | æ•¸æ“šçµ±è¨ˆé¢æ¿ |

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. å•Ÿå‹•æœå‹™å™¨

```bash
cd backend

# åˆå§‹åŒ–æ•¸æ“šåº«
python license_server.py init

# å•Ÿå‹•æœå‹™å™¨
python license_server.py run --host 0.0.0.0 --port 8080
```

### 2. ç”Ÿç”¢ç’°å¢ƒé…ç½®

```python
# ä¿®æ”¹ license_server.py ä¸­çš„é…ç½®
JWT_SECRET = "your-production-secret"  # ä½¿ç”¨ç’°å¢ƒè®Šé‡
```

### 3. Nginx åå‘ä»£ç†

```nginx
server {
    listen 443 ssl;
    server_name license.tg-matrix.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location /api/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 4. å®¢æˆ¶ç«¯é…ç½®

```typescript
// åœ¨æ‡‰ç”¨å•Ÿå‹•æ™‚è¨­ç½®æœå‹™å™¨åœ°å€
licenseClient.setServerUrl('https://license.tg-matrix.com');
```

---

## ğŸ“Š çµ±è¨ˆé¢æ¿

### é—œéµæŒ‡æ¨™

| æŒ‡æ¨™ | èªªæ˜ |
|------|------|
| ARPU | æ¯ç”¨æˆ¶å¹³å‡æ”¶å…¥ |
| LTV | ç”¨æˆ¶ç”Ÿå‘½é€±æœŸåƒ¹å€¼ |
| MoM | æœˆåº¦å¢é•·ç‡ |
| è½‰åŒ–ç‡ | å…è²» â†’ ä»˜è²»æ¯”ä¾‹ |
| æµå¤±ç‡ | æœƒå“¡åˆ°æœŸæœªçºŒè²»æ¯”ä¾‹ |

### æ•¸æ“šå°å‡º

çµ±è¨ˆé¢æ¿æ”¯æŒå°å‡º CSV æ ¼å¼æ•¸æ“šï¼ŒåŒ…å«ï¼š
- æ—¥æœŸ
- æ–°ç”¨æˆ¶æ•¸
- æ¿€æ´»æ•¸
- ä»˜è²»æ•¸
- æ”¶å…¥
- æ´»èºç”¨æˆ¶
- è½‰åŒ–æ•¸
- æµå¤±æ•¸

---

## ğŸ” å®‰å…¨æªæ–½

### 1. JWT Token

- æœ‰æ•ˆæœŸï¼š24å°æ™‚
- æ¯æ¬¡å¿ƒè·³åˆ·æ–°
- æ©Ÿå™¨ç¢¼ç¶å®š

### 2. æ©Ÿå™¨ç¢¼ç¶å®š

- æ¿€æ´»æ™‚ç¶å®šæ©Ÿå™¨ç¢¼
- å¿ƒè·³æ™‚é©—è­‰åŒ¹é…
- é˜²æ­¢å¤šè¨­å‚™ä½¿ç”¨

### 3. é›¢ç·šå¯¬é™æœŸ

- 7å¤©é›¢ç·šå¯¬é™æœŸ
- è¶…æ™‚éœ€é‡æ–°åœ¨ç·šé©—è­‰
- æœ¬åœ°ç·©å­˜æœƒå“¡ç‹€æ…‹

### 4. æ”¯ä»˜å®‰å…¨

- é©—è­‰æ”¯ä»˜ç¶²é—œç°½å
- HTTPS åŠ å¯†å‚³è¼¸
- è¨‚å–®è™Ÿé˜²é‡æ”¾

---

## ğŸ”§ å‘½ä»¤è¡Œå·¥å…·

```bash
# åˆå§‹åŒ–æ•¸æ“šåº«
python license_server.py init

# å•Ÿå‹•æœå‹™å™¨
python license_server.py run --host 0.0.0.0 --port 8080

# æŸ¥çœ‹çµ±è¨ˆ
python license_server.py stats

# ç”Ÿæˆå¡å¯†
python license_generator.py generate V -n 10 --batch "é¦–ç™¼å„ªæƒ "

# é©—è­‰å¡å¯†
python license_generator.py validate TGM-V-XXXX-XXXX-XXXX

# å°å‡ºå¡å¯†
python license_generator.py export -o licenses.csv --status unused
```

---

## ğŸ“ é›†æˆæ”¯ä»˜ç¶²é—œ

### æ”¯ä»˜å¯¶

```python
# éœ€è¦å®‰è£ alipay-sdk-python
# pip install alipay-sdk-python

from alipay import AliPay

alipay = AliPay(
    appid="your_app_id",
    app_private_key_string=open("private_key.pem").read(),
    alipay_public_key_string=open("alipay_public_key.pem").read()
)

# å‰µå»ºè¨‚å–®
order_string = alipay.api_alipay_trade_page_pay(
    out_trade_no=order_id,
    total_amount=amount,
    subject=product_name,
    return_url="https://your-site.com/return",
    notify_url="https://your-site.com/api/payment/callback"
)
```

### å¾®ä¿¡æ”¯ä»˜

```python
# éœ€è¦å®‰è£ wechatpay
# pip install wechatpay

from wechatpay import WeChatPay

wechat = WeChatPay(
    appid="your_app_id",
    mch_id="your_mch_id",
    api_key="your_api_key"
)

# å‰µå»ºè¨‚å–®
result = wechat.unified_order(
    body=product_name,
    out_trade_no=order_id,
    total_fee=int(amount * 100),
    notify_url="https://your-site.com/api/payment/callback"
)
```

---

*æ–‡æª”æ›´æ–°æ™‚é–“: 2026-01-11*
