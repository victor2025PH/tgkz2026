# TG-AI智控王 服務器部署完整指南

> **版本**: 2.0.0  
> **更新日期**: 2026年1月12日  
> **品牌**: TG-AI智控王  
> **會員系統**: 王者榮耀風格六級等級

---

## 📋 目錄

1. [系統概述](#系統概述)
2. [會員等級說明](#會員等級說明)
3. [快速部署](#快速部署)
4. [詳細部署步驟](#詳細部署步驟)
5. [GitHub Actions 自動部署](#github-actions-自動部署)
6. [管理後台功能](#管理後台功能)
7. [維護指南](#維護指南)
8. [常見問題](#常見問題)

---

## 系統概述

### 架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                    Ubuntu 服務器 (165.154.233.78)                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐ │
│   │  License Server │    │  Admin Panel    │    │  Nginx      │ │
│   │  (Python/aiohttp│    │  (Vue 3)        │    │  反向代理    │ │
│   │  Port: 8080     │    │  靜態文件        │    │  Port: 443  │ │
│   └────────┬────────┘    └────────┬────────┘    └──────┬──────┘ │
│            │                      │                     │       │
│            └──────────────────────┴─────────────────────┘       │
│                              │                                   │
│   ┌──────────────────────────┴──────────────────────────┐       │
│   │                    SQLite 數據庫                     │       │
│   │                  tgai_server.db                      │       │
│   └─────────────────────────────────────────────────────┘       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │ HTTPS API (tgkz.usdt2026.cc)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                  用戶客戶端 (TG-AI智控王 App)                     │
└─────────────────────────────────────────────────────────────────┘
```

### 系統要求

| 項目 | 最低配置 | 推薦配置 |
|------|---------|---------|
| CPU | 1 核心 | 2+ 核心 |
| 內存 | 512MB | 1GB+ |
| 硬盤 | 5GB | 20GB SSD |
| 系統 | Ubuntu 20.04 | Ubuntu 24.04 |
| Python | 3.8+ | 3.11+ |

### 當前部署信息

| 項目 | 值 |
|------|-----|
| 服務器 IP | 165.154.233.78 |
| 域名 | tgkz.usdt2026.cc |
| 管理後台 | https://tgkz.usdt2026.cc/admin/ |
| API 端點 | https://tgkz.usdt2026.cc/api/ |
| 管理員帳號 | admin / admin888 |

---

## 會員等級說明

### 王者榮耀風格六級體系

| 等級 | 代碼 | 名稱 | 圖標 | 月費 | 年費 | 終身 |
|------|------|------|------|------|------|------|
| 1 | bronze | 青銅戰士 | ⚔️ | 免費 | 免費 | 免費 |
| 2 | silver | 白銀精英 | 🥈 | ¥49 | ¥399 | ¥699 |
| 3 | gold | 黃金大師 | 🥇 | ¥99 | ¥799 | ¥1299 |
| 4 | diamond | 鑽石王牌 | 💎 | ¥199 | ¥1599 | ¥2599 |
| 5 | star | 星耀傳說 | 🌟 | ¥399 | ¥2999 | ¥4999 |
| 6 | king | 榮耀王者 | 👑 | ¥999 | ¥6999 | ¥9999 |

### 配額對比

| 功能 | 青銅 | 白銀 | 黃金 | 鑽石 | 星耀 | 王者 |
|------|------|------|------|------|------|------|
| 賬戶數 | 2 | 5 | 10 | 20 | 50 | 無限 |
| 每日消息 | 20 | 100 | 300 | 1000 | 無限 | 無限 |
| AI 調用 | 10 | 50 | 200 | 無限 | 無限 | 無限 |
| 群組數 | 3 | 10 | 30 | 100 | 無限 | 無限 |
| 數據保存 | 7天 | 15天 | 30天 | 60天 | 180天 | 365天 |
| 自動回復 | ❌ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 智能營銷 | ❌ | ❌ | ✅ | ✅ | ✅ | ✅ |
| API 訪問 | ❌ | ❌ | ❌ | ✅ | ✅ | ✅ |
| 專屬客服 | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ |
| 優先更新 | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ |

### 卡密格式

```
TGAI-[類型]-[XXXX]-[XXXX]-[XXXX]

類型代碼:
  B1/B2/B3/BY/BL = 白銀 周/月/季/年/終身
  G1/G2/G3/GY/GL = 黃金 周/月/季/年/終身
  D1/D2/D3/DY/DL = 鑽石 周/月/季/年/終身
  S1/S2/S3/SY/SL = 星耀 周/月/季/年/終身
  K1/K2/K3/KY/KL = 王者 周/月/季/年/終身
  PAY = 在線支付自動生成

示例:
  TGAI-G2-ABCD-EFGH-IJKL = 黃金大師月卡
  TGAI-KY-MNOP-QRST-UVWX = 榮耀王者年卡
  TGAI-PAY-1234-5678-9ABC = 在線支付卡密
```

### 邀請獎勵規則

| 被邀請人等級 | 邀請人獎勵天數 | 現金返傭 |
|-------------|---------------|---------|
| 白銀精英 | +3天 | ¥5 |
| 黃金大師 | +7天 | ¥10 |
| 鑽石王牌 | +15天 | ¥20 |
| 星耀傳說 | +30天 | ¥50 |
| 榮耀王者 | +60天 | ¥100 |

**重複付費返傭**: 10% 永久返傭

---

## 快速部署

### 方式一：GitHub Actions 自動部署 (當前使用)

每次推送代碼到 `main` 分支，GitHub Actions 會自動：
1. SSH 連接服務器
2. 拉取最新代碼
3. 初始化數據庫
4. 重啟服務

**無需手動操作！**

### 方式二：手動部署

```bash
# SSH 連接服務器
ssh ubuntu@165.154.233.78
# 密碼: FtwpP3s2WiEU4Pv6

# 進入項目目錄
cd /opt/tg-matrix-server

# 拉取最新代碼
git pull origin main

# 激活虛擬環境
source venv/bin/activate

# 初始化數據庫
python backend/license_server.py init

# 重啟服務
sudo systemctl restart tg-matrix-license

# 檢查狀態
sudo systemctl status tg-matrix-license
```

### 方式三：Windows 一鍵更新

雙擊運行 `一鍵更新服務器.bat` 腳本。

---

## 詳細部署步驟

### 1. 初次服務器設置

```bash
# 更新系統
sudo apt update && sudo apt upgrade -y

# 安裝依賴
sudo apt install -y python3 python3-pip python3-venv nginx certbot python3-certbot-nginx git

# 創建項目目錄
sudo mkdir -p /opt/tg-matrix-server
sudo chown ubuntu:ubuntu /opt/tg-matrix-server
cd /opt/tg-matrix-server

# 克隆代碼
git clone https://github.com/victor2025PH/tgkz2026.git .

# 創建虛擬環境
python3 -m venv venv
source venv/bin/activate
pip install -r backend/requirements.txt

# 初始化數據庫
python backend/license_server.py init
```

### 2. 創建 Systemd 服務

```bash
sudo tee /etc/systemd/system/tg-matrix-license.service << 'EOF'
[Unit]
Description=TG-Matrix License Server
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/tg-matrix-server
ExecStart=/opt/tg-matrix-server/venv/bin/python backend/license_server.py run
Restart=always
RestartSec=5
Environment=JWT_SECRET=tgai-license-secret-2026

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable tg-matrix-license
sudo systemctl start tg-matrix-license
```

### 3. 配置 Nginx

```bash
sudo tee /etc/nginx/sites-available/tg-matrix << 'EOF'
server {
    listen 80;
    server_name tgkz.usdt2026.cc;
    
    location /api/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location /admin/ {
        alias /opt/tg-matrix-server/admin-panel/;
        try_files $uri $uri/ /admin/index.html;
    }
    
    location / {
        root /opt/tg-matrix-server/admin-panel;
        try_files $uri $uri/ /index.html;
    }
}
EOF

sudo ln -sf /etc/nginx/sites-available/tg-matrix /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 4. 申請 SSL 證書

```bash
sudo certbot --nginx -d tgkz.usdt2026.cc
```

---

## GitHub Actions 自動部署

### 配置文件位置

`.github/workflows/deploy.yml`

### 需要配置的 Secrets

在 GitHub 倉庫設置 → Secrets and variables → Actions：

| Secret 名稱 | 值 |
|------------|-----|
| SERVER_HOST | 165.154.233.78 |
| SERVER_USER | ubuntu |
| SERVER_PASSWORD | FtwpP3s2WiEU4Pv6 |

### 工作流程

```yaml
name: Auto Deploy to Server
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        
      - name: Deploy to server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd /opt/tg-matrix-server
          git pull origin main
          source venv/bin/activate
          python backend/license_server.py init
          sudo systemctl restart tg-matrix-license
          EOF
```

---

## 管理後台功能

### 功能清單 (v2.0)

```
TG-AI智控王 管理後台
├── 📊 儀表盤
│   ├── 總用戶數/今日新增
│   ├── 總收入/今日收入
│   ├── 活躍用戶/卡密統計
│   └── 等級分布圖表
│
├── 👥 用戶管理
│   ├── 用戶列表 (搜索/篩選)
│   ├── 用戶詳情彈窗
│   ├── 手動續費/升級
│   ├── 封禁/解封
│   └── 操作確認對話框
│
├── 🎟️ 卡密管理
│   ├── 批量生成 (等級/時長/數量)
│   ├── 卡密列表
│   ├── 禁用卡密
│   └── 導出 CSV
│
├── 💰 訂單管理
│   ├── 訂單列表
│   ├── 手動確認支付
│   └── 訂單狀態篩選
│
├── 💹 收入報表 [NEW]
│   ├── 收入趨勢圖 (7/30/90天)
│   ├── 增長率對比
│   ├── 按等級分布餅圖
│   └── 按時長統計表
│
├── 📈 用戶分析 [NEW]
│   ├── 用戶增長趨勢
│   ├── 留存率 (次日/7日/30日)
│   ├── 轉化率 (ARPU/ARPPU)
│   ├── 等級分布圖
│   └── 邀請效果統計
│
├── 🎁 邀請管理
│   ├── 邀請統計
│   ├── 排行榜
│   └── 獎勵發放記錄
│
├── 🎫 優惠券系統 [NEW]
│   ├── 創建優惠券
│   ├── 優惠券列表
│   └── 禁用優惠券
│
├── 📢 公告管理
│   ├── 發布公告
│   ├── 編輯/刪除
│   ├── 置頂/彈窗設置
│   └── 有效期設置
│
├── 📝 操作日誌
│   ├── 全部操作記錄
│   └── 按類型篩選
│
└── ⚙️ 系統設置
    ├── USDT 收款地址
    ├── 匯率設置
    ├── 維護模式
    └── 公告內容
```

### 訪問地址

| 頁面 | URL |
|------|-----|
| 登錄頁 | https://tgkz.usdt2026.cc/admin/login.html |
| 主面板 | https://tgkz.usdt2026.cc/admin/ |

---

## 維護指南

### 日常維護腳本

```bash
# 位置: /opt/tg-matrix-server/scripts/

# 服務器更新
./server-update.sh

# 每日備份 (已設置 cron 自動執行)
./daily-backup.sh

# 設置定時任務
./setup-cron.sh
```

### 定時任務

```bash
# 查看當前任務
crontab -l

# 已配置:
# - 每天 03:00 自動備份數據庫
# - 每週日 04:00 清理舊日誌
```

### 備份與恢復

```bash
# 備份目錄
/opt/tg-matrix-server/backups/

# 手動備份
cd /opt/tg-matrix-server
./scripts/daily-backup.sh

# 恢復備份
gunzip backups/tgai_server_YYYYMMDD_HHMMSS.db.gz
cp backups/tgai_server_YYYYMMDD_HHMMSS.db backend/data/tgai_server.db
sudo systemctl restart tg-matrix-license
```

### 查看日誌

```bash
# 服務日誌
sudo journalctl -u tg-matrix-license -f

# Nginx 日誌
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 重啟服務

```bash
# 重啟 License Server
sudo systemctl restart tg-matrix-license

# 重啟 Nginx
sudo systemctl reload nginx

# 檢查狀態
sudo systemctl status tg-matrix-license
```

---

## 常見問題

### Q1: GitHub Actions 部署失敗

**檢查：**
1. 確認 Secrets 配置正確
2. 查看 Actions 日誌詳情
3. SSH 連接測試: `ssh ubuntu@165.154.233.78`

### Q2: 服務無法啟動

```bash
# 查看詳細錯誤
sudo journalctl -u tg-matrix-license --no-pager -n 50

# 手動測試運行
cd /opt/tg-matrix-server
source venv/bin/activate
python backend/license_server.py run
```

### Q3: 網站無法訪問

```bash
# 檢查服務狀態
sudo systemctl status tg-matrix-license
sudo systemctl status nginx

# 檢查端口
sudo netstat -tlnp | grep -E '8080|80|443'

# 檢查防火牆
sudo ufw status
```

### Q4: SSL 證書過期

```bash
# 手動續期
sudo certbot renew

# 自動續期 (已配置)
sudo certbot renew --dry-run
```

### Q5: 數據庫初始化失敗

```bash
# 重新初始化
cd /opt/tg-matrix-server
source venv/bin/activate
python backend/license_server.py init

# 如需重置 (會清空數據!)
rm backend/data/tgai_server.db
python backend/license_server.py init
```

---

## API 快速參考

| 端點 | 方法 | 說明 |
|------|------|------|
| `/api/health` | GET | 健康檢查 |
| `/api/license/validate` | POST | 驗證卡密 |
| `/api/license/activate` | POST | 激活卡密 |
| `/api/heartbeat` | POST | 心跳上報 |
| `/api/products` | GET | 產品列表 |
| `/api/payment/create` | POST | 創建訂單 |
| `/api/order/status` | GET | 訂單狀態 |
| `/api/announcements` | GET | 公告列表 |
| `/api/user/expiry-check` | GET | 到期提醒 |

**詳細 API 文檔**: 參見 `docs/API完整文檔.md`

---

## 技術支持

- 📧 郵箱: support@tg-ai.com
- 💬 Telegram: @TGAISupport
- 📖 文檔: https://github.com/victor2025PH/tgkz2026

---

*© 2026 TG-AI智控王. All Rights Reserved.*
