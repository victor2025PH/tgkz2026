# 環境配置與運行說明

## 一、前端環境（掃碼登錄同一套系統）

- **`src/environments/environment.ts`**（開發）：已配置 `defaultLoginApiUrl: 'https://tgw.usdt2026.cc'`，本地 `ng serve` 或 Electron 未填「使用服務器登錄」時掃碼走該後端。
- **`src/environments/environment.prod.ts`**（生產/Electron 打包）：同上，安裝版掃碼默認走同一後端。
- **`src/environments/environment.saas.ts`**：SaaS 版 `defaultLoginApiUrl` 為空，按需配置。

無需改動即可與後端「同一套數據」；若正式環境域名變更，僅需修改上述文件中的 `defaultLoginApiUrl` 與後端 `INTERNAL_API_URL` 一致。

---

## 二、後端環境變量

建議複製根目錄 `.env.example` 為 `.env` 並按需修改。掃碼登錄相關必讀項：

| 變量 | 說明 | 示例 |
|------|------|------|
| `INTERNAL_API_URL` | Bot 查詢/確認 login token 的 API 基址，**必須與前端生成二維碼的後端一致**，否則會出現「Token 不存在」、掃碼後仍無法登入 | 本地：`http://127.0.0.1:8000`<br>**生產：務必設為 `https://tgw.usdt2026.cc`（與 defaultLoginApiUrl 一致）** |
| `TELEGRAM_BOT_TOKEN` | Bot 密鑰（BotFather 簽發），用於掃碼確認與 OAuth | `123456:ABC-xxx` |
| `DATABASE_PATH` | 可選；未設時使用 `config.py` 中的默認路徑 | `backend/data/tgmatrix.db` |

生產部署時：將 `INTERNAL_API_URL` 設為對外 API 基址（如 `https://tgw.usdt2026.cc`），並確保 Telegram Webhook 指向同一部署。

**「運行 Telegram Bot 的那台機器」**：Bot 與 API 在同一進程內（接收 `POST /webhook/telegram`），因此就是**運行 API 的那台機器**（本項目為 `ubuntu@165.154.210.154`，部署路徑 `/opt/tg-matrix`）。在該機器上配置好 `INTERNAL_API_URL` 並重啟 API 即可同時重啟 Bot。

**通過 GitHub Actions 自動配置**：推送到 `main` 分支時，`deploy.yml` 與 `deploy-backend.yml` 會在服務器上自動確保 `INTERNAL_API_URL=https://tgw.usdt2026.cc` 並以 `--force-recreate` 重啟 API 容器。若仍出現「登錄失敗、Token 不存在」：

1. **在服務器上一次性修復**（SSH 登入 `ubuntu@165.154.210.154` 後執行）：
   ```bash
   cd /opt/tg-matrix
   grep -q '^INTERNAL_API_URL=' .env && sed -i 's|^INTERNAL_API_URL=.*|INTERNAL_API_URL=https://tgw.usdt2026.cc|' .env || echo 'INTERNAL_API_URL=https://tgw.usdt2026.cc' >> .env
   sudo docker compose up -d --force-recreate api
   ```
2. 或在 GitHub 倉庫 **Actions** 頁手動觸發 **Deploy Backend Only**，跑完後再試掃碼登錄。

手動一鍵腳本（在服務器項目根目錄）：`bash scripts/deploy-bot-env-and-restart.sh`

---

## 三、本地運行前檢查

1. **前端**：`npm run build` 或 `ng serve --port 4200` 可正常編譯/啟動。
2. **後端**：`cd backend && python -m pytest tests/test_api.py::TestAuthService -v` 通過；完整測試 `python -m pytest tests/ -v`（部分用例依賴 fixture/數據庫狀態，不影響主流程）。必要時先 `pip install -r requirements.txt`。
3. **環境**：若需本地掃碼聯調，確保 `.env` 中 `INTERNAL_API_URL` 與前端使用的基址一致（本地可為 `http://127.0.0.1:8000`）。
4. **Windows**：若後端啟動時出現編碼錯誤，可設置 `PYTHONIOENCODING=utf-8` 後再啟動。

完成上述配置後，服務器與本地開發者模式將使用同一套數據與系統。
