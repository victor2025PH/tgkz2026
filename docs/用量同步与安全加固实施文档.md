# TG-AI智控王 用量同步與安全加固實施文檔

> **版本**: v2.0  
> **日期**: 2026-01-12  
> **狀態**: ✅ 已完成

---

## 📊 概述

本文檔描述了用量數據同步機制和安全加固措施的完整實現。

### 主要功能

1. **用量數據同步**
   - 本地用量追蹤
   - 服務器實時同步
   - 離線緩存和恢復

2. **安全加固**
   - 請求簽名驗證
   - Token 自動刷新
   - 設備指紋驗證
   - 防重放攻擊

---

## 🔄 用量數據同步機制

### 架構圖

```
本地程序                           服務器
   │                                │
   │  1. 執行操作（發消息/AI調用）   │
   │                                │
   │  2. 本地配額檢查               │
   │                                │
   │  3. 更新本地計數               │
   │                                │
   │  4. POST /api/usage/log ────▶ │
   │     (帶簽名、nonce、時間戳)     │
   │                                │
   │  ◀──────────────────────────  │
   │  5. 返回剩餘配額               │
   │     更新本地狀態               │
   │                                │
   │  6. 定時同步 (每5分鐘)         │
   │     GET /api/usage/sync ────▶ │
   │                                │
```

### 服務器端 API

#### POST `/api/usage/log` - 記錄用量

**請求頭**：
```
X-Signature: SHA256(timestamp:nonce:machine_id:secret)
X-Timestamp: 1736697600
X-Nonce: a1b2c3d4e5f6...
X-Machine-Id: M-ABCD1234...
```

**請求體**：
```json
{
  "token": "jwt_token",
  "type": "message",
  "action": "use",
  "count": 1,
  "timestamp": 1736697600,
  "nonce": "a1b2c3d4e5f6...",
  "machine_id": "M-ABCD1234...",
  "device_fingerprint": "fingerprint_hash"
}
```

**響應**：
```json
{
  "success": true,
  "data": {
    "quotaExceeded": false,
    "remaining": {
      "messages": 45,
      "ai": 8
    },
    "used": {
      "messages": 5,
      "ai": 2
    },
    "max": {
      "messages": 50,
      "ai": 10
    }
  }
}
```

#### GET `/api/usage/sync` - 同步配額狀態

**請求頭**：
```
Authorization: Bearer jwt_token
```

**響應**：
```json
{
  "success": true,
  "data": {
    "date": "2026-01-12",
    "used": {
      "messages": 5,
      "ai": 2
    },
    "remaining": {
      "messages": 45,
      "ai": 8
    },
    "max": {
      "messages": 50,
      "ai": 10
    },
    "level": "bronze",
    "expiresAt": "2026-02-12T00:00:00"
  }
}
```

### 客戶端服務

#### `UsageSyncService`

```typescript
// 記錄消息發送
await usageSyncService.logMessageSent(1);

// 記錄 AI 調用
await usageSyncService.logAiCall(1);

// 手動同步
await usageSyncService.syncWithServer();

// 獲取配額狀態
const status = usageSyncService.quotaStatus();
```

**配額狀態接口**：
```typescript
interface QuotaStatus {
  used: { messages: number; ai: number };
  remaining: { messages: number; ai: number };
  max: { messages: number; ai: number };
  synced: boolean;
  lastSync?: Date;
}
```

---

## 🔒 安全加固措施

### 1. 請求簽名驗證

**客戶端生成簽名**：
```typescript
// security-client.service.ts
generateRequestSignature(timestamp: number, nonce: string, machineId: string): string {
  const signString = `${timestamp}:${nonce}:${machineId}:${JWT_SECRET}`;
  return sha256(signString);
}
```

**服務器驗證簽名**：
```python
# license_server.py
def _verify_request_signature(self, data: Dict, request: web.Request) -> bool:
    signature = request.headers.get('X-Signature', '')
    timestamp = data.get('timestamp', 0)
    nonce = data.get('nonce', '')
    
    # 檢查時間戳（5分鐘有效期）
    if abs(time.time() - timestamp) > 300:
        return False
    
    # 構建簽名字符串
    sign_string = f"{timestamp}:{nonce}:{data.get('machine_id', '')}:{JWT_SECRET}"
    expected_signature = hashlib.sha256(sign_string.encode()).hexdigest()
    
    return hmac.compare_digest(signature, expected_signature)
```

### 2. Token 刷新機制

**Token 有效期**：24 小時

**刷新策略**：
- 每 20 小時自動刷新
- Token 過期後 7 天內可刷新
- 刷新時驗證設備指紋

**API**：`POST /api/token/refresh`

```typescript
// license-client.service.ts
async refreshToken(): Promise<{ success: boolean; message: string }> {
  const body = this.securityService.createSignedRequestBody({
    token: this.token(),
    machine_id: this.securityService.machineId,
    device_fingerprint: this.securityService.deviceFingerprint
  });
  
  const response = await fetch(`${this.serverUrl()}/api/token/refresh`, {
    method: 'POST',
    headers: { ...this.securityService.createSecureHeaders() },
    body: JSON.stringify(body)
  });
  // ...
}
```

### 3. 設備指紋驗證

**指紋組成元素**：
- User Agent
- Platform
- 語言設置
- 螢幕分辨率和色深
- 時區
- 硬件信息（CPU 核心數、內存）
- 觸摸點數
- Canvas 指紋
- WebGL 指紋

```typescript
// security-client.service.ts
generateDeviceFingerprint(): string {
  const components = [
    navigator.userAgent,
    navigator.platform,
    navigator.language,
    screen.width + 'x' + screen.height,
    screen.colorDepth,
    new Date().getTimezoneOffset(),
    navigator.hardwareConcurrency || 0,
    (navigator as any).deviceMemory || 0,
    navigator.maxTouchPoints || 0,
    this.getCanvasFingerprint(),
    this.getWebGLFingerprint()
  ];
  
  return sha256(components.join('::'));
}
```

**驗證邏輯**：
- 首次激活時記錄設備指紋
- 後續請求時比對指紋
- 指紋變化觸發安全警報

### 4. 防重放攻擊

**Nonce 機制**：
- 每個請求包含唯一的 nonce
- 服務器緩存已使用的 nonce（10分鐘）
- 重複的 nonce 被拒絕

**時間戳驗證**：
- 請求時間戳必須在 5 分鐘內
- 過期請求被拒絕

```python
# license_server.py
def _verify_nonce(self, nonce: str, timestamp: int) -> bool:
    # 檢查時間戳（5分鐘有效期）
    if abs(time.time() - timestamp) > 300:
        return False
    
    # 檢查 nonce 是否已使用
    if nonce in self._used_nonces:
        return False
    
    # 記錄 nonce
    self._used_nonces[nonce] = time.time()
    return True
```

---

## 📁 文件結構

### 新增文件

```
src/
├── security-client.service.ts   # 安全客戶端服務
├── usage-sync.service.ts        # 用量同步服務

backend/
├── license_server.py            # 更新：添加安全 API
```

### 修改文件

```
src/
├── license-client.service.ts    # 集成安全服務

backend/
├── license_server.py            # 添加用量同步和安全 API
```

---

## 🔧 API 端點總結

### 用量同步 API

| 端點 | 方法 | 描述 | 安全級別 |
|------|------|------|---------|
| `/api/usage/log` | POST | 記錄用量 | 簽名 + Token + Nonce |
| `/api/usage/sync` | GET | 同步配額 | Token |
| `/api/token/refresh` | POST | 刷新 Token | 簽名 + 設備指紋 |

### 安全請求頭

| 請求頭 | 描述 |
|--------|------|
| `X-Signature` | 請求簽名（SHA-256） |
| `X-Timestamp` | 請求時間戳 |
| `X-Nonce` | 唯一隨機數 |
| `X-Machine-Id` | 機器碼 |
| `Authorization` | Bearer Token |

---

## 🚀 使用示例

### 在組件中使用用量同步

```typescript
import { UsageSyncService } from './usage-sync.service';

@Component({...})
export class MyComponent {
  private usageSync = inject(UsageSyncService);
  
  async sendMessage() {
    // 記錄消息發送
    const result = await this.usageSync.logMessageSent(1);
    
    if (!result.allowed) {
      this.toastService.warning('今日消息配額已用完');
      return;
    }
    
    // 發送消息邏輯...
    
    console.log(`剩餘消息配額: ${result.remaining}`);
  }
  
  async callAi() {
    const result = await this.usageSync.logAiCall(1);
    
    if (!result.allowed) {
      this.toastService.warning('今日 AI 配額已用完');
      return;
    }
    
    // AI 調用邏輯...
  }
}
```

### 監控配額狀態

```typescript
// 使用計算屬性
isMessageExceeded = computed(() => this.usageSync.isMessageQuotaExceeded());
isAiExceeded = computed(() => this.usageSync.isAiQuotaExceeded());

// 在模板中使用
@if (isMessageExceeded()) {
  <div class="warning">消息配額已用完</div>
}
```

---

## 📊 安全等級

| 功能 | 安全措施 | 防護目標 |
|------|---------|---------|
| 用量記錄 | 簽名 + Token + Nonce | 防止偽造請求 |
| Token 刷新 | 簽名 + 設備指紋 | 防止 Token 被盜用 |
| 配額同步 | Token | 防止未授權訪問 |
| 心跳檢測 | Token + 機器碼 | 設備綁定驗證 |

---

## 🔐 安全建議

### 生產環境

1. **使用 HTTPS**：所有 API 請求必須使用 HTTPS
2. **環境變量**：JWT_SECRET 應從環境變量讀取
3. **Redis 緩存**：Nonce 應使用 Redis 存儲（分布式環境）
4. **IP 白名單**：可選擇性添加 IP 白名單
5. **請求頻率限制**：已實現（需要調整參數）

### 客戶端

1. **代碼混淆**：生產構建時啟用代碼混淆
2. **敏感信息**：不在客戶端存儲敏感密鑰
3. **錯誤處理**：不暴露詳細錯誤信息

---

## ✅ 完成狀態

| 功能 | 狀態 |
|------|------|
| 服務器端用量同步 API | ✅ |
| 客戶端用量同步服務 | ✅ |
| Token 刷新機制 | ✅ |
| 請求簽名驗證 | ✅ |
| 防重放攻擊 | ✅ |
| 設備綁定驗證 | ✅ |
| 文檔 | ✅ |

---

*文檔更新時間: 2026-01-12*
