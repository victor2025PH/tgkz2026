# 白屏問題修復說明

## 🔍 問題診斷

根據您提供的信息，應用顯示為白屏可能有以下原因：

### 1. **構建成功但未正確載入**
- ✅ Angular 構建成功（dist/main-SSQY3MRV.js 已生成，1.4 MB）
- ✅ 後端 exe 已存在（227.4 MB）
- ✅ Angular 開發服務器正在運行（http://localhost:3000）

### 2. **可能的錯誤來源**
- ⚠️ 控制台錯誤：`ReferenceError: dragEvent is not defined`
- ⚠️ 認證初始化可能阻塞渲染
- ⚠️ Angular 應用可能未正確啟動

## 🔧 已修復的問題

### 修復 1: 認證初始化優化
**問題**：`AuthService` 的 `checkLocalAuth()` 在構造函數中同步執行，可能阻塞 Angular 應用初始化。

**修復**：
- 使用 `setTimeout` 延遲執行認證檢查，不阻塞 Angular 初始化
- 添加錯誤處理，確保即使認證檢查失敗也能顯示登入頁面
- 確保 `isAuthenticated` 初始狀態為 `false`，讓應用先顯示登入頁面

**代碼位置**：`src/auth.service.ts` (第 116-153 行)

### 修復 2: Electron 錯誤監聽增強
**問題**：Electron 可能沒有正確捕獲渲染進程的錯誤。

**修復**：
- 添加 `did-fail-load` 事件監聽，捕獲頁面載入失敗
- 添加 `console-message` 事件監聽，捕獲渲染進程的控制台錯誤

**代碼位置**：`electron.js` (第 309 行附近)

## 🚀 解決方案

### 方案 1: 清理並重新構建（推薦）

```bash
# 1. 停止當前運行的應用（Ctrl+C）

# 2. 清理構建文件
rm -rf dist node_modules/.angular

# 3. 重新構建
npm run build

# 4. 重新啟動開發模式
npm run start:dev
```

### 方案 2: 檢查控制台錯誤

1. 在 Electron 窗口中打開開發者工具（F12 或 Ctrl+Shift+I）
2. 查看 Console 標籤是否有錯誤
3. 查看 Network 標籤，確認 Angular 應用是否正確載入
4. 查看 Sources 標籤，確認 JavaScript 文件是否正確加載

### 方案 3: 檢查認證狀態

如果應用顯示白屏，可能是因為：
1. 認證檢查失敗
2. 需要登入但登入組件未正確加載

**解決**：
- 檢查瀏覽器 localStorage 是否有 `tgm_auth_token` 和 `tgm_user`
- 如果有，嘗試清除：
  ```javascript
  localStorage.removeItem('tgm_auth_token');
  localStorage.removeItem('tgm_user');
  ```
- 然後刷新頁面，應該會顯示登入頁面

### 方案 4: 使用生產模式測試

如果開發模式有問題，可以嘗試生產模式：

```bash
# 構建生產版本
npm run build:prod

# 啟動 Electron（使用構建文件）
npm start
```

## 🔍 診斷步驟

### 步驟 1: 檢查構建文件
```bash
# 檢查 dist 目錄
ls dist/

# 應該看到：
# - index.html
# - main-*.js
# - prerendered-routes.json
```

### 步驟 2: 檢查開發服務器
```bash
# 在瀏覽器中打開
http://localhost:3000

# 應該能看到 Angular 應用（或登入頁面）
```

### 步驟 3: 檢查 Electron 日誌
查看終端輸出，確認：
- ✅ Angular 構建成功
- ✅ Angular 開發服務器運行在 3000 端口
- ✅ Electron 成功連接到 http://localhost:3000
- ✅ 後端 exe 啟動成功

### 步驟 4: 檢查瀏覽器控制台
在 Electron 窗口中：
1. 按 F12 打開開發者工具
2. 查看 Console 標籤
3. 查看是否有錯誤或警告
4. 查看 Network 標籤，確認資源是否正確加載

## 📋 常見問題

### Q1: 為什麼顯示白屏？
**A**: 可能的原因：
1. Angular 應用沒有正確初始化
2. 認證檢查阻塞了渲染
3. JavaScript 錯誤阻止了應用啟動
4. 網絡問題導致 Angular 資源無法加載

### Q2: 如何確認 Angular 是否正確載入？
**A**: 
1. 打開開發者工具（F12）
2. 查看 Console 標籤，應該看到 Angular 的初始化日誌
3. 查看 Elements 標籤，應該看到 `<app-root>` 元素
4. 查看 Network 標籤，應該看到 `main-*.js` 文件已加載

### Q3: `dragEvent is not defined` 錯誤是什麼？
**A**: 這個錯誤可能來自：
- 瀏覽器內部的某個腳本
- 或者 Angular 構建過程中生成的代碼
- 通常不會影響應用運行，但如果影響，需要檢查是否有拖放相關的事件處理

### Q4: 如何強制顯示登入頁面？
**A**: 
1. 清除瀏覽器 localStorage
2. 或者修改 `auth.service.ts`，將 `_isAuthenticated` 初始值設為 `false`

## ✅ 驗證修復

修復後，應用應該：
1. ✅ 正常顯示登入頁面（如果未認證）
2. ✅ 正常顯示主界面（如果已認證）
3. ✅ 控制台沒有嚴重錯誤
4. ✅ 所有資源正確加載

## 📝 下一步

如果修復後仍有問題，請：
1. 查看 Electron 控制台輸出
2. 查看瀏覽器開發者工具（F12）的 Console 和 Network 標籤
3. 檢查是否有其他錯誤信息
4. 提供完整的錯誤日誌

---

*最後更新: 2026-01-12*
