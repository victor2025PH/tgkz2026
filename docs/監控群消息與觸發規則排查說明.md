# 監控群消息與觸發規則排查說明

> 當「群裡發消息後沒有監控群消息日誌」或「發送消息了也沒有進行聊天」時，按以下步驟排查。

---

## 一、為什麼沒有「監控群消息」日誌？

### 1. 日誌在什麼地方看？

- **後端窗口（終端）**：運行 API 的 Console（如 `python -m backend.main` 或 Docker 容器日誌）。  
  每次收到**任意群消息**時會輸出一行：  
  `[監控群消息] chat_id=... title=... 監控中=是/否 有文字=...`
- **前端日誌面板**：應用內的日誌區域收到的是 `log-entry` 事件（如「✓ 收到監控群組消息」「✓✓ 關鍵詞匹配成功」）。  
  若你只看前端而後端有輸出，說明消息有進來，只是前端展示的條目不同。

### 2. 若後端也沒有 `[監控群消息]` 這一行

說明 **Pyrogram 沒有把該群消息交給我們的處理器**，可能原因：

- **監控未真正啟動**：儀表盤顯示「運行中」但後端重啟後未再次點「一鍵全部啟動」，或啟動失敗。  
  → 解決：重新點「一鍵全部啟動」，確認後端日誌有「已註冊消息處理器，監控 N 個群組」。
- **帳號未在線**：監控帳號（Listener）離線，收不到消息。  
  → 解決：確保「帳號在線」為 3/3（或至少 1 個在線）。

### 3. 若有 `[監控群消息]` 但顯示「監控中=False」

說明 **該群不在當前帳號的監控列表裡**（chat_id 未在我們解析到的監控群 ID 中）。可能原因：

- 監控群組配置的連結與實際群不一致（例如連結是 A 群，你發消息的是 B 群）。
- 啟動監控時部分群解析失敗（後端會打 `✗ 無法解析: ...`）。  
→ 解決：在「監控群組」中確認群連結正確，重新「一鍵全部啟動」，看後端是否有「✓ url -> chat_id」及無解析錯誤。

### 4. 若有「監控中=True」但沒有「關鍵詞匹配」日誌

說明消息有被當成監控群消息，但**沒有命中關鍵詞**。請檢查：

- 「關鍵詞集」是否已綁定到該監控群組，且關鍵詞裡包含你發的詞（如「支付」「支付宝」）。
- 關鍵詞集是否為空（後端會打 `keyword_sets 為空`）。

---

## 二、為什麼「發送消息了也沒有進行聊天」？

儀表盤「觸發規則」顯示 **0/0、需配置規則** 時，**即使關鍵詞匹配成功，也不會自動發送任何回覆**，因為沒有「關鍵詞 → 發送什麼」的規則。

### 正確流程

1. **監控狀態**：運行中  
2. **監控群組**：包含你發消息的那個群  
3. **關鍵詞集**：綁定到該群，且包含你發的詞  
4. **觸發規則**：至少 1 條**已啟用**，且關聯了上述關鍵詞集和回覆方式（模板或 AI）

### 你需要做的

1. 左側進入 **監控中心 → 觸發規則**。  
2. 若列表為空或全部停用：**創建一條規則** 或 **啟用現有規則**。  
3. 規則中：選擇**關鍵詞集**（含「支付」等）、選擇**響應方式**（如模板）、選擇**發送帳號**。  
4. 保存後，儀表盤「觸發規則」應顯示為 1/1 或 N/N（N 為啟用數）。  
5. 再次在群裡發帶關鍵詞的消息；後端會打「觸發規則 已入隊」或「無活躍規則，未發送」（若仍為 0 條活躍）。

若已配置規則仍為 0/0，請**刷新儀表盤**或重新進入觸發規則頁，確認後端「獲取觸發規則」返回的數據中有啟用規則。

---

## 三、後端日誌含義速查

| 日誌內容 | 含義 |
|----------|------|
| `[監控群消息] ... 監控中=True` | 該群在監控列表內，會繼續做關鍵詞匹配 |
| `[監控群消息] ... 監控中=False` | 該群不在監控列表，不會匹配關鍵詞 |
| `首次未匹配: chat_id=... monitored_ids=[...]` | 同上，並列出當前監控的 chat_id，便於對照 |
| `========== KEYWORD MATCHED ==========` | 關鍵詞匹配成功，即將捕獲 Lead 並執行觸發規則 |
| `[LeadActions] 觸發規則: 無活躍規則（共 0 條），未發送` | 關鍵詞已匹配，但沒有啟用的觸發規則，不會發送 |
| `[觸發規則] 已入隊 rule=...` | 已按規則入隊，稍後會發送私聊/群回覆 |

---

## 四、本次代碼改動（便於你對照日誌）

1. **telegram_client.py**  
   每次收到群消息都會在後端終端打一行：  
   `[監控群消息] chat_id=... title=... 監控中=... 有文字=...`

2. **lead_actions_mixin.py**  
   當沒有活躍觸發規則時，會打：  
   `[LeadActions] 觸發規則: 無活躍規則（共 N 條），未發送。請在「觸發規則」中啟用至少一條。`  
   並在前端日誌中提示：「無活躍規則，未發送。請在「觸發規則」中啟用至少一條。」

部署後在後端窗口看上述日誌，即可區分是「沒收到消息」「群沒在監控」還是「沒有觸發規則」。
