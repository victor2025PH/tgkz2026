# 群聊沒有被監控、AI 沒有自動聊天 — 排查說明

## 現象

- 關鍵詞集、觸發規則、AI 設置都已配置，儀表盤顯示「監控運行中」「AI 全自動」「觸發規則 1/1」。
- 在群裡發包含關鍵詞的消息後：「總匹配」仍為 0，沒有觸發 AI 自動回覆。

---

## 監控與觸發鏈路（簡要）

1. **監控帳號**（角色為「監聽」且在線）加入 **監控群組**。
2. 監控啟動時，後端會用該帳號監聽這些群組的消息。
3. 群內消息內容與 **關鍵詞集** 中的關鍵詞匹配時，會觸發 **Lead 捕獲**。
4. 捕獲後依次執行：**AI 問候** → **觸發規則**（含「AI 智能对话」）→ **活動**。
5. 觸發規則若為「AI 智能对话」，會調用當前配置的 **AI 模型** 生成回覆，並由 **發送帳號** 發私信。

因此，要同時滿足：**有監控、有關鍵詞匹配、有發送帳號、AI 可用**，群裡才會被監控並出現 AI 自動聊天。

---

## 一、為什麼「總匹配」一直是 0？

表示目前 **沒有任何一條群消息** 被識別為關鍵詞匹配，常見原因如下。

### 1. 聊天所在群組不在「監控群組」裡

- 監控只會處理 **監控中心 → 監控群組** 裡已添加的群。
- **操作**：打開 **監控中心 → 監控群組**，確認你測試的那個群已在列表中，且狀態正常（已加入）。
- 若未添加：點「添加群組」把該群的連結或標識加進去。

### 2. 監控帳號沒有加入該群、或未在線

- 只有 **角色為「監聽」且狀態為在線** 的帳號會參與監控；且該帳號必須 **已加入** 要監控的群，才能收到群消息。
- **操作**：
  - **帳號管理** 中確認至少有一個帳號角色為 **監聽**（或同時勾選監聽），並保持 **在線**。
  - 用該帳號的 Telegram 確認已加入你要測試的群；若被踢出或從未加入，需重新加入後再試。

### 3. 監控沒有真正啟動、或啟動後被停掉

- 儀表盤顯示「運行中」只表示 **上次啟動監控成功**；若之後重啟過後端、或點過「一鍵停止」，監控可能已停。
- **操作**：到儀表盤點 **「一鍵全部啟動」**（或監控中心內對應的啟動按鈕），確認日誌裡有「監控已啟動」「成功啟動監控」等提示；必要時刷新頁面後再看一次狀態。

### 4. 消息內容沒有命中關鍵詞

- 匹配是按 **當前配置的關鍵詞集** 做的；若發的是「hello」而關鍵詞只有「你好」，不會算一次匹配。
- **操作**：在群裡發一句 **完全包含** 某個已啟用關鍵詞的句子（例如關鍵詞有「你好」就發「你好」或「你好啊」），看「總匹配」是否增加。注意繁簡體、空格、符號要一致或符合匹配規則。

### 5. 多租戶 / 多用戶下數據不一致

- 若為多用戶環境：監控群組、關鍵詞集、觸發規則都是 **按當前登入用戶** 隔離的。
- **操作**：確認當前登入的是 **Vivian**（或你配置監控的那個帳號），在 **該用戶** 的監控群組、關鍵詞集、觸發規則裡檢查上述 1～4 項。

---

## 二、有匹配但仍沒有 AI 自動回覆？

若「總匹配」會增加，但從未收到 AI 私信或群內回覆，多半在 **發送能力** 或 **AI 配置**。

### 1. 沒有可用的「發送」帳號

- 觸發「AI 智能对话」後，需要由 **角色為「發送」** 的帳號發私信；若沒有在線的發送帳號，就不會發出消息。
- **操作**：在 **帳號管理** 中將至少一個帳號設為 **發送**（或同時監聽+發送），並保持 **在線**。儀表盤若出現「AI 已啟用但沒有可用的發送帳號」的提示，按提示去配置即可。

### 2. 智能引擎顯示「未配置 AI」或「未測試」

- 若 **智能引擎設置** 頁頂部是「未配置 AI」，或本地 AI 顯示「未測試」，表示系統認為 **沒有可用的 AI 端點**；觸發規則調用 AI 時可能失敗或直接跳過。
- **操作**：
  - 打開 **智能引擎 → 模型配置**，為「日常對話」等用途配置並保存 **本地 AI 或雲端模型**。
  - 若使用本地 AI：填好 API 地址後點 **「測試」**，確認通過後再試群裡觸發。
  - 必要時點 **「設為默認」**，並在 **引擎概覽** 確認頂部狀態變為「已連接」或「已配置」。

### 3. 觸發規則未選「AI 智能对话」或規則未啟用

- 觸發規則的 **響應方式** 需為「AI 智能对话」；且該規則需 **啟用**。
- **操作**：到 **監控中心 → 觸發規則**，確認至少一條規則的響應方式為「AI 智能对话(全自动)」且開關為開啟。

---

## 三、建議自檢順序（逐項打勾）

| 序號 | 檢查項 | 位置 |
|------|--------|------|
| 1 | 要測試的群已加入「監控群組」 | 監控中心 → 監控群組 |
| 2 | 至少一個帳號為「監聽」且在線，且該帳號已在該群內 | 帳號管理 + 實際 Telegram |
| 3 | 已點「一鍵全部啟動」或對應啟動監控，且日誌無報錯 | 儀表盤 / 監控中心 |
| 4 | 在群裡發送 **包含關鍵詞** 的句子（與關鍵詞集完全一致或符合匹配規則） | 群內發言 |
| 5 | 至少一個帳號為「發送」且在線 | 帳號管理 |
| 6 | 智能引擎中 AI 已配置並通過測試，非「未配置 AI」 | 智能引擎 → 模型配置 |
| 7 | 觸發規則中有「AI 智能对话」且規則已啟用 | 監控中心 → 觸發規則 |

若 1～4 都滿足但「總匹配」仍為 0，多半是 **群未在監控列表** 或 **監控帳號未在該群 / 未在線**；若 5～7 未滿足，則會出現有匹配但 **沒有 AI 自動聊天** 的情況。按上表從上到下逐項檢查即可快速定位問題。
