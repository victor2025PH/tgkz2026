# 营销任务创建失败与「110 人」数据来源 — 解决方案（无代码）

## 一、问题结论

### 1.1 为什么会创建失败？

**直接原因：数据库里没有 `marketing_tasks` 表。**

- 后端在处理「创建营销任务」时，会向 `marketing_tasks` 表执行 `INSERT` 或查询。
- 日志中的 `[Database] execute ERROR: no such table: marketing_tasks` 和 `Error in fetch_one: no such table: marketing_tasks` 表明：**当前使用的数据库连接对应的库里，没有这张表。**
- 因此创建逻辑在写库或后续查库时抛错，任务无法落库，用户看到「创建任务失败」。

**可能原因（任一种成立即会出问题）：**

1. **迁移未执行**：项目中有迁移 `0014_create_marketing_tasks.py` 负责创建 `marketing_tasks` 及相关表。若当前运行的后端在启动时**没有**对当前使用的数据库执行这套迁移（例如新环境、SaaS 新实例、或迁移脚本未跑），表就不会存在。
2. **用了未迁移的库**：营销任务服务通过 `get_marketing_task_service()` 拿到的数据库连接，若不是「已经跑过 0014 迁移」的那个库（例如多数据源时指错了库），也会出现“表不存在”。
3. **SaaS/多进程**：若 SaaS 有多节点或单独的任务服务进程，且该进程连的是新建库或未迁移库，同样会报 `no such table: marketing_tasks`。

**关于日志里「任务已创建」与 success: true：**

- 日志里在报错后仍出现 `marketing-task-created` 且 `success: true`、`任務已創建:测试001 (ID:0)`，说明存在**前后端或异常处理不一致**：要么某条代码路径在捕获异常后仍发了“成功”事件，要么有另一套逻辑（例如旧 API）在表不存在时返回了成功。  
- 这不会改变事实：**表不存在导致写库失败，任务并未真正创建成功。** 需要在解决表缺失的同时，统一“仅在实际写库成功时再返回 success: true”。

---

### 1.2 「110 人」的数据从哪里来？

**110 人来自前端的「預估目標人數」，不是来自后端的真实客群人数，也不是当前步骤里勾选的 110 个用户。**

- 在创建任务向导的**第 4 步「確認啟動」**里，「目標人數」绑定的是前端的 `estimatedAudience()`。
- `estimatedAudience()` 的实现是**纯前端公式**，依赖：
  - **客群来源**（選擇客群）：如「最近联系」= 150、「按标签」= 80、「按群组」= 200 等作为基数；
  - **意向分下限**等参数，参与一个系数计算；
  - 公式形如：`Math.floor(base * multiplier) + 10`。
- 因此界面上的「110 人」是**根据你选的客群来源和意向分算出来的预估值**，例如基数 150、系数约 0.67 时就会得到约 110。  
- 代码里还有 TODO「從後端獲取真實數據」，说明目前**没有**把「選擇客群」步骤里真实选中的用户数量传到后端，也没有在确认页展示真实人数；后端收到的 `targetCount`/`totalContacts` 为 0 也与此一致。

**小结：**

- **110**：前端根据「客群来源 + 意向分」算出的**预估目标人数**，仅用于展示。
- **真实人数**：当前未在确认页展示，也未在创建任务时传给后端；若要在任务里体现「真实 110 人」，需要后端支持并在前端把「選擇客群」的统计结果传过去。

---

## 二、解决方案（仅方案，不写具体代码）

### 2.1 解决「创建失败」：保证存在 `marketing_tasks` 表

**目标：** 让处理 `create-marketing-task` 的那条后端链路所使用的数据库里，存在 `marketing_tasks`（及迁移 0014 中定义的相关表）。

可选做法（按推荐顺序）：

1. **统一用迁移系统创建表（推荐）**
   - 确认当前 SaaS/Electron 后端启动时，使用的**是**那套会执行 `backend/migrations` 下迁移的初始化逻辑（例如 `init_startup_mixin` 里的 migration_manager）。
   - 确认迁移 0014 会被扫描并执行（版本号、命名、注册方式无误）。
   - 对**当前环境实际使用的数据库文件/连接**执行一次完整迁移（包括 0014），确保没有漏跑。
   - 若有多套启动方式（如 dev/prod、Electron/SaaS），要保证**每种**启动路径都会对**同一**数据库执行同一套迁移。

2. **若暂时不用迁移系统**
   - 从 `backend/migrations/0014_create_marketing_tasks.py` 中取出建表 SQL（以及必要的索引、外键）。
   - 在**当前后端实际使用的数据库**上手动执行这些 SQL（或通过一次性脚本执行），使 `marketing_tasks` 等表存在。
   - 后续仍建议纳入统一迁移，避免环境不一致。

3. **服务层兜底（可选）**
   - 在营销任务服务初始化或首次执行 `create_task` 时，检测 `marketing_tasks` 是否存在；若不存在，则执行与 0014 等价的建表语句后再继续。  
   - 仅建议作为临时兜底，长期应以「启动时统一迁移」为准。

4. **统一成功/失败反馈**
   - 在创建任务的整条调用链中约定：**只有**在数据库 `INSERT`（及必要查询）成功之后，才发送 `marketing-task-created` 且 `success: true` 并带上任务信息。
   - 一旦捕获到「表不存在」或其它数据库异常，**只**返回 `success: false` 和明确错误信息（如「数据库未就绪，请稍后重试」或「营销任务表未初始化」），不在异常路径下发 success: true。
   - 前端在收到 success: false 时，固定展示「创建任务失败」并可选展示后端返回的简短错误说明，避免用户误以为任务已创建。

---

### 2.2 理清并优化「目标人数」展示与数据

**目标：** 让用户知道「110 人」是什么、可选地区分「预估」与「实际」，并为后续对接真实客群人数留接口。

1. **文案与展示**
   - 在创建任务第 4 步，将「目標人數」改为「預估目標人數」或「預估覆蓋人數」，并在旁加简短说明（如「根據所選客群來源與意向分預估」），避免被理解为「已选 110 个具体用户」。
   - 若后续接入真实客群数量，可并排展示「預估：110 人」「實際可觸達：XX 人」（实际数来自后端或前端从「選擇客群」步骤汇总）。

2. **数据流（为后续真实人数铺路）**
   - 在「選擇客群」步骤中，若已有具体选人结果（标签、群组、名单等），在前端汇总出「本次选中人数」。
   - 创建任务时，将「预估人数」和「实际选中人数」（若有）一并传给后端（例如 `targetCount` / `estimatedAudience` / `actualAudienceCount`），后端落库，便于统计与报表。
   - 确认页可优先展示「实际选中人数」；若未选具体人，再仅展示「预估人数」。

3. **后端**
   - 建表/迁移中已有 `target_count`、`stats_total_contacts` 等字段时，创建任务时根据前端传入值写入；若当前 INSERT 未包含这些字段，在方案中补充：在 `create_task` 的 INSERT 中增加对应列，并从 payload 取 targetCount/总人数写入。

---

## 三、实施顺序建议

1. **先解决创建失败**
   - 确认当前环境使用的数据库与迁移执行路径；
   - 对当前库执行 0014（或等价建表），确认 `marketing_tasks` 存在；
   - 再测一次「创建营销任务」，确认可成功并能在列表中看到任务。

2. **再统一成功/失败语义**
   - 检查并修正所有在表不存在或写库失败时仍返回 success: true 的分支，确保仅在实际落库成功时返回成功；
   - 前端根据 success 与 error 文案展示「创建任务失败」及原因。

3. **最后优化「目标人数」**
   - 文案改为「預估目標人數」并加说明；
   - 若有「選擇客群」的统计结果，再增加传递与展示「实际人数」的字段和 UI。

---

## 四、小结

| 问题 | 原因 | 解决方向 |
|------|------|----------|
| 为什么会创建失败？ | 当前使用的数据库中不存在 `marketing_tasks` 表，写库/查库报错。 | 对该库执行迁移 0014（或等价建表）；统一仅在写库成功时返回 success: true。 |
| 110 人的数据从哪里来？ | 来自前端 `estimatedAudience()` 的公式结果（客群来源 + 意向分等），是**预估**人数，不是真实选中的 110 个用户。 | 文案改为「預估目標人數」并加说明；可选：传真实客群人数到后端并在确认页展示。 |

---

*文档版本：v1.0*
