# 🐝 蜂群效應 AI 營銷系統 - 實施報告

**實施日期**: 2026-01-21  
**版本**: v1.2.0  
**狀態**: ✅ 已完成

---

## 📋 實施概覽

### 核心功能
1. **蜂群執行引擎** - 多角色自動協作回覆
2. **內存鎖機制** - 防止多角色同時發言
3. **角色搶答邏輯** - 關鍵詞匹配 + 概率選擇
4. **TTS 語音集成** - GPT-SoVITS 語音狙擊
5. **智能分流** - 高價值關鍵詞觸發語音回覆

---

## 📁 修改/新建的文件

### 後端 (Python)

| 文件 | 類型 | 說明 |
|------|------|------|
| `backend/collaboration_coordinator.py` | 重構 | 添加蜂群執行引擎核心邏輯 |
| `backend/discussion_watcher.py` | 修改 | 打通蜂群調用鏈路 |
| `backend/services/tts_service.py` | 新建 | GPT-SoVITS 語音合成服務 |
| `backend/services/__init__.py` | 新建 | 服務模塊導出 |
| `backend/main.py` | 修改 | 註冊新服務和 IPC 處理器 |

### 前端 (Angular)

| 文件 | 類型 | 說明 |
|------|------|------|
| `src/multi-role/swarm.service.ts` | 新建 | 蜂群控制服務 |
| `src/multi-role/components/swarm-monitor.component.ts` | 新建 | 蜂群監控組件 |
| `src/multi-role/multi-role-center.component.ts` | 修改 | 集成蜂群標籤頁 |

---

## 🔧 核心代碼結構

### 蜂群協調器 (`collaboration_coordinator.py`)

```python
class CollaborationCoordinator:
    # 🆕 蜂群狀態管理
    _swarm_states: Dict[str, SwarmGroupState]  # 群組狀態
    _swarm_enabled_groups: set                 # 啟用的群組
    
    # 核心方法
    async def process_group_message(...)       # 處理群消息，觸發蜂群回覆
    async def _select_best_role(...)           # 選擇最佳回覆角色
    async def _generate_role_response(...)     # AI 生成角色化回覆
    async def _execute_role_response(...)      # 發送消息（文字/語音）
```

### 蜂群狀態數據結構

```python
@dataclass
class SwarmGroupState:
    group_id: str
    speaking_lock: asyncio.Lock      # 發言鎖
    last_speaker_role: str           # 上次發言角色
    last_speak_time: float           # 上次發言時間
    cooldown_seconds: int = 30       # 角色冷卻時間
    global_cooldown: int = 5         # 全局冷卻時間
    conversation_context: List[Dict] # 對話上下文
    voice_enabled: bool = True       # 是否啟用語音
```

### 關鍵詞 → 角色映射

```python
HIGH_VALUE_KEYWORDS = {
    r'價格|多少錢|費用': 'expert',      # → 語音回覆
    r'怎麼買|下單|購買': 'sales',        # → 語音回覆
    r'好用嗎|效果|評價': 'satisfied_customer',
    r'售後|問題|退款': 'support',
    r'優惠|折扣|活動': 'manager',
}
```

---

## 🔌 IPC 命令列表

### 蜂群控制
| 命令 | 說明 |
|------|------|
| `swarm-enable-group` | 為群組啟用蜂群模式 |
| `swarm-disable-group` | 禁用群組蜂群模式 |
| `swarm-get-status` | 獲取蜂群運行狀態 |
| `swarm-get-stats` | 獲取蜂群統計數據 |
| `swarm-test-response` | 測試蜂群回覆 |

### TTS 控制
| 命令 | 說明 |
|------|------|
| `tts-check-connection` | 檢查 GPT-SoVITS 連接 |
| `tts-generate-voice` | 生成語音 |
| `tts-set-voice-config` | 設置角色語音配置 |

---

## 🚀 使用流程

### 1. 啟動 GPT-SoVITS 服務
```bash
# 確保 GPT-SoVITS 在 127.0.0.1:9880 運行
python api.py  # 在 GPT-SoVITS 目錄
```

### 2. 在程序中啟用蜂群
1. 進入「多角色協作」頁面
2. 點擊「🐝 蜂群營銷」標籤
3. 輸入目標群組 ID
4. 點擊「啟用蜂群」

### 3. 監控蜂群運行
- 實時查看回覆日誌
- 監控 TTS 服務狀態
- 查看角色統計

---

## 📊 執行流程圖

```
用戶消息 ────────────────────────────────────────────────────────────┐
                                                                     │
                                                                     ▼
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│ discussion_watcher  │───▶│ 關鍵詞匹配          │───▶│ 觸發蜂群            │
│ 監聯群消息          │    │ keyword_matcher     │    │ _trigger_swarm_     │
└─────────────────────┘    └─────────────────────┘    │ response()          │
                                                       └──────────┬──────────┘
                                                                  │
                                                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    collaboration_coordinator.py                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │ process_group_  │───▶│ _select_best_   │───▶│ _generate_role_ │         │
│  │ message()       │    │ role()          │    │ response()      │         │
│  │                 │    │                 │    │                 │         │
│  │ 1. 獲取發言鎖   │    │ 1. 高價值關鍵詞 │    │ 1. 構建 Prompt  │         │
│  │ 2. 選擇角色     │    │ 2. 普通關鍵詞   │    │ 2. 調用 AI      │         │
│  │ 3. 生成回覆     │    │ 3. 概率選擇     │    │ 3. 返回回覆     │         │
│  │ 4. 發送消息     │    │                 │    │                 │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
│                                                        │                    │
│                                                        ▼                    │
│                                            ┌─────────────────┐              │
│                                            │ _execute_role_  │              │
│                                            │ response()      │              │
│                                            │                 │              │
│                                            │ 文字 or 語音?   │              │
│                                            └────────┬────────┘              │
│                                                     │                       │
└─────────────────────────────────────────────────────┼───────────────────────┘
                                                      │
                          ┌───────────────────────────┼───────────────────────┐
                          │                           │                       │
                          ▼                           ▼                       │
               ┌─────────────────┐         ┌─────────────────┐               │
               │ 文字回覆        │         │ 語音回覆        │               │
               │                 │         │                 │               │
               │ client.send_   │         │ tts_service.    │               │
               │ message()      │         │ generate_voice()│               │
               └─────────────────┘         │ + send_voice()  │               │
                                           └─────────────────┘               │
                                                                              │
                                           ┌─────────────────┐               │
                                           │ GPT-SoVITS      │               │
                                           │ 127.0.0.1:9880  │◀──────────────┘
                                           └─────────────────┘
```

---

## ⚠️ 注意事項

1. **帳號風險** - 設置合理的冷卻時間，避免頻繁發言被封禁
2. **TTS 服務** - 確保 GPT-SoVITS 在本地運行
3. **角色綁定** - 角色必須綁定 Telegram 帳號才能發送消息
4. **群組權限** - 帳號需要是群組成員才能發言

---

## 🔜 後續優化建議

1. **多輪對話策略** - 根據對話階段選擇不同角色
2. **情感分析** - 根據用戶情緒調整回覆風格
3. **A/B 測試** - 比較不同角色組合的轉化率
4. **自定義語音** - 支持每個角色使用不同的聲音

---

## 📝 更新日誌

### v1.2.0 (2026-01-21)
- ✅ 實現蜂群執行引擎
- ✅ 集成 GPT-SoVITS 語音服務
- ✅ 添加蜂群監控組件
- ✅ 實現關鍵詞→角色映射
- ✅ 添加內存鎖防止並發衝突
