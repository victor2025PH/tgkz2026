# TG-AI智控王 開發文檔

> **版本**: 2.1.1  
> **更新日期**: 2026年2月5日  
> **文檔類型**: 開發進度與技術架構

---

## 目錄

1. [項目概述](#1-項目概述)
2. [開發進度總覽](#2-開發進度總覽)
3. [技術架構](#3-技術架構)
4. [模塊結構](#4-模塊結構)
5. [版本歷程](#5-版本歷程)
6. [待優化與已知問題](#6-待優化與已知問題)

---

## 1. 項目概述

### 1.1 項目簡介

**TG-AI智控王** 是一款 AI 驅動的 Telegram 智能營銷自動化平台，支持 **桌面版 (Electron)** 與 **Web 版 (SaaS)** 雙模式運行。

### 1.2 核心技術棧

| 層級 | 技術 | 說明 |
|------|------|------|
| 前端 | Angular 21 | SPA 框架，獨立組件 |
| 前端構建 | Vite / Angular Build | 支持 development / production / saas 三種配置 |
| 桌面殼 | Electron 28 | 本地打包運行 |
| 後端 | Python 3.11 | aiohttp / asyncio 異步框架 |
| 通訊 | IPC (Electron) / HTTP + WebSocket (SaaS) | 雙模式適配 |
| 數據庫 | SQLite | 主數據存儲 |
| 緩存 | Redis | 可選，生產環境 |
| 部署 | Docker Compose | web(nginx) + api + redis |

### 1.3 運行模式

| 模式 | 入口 | API 通訊 | 適用場景 |
|------|------|----------|----------|
| Electron 桌面版 | `npm run start` | IPC | 本地安裝使用 |
| Web 開發版 | `npm run dev` | HTTP + WebSocket | 開發調試 |
| SaaS 生產版 | Nginx 靜態 + API | HTTP + WebSocket | 服務器部署 |

---

## 2. 開發進度總覽

### 2.1 已完成模塊

| 模塊 | 狀態 | 說明 |
|------|------|------|
| 帳號管理 | ✅ 完成 | 多帳號、QR/手機/Session 登錄、API 憑證 |
| 監控中心 | ✅ 完成 | 群組監控、關鍵詞集、觸發規則、聊天模板 |
| 用戶收集 | ✅ 完成 | 歷史消息收集、進階篩選 (v2.1.0 增強) |
| 潛在客戶 | ✅ 完成 | 線索管理、狀態跟進、批量操作 |
| 自動化中心 | ✅ 完成 | 活動、模板、觸發鏈 |
| 智能營銷 | ✅ 完成 | 營銷任務、角色協作、AI 文案 |
| AI 中心 | ✅ 完成 | 知識庫、模型配置、RAG |
| 多角色協作 | ✅ 完成 | 角色庫、腳本、蜂群營銷 |
| 資源發現 | ✅ 完成 | 群組搜索、成員提取 |
| 數據分析 | ✅ 完成 | 轉化漏斗、趨勢圖表 |
| 錢包系統 | ✅ 完成 | 充值、提現、訂單、USDT |
| 認證系統 | ✅ 完成 | 郵箱登錄、Telegram OAuth、JWT |
| 會員/配額 | ✅ 完成 | 訂閱等級、用量追蹤 |
| 管理後台 | ✅ 完成 | 審計、API 池、智能運維 |

### 2.2 前端模塊統計

| 目錄 | 組件/服務數 | 主要職責 |
|------|-------------|----------|
| views/ | 30+ | 頁面視圖 |
| services/ | 60+ | 業務邏輯、API 調用 |
| components/ | 29 | 通用組件 |
| auth/ | 9 | 認證、登錄、註冊 |
| group-search/ | 65 | 群組搜索與成員管理 |
| lead-nurturing/ | 24 | 潛在客戶培育 |
| multi-role/ | 17 | 多角色協作 |
| smart-marketing/ | 9 | 營銷任務中心 |
| admin/ | 14 | 管理後台 |
| dialogs/ | 6 | 彈窗組件 |

### 2.3 後端模塊統計

| 目錄/文件 | 職責 |
|-----------|------|
| api/ | HTTP 服務器、命令路由、中間件 |
| auth/ | JWT、OAuth、郵箱、設備會話 |
| wallet/ | 錢包、充值、提現、訂單、優惠券 |
| admin/ | 審計日誌、代理池、密碼策略 |
| domain/ | 領域模型 (accounts, ai, contacts, messaging) |
| core/ | 租戶、配額、計費、健康檢查等 |
| 根目錄 70+ 個 .py | AI、監控、消息隊列、分析等業務邏輯 |

---

## 3. 技術架構

### 3.1 整體架構

```
┌─────────────────────────────────────────────────────────────────────┐
│                         用戶端                                        │
├─────────────────────────────────────────────────────────────────────┤
│  Electron 桌面版              │  Web 瀏覽器 (SaaS)                    │
│  • Angular SPA               │  • Angular SPA                        │
│  • IPC 通訊                   │  • HTTP REST API                      │
│  • 內嵌 Python 後端           │  • WebSocket 實時事件                  │
└──────────────┬────────────────┴────────────────┬────────────────────┘
               │                                  │
               ▼                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      後端 API 層                                      │
├─────────────────────────────────────────────────────────────────────┤
│  api/http_server.py (完整)     │  fallback_server.py (降級)           │
│  • REST API                    │  • 基礎 HTTP                         │
│  • WebSocket                   │  • 限於部分路由                      │
│  • 認證 / 錢包 / 管理          │  • 當 http_server 導入失敗時啟用      │
└──────────────┬─────────────────────────────────┬────────────────────┘
               │                                  │
               ▼                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      業務邏輯層                                       │
├─────────────────────────────────────────────────────────────────────┤
│  CommandRouter │ Auth │ Wallet │ AI │ Monitoring │ MessageQueue       │
└──────────────┬──────────────────────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      數據層                                           │
├─────────────────────────────────────────────────────────────────────┤
│  SQLite (tgmatrix.db)  │  Redis  │  Chroma (RAG 向量庫)               │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 前後端通訊

**Electron 模式**
- 前端 ↔ 後端：`ElectronIpcService` 通過 IPC 通道
- 命令格式：`{ channel: string, payload: any }`

**Web/SaaS 模式**
- 前端 ↔ 後端：`ElectronIpcService` 自動切換為 HTTP + WebSocket
- API 基址：`window.location.origin` 或 `http://localhost:8000` (開發)
- 命令映射：`api-command-registry.ts` 映射 IPC 命令到 REST 端點

### 3.3 構建與部署

| 命令 | 用途 |
|------|------|
| `npm run build:saas` | SaaS 生產構建 |
| `npm run build:prod` | Electron 生產構建 |
| `npm run dev` | 前端開發服務 (port 4200) |
| `docker compose up -d` | 本地/服務器 Docker 部署 |
| GitHub Actions | 自動部署到 165.154.210.154 |

---

## 4. 模塊結構

### 4.1 路由與頁面

| 路徑 | 組件 | 守衛 | 說明 |
|------|------|------|------|
| /auth/* | auth.routes | - | 登錄、註冊、找回密碼等 |
| /dashboard | DashboardViewComponent | authGuard | 儀表板 |
| /accounts | AccountsViewComponent | authGuard | 帳號管理 |
| /monitoring | MonitoringViewComponent | - | 監控中心 |
| /leads | LeadsViewComponent | membershipGuard | 潛在客戶 |
| /automation | AutomationViewComponent | membershipGuard | 自動化中心 |
| /marketing-hub | SmartMarketingViewComponent | membershipGuard | 營銷任務中心 |
| /role-library | MultiRoleViewComponent | membershipGuard | 角色資源庫 |
| /ai-engine | AiCenterViewComponent | membershipGuard | 智能引擎 |
| /analytics | AnalyticsViewComponent | membershipGuard | 數據分析 |
| /resource-discovery | ResourceDiscoveryViewComponent | membershipGuard | 資源發現 |
| /wallet/* | Wallet*Component | authGuard | 錢包相關 |
| /billing, /payment, /upgrade | - | authGuard | 計費與升級 |

### 4.2 核心服務

| 服務 | 職責 |
|------|------|
| ElectronIpcService | 前後端通訊 (IPC/HTTP) |
| ApiClientService | 統一 API 請求封裝 |
| AuthService / UnifiedAuthService | 認證與 Token 管理 |
| ToastService | 全局提示 |
| TranslationService | 多語言 (繁/简/EN) |

---

## 5. 版本歷程

### v2.1.1 (當前)
- 構建修復：realtime-events 導入路徑、alert-notification invoke
- 部署驗證腳本

### v2.1.0 (2026-01-28)
- 歷史消息用戶收集增強（時間/活躍度篩選、快速模板）
- 群組詳情頁 UI 優化
- 後端 `get-history-collection-stats`、`collect-users-from-history-advanced` API
- 全功能版開放

### v2.0.0-beta.1
- 帳號管理、群組監控、AI 自動回覆
- 多角色協作、營銷自動化

---

## 6. 待優化與已知問題

### 6.1 已知問題

| 問題 | 影響 | 狀態 |
|------|------|------|
| SaaS 部署時 API 運行 fallback_server | 登錄頁顯示 "Not Found"，/api/v1/auth/me 等 404 | 待修 |
| http_server 導入失敗 | 需排查 wallet/admin/auth 等模塊導入錯誤 | 待修 |
| E2E 測試 baseURL 問題 | Playwright 部分環境 "Cannot navigate to invalid URL" | 低優先級 |
| Angular 單元測試未配置 | 無 test architect target | 可選 |

### 6.2 後續優化方向

- 修復 http_server 啟動，確保完整 API 可用
- 為 fallback_server 補充認證相關路由（臨時方案）
- 完善 E2E 與單元測試
- 性能與安全加固（見 `docs/性能優化與安全加固實施文檔.md`）

---

*文檔生成時間: 2026-02-05*
