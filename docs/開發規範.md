# TG-AIæ™ºæ§ç‹ é–‹ç™¼è¦ç¯„ï¼ˆå®Œæ•´ç‰ˆï¼‰

> æœ¬æ–‡æª”å®šç¾©äº† TG-AIæ™ºæ§ç‹ å°ˆæ¡ˆçš„é–‹ç™¼æ¨™æº–èˆ‡å¯©æŸ¥æ¡†æ¶ã€‚æ‰€æœ‰ä»£ç¢¼æäº¤å‰æ‡‰åƒç…§æœ¬è¦ç¯„é€²è¡Œè‡ªæŸ¥ã€‚

---

## ç›®éŒ„

1. [æŠ€è¡“æ£§æ¦‚è¦½](#æŠ€è¡“æ£§æ¦‚è¦½)
2. [å…«ç¶­æ·±åº¦å¯©æŸ¥æ¡†æ¶](#å…«ç¶­æ·±åº¦å¯©æŸ¥æ¡†æ¶)
3. [ä»£ç¢¼é¢¨æ ¼è¦ç¯„](#ä»£ç¢¼é¢¨æ ¼è¦ç¯„)
4. [è³‡æ–™åº«é–‹ç™¼è¦ç¯„](#è³‡æ–™åº«é–‹ç™¼è¦ç¯„)
5. [Telegram/Pyrogram é–‹ç™¼è¦ç¯„](#telegrampyrogram-é–‹ç™¼è¦ç¯„)
6. [å‰ç«¯é–‹ç™¼è¦ç¯„](#å‰ç«¯é–‹ç™¼è¦ç¯„)
7. [å¾Œç«¯é–‹ç™¼è¦ç¯„](#å¾Œç«¯é–‹ç™¼è¦ç¯„)
8. [å®‰å…¨è¦ç¯„](#å®‰å…¨è¦ç¯„)
9. [éŒ¯èª¤è™•ç†èˆ‡æ—¥èªŒ](#éŒ¯èª¤è™•ç†èˆ‡æ—¥èªŒ)
10. [æ¸¬è©¦è¦ç¯„](#æ¸¬è©¦è¦ç¯„)
11. [å·²çŸ¥å•é¡Œèˆ‡åœ°é›·å€](#å·²çŸ¥å•é¡Œèˆ‡åœ°é›·å€)
12. [æäº¤èˆ‡å¯©æŸ¥æµç¨‹](#æäº¤èˆ‡å¯©æŸ¥æµç¨‹)

---

## æŠ€è¡“æ£§æ¦‚è¦½

| å±¤ç´š | æŠ€è¡“ | ç‰ˆæœ¬ | èªªæ˜ |
|------|------|------|------|
| å‰ç«¯æ¡†æ¶ | Angular | 21.x | Standalone Components æ¨¡å¼ |
| å‰ç«¯èªè¨€ | TypeScript | 5.x | åš´æ ¼æ¨¡å¼ |
| æ¡Œé¢æ¡†æ¶ | Electron | 28.x | ä¸»é€²ç¨‹ + æ¸²æŸ“é€²ç¨‹ |
| å¾Œç«¯èªè¨€ | Python | 3.11+ | é¡å‹æç¤ºå¿…é ˆ |
| å¾Œç«¯æ¡†æ¶ | FastAPI | - | ç•°æ­¥å„ªå…ˆ |
| Telegram SDK | Pyrogram | 2.x | MTProto å”è­° |
| è³‡æ–™åº« | SQLite | 3.x | é›™åº«æ¶æ§‹ |
| é€²ç¨‹é€šè¨Š | stdin/stdout | JSON | Electron â†” Python |

### è³‡æ–™åº«æ¶æ§‹

```
backend/data/
â”œâ”€â”€ tgmatrix.db      # å¸³è™Ÿç®¡ç†ã€ç¾¤çµ„ã€æ¶ˆæ¯ç­‰æ ¸å¿ƒæ¥­å‹™æ•¸æ“š
â””â”€â”€ tgai_server.db   # ç”¨æˆ¶ç³»çµ±ã€æœƒå“¡ã€é…é¡ã€æˆæ¬Šç­‰
```

---

## å…«ç¶­æ·±åº¦å¯©æŸ¥æ¡†æ¶

æ¯æ¬¡é–‹ç™¼æˆ–å¯©æŸ¥ä»£ç¢¼æ™‚ï¼Œæ‡‰å¾ä»¥ä¸‹å…«å€‹ç¶­åº¦é€²è¡Œæª¢æŸ¥ï¼š

### 1. ğŸ’ UI/UX èˆ‡è¨­è¨ˆè¦–è§’ (Priority: High)

#### æª¢æŸ¥é …ç›®

- [ ] **è¦–è¦ºä¸€è‡´æ€§**ï¼šæ–°å¢ UI æ˜¯å¦ç¬¦åˆç¾æœ‰è¨­è¨ˆç³»çµ±ï¼Ÿ
  - é¡è‰²ï¼šä½¿ç”¨ CSS è®Šé‡æˆ– Tailwind é è¨­é¡
  - é–“è·ï¼šéµå¾ª 4px/8px ç¶²æ ¼ç³»çµ±
  - å­—é«”ï¼šä½¿ç”¨ç³»çµ±å®šç¾©çš„å­—é«”å±¤ç´š

- [ ] **åé¥‹æ©Ÿåˆ¶**ï¼šæ¯å€‹ç”¨æˆ¶æ“ä½œæ˜¯å¦æœ‰æ˜ç¢ºåé¥‹ï¼Ÿ
  - æŒ‰éˆ•é»æ“Šï¼šLoading ç‹€æ…‹ + ç¦ç”¨é˜²é‡è¤‡é»æ“Š
  - è¡¨å–®æäº¤ï¼šæˆåŠŸ/å¤±æ•— Toast é€šçŸ¥
  - é•·æ™‚é–“æ“ä½œï¼šé€²åº¦æŒ‡ç¤ºå™¨

- [ ] **ç©ºç‹€æ…‹èˆ‡é‚Šç•Œ**
  - åˆ—è¡¨ç‚ºç©ºï¼šé¡¯ç¤ºç©ºç‹€æ…‹æ’åœ– + å¼•å°æ–‡æ¡ˆ
  - æ–‡æœ¬éé•·ï¼šä½¿ç”¨ `text-ellipsis` æˆªæ–· + `title` æ‡¸åœé¡¯ç¤ºå®Œæ•´
  - åœ–ç‰‡åŠ è¼‰å¤±æ•—ï¼šé¡¯ç¤ºå ä½åœ–

- [ ] **æ¨‚è§€ UI (Optimistic UI)**
  - åˆªé™¤æ“ä½œï¼šå…ˆç§»é™¤ UIï¼Œå¤±æ•—å¾Œå›æ»¾
  - ç‹€æ…‹åˆ‡æ›ï¼šå…ˆæ›´æ–°æœ¬åœ°ç‹€æ…‹ï¼Œå¾Œç«¯ç¢ºèªå¾ŒåŒæ­¥

#### å¸¸è¦‹å•é¡Œ

```typescript
// âŒ éŒ¯èª¤ï¼šæ²’æœ‰ Loading ç‹€æ…‹
async onSubmit() {
  await this.api.save(this.data);
}

// âœ… æ­£ç¢ºï¼šå®Œæ•´çš„ç‹€æ…‹ç®¡ç†
async onSubmit() {
  this.isLoading = true;
  try {
    await this.api.save(this.data);
    this.toast.success('ä¿å­˜æˆåŠŸ');
  } catch (e) {
    this.toast.error('ä¿å­˜å¤±æ•—ï¼š' + e.message);
  } finally {
    this.isLoading = false;
  }
}
```

---

### 2. ğŸ’¾ è³‡æ–™åº«èˆ‡æ•¸æ“šå®Œæ•´æ€§ (Priority: High)

#### æª¢æŸ¥é …ç›®

- [ ] **Schema è¨­è¨ˆ**
  - å­—æ®µé¡å‹æ˜¯å¦æº–ç¢ºï¼Ÿï¼ˆINTEGER vs TEXT, BOOLEAN vs INTEGERï¼‰
  - æ˜¯å¦éœ€è¦ç´¢å¼•å„ªåŒ–æŸ¥è©¢ï¼Ÿ
  - å¤–éµç´„æŸæ˜¯å¦æ­£ç¢ºè¨­ç½®ï¼Ÿ
  - æ˜¯å¦æœ‰ `created_at`, `updated_at` æ™‚é–“æˆ³ï¼Ÿ

- [ ] **æŸ¥è©¢æ€§èƒ½**
  - æ˜¯å¦å­˜åœ¨ N+1 å•é¡Œï¼Ÿ
  - å¤§æ•¸æ“šé‡æŸ¥è©¢æ˜¯å¦æœ‰åˆ†é ï¼Ÿ
  - è¤‡é›œæŸ¥è©¢æ˜¯å¦éœ€è¦è¦–åœ–æˆ–é è¨ˆç®—ï¼Ÿ

- [ ] **æ•¸æ“šä¸€è‡´æ€§**
  - å¤šè¡¨æ›´æ–°æ˜¯å¦ä½¿ç”¨äº‹å‹™ï¼Ÿ
  - åˆªé™¤æ“ä½œæ˜¯å¦è™•ç†é—œè¯æ•¸æ“šï¼Ÿ
  - ä¸¦ç™¼å¯«å…¥æ˜¯å¦æœ‰é–æ©Ÿåˆ¶ï¼Ÿ

- [ ] **é·ç§»å®‰å…¨**
  - æ–°å­—æ®µæ˜¯å¦æœ‰é»˜èªå€¼ï¼Ÿ
  - æ˜¯å¦å…¼å®¹ç¾æœ‰æ•¸æ“šï¼Ÿ
  - æ˜¯å¦æœ‰å›æ»¾æ–¹æ¡ˆï¼Ÿ

#### N+1 å•é¡Œç¤ºä¾‹

```python
# âŒ éŒ¯èª¤ï¼šN+1 æŸ¥è©¢
accounts = db.get_all_accounts()
for account in accounts:
    groups = db.get_groups_by_account(account['id'])  # N æ¬¡æŸ¥è©¢ï¼

# âœ… æ­£ç¢ºï¼šJOIN æŸ¥è©¢
accounts_with_groups = db.execute("""
    SELECT a.*, GROUP_CONCAT(g.name) as group_names
    FROM accounts a
    LEFT JOIN account_groups ag ON a.id = ag.account_id
    LEFT JOIN groups g ON ag.group_id = g.id
    GROUP BY a.id
""")
```

#### äº‹å‹™ä½¿ç”¨ç¤ºä¾‹

```python
# âœ… æ­£ç¢ºï¼šä½¿ç”¨äº‹å‹™ä¿è­‰ä¸€è‡´æ€§
def transfer_credits(from_user, to_user, amount):
    with db.get_connection() as conn:
        cursor = conn.cursor()
        try:
            cursor.execute("UPDATE users SET credits = credits - ? WHERE id = ?", 
                          (amount, from_user))
            cursor.execute("UPDATE users SET credits = credits + ? WHERE id = ?", 
                          (amount, to_user))
            cursor.execute("INSERT INTO transfer_logs (...) VALUES (...)")
            conn.commit()
        except Exception as e:
            conn.rollback()
            raise
```

---

### 3. âš™ï¸ åŠŸèƒ½èˆ‡é‚è¼¯è¦–è§’ (Priority: High)

#### æª¢æŸ¥é …ç›®

- [ ] **æ¥­å‹™é–‰ç’°**
  - ä»£ç¢¼æ˜¯å¦å®Œæ•´å¯¦ç¾éœ€æ±‚ï¼Ÿ
  - ç‹€æ…‹æµè½‰æ˜¯å¦æ­£ç¢ºï¼Ÿï¼ˆå¦‚ï¼špending â†’ processing â†’ completed/failedï¼‰
  - é‚Šç•Œæ¢ä»¶æ˜¯å¦è™•ç†ï¼Ÿ

- [ ] **é­¯æ£’æ€§**
  - API è¿”å›ç©ºå€¼æ™‚æœƒå´©æ½°å—ï¼Ÿ
  - ç¶²çµ¡è¶…æ™‚å¦‚ä½•è™•ç†ï¼Ÿ
  - ç”¨æˆ¶è¼¸å…¥ç•°å¸¸æ•¸æ“šæœƒæ€æ¨£ï¼Ÿ

- [ ] **ç‹€æ…‹ç®¡ç†**
  - å‰ç«¯ç‹€æ…‹æ›´æ–°æ˜¯å¦æº–ç¢ºï¼Ÿ
  - æ˜¯å¦å­˜åœ¨ä¸å¿…è¦çš„é‡æ¸²æŸ“ï¼Ÿ
  - çµ„ä»¶éŠ·æ¯€æ™‚æ˜¯å¦æ¸…ç†è¨‚é–±ï¼Ÿ

#### ç‹€æ…‹æ©Ÿç¤ºä¾‹

```typescript
// å¸³è™Ÿç‹€æ…‹æµè½‰
type AccountStatus = 
  | 'offline'      // é›¢ç·š
  | 'connecting'   // é€£æ¥ä¸­
  | 'verifying'    // é©—è­‰ä¸­ï¼ˆç­‰å¾…é©—è­‰ç¢¼ï¼‰
  | 'online'       // åœ¨ç·š
  | 'error'        // éŒ¯èª¤
  | 'banned';      // è¢«å°ç¦

// åˆæ³•çš„ç‹€æ…‹è½‰æ›
const validTransitions: Record<AccountStatus, AccountStatus[]> = {
  'offline': ['connecting'],
  'connecting': ['verifying', 'online', 'error'],
  'verifying': ['online', 'error', 'offline'],
  'online': ['offline', 'error', 'banned'],
  'error': ['offline', 'connecting'],
  'banned': ['offline']
};
```

---

### 4. ğŸŸ¢ ä»£ç¢¼è³ªé‡è¦–è§’ (Priority: Medium)

#### æª¢æŸ¥é …ç›®

- [ ] **å¯è®€æ€§**
  - è®Šé‡å‘½åæ˜¯å¦èªç¾©åŒ–ï¼Ÿ
  - è¤‡é›œé‚è¼¯æ˜¯å¦æœ‰è¨»é‡‹è§£é‡‹ "Why"ï¼Ÿ
  - å‡½æ•¸æ˜¯å¦éé•·ï¼Ÿï¼ˆå»ºè­° < 50 è¡Œï¼‰

- [ ] **è§£è€¦**
  - UI å±¤ã€é‚è¼¯å±¤ã€æ•¸æ“šå±¤æ˜¯å¦åˆ†é›¢ï¼Ÿ
  - å–®å€‹æ–‡ä»¶æ˜¯å¦éå¤§ï¼Ÿï¼ˆå»ºè­° < 500 è¡Œï¼‰
  - æ˜¯å¦æœ‰é‡è¤‡ä»£ç¢¼å¯æå–ï¼Ÿ

- [ ] **é¡å‹å®‰å…¨**
  - TypeScript æ˜¯å¦ä½¿ç”¨åš´æ ¼é¡å‹ï¼Ÿ
  - Python æ˜¯å¦æ·»åŠ é¡å‹æç¤ºï¼Ÿ
  - æ˜¯å¦é¿å…ä½¿ç”¨ `any` å’Œ `# type: ignore`ï¼Ÿ

#### å‘½åè¦ç¯„

| é¡å‹ | Python | TypeScript | è³‡æ–™åº« |
|------|--------|------------|--------|
| è®Šé‡/å‡½æ•¸ | `snake_case` | `camelCase` | `snake_case` |
| é¡/çµ„ä»¶ | `PascalCase` | `PascalCase` | - |
| å¸¸é‡ | `UPPER_SNAKE` | `UPPER_SNAKE` | - |
| ç§æœ‰æˆå“¡ | `_prefix` | `private` é—œéµå­— | - |

#### è¨»é‡‹è¦ç¯„

```python
# âŒ éŒ¯èª¤ï¼šæè¿° What
# å¢åŠ è¨ˆæ•¸å™¨
counter += 1

# âœ… æ­£ç¢ºï¼šè§£é‡‹ Why
# é‡è©¦è¨ˆæ•¸ï¼Œè¶…é 3 æ¬¡å¾Œæ”¾æ£„ä¸¦é€šçŸ¥ç”¨æˆ¶
retry_count += 1
```

---

### 5. ğŸ›¡ï¸ å®‰å…¨è¦–è§’ (Priority: High)

#### æª¢æŸ¥é …ç›®

- [ ] **æ¬Šé™æ§åˆ¶**
  - ç•¶å‰ç”¨æˆ¶æ˜¯å¦æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œï¼Ÿ
  - æ˜¯å¦å­˜åœ¨ IDORï¼ˆä¸å®‰å…¨çš„ç›´æ¥å°è±¡å¼•ç”¨ï¼‰æ¼æ´ï¼Ÿ
  - API ç«¯é»æ˜¯å¦é©—è­‰èº«ä»½ï¼Ÿ

- [ ] **è¼¸å…¥é©—è­‰**
  - æ‰€æœ‰è¼¸å…¥æ˜¯å¦ç¶“éé©—è­‰å’Œæ¸…æ´—ï¼Ÿ
  - SQL æŸ¥è©¢æ˜¯å¦ä½¿ç”¨åƒæ•¸åŒ–ï¼Ÿ
  - æ˜¯å¦é˜²ç¯„ XSS æ”»æ“Šï¼Ÿ

- [ ] **æ•æ„Ÿæ•¸æ“š**
  - API_ID/API_HASH æ˜¯å¦ç¡¬ç·¨ç¢¼ï¼Ÿï¼ˆç¦æ­¢ï¼ï¼‰
  - Session æ–‡ä»¶æ˜¯å¦å¦¥å–„ä¿è­·ï¼Ÿ
  - æ—¥èªŒæ˜¯å¦æ´©éœ²æ•æ„Ÿä¿¡æ¯ï¼Ÿ

#### è¼¸å…¥é©—è­‰ç¤ºä¾‹

```python
from validators import validate_account, ValidationError

# âœ… ä½¿ç”¨é …ç›®çš„é©—è­‰å™¨
def add_account(phone: str, api_id: int, api_hash: str):
    try:
        validated = validate_account({
            'phone': phone,
            'api_id': api_id,
            'api_hash': api_hash
        })
    except ValidationError as e:
        return {"success": False, "error": str(e)}
    
    # ç¹¼çºŒè™•ç†...
```

---

### 6. ğŸŸ£ é‹ç¶­èˆ‡æ€§èƒ½è¦–è§’ (Priority: Medium)

#### æª¢æŸ¥é …ç›®

- [ ] **éŒ¯èª¤è¿½è¹¤**
  - é—œéµéŒ¯èª¤æ˜¯å¦è¨˜éŒ„è¶³å¤ çš„ä¸Šä¸‹æ–‡ï¼Ÿ
  - æ˜¯å¦ä½¿ç”¨çµ±ä¸€çš„éŒ¯èª¤è™•ç†ï¼Ÿ
  - ç”¨æˆ¶æ˜¯å¦èƒ½çœ‹åˆ°å‹å¥½çš„éŒ¯èª¤æç¤ºï¼Ÿ

- [ ] **è³‡æºç®¡ç†**
  - æ˜¯å¦å­˜åœ¨å…§å­˜æ´©æ¼ï¼Ÿ
  - æ•¸æ“šåº«é€£æ¥æ˜¯å¦æ­£ç¢ºé—œé–‰ï¼Ÿ
  - æ–‡ä»¶å¥æŸ„æ˜¯å¦é‡‹æ”¾ï¼Ÿ

- [ ] **æ€§èƒ½è€ƒé‡**
  - æ˜¯å¦æœ‰ä¸å¿…è¦çš„é‡è¤‡è¨ˆç®—ï¼Ÿ
  - å¤§æ•¸æ“šæ˜¯å¦ä½¿ç”¨åˆ†é æˆ–è™›æ“¬æ»¾å‹•ï¼Ÿ
  - æ˜¯å¦éœ€è¦ç·©å­˜ï¼Ÿ

#### è³‡æºæ¸…ç†ç¤ºä¾‹

```python
# âœ… æ­£ç¢ºï¼šä½¿ç”¨ context manager ç¢ºä¿è³‡æºé‡‹æ”¾
async def process_file(path: str):
    async with aiofiles.open(path) as f:
        content = await f.read()
    # æ–‡ä»¶è‡ªå‹•é—œé–‰

# âœ… æ­£ç¢ºï¼šç¢ºä¿ Telegram å®¢æˆ¶ç«¯æ–·é–‹
async def send_message(account_id: int, chat_id: int, text: str):
    client = None
    try:
        client = await get_client(account_id)
        await client.send_message(chat_id, text)
    finally:
        if client:
            await client.disconnect()
```

---

### 7. ğŸ”´ æ¸¬è©¦èˆ‡é‚Šç•Œæƒ…æ³è¦–è§’ (Priority: Medium)

#### æª¢æŸ¥é …ç›®

- [ ] **æ¥µç«¯æƒ…æ³**
  - ä¸¦ç™¼æ“ä½œæœƒæ€æ¨£ï¼Ÿ
  - æ–·ç¶²é‡é€£æœƒæ€æ¨£ï¼Ÿ
  - æ•¸æ“šç‚ºç©ºæœƒæ€æ¨£ï¼Ÿ
  - æ•¸æ“šé‡æ¥µå¤§æœƒæ€æ¨£ï¼Ÿ

- [ ] **éŒ¯èª¤æ¢å¾©**
  - æ“ä½œå¤±æ•—å¾Œèƒ½å¦é‡è©¦ï¼Ÿ
  - ä¸­æ–·çš„æ“ä½œèƒ½å¦æ¢å¾©ï¼Ÿ
  - æ˜¯å¦æœ‰äº‹å‹™å›æ»¾æ©Ÿåˆ¶ï¼Ÿ

#### æ¸¬è©¦å ´æ™¯æ¸…å–®

æ¯å€‹åŠŸèƒ½æ‡‰è€ƒæ…®ä»¥ä¸‹å ´æ™¯ï¼š

| å ´æ™¯é¡å‹ | æ¸¬è©¦é» |
|----------|--------|
| æ­£å¸¸æµç¨‹ | é æœŸè¼¸å…¥ï¼Œé æœŸè¼¸å‡º |
| ç©ºå€¼è™•ç† | null, undefined, ç©ºå­—ç¬¦ä¸², ç©ºæ•¸çµ„ |
| é‚Šç•Œå€¼ | 0, -1, MAX_INT, è¶…é•·å­—ç¬¦ä¸² |
| ä¸¦ç™¼ | åŒæ™‚æ“ä½œåŒä¸€è³‡æº |
| ç¶²çµ¡ç•°å¸¸ | è¶…æ™‚ã€æ–·ç·šã€éŒ¯èª¤éŸ¿æ‡‰ |
| æ¬Šé™ | ç„¡æ¬Šé™ç”¨æˆ¶å˜—è©¦æ“ä½œ |
| é…é¡ | è¶…å‡ºé™åˆ¶æ™‚çš„è¡Œç‚º |

---

### 8. ğŸ’° å•†æ¥­åƒ¹å€¼è¦–è§’ (Priority: Low)

#### æª¢æŸ¥é …ç›®

- [ ] **å¯æ“´å±•æ€§**
  - è¨­è¨ˆæ˜¯å¦ç‚ºæœªä¾†éœ€æ±‚ç•™æœ‰é¤˜åœ°ï¼Ÿ
  - æ˜¯å¦å®¹æ˜“æ·»åŠ æ–°åŠŸèƒ½ï¼Ÿ
  - æ˜¯å¦å®¹æ˜“ä¿®æ”¹ç¾æœ‰é‚è¼¯ï¼Ÿ

- [ ] **å¯ç¶­è­·æ€§**
  - å…¶ä»–é–‹ç™¼è€…èƒ½å¦ç†è§£æ­¤ä»£ç¢¼ï¼Ÿ
  - æ˜¯å¦æœ‰è¶³å¤ çš„æ–‡æª”ï¼Ÿ
  - æ˜¯å¦éµå¾ªé …ç›®ç¾æœ‰æ¨¡å¼ï¼Ÿ

---

## ä»£ç¢¼é¢¨æ ¼è¦ç¯„

### Python

```python
"""
æ¨¡å¡Šæ–‡æª”å­—ç¬¦ä¸²ï¼šæè¿°æ¨¡å¡Šç”¨é€”
"""
from typing import Dict, List, Optional
from datetime import datetime

# å¸¸é‡å®šç¾©
MAX_RETRY_COUNT = 3
DEFAULT_TIMEOUT = 30

class AccountManager:
    """å¸³è™Ÿç®¡ç†å™¨ï¼šè™•ç†å¸³è™Ÿçš„é€£æ¥ã€æ–·é–‹å’Œç‹€æ…‹ç®¡ç†"""
    
    def __init__(self, db: Database):
        self._db = db
        self._clients: Dict[int, Client] = {}
    
    async def connect_account(
        self, 
        account_id: int, 
        *, 
        force: bool = False
    ) -> Optional[Client]:
        """
        é€£æ¥å¸³è™Ÿ
        
        Args:
            account_id: å¸³è™Ÿ ID
            force: æ˜¯å¦å¼·åˆ¶é‡é€£
            
        Returns:
            é€£æ¥æˆåŠŸè¿”å› Clientï¼Œå¤±æ•—è¿”å› None
            
        Raises:
            ConnectionError: é€£æ¥å¤±æ•—æ™‚æ‹‹å‡º
        """
        pass
```

### TypeScript

```typescript
/**
 * å¸³è™Ÿæœå‹™ï¼šè™•ç†å¸³è™Ÿç›¸é—œçš„ API èª¿ç”¨
 */
@Injectable({ providedIn: 'root' })
export class AccountService {
  private readonly api = inject(ApiService);
  private readonly toast = inject(ToastService);
  
  /** ç•¶å‰é¸ä¸­çš„å¸³è™Ÿ */
  readonly selectedAccount = signal<Account | null>(null);
  
  /** å¸³è™Ÿåˆ—è¡¨ */
  readonly accounts = signal<Account[]>([]);
  
  /**
   * ç²å–å¸³è™Ÿåˆ—è¡¨
   * @param options æŸ¥è©¢é¸é …
   * @returns å¸³è™Ÿåˆ—è¡¨
   */
  async getAccounts(options?: GetAccountsOptions): Promise<Account[]> {
    // å¯¦ç¾...
  }
}
```

---

## è³‡æ–™åº«é–‹ç™¼è¦ç¯„

### è¡¨è¨­è¨ˆè¦ç¯„

```sql
-- âœ… æ¨™æº–è¡¨çµæ§‹
CREATE TABLE IF NOT EXISTS resources (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    telegram_id INTEGER UNIQUE,           -- Telegram å¯¦é«” ID
    type TEXT NOT NULL DEFAULT 'group',   -- é¡å‹ï¼šgroup/channel/user
    username TEXT,                         -- ç”¨æˆ¶åï¼ˆå¯ç©ºï¼‰
    title TEXT NOT NULL,                   -- æ¨™é¡Œ
    status TEXT DEFAULT 'active',          -- ç‹€æ…‹
    metadata TEXT,                         -- JSON æ“´å±•å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•ï¼šæ ¹æ“šæŸ¥è©¢æ¨¡å¼å‰µå»º
CREATE INDEX IF NOT EXISTS idx_resources_type ON resources(type);
CREATE INDEX IF NOT EXISTS idx_resources_status ON resources(status);
CREATE INDEX IF NOT EXISTS idx_resources_telegram_id ON resources(telegram_id);
```

### æŸ¥è©¢è¦ç¯„

```python
# âœ… åƒæ•¸åŒ–æŸ¥è©¢ï¼ˆé˜² SQL æ³¨å…¥ï¼‰
cursor.execute(
    "SELECT * FROM accounts WHERE phone = ? AND status = ?",
    (phone, status)
)

# âœ… åˆ†é æŸ¥è©¢
def get_resources(limit: int = 100, offset: int = 0) -> Dict:
    cursor.execute(
        "SELECT COUNT(*) FROM resources WHERE status = 'active'"
    )
    total = cursor.fetchone()[0]
    
    cursor.execute(
        """SELECT * FROM resources 
           WHERE status = 'active' 
           ORDER BY created_at DESC 
           LIMIT ? OFFSET ?""",
        (limit, offset)
    )
    items = cursor.fetchall()
    
    return {
        "items": items,
        "total": total,
        "limit": limit,
        "offset": offset,
        "has_more": offset + len(items) < total
    }
```

---

## Telegram/Pyrogram é–‹ç™¼è¦ç¯„

### æ ¸å¿ƒåŸå‰‡

1. **æ‰€æœ‰ API èª¿ç”¨å¿…é ˆè™•ç† FloodWait**
2. **Session æ–‡ä»¶æ“ä½œå¿…é ˆé˜²æ­¢é–å®š**
3. **å¸³è™Ÿæ“ä½œå‰å¿…é ˆé©—è­‰é€£æ¥ç‹€æ…‹**

### FloodWait è™•ç†

```python
from flood_wait_handler import safe_telegram_call

# âœ… æ­£ç¢ºï¼šä½¿ç”¨å®‰å…¨åŒ…è£å™¨
async def send_message(client, chat_id: int, text: str):
    result = await safe_telegram_call(
        client.send_message,
        chat_id,
        text,
        max_retries=3,
        base_delay=1.0
    )
    return result

# âŒ éŒ¯èª¤ï¼šç›´æ¥èª¿ç”¨ï¼Œä¸è™•ç† FloodWait
async def send_message_bad(client, chat_id: int, text: str):
    return await client.send_message(chat_id, text)  # å¯èƒ½æ‹‹å‡º FloodWaitï¼
```

### Session æ–‡ä»¶è™•ç†

```python
import asyncio
from pathlib import Path

async def safe_session_operation(session_path: Path, operation):
    """å®‰å…¨çš„ Session æ–‡ä»¶æ“ä½œ"""
    lock_path = session_path.with_suffix('.lock')
    
    # ç­‰å¾…é–é‡‹æ”¾
    for _ in range(10):
        if not lock_path.exists():
            break
        await asyncio.sleep(0.5)
    else:
        raise RuntimeError(f"Session æ–‡ä»¶è¢«é–å®š: {session_path}")
    
    try:
        # å‰µå»ºé–æ–‡ä»¶
        lock_path.touch()
        return await operation()
    finally:
        # ç¢ºä¿é‡‹æ”¾é–
        if lock_path.exists():
            lock_path.unlink()
```

### å¸³è™Ÿé€£æ¥ç‹€æ…‹æª¢æŸ¥

```python
async def ensure_connected(account_id: int) -> Client:
    """ç¢ºä¿å¸³è™Ÿå·²é€£æ¥"""
    client = self._clients.get(account_id)
    
    if client is None:
        raise AccountNotFoundError(f"å¸³è™Ÿ {account_id} ä¸å­˜åœ¨")
    
    if not client.is_connected:
        # å˜—è©¦é‡é€£
        try:
            await client.connect()
        except Exception as e:
            raise ConnectionError(f"å¸³è™Ÿ {account_id} é€£æ¥å¤±æ•—: {e}")
    
    return client
```

---

## å‰ç«¯é–‹ç™¼è¦ç¯„

### çµ„ä»¶çµæ§‹

```typescript
@Component({
  selector: 'app-account-list',
  standalone: true,
  imports: [CommonModule, FormsModule],
  template: `
    <!-- Loading ç‹€æ…‹ -->
    @if (isLoading()) {
      <div class="loading-spinner">è¼‰å…¥ä¸­...</div>
    }
    
    <!-- ç©ºç‹€æ…‹ -->
    @if (!isLoading() && accounts().length === 0) {
      <div class="empty-state">
        <img src="/assets/empty.svg" alt="ç„¡æ•¸æ“š">
        <p>å°šæœªæ·»åŠ å¸³è™Ÿ</p>
        <button (click)="onAddAccount()">æ·»åŠ å¸³è™Ÿ</button>
      </div>
    }
    
    <!-- åˆ—è¡¨ -->
    @for (account of accounts(); track account.id) {
      <app-account-card [account]="account" />
    }
  `
})
export class AccountListComponent {
  private readonly accountService = inject(AccountService);
  
  readonly accounts = this.accountService.accounts;
  readonly isLoading = signal(false);
  
  // ...
}
```

### Track è¡¨é”å¼è¦ç¯„

```typescript
// âŒ éŒ¯èª¤ï¼šå¯èƒ½ç”¢ç”Ÿé‡è¤‡éµï¼ˆNG0955ï¼‰
@for (item of items(); track item.telegram_id || item.id) {
  // telegram_id å’Œ id éƒ½å¯èƒ½ç‚º null
}

// âœ… æ­£ç¢ºï¼šç¢ºä¿å”¯ä¸€æ€§
@for (item of items(); track trackByUniqueId(item, $index)) {
  // ...
}

// è¿½è¹¤å‡½æ•¸
trackByUniqueId(item: Resource, index: number): string {
  return `${item.id ?? 'new'}-${item.telegram_id ?? index}-${item.type}`;
}
```

### API èª¿ç”¨è¦ç¯„

```typescript
async loadAccounts(): Promise<void> {
  this.isLoading.set(true);
  this.error.set(null);
  
  try {
    const response = await this.api.getAccounts();
    
    if (!response.success) {
      throw new Error(response.error || 'æœªçŸ¥éŒ¯èª¤');
    }
    
    this.accounts.set(response.data ?? []);
  } catch (e) {
    const message = e instanceof Error ? e.message : 'è¼‰å…¥å¤±æ•—';
    this.error.set(message);
    this.toast.error(message);
  } finally {
    this.isLoading.set(false);
  }
}
```

---

## å¾Œç«¯é–‹ç™¼è¦ç¯„

### API éŸ¿æ‡‰æ ¼å¼

```python
from typing import TypedDict, Any, Optional

class ApiResponse(TypedDict):
    success: bool
    data: Optional[Any]
    error: Optional[str]

def success_response(data: Any = None) -> ApiResponse:
    return {"success": True, "data": data, "error": None}

def error_response(message: str) -> ApiResponse:
    return {"success": False, "data": None, "error": message}

# ä½¿ç”¨ç¤ºä¾‹
async def handle_get_accounts(params: dict) -> ApiResponse:
    try:
        accounts = await db.get_accounts(**params)
        return success_response(accounts)
    except ValidationError as e:
        return error_response(f"åƒæ•¸éŒ¯èª¤: {e}")
    except Exception as e:
        logger.exception("ç²å–å¸³è™Ÿåˆ—è¡¨å¤±æ•—")
        return error_response(f"å…§éƒ¨éŒ¯èª¤: {e}")
```

### å‘½ä»¤è™•ç†æ¨¡å¼

```python
class BackendService:
    """å¾Œç«¯æœå‹™"""
    
    def __init__(self):
        self._handlers: Dict[str, Callable] = {
            'get_accounts': self.handle_get_accounts,
            'add_account': self.handle_add_account,
            'delete_account': self.handle_delete_account,
            # ...
        }
    
    async def handle_command(self, command: str, params: dict) -> ApiResponse:
        handler = self._handlers.get(command)
        
        if handler is None:
            return error_response(f"æœªçŸ¥å‘½ä»¤: {command}")
        
        try:
            return await handler(params)
        except Exception as e:
            logger.exception(f"å‘½ä»¤åŸ·è¡Œå¤±æ•—: {command}")
            return error_response(str(e))
```

---

## å®‰å…¨è¦ç¯„

### ç¦æ­¢äº‹é …

| é¡åˆ¥ | ç¦æ­¢è¡Œç‚º | æ­£ç¢ºåšæ³• |
|------|----------|----------|
| æ†‘è­‰ | ç¡¬ç·¨ç¢¼ API_ID/API_HASH | å¾ config è®€å– |
| SQL | å­—ç¬¦ä¸²æ‹¼æ¥æŸ¥è©¢ | åƒæ•¸åŒ–æŸ¥è©¢ |
| æ—¥èªŒ | è¨˜éŒ„å®Œæ•´ session å…§å®¹ | åªè¨˜éŒ„æ–‡ä»¶å/ID |
| å‰ç«¯ | å­˜å„²æ•æ„Ÿæ†‘è­‰ | åƒ…å­˜å„² token |
| æ¬Šé™ | ä¿¡ä»»å‰ç«¯å‚³ä¾†çš„ user_id | å¾Œç«¯é©—è­‰ session |

### è¼¸å…¥é©—è­‰æ¸…å–®

```python
# æ‰‹æ©Ÿè™Ÿç¢¼
def validate_phone(phone: str) -> str:
    phone = phone.strip().replace(' ', '').replace('-', '')
    if not phone.startswith('+'):
        phone = '+' + phone
    if not re.match(r'^\+\d{7,15}$', phone):
        raise ValidationError("ç„¡æ•ˆçš„æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼")
    return phone

# Telegram ç”¨æˆ¶å
def validate_username(username: str) -> str:
    username = username.strip().lstrip('@')
    if not re.match(r'^[a-zA-Z][a-zA-Z0-9_]{4,31}$', username):
        raise ValidationError("ç„¡æ•ˆçš„ç”¨æˆ¶åæ ¼å¼")
    return username

# ç¾¤çµ„ URL
def validate_group_url(url: str) -> str:
    patterns = [
        r'^https?://t\.me/([a-zA-Z][a-zA-Z0-9_]{4,31})$',
        r'^https?://t\.me/joinchat/([a-zA-Z0-9_-]+)$',
        r'^@([a-zA-Z][a-zA-Z0-9_]{4,31})$'
    ]
    for pattern in patterns:
        if re.match(pattern, url):
            return url
    raise ValidationError("ç„¡æ•ˆçš„ç¾¤çµ„é€£çµæ ¼å¼")
```

---

## éŒ¯èª¤è™•ç†èˆ‡æ—¥èªŒ

### æ—¥èªŒç´šåˆ¥è¦ç¯„

| ç´šåˆ¥ | ä½¿ç”¨å ´æ™¯ | ç¤ºä¾‹ |
|------|----------|------|
| DEBUG | é–‹ç™¼èª¿è©¦ä¿¡æ¯ | è®Šé‡å€¼ã€æµç¨‹è¿½è¹¤ |
| INFO | æ­£å¸¸æ¥­å‹™æ“ä½œ | å¸³è™Ÿç™»éŒ„ã€æ¶ˆæ¯ç™¼é€ |
| WARNING | å¯æ¢å¾©çš„å•é¡Œ | é‡è©¦ã€é™ç´š |
| ERROR | éœ€è¦é—œæ³¨çš„éŒ¯èª¤ | API å¤±æ•—ã€æ•¸æ“šç•°å¸¸ |
| CRITICAL | ç³»çµ±ç´šæ•…éšœ | æ•¸æ“šåº«é€£æ¥å¤±æ•— |

### æ—¥èªŒæ ¼å¼

```python
import logging

logger = logging.getLogger(__name__)

# âœ… æ­£ç¢ºï¼šåŒ…å«è¶³å¤ ä¸Šä¸‹æ–‡
logger.error(
    "ç™¼é€æ¶ˆæ¯å¤±æ•—",
    extra={
        "account_id": account_id,
        "chat_id": chat_id,
        "error_type": type(e).__name__,
        "error_message": str(e)
    }
)

# âŒ éŒ¯èª¤ï¼šä¸Šä¸‹æ–‡ä¸è¶³
logger.error("ç™¼é€å¤±æ•—")
```

### çµ±ä¸€éŒ¯èª¤è™•ç†

```python
from error_handler import handle_error, AppError, ErrorType

async def send_message(account_id: int, chat_id: int, text: str):
    try:
        client = await ensure_connected(account_id)
        await safe_telegram_call(client.send_message, chat_id, text)
    except FloodWait as e:
        # è¨˜éŒ„ä¸¦é€šçŸ¥å‰ç«¯
        handle_error(
            AppError(ErrorType.RATE_LIMIT, f"éœ€è¦ç­‰å¾… {e.value} ç§’"),
            context={"account_id": account_id, "chat_id": chat_id}
        )
        raise
    except Exception as e:
        handle_error(
            AppError(ErrorType.TELEGRAM_ERROR, str(e)),
            context={"account_id": account_id, "chat_id": chat_id}
        )
        raise
```

---

## æ¸¬è©¦è¦ç¯„

### æ‰‹å‹•æ¸¬è©¦æ¸…å–®æ¨¡æ¿

æ¯å€‹åŠŸèƒ½æäº¤å‰ï¼Œæ‡‰å¡«å¯«ä»¥ä¸‹æ¸¬è©¦æ¸…å–®ï¼š

```markdown
## åŠŸèƒ½ï¼š[åŠŸèƒ½åç¨±]

### æ­£å¸¸æµç¨‹
- [ ] è¼¸å…¥æœ‰æ•ˆæ•¸æ“šï¼Œæ“ä½œæˆåŠŸ
- [ ] UI æ­£ç¢ºæ›´æ–°
- [ ] æ•¸æ“šæ­£ç¢ºä¿å­˜åˆ°è³‡æ–™åº«

### é‚Šç•Œæƒ…æ³
- [ ] ç©ºè¼¸å…¥ï¼š[é æœŸè¡Œç‚º]
- [ ] è¶…é•·è¼¸å…¥ï¼š[é æœŸè¡Œç‚º]
- [ ] ç‰¹æ®Šå­—ç¬¦ï¼š[é æœŸè¡Œç‚º]

### éŒ¯èª¤è™•ç†
- [ ] ç¶²çµ¡æ–·é–‹æ™‚ï¼š[é æœŸè¡Œç‚º]
- [ ] å¾Œç«¯è¿”å›éŒ¯èª¤ï¼š[é æœŸè¡Œç‚º]
- [ ] æ¬Šé™ä¸è¶³ï¼š[é æœŸè¡Œç‚º]

### ä¸¦ç™¼æƒ…æ³
- [ ] é‡è¤‡é»æ“Šï¼š[é æœŸè¡Œç‚º]
- [ ] å¤šç”¨æˆ¶åŒæ™‚æ“ä½œï¼š[é æœŸè¡Œç‚º]
```

---

## å·²çŸ¥å•é¡Œèˆ‡åœ°é›·å€

ä»¥ä¸‹æ–‡ä»¶/æ¨¡å¡Šå­˜åœ¨å·²çŸ¥å•é¡Œï¼Œä¿®æ”¹æ™‚éœ€ç‰¹åˆ¥è¬¹æ…ï¼š

| æ–‡ä»¶ | å•é¡Œ | æ³¨æ„äº‹é … |
|------|------|----------|
| `telegram_client.py` | Session é–å®š | ç¢ºä¿ disconnect åœ¨ finally ä¸­ |
| `message_queue.py` | ä¸¦ç™¼ç‹€æ…‹ | ä½¿ç”¨é–ä¿è­·å…±äº«ç‹€æ…‹ |
| `database.py` | é·ç§»å…¼å®¹ | æ–°å­—æ®µå¿…é ˆæœ‰é»˜èªå€¼ |
| `search-discovery.component.ts` | NG0955 | track å¿…é ˆå”¯ä¸€ |
| `app.component.html` | 10000+ è¡Œ | è€ƒæ…®æ‹†åˆ†çµ„ä»¶ |

### å¸¸è¦‹é™·é˜±

1. **FloodWait æœªè™•ç†**ï¼šç›´æ¥èª¿ç”¨ Pyrogram API å°è‡´å¸³è™Ÿè¢«é™åˆ¶
2. **Session æ–‡ä»¶é–å®š**ï¼šå¤šå€‹é€²ç¨‹åŒæ™‚è¨ªå•åŒä¸€ session æ–‡ä»¶
3. **N+1 æŸ¥è©¢**ï¼šåˆ—è¡¨é é¢åŠ è¼‰ç·©æ…¢
4. **Track é‡è¤‡**ï¼šAngular åˆ—è¡¨æ¸²æŸ“ç•°å¸¸
5. **é€£æ¥ç‹€æ…‹ä¸åŒæ­¥**ï¼šUI é¡¯ç¤ºåœ¨ç·šä½†å¯¦éš›å·²æ–·é–‹

---

## æäº¤èˆ‡å¯©æŸ¥æµç¨‹

### æäº¤å‰è‡ªæŸ¥

1. ä»£ç¢¼æ˜¯å¦é€šé Lint æª¢æŸ¥ï¼Ÿ
2. æ˜¯å¦è™•ç†äº†æ‰€æœ‰ TODO è¨»é‡‹ï¼Ÿ
3. æ˜¯å¦æ·»åŠ äº†å¿…è¦çš„æ—¥èªŒï¼Ÿ
4. æ˜¯å¦æ›´æ–°äº†ç›¸é—œæ–‡æª”ï¼Ÿ
5. æ˜¯å¦è€ƒæ…®äº†å…«ç¶­å¯©æŸ¥çš„æ‰€æœ‰ç¶­åº¦ï¼Ÿ

### Commit è¨Šæ¯æ ¼å¼

```
<type>(<scope>): <subject>

<body>

<footer>
```

é¡å‹ (type)ï¼š
- `feat`: æ–°åŠŸèƒ½
- `fix`: éŒ¯èª¤ä¿®å¾©
- `docs`: æ–‡æª”æ›´æ–°
- `style`: ä»£ç¢¼æ ¼å¼ï¼ˆä¸å½±éŸ¿åŠŸèƒ½ï¼‰
- `refactor`: é‡æ§‹
- `perf`: æ€§èƒ½å„ªåŒ–
- `test`: æ¸¬è©¦
- `chore`: æ§‹å»º/å·¥å…·

ç¤ºä¾‹ï¼š
```
feat(account): æ·»åŠ æ‰¹é‡åˆªé™¤å¸³è™ŸåŠŸèƒ½

- æ”¯æŒå¤šé¸åˆªé™¤
- æ·»åŠ ç¢ºèªå°è©±æ¡†
- è™•ç†é—œè¯æ•¸æ“šæ¸…ç†

Closes #123
```

---

## é™„éŒ„ï¼šå¿«é€Ÿåƒè€ƒå¡ç‰‡

### API éŸ¿æ‡‰

```python
{"success": True, "data": {...}, "error": None}
{"success": False, "data": None, "error": "éŒ¯èª¤è¨Šæ¯"}
```

### è³‡æ–™åº«é€£æ¥

```python
with db.get_connection() as conn:
    cursor = conn.cursor()
    # æ“ä½œ...
    conn.commit()
```

### Telegram API èª¿ç”¨

```python
await safe_telegram_call(client.method, *args, **kwargs)
```

### å‰ç«¯ç‹€æ…‹

```typescript
isLoading = signal(false);
error = signal<string | null>(null);
data = signal<T[]>([]);
```

---

*æœ€å¾Œæ›´æ–°ï¼š2026-01-23*
