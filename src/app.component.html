<!-- å…¨å±€é€šçŸ¥å’Œå°è©±æ¡† -->
<app-toast></app-toast>
<app-loading-overlay></app-loading-overlay>
<app-membership-dialog></app-membership-dialog>
<app-payment></app-payment>
<app-upgrade-prompt></app-upgrade-prompt>

<!-- ç™»å…¥é é¢ï¼ˆæœªèªè­‰æ™‚é¡¯ç¤ºï¼‰ -->
@if (!isAuthenticated()) {
  <app-login></app-login>
} @else {
  <!-- ä¸»æ‡‰ç”¨ç•Œé¢ï¼ˆå·²èªè­‰ï¼‰ -->
  <div class="flex h-screen" style="background-color: var(--bg-primary); color: var(--text-primary);">
    
    <!-- Onboarding -->
    <app-onboarding></app-onboarding>
    
    <!-- Progress Dialog -->
    <app-progress-dialog
      [show]="progressDialog().show"
      [title]="progressDialog().title"
      [progress]="progressDialog().progress"
      [cancellable]="progressDialog().cancellable">
    </app-progress-dialog>
    
    <!-- Sidebar -->
    <aside class="w-64 backdrop-blur-sm flex-shrink-0 flex flex-col sidebar" 
           style="background-color: var(--bg-sidebar); border-right: 1px solid var(--border-default);">
      <div>
        <!-- Logo - TG-AIæ™ºæ§ç‹ -->
        <div class="flex items-center gap-3 p-4">
           <div class="relative">
             <!-- Logo ç™¼å…‰æ•ˆæœ -->
             <div class="absolute inset-0 rounded-xl blur-md opacity-50" 
                  style="background: linear-gradient(135deg, #06b6d4, #8b5cf6);"></div>
             <!-- Logo SVG -->
             <svg class="h-10 w-10 relative z-10" viewBox="0 0 64 64" fill="none">
               <!-- ä¸­å¿ƒå…­é‚Šå½¢ -->
               <path d="M32 8L52 20V44L32 56L12 44V20L32 8Z" fill="url(#sidebarLogoGrad)" stroke="url(#sidebarLogoStroke)" stroke-width="1.5"/>
               <!-- ç´™é£›æ©Ÿ -->
               <path d="M22 28L40 22L34 36L28 32L22 28Z" fill="white" opacity="0.95"/>
               <path d="M28 32L34 36L32 42L28 32Z" fill="white" opacity="0.8"/>
               <!-- çš‡å†  -->
               <path d="M24 12L28 8L32 11L36 8L40 12L38 16H26L24 12Z" fill="#fbbf24"/>
               <circle cx="32" cy="8" r="1.2" fill="#fef3c7"/>
               <!-- æ¼¸è®Š -->
               <defs>
                 <linearGradient id="sidebarLogoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                   <stop offset="0%" stop-color="#0891b2"/>
                   <stop offset="100%" stop-color="#7c3aed"/>
                 </linearGradient>
                 <linearGradient id="sidebarLogoStroke" x1="0%" y1="0%" x2="100%" y2="100%">
                   <stop offset="0%" stop-color="#22d3ee"/>
                   <stop offset="100%" stop-color="#a78bfa"/>
                 </linearGradient>
               </defs>
             </svg>
           </div>
          <div>
            <h1 class="text-xl font-bold bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">{{ t('title') }}</h1>
            <p class="text-xs" style="color: var(--text-muted);">{{ t('subtitle') }}</p>
          </div>
        </div>
        
        <!-- ç”¨æˆ¶ä¿¡æ¯å€åŸŸï¼ˆç¾åŒ–ç‰ˆï¼‰ -->
        <div class="user-profile-card mx-3 mb-4 p-3 rounded-xl cursor-pointer transition-all duration-300 hover:scale-[1.02] group"
             [class.level-free]="userMembershipLevel() === 'free'"
             [class.level-vip]="userMembershipLevel() === 'vip'"
             [class.level-svip]="userMembershipLevel() === 'svip'"
             [class.level-mvp]="userMembershipLevel() === 'mvp'"
             (click)="changeView('profile')">
          <div class="flex items-center gap-3">
            <!-- é ­åƒæ¡†ï¼ˆå¸¶ç­‰ç´šé‚Šæ¡†ï¼‰ -->
            <div class="avatar-wrapper relative">
              <!-- å‹•æ…‹å…‰ç’° -->
              <div class="avatar-glow absolute inset-0 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                   [class.glow-free]="userMembershipLevel() === 'free'"
                   [class.glow-vip]="userMembershipLevel() === 'vip'"
                   [class.glow-svip]="userMembershipLevel() === 'svip'"
                   [class.glow-mvp]="userMembershipLevel() === 'mvp'">
              </div>
              <!-- é ­åƒé‚Šæ¡† -->
              <div class="avatar-border w-12 h-12 rounded-full p-[2px]"
                   [class.border-free]="userMembershipLevel() === 'free'"
                   [class.border-vip]="userMembershipLevel() === 'vip'"
                   [class.border-svip]="userMembershipLevel() === 'svip'"
                   [class.border-mvp]="userMembershipLevel() === 'mvp'">
                <!-- é ­åƒå…§å®¹ -->
                <div class="w-full h-full rounded-full flex items-center justify-center text-white font-bold text-lg avatar-inner"
                     [class.avatar-free]="userMembershipLevel() === 'free'"
                     [class.avatar-vip]="userMembershipLevel() === 'vip'"
                     [class.avatar-svip]="userMembershipLevel() === 'svip'"
                     [class.avatar-mvp]="userMembershipLevel() === 'mvp'">
                  {{ currentUser()?.username?.charAt(0).toUpperCase() || '?' }}
                </div>
              </div>
              <!-- VIP å¾½ç« ï¼ˆå³ä¸‹è§’ï¼‰ -->
              @if (userMembershipLevel() !== 'free') {
                <div class="vip-badge absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-lg"
                     [class.badge-vip]="userMembershipLevel() === 'vip'"
                     [class.badge-svip]="userMembershipLevel() === 'svip'"
                     [class.badge-mvp]="userMembershipLevel() === 'mvp'">
                  @switch (userMembershipLevel()) {
                    @case ('vip') { <span class="animate-pulse">â­</span> }
                    @case ('svip') { <span class="animate-pulse">ğŸ’</span> }
                    @case ('mvp') { <span class="animate-bounce">ğŸ‘‘</span> }
                  }
                </div>
              }
            </div>
            
            <!-- ç”¨æˆ¶ä¿¡æ¯ -->
            <div class="flex-1 min-w-0">
              <div class="text-sm font-semibold truncate" style="color: var(--text-primary);">
                {{ currentUser()?.username || 'ç”¨æˆ¶' }}
              </div>
              <div class="flex items-center gap-1.5 mt-0.5">
                <!-- VIP æ¨™ç±¤ï¼ˆç²¾ç¾ç‰ˆï¼‰ -->
                @switch (userMembershipLevel()) {
                  @case ('vip') {
                    <span class="vip-tag vip-tag-vip">
                      <span class="vip-icon">â­</span>
                      <span class="vip-text">VIP</span>
                    </span>
                  }
                  @case ('svip') {
                    <span class="vip-tag vip-tag-svip">
                      <span class="vip-icon">ğŸ’</span>
                      <span class="vip-text">SVIP</span>
                    </span>
                  }
                  @case ('mvp') {
                    <span class="vip-tag vip-tag-mvp">
                      <span class="vip-icon">ğŸ‘‘</span>
                      <span class="vip-text">MVP</span>
                    </span>
                  }
                  @default {
                    <span class="vip-tag vip-tag-free">
                      <span class="vip-icon">ğŸŒŸ</span>
                      <span class="vip-text">å…è²»ç‰ˆ</span>
                    </span>
                  }
                }
              </div>
            </div>
            
            <!-- ç®­é ­ -->
            <div class="arrow-icon transition-transform duration-300 group-hover:translate-x-1">
              <svg class="w-4 h-4" style="color: var(--text-muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </div>
          </div>
        </div>
      <nav class="mt-6 px-2">
        @let view = currentView();
        
        <!-- æœƒå“¡ä¸­å¿ƒï¼ˆç§»åˆ°ç¬¬ä¸€å€‹ï¼‰ -->
        <a (click)="changeView('membership-center')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'membership-center'"
           [style.background-color]="view === 'membership-center' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'membership-center' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
           <span>æœƒå“¡ä¸­å¿ƒ</span>
        </a>
        
        <!-- å„€è¡¨ç›¤ -->
        <a (click)="changeView('dashboard')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'dashboard'"
           [style.background-color]="view === 'dashboard' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'dashboard' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
          <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
          <span>{{ t('dashboard') }}</span>
        </a>
        
        <!-- åˆ†éš”ç·šï¼šè³‡æºç®¡ç† -->
        <div class="px-3 py-2 mt-2">
          <span class="sidebar-group-title text-xs uppercase tracking-wider" style="color: var(--sidebar-group-title);">{{ t('resourceManagement') }}</span>
        </div>
        
        <!-- å¸³è™Ÿç®¡ç† -->
        <a (click)="changeView('accounts')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'accounts'"
           [style.background-color]="view === 'accounts' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'accounts' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
           <span>{{ t('accounts') }}</span>
        </a>
        
        <!-- è³‡æºç™¼ç¾ -->
        <a (click)="changeView('resources'); autoInitResourceDiscovery()" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'resources'"
           [style.background-color]="view === 'resources' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'resources' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
           <span>{{ t('resourceDiscoveryMenu') }}</span>
        </a>
        
        <!-- åˆ†éš”ç·šï¼šç‡ŸéŠ·è‡ªå‹•åŒ– -->
        <div class="px-3 py-2 mt-2">
          <span class="sidebar-group-title text-xs uppercase tracking-wider" style="color: var(--sidebar-group-title);">{{ t('marketingAutomation') }}</span>
        </div>
        
        <!-- è‡ªå‹•åŒ–ä¸­å¿ƒ -->
        <a (click)="changeView('automation')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'automation'"
           [style.background-color]="view === 'automation' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'automation' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
            <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8" /><rect x="4" y="4" width="16" height="16" rx="2" /><path d="M12 12h.01" /><path d="M16 12h.01" /><path d="M12 16h.01" /><path d="M16 16h.01" /></svg>
            <span>{{ t('automation') }}</span>
        </a>
        
        <!-- æ½›åœ¨å®¢æˆ¶ -->
        <a (click)="changeView('leads')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'leads'"
           [style.background-color]="view === 'leads' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'leads' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="19" x2="19" y1="8" y2="14"></line><line x1="22" x2="16" y1="11" y2="11"></line></svg>
           <span>{{ t('leads') }}</span>
        </a>
        
        <!-- å»£å‘Šç™¼é€ -->
        <a (click)="changeView('ads'); loadAdSystemData()" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'ads'"
           [style.background-color]="view === 'ads' ? 'rgba(249, 115, 22, 0.15)' : 'transparent'"
           [style.color]="view === 'ads' ? '#fb923c' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
           <span>å»£å‘Šç™¼é€</span>
        </a>
        
        <!-- ç”¨æˆ¶è¿½è¹¤ -->
        <a (click)="changeView('user-tracking'); loadUserTrackingData()" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'user-tracking'"
           [style.background-color]="view === 'user-tracking' ? 'rgba(16, 185, 129, 0.15)' : 'transparent'"
           [style.color]="view === 'user-tracking' ? '#34d399' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6"/><path d="M23 11h-6"/></svg>
           <span>ç”¨æˆ¶è¿½è¹¤</span>
        </a>
        
        <!-- ç‡ŸéŠ·æ´»å‹• -->
        <a (click)="changeView('campaigns'); loadCampaignData()" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'campaigns'"
           [style.background-color]="view === 'campaigns' ? 'rgba(236, 72, 153, 0.15)' : 'transparent'"
           [style.color]="view === 'campaigns' ? '#f472b6' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
           <span>ç‡ŸéŠ·æ´»å‹•</span>
        </a>
        
        <!-- å¤šè§’è‰²å”ä½œ -->
        <a (click)="changeView('multi-role'); loadMultiRoleData()" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'multi-role'"
           [style.background-color]="view === 'multi-role' ? 'rgba(99, 102, 241, 0.15)' : 'transparent'"
           [style.color]="view === 'multi-role' ? '#a5b4fc' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
           <span>å¤šè§’è‰²å”ä½œ</span>
        </a>
        
        <!-- åˆ†éš”ç·šï¼šAI èˆ‡æ™ºèƒ½ -->
        <div class="px-3 py-2 mt-2">
          <span class="sidebar-group-title text-xs uppercase tracking-wider" style="color: var(--sidebar-group-title);">{{ t('aiIntelligence') }}</span>
        </div>
        
        <!-- AI ä¸­å¿ƒ -->
        <a (click)="changeView('ai-center')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'ai-center'"
           [style.background-color]="view === 'ai-center' ? 'rgba(168, 85, 247, 0.15)' : 'transparent'"
           [style.color]="view === 'ai-center' ? '#c084fc' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m9 0a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3"></path></svg>
           <span>{{ t('aiCenter') }}</span>
        </a>
        
        <!-- åˆ†éš”ç·šï¼šç³»çµ±ç›£æ§ -->
        <div class="px-3 py-2 mt-2">
          <span class="sidebar-group-title text-xs uppercase tracking-wider" style="color: var(--sidebar-group-title);">{{ t('systemMonitor') }}</span>
        </div>
        
        <!-- é‹è¡Œæ—¥èªŒï¼ˆåˆä½µç›£æ§ä¸­å¿ƒå’Œå‘Šè­¦ï¼‰ -->
        <a (click)="changeView('runtime-logs')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1 relative"
           [class.active]="view === 'runtime-logs'"
           [style.background-color]="view === 'runtime-logs' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'runtime-logs' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18.7 8a2.3 2.3 0 0 0-3.4 0l-3.3 3.4-3.4-3.4a2.3 2.3 0 0 0-3.4 0L3 13.3"></path></svg>
           <span>é‹è¡Œæ—¥èªŒ</span>
           @if(unacknowledgedAlertsCount() > 0) {
             <span class="absolute right-2 text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center" style="background-color: var(--error); color: white;">{{ unacknowledgedAlertsCount() }}</span>
           }
        </a>
        
        <!-- è¨­ç½® -->
        <a (click)="changeView('settings')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'settings'"
           [style.background-color]="view === 'settings' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'settings' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
           <span>{{ t('settings') }}</span>
        </a>
      </nav>
    </div>
    
    <!-- å´é‚Šæ¬„åº•éƒ¨ -->
    <div class="mt-auto p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--sidebar-group-title);">{{ t('language') }}</label>
          <app-language-switcher-compact></app-language-switcher-compact>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--sidebar-group-title);">{{ t('appearance') }}</label>
          <div class="flex rounded-md shadow-sm p-1" style="background-color: var(--bg-tertiary);">
            <button (click)="theme.set('light')" 
                    class="w-full text-sm py-1.5 rounded transition-colors flex items-center justify-center gap-2"
                    [style.background-color]="theme() === 'light' ? 'var(--bg-card)' : 'transparent'"
                    [style.color]="theme() === 'light' ? 'var(--primary)' : 'var(--text-muted)'"
                    [style.box-shadow]="theme() === 'light' ? 'var(--shadow-sm)' : 'none'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            </button>
            <button (click)="theme.set('dark')" 
                    class="w-full text-sm py-1.5 rounded transition-colors flex items-center justify-center gap-2"
                    [style.background-color]="theme() === 'dark' ? 'var(--primary-bg)' : 'transparent'"
                    [style.color]="theme() === 'dark' ? 'var(--primary)' : 'var(--text-muted)'"
                    [style.box-shadow]="theme() === 'dark' ? 'var(--shadow-sm)' : 'none'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
              </svg>
            </button>
          </div>
        </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 overflow-y-auto" style="background-color: var(--bg-primary);">
    @switch (currentView()) {
      @case ('dashboard') {
        <h2 class="text-4xl font-bold mb-8" style="color: var(--text-primary);">{{ t('dashboard') }}</h2>
        
        <!-- ğŸš€ ä¸€éµé‹è¡Œä¸­å¿ƒ -->
        <div class="rounded-xl p-6 mb-8" style="background: linear-gradient(to right, var(--primary-bg), rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1)); border: 1px solid var(--primary); box-shadow: var(--shadow-lg);">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <span class="text-3xl">ğŸš€</span>
              <h3 class="text-xl font-bold" style="color: var(--text-primary);">ä¸€éµé‹è¡Œä¸­å¿ƒ</h3>
            </div>
            <button (click)="loadSystemStatus()" class="transition-colors" style="color: var(--text-muted);" title="åˆ·æ–°ç‹€æ…‹">
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            </button>
          </div>
          
          <!-- å¿«é€Ÿç‹€æ…‹æŒ‡ç¤ºå™¨ -->
          @let status = systemStatus();
          <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="rounded-lg p-4 text-center" style="background-color: var(--bg-card);">
              <div class="text-2xl mb-1">ğŸ”‘</div>
              <div class="text-sm" style="color: var(--text-muted);">å¸³è™Ÿåœ¨ç·š</div>
              <div class="text-xl font-bold" [style.color]="status.accounts.online > 0 ? 'var(--success)' : 'var(--error)'">
                {{ status.accounts.online }}/{{ status.accounts.total }}
              </div>
            </div>
            <div class="rounded-lg p-4 text-center" style="background-color: var(--bg-card);">
              <div class="text-2xl mb-1">ğŸ“¡</div>
              <div class="text-sm" style="color: var(--text-muted);">ç›£æ§ç‹€æ…‹</div>
              <div class="text-xl font-bold" [style.color]="isMonitoring() ? 'var(--success)' : 'var(--error)'">
                {{ isMonitoring() ? 'é‹è¡Œä¸­' : 'æœªå•Ÿå‹•' }}
              </div>
            </div>
            <div class="rounded-lg p-4 text-center" style="background-color: var(--bg-card);">
              <div class="text-2xl mb-1">ğŸ¤–</div>
              <div class="text-sm" style="color: var(--text-muted);">AI èŠå¤©</div>
              <div class="text-xl font-bold" [style.color]="status.ai.enabled ? 'var(--success)' : 'var(--error)'">
                {{ status.ai.enabled ? (status.ai.mode === 'full' ? 'å…¨è‡ªå‹•' : 'åŠè‡ªå‹•') : 'æœªå•Ÿç”¨' }}
              </div>
            </div>
          </div>
          
          <!-- ä¸€éµå•Ÿå‹•æŒ‰éˆ• -->
          @if (oneClickStarting()) {
            <div class="bg-slate-800/50 rounded-lg p-4 mb-4">
              <div class="flex items-center gap-3 mb-2">
                <div class="animate-spin h-5 w-5 border-2 border-cyan-500 border-t-transparent rounded-full"></div>
                <span class="text-cyan-300">{{ oneClickMessage() }}</span>
              </div>
              <div class="w-full bg-slate-700 rounded-full h-2">
                <div class="bg-gradient-to-r from-cyan-500 to-purple-500 h-2 rounded-full transition-all duration-300" [style.width.%]="oneClickProgress()"></div>
              </div>
            </div>
          }
          
          <div class="flex gap-4">
            @if (!isMonitoring() || !status.ai.enabled) {
              <button 
                (click)="oneClickStart()" 
                [disabled]="oneClickStarting()"
                class="flex-1 bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-lg flex items-center justify-center gap-2">
                <span class="text-xl">âš¡</span>
                <span>ä¸€éµå…¨éƒ¨å•Ÿå‹•</span>
              </button>
            } @else {
              <button 
                (click)="oneClickStop()" 
                class="flex-1 bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-lg flex items-center justify-center gap-2">
                <span class="text-xl">ğŸ›‘</span>
                <span>ä¸€éµåœæ­¢æ‰€æœ‰</span>
              </button>
            }
          </div>
          
          <!-- è©³ç´°ç‹€æ…‹ï¼ˆå¯å±•é–‹ï¼‰ -->
          <details class="mt-4">
            <summary class="text-slate-400 text-sm cursor-pointer hover:text-white">ğŸ“Š æŸ¥çœ‹è©³ç´°ç‹€æ…‹</summary>
            <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div class="bg-slate-800/30 rounded p-2">
                <span class="text-slate-500">é—œéµè©é›†:</span>
                <span class="text-white ml-1">{{ status.keywords.sets }} å€‹</span>
              </div>
              <div class="bg-slate-800/30 rounded p-2">
                <span class="text-slate-500">ç›£æ§ç¾¤çµ„:</span>
                <span class="text-white ml-1">{{ status.monitoring.groups }} å€‹</span>
              </div>
              <div class="bg-slate-800/30 rounded p-2">
                <span class="text-slate-500">æ´»å‹•è¦å‰‡:</span>
                <span class="text-white ml-1">{{ status.campaigns.active }}/{{ status.campaigns.total }}</span>
              </div>
              <div class="bg-slate-800/30 rounded p-2">
                <span class="text-slate-500">æ¶ˆæ¯æ¨¡æ¿:</span>
                <span class="text-white ml-1">{{ status.templates.active }}/{{ status.templates.total }}</span>
              </div>
            </div>
          </details>
          
          <!-- ğŸš€ å•Ÿå‹•å ±å‘Šé¢æ¿ -->
          @if (showStartReport() && oneClickStartReport()) {
            @let report = oneClickStartReport();
            <div class="mt-4 bg-slate-900/60 rounded-lg border border-slate-700 overflow-hidden">
              <div class="flex items-center justify-between px-4 py-2 bg-slate-800/50 border-b border-slate-700">
                <div class="flex items-center gap-2">
                  <span class="text-lg">{{ report.overall_success ? 'âœ…' : 'âš ï¸' }}</span>
                  <span class="font-semibold text-white">å•Ÿå‹•å ±å‘Š</span>
                </div>
                <button (click)="showStartReport.set(false)" class="text-slate-400 hover:text-white">
                  <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
              <div class="p-4 space-y-3">
                <!-- å¸³è™Ÿç‹€æ…‹ -->
                <div class="flex items-start gap-3">
                  <span class="text-2xl">ğŸ‘¥</span>
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-white">å¸³è™Ÿé€£æ¥</span>
                      <span class="px-2 py-0.5 rounded text-xs {{ report.accounts?.success > 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400' }}">
                        {{ report.accounts?.success || 0 }}/{{ report.accounts?.total || 0 }}
                      </span>
                    </div>
                    @if (report.accounts?.details?.length) {
                      <div class="mt-2 space-y-1 text-sm">
                        @for (acc of report.accounts.details; track acc.phone) {
                          <div class="flex items-center gap-2 text-slate-400">
                            <span>{{ acc.success ? 'âœ“' : 'âœ—' }}</span>
                            <span>{{ acc.phone }}</span>
                            <span class="text-slate-500">{{ acc.message }}</span>
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>
                
                <!-- ç¾¤çµ„ç‹€æ…‹ -->
                @if (report.groups) {
                  <div class="flex items-start gap-3">
                    <span class="text-2xl">ğŸ“¢</span>
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-white">ç¾¤çµ„åŠ å…¥</span>
                        <span class="px-2 py-0.5 rounded text-xs bg-green-500/20 text-green-400">{{ report.groups.success?.length || 0 }} æˆåŠŸ</span>
                        @if (report.groups.pending?.length) {
                          <span class="px-2 py-0.5 rounded text-xs bg-yellow-500/20 text-yellow-400">{{ report.groups.pending.length }} å¾…å¯©æ ¸</span>
                        }
                        @if (report.groups.failed?.length) {
                          <span class="px-2 py-0.5 rounded text-xs bg-red-500/20 text-red-400">{{ report.groups.failed.length }} å¤±æ•—</span>
                        }
                      </div>
                      @if (report.groups.failed?.length) {
                        <div class="mt-2 space-y-1 text-sm">
                          @for (fail of report.groups.failed; track fail.url) {
                            <div class="text-red-400">âœ— {{ fail.url }}: {{ fail.reason }}</div>
                          }
                        </div>
                      }
                    </div>
                  </div>
                }
                
                <!-- ç›£æ§ç‹€æ…‹ -->
                <div class="flex items-start gap-3">
                  <span class="text-2xl">ğŸ‘ï¸</span>
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-white">ç›£æ§æœå‹™</span>
                      <span class="px-2 py-0.5 rounded text-xs {{ report.monitoring?.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400' }}">
                        {{ report.monitoring?.success ? 'å·²å•Ÿå‹•' : 'å•Ÿå‹•å¤±æ•—' }}
                      </span>
                    </div>
                    @if (report.monitoring?.groups) {
                      <div class="text-slate-400 text-sm mt-1">ç›£æ§ {{ report.monitoring.groups }} å€‹ç¾¤çµ„</div>
                    }
                  </div>
                </div>
                
                <!-- AI ç‹€æ…‹ -->
                <div class="flex items-start gap-3">
                  <span class="text-2xl">ğŸ¤–</span>
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-white">AI è‡ªå‹•èŠå¤©</span>
                      <span class="px-2 py-0.5 rounded text-xs {{ report.ai?.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400' }}">
                        {{ report.ai?.success ? 'å…¨è‡ªå‹•æ¨¡å¼' : 'æœªå•Ÿç”¨' }}
                      </span>
                    </div>
                  </div>
                </div>
                
                <!-- æ¼æ–—ç‹€æ…‹ -->
                @if (report.funnel) {
                  <div class="flex items-start gap-3">
                    <span class="text-2xl">ğŸ¯</span>
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-white">æ¼æ–—è‡ªå‹•æµè½‰</span>
                        <span class="px-2 py-0.5 rounded text-xs {{ report.funnel?.success ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400' }}">
                          {{ report.funnel?.success ? 'å·²å•Ÿç”¨' : 'æœªå•Ÿç”¨' }}
                        </span>
                      </div>
                      @if (report.funnel?.success) {
                        <div class="text-slate-400 text-sm mt-1">è‡ªå‹•è·Ÿé€² + éšæ®µåˆ†æ</div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
        
        @let stats = dashboardStats();
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><div class="flex items-center gap-4"><div class="p-3 rounded-full bg-cyan-500/20"><svg class="h-6 w-6 text-cyan-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div><div><h3 class="text-slate-500 dark:text-slate-400 text-sm font-medium">{{ t('totalAccounts') }}</h3><p class="text-3xl font-semibold">{{ stats.totalAccounts }}</p></div></div></div>
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><div class="flex items-center gap-4"><div class="p-3 rounded-full bg-green-500/20"><svg class="h-6 w-6 text-green-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div><div><h3 class="text-slate-500 dark:text-slate-400 text-sm font-medium">{{ t('onlineAccounts') }}</h3><p class="text-3xl font-semibold">{{ stats.onlineAccounts }}</p></div></div></div>
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><div class="flex items-center gap-4"><div class="p-3 rounded-full bg-blue-500/20"><svg class="h-6 w-6 text-blue-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg></div><div><h3 class="text-slate-500 dark:text-slate-400 text-sm font-medium">{{ t('leadsToday') }}</h3><p class="text-3xl font-semibold">{{ stats.leadsToday }}</p></div></div></div>
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><div class="flex items-center gap-4"><div class="p-3 rounded-full bg-purple-500/20"><svg class="h-6 w-6 text-purple-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></div><div><h3 class="text-slate-500 dark:text-slate-400 text-sm font-medium">{{ t('messagesSentToday') }}</h3><p class="text-3xl font-semibold">{{ stats.messagesSentToday }}</p></div></div></div>
        </div>
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
          <h3 class="text-xl font-semibold mb-4 text-slate-800 dark:text-slate-200">{{ t('systemControl') }}</h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <span class="text-slate-600 dark:text-slate-300">{{ t('monitoringStatus') }} <span [class.text-green-400]="isMonitoring()" [class.text-red-400]="!isMonitoring()" class="font-bold">{{ isMonitoring() ? t('active') : t('inactive') }}</span></span>
              @if(isMonitoring()) {
                <button (click)="stopMonitoring()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-red-500/20">{{ t('stop') }}</button>
              } @else {
                <button (click)="startMonitoring()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-green-500/20">{{ t('start') }}</button>
              }
            </div>
            <div class="flex gap-2">
              <button (click)="checkMonitoringStatus()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1.5 px-3 rounded-lg text-sm transition duration-200">ğŸ” æª¢æŸ¥ç›£æ§ç‹€æ…‹</button>
              <button (click)="checkMonitoringHealth()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1.5 px-3 rounded-lg text-sm transition duration-200">ğŸ¥ å¥åº·æª¢æŸ¥</button>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold mb-4">{{ t('recentLeads') }}</h3>
            <div class="space-y-3">
              @for(lead of leads().slice(0, 5); track lead.id) {
                <div class="bg-slate-200/50 dark:bg-slate-800/50 p-3 rounded-lg"><p class="font-bold text-cyan-600 dark:text-cyan-400">@{{ lead.username }}</p><p class="text-sm text-slate-500 dark:text-slate-400">{{ t('sourceGroup') }}: {{ lead.sourceGroup }}</p></div>
              } @empty { <p class="text-slate-500">{{ t('noRecentActivity') }}</p> }
            </div>
          </div>
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold mb-4">æ¶ˆæ¯é˜Ÿåˆ—çŠ¶æ€</h3>
            @let queueStats = getTotalQueueStats();
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-slate-600 dark:text-slate-400">å¾…å‘é€</span>
                <span class="font-bold text-yellow-500">{{ queueStats.pending }}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600 dark:text-slate-400">å‘é€ä¸­</span>
                <span class="font-bold text-blue-500">{{ queueStats.processing }}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600 dark:text-slate-400">é‡è¯•ä¸­</span>
                <span class="font-bold text-orange-500">{{ queueStats.retrying }}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600 dark:text-slate-400">å·²å®Œæˆ</span>
                <span class="font-bold text-green-500">{{ queueStats.completed }}</span>
              </div>
              <div class="flex justify-between items-center pt-2 border-t border-slate-300 dark:border-slate-700">
                <span class="text-slate-600 dark:text-slate-400">æ´»è·ƒè´¦æˆ·</span>
                <span class="font-bold text-cyan-500">{{ queueStats.totalAccounts }}</span>
              </div>
              <button (click)="refreshQueueStatusThrottled()" class="w-full mt-3 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm">åˆ·æ–°çŠ¶æ€</button>
            </div>
          </div>
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold mb-4">{{ t('recentLogs') }}</h3>
            <div class="space-y-2 text-sm font-mono">
              @for(log of logs().slice(0, 5); track trackByLogId($index, log)) {
                <div><span [class]="getLogColor(log.type)">[{{ log.type.toUpperCase() }}]</span><span class="ml-2 text-slate-600 dark:text-slate-400">{{ log.message }}</span></div>
              } @empty { <p class="text-slate-500">{{ t('noRecentActivity') }}</p> }
            </div>
          </div>
        </div>
      }
      @case ('accounts') {
        <h2 id="accounts-section" class="text-4xl font-bold mb-8 text-slate-900 dark:text-white">{{ t('manageAccounts') }}</h2>
        
        <!-- æ·»åŠ è´¦æˆ·æ–¹æ³•è¯´æ˜ -->
        <div class="bg-gradient-to-r from-cyan-500/10 to-blue-500/10 dark:from-cyan-500/20 dark:to-blue-500/20 border border-cyan-500/30 p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-xl font-semibold mb-4 text-slate-900 dark:text-white">ğŸ“‹ æ·»åŠ è´¦æˆ·çš„ä¸‰ç§æ–¹æ³•</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white/50 dark:bg-slate-800/50 p-4 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl">1ï¸âƒ£</span>
                        <h4 class="font-semibold text-slate-900 dark:text-white">æ‰‹åŠ¨æ·»åŠ </h4>
                    </div>
                    <p class="text-sm text-slate-600 dark:text-slate-400">åœ¨ä¸‹æ–¹è¡¨å•ä¸­å¡«å†™è´¦æˆ·ä¿¡æ¯ï¼Œé€‚ç”¨äºæ·»åŠ å•ä¸ªè´¦æˆ·ã€‚</p>
                </div>
                <div class="bg-white/50 dark:bg-slate-800/50 p-4 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl">2ï¸âƒ£</span>
                        <h4 class="font-semibold text-slate-900 dark:text-white">Excel æ‰¹é‡å¯¼å…¥</h4>
                    </div>
                    <p class="text-sm text-slate-600 dark:text-slate-400">ä¸‹è½½æ¨¡æ¿ï¼Œå¡«å†™è´¦æˆ·ä¿¡æ¯åæ‰¹é‡å¯¼å…¥ï¼Œé€‚ç”¨äºæ·»åŠ å¤šä¸ªè´¦æˆ·ã€‚</p>
                </div>
                <div class="bg-white/50 dark:bg-slate-800/50 p-4 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl">3ï¸âƒ£</span>
                        <h4 class="font-semibold text-slate-900 dark:text-white">å¯¼å…¥ Session æ–‡ä»¶</h4>
                    </div>
                    <p class="text-sm text-slate-600 dark:text-slate-400">å¯¼å…¥å·²æœ‰çš„ Pyrogram session æ–‡ä»¶ï¼Œè‡ªåŠ¨åˆ›å»ºè´¦æˆ·ã€‚</p>
                </div>
            </div>
        </div>
        
        <!-- æ‰‹åŠ¨æ·»åŠ è´¦æˆ·è¡¨å• -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-xl mb-4 font-semibold">æ–¹æ³• 1ï¼šæ‰‹åŠ¨æ·»åŠ æ–°è´¦æˆ·</h3>
            <form (submit)="addAccount()" class="space-y-4">
                @if(validationErrors()['account'] && validationErrors()['account'].length > 0) {
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-4">
                        <h4 class="text-red-500 font-semibold mb-2">éªŒè¯é”™è¯¯ï¼š</h4>
                        <ul class="list-disc list-inside space-y-1 text-sm text-red-400">
                            @for(error of validationErrors()['account']; track error) {
                                <li>{{ error }}</li>
                            }
                        </ul>
                    </div>
                }
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">{{ t('phoneNumber') }} <span class="text-red-500">*</span></label>
                        <input [(ngModel)]="newAccount().phone" name="phone" type="text" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm" [placeholder]="t('phoneNumber')" required>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">æ ¼å¼ï¼š+å›½å®¶ä»£ç +å·ç ï¼ˆå¦‚ï¼š+1234567890ï¼‰</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">{{ t('apiId') }}</label>
                        <input [(ngModel)]="newAccount().apiId" name="apiId" type="text" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm" [placeholder]="t('apiId')">
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">å¿…é¡»æ˜¯æ­£æ•´æ•°</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">{{ t('apiHash') }}</label>
                        <input [(ngModel)]="newAccount().apiHash" name="apiHash" type="text" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm" [placeholder]="t('apiHash')">
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">{{ t('proxy') }}</label>
                        <input [(ngModel)]="newAccount().proxy" name="proxy" type="text" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm" [placeholder]="t('proxy')">
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">æ ¼å¼ï¼šsocks5://host:port æˆ– http://host:port</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">{{ t('accountGroup') }}</label>
                        <input [(ngModel)]="newAccount().group" name="group" type="text" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm" [placeholder]="t('accountGroup')">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">{{ t('twoFactorPassword') }}</label>
                        <input [(ngModel)]="newAccount().twoFactorPassword" name="twoFactorPassword" type="password" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm" [placeholder]="t('twoFactorPassword')">
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" [(ngModel)]="newAccount().enableWarmup" name="enableWarmup" class="form-checkbox bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded text-cyan-500 h-5 w-5">
                        <span class="text-sm text-slate-700 dark:text-slate-300">{{ t('enableWarmup') }}</span>
                    </label>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20">
                        {{ t('addAccount') }}
                    </button>
                </div>
            </form>
        </div>
        
        <!-- æ–‡ä»¶ç®¡ç†åŒºåŸŸ -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-xl mb-4 font-semibold">æ–¹æ³• 2 & 3ï¼šæ–‡ä»¶ç®¡ç†</h3>
            <div class="space-y-4">
                <div>
                    <h4 class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-3">Excel æ‰¹é‡å¯¼å…¥</h4>
                    <div class="flex flex-wrap items-center gap-4">
                        <button (click)="onDownloadTemplate()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                            <svg class="h-4 w-4" viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round">  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />  <polyline points="14 2 14 8 20 8" />  <line x1="12" y1="18" x2="12" y2="12" />  <line x1="9" y1="15" x2="15" y2="15" /></svg>
                            {{ t('downloadTemplate') }}
                        </button>
                        <button (click)="onExcelFileSelected()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            {{ t('uploadExcel') }}
                        </button>
                    </div>
                </div>
                <div class="border-t border-slate-300 dark:border-slate-700 pt-4">
                    <h4 class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-3">Session æ–‡ä»¶ç®¡ç†</h4>
                    <div class="flex flex-wrap items-center gap-4">
                        <button (click)="importSession()" class="flex items-center gap-2 bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20">
                            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            {{ t('importSession') }}
                        </button>
                        <button (click)="reloadSessionsAndAccounts()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">  <polyline points="23 4 23 10 17 10" />  <polyline points="1 20 1 14 7 14" />  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" /></svg>
                            {{ t('reloadSessions') }}
                        </button>
                        <button (click)="cleanupSessionFiles()" class="flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-amber-500/20">
                            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            æ¸…ç†å­¤ç«‹æ–‡ä»¶
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
              <div class="flex items-center gap-2 border-b border-slate-200 dark:border-slate-800">
              @for(group of accountGroups(); track group) {
                  <button (click)="selectedAccountGroup.set(group)" [class.border-cyan-500]="selectedAccountGroup() === group" [class.text-cyan-500]="selectedAccountGroup() === group" class="py-2 px-3 text-sm font-medium border-b-2 border-transparent hover:border-slate-400 dark:hover:border-slate-500 transition-colors">{{ group === 'All' ? t('allAccounts') : group }}</button>
              }
              </div>
              <button (click)="refreshQueueStatusThrottled()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg shadow-cyan-500/20">åˆ·æ–°é˜Ÿåˆ—çŠ¶æ€</button>
            </div>
             @if(selectedAccounts().length > 0) {
                 <div class="flex items-center gap-2 relative">
                    <span class="text-sm font-semibold">{{ selectedAccounts().length }} {{ t('selected')}}</span>
                     <div class="relative group">
                        <button class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20 text-sm">{{ t('bulkActions') }}</button>
                        <div class="absolute z-10 hidden group-hover:block right-0 mt-1 bg-white dark:bg-slate-800 rounded-lg shadow-xl w-48 border border-slate-200 dark:border-slate-700">
                             <a (click)="bulkAssignRole('Listener')" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer">{{ t('assignRole') }} Listener</a>
                             <a (click)="bulkAssignRole('Sender')" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer">{{ t('assignRole') }} Sender</a>
                             <a (click)="bulkAssignRole('Unassigned')" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer">{{ t('assignRole') }} Unassigned</a>
                             <a (click)="bulkAssignGroup(null)" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer border-t border-slate-200 dark:border-slate-700">{{ t('assignGroup') }}...</a>
                             <a (click)="bulkDelete()" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer text-red-500 border-t border-slate-200 dark:border-slate-700">{{ t('deleteSelected') }}</a>
                        </div>
                    </div>
                 </div>
             }
        </div>
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 rounded-xl shadow-lg overflow-hidden">
          <table class="w-full text-left">
            <thead class="bg-slate-200/50 dark:bg-slate-800/50 text-slate-600 dark:text-slate-300 uppercase text-sm">
              <tr>
                <th class="py-3 px-4"><input type="checkbox" [checked]="isAllAccountsSelected()" (change)="toggleAllAccountSelection($event)" class="form-checkbox bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded text-cyan-500 h-5 w-5"></th>
                <th class="py-3 px-6">{{ t('phone') }}</th><th class="py-3 px-6">{{ t('role') }}</th><th class="py-3 px-6">{{ t('group') }}</th><th class="py-3 px-6">{{ t('health') }}</th><th class="py-3 px-6">{{ t('dailySends') }}</th><th class="py-3 px-6">é˜Ÿåˆ—çŠ¶æ€</th><th class="py-3 px-6">{{ t('status') }}</th><th class="py-3 px-6 text-right">{{ t('actions') }}</th></tr>
            </thead>
            <tbody>
              @for (account of filteredAccounts(); track account.id) {
                <tr class="border-b border-slate-200 dark:border-slate-800 hover:bg-slate-200/50 dark:hover:bg-slate-800/50 transition-colors">
                  <td class="py-4 px-4"><input type="checkbox" [(ngModel)]="account.selected" class="form-checkbox bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded text-cyan-500 h-5 w-5"></td>
                  <td class="py-4 px-6 font-semibold">{{ account.phone }}</td>
                  <td class="py-4 px-6">
                     <select [ngModel]="account.role" (ngModelChange)="updateAccountRole(account.id, $event)" class="form-select bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg text-sm p-1 focus:outline-none focus:ring-1 focus:ring-cyan-500">
                        @for(role of accountRoles; track role) {
                            <option [value]="role">{{ t(role) }}</option>
                        }
                     </select>
                  </td>
                  <td class="py-4 px-6"><span class="px-2.5 py-1 text-xs font-semibold rounded-full bg-slate-500/10 text-slate-400">{{ account.group || 'None' }}</span></td>
                  <td class="py-4 px-6" [title]="t('accountHealthTooltip')"><div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5"><div class="h-2.5 rounded-full" [class]="getHealthColor(account.healthScore)" [style.width.%]="account.healthScore"></div></div></td>
                  <td class="py-4 px-6"><div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5"><div class="bg-cyan-500 h-2.5 rounded-full" [style.width.%]="(account.dailySendCount / account.dailySendLimit) * 100"></div></div><span class="text-xs text-slate-500 dark:text-slate-400">{{ account.dailySendCount }} / {{ account.dailySendLimit }}</span></td>
                  <td class="py-4 px-6">
                    @let queueStatus = getQueueStatusForAccount(account.phone);
                    @if(queueStatus) {
                      <div class="flex flex-col gap-1 text-xs">
                        <div class="flex items-center gap-2">
                          <span class="text-slate-500 dark:text-slate-400">å¾…å‘é€:</span>
                          <span class="font-bold text-yellow-500">{{ queueStatus.pending }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="text-slate-500 dark:text-slate-400">å‘é€ä¸­:</span>
                          <span class="font-bold text-blue-500">{{ queueStatus.processing }}</span>
                        </div>
                        @if(queueStatus.retrying > 0) {
                          <div class="flex items-center gap-2">
                            <span class="text-slate-500 dark:text-slate-400">é‡è¯•:</span>
                            <span class="font-bold text-orange-500">{{ queueStatus.retrying }}</span>
                          </div>
                        }
                        <div class="flex items-center gap-2 pt-1 border-t border-slate-300 dark:border-slate-700">
                          <span class="text-slate-500 dark:text-slate-400">æˆåŠŸç‡:</span>
                          <span class="font-bold" [class.text-green-500]="queueStatus.stats.total > 0 && (queueStatus.stats.completed / queueStatus.stats.total) >= 0.9" [class.text-yellow-500]="queueStatus.stats.total > 0 && (queueStatus.stats.completed / queueStatus.stats.total) >= 0.7 && (queueStatus.stats.completed / queueStatus.stats.total) < 0.9" [class.text-red-500]="queueStatus.stats.total > 0 && (queueStatus.stats.completed / queueStatus.stats.total) < 0.7">
                            {{ queueStatus.stats.total > 0 ? ((queueStatus.stats.completed / queueStatus.stats.total) * 100).toFixed(1) : 0 }}%
                          </span>
                        </div>
                        @if(queueStatus.paused) {
                          <div class="flex items-center gap-1 mt-1">
                            <span class="text-xs text-yellow-500 font-semibold">â¸ å·²æš‚åœ</span>
                          </div>
                        }
                        <div class="flex gap-1 mt-2">
                          @if(queueStatus.paused) {
                            <button (click)="resumeQueue(account.phone)" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded transition duration-200" title="æ¢å¤é˜Ÿåˆ—">â–¶</button>
                          } @else {
                            <button (click)="pauseQueue(account.phone)" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold py-1 px-2 rounded transition duration-200" title="æš‚åœé˜Ÿåˆ—">â¸</button>
                          }
                          <button (click)="clearQueue(account.phone)" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded transition duration-200" title="æ¸…ç©ºé˜Ÿåˆ—">æ¸…ç©º</button>
                          <button (click)="viewQueueDetails(account.phone)" class="bg-cyan-500 hover:bg-cyan-600 text-white text-xs font-bold py-1 px-2 rounded transition duration-200" title="æŸ¥çœ‹è¯¦æƒ…">è¯¦æƒ…</button>
                        </div>
                      </div>
                    } @else {
                      <span class="text-xs text-slate-400">æ— é˜Ÿåˆ—</span>
                    }
                  </td>
                  <td class="py-4 px-6"><span class="px-2.5 py-1 text-xs font-semibold rounded-full" [class]="getStatusColor(account.status)">{{ t(account.status) }}</span></td>
                  <td class="py-4 px-6 text-right">
                    <div class="flex items-center justify-end gap-3">
                      <button (click)="checkAccountStatus(account.id)" class="text-blue-400 hover:text-blue-300 font-medium transition-colors" [title]="t('checkStatus')"><svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg></button>
                      <button (click)="exportSession(account.phone)" class="text-purple-400 hover:text-purple-300 font-medium transition-colors" [title]="t('exportSession')"><svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>
                      @if(account.status === 'Offline' || account.status === 'Banned' || account.status === 'Proxy Error') {<button (click)="loginAccount(account.id)" class="text-green-400 hover:text-green-300 font-medium transition-colors" [title]="t('login')"><svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></button>}
                      <button (click)="removeById(accounts, account.id, 'account')" class="text-red-400 hover:text-red-300 font-medium transition-colors" [title]="t('remove')"><svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                    </div>
                  </td>
                </tr>
              } @empty {
                <tr><td colspan="9" class="text-center p-8 text-slate-500">{{t('noAccountsFound')}}</td></tr>
              }
            </tbody>
          </table>
        </div>
        
        <!-- Queue Details Modal -->
        @if(selectedQueuePhone()) {
          <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-slate-100 dark:bg-slate-900 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden border border-slate-500/20 flex flex-col">
              <div class="p-6 border-b border-slate-300 dark:border-slate-700 flex items-center justify-between">
                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">é˜Ÿåˆ—è¯¦æƒ… - {{ selectedQueuePhone() }}</h3>
                <button (click)="closeQueueDetails()" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 text-2xl font-bold">&times;</button>
              </div>
              <div class="flex-1 overflow-y-auto p-6">
                <div class="mb-4 flex gap-2">
                  <select (change)="getQueueMessages(selectedQueuePhone()!, $any($event.target).value)" class="form-select bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="pending">å¾…å‘é€</option>
                    <option value="processing">å‘é€ä¸­</option>
                    <option value="retrying">é‡è¯•ä¸­</option>
                    <option value="failed">å¤±è´¥</option>
                    <option value="completed">å·²å®Œæˆ</option>
                  </select>
                  <button (click)="getQueueMessages(selectedQueuePhone()!)" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm">åˆ·æ–°</button>
                </div>
                <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-lg overflow-hidden">
                  <table class="w-full text-sm">
                    <thead class="bg-slate-300/50 dark:bg-slate-700/50">
                      <tr>
                        <th class="py-2 px-4 text-left">ID</th>
                        <th class="py-2 px-4 text-left">ç”¨æˆ·ID</th>
                        <th class="py-2 px-4 text-left">æ¶ˆæ¯å†…å®¹</th>
                        <th class="py-2 px-4 text-left">ä¼˜å…ˆçº§</th>
                        <th class="py-2 px-4 text-left">çŠ¶æ€</th>
                        <th class="py-2 px-4 text-left">å°è¯•æ¬¡æ•°</th>
                        <th class="py-2 px-4 text-left">åˆ›å»ºæ—¶é—´</th>
                        <th class="py-2 px-4 text-left">æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for(msg of queueMessages(); track msg.id) {
                        <tr class="border-b border-slate-300 dark:border-slate-700 hover:bg-slate-200/50 dark:hover:bg-slate-700/50">
                          <td class="py-2 px-4 font-mono text-xs">{{ msg.id.substring(0, 8) }}...</td>
                          <td class="py-2 px-4">{{ msg.user_id }}</td>
                          <td class="py-2 px-4 max-w-xs truncate" [title]="msg.text">{{ msg.text }}</td>
                          <td class="py-2 px-4">
                            <select [value]="msg.priority" (change)="updateQueueMessagePriority(selectedQueuePhone()!, msg.id, $any($event.target).value)" class="form-select bg-slate-100 dark:bg-slate-800 border-slate-300 dark:border-slate-600 rounded text-xs p-1">
                              <option value="HIGH">é«˜</option>
                              <option value="NORMAL">ä¸­</option>
                              <option value="LOW">ä½</option>
                            </select>
                          </td>
                          <td class="py-2 px-4">
                            <span class="px-2 py-1 text-xs rounded-full" 
                                  [class.bg-yellow-500/20]="msg.status === 'pending'"
                                  [class.text-yellow-500]="msg.status === 'pending'"
                                  [class.bg-blue-500/20]="msg.status === 'processing'"
                                  [class.text-blue-500]="msg.status === 'processing'"
                                  [class.bg-orange-500/20]="msg.status === 'retrying'"
                                  [class.text-orange-500]="msg.status === 'retrying'"
                                  [class.bg-red-500/20]="msg.status === 'failed'"
                                  [class.text-red-500]="msg.status === 'failed'"
                                  [class.bg-green-500/20]="msg.status === 'completed'"
                                  [class.text-green-500]="msg.status === 'completed'">
                              {{ msg.status === 'pending' ? 'å¾…å‘é€' : msg.status === 'processing' ? 'å‘é€ä¸­' : msg.status === 'retrying' ? 'é‡è¯•ä¸­' : msg.status === 'failed' ? 'å¤±è´¥' : 'å·²å®Œæˆ' }}
                            </span>
                          </td>
                          <td class="py-2 px-4">{{ msg.attempts }} / {{ msg.max_attempts }}</td>
                          <td class="py-2 px-4 text-xs">{{ formatDate(msg.created_at) }}</td>
                          <td class="py-2 px-4">
                            <button (click)="deleteQueueMessage(selectedQueuePhone()!, msg.id)" class="text-red-400 hover:text-red-300 text-sm font-bold">åˆ é™¤</button>
                          </td>
                        </tr>
                      } @empty {
                        <tr>
                          <td colspan="8" class="py-8 text-center text-slate-500">æš‚æ— æ¶ˆæ¯</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        }
        
        <!-- Login Code Dialog -->
        @if(loginState().requiresCode || loginState().isSubmittingCode) {
          <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
            <div class="bg-slate-100 dark:bg-slate-900 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 border border-slate-500/20">
              @if(loginState().isSubmittingCode) {
                <!-- Loading State -->
                <div class="text-center">
                  <div class="mb-4">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500"></div>
                  </div>
                  <h3 class="text-xl font-bold mb-2 text-slate-900 dark:text-white">æ­£åœ¨éªŒè¯éªŒè¯ç ...</h3>
                  <p class="text-sm text-slate-600 dark:text-slate-400">
                    è¯·ç¨å€™ï¼Œæ­£åœ¨éªŒè¯æ‚¨çš„éªŒè¯ç 
                  </p>
                </div>
              } @else {
                <!-- Code Input State -->
                <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">è¾“å…¥éªŒè¯ç </h3>
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
                  éªŒè¯ç å·²å‘é€åˆ° <strong>{{loginState().phone}}</strong>
                </p>
                    <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 mb-4">
                      <p class="text-xs text-amber-800 dark:text-amber-300 font-semibold mb-2">
                        âš ï¸ é‡è¦æç¤ºï¼š
                      </p>
                      <ul class="text-xs text-amber-700 dark:text-amber-400 space-y-1 list-disc list-inside">
                        <li>éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„ Telegram åº”ç”¨ï¼ˆä¸æ˜¯çŸ­ä¿¡ï¼‰</li>
                        <li>è¯·æ£€æŸ¥æ‚¨æ‰‹æœºä¸Šå·²ç™»å½•çš„ Telegram åº”ç”¨ï¼ŒæŸ¥çœ‹éªŒè¯ç æ¶ˆæ¯</li>
                        <li>æ‰“å¼€ Telegram åº”ç”¨ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰æ¥è‡ª Telegram çš„éªŒè¯ç æ¶ˆæ¯</li>
                        <li>å¦‚æœæœªæ”¶åˆ°ï¼Œè¯·ç‚¹å‡»"é‡æ–°å‘é€"æŒ‰é’®ï¼Œç³»ç»Ÿå°†é‡æ–°å‘é€éªŒè¯ç åˆ°æ‚¨çš„ Telegram åº”ç”¨</li>
                      </ul>
                    </div>
                <div class="space-y-4">
                  <input 
                    type="text" 
                    [(ngModel)]="loginCode" 
                    (keyup.enter)="submitLoginCode()"
                    placeholder="è¾“å…¥éªŒè¯ç "
                    class="w-full bg-slate-200/50 dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-lg text-center font-mono tracking-widest"
                    maxlength="6"
                    autofocus>
                  <div class="flex gap-3">
                    <button 
                      (click)="submitLoginCode()" 
                      [disabled]="!loginCode().trim() || loginCode().length < 5"
                      class="flex-1 bg-cyan-500 hover:bg-cyan-600 disabled:bg-slate-400 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                      æäº¤
                    </button>
                    <button 
                      (click)="resendVerificationCode()" 
                      class="px-4 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-900 dark:text-white font-bold py-2 rounded-lg transition duration-200">
                      é‡æ–°å‘é€
                    </button>
                    <button 
                      (click)="cancelLogin()" 
                      class="flex-1 bg-slate-300 dark:bg-slate-700 hover:bg-slate-400 dark:hover:bg-slate-600 text-slate-900 dark:text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                      å–æ¶ˆ
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- Login 2FA Dialog -->
        @if(loginState().requires2FA) {
          <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
            <div class="bg-slate-100 dark:bg-slate-900 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 border border-slate-500/20">
              <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">è¾“å…¥ 2FA å¯†ç </h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
                è´¦æˆ· <strong>{{loginState().phone}}</strong> éœ€è¦ä¸¤æ­¥éªŒè¯å¯†ç 
              </p>
              <div class="space-y-4">
                <input 
                  type="password" 
                  [(ngModel)]="login2FAPassword" 
                  (keyup.enter)="submitLogin2FA()"
                  placeholder="è¾“å…¥ 2FA å¯†ç "
                  class="w-full bg-slate-200/50 dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-lg"
                  autofocus>
                <div class="flex gap-3">
                  <button 
                    (click)="submitLogin2FA()" 
                    class="flex-1 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    æäº¤
                  </button>
                  <button 
                    (click)="cancelLogin()" 
                    class="flex-1 bg-slate-300 dark:bg-slate-700 hover:bg-slate-400 dark:hover:bg-slate-600 text-slate-900 dark:text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    å–æ¶ˆ
                  </button>
                </div>
              </div>
            </div>
          </div>
        }
      }
      @case ('resources') {
        <!-- è³‡æºç™¼ç¾é é¢ -->
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ”</span> {{ t('resourceDiscoveryTitle') }}
        </h2>
        
        <!-- Tab å°èˆª -->
        <div class="flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-lg w-fit">
          <button (click)="resourcesTab.set('resources')" 
                  [class]="resourcesTab() === 'resources' ? 'bg-cyan-500/30 text-cyan-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ”</span> ç¾¤çµ„/é »é“
          </button>
          <button (click)="resourcesTab.set('discussions'); loadChannelDiscussions(); refreshDiscussionStats()" 
                  [class]="resourcesTab() === 'discussions' ? 'bg-cyan-500/30 text-cyan-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ’¬</span> è¨è«–çµ„ç›£æ§
          </button>
        </div>
        
        @if (resourcesTab() === 'resources') {
        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-blue-500/30 p-4 rounded-xl text-center">
            <div class="text-3xl mb-2">ğŸ“Š</div>
            <div class="text-2xl font-bold text-blue-400">{{ resourceStats().total_resources }}</div>
            <div class="text-sm text-slate-400">{{ t('totalResources') }}</div>
          </div>
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-green-500/30 p-4 rounded-xl text-center">
            <div class="text-3xl mb-2">ğŸ†•</div>
            <div class="text-2xl font-bold text-green-400">{{ resourceStats().today_discovered }}</div>
            <div class="text-sm text-slate-400">{{ t('todayDiscovered') }}</div>
          </div>
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-yellow-500/30 p-4 rounded-xl text-center">
            <div class="text-3xl mb-2">ğŸ“‹</div>
            <div class="text-2xl font-bold text-yellow-400">{{ resourceStats().pending_joins }}</div>
            <div class="text-sm text-slate-400">{{ t('pendingJoins') }}</div>
          </div>
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-emerald-500/30 p-4 rounded-xl text-center">
            <div class="text-3xl mb-2">âœ…</div>
            <div class="text-2xl font-bold text-emerald-400">{{ resourceStats().joined_count }}</div>
            <div class="text-sm text-slate-400">{{ t('joinedCount') }}</div>
          </div>
        </div>
        
        <!-- æ“ä½œå€ -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-6">
          <!-- ç³»çµ±ç‹€æ…‹å’Œåˆå§‹åŒ– -->
          <div class="flex items-center gap-4 mb-4">
            <span class="px-3 py-1.5 rounded-lg text-sm" [class]="resourceDiscoveryInitialized() ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'">
              {{ resourceDiscoveryInitialized() ? 'ğŸŸ¢ ç³»çµ±åœ¨ç·š' : 'ğŸ”´ æœªåˆå§‹åŒ–' }}
            </span>
            <button (click)="initResourceDiscovery()" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg transition-all border border-cyan-500/30">
              ğŸš€ {{ t('initResourceDiscovery') }}
            </button>
            <button (click)="processJoinQueue()" [disabled]="isProcessingJoinQueue() || resourceStats().pending_joins === 0"
                    class="px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded-lg transition-all border border-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed">
              {{ isProcessingJoinQueue() ? 'â³ è™•ç†ä¸­...' : 'ğŸš€ ' + t('processJoinQueue') }}
            </button>
            <button (click)="refreshAllResources()" [disabled]="isRefreshing()" 
                    class="px-4 py-2 bg-slate-500/20 hover:bg-slate-500/30 text-slate-400 rounded-lg transition-all disabled:opacity-50">
              {{ isRefreshing() ? 'ğŸ”„ åˆ·æ–°ä¸­...' : 'ğŸ”„ åˆ·æ–°' }}
            </button>
            <button (click)="clearSearchResults()" 
                    class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-all border border-red-500/30">
              ğŸ—‘ï¸ æ¸…ç©ºçµæœ
            </button>
          </div>
          
          <!-- æœç´¢æ¡† -->
          <div class="flex gap-3 mb-4">
            <input type="text" [(ngModel)]="resourceSearchQuery" (keyup.enter)="searchResources()"
                   placeholder="è¼¸å…¥é—œéµè©æœç´¢ï¼ˆå¤šå€‹ç”¨é€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šæ”¯ä»˜,æ”¶æ¬¾,USDTï¼‰"
                   class="flex-1 bg-slate-700/50 border border-slate-600 rounded-lg py-3 px-4 text-white focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500">
            <button (click)="showSearchOptions.set(!showSearchOptions())" 
                    class="px-4 py-3 bg-slate-600/50 hover:bg-slate-600 text-slate-300 rounded-lg transition-all border border-slate-500/30"
                    title="æœç´¢é¸é …">
              âš™ï¸
            </button>
            <button (click)="searchResources()" [disabled]="isSearchingResources()"
                    class="px-6 py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg transition-all disabled:opacity-50 font-medium">
              {{ isSearchingResources() ? 'ğŸ” æœç´¢ä¸­...' : 'ğŸ” æœç´¢' }}
            </button>
          </div>
          
          <!-- æœç´¢æ¨¡å¼é¸é … -->
          <div class="flex items-center gap-4 mb-4 text-sm">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" [checked]="searchReplaceMode()" (change)="searchReplaceMode.set(!searchReplaceMode())"
                     class="w-4 h-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-500">
              <span class="text-slate-300">æ›¿æ›æ¨¡å¼</span>
              <span class="text-slate-500 text-xs">ï¼ˆæ¯æ¬¡æœç´¢æ¸…ç©ºèˆŠçµæœï¼‰</span>
            </label>
          </div>
          
          <!-- æœç´¢é¸é …é¢æ¿ -->
          @if (showSearchOptions()) {
            <div class="bg-slate-800/50 rounded-lg p-4 mb-4 border border-slate-600/50">
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm text-slate-400 mb-1">è³‡æºé¡å‹</label>
                  <select [ngModel]="resourceSearchType()" (ngModelChange)="resourceSearchType.set($event)"
                          class="w-full bg-slate-700/50 border border-slate-600 rounded-lg py-2 px-3 text-white">
                    <option value="all">å…¨éƒ¨é¡å‹</option>
                    <option value="group">ç¾¤çµ„</option>
                    <option value="supergroup">è¶…ç´šç¾¤çµ„</option>
                    <option value="channel">é »é“</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">æœ€å°æˆå“¡æ•¸</label>
                  <input type="number" [ngModel]="resourceMinMembers()" (ngModelChange)="resourceMinMembers.set($event)"
                         min="0" step="100" placeholder="0"
                         class="w-full bg-slate-700/50 border border-slate-600 rounded-lg py-2 px-3 text-white">
                </div>
                <div class="flex items-end">
                  <button (click)="resourceSearchType.set('all'); resourceMinMembers.set(0)"
                          class="px-4 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-all">
                    é‡ç½®ç¯©é¸
                  </button>
                </div>
              </div>
            </div>
          }
          
          <!-- é—œéµè©æ¨™ç±¤ -->
          <div class="mb-4">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-sm text-slate-400">{{ t('discoveryKeywords') }}:</span>
              <button (click)="showAddKeywordDialog.set(true)" class="text-xs px-2 py-1 bg-cyan-500/20 text-cyan-400 rounded hover:bg-cyan-500/30">
                â• {{ t('addKeyword') }}
              </button>
            </div>
            <div class="flex flex-wrap gap-2">
              @for (kw of discoveryKeywords(); track kw.id) {
                <button (click)="searchWithKeyword(kw.keyword)" 
                        class="px-3 py-1.5 text-sm bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 rounded-full border border-slate-600 transition-all">
                  {{ kw.keyword }}
                  <span class="text-slate-500 ml-1">({{ kw.total_found }})</span>
                </button>
              }
            </div>
          </div>
        </div>
        
        <!-- è³‡æºåˆ—è¡¨ -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
          <!-- éæ¿¾å’Œæ‰¹é‡æ“ä½œ -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <select [(ngModel)]="resourceFilterStatus" (ngModelChange)="resourceFilterStatus.set($event); loadResources()" 
                      class="bg-slate-700/50 border border-slate-600 rounded-lg py-2 px-3 text-white">
                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                <option value="discovered">å·²ç™¼ç¾</option>
                <option value="queued">éšŠåˆ—ä¸­</option>
                <option value="joined">å·²åŠ å…¥</option>
                <option value="blocked">è¢«å°ç¦</option>
              </select>
              <select [(ngModel)]="resourceFilterType" (ngModelChange)="resourceFilterType.set($event); loadResources()"
                      class="bg-slate-700/50 border border-slate-600 rounded-lg py-2 px-3 text-white">
                <option value="">å…¨éƒ¨é¡å‹</option>
                <option value="group">ç¾¤çµ„</option>
                <option value="supergroup">è¶…ç´šç¾¤çµ„</option>
                <option value="channel">é »é“</option>
              </select>
            </div>
            
            @if (selectedResourceIds().length > 0) {
              <div class="flex items-center gap-3">
                <span class="text-sm text-slate-400">{{ selectedResourceIds().length }} {{ t('selectedCount') }}</span>
                <button (click)="addSelectedToJoinQueue()" class="px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded-lg border border-blue-500/30">
                  ğŸ“‹ {{ t('addToQueue') }}
                </button>
                <button (click)="batchJoinSelected()" class="px-4 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg border border-green-500/30">
                  ğŸš€ {{ t('batchJoin') }}
                </button>
                <button (click)="batchJoinAndMonitor()" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg border border-purple-500/30">
                  ğŸ¯ æ‰¹é‡åŠ å…¥+ç›£æ§
                </button>
              </div>
            }
          </div>
          
          <!-- è¡¨æ ¼ -->
          <div class="overflow-x-auto">
            @if (discoveredResources().length === 0) {
              <div class="text-center py-12 text-slate-500">
                <div class="text-5xl mb-4">ğŸ”</div>
                <p class="text-lg">{{ t('noResourcesFound') }}</p>
                <p class="text-sm mt-2">ä½¿ç”¨ä¸Šæ–¹æœç´¢æ¡†é–‹å§‹æœç´¢ç¾¤çµ„å’Œé »é“</p>
              </div>
            } @else {
              <table class="w-full">
                <thead class="text-slate-400 text-left bg-slate-800/50">
                  <tr>
                    <th class="p-3 w-10">
                      <input type="checkbox" [checked]="selectedResourceIds().length === discoveredResources().length && discoveredResources().length > 0"
                             (change)="toggleSelectAllResources()" class="form-checkbox rounded text-cyan-500">
                    </th>
                    <th class="p-3">{{ t('resourceType') }}</th>
                    <th class="p-3">æ¨™é¡Œ</th>
                    <th class="p-3">{{ t('memberCount') }}</th>
                    <th class="p-3">{{ t('overallScore') }}</th>
                    <th class="p-3">{{ t('resourceStatus') }}</th>
                    <th class="p-3">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  @for (resource of discoveredResources(); track resource.id) {
                    <tr class="border-b border-slate-700/50 hover:bg-slate-700/30 transition-colors">
                      <td class="p-3">
                        <input type="checkbox" [checked]="selectedResourceIds().includes(resource.id)"
                               (change)="toggleResourceSelection(resource.id)" class="form-checkbox rounded text-cyan-500">
                      </td>
                      <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs" 
                              [class]="resource.resource_type === 'channel' ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400'">
                          {{ getResourceTypeName(resource.resource_type) }}
                        </span>
                      </td>
                      <td class="p-3">
                        <div class="font-medium text-white truncate max-w-xs" [title]="resource.title">{{ resource.title }}</div>
                        @if (resource.username) {
                          <button (click)="openTelegramLink(resource)" 
                                  class="text-xs text-cyan-400 hover:text-cyan-300 hover:underline cursor-pointer">
                            &#64;{{ resource.username }} â†—
                          </button>
                        }
                        @if (resource.description) {
                          <div class="text-xs text-slate-500 truncate max-w-xs mt-0.5" [title]="resource.description">
                            {{ resource.description | slice:0:50 }}{{ resource.description.length > 50 ? '...' : '' }}
                          </div>
                        }
                      </td>
                      <td class="p-3">
                        <span class="text-slate-300 font-medium">{{ formatMemberCount(resource.member_count) }}</span>
                        <span class="text-xs text-slate-500 ml-1">äºº</span>
                      </td>
                      <td class="p-3">
                        <div class="flex items-center gap-2">
                          <div class="w-20 bg-slate-700 rounded-full h-2">
                            <div class="h-2 rounded-full bg-cyan-500" [style.width.%]="resource.overall_score * 100"></div>
                          </div>
                          <span class="text-xs text-slate-400">{{ (resource.overall_score * 100).toFixed(0) }}%</span>
                        </div>
                      </td>
                      <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs" [class]="getResourceStatusColor(resource.status) + '/20 text-white'">
                          {{ getResourceStatusName(resource.status) }}
                        </span>
                      </td>
                      <td class="p-3">
                        <div class="flex items-center gap-1">
                          @if (resource.username) {
                            <button (click)="openTelegramLink(resource)" 
                                    class="px-2 py-1 bg-cyan-500/20 text-cyan-400 rounded text-xs hover:bg-cyan-500/30 transition-colors"
                                    title="æ‰“é–‹">
                              ğŸ”—
                            </button>
                          }
                          @if (resource.status !== 'joined') {
                            <button (click)="quickJoinResource(resource.id)" 
                                    class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs hover:bg-green-500/30 transition-colors"
                                    title="åŠ å…¥">
                              â•
                            </button>
                            <button (click)="joinAndMonitor(resource.id)" 
                                    class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs hover:bg-purple-500/30 transition-colors"
                                    title="åŠ å…¥ä¸¦ç›£æ§">
                              ğŸš€
                            </button>
                          }
                          <button (click)="copyTelegramLink(resource)" 
                                  class="px-2 py-1 bg-slate-500/20 text-slate-400 rounded text-xs hover:bg-slate-500/30 transition-colors"
                                  title="è¤‡è£½éˆæ¥">
                            ğŸ“‹
                          </button>
                          <button (click)="deleteResource(resource.id)" 
                                  class="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs hover:bg-red-500/30 transition-colors"
                                  title="åˆªé™¤">
                            ğŸ—‘ï¸
                          </button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            }
          </div>
        </div>
        
        <!-- æ·»åŠ é—œéµè©å°è©±æ¡† -->
        @if (showAddKeywordDialog()) {
          <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="showAddKeywordDialog.set(false)">
            <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6 border border-cyan-500/30" (click)="$event.stopPropagation()">
              <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <span>ğŸ”‘</span> {{ t('addKeyword') }}
              </h3>
              <input type="text" [(ngModel)]="newResourceKeyword" (keyup.enter)="addDiscoveryKeyword()"
                     placeholder="è¼¸å…¥æœç´¢é—œéµè©..."
                     class="w-full bg-slate-700 border border-slate-600 rounded-lg py-3 px-4 text-white mb-4">
              <div class="flex gap-3">
                <button (click)="showAddKeywordDialog.set(false)" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2.5 rounded-lg">
                  {{ t('cancel') }}
                </button>
                <button (click)="addDiscoveryKeyword()" class="flex-1 bg-cyan-500 hover:bg-cyan-600 text-white py-2.5 rounded-lg">
                  ç¢ºèªæ·»åŠ 
                </button>
              </div>
            </div>
          </div>
        }
        } @else {
        <!-- è¨è«–çµ„ç›£æ§ Tab -->
        
        <!-- è¨è«–çµ„çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-slate-900/50 border border-purple-500/30 p-4 rounded-xl text-center">
            <div class="text-2xl mb-1">ğŸ’¬</div>
            <div class="text-xl font-bold text-purple-400">{{ discussionStats().total_discussions }}</div>
            <div class="text-xs text-slate-400">è¨è«–çµ„ç¸½æ•¸</div>
          </div>
          <div class="bg-slate-900/50 border border-green-500/30 p-4 rounded-xl text-center">
            <div class="text-2xl mb-1">ğŸŸ¢</div>
            <div class="text-xl font-bold text-green-400">{{ discussionStats().monitoring_count }}</div>
            <div class="text-xs text-slate-400">ç›£æ§ä¸­</div>
          </div>
          <div class="bg-slate-900/50 border border-cyan-500/30 p-4 rounded-xl text-center">
            <div class="text-2xl mb-1">ğŸ“¨</div>
            <div class="text-xl font-bold text-cyan-400">{{ discussionStats().today_messages }}</div>
            <div class="text-xs text-slate-400">ä»Šæ—¥æ¶ˆæ¯</div>
          </div>
          <div class="bg-slate-900/50 border border-yellow-500/30 p-4 rounded-xl text-center">
            <div class="text-2xl mb-1">ğŸ‘¤</div>
            <div class="text-xl font-bold text-yellow-400">{{ discussionStats().leads_from_discussions }}</div>
            <div class="text-xs text-slate-400">æ•ç²çš„ Lead</div>
          </div>
        </div>
        
        <!-- æ“ä½œå€ -->
        <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl mb-6">
          <div class="flex items-center gap-4 mb-4">
            <span class="px-3 py-1.5 rounded-lg text-sm" [class]="discussionWatcherInitialized() ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'">
              {{ discussionWatcherInitialized() ? 'ğŸŸ¢ æœå‹™åœ¨ç·š' : 'ğŸ”´ æœªåˆå§‹åŒ–' }}
            </span>
            <button (click)="initDiscussionWatcher()" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg border border-purple-500/30">
              ğŸš€ åˆå§‹åŒ–ç›£æ§æœå‹™
            </button>
            <button (click)="discoverDiscussionsFromResources()" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg border border-cyan-500/30">
              ğŸ”„ å¾è³‡æºç™¼ç¾è¨è«–çµ„
            </button>
            <button (click)="refreshDiscussionStats()" class="px-4 py-2 bg-slate-500/20 hover:bg-slate-500/30 text-slate-400 rounded-lg">
              ğŸ”„ åˆ·æ–°
            </button>
          </div>
          
          <!-- æ‰‹å‹•æ·»åŠ é »é“ -->
          <div class="flex gap-3">
            <input type="text" [(ngModel)]="discoverChannelId" (keyup.enter)="discoverDiscussion()"
                   placeholder="è¼¸å…¥é »é“ ID æˆ– @username ç™¼ç¾è¨è«–çµ„..."
                   class="flex-1 bg-slate-700/50 border border-slate-600 rounded-lg py-2 px-3 text-white">
            <button (click)="discoverDiscussion()" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg">
              ğŸ” ç™¼ç¾è¨è«–çµ„
            </button>
          </div>
        </div>
        
        <!-- è¨è«–çµ„åˆ—è¡¨ -->
        <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl">
          <h3 class="text-lg font-semibold text-white mb-4">ğŸ“‹ é »é“-è¨è«–çµ„åˆ—è¡¨</h3>
          
          @if (channelDiscussions().length === 0) {
            <div class="text-center py-12 text-slate-500">
              <div class="text-5xl mb-4">ğŸ’¬</div>
              <p class="text-lg">æš«ç„¡è¨è«–çµ„</p>
              <p class="text-sm mt-2">å¾å·²åŠ å…¥çš„é »é“ç™¼ç¾è¨è«–çµ„ï¼Œæˆ–æ‰‹å‹•æ·»åŠ é »é“</p>
            </div>
          } @else {
            <div class="space-y-3">
              @for (disc of channelDiscussions(); track disc.id) {
                <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700 hover:border-purple-500/30 transition-all">
                  <div class="flex items-center justify-between">
                    <div class="flex-1">
                      <div class="flex items-center gap-3 mb-2">
                        <span class="text-lg">ğŸ“º</span>
                        <span class="font-medium text-white">{{ disc.channel_title }}</span>
                        <span class="text-slate-500">â†’</span>
                        <span class="text-lg">ğŸ’¬</span>
                        <span class="font-medium text-purple-400">{{ disc.discussion_title }}</span>
                      </div>
                      <div class="flex items-center gap-4 text-sm text-slate-400">
                        <span>ğŸ“¨ {{ disc.message_count }} æ¶ˆæ¯</span>
                        <span>ğŸ‘¤ {{ disc.lead_count }} Lead</span>
                        @if (disc.last_message_at) {
                          <span>ğŸ• {{ disc.last_message_at | date:'MM/dd HH:mm' }}</span>
                        }
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      @if (disc.is_monitoring) {
                        <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs">ç›£æ§ä¸­</span>
                        <button (click)="stopDiscussionMonitoring(disc.discussion_id)" class="px-3 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded">
                          åœæ­¢
                        </button>
                      } @else {
                        <button (click)="startDiscussionMonitoring(disc.discussion_id)" class="px-3 py-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded">
                          é–‹å§‹ç›£æ§
                        </button>
                      }
                      <button (click)="loadDiscussionMessages(disc.discussion_id)" class="px-3 py-1 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded">
                        æŸ¥çœ‹æ¶ˆæ¯
                      </button>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
        
        <!-- è¨è«–çµ„æ¶ˆæ¯åˆ—è¡¨ï¼ˆç•¶é¸ä¸­æ™‚é¡¯ç¤ºï¼‰ -->
        @if (selectedDiscussionId() && discussionMessages().length > 0) {
          <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl mt-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-white">ğŸ“¨ è¨è«–çµ„æ¶ˆæ¯</h3>
              <button (click)="selectedDiscussionId.set('')" class="text-slate-400 hover:text-white">âœ• é—œé–‰</button>
            </div>
            <div class="space-y-2 max-h-96 overflow-y-auto">
              @for (msg of discussionMessages(); track msg.id) {
                <div class="p-3 rounded-lg" [class]="msg.is_matched ? 'bg-yellow-500/10 border border-yellow-500/30' : 'bg-slate-800/50'">
                  <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-white">{{ msg.first_name || '@' + msg.username }}</span>
                      @if (msg.is_matched) {
                        <span class="px-2 py-0.5 bg-yellow-500/20 text-yellow-400 rounded text-xs">ğŸ¯ åŒ¹é…</span>
                      }
                    </div>
                    <span class="text-xs text-slate-500">{{ msg.created_at | date:'MM/dd HH:mm' }}</span>
                  </div>
                  <p class="text-sm text-slate-300">{{ msg.message_text }}</p>
                  @if (msg.matched_keywords && msg.matched_keywords.length > 0) {
                    <div class="mt-1 flex gap-1">
                      @for (kw of msg.matched_keywords; track kw) {
                        <span class="px-1.5 py-0.5 bg-yellow-500/20 text-yellow-400 rounded text-xs">{{ kw }}</span>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }
        }
      }
      @case ('automation') {
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-4xl font-bold text-slate-900 dark:text-white">{{ t('automationHub') }}</h2>
          <div class="flex items-center gap-4">
            <span class="text-sm" [class.text-green-400]="isMonitoring()" [class.text-slate-400]="!isMonitoring()">
              {{ isMonitoring() ? 'ç›‘æ§ä¸­' : 'ç›‘æ§å·²åœæ­¢' }}
              <span class="inline-block w-2 h-2 rounded-full ml-2" [class.bg-green-400]="isMonitoring()" [class.bg-slate-400]="!isMonitoring()" [class.animate-pulse]="isMonitoring()"></span>
            </span>
            @if(!isMonitoring()) {
              <button (click)="startMonitoring()" [disabled]="isStartingMonitoring()" [class.opacity-50]="isStartingMonitoring()" [class.cursor-not-allowed]="isStartingMonitoring()" class="bg-green-500 hover:bg-green-600 disabled:bg-green-400 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg shadow-green-500/20 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                å¼€å§‹ç›‘æ§
              </button>
            } @else {
              <button (click)="stopMonitoring()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg shadow-red-500/20 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/></svg>
                åœæ­¢ç›‘æ§
              </button>
            }
          </div>
        </div>
        
        <!-- é…ç½®æª¢æŸ¥ç‹€æ…‹é¢æ¿ -->
        @if(lastConfigCheck()) {
            <div class="mb-6 bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border rounded-xl shadow-lg overflow-hidden"
                 [class.border-red-500/50]="!lastConfigCheck()!.passed"
                 [class.border-yellow-500/50]="lastConfigCheck()!.passed && lastConfigCheck()!.warnings.length > 0"
                 [class.border-green-500/50]="lastConfigCheck()!.passed && lastConfigCheck()!.warnings.length === 0">
                
                <!-- æ¨™é¡Œæ¬„ -->
                <div class="px-4 py-3 flex items-center justify-between"
                     [class.bg-red-500/10]="!lastConfigCheck()!.passed"
                     [class.bg-yellow-500/10]="lastConfigCheck()!.passed && lastConfigCheck()!.warnings.length > 0"
                     [class.bg-green-500/10]="lastConfigCheck()!.passed && lastConfigCheck()!.warnings.length === 0">
                    <div class="flex items-center gap-2">
                        @if(!lastConfigCheck()!.passed) {
                            <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span class="font-semibold text-red-400">é…ç½®æª¢æŸ¥å¤±æ•—</span>
                        } @else if(lastConfigCheck()!.warnings.length > 0) {
                            <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span class="font-semibold text-yellow-400">é…ç½®æœ‰è­¦å‘Š</span>
                        } @else {
                            <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="font-semibold text-green-400">é…ç½®æª¢æŸ¥é€šé</span>
                        }
                    </div>
                    <button (click)="lastConfigCheck.set(null)" class="text-slate-400 hover:text-slate-300 text-sm">é—œé–‰</button>
                </div>
                
                <div class="px-4 py-3 space-y-2">
                    <!-- åš´é‡å•é¡Œ -->
                    @for(issue of lastConfigCheck()!.critical_issues; track issue.code) {
                        <div (click)="navigateToError(issue.code)" 
                             class="flex items-start gap-2 p-2 bg-red-500/10 rounded-lg cursor-pointer hover:bg-red-500/20 transition-colors group">
                            <span class="text-red-400">âœ—</span>
                            <div class="flex-1">
                                <p class="text-sm text-red-400 font-medium">{{ issue.message }}</p>
                                <p class="text-xs text-slate-400 mt-1">ä¿®å¾©: {{ issue.fix }}</p>
                            </div>
                            <span class="text-xs text-slate-500 group-hover:text-cyan-400 transition-colors">é»æ“Šå‰å¾€ â†’</span>
                        </div>
                    }
                    
                    <!-- è­¦å‘Š -->
                    @for(warning of lastConfigCheck()!.warnings; track warning.code) {
                        <div (click)="navigateToError(warning.code)" 
                             class="flex items-start gap-2 p-2 bg-yellow-500/10 rounded-lg cursor-pointer hover:bg-yellow-500/20 transition-colors group">
                            <span class="text-yellow-400">âš </span>
                            <div class="flex-1">
                                <p class="text-sm text-yellow-400 font-medium">{{ warning.message }}</p>
                                <p class="text-xs text-slate-400 mt-1">ä¿®å¾©: {{ warning.fix }}</p>
                            </div>
                            <span class="text-xs text-slate-500 group-hover:text-cyan-400 transition-colors">é»æ“Šå‰å¾€ â†’</span>
                        </div>
                    }
                    
                    <!-- ä¿¡æ¯ï¼ˆæ‘ºç–Šé¡¯ç¤ºï¼‰ -->
                    @if(lastConfigCheck()!.info.length > 0) {
                        <details class="mt-2">
                            <summary class="text-sm text-slate-400 cursor-pointer hover:text-slate-300">
                                æŸ¥çœ‹ {{ lastConfigCheck()!.info.length }} é …é…ç½®è©³æƒ…
                            </summary>
                            <div class="mt-2 space-y-1 pl-4">
                                @for(info of lastConfigCheck()!.info; track info) {
                                    <p class="text-sm text-slate-400">{{ info }}</p>
                                }
                            </div>
                        </details>
                    }
                    
                    <!-- æ‘˜è¦ -->
                    @if(lastConfigCheck()!.summary) {
                        <div class="flex items-center gap-4 mt-3 pt-3 border-t border-slate-700/50 text-xs text-slate-400">
                            <span [class.text-green-400]="lastConfigCheck()!.summary.can_monitor" [class.text-red-400]="!lastConfigCheck()!.summary.can_monitor">
                                ç›£æ§: {{ lastConfigCheck()!.summary.can_monitor ? 'å¯å•Ÿå‹•' : 'ç„¡æ³•å•Ÿå‹•' }}
                            </span>
                            <span [class.text-green-400]="lastConfigCheck()!.summary.can_send_messages" [class.text-yellow-400]="!lastConfigCheck()!.summary.can_send_messages">
                                ç™¼é€æ¶ˆæ¯: {{ lastConfigCheck()!.summary.can_send_messages ? 'å¯ç™¼é€' : 'ç„¡æ³•ç™¼é€' }}
                            </span>
                        </div>
                    }
                </div>
            </div>
        }
        
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8 items-start">
            <!-- Column 1: Monitoring Targets -->
            <div class="space-y-8">
                <div id="keyword-sets-section" class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg transition-all duration-300">
                    <h3 class="text-xl mb-4 font-semibold">{{ t('monitoringTargets') }}</h3>
                    <div class="space-y-4">
                        <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-2">{{ t('keywordSets') }}</h4>
                            <form (submit)="addKeywordSet()" class="flex items-end gap-2">
                                <div class="flex-grow"><input [(ngModel)]="newKeywordSet().name" name="keywordSetName" class="form-input w-full bg-slate-100 dark:bg-slate-700/50 border-slate-300 dark:border-slate-600 rounded-lg p-2 text-sm" [placeholder]="t('newKeywordSet')"></div>
                                <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20 text-sm">{{ t('add') }}</button>
                            </form>
                             @for(set of keywordSets(); track set.id) {
                                <div class="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg mt-3 border border-slate-200 dark:border-slate-600">
                                    <div class="flex justify-between items-center mb-3">
                                        <h5 class="font-semibold">{{set.name}}</h5>
                                        <button (click)="removeById(keywordSets, set.id, 'keyword-set')" class="text-red-400 hover:text-red-300 hover:bg-red-500/10 text-lg font-bold px-1 rounded transition-colors" title="åˆªé™¤é—œéµè©é›†">Ã—</button>
                                    </div>
                                    
                                    <!-- é—œéµè©è¼¸å…¥è¡¨å–® -->
                                    <form (submit)="addKeyword(); $event.preventDefault()" class="space-y-2">
                                        <div class="flex items-end gap-2">
                                            <div class="flex-1">
                                                <input 
                                                    [(ngModel)]="newKeyword().keyword" 
                                                    (focus)="newKeyword.set({setId: set.id, keyword: '', isRegex: newKeyword().isRegex})" 
                                                    (keyup.enter)="addKeyword()"
                                                    name="keyword" 
                                                    class="form-input w-full bg-slate-200 dark:bg-slate-800/50 border-slate-300 dark:border-slate-600 rounded-lg p-2 text-sm" 
                                                    [placeholder]="t('addKeywordPlaceholder')"
                                                    [class.border-red-400]="newKeyword().isRegex && newKeyword().keyword && !isRegexValid(newKeyword().keyword)">
                                                @if(newKeyword().isRegex && newKeyword().keyword && !isRegexValid(newKeyword().keyword)) {
                                                    <p class="text-xs text-red-400 mt-1">âš ï¸ {{ t('invalidRegex') }}: {{ getRegexError(newKeyword().keyword) }}</p>
                                                }
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="relative group">
                                                    <label class="flex items-center gap-2 text-sm h-full cursor-pointer">
                                                        <input 
                                                            type="checkbox" 
                                                            [(ngModel)]="newKeyword().isRegex" 
                                                            (focus)="newKeyword.set({setId: set.id, keyword: newKeyword().keyword, isRegex: false})" 
                                                            name="isRegex" 
                                                            class="form-checkbox bg-slate-200 dark:bg-slate-800/50 border-slate-300 dark:border-slate-600 rounded text-cyan-500"> 
                                                        <span class="text-slate-700 dark:text-slate-300">{{ t('regex') }}</span>
                                                    </label>
                                                    <!-- æ­£å‰‡è¡¨é”å¼å·¥å…·æç¤º -->
                                                    <div class="absolute z-10 hidden group-hover:block bottom-full mb-2 left-0 w-80 bg-slate-900 text-white text-xs rounded-lg p-3 shadow-lg">
                                                        <h4 class="font-bold mb-2">{{ t('regexTooltip') }}</h4>
                                                        <div class="space-y-1 text-slate-300">
                                                            <p class="font-semibold text-cyan-400 mb-1">{{ t('regexExamples') }}:</p>
                                                            <p>â€¢ {{ t('regexExample1') }}</p>
                                                            <p>â€¢ {{ t('regexExample2') }}</p>
                                                            <p>â€¢ {{ t('regexExample3') }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button 
                                                    type="submit" 
                                                    [disabled]="newKeyword().setId !== set.id || !newKeyword().keyword.trim()" 
                                                    [title]="newKeyword().setId !== set.id ? t('selectKeywordSetFirst') : (newKeyword().keyword.trim() ? t('addKeywordButton') : t('keywordEmpty'))"
                                                    class="bg-cyan-500 hover:bg-cyan-600 disabled:bg-slate-400 disabled:cursor-not-allowed text-white font-bold py-2 px-3 rounded-lg text-sm transition duration-200 flex items-center gap-1">
                                                    <span>+</span>
                                                    <span class="hidden sm:inline">{{ t('addKeywordButton') }}</span>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- æ¸¬è©¦åŠŸèƒ½ -->
                                        @if(newKeyword().setId === set.id && newKeyword().keyword.trim()) {
                                            <div class="bg-slate-100 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-300 dark:border-slate-600">
                                                <p class="text-xs text-slate-600 dark:text-slate-400 mb-1">{{ t('testKeyword') }}:</p>
                                                <div class="flex gap-2">
                                                    <input 
                                                        [(ngModel)]="testKeywordText" 
                                                        (keyup.enter)="testKeyword()"
                                                        (input)="onTestTextInput($event)"
                                                        name="testKeywordText"
                                                        [placeholder]="t('testKeywordPlaceholder')" 
                                                        class="flex-1 form-input bg-slate-200 dark:bg-slate-700/50 border-slate-300 dark:border-slate-600 rounded-lg p-1.5 text-xs">
                                                    <button 
                                                        type="button"
                                                        (click)="testKeyword()" 
                                                        [disabled]="!testKeywordText().trim()"
                                                        class="bg-blue-500 hover:bg-blue-600 disabled:bg-slate-400 disabled:cursor-not-allowed text-white font-bold py-1.5 px-3 rounded-lg text-xs transition duration-200">
                                                        {{ t('testKeyword') }}
                                                    </button>
                                                </div>
                                                @if(keywordTestResult()) {
                                                    <div class="mt-2 p-1.5 rounded text-xs" [class.bg-green-500/20]="keywordTestResult()!.matches" [class.bg-red-500/20]="!keywordTestResult()!.matches" [class.text-green-400]="keywordTestResult()!.matches" [class.text-red-400]="!keywordTestResult()!.matches">
                                                        @if(keywordTestResult()!.matches) {
                                                            âœ“ {{ t('keywordMatches') }}
                                                        } @else {
                                                            âœ— {{ t('keywordNoMatch') }}
                                                            @if(keywordTestResult()!.error) {
                                                                <span class="block mt-1 text-xs opacity-75">{{ keywordTestResult()!.error }}</span>
                                                            }
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </form>
                                    
                                    <!-- é—œéµè©åˆ—è¡¨ -->
                                    <div class="space-y-1 mt-3 max-h-32 overflow-y-auto">
                                        @if(set.keywords.length > 0) {
                                            @for(key of set.keywords; track key.id) {
                                                <div class="bg-slate-200 dark:bg-slate-800/50 p-1.5 rounded-md flex justify-between items-center text-sm border border-slate-300 dark:border-slate-600">
                                                    <div class="flex items-center gap-2 flex-1 min-w-0">
                                                        <p class="font-mono text-xs truncate" [title]="key.keyword">{{ key.keyword }}</p>
                                                        @if(key.isRegex) {
                                                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full flex-shrink-0" title="æ­£å‰‡è¡¨é”å¼">Regex</span>
                                                        }
                                                    </div>
                                                    <button 
                                                        (click)="removeKeywordFromSet(set.id, key.id)" 
                                                        class="text-red-400 hover:text-red-300 hover:bg-red-500/10 font-bold px-1 rounded transition-colors flex-shrink-0" 
                                                        title="åˆªé™¤é—œéµè©">Ã—</button>
                                                </div>
                                            }
                                        } @else {
                                            <p class="text-xs text-slate-500 dark:text-slate-400 text-center py-2">å°šæœªæ·»åŠ é—œéµè©</p>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                        <div id="monitored-groups-section" class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg transition-all duration-300">
                            <h4 class="font-semibold mb-2">{{ t('monitoredGroups') }}</h4>
                             <form (submit)="addGroup()" class="space-y-3">
                                <div><input [(ngModel)]="newGroup().url" name="groupUrl" class="form-input w-full bg-slate-100 dark:bg-slate-700/50 border-slate-300 dark:border-slate-600 rounded-lg p-2" [placeholder]="t('groupUrl')"></div>
                                <div>
                                    <div class="max-h-32 overflow-y-auto bg-slate-100 dark:bg-slate-700/50 border border-slate-300 dark:border-slate-600 rounded-lg p-2 space-y-1">
                                        @for(set of keywordSets(); track set.id) {
                                            <label class="flex items-center gap-2 p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-600/50"><input type="checkbox" [checked]="newGroup().keywordSetIds.includes(set.id)" (change)="toggleKeywordSetForNewGroup(set.id)" class="form-checkbox rounded text-cyan-500"> {{set.name}}</label>
                                        }
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20 text-sm">{{ t('add') }} {{t('group')}}</button>
                            </form>
                             <div class="space-y-2 mt-4 max-h-48 overflow-y-auto">
                                @for(group of monitoredGroups(); track group.id){
                                    <div class="bg-slate-50 dark:bg-slate-700/50 p-2 rounded-lg border border-slate-200 dark:border-slate-600">
                                        <div class="flex justify-between items-center">
                                            <div class="flex-1 min-w-0">
                                                <p class="font-mono font-semibold text-sm truncate" [title]="group.url">{{ group.name || group.url }}</p>
                                                <p class="text-xs text-slate-500 dark:text-slate-400 truncate mt-0.5" [title]="group.url">{{ group.url }}</p>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <button (click)="joinGroup(group.url)" 
                                                    class="text-xs bg-green-500/20 hover:bg-green-500/30 text-green-400 px-2 py-1 rounded transition-colors" 
                                                    title="è®“ç›£æ§è™ŸåŠ å…¥æ­¤ç¾¤çµ„">
                                                    åŠ å…¥
                                                </button>
                                                <button (click)="removeById(monitoredGroups, group.id, 'group')" class="text-red-400 hover:text-red-300 hover:bg-red-500/10 text-lg font-bold px-1 rounded transition-colors" title="åˆªé™¤ç¾¤çµ„">Ã—</button>
                                            </div>
                                        </div>
                                        <div class="flex flex-wrap gap-1 mt-2">
                                            @if(group.keywordSetIds.length > 0) {
                                                @for(id of group.keywordSetIds; track id) { 
                                                    <span class="text-xs bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded-full">{{ getKeywordSetName(id) }}</span> 
                                                }
                                            } @else {
                                                <span class="text-xs text-slate-400 italic">æœªåˆ†é…é—œéµè©é›†</span>
                                            }
                                        </div>
                                    </div>
                                } @empty {
                                    <p class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">å°šæœªæ·»åŠ ç›£æ§ç¾¤çµ„</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 2: Automation Campaigns -->
             <div class="space-y-8">
                <div id="campaign-rules-section" class="bg-slate-100/50 dark:bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl shadow-lg transition-all duration-300">
                    <h3 class="text-xl mb-4 font-semibold">{{t('automationRules')}}</h3>
                    <form (submit)="addCampaign()" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-1">{{t('campaignName')}}</label>
                            <input [(ngModel)]="newCampaign().name" name="campaignName" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2">
                        </div>
                        <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
                            <h4 class="font-semibold mb-2">{{t('triggers')}}</h4>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">{{t('campaignTriggerHint')}}</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{t('sourceGroups')}}</label>
                                    <div class="max-h-32 overflow-y-auto bg-slate-200/50 dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 rounded-lg p-2 space-y-1">
                                        @for(group of monitoredGroups(); track group.id) {
                                            <label class="flex items-center gap-2 p-1 rounded hover:bg-slate-300 dark:hover:bg-slate-700/50"><input type="checkbox" [checked]="newCampaign().trigger.sourceGroupIds.includes(group.id)" (change)="toggleNewCampaignSourceGroup(group.id)" class="form-checkbox rounded text-cyan-500"> {{group.name}}</label>
                                        }
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{t('keywordSets')}}</label>
                                    <div class="max-h-32 overflow-y-auto bg-slate-200/50 dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 rounded-lg p-2 space-y-1">
                                        @for(set of keywordSets(); track set.id) {
                                            <label class="flex items-center gap-2 p-1 rounded hover:bg-slate-300 dark:hover:bg-slate-700/50"><input type="checkbox" [checked]="newCampaign().trigger.keywordSetIds.includes(set.id)" (change)="toggleNewCampaignKeywordSet(set.id)" class="form-checkbox rounded text-cyan-500"> {{set.name}}</label>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
                             <h4 class="font-semibold mb-2">{{t('actions')}}</h4>
                             <div class="space-y-3">
                                <div>
                                    <div class="flex items-center justify-between mb-1">
                                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">{{t('messageTemplate')}}</label>
                                        <button type="button" (click)="showTemplateCreator.set(!showTemplateCreator())" class="text-xs bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-300 px-2 py-1 rounded transition-colors flex items-center gap-1">
                                            <span>{{ showTemplateCreator() ? 'âˆ’' : '+' }}</span>
                                            <span>{{ showTemplateCreator() ? 'æ”¶èµ·' : 'å‰µå»ºæ–°æ¨¡æ¿' }}</span>
                                        </button>
                                    </div>
                                    <select [(ngModel)]="newCampaign().action.templateId" name="actionTemplate" class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2">
                                        <option value="0" disabled>{{t('selectTemplate')}}</option>
                                        @for(template of messageTemplates(); track template.id) {
                                            <option [value]="template.id">{{template.name}}</option>
                                        }
                                    </select>
                                    @if(messageTemplates().length > 0) {
                                        <div class="mt-2 p-2 bg-slate-200/30 dark:bg-slate-800/30 rounded-lg border border-slate-300 dark:border-slate-700">
                                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-2 font-semibold">ğŸ“‹ æ¨¡æ¿åˆ—è¡¨ ({{messageTemplates().length}})ï¼š</p>
                                            <div class="space-y-1 max-h-32 overflow-y-auto">
                                                @for(template of messageTemplates(); track template.id) {
                                                    <div class="flex items-center justify-between p-1.5 bg-slate-100 dark:bg-slate-700/50 rounded text-sm border border-slate-200 dark:border-slate-600">
                                                        <div class="flex-1 min-w-0">
                                                            <div class="flex items-center gap-2">
                                                                <p class="font-medium text-slate-700 dark:text-slate-300 truncate">{{template.name}}</p>
                                                                @if(!template.isActive) {
                                                                    <span class="text-xs bg-slate-500/20 text-slate-400 px-1.5 py-0.5 rounded">å·²åœç”¨</span>
                                                                }
                                                            </div>
                                                            <p class="text-xs text-slate-500 dark:text-slate-400 truncate mt-0.5" [title]="template.prompt">{{template.prompt.substring(0, 50)}}{{template.prompt.length > 50 ? '...' : ''}}</p>
                                                        </div>
                                                        <button 
                                                            type="button" 
                                                            (click)="removeTemplate(template.id)" 
                                                            class="ml-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 px-2 py-1 rounded transition-colors flex-shrink-0"
                                                            title="åˆªé™¤æ¨¡æ¿">
                                                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                    @if(messageTemplates().length === 0 && !showTemplateCreator()) {
                                        <p class="text-xs text-amber-400 mt-1">âš ï¸ è¯·å…ˆåˆ›å»ºæ¶ˆæ¯æ¨¡æ¿</p>
                                    }
                                    @if(showTemplateCreator() || messageTemplates().length === 0) {
                                        <div class="mt-2 p-3 bg-slate-700/50 rounded-lg space-y-2">
                                            <input #quickTemplateName [value]="newTemplate().name" (input)="updateTemplateName(quickTemplateName.value)" class="form-input w-full bg-slate-800/50 border-slate-600 rounded-lg p-2 text-sm" placeholder="æ¨¡æ¿åç§° (å¦‚: æ‰“æ‹›å‘¼)">
                                            <div class="relative">
                                                <textarea #quickTemplatePrompt [value]="newTemplate().prompt" (input)="updateTemplatePrompt(quickTemplatePrompt.value)" rows="3" class="form-textarea w-full bg-slate-800/50 border-slate-600 rounded-lg p-2 text-sm" placeholder="æ¶ˆæ¯å†…å®¹..."></textarea>
                                            </div>
                                            <div class="space-y-2">
                                                <p class="text-xs text-slate-400">ğŸ“ ç‚¹å‡»æ’å…¥å˜é‡:</p>
                                                <div class="flex flex-wrap gap-1">
                                                    <!-- ç”¨æˆ·ä¿¡æ¯ -->
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{username}')" class="px-2 py-1 bg-cyan-600/30 hover:bg-cyan-600/50 text-cyan-300 rounded text-xs" title="æ’å…¥: {username}">ğŸ‘¤ ç”¨æˆ·å</button>
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{firstName}')" class="px-2 py-1 bg-cyan-600/30 hover:bg-cyan-600/50 text-cyan-300 rounded text-xs" title="æ’å…¥: {firstName}">ğŸ“› åå­—</button>
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{name}')" class="px-2 py-1 bg-cyan-600/30 hover:bg-cyan-600/50 text-cyan-300 rounded text-xs" title="æ’å…¥: {name}">ğŸ·ï¸ æ˜µç§°</button>
                                                    <!-- è§¦å‘ä¿¡æ¯ -->
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{keyword}')" class="px-2 py-1 bg-amber-600/30 hover:bg-amber-600/50 text-amber-300 rounded text-xs" title="æ’å…¥: {keyword}">ğŸ”‘ è§¦å‘å…³é”®è¯</button>
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{message}')" class="px-2 py-1 bg-amber-600/30 hover:bg-amber-600/50 text-amber-300 rounded text-xs" title="æ’å…¥: {message}">ğŸ’¬ ç”¨æˆ·æ¶ˆæ¯</button>
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{groupName}')" class="px-2 py-1 bg-green-600/30 hover:bg-green-600/50 text-green-300 rounded text-xs" title="æ’å…¥: {groupName}">ğŸ‘¥ ç¾¤ç»„åç§°</button>
                                                    <!-- æ—¶é—´å’Œéšæœº -->
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{time}')" class="px-2 py-1 bg-purple-600/30 hover:bg-purple-600/50 text-purple-300 rounded text-xs" title="æ’å…¥: {time}">ğŸ• å½“å‰æ—¶é—´</button>
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{date}')" class="px-2 py-1 bg-purple-600/30 hover:bg-purple-600/50 text-purple-300 rounded text-xs" title="æ’å…¥: {date}">ğŸ“… å½“å‰æ—¥æœŸ</button>
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{random}')" class="px-2 py-1 bg-pink-600/30 hover:bg-pink-600/50 text-pink-300 rounded text-xs" title="æ’å…¥: {random}">ğŸ² éšæœºè¡¨æƒ…</button>
                                                </div>
                                                <p class="text-xs text-slate-500 mt-1">ğŸ’¡ å˜é‡ä¼šè‡ªåŠ¨æ›¿æ¢ä¸ºå®é™…å€¼ | é¼ æ ‡æ‚¬åœæŸ¥çœ‹å˜é‡ä»£ç </p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button type="button" (click)="addTemplateQuick(quickTemplateName.value, quickTemplatePrompt.value); showTemplateCreator.set(false)" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-1.5 px-3 rounded-lg text-sm">âœ“ æ·»åŠ æ¨¡æ¿</button>
                                                @if(messageTemplates().length > 0) {
                                                    <button type="button" (click)="showTemplateCreator.set(false)" class="px-3 bg-slate-600 hover:bg-slate-700 text-white font-bold py-1.5 rounded-lg text-sm">å–æ¶ˆ</button>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div>
                                     <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{t('sendingDelays')}}</label>
                                     <div class="flex items-center gap-4">
                                         <div class="flex-1"><label class="block text-xs font-medium">{{t('min')}}</label><input type="number" [(ngModel)]="newCampaign().action.minDelaySeconds" name="minDelay" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2"></div>
                                         <div class="flex-1"><label class="block text-xs font-medium">{{t('max')}}</label><input type="number" [(ngModel)]="newCampaign().action.maxDelaySeconds" name="maxDelay" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2"></div>
                                     </div>
                                </div>
                             </div>
                        </div>
                        <button type="submit" [disabled]="isSubmittingCampaign()" [class.opacity-50]="isSubmittingCampaign()" [class.cursor-not-allowed]="isSubmittingCampaign()" class="w-full bg-cyan-500 hover:bg-cyan-600 disabled:bg-cyan-400 text-white font-bold py-2.5 px-4 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20">{{isSubmittingCampaign() ? 'å‰µå»ºä¸­...' : t('createCampaign')}}</button>
                    </form>
                </div>
                 <div id="campaign-list-section" class="bg-slate-100/50 dark:bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl shadow-lg transition-all duration-300">
                    <h3 class="text-xl mb-4 font-semibold">{{t('campaigns')}}</h3>
                    <div class="space-y-4 max-h-96 overflow-y-auto">
                        @for(campaign of campaigns(); track campaign.id) {
                            <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-xl">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold">{{ campaign.name }}</span>
                                    <div class="flex items-center gap-3">
                                        <label class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" [checked]="campaign.isActive" (change)="toggleCampaignStatus(campaign.id)" class="sr-only"><div class="block bg-slate-600 w-10 h-6 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition" [class.translate-x-full]="campaign.isActive" [class.bg-cyan-400]="campaign.isActive"></div></div></label>
                                        <button (click)="removeById(campaigns, campaign.id, 'campaign')" class="text-red-400 hover:text-red-300 font-medium transition-colors" [title]="t('remove')"><svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                                    </div>
                                </div>
                                <div class="mt-3 text-xs space-y-2"><p><strong class="text-slate-500 dark:text-slate-400">{{t('triggers')}}:</strong> {{ campaign.trigger.sourceGroupIds.length }} {{t('groups')}}, {{ campaign.trigger.keywordSetIds.length }} {{t('keywordSets')}}</p><p><strong class="text-slate-500 dark:text-slate-400">{{t('actions')}}:</strong> {{t('sendMessage')}} ({{ campaign.actions[0].minDelaySeconds }}s-{{ campaign.actions[0].maxDelaySeconds }}s)</p></div>
                            </div>
                        } @empty {
                            <p class="text-slate-500 text-center py-8">{{t('noCampaignsFound')}}</p>
                        }
                    </div>
                </div>
            </div>

            <!-- Column 3: Global Config & Status -->
            <div class="space-y-8">
                <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl mb-4 font-semibold">{{ t('globalSendingConfig') }}</h3>
                    <div class="space-y-4">
                        <div><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" [ngModel]="spintaxEnabled()" (ngModelChange)="spintaxEnabled.set($event)" class="form-checkbox bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded text-cyan-500 h-5 w-5"><span class="text-slate-700 dark:text-slate-300">{{ t('enableSpintax') }}</span></label><p class="text-xs text-slate-500 mt-1 pl-8">{{ t('spintaxHint') }}</p></div>
                        <div class="pt-4 border-t border-slate-200 dark:border-slate-700"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" [ngModel]="smartSendingEnabled()" (ngModelChange)="smartSendingEnabled.set($event)" class="form-checkbox bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded text-cyan-500 h-5 w-5"><span class="text-slate-700 dark:text-slate-300">{{ t('enableSmartSending') }}</span></label><p class="text-xs text-slate-500 dark:text-slate-400 mt-1 pl-8">{{ t('smartSendingHint') }}</p></div>
                        <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" [ngModel]="autoReplyEnabled()" (ngModelChange)="autoReplyEnabled.set($event); saveSettings()" class="form-checkbox bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded text-cyan-500 h-5 w-5">
                                <span class="text-slate-700 dark:text-slate-300">{{ t('enableAutoReply') }}</span>
                            </label>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 pl-8">{{ t('autoReplyHint') }}</p>
                            <div class="mt-2 space-y-2">
                                <textarea 
                                    [ngModel]="autoReplyMessage()" 
                                    (ngModelChange)="autoReplyMessage.set($event)"
                                    rows="3" 
                                    class="form-textarea w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-3 text-sm resize-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 transition-all" 
                                    [placeholder]="t('autoReplyMessage')">
                                </textarea>
                                <div class="flex items-center justify-between">
                                    <p class="text-xs text-slate-500">{{ t('autoReplyEditHint') }}</p>
                                    <button 
                                        (click)="saveSettings(); showSettingsSavedToast()"
                                        class="bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-medium py-1.5 px-4 rounded-lg transition-all duration-200 shadow-md shadow-cyan-500/20 hover:shadow-lg hover:shadow-cyan-500/30 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        {{ t('saveAutoReply') }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl mb-4 font-semibold">{{ t('accountStatus') }}</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-2">{{ t('activeListenerAccounts') }} ({{listenerAccounts().length}})</h4>
                            <div class="space-y-2 max-h-32 overflow-y-auto">@for(acc of listenerAccounts(); track acc.id) { <div class="flex items-center justify-between p-2 bg-slate-200/50 dark:bg-slate-800/50 rounded-lg text-sm"><span class="font-mono">{{acc.phone}}</span><span class="px-2 py-0.5 text-xs font-semibold rounded-full" [class]="getStatusColor(acc.status)">{{ acc.status }}</span></div> } @empty {<p class="text-slate-500 text-sm">{{t('noActiveListeners')}}</p>}</div>
                        </div>
                         <div>
                            <h4 class="font-semibold mb-2">{{ t('activeSenderAccounts') }} ({{senderAccounts().length}})</h4>
                            <div class="space-y-2 max-h-32 overflow-y-auto">@for(acc of senderAccounts(); track acc.id) { <div class="flex items-center justify-between p-2 bg-slate-200/50 dark:bg-slate-800/50 rounded-lg text-sm"><span class="font-mono">{{acc.phone}}</span><span class="px-2 py-0.5 text-xs font-semibold rounded-full" [class]="getStatusColor(acc.status)">{{ acc.status }}</span></div> } @empty {<p class="text-slate-500 text-sm">{{t('noActiveSenders')}}</p>}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      }
      @case ('leads') {
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-4xl font-bold text-slate-900 dark:text-white">{{ t('leadPipeline') }}</h2>
            <div class="flex items-center gap-4">
                <button (click)="loadFunnelStats()" class="flex items-center gap-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                    åˆ·æ–°çµ±è¨ˆ
                </button>
                <div class="flex rounded-md shadow-sm bg-slate-200/50 dark:bg-slate-800/50 p-1">
                    <button (click)="leadsViewMode.set('kanban')" [class.bg-white]="leadsViewMode() === 'kanban'" [class.dark:bg-slate-700]="leadsViewMode() === 'kanban'" class="px-3 py-1.5 text-sm rounded transition-colors flex items-center gap-2"><svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg> {{t('kanbanView')}}</button>
                    <button (click)="leadsViewMode.set('list')" [class.bg-white]="leadsViewMode() === 'list'" [class.dark:bg-slate-700]="leadsViewMode() === 'list'" class="px-3 py-1.5 text-sm rounded transition-colors flex items-center gap-2"><svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg> {{t('listView')}}</button>
                </div>
                <button (click)="exportLeads()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    {{t('exportToExcel')}}
                </button>
                <!-- æ‰¹é‡æ“ä½œæŒ‰éˆ• -->
                <button (click)="showBatchOperationMenu.set(!showBatchOperationMenu()); loadAllTags()" 
                        class="flex items-center gap-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 text-sm font-bold py-2 px-4 rounded-lg transition duration-200"
                        [class.ring-2]="hasSelectedLeads()"
                        [class.ring-purple-500]="hasSelectedLeads()">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    æ‰¹é‡æ“ä½œ
                    @if(hasSelectedLeads()) {
                        <span class="bg-purple-500 text-white text-xs px-1.5 py-0.5 rounded-full">{{ selectedLeadsCount() }}</span>
                    }
                </button>
                <!-- æ“ä½œæ­·å²æŒ‰éˆ• -->
                <button (click)="loadBatchOperationHistory()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>
                    æ­·å²
                </button>
            </div>
        </div>
        
        <!-- æ‰¹é‡æ“ä½œå·¥å…·æ¬„ -->
        @if(hasSelectedLeads() || showBatchOperationMenu()) {
        <div class="mb-4 bg-purple-500/10 border border-purple-500/20 rounded-xl p-4">
            <div class="flex flex-wrap items-center gap-3">
                <!-- é¸æ“‡ä¿¡æ¯ -->
                <div class="flex items-center gap-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" [checked]="isSelectAllLeads()" (change)="toggleSelectAllLeads()" 
                               class="w-4 h-4 rounded border-purple-400 text-purple-500 focus:ring-purple-500">
                        <span class="text-sm text-purple-400">å…¨é¸</span>
                    </label>
                    <span class="text-sm text-slate-400">å·²é¸æ“‡ <span class="font-bold text-purple-400">{{ selectedLeadsCount() }}</span> å€‹ Lead</span>
                    @if(hasSelectedLeads()) {
                        <button (click)="clearLeadSelection()" class="text-xs text-slate-400 hover:text-slate-300 underline">æ¸…é™¤é¸æ“‡</button>
                    }
                </div>
                
                <div class="h-6 w-px bg-slate-600"></div>
                
                <!-- æ‰¹é‡æ“ä½œæŒ‰éˆ• -->
                @if(hasSelectedLeads()) {
                    <!-- æ›´æ–°ç‹€æ…‹ä¸‹æ‹‰é¸å–® -->
                    <div class="relative">
                        <select (change)="batchUpdateLeadStatus($any($event.target).value); $any($event.target).value = ''" 
                                class="bg-cyan-500/20 border border-cyan-500/30 text-cyan-400 text-sm rounded-lg px-3 py-1.5 appearance-none cursor-pointer hover:bg-cyan-500/30">
                            <option value="" disabled selected>æ›´æ–°ç‹€æ…‹</option>
                            <option value="New">New</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Replied">Replied</option>
                            <option value="Follow-up">Follow-up</option>
                            <option value="Closed-Won">Closed-Won</option>
                            <option value="Closed-Lost">Closed-Lost</option>
                        </select>
                    </div>
                    
                    <!-- æ·»åŠ æ¨™ç±¤ -->
                    <div class="relative">
                        <button (click)="showBatchTagSelector.set(!showBatchTagSelector())" 
                                class="flex items-center gap-1 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 text-sm px-3 py-1.5 rounded-lg">
                            <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                            æ·»åŠ æ¨™ç±¤
                        </button>
                        @if(showBatchTagSelector()) {
                            <div class="absolute top-full mt-1 left-0 z-50 bg-slate-800 border border-slate-600 rounded-lg shadow-xl p-3 min-w-[200px]">
                                <input [(ngModel)]="batchTagInput" 
                                       (keyup.enter)="batchAddTag(batchTagInput()); batchTagInput.set('')"
                                       placeholder="è¼¸å…¥æ–°æ¨™ç±¤..." 
                                       class="w-full bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm mb-2">
                                <button (click)="batchAddTag(batchTagInput()); batchTagInput.set('')" 
                                        class="w-full bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 rounded mb-2">æ·»åŠ </button>
                                @if(allTags().length > 0) {
                                    <div class="border-t border-slate-600 pt-2 max-h-32 overflow-y-auto">
                                        <p class="text-xs text-slate-400 mb-1">ç¾æœ‰æ¨™ç±¤:</p>
                                        @for(tag of allTags(); track tag.id) {
                                            <button (click)="batchAddTag(tag.name)" 
                                                    class="block w-full text-left text-sm px-2 py-1 rounded hover:bg-slate-700" 
                                                    [style.color]="tag.color">
                                                {{ tag.name }} ({{ tag.usageCount }})
                                            </button>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    
                    <!-- æ·»åŠ åˆ° DNC -->
                    <button (click)="batchAddToDnc()" 
                            class="flex items-center gap-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 text-sm px-3 py-1.5 rounded-lg">
                        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                        åŠ å…¥ DNC
                    </button>
                    
                    <!-- åˆªé™¤ -->
                    <button (click)="batchDeleteLeads()" 
                            class="flex items-center gap-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 text-sm px-3 py-1.5 rounded-lg">
                        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        åˆªé™¤
                    </button>
                }
                
                <!-- åŠ è¼‰ä¸­æŒ‡ç¤ºå™¨ -->
                @if(batchOperationInProgress()) {
                    <div class="flex items-center gap-2 text-purple-400">
                        <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg>
                        <span class="text-sm">è™•ç†ä¸­...</span>
                    </div>
                }
            </div>
        </div>
        }
        
        <!-- æ¼æ–—çµ±è¨ˆå„€è¡¨æ¿ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- ä»Šæ—¥æ–°å¢ -->
            <div class="bg-blue-500/10 border border-blue-500/20 p-4 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-blue-500/20">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400">ä»Šæ—¥æ–°å¢</p>
                        <p class="text-2xl font-bold text-blue-400">{{ funnelStats().today_new }}</p>
                    </div>
                </div>
            </div>
            <!-- æœ¬é€±æˆäº¤ -->
            <div class="bg-emerald-500/10 border border-emerald-500/20 p-4 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-emerald-500/20">
                        <svg class="h-5 w-5 text-emerald-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400">æœ¬é€±æˆäº¤</p>
                        <p class="text-2xl font-bold text-emerald-400">{{ funnelStats().week_converted }}</p>
                    </div>
                </div>
            </div>
            <!-- æœ‰èˆˆè¶£ -->
            <div class="bg-yellow-500/10 border border-yellow-500/20 p-4 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-yellow-500/20">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400">æœ‰èˆˆè¶£</p>
                        <p class="text-2xl font-bold text-yellow-400">{{ funnelStats().stages['interested']?.count || 0 }}</p>
                    </div>
                </div>
            </div>
            <!-- æ´½è«‡ä¸­ -->
            <div class="bg-orange-500/10 border border-orange-500/20 p-4 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-orange-500/20">
                        <svg class="h-5 w-5 text-orange-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400">æ´½è«‡ä¸­</p>
                        <p class="text-2xl font-bold text-orange-400">{{ funnelStats().stages['negotiating']?.count || 0 }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ¼æ–—éšæ®µåˆ†ä½ˆ -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-4 rounded-xl mb-6">
            <h3 class="text-lg font-semibold mb-3">æ¼æ–—éšæ®µåˆ†ä½ˆ</h3>
            <div class="flex gap-2 flex-wrap">
                @for(stage of funnelStages; track stage.key) {
                    <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-200/50 dark:bg-slate-800/50">
                        <div class="w-3 h-3 rounded-full {{ stage.color }}"></div>
                        <span class="text-sm">{{ stage.name }}</span>
                        <span class="text-sm font-bold">{{ funnelStats().stages[stage.key]?.count || 0 }}</span>
                    </div>
                }
            </div>
            
            <!-- ç†±é–€æ¨™ç±¤ -->
            @if(funnelStats().tags.length > 0) {
                <div class="mt-4 pt-4 border-t border-slate-500/20">
                    <h4 class="text-sm font-semibold mb-2 text-slate-500">ç†±é–€æ¨™ç±¤</h4>
                    <div class="flex gap-2 flex-wrap">
                        @for(tag of funnelStats().tags.slice(0, 10); track tag[0]) {
                            <span class="px-2 py-1 text-xs bg-cyan-500/20 text-cyan-400 rounded-full">
                                {{ tag[0] }} ({{ tag[1] }})
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
        @if(leadsViewMode() === 'kanban') {
            <div class="flex gap-4 overflow-x-auto pb-4 -mx-8 px-8">
                @for(status of leadStatuses; track status) {
                    @let leads = leadsByStatus().get(status) ?? [];
                    <div class="w-80 bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 rounded-xl shadow-lg flex-shrink-0">
                        <h3 class="text-lg font-semibold p-4 border-b border-slate-500/20 flex justify-between"><span>{{ t(status) }}</span><span class="text-sm font-normal bg-slate-200/80 dark:bg-slate-800/80 text-slate-600 dark:text-slate-300 rounded-full px-2.5 py-0.5">{{ leads.length }}</span></h3>
                        <div class="p-2 space-y-2 h-[calc(100vh-300px)] overflow-y-auto">
                            @for(lead of leads; track lead.id) {
                                <div class="bg-slate-50 dark:bg-slate-800/70 p-3 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700/50 transition-shadow hover:shadow-md"
                                     (click)="closeLeadMenu()">
                                    <div (click)="openLeadDetailModal(lead)" class="cursor-pointer">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <p class="font-bold text-cyan-500 dark:text-cyan-400">@{{ lead.username }}</p>
                                                <p class="text-sm text-slate-600 dark:text-slate-300">{{lead.firstName}} {{lead.lastName}}</p>
                                                <p class="text-xs text-slate-400">ID: {{lead.userId}}</p>
                                            </div>
                                            <span class="h-2.5 w-2.5 rounded-full mt-1.5" [class]="getOnlineStatusColor(lead.onlineStatus)" [title]="t(lead.onlineStatus)"></span>
                                        </div>
                                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">{{ lead.sourceGroup }}</p>
                                        <p class="text-xs font-mono bg-slate-200/80 dark:bg-slate-700/50 rounded px-1.5 py-0.5 inline-block my-1.5">{{ lead.triggeredKeyword }}</p>
                                        @if (getCampaignById(lead.campaignId); as campaign) {
                                        <div class="relative group">
                                            <p class="text-xs text-slate-400">{{ t('campaign') }}: <span class="font-semibold text-slate-500 dark:text-slate-300">{{ getCampaignName(lead.campaignId) }}</span></p>
                                            <div class="absolute hidden group-hover:block bottom-full mb-2 w-72 bg-slate-900 text-white text-xs rounded-lg p-3 shadow-lg z-10">
                                                <h4 class="font-bold border-b border-slate-600 pb-1 mb-1">{{ t('campaignDetails') }}</h4>
                                                <p><strong>{{t('triggers')}}:</strong> {{ campaign.trigger.sourceGroupIds.map(getGroupName).join(', ') }}; {{ campaign.trigger.keywordSetIds.map(getKeywordSetName).join(', ') }}</p>
                                                <p><strong>{{t('actions')}}:</strong> {{ getTemplateName(campaign.actions[0].templateId) }} ({{ campaign.actions[0].minDelaySeconds }}s-{{ campaign.actions[0].maxDelaySeconds }}s)</p>
                                            </div>
                                        </div>
                                        }
                                    </div>
                                    <div class="relative mt-2 pt-2 border-t border-slate-200 dark:border-slate-700/50">
                                        <button 
                                            (click)="$event.stopPropagation(); toggleLeadMenu(lead.id)" 
                                            class="w-full text-xs text-center text-slate-500 dark:text-slate-400 hover:text-cyan-400 transition-colors py-1">
                                            {{ t('moveTo') }} &#9662;
                                        </button>
                                        @if(openLeadMenuId() === lead.id) {
                                            <div class="absolute z-50 left-0 right-0 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden"
                                                 (click)="$event.stopPropagation()">
                                                @for(s of leadStatuses; track s) {
                                                    @if(s !== lead.status) {
                                                        <a (click)="updateLeadStatus(lead.id, s); closeLeadMenu()" 
                                                           class="block px-3 py-2.5 text-sm hover:bg-cyan-500/20 dark:hover:bg-cyan-500/20 hover:text-cyan-400 cursor-pointer transition-colors">
                                                            {{ t(s) }}
                                                        </a>
                                                    }
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        } @else {
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 rounded-xl shadow-lg overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-200/50 dark:bg-slate-800/50 text-slate-600 dark:text-slate-300 uppercase text-sm">
                        <tr>
                            <th class="py-3 px-4 w-10">
                                <input type="checkbox" [checked]="isSelectAllLeads()" (change)="toggleSelectAllLeads()" 
                                       class="w-4 h-4 rounded border-purple-400 text-purple-500 focus:ring-purple-500 cursor-pointer">
                            </th>
                            <th class="py-3 px-6">{{t('leadName')}}</th>
                            <th class="py-3 px-6">{{t('campaign')}}</th>
                            <th class="py-3 px-6">{{t('status')}}</th>
                            <th class="py-3 px-6">{{t('onlineStatus')}}</th>
                            <th class="py-3 px-6">{{t('sourceGroup')}}</th>
                            <th class="py-3 px-6">{{t('capturedAt')}}</th>
                            <th class="py-3 px-6 text-right">{{t('actions')}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for(lead of leads(); track trackByChatId($index, lead)) {
                             <tr class="border-b border-slate-200 dark:border-slate-800 hover:bg-slate-200/50 dark:hover:bg-slate-800/50 transition-colors"
                                 [class.bg-purple-500/10]="isLeadSelected(lead.id)"
                                 [class.dark:bg-purple-500/10]="isLeadSelected(lead.id)">
                                <td class="py-4 px-4">
                                    <input type="checkbox" [checked]="isLeadSelected(lead.id)" (change)="toggleLeadSelection(lead.id)" 
                                           class="w-4 h-4 rounded border-purple-400 text-purple-500 focus:ring-purple-500 cursor-pointer">
                                </td>
                                <td class="py-4 px-6">
                                    <div class="font-semibold cursor-pointer hover:text-cyan-400" (click)="openLeadDetailModal(lead)">@{{lead.username}}</div>
                                    <div class="text-xs text-slate-500 dark:text-slate-400">ID: {{lead.userId}}</div>
                                </td>
                                <td class="py-4 px-6 text-sm">
                                     @if (getCampaignById(lead.campaignId); as campaign) {
                                        <div class="relative group">
                                            <span class="px-2.5 py-1 rounded-full bg-slate-500/10 text-slate-300 cursor-pointer">{{getCampaignName(lead.campaignId)}}</span>
                                            <div class="absolute hidden group-hover:block bottom-full mb-2 w-72 bg-slate-900 text-white text-xs rounded-lg p-3 shadow-lg z-10">
                                                <h4 class="font-bold border-b border-slate-600 pb-1 mb-1">{{ t('campaignDetails') }}</h4>
                                                <p><strong>{{t('triggers')}}:</strong> {{ campaign.trigger.sourceGroupIds.map(getGroupName).join(', ') }}; {{ campaign.trigger.keywordSetIds.map(getKeywordSetName).join(', ') }}</p>
                                                <p><strong>{{t('actions')}}:</strong> {{ getTemplateName(campaign.actions[0].templateId) }} ({{ campaign.actions[0].minDelaySeconds }}s-{{ campaign.actions[0].maxDelaySeconds }}s)</p>
                                            </div>
                                        </div>
                                     } @else {
                                        <span class="px-2.5 py-1 rounded-full bg-slate-500/10 text-slate-300">{{getCampaignName(lead.campaignId)}}</span>
                                     }
                                </td>
                                <td class="py-4 px-6"><span class="px-2.5 py-1 text-xs font-semibold rounded-full" [class]="getStatusColor(lead.status)">{{ t(lead.status) }}</span></td>
                                <td class="py-4 px-6"><span class="inline-flex items-center gap-2 px-2.5 py-1 text-xs font-semibold rounded-full bg-slate-500/10 text-slate-400"><span class="h-2 w-2 rounded-full" [class]="getOnlineStatusColor(lead.onlineStatus)"></span> {{ t(lead.onlineStatus) }}</span></td>
                                <td class="py-4 px-6">{{lead.sourceGroup}}</td>
                                <td class="py-4 px-6 text-sm text-slate-500 dark:text-slate-400">{{lead.timestamp.toLocaleString()}}</td>
                                <td class="py-4 px-6 text-right"><button (click)="openLeadDetailModal(lead)" class="text-cyan-400 hover:text-cyan-300 font-medium transition-colors" [title]="t('sendMessageTab')"><svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></button></td>
                            </tr>
                        } @empty {
                            <tr><td colspan="8" class="text-center p-8 text-slate-500">{{t('noRecentActivity')}}</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        }
      }
      @case ('ads') {
        <!-- å»£å‘Šç™¼é€ç³»çµ±é é¢ -->
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ“¢</span> å»£å‘Šç™¼é€ç³»çµ±
        </h2>
        
        <!-- Tab å°èˆª -->
        <div class="flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-lg w-fit">
          <button (click)="adSystemTab.set('templates')" 
                  [class]="adSystemTab() === 'templates' ? 'bg-orange-500/30 text-orange-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“</span> æ¨¡æ¿ç®¡ç†
          </button>
          <button (click)="adSystemTab.set('schedules')" 
                  [class]="adSystemTab() === 'schedules' ? 'bg-orange-500/30 text-orange-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“…</span> ç™¼é€è¨ˆåŠƒ
          </button>
          <button (click)="adSystemTab.set('logs'); loadAdSendLogs()" 
                  [class]="adSystemTab() === 'logs' ? 'bg-orange-500/30 text-orange-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“Š</span> ç™¼é€è¨˜éŒ„
          </button>
          <button (click)="adSystemTab.set('analytics'); loadAdOverviewStats()" 
                  [class]="adSystemTab() === 'analytics' ? 'bg-orange-500/30 text-orange-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“ˆ</span> æ•ˆæœåˆ†æ
          </button>
        </div>
        
        <!-- æ¨¡æ¿ç®¡ç† Tab -->
        @if (adSystemTab() === 'templates') {
          <div class="space-y-4">
            <!-- å·¥å…·æ¬„ -->
            <div class="flex justify-between items-center">
              <span class="text-slate-400">å…± {{ adTemplates().length }} å€‹æ¨¡æ¿</span>
              <button (click)="showAdTemplateForm.set(true)" 
                      class="px-4 py-2 bg-orange-500/20 text-orange-400 rounded-lg hover:bg-orange-500/30 transition-colors flex items-center gap-2">
                <span>+</span> æ–°å»ºæ¨¡æ¿
              </button>
            </div>
            
            <!-- å‰µå»ºæ¨¡æ¿è¡¨å–® -->
            @if (showAdTemplateForm()) {
              <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                <h3 class="text-lg font-semibold text-white mb-4">å‰µå»ºå»£å‘Šæ¨¡æ¿</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">æ¨¡æ¿åç¨±</label>
                    <input type="text" 
                           [value]="newAdTemplate().name"
                           (input)="updateAdTemplateName($any($event.target).value)"
                           class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500/50"
                           placeholder="ä¾‹å¦‚ï¼šç”¢å“æ¨å»£æ¨¡æ¿">
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">æ¨¡æ¿å…§å®¹ (æ”¯æŒ Spintax)</label>
                    <textarea [value]="newAdTemplate().content"
                              (input)="updateAdTemplateContent($any($event.target).value)"
                              rows="5"
                              class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500/50 font-mono"
                              [placeholder]="'{ä½ å¥½|å—¨|Hi}ï¼æˆ‘å€‘æä¾›{å„ªè³ª|å°ˆæ¥­}çš„æœå‹™...'"></textarea>
                    <p class="text-xs text-slate-500 mt-1">ä½¿ç”¨ {{ '{' }}é¸é …1|é¸é …2|é¸é …3{{ '}' }} èªæ³•å‰µå»ºè®Šé«”</p>
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">åª’é«”é¡å‹</label>
                    <select [value]="newAdTemplate().mediaType"
                            (change)="updateAdTemplateMediaType($any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                      <option value="text">ç´”æ–‡å­—</option>
                      <option value="photo">åœ–ç‰‡</option>
                      <option value="video">å½±ç‰‡</option>
                      <option value="document">æ–‡ä»¶</option>
                    </select>
                  </div>
                  <!-- Spintax é è¦½ -->
                  <div>
                    <button (click)="previewSpintax(newAdTemplate().content)" 
                            [disabled]="isPreviewingSpintax()"
                            class="px-4 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                      {{ isPreviewingSpintax() ? 'ç”Ÿæˆä¸­...' : 'é è¦½è®Šé«”' }}
                    </button>
                    @if (spintaxPreview().length > 0) {
                      <div class="mt-3 p-3 bg-slate-700/30 rounded-lg space-y-2">
                        <p class="text-xs text-slate-400 mb-2">è®Šé«”é è¦½ï¼š</p>
                        @for (variant of spintaxPreview(); track $index) {
                          <div class="p-2 bg-slate-800/50 rounded text-sm text-slate-300" [textContent]="variant"></div>
                        }
                      </div>
                    }
                  </div>
                  <div class="flex gap-3">
                    <button (click)="createAdTemplate()" 
                            class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                      å‰µå»ºæ¨¡æ¿
                    </button>
                    <button (click)="showAdTemplateForm.set(false); spintaxPreview.set([])" 
                            class="px-6 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                      å–æ¶ˆ
                    </button>
                  </div>
                </div>
              </div>
            }
            
            <!-- æ¨¡æ¿åˆ—è¡¨ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              @for (template of adTemplates(); track template.id) {
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <div class="flex justify-between items-start mb-3">
                    <div>
                      <h4 class="font-semibold text-white">{{ template.name }}</h4>
                      <span class="text-xs px-2 py-0.5 rounded-full" 
                            [class]="template.isActive ? 'bg-green-500/20 text-green-400' : 'bg-slate-500/20 text-slate-400'">
                        {{ template.isActive ? 'å•Ÿç”¨ä¸­' : 'å·²åœç”¨' }}
                      </span>
                    </div>
                    <div class="flex gap-2">
                      <button (click)="toggleAdTemplateStatus(template.id)" 
                              class="p-2 text-slate-400 hover:text-white transition-colors"
                              [title]="template.isActive ? 'åœç”¨' : 'å•Ÿç”¨'">
                        @if (template.isActive) {
                          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4" y1="21" x2="20" y2="3"/></svg>
                        } @else {
                          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>
                        }
                      </button>
                      <button (click)="deleteAdTemplate(template.id)" 
                              class="p-2 text-red-400 hover:text-red-300 transition-colors"
                              title="åˆªé™¤">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/></svg>
                      </button>
                    </div>
                  </div>
                  <p class="text-sm text-slate-400 mb-3 line-clamp-3 font-mono" [textContent]="template.content"></p>
                  <div class="flex gap-4 text-xs text-slate-500">
                    <span>ä½¿ç”¨: {{ template.useCount }}</span>
                    <span class="text-green-400">æˆåŠŸ: {{ template.successCount }}</span>
                    <span class="text-red-400">å¤±æ•—: {{ template.failCount }}</span>
                  </div>
                </div>
              } @empty {
                <div class="col-span-2 text-center py-12 text-slate-500">
                  <p class="text-4xl mb-2">ğŸ“</p>
                  <p>é‚„æ²’æœ‰å»£å‘Šæ¨¡æ¿</p>
                  <p class="text-sm">é»æ“Šã€Œæ–°å»ºæ¨¡æ¿ã€å‰µå»ºä½ çš„ç¬¬ä¸€å€‹å»£å‘Šæ¨¡æ¿</p>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- ç™¼é€è¨ˆåŠƒ Tab -->
        @if (adSystemTab() === 'schedules') {
          <div class="space-y-4">
            <!-- å·¥å…·æ¬„ -->
            <div class="flex justify-between items-center">
              <span class="text-slate-400">å…± {{ adSchedules().length }} å€‹è¨ˆåŠƒ</span>
              <button (click)="showAdScheduleForm.set(true)" 
                      class="px-4 py-2 bg-orange-500/20 text-orange-400 rounded-lg hover:bg-orange-500/30 transition-colors flex items-center gap-2">
                <span>+</span> æ–°å»ºè¨ˆåŠƒ
              </button>
            </div>
            
            <!-- å‰µå»ºè¨ˆåŠƒè¡¨å–® -->
            @if (showAdScheduleForm()) {
              <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                <h3 class="text-lg font-semibold text-white mb-4">å‰µå»ºç™¼é€è¨ˆåŠƒ</h3>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">è¨ˆåŠƒåç¨±</label>
                    <input type="text" 
                           [value]="newAdSchedule().name"
                           (input)="updateAdScheduleName($any($event.target).value)"
                           class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500/50"
                           placeholder="ä¾‹å¦‚ï¼šæ¯æ—¥æ¨å»£è¨ˆåŠƒ">
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">é¸æ“‡æ¨¡æ¿</label>
                    <select [value]="newAdSchedule().templateId"
                            (change)="updateAdScheduleTemplateId(+$any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                      <option value="0">-- é¸æ“‡æ¨¡æ¿ --</option>
                      @for (template of adTemplates(); track template.id) {
                        <option [value]="template.id">{{ template.name }}</option>
                      }
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">ç™¼é€æ¨¡å¼</label>
                    <select [value]="newAdSchedule().sendMode"
                            (change)="updateAdScheduleSendMode($any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                      <option value="scheduled">å®šæ™‚ç™¼é€</option>
                      <option value="interval">é–“éš”å¾ªç’°</option>
                      <option value="triggered">é—œéµè©è§¸ç™¼</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">è¨ˆåŠƒé¡å‹</label>
                    <select [value]="newAdSchedule().scheduleType"
                            (change)="updateAdScheduleType($any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                      <option value="once">ä¸€æ¬¡æ€§</option>
                      <option value="daily">æ¯æ—¥</option>
                      <option value="interval">é–“éš”é‡è¤‡</option>
                    </select>
                  </div>
                  @if (newAdSchedule().scheduleType === 'daily') {
                    <div>
                      <label class="block text-sm text-slate-400 mb-1">ç™¼é€æ™‚é–“</label>
                      <input type="time" 
                             [value]="newAdSchedule().scheduleTime"
                             (input)="updateAdScheduleTime($any($event.target).value)"
                             class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                    </div>
                  }
                  @if (newAdSchedule().scheduleType === 'interval') {
                    <div>
                      <label class="block text-sm text-slate-400 mb-1">é–“éš”åˆ†é˜</label>
                      <input type="number" 
                             [value]="newAdSchedule().intervalMinutes"
                             (input)="updateAdScheduleInterval(+$any($event.target).value)"
                             min="5"
                             class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                    </div>
                  }
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">å¸³è™Ÿç­–ç•¥</label>
                    <select [value]="newAdSchedule().accountStrategy"
                            (change)="updateAdScheduleStrategy($any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                      <option value="rotate">è¼ªæ›å¸³è™Ÿ</option>
                      <option value="single">å–®ä¸€å¸³è™Ÿ</option>
                      <option value="random">éš¨æ©Ÿé¸æ“‡</option>
                    </select>
                  </div>
                  <div class="col-span-2">
                    <label class="block text-sm text-slate-400 mb-1">ç™¼é€å¸³è™Ÿ</label>
                    <div class="flex flex-wrap gap-2 p-3 bg-slate-700/30 rounded-lg min-h-[60px]">
                      @for (account of accounts(); track account.id) {
                        @if (account.status === 'Online') {
                          <label class="flex items-center gap-2 px-3 py-1.5 bg-slate-600/50 rounded-lg cursor-pointer hover:bg-slate-600 transition-colors">
                            <input type="checkbox" 
                                   [checked]="newAdSchedule().assignedAccounts.includes(account.phone)"
                                   (change)="toggleAccountForSchedule(account.phone)"
                                   class="rounded border-slate-500">
                            <span class="text-sm text-slate-300">{{ account.phone }}</span>
                          </label>
                        }
                      } @empty {
                        <span class="text-slate-500 text-sm">æ²’æœ‰åœ¨ç·šå¸³è™Ÿ</span>
                      }
                    </div>
                  </div>
                  <div class="col-span-2">
                    <label class="block text-sm text-slate-400 mb-1">ç›®æ¨™ç¾¤çµ„ (è¼¸å…¥ç¾¤çµ„ ID æˆ– username)</label>
                    <textarea [value]="newAdSchedule().targetGroups.join('\n')"
                              (input)="updateScheduleTargetGroups($any($event.target).value)"
                              rows="3"
                              class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500/50 font-mono"
                              placeholder="æ¯è¡Œä¸€å€‹ç¾¤çµ„ ID æˆ– @username"></textarea>
                  </div>
                </div>
                <div class="flex gap-3 mt-4">
                  <button (click)="createAdSchedule()" 
                          class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                    å‰µå»ºè¨ˆåŠƒ
                  </button>
                  <button (click)="showAdScheduleForm.set(false)" 
                          class="px-6 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                    å–æ¶ˆ
                  </button>
                </div>
              </div>
            }
            
            <!-- è¨ˆåŠƒåˆ—è¡¨ -->
            <div class="space-y-3">
              @for (schedule of adSchedules(); track schedule.id) {
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <div class="flex items-center gap-3 mb-2">
                        <h4 class="font-semibold text-white">{{ schedule.name }}</h4>
                        <span class="text-xs px-2 py-0.5 rounded-full" 
                              [class]="schedule.isActive ? 'bg-green-500/20 text-green-400' : 'bg-slate-500/20 text-slate-400'">
                          {{ schedule.isActive ? 'å•Ÿç”¨ä¸­' : 'å·²åœç”¨' }}
                        </span>
                      </div>
                      <div class="grid grid-cols-4 gap-4 text-sm text-slate-400">
                        <div>
                          <span class="text-slate-500">æ¨¡å¼:</span> 
                          {{ getSendModeLabel(schedule.sendMode) }}
                        </div>
                        <div>
                          <span class="text-slate-500">é¡å‹:</span> 
                          {{ getScheduleTypeLabel(schedule.scheduleType) }}
                        </div>
                        <div>
                          <span class="text-slate-500">ç›®æ¨™:</span> 
                          {{ schedule.targetGroups.length }} å€‹ç¾¤çµ„
                        </div>
                        <div>
                          <span class="text-slate-500">å¸³è™Ÿ:</span> 
                          {{ getAccountStrategyLabel(schedule.accountStrategy) }}
                        </div>
                      </div>
                      <div class="flex gap-6 mt-2 text-xs">
                        <span class="text-slate-500">åŸ·è¡Œæ¬¡æ•¸: {{ schedule.runCount }}</span>
                        <span class="text-green-400">æˆåŠŸ: {{ schedule.successCount }}</span>
                        <span class="text-red-400">å¤±æ•—: {{ schedule.failCount }}</span>
                        @if (schedule.nextRunAt) {
                          <span class="text-cyan-400">ä¸‹æ¬¡åŸ·è¡Œ: {{ formatBatchOperationDate(schedule.nextRunAt) }}</span>
                        }
                      </div>
                    </div>
                    <div class="flex gap-2">
                      <button (click)="runAdScheduleNow(schedule.id)" 
                              class="px-3 py-1.5 bg-cyan-500/20 text-cyan-400 rounded-lg hover:bg-cyan-500/30 transition-colors text-sm"
                              title="ç«‹å³åŸ·è¡Œ">
                        â–¶ åŸ·è¡Œ
                      </button>
                      <button (click)="toggleAdScheduleStatus(schedule.id)" 
                              class="p-2 text-slate-400 hover:text-white transition-colors"
                              [title]="schedule.isActive ? 'åœç”¨' : 'å•Ÿç”¨'">
                        @if (schedule.isActive) {
                          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                        } @else {
                          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5,3 19,12 5,21 5,3"/></svg>
                        }
                      </button>
                      <button (click)="deleteAdSchedule(schedule.id)" 
                              class="p-2 text-red-400 hover:text-red-300 transition-colors"
                              title="åˆªé™¤">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/></svg>
                      </button>
                    </div>
                  </div>
                </div>
              } @empty {
                <div class="text-center py-12 text-slate-500">
                  <p class="text-4xl mb-2">ğŸ“…</p>
                  <p>é‚„æ²’æœ‰ç™¼é€è¨ˆåŠƒ</p>
                  <p class="text-sm">é»æ“Šã€Œæ–°å»ºè¨ˆåŠƒã€å‰µå»ºä½ çš„ç¬¬ä¸€å€‹ç™¼é€è¨ˆåŠƒ</p>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- ç™¼é€è¨˜éŒ„ Tab -->
        @if (adSystemTab() === 'logs') {
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-slate-400">æœ€è¿‘ {{ adSendLogs().length }} æ¢ç™¼é€è¨˜éŒ„</span>
              <button (click)="loadAdSendLogs()" 
                      class="px-4 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                åˆ·æ–°
              </button>
            </div>
            
            <div class="bg-slate-800/50 rounded-xl border border-slate-700/50 overflow-hidden">
              <table class="w-full">
                <thead class="bg-slate-700/30">
                  <tr>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">æ™‚é–“</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">ç¾¤çµ„</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">å¸³è™Ÿ</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">å…§å®¹</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">ç‹€æ…‹</th>
                  </tr>
                </thead>
                <tbody>
                  @for (log of adSendLogs(); track log.id) {
                    <tr class="border-t border-slate-700/30 hover:bg-slate-700/20">
                      <td class="py-3 px-4 text-sm text-slate-300">{{ formatBatchOperationDate(log.sentAt) }}</td>
                      <td class="py-3 px-4 text-sm text-slate-300">{{ log.targetGroupTitle || log.targetGroupId }}</td>
                      <td class="py-3 px-4 text-sm text-slate-400 font-mono">{{ log.accountPhone }}</td>
                      <td class="py-3 px-4 text-sm text-slate-400 max-w-xs truncate" [title]="log.variantContent">{{ log.variantContent }}</td>
                      <td class="py-3 px-4">
                        <span class="text-xs px-2 py-0.5 rounded-full" [class]="getAdStatusColor(log.status)">
                          {{ log.status === 'sent' ? 'å·²ç™¼é€' : log.status === 'failed' ? 'å¤±æ•—' : log.status === 'banned' ? 'è¢«å°ç¦' : 'å·²åˆªé™¤' }}
                        </span>
                      </td>
                    </tr>
                  } @empty {
                    <tr>
                      <td colspan="5" class="py-12 text-center text-slate-500">
                        <p class="text-4xl mb-2">ğŸ“Š</p>
                        <p>æš«ç„¡ç™¼é€è¨˜éŒ„</p>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }
        
        <!-- æ•ˆæœåˆ†æ Tab -->
        @if (adSystemTab() === 'analytics') {
          <div class="space-y-6">
            @if (adOverviewStats()) {
              @let stats = adOverviewStats();
              <!-- ç¸½è¦½å¡ç‰‡ -->
              <div class="grid grid-cols-4 gap-4">
                <div class="bg-gradient-to-br from-cyan-500/20 to-blue-500/20 rounded-xl p-5 border border-cyan-500/30">
                  <p class="text-3xl font-bold text-white">{{ stats.totalSends }}</p>
                  <p class="text-sm text-slate-400">ç¸½ç™¼é€æ¬¡æ•¸</p>
                </div>
                <div class="bg-gradient-to-br from-green-500/20 to-emerald-500/20 rounded-xl p-5 border border-green-500/30">
                  <p class="text-3xl font-bold text-green-400">{{ stats.successRate }}%</p>
                  <p class="text-sm text-slate-400">æˆåŠŸç‡</p>
                </div>
                <div class="bg-gradient-to-br from-orange-500/20 to-amber-500/20 rounded-xl p-5 border border-orange-500/30">
                  <p class="text-3xl font-bold text-orange-400">{{ stats.groupsReached }}</p>
                  <p class="text-sm text-slate-400">è§¸é”ç¾¤çµ„</p>
                </div>
                <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-xl p-5 border border-purple-500/30">
                  <p class="text-3xl font-bold text-purple-400">{{ stats.todaySends }}</p>
                  <p class="text-sm text-slate-400">ä»Šæ—¥ç™¼é€</p>
                </div>
              </div>
              
              <!-- è©³ç´°çµ±è¨ˆ -->
              <div class="grid grid-cols-2 gap-6">
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <h4 class="font-semibold text-white mb-4">ç™¼é€çµ±è¨ˆ</h4>
                  <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">æˆåŠŸç™¼é€</span>
                      <span class="text-green-400">{{ stats.successfulSends }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">ç™¼é€å¤±æ•—</span>
                      <span class="text-red-400">{{ stats.failedSends }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">è¢«å°ç¦</span>
                      <span class="text-red-500">{{ stats.bannedSends }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">å·²åˆªé™¤</span>
                      <span class="text-yellow-400">{{ stats.deletedSends }}</span>
                    </div>
                  </div>
                </div>
                
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <h4 class="font-semibold text-white mb-4">ç³»çµ±ç‹€æ…‹</h4>
                  <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">æ´»èºæ¨¡æ¿</span>
                      <span class="text-cyan-400">{{ stats.activeTemplates }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">æ´»èºè¨ˆåŠƒ</span>
                      <span class="text-cyan-400">{{ stats.activeSchedules }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">ä»Šæ—¥æˆåŠŸ</span>
                      <span class="text-green-400">{{ stats.todaySuccess }}</span>
                    </div>
                  </div>
                </div>
              </div>
            } @else {
              <div class="text-center py-12 text-slate-500">
                <p class="text-4xl mb-2">ğŸ“ˆ</p>
                <p>æ­£åœ¨åŠ è¼‰çµ±è¨ˆæ•¸æ“š...</p>
              </div>
            }
          </div>
        }
      }
      @case ('user-tracking') {
        <!-- ç”¨æˆ¶è¿½è¹¤ç³»çµ±é é¢ -->
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ‘¤</span> ç”¨æˆ¶è¿½è¹¤ç³»çµ±
        </h2>
        
        <!-- Tab å°èˆª -->
        <div class="flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-lg w-fit">
          <button (click)="userTrackingTab.set('users')" 
                  [class]="userTrackingTab() === 'users' ? 'bg-emerald-500/30 text-emerald-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ‘¥</span> è¿½è¹¤ç”¨æˆ¶
          </button>
          <button (click)="userTrackingTab.set('groups'); loadHighValueGroups()" 
                  [class]="userTrackingTab() === 'groups' ? 'bg-emerald-500/30 text-emerald-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ†</span> é«˜åƒ¹å€¼ç¾¤çµ„
          </button>
          <button (click)="userTrackingTab.set('analytics'); loadTrackingStats()" 
                  [class]="userTrackingTab() === 'analytics' ? 'bg-emerald-500/30 text-emerald-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“Š</span> çµ±è¨ˆåˆ†æ
          </button>
        </div>
        
        <!-- è¿½è¹¤ç”¨æˆ¶ Tab -->
        @if (userTrackingTab() === 'users') {
          <div class="space-y-4">
            <!-- å·¥å…·æ¬„ -->
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-3">
                <span class="text-slate-400">å…± {{ trackedUsers().length }} å€‹è¿½è¹¤ç”¨æˆ¶</span>
                <select [value]="userValueFilter()" 
                        (change)="userValueFilter.set($any($event.target).value); loadTrackedUsers()"
                        class="px-3 py-1.5 bg-slate-700/50 border border-slate-600/50 rounded-lg text-sm text-slate-300">
                  <option value="">å…¨éƒ¨ç­‰ç´š</option>
                  <option value="vip">VIP</option>
                  <option value="high">é«˜åƒ¹å€¼</option>
                  <option value="medium">ä¸­ç­‰</option>
                  <option value="low">ä½</option>
                </select>
              </div>
              <button (click)="showAddUserForm.set(true)" 
                      class="px-4 py-2 bg-emerald-500/20 text-emerald-400 rounded-lg hover:bg-emerald-500/30 transition-colors flex items-center gap-2">
                <span>+</span> æ·»åŠ ç”¨æˆ¶
              </button>
            </div>
            
            <!-- æ·»åŠ ç”¨æˆ¶è¡¨å–® -->
            @if (showAddUserForm()) {
              <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                <h3 class="text-lg font-semibold text-white mb-4">æ·»åŠ è¿½è¹¤ç”¨æˆ¶</h3>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">ç”¨æˆ¶ ID *</label>
                    <input type="text" 
                           [value]="newTrackedUser().userId"
                           (input)="updateTrackedUserId($any($event.target).value)"
                           class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500/50"
                           placeholder="ä¾‹å¦‚ï¼š123456789">
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">ç”¨æˆ¶å</label>
                    <input type="text" 
                           [value]="newTrackedUser().username"
                           (input)="updateTrackedUserName($any($event.target).value)"
                           class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none"
                           placeholder="@username">
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">å‚™è¨»</label>
                    <input type="text" 
                           [value]="newTrackedUser().notes"
                           (input)="updateTrackedUserNotes($any($event.target).value)"
                           class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none"
                           placeholder="å¯é¸">
                  </div>
                </div>
                <div class="flex gap-3 mt-4">
                  <button (click)="addUserToTrack()" 
                          class="px-6 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-colors">
                    æ·»åŠ ç”¨æˆ¶
                  </button>
                  <button (click)="showAddUserForm.set(false)" 
                          class="px-6 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                    å–æ¶ˆ
                  </button>
                </div>
              </div>
            }
            
            <!-- ç”¨æˆ¶åˆ—è¡¨ -->
            <div class="bg-slate-800/50 rounded-xl border border-slate-700/50 overflow-hidden">
              <table class="w-full">
                <thead class="bg-slate-700/30">
                  <tr>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">ç”¨æˆ¶</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">åƒ¹å€¼ç­‰ç´š</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">ç¾¤çµ„æ•¸</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">é«˜åƒ¹å€¼ç¾¤çµ„</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">ç‹€æ…‹</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">ä¾†æº</th>
                    <th class="text-right py-3 px-4 text-sm font-medium text-slate-400">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  @for (user of trackedUsers(); track user.id) {
                    <tr class="border-t border-slate-700/30 hover:bg-slate-700/20">
                      <td class="py-3 px-4">
                        <div class="font-medium text-white">{{ user.displayName }}</div>
                        <div class="text-xs text-slate-500">ID: {{ user.userId }}</div>
                      </td>
                      <td class="py-3 px-4">
                        <select [value]="user.valueLevel"
                                (change)="updateUserValueLevel(user.userId, $any($event.target).value)"
                                class="px-2 py-1 rounded-lg text-xs border" 
                                [class]="getValueLevelColor(user.valueLevel)">
                          <option value="vip">VIP</option>
                          <option value="high">é«˜åƒ¹å€¼</option>
                          <option value="medium">ä¸­ç­‰</option>
                          <option value="low">ä½</option>
                        </select>
                      </td>
                      <td class="py-3 px-4 text-sm text-slate-300">{{ user.groupsCount }}</td>
                      <td class="py-3 px-4 text-sm text-orange-400">{{ user.highValueGroups }}</td>
                      <td class="py-3 px-4">
                        <span class="text-xs px-2 py-0.5 rounded-full" [class]="getTrackingStatusColor(user.trackingStatus)">
                          {{ getTrackingStatusLabel(user.trackingStatus) }}
                        </span>
                      </td>
                      <td class="py-3 px-4 text-sm text-slate-400">{{ user.source }}</td>
                      <td class="py-3 px-4 text-right">
                        <div class="flex gap-2 justify-end">
                          <button (click)="trackUserGroups(user.userId)" 
                                  [disabled]="isTrackingUser()"
                                  class="px-3 py-1 bg-cyan-500/20 text-cyan-400 rounded text-xs hover:bg-cyan-500/30 disabled:opacity-50"
                                  title="è¿½è¹¤ç¾¤çµ„">
                            {{ isTrackingUser() ? '...' : 'ğŸ” è¿½è¹¤' }}
                          </button>
                          <button (click)="viewUserGroups(user)" 
                                  class="px-3 py-1 bg-slate-600/50 text-slate-300 rounded text-xs hover:bg-slate-600"
                                  title="æŸ¥çœ‹ç¾¤çµ„">
                            ğŸ“‹ ç¾¤çµ„
                          </button>
                          <button (click)="removeTrackedUser(user.userId)" 
                                  class="p-1 text-red-400 hover:text-red-300"
                                  title="ç§»é™¤">
                            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/></svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  } @empty {
                    <tr>
                      <td colspan="7" class="py-12 text-center text-slate-500">
                        <p class="text-4xl mb-2">ğŸ‘¤</p>
                        <p>é‚„æ²’æœ‰è¿½è¹¤ç”¨æˆ¶</p>
                        <p class="text-sm">é»æ“Šã€Œæ·»åŠ ç”¨æˆ¶ã€é–‹å§‹è¿½è¹¤é«˜åƒ¹å€¼ç”¨æˆ¶</p>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
            
            <!-- ç”¨æˆ¶ç¾¤çµ„è©³æƒ…å°è©±æ¡† -->
            @if (selectedTrackedUser()) {
              <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" (click)="selectedTrackedUser.set(null)">
                <div class="bg-slate-800 rounded-xl p-6 w-[700px] max-h-[80vh] overflow-auto" (click)="$event.stopPropagation()">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-white">
                      {{ selectedTrackedUser().displayName }} çš„ç¾¤çµ„
                    </h3>
                    <button (click)="selectedTrackedUser.set(null)" class="text-slate-400 hover:text-white">
                      <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                  </div>
                  <div class="space-y-2">
                    @for (group of userGroups(); track group.id) {
                      <div class="p-3 rounded-lg" [class]="group.isHighValue ? 'bg-orange-500/10 border border-orange-500/30' : 'bg-slate-700/30'">
                        <div class="flex justify-between items-center">
                          <div>
                            <span class="font-medium text-white">{{ group.groupTitle }}</span>
                            @if (group.groupUsername) {
                              <span class="text-slate-400 text-sm ml-2">@{{ group.groupUsername }}</span>
                            }
                          </div>
                          <div class="flex items-center gap-3">
                            <span class="text-sm text-slate-400">{{ group.memberCount }} æˆå“¡</span>
                            @if (group.isHighValue) {
                              <span class="text-xs px-2 py-0.5 bg-orange-500/20 text-orange-400 rounded-full">é«˜åƒ¹å€¼</span>
                            }
                          </div>
                        </div>
                      </div>
                    } @empty {
                      <p class="text-center text-slate-500 py-8">å°šæœªç™¼ç¾ç¾¤çµ„ï¼Œè«‹å…ˆåŸ·è¡Œè¿½è¹¤</p>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        }
        
        <!-- é«˜åƒ¹å€¼ç¾¤çµ„ Tab -->
        @if (userTrackingTab() === 'groups') {
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-slate-400">é€šéç”¨æˆ¶è¿½è¹¤ç™¼ç¾çš„é«˜åƒ¹å€¼ç¾¤çµ„</span>
              <button (click)="loadHighValueGroups()" 
                      class="px-4 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                åˆ·æ–°
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              @for (group of highValueGroups(); track group.groupId) {
                <div class="bg-gradient-to-br from-orange-500/10 to-amber-500/10 rounded-xl p-5 border border-orange-500/30">
                  <div class="flex justify-between items-start mb-3">
                    <div>
                      <h4 class="font-semibold text-white">{{ group.groupTitle }}</h4>
                      @if (group.groupUsername) {
                        <span class="text-sm text-slate-400">@{{ group.groupUsername }}</span>
                      }
                    </div>
                    <span class="text-xs px-2 py-1 bg-orange-500/20 text-orange-400 rounded-full">
                      é«˜åƒ¹å€¼
                    </span>
                  </div>
                  <div class="grid grid-cols-3 gap-4 text-sm">
                    <div>
                      <p class="text-2xl font-bold text-white">{{ group.memberCount }}</p>
                      <p class="text-slate-400">æˆå“¡æ•¸</p>
                    </div>
                    <div>
                      <p class="text-2xl font-bold text-cyan-400">{{ group.usersCount }}</p>
                      <p class="text-slate-400">è¿½è¹¤ç”¨æˆ¶</p>
                    </div>
                    <div>
                      <p class="text-2xl font-bold text-emerald-400">{{ (group.valueScore * 100).toFixed(0) }}%</p>
                      <p class="text-slate-400">åƒ¹å€¼åˆ†</p>
                    </div>
                  </div>
                </div>
              } @empty {
                <div class="col-span-2 text-center py-12 text-slate-500">
                  <p class="text-4xl mb-2">ğŸ†</p>
                  <p>é‚„æ²’æœ‰ç™¼ç¾é«˜åƒ¹å€¼ç¾¤çµ„</p>
                  <p class="text-sm">è¿½è¹¤æ›´å¤šç”¨æˆ¶ä»¥ç™¼ç¾é«˜åƒ¹å€¼ç¾¤çµ„</p>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- çµ±è¨ˆåˆ†æ Tab -->
        @if (userTrackingTab() === 'analytics') {
          <div class="space-y-6">
            @if (trackingStats()) {
              @let stats = trackingStats();
              <!-- ç¸½è¦½å¡ç‰‡ -->
              <div class="grid grid-cols-4 gap-4">
                <div class="bg-gradient-to-br from-cyan-500/20 to-blue-500/20 rounded-xl p-5 border border-cyan-500/30">
                  <p class="text-3xl font-bold text-white">{{ stats.totalUsers }}</p>
                  <p class="text-sm text-slate-400">è¿½è¹¤ç”¨æˆ¶</p>
                </div>
                <div class="bg-gradient-to-br from-emerald-500/20 to-green-500/20 rounded-xl p-5 border border-emerald-500/30">
                  <p class="text-3xl font-bold text-emerald-400">{{ stats.totalGroupsDiscovered }}</p>
                  <p class="text-sm text-slate-400">ç™¼ç¾ç¾¤çµ„</p>
                </div>
                <div class="bg-gradient-to-br from-orange-500/20 to-amber-500/20 rounded-xl p-5 border border-orange-500/30">
                  <p class="text-3xl font-bold text-orange-400">{{ stats.highValueGroups }}</p>
                  <p class="text-sm text-slate-400">é«˜åƒ¹å€¼ç¾¤çµ„</p>
                </div>
                <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-xl p-5 border border-purple-500/30">
                  <p class="text-3xl font-bold text-purple-400">{{ stats.todayTracked }}</p>
                  <p class="text-sm text-slate-400">ä»Šæ—¥è¿½è¹¤</p>
                </div>
              </div>
              
              <!-- è©³ç´°çµ±è¨ˆ -->
              <div class="grid grid-cols-2 gap-6">
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <h4 class="font-semibold text-white mb-4">ç”¨æˆ¶åƒ¹å€¼åˆ†ä½ˆ</h4>
                  <div class="space-y-3">
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">VIP</span>
                      <span class="px-3 py-1 bg-purple-500/20 text-purple-400 rounded-full text-sm">{{ stats.byValueLevel.vip }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">é«˜åƒ¹å€¼</span>
                      <span class="px-3 py-1 bg-orange-500/20 text-orange-400 rounded-full text-sm">{{ stats.byValueLevel.high }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">ä¸­ç­‰</span>
                      <span class="px-3 py-1 bg-cyan-500/20 text-cyan-400 rounded-full text-sm">{{ stats.byValueLevel.medium }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">ä½</span>
                      <span class="px-3 py-1 bg-slate-500/20 text-slate-400 rounded-full text-sm">{{ stats.byValueLevel.low }}</span>
                    </div>
                  </div>
                </div>
                
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <h4 class="font-semibold text-white mb-4">è¿½è¹¤ç‹€æ…‹åˆ†ä½ˆ</h4>
                  <div class="space-y-3">
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">å¾…è¿½è¹¤</span>
                      <span class="px-3 py-1 bg-yellow-500/20 text-yellow-400 rounded-full text-sm">{{ stats.byStatus.pending }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">è¿½è¹¤ä¸­</span>
                      <span class="px-3 py-1 bg-blue-500/20 text-blue-400 rounded-full text-sm">{{ stats.byStatus.tracking }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">å·²å®Œæˆ</span>
                      <span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm">{{ stats.byStatus.completed }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">å¤±æ•—</span>
                      <span class="px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-sm">{{ stats.byStatus.failed }}</span>
                    </div>
                  </div>
                </div>
              </div>
            } @else {
              <div class="text-center py-12 text-slate-500">
                <p class="text-4xl mb-2">ğŸ“Š</p>
                <p>æ­£åœ¨åŠ è¼‰çµ±è¨ˆæ•¸æ“š...</p>
              </div>
            }
          </div>
        }
      }
      @case ('campaigns') {
        <!-- ç‡ŸéŠ·æ´»å‹•é é¢ -->
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ“ˆ</span> ç‡ŸéŠ·æ´»å‹•å”èª¿å™¨
        </h2>
        
        <!-- çµ±ä¸€æ¦‚è¦½ -->
        @if (unifiedOverview()) {
          @let overview = unifiedOverview();
          <div class="grid grid-cols-6 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-xl p-4 border border-blue-500/30">
              <p class="text-2xl font-bold text-white">{{ overview.totals.resourcesDiscovered }}</p>
              <p class="text-xs text-slate-400">ç™¼ç¾è³‡æº</p>
            </div>
            <div class="bg-gradient-to-br from-emerald-500/20 to-green-500/20 rounded-xl p-4 border border-emerald-500/30">
              <p class="text-2xl font-bold text-emerald-400">{{ overview.totals.leadsGenerated }}</p>
              <p class="text-xs text-slate-400">ç”Ÿæˆæ½›å®¢</p>
            </div>
            <div class="bg-gradient-to-br from-orange-500/20 to-amber-500/20 rounded-xl p-4 border border-orange-500/30">
              <p class="text-2xl font-bold text-orange-400">{{ overview.totals.adsSent }}</p>
              <p class="text-xs text-slate-400">ç™¼é€å»£å‘Š</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-xl p-4 border border-purple-500/30">
              <p class="text-2xl font-bold text-purple-400">{{ overview.totals.usersTracked }}</p>
              <p class="text-xs text-slate-400">è¿½è¹¤ç”¨æˆ¶</p>
            </div>
            <div class="bg-gradient-to-br from-pink-500/20 to-rose-500/20 rounded-xl p-4 border border-pink-500/30">
              <p class="text-2xl font-bold text-pink-400">{{ overview.totals.highValueGroups }}</p>
              <p class="text-xs text-slate-400">é«˜åƒ¹å€¼ç¾¤</p>
            </div>
            <div class="bg-gradient-to-br from-cyan-500/20 to-teal-500/20 rounded-xl p-4 border border-cyan-500/30">
              <p class="text-2xl font-bold text-cyan-400">{{ overview.totals.activeCampaigns }}</p>
              <p class="text-xs text-slate-400">æ´»èºæ´»å‹•</p>
            </div>
          </div>
        }
        
        <!-- æ¼æ–—åˆ†æ -->
        @if (funnelAnalysis()) {
          @let funnel = funnelAnalysis();
          <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50 mb-6">
            <h3 class="font-semibold text-white mb-4">ç‡ŸéŠ·æ¼æ–—åˆ†æ</h3>
            <div class="flex items-end gap-1">
              @for (stage of funnel.funnel; track stage.stage; let i = $index) {
                <div class="flex-1 text-center">
                  <div class="h-32 flex flex-col justify-end">
                    <div class="bg-gradient-to-t from-pink-500 to-pink-400 rounded-t-lg transition-all" 
                         [style.height.%]="stage.count > 0 ? Math.max(20, stage.conversionRate) : 10">
                    </div>
                  </div>
                  <p class="text-lg font-bold text-white mt-2">{{ stage.count }}</p>
                  <p class="text-xs text-slate-400">{{ stage.stage }}</p>
                  @if (i > 0) {
                    <p class="text-xs text-slate-500">{{ stage.conversionRate }}%</p>
                  }
                </div>
              }
            </div>
            <p class="text-center text-sm text-slate-400 mt-4">
              æ•´é«”è½‰åŒ–ç‡: <span class="text-pink-400 font-semibold">{{ funnel.overallConversion }}%</span>
            </p>
          </div>
        }
        
        <!-- æ´»å‹•åˆ—è¡¨ -->
        <div class="space-y-4">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold text-white">ç‡ŸéŠ·æ´»å‹•</h3>
            <button (click)="showCampaignForm.set(true)" 
                    class="px-4 py-2 bg-pink-500/20 text-pink-400 rounded-lg hover:bg-pink-500/30 transition-colors flex items-center gap-2">
              <span>+</span> å‰µå»ºæ´»å‹•
            </button>
          </div>
          
          <!-- å‰µå»ºæ´»å‹•è¡¨å–® -->
          @if (showCampaignForm()) {
            <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
              <h4 class="text-lg font-semibold text-white mb-4">å‰µå»ºç‡ŸéŠ·æ´»å‹•</h4>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-slate-400 mb-1">æ´»å‹•åç¨± *</label>
                  <input type="text" 
                         [value]="campaignFormData().name"
                         (input)="updateCampaignFormName($any($event.target).value)"
                         class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-pink-500/50"
                         placeholder="ä¾‹å¦‚ï¼šQ1 ç²å®¢æ´»å‹•">
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">æ´»å‹•æè¿°</label>
                  <input type="text" 
                         [value]="campaignFormData().description"
                         (input)="updateCampaignFormDesc($any($event.target).value)"
                         class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none"
                         placeholder="å¯é¸">
                </div>
                <div class="col-span-2">
                  <label class="block text-sm text-slate-400 mb-2">æ´»å‹•éšæ®µ</label>
                  <div class="flex gap-2 flex-wrap">
                    @for (phase of ['discovery', 'monitoring', 'outreach', 'tracking', 'conversion']; track phase) {
                      <button (click)="toggleCampaignPhase(phase)"
                              class="px-3 py-1.5 rounded-lg text-sm transition-colors"
                              [class]="campaignFormData().phases.includes(phase) ? 'bg-pink-500/30 text-pink-300 border border-pink-500/50' : 'bg-slate-600/50 text-slate-400 border border-slate-600'">
                        {{ getPhaseLabel(phase) }}
                      </button>
                    }
                  </div>
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">é—œéµè©</label>
                  <div class="flex gap-2">
                    <input type="text" 
                           [value]="campaignKeywordInput()"
                           (input)="campaignKeywordInput.set($any($event.target).value)"
                           (keyup.enter)="addCampaignKeyword()"
                           class="flex-1 px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none"
                           placeholder="è¼¸å…¥é—œéµè©">
                    <button (click)="addCampaignKeyword()" class="px-3 py-2 bg-slate-600/50 text-slate-300 rounded-lg">+</button>
                  </div>
                  <div class="flex gap-1 flex-wrap mt-2">
                    @for (keyword of campaignFormData().keywords; track keyword) {
                      <span class="px-2 py-0.5 bg-slate-600/50 text-slate-300 rounded text-xs flex items-center gap-1">
                        {{ keyword }}
                        <button (click)="removeCampaignKeyword(keyword)" class="text-slate-500 hover:text-white">&times;</button>
                      </span>
                    }
                  </div>
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">é¸æ“‡å¸³è™Ÿ *</label>
                  <div class="flex flex-wrap gap-2 p-2 bg-slate-700/30 rounded-lg min-h-[42px]">
                    @for (account of accounts(); track account.id) {
                      @if (account.status === 'Online') {
                        <label class="flex items-center gap-1.5 px-2 py-1 bg-slate-600/50 rounded cursor-pointer hover:bg-slate-600 text-xs">
                          <input type="checkbox" 
                                 [checked]="campaignFormData().assignedAccounts.includes(account.phone)"
                                 (change)="toggleCampaignAccount(account.phone)"
                                 class="rounded border-slate-500 w-3 h-3">
                          <span class="text-slate-300">{{ account.phone }}</span>
                        </label>
                      }
                    }
                  </div>
                </div>
              </div>
              <div class="flex gap-3 mt-4">
                <button (click)="createCampaignFromForm()" 
                        class="px-6 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors">
                  å‰µå»ºæ´»å‹•
                </button>
                <button (click)="showCampaignForm.set(false)" 
                        class="px-6 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                  å–æ¶ˆ
                </button>
              </div>
            </div>
          }
          
          <!-- æ´»å‹•åˆ—è¡¨ -->
          @for (campaign of campaigns(); track campaign.id) {
            <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-2">
                    <h4 class="font-semibold text-white text-lg">{{ campaign.name }}</h4>
                    <span class="text-xs px-2 py-0.5 rounded-full" [class]="getCampaignStatusColor(campaign.status)">
                      {{ getCampaignStatusLabel(campaign.status) }}
                    </span>
                  </div>
                  @if (campaign.description) {
                    <p class="text-sm text-slate-400 mb-2">{{ campaign.description }}</p>
                  }
                  <div class="flex gap-2 mb-3">
                    @for (phase of campaign.phases; track phase) {
                      <span class="text-xs px-2 py-0.5 bg-slate-600/50 text-slate-300 rounded">{{ getPhaseLabel(phase) }}</span>
                    }
                  </div>
                  <div class="grid grid-cols-5 gap-4 text-sm">
                    <div>
                      <span class="text-slate-500">ç¾¤çµ„ç™¼ç¾:</span>
                      <span class="text-white ml-1">{{ campaign.stats.groupsDiscovered }}</span>
                    </div>
                    <div>
                      <span class="text-slate-500">æ½›å®¢:</span>
                      <span class="text-emerald-400 ml-1">{{ campaign.stats.leadsGenerated }}</span>
                    </div>
                    <div>
                      <span class="text-slate-500">å»£å‘Š:</span>
                      <span class="text-orange-400 ml-1">{{ campaign.stats.adsSent }}</span>
                    </div>
                    <div>
                      <span class="text-slate-500">è¿½è¹¤:</span>
                      <span class="text-purple-400 ml-1">{{ campaign.stats.usersTracked }}</span>
                    </div>
                    <div>
                      <span class="text-slate-500">æˆäº¤:</span>
                      <span class="text-pink-400 ml-1">{{ campaign.stats.conversions }}</span>
                    </div>
                  </div>
                </div>
                <div class="flex gap-2">
                  @if (campaign.status === 'draft' || campaign.status === 'paused') {
                    <button (click)="startCampaign(campaign.id)" 
                            class="px-3 py-1.5 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30 text-sm">
                      â–¶ å•Ÿå‹•
                    </button>
                  }
                  @if (campaign.status === 'running') {
                    <button (click)="pauseCampaign(campaign.id)" 
                            class="px-3 py-1.5 bg-yellow-500/20 text-yellow-400 rounded-lg hover:bg-yellow-500/30 text-sm">
                      â¸ æš«åœ
                    </button>
                    <button (click)="stopCampaign(campaign.id)" 
                            class="px-3 py-1.5 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 text-sm">
                      â¹ åœæ­¢
                    </button>
                  }
                  @if (campaign.status !== 'running') {
                    <button (click)="deleteCampaign(campaign.id)" 
                            class="p-2 text-red-400 hover:text-red-300">
                      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/></svg>
                    </button>
                  }
                </div>
              </div>
            </div>
          } @empty {
            <div class="text-center py-12 text-slate-500 bg-slate-800/30 rounded-xl">
              <p class="text-4xl mb-2">ğŸ“ˆ</p>
              <p>é‚„æ²’æœ‰ç‡ŸéŠ·æ´»å‹•</p>
              <p class="text-sm">å‰µå»ºä¸€å€‹å…¨æµç¨‹è‡ªå‹•åŒ–ç‡ŸéŠ·æ´»å‹•</p>
            </div>
          }
        </div>
      }
      @case ('multi-role') {
        <!-- å¤šè§’è‰²å”ä½œé é¢ -->
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ­</span> å¤šè§’è‰²å”ä½œç³»çµ±
        </h2>
        
        <!-- Tab å°èˆª -->
        <div class="flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-lg w-fit">
          <button (click)="multiRoleTab.set('roles')" 
                  [class]="multiRoleTab() === 'roles' ? 'bg-indigo-500/30 text-indigo-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ‘¤</span> è§’è‰²é…ç½®
          </button>
          <button (click)="multiRoleTab.set('scripts')" 
                  [class]="multiRoleTab() === 'scripts' ? 'bg-indigo-500/30 text-indigo-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“œ</span> åŠ‡æœ¬æ¨¡æ¿
          </button>
          <button (click)="multiRoleTab.set('collab')" 
                  [class]="multiRoleTab() === 'collab' ? 'bg-indigo-500/30 text-indigo-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ‘¥</span> å”ä½œç¾¤çµ„
          </button>
          <button (click)="multiRoleTab.set('stats')" 
                  [class]="multiRoleTab() === 'stats' ? 'bg-indigo-500/30 text-indigo-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“Š</span> çµ±è¨ˆåˆ†æ
          </button>
        </div>
        
        <!-- è§’è‰²é…ç½® Tab -->
        @if (multiRoleTab() === 'roles') {
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-slate-400">å…± {{ allRoles().length }} å€‹è§’è‰²åˆ†é…</span>
              <button (click)="showRoleAssignForm.set(true)" 
                      class="px-4 py-2 bg-indigo-500/20 text-indigo-400 rounded-lg hover:bg-indigo-500/30 transition-colors flex items-center gap-2">
                <span>+</span> åˆ†é…è§’è‰²
              </button>
            </div>
            
            <!-- åˆ†é…è§’è‰²è¡¨å–® -->
            @if (showRoleAssignForm()) {
              <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                <h3 class="text-lg font-semibold text-white mb-4">åˆ†é…è§’è‰²çµ¦å¸³è™Ÿ</h3>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">é¸æ“‡å¸³è™Ÿ *</label>
                    <select [value]="newRoleAssign().accountPhone"
                            (change)="updateRoleAssignPhone($any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white">
                      <option value="">é¸æ“‡å¸³è™Ÿ</option>
                      @for (account of accounts(); track account.id) {
                        @if (account.status === 'Online') {
                          <option [value]="account.phone">{{ account.phone }}</option>
                        }
                      }
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">è§’è‰²é¡å‹ *</label>
                    <select [value]="newRoleAssign().roleType"
                            (change)="updateRoleAssignType($any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white">
                      <option value="seller">ğŸ§‘â€ğŸ’¼ éŠ·å”®é¡§å•</option>
                      <option value="expert">ğŸ‘¨â€ğŸ”¬ å°ˆæ¥­é¡§å•</option>
                      <option value="satisfied">ğŸ˜Š æ»¿æ„å®¢æˆ¶</option>
                      <option value="hesitant">ğŸ¤” çŒ¶è±«å®¢æˆ¶</option>
                      <option value="converted">ğŸ‰ æˆäº¤å®¢æˆ¶</option>
                      <option value="curious">â“ å¥½å¥‡è€…</option>
                      <option value="manager">ğŸ‘” ç¶“ç†ä¸»ç®¡</option>
                      <option value="support">ğŸ› ï¸ å”®å¾Œå®¢æœ</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">è§’è‰²åç¨± *</label>
                    <input type="text" 
                           [value]="newRoleAssign().roleName"
                           (input)="updateRoleAssignName($any($event.target).value)"
                           class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none"
                           placeholder="ä¾‹å¦‚ï¼šå°æ˜">
                  </div>
                </div>
                <div class="flex gap-3 mt-4">
                  <button (click)="assignRole()" 
                          class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors">
                    åˆ†é…è§’è‰²
                  </button>
                  <button (click)="showRoleAssignForm.set(false)" 
                          class="px-6 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                    å–æ¶ˆ
                  </button>
                </div>
              </div>
            }
            
            <!-- è§’è‰²é¡å‹ç¸½è¦½ -->
            <div class="grid grid-cols-4 gap-4">
              @for (roleType of ['seller', 'expert', 'satisfied', 'hesitant', 'converted', 'curious', 'manager', 'support']; track roleType) {
                @let rolesOfType = getRolesOfType(roleType);
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">{{ getRoleIcon(roleType) }}</span>
                    <div>
                      <p class="font-semibold text-white">{{ getRoleLabel(roleType) }}</p>
                      <p class="text-xs text-slate-400">{{ rolesOfType.length }} å€‹å¸³è™Ÿ</p>
                    </div>
                  </div>
                  <div class="space-y-1">
                    @for (role of rolesOfType; track role.id) {
                      <div class="flex justify-between items-center text-sm bg-slate-700/30 px-2 py-1 rounded">
                        <span class="text-slate-300">{{ role.roleName }}</span>
                        <button (click)="removeRole(role.id)" class="text-red-400 hover:text-red-300 text-xs">âœ•</button>
                      </div>
                    } @empty {
                      <p class="text-xs text-slate-500">æš«ç„¡å¸³è™Ÿ</p>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- åŠ‡æœ¬æ¨¡æ¿ Tab -->
        @if (multiRoleTab() === 'scripts') {
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-slate-400">å…± {{ scriptTemplates().length }} å€‹åŠ‡æœ¬æ¨¡æ¿</span>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              @for (template of scriptTemplates(); track template.id) {
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <div class="flex justify-between items-start mb-3">
                    <div>
                      <h4 class="font-semibold text-white text-lg">{{ template.name }}</h4>
                      <p class="text-sm text-slate-400">{{ template.description }}</p>
                    </div>
                    <span class="text-xs px-2 py-1 bg-indigo-500/20 text-indigo-400 rounded">
                      {{ getScenarioLabel(template.scenario) }}
                    </span>
                  </div>
                  <div class="space-y-2 text-sm">
                    <div class="flex gap-2">
                      <span class="text-slate-500">éœ€è¦è§’è‰²:</span>
                      <div class="flex gap-1 flex-wrap">
                        @for (role of template.requiredRoles.slice(0, 4); track role) {
                          <span class="px-1.5 py-0.5 bg-slate-600/50 text-slate-300 rounded text-xs">
                            {{ getRoleIcon(role) }} {{ getRoleLabel(role) }}
                          </span>
                        }
                        @if (template.requiredRoles.length > 4) {
                          <span class="text-slate-500">+{{ template.requiredRoles.length - 4 }}</span>
                        }
                      </div>
                    </div>
                    <div class="flex gap-4">
                      <span class="text-slate-500">éšæ®µ: <span class="text-white">{{ template.stages.length }}</span></span>
                      <span class="text-slate-500">æ™‚é•·: <span class="text-white">{{ template.durationMinutes }}åˆ†é˜</span></span>
                      <span class="text-slate-500">ä½¿ç”¨: <span class="text-cyan-400">{{ template.useCount }}æ¬¡</span></span>
                    </div>
                  </div>
                </div>
              } @empty {
                <div class="col-span-2 text-center py-12 text-slate-500 bg-slate-800/30 rounded-xl">
                  <p class="text-4xl mb-2">ğŸ“œ</p>
                  <p>æš«ç„¡åŠ‡æœ¬æ¨¡æ¿</p>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- å”ä½œç¾¤çµ„ Tab -->
        @if (multiRoleTab() === 'collab') {
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-slate-400">å…± {{ collabGroups().length }} å€‹å”ä½œç¾¤çµ„</span>
            </div>
            
            @for (group of collabGroups(); track group.id) {
              <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                <div class="flex justify-between items-start">
                  <div>
                    <div class="flex items-center gap-3 mb-2">
                      <h4 class="font-semibold text-white">{{ group.groupTitle }}</h4>
                      <span class="text-xs px-2 py-0.5 rounded" [class]="getCollabStatusColor(group.status)">
                        {{ getCollabStatusLabel(group.status) }}
                      </span>
                    </div>
                    <div class="text-sm space-y-1">
                      @if (group.targetUsername) {
                        <p class="text-slate-400">ç›®æ¨™ç”¨æˆ¶: <span class="text-cyan-400">&#64;{{ group.targetUsername }}</span></p>
                      }
                      <p class="text-slate-500">æˆå“¡æ•¸: {{ group.memberCount }} | å‰µå»ºæ–¼: {{ group.createdAt | date:'MM/dd HH:mm' }}</p>
                    </div>
                  </div>
                  @if (group.outcome) {
                    <span class="text-xs px-2 py-1 rounded"
                          [class]="group.outcome === 'converted' ? 'bg-green-500/20 text-green-400' : 'bg-slate-500/20 text-slate-400'">
                      {{ group.outcome === 'converted' ? 'å·²æˆäº¤' : group.outcome }}
                    </span>
                  }
                </div>
              </div>
            } @empty {
              <div class="text-center py-12 text-slate-500 bg-slate-800/30 rounded-xl">
                <p class="text-4xl mb-2">ğŸ‘¥</p>
                <p>æš«ç„¡å”ä½œç¾¤çµ„</p>
              </div>
            }
          </div>
        }
        
        <!-- çµ±è¨ˆåˆ†æ Tab -->
        @if (multiRoleTab() === 'stats') {
          <div class="space-y-6">
            @if (collabStats() && roleStats()) {
              <!-- ç¸½è¦½å¡ç‰‡ -->
              <div class="grid grid-cols-4 gap-4">
                <div class="bg-gradient-to-br from-indigo-500/20 to-purple-500/20 rounded-xl p-5 border border-indigo-500/30">
                  <p class="text-3xl font-bold text-white">{{ roleStats().total }}</p>
                  <p class="text-sm text-slate-400">å·²åˆ†é…è§’è‰²</p>
                </div>
                <div class="bg-gradient-to-br from-cyan-500/20 to-blue-500/20 rounded-xl p-5 border border-cyan-500/30">
                  <p class="text-3xl font-bold text-cyan-400">{{ roleStats().accountsWithRoles }}</p>
                  <p class="text-sm text-slate-400">æœ‰è§’è‰²å¸³è™Ÿ</p>
                </div>
                <div class="bg-gradient-to-br from-emerald-500/20 to-green-500/20 rounded-xl p-5 border border-emerald-500/30">
                  <p class="text-3xl font-bold text-emerald-400">{{ collabStats().activeGroups }}</p>
                  <p class="text-sm text-slate-400">æ´»èºå”ä½œç¾¤çµ„</p>
                </div>
                <div class="bg-gradient-to-br from-pink-500/20 to-rose-500/20 rounded-xl p-5 border border-pink-500/30">
                  <p class="text-3xl font-bold text-pink-400">{{ collabStats().conversionRate }}%</p>
                  <p class="text-sm text-slate-400">å”ä½œè½‰åŒ–ç‡</p>
                </div>
              </div>
              
              <!-- è©³ç´°çµ±è¨ˆ -->
              <div class="grid grid-cols-2 gap-6">
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <h4 class="font-semibold text-white mb-4">è§’è‰²åˆ†ä½ˆ</h4>
                  <div class="space-y-2">
                    @for (roleType of ['seller', 'expert', 'satisfied', 'hesitant', 'converted', 'curious', 'manager', 'support']; track roleType) {
                      @let count = roleStats().byType[roleType] || 0;
                      <div class="flex justify-between items-center">
                        <span class="text-slate-400">{{ getRoleIcon(roleType) }} {{ getRoleLabel(roleType) }}</span>
                        <span class="px-2 py-0.5 bg-indigo-500/20 text-indigo-400 rounded text-sm">{{ count }}</span>
                      </div>
                    }
                  </div>
                </div>
                
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <h4 class="font-semibold text-white mb-4">å”ä½œçµ±è¨ˆ</h4>
                  <div class="space-y-3">
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">ç¸½å”ä½œç¾¤çµ„</span>
                      <span class="text-white">{{ collabStats().total }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">ç¸½æ¶ˆæ¯æ•¸</span>
                      <span class="text-cyan-400">{{ collabStats().totalMessages }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">ç›®æ¨™ç”¨æˆ¶å›è¦†</span>
                      <span class="text-emerald-400">{{ collabStats().targetResponses }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">å·²å®Œæˆ</span>
                      <span class="text-purple-400">{{ collabStats().byStatus?.completed || 0 }}</span>
                    </div>
                  </div>
                </div>
              </div>
            } @else {
              <div class="text-center py-12 text-slate-500">
                <p class="text-4xl mb-2">ğŸ“Š</p>
                <p>æ­£åœ¨åŠ è¼‰çµ±è¨ˆæ•¸æ“š...</p>
              </div>
            }
          </div>
        }
      }
      @case ('ai-center') {
        <!-- AI ä¸­å¿ƒé é¢ -->
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ§ </span> {{ t('aiCenter') }}
        </h2>
        
        <!-- Tab å°èˆª -->
        <div class="flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-lg w-fit">
          <button (click)="aiCenterTab.set('config')" 
                  [class]="aiCenterTab() === 'config' ? 'bg-purple-500/30 text-purple-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>âš™ï¸</span> {{ t('aiConfiguration') }}
          </button>
          <button (click)="aiCenterTab.set('chat')" 
                  [class]="aiCenterTab() === 'chat' ? 'bg-purple-500/30 text-purple-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ’¬</span> {{ t('aiAutoChat') }}
          </button>
          <button (click)="aiCenterTab.set('rag')" 
                  [class]="aiCenterTab() === 'rag' ? 'bg-purple-500/30 text-purple-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“š</span> {{ t('ragKnowledge') }}
          </button>
          <button (click)="aiCenterTab.set('voice')" 
                  [class]="aiCenterTab() === 'voice' ? 'bg-purple-500/30 text-purple-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ™ï¸</span> {{ t('voiceService') }}
          </button>
        </div>
        
        <!-- Tab å…§å®¹ -->
        @switch (aiCenterTab()) {
          @case ('config') {
            <!-- AI é…ç½® Tab - å°‡å¾è¨­ç½®é é¢ç§»å‹•éä¾†çš„å…§å®¹ -->
            <div class="space-y-6">
              <!-- AI API Configuration -->
              <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl mb-4 font-semibold flex items-center gap-2">
                  <span class="text-2xl">âœ¨</span> {{ t('aiConfiguration') }}
                </h3>
                <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">{{ t('aiConfigurationHint') }}</p>
                
                <div class="space-y-4">
                  <!-- API Type Selection -->
                  <div>
                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">{{ t('aiProvider') }}</label>
                    <div class="flex flex-wrap gap-4">
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="aiTypeCenter" [checked]="aiApiType() === 'gemini'" (change)="aiApiType.set('gemini')" class="form-radio text-cyan-500">
                        <span class="text-sm">Google Gemini</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="aiTypeCenter" [checked]="aiApiType() === 'openai'" (change)="aiApiType.set('openai')" class="form-radio text-cyan-500">
                        <span class="text-sm">OpenAI</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="aiTypeCenter" [checked]="aiApiType() === 'custom'" (change)="aiApiType.set('custom')" class="form-radio text-cyan-500">
                        <span class="text-sm">{{ t('customApi') }}</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="aiTypeCenter" [checked]="aiApiType() === 'local'" (change)="aiApiType.set('local')" class="form-radio text-purple-500">
                        <span class="text-sm bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent font-semibold">ğŸ  {{ t('localAi') }}</span>
                      </label>
                    </div>
                  </div>
                  
                  <!-- API Key (éæœ¬åœ° AI) -->
                  @if(aiApiType() !== 'local') {
                    <div>
                      <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">API Key</label>
                      <div class="relative">
                        <input [type]="showApiKey() ? 'text' : 'password'" [ngModel]="aiApiKey()" (ngModelChange)="aiApiKey.set($event)"
                               class="form-input w-full bg-slate-800/50 border-slate-700 rounded-lg py-2 px-3 pr-12 text-white focus:ring-2 focus:ring-cyan-500 font-mono text-sm"
                               [placeholder]="aiApiType() === 'gemini' ? 'AIza...' : 'sk-...'">
                        <button type="button" (click)="showApiKey.set(!showApiKey())" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white">
                          {{ showApiKey() ? 'ğŸ‘ï¸' : 'ğŸ™ˆ' }}
                        </button>
                      </div>
                    </div>
                  }
                  
                  <!-- æœ¬åœ° AI é…ç½® -->
                  @if(aiApiType() === 'local') {
                    <div class="space-y-4 p-4 bg-gradient-to-r from-purple-500/10 to-pink-500/10 rounded-lg border border-purple-500/20">
                      <h4 class="text-sm font-semibold text-purple-400 flex items-center gap-2">
                        <span>ğŸ </span> æœ¬åœ° AI é…ç½®
                      </h4>
                      
                      <!-- æœ¬åœ° AI æä¾›è€…é¸æ“‡ -->
                      <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æœå‹™æä¾›è€…</label>
                        <div class="flex flex-wrap gap-3">
                          <button (click)="setLocalAiPresets('ollama')" 
                                  [class]="localAiProvider() === 'ollama' ? 'bg-purple-500 text-white' : 'bg-slate-700 text-slate-300'"
                                  class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            <span>ğŸ¦™</span> Ollama
                          </button>
                          <button (click)="setLocalAiPresets('lmstudio')"
                                  [class]="localAiProvider() === 'lmstudio' ? 'bg-purple-500 text-white' : 'bg-slate-700 text-slate-300'"
                                  class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            <span>ğŸ“¦</span> LM Studio
                          </button>
                          <button (click)="setLocalAiPresets('custom')"
                                  [class]="localAiProvider() === 'custom' ? 'bg-purple-500 text-white' : 'bg-slate-700 text-slate-300'"
                                  class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            <span>âš™ï¸</span> è‡ªå®šç¾©
                          </button>
                        </div>
                      </div>
                      
                      <!-- æœå‹™åœ°å€ -->
                      <div>
                        <label class="block text-sm font-medium text-slate-400 mb-1">æœå‹™åœ°å€</label>
                        <input [ngModel]="localAiEndpoint()" (ngModelChange)="localAiEndpoint.set($event)"
                               class="form-input w-full bg-slate-800/50 border-slate-700 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-purple-500 font-mono text-sm"
                               [placeholder]="localAiProvider() === 'ollama' ? 'http://localhost:11434' : 'http://localhost:1234'">
                        <p class="text-xs text-slate-500 mt-1">
                          {{ localAiProvider() === 'ollama' ? 'Ollama é»˜èªç«¯å£ 11434' : 
                             localAiProvider() === 'lmstudio' ? 'LM Studio é»˜èªç«¯å£ 1234' : 'è¼¸å…¥è‡ªå®šç¾©æœå‹™åœ°å€' }}
                        </p>
                      </div>
                      
                      <!-- æ¨¡å‹é¸æ“‡ -->
                      <div>
                        <label class="block text-sm font-medium text-slate-400 mb-1">æ¨¡å‹</label>
                        <div class="flex gap-2">
                          @if(localAiProvider() === 'ollama' && availableOllamaModels().length > 0) {
                            <select [ngModel]="localAiModel()" (ngModelChange)="localAiModel.set($event)"
                                    class="flex-1 bg-slate-800/50 border-slate-700 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-purple-500">
                              @for(model of availableOllamaModels(); track model) {
                                <option [value]="model">{{ model }}</option>
                              }
                            </select>
                            <button (click)="refreshOllamaModels()" 
                                    class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg transition-colors"
                                    title="åˆ·æ–°æ¨¡å‹åˆ—è¡¨">
                              ğŸ”„
                            </button>
                          } @else {
                            <input [ngModel]="localAiModel()" (ngModelChange)="localAiModel.set($event)"
                                   class="flex-1 bg-slate-800/50 border-slate-700 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-purple-500 font-mono text-sm"
                                   [placeholder]="localAiProvider() === 'ollama' ? 'qwen2:7b' : 'gpt-3.5-turbo'">
                            @if(localAiProvider() === 'ollama') {
                              <button (click)="refreshOllamaModels()" 
                                      class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg transition-colors"
                                      title="ç²å–æ¨¡å‹åˆ—è¡¨">
                                ğŸ”
                              </button>
                            }
                          }
                        </div>
                        <p class="text-xs text-slate-500 mt-1">
                          æ¨è–¦æ¨¡å‹ï¼šqwen2:7bï¼ˆä¸­è‹±æ–‡ï¼‰ã€llama3:8bï¼ˆè‹±æ–‡ï¼‰ã€mistral:7bï¼ˆå¿«é€Ÿï¼‰
                        </p>
                      </div>
                      
                      <!-- è‡ªå‹•é™ç´šè¨­ç½® -->
                      <div class="p-3 bg-slate-800/50 rounded-lg">
                        <label class="flex items-center gap-3 cursor-pointer">
                          <input type="checkbox" [checked]="aiAutoFallback()" (change)="aiAutoFallback.set(!aiAutoFallback())"
                                 class="w-4 h-4 text-purple-500 bg-slate-700 border-slate-600 rounded focus:ring-purple-500">
                          <div>
                            <span class="text-sm text-slate-300">è‡ªå‹•é™ç´šåˆ°é›²ç«¯æœå‹™</span>
                            <p class="text-xs text-slate-500">æœ¬åœ° AI ä¸å¯ç”¨æ™‚è‡ªå‹•åˆ‡æ›åˆ°å‚™ç”¨é›²ç«¯æœå‹™</p>
                          </div>
                        </label>
                        @if(aiAutoFallback()) {
                          <div class="mt-3 ml-7">
                            <label class="block text-xs text-slate-400 mb-1">å‚™ç”¨æœå‹™</label>
                            <select [ngModel]="aiBackupProvider()" (ngModelChange)="aiBackupProvider.set($event)"
                                    class="bg-slate-700 border-slate-600 rounded py-1 px-2 text-sm text-white">
                              <option value="gemini">Google Gemini</option>
                              <option value="openai">OpenAI</option>
                            </select>
                          </div>
                        }
                      </div>
                      
                      <!-- æ¸¬è©¦é€£æ¥ -->
                      <div class="flex items-center gap-3">
                        <button (click)="testLocalAiConnection()" [disabled]="!localAiEndpoint() || isTestingLocalAi()"
                                class="bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-lg transition-colors disabled:opacity-50">
                          {{ isTestingLocalAi() ? 'â³ æ¸¬è©¦ä¸­...' : 'âš¡ æ¸¬è©¦é€£æ¥' }}
                        </button>
                        @if(localAiStatus()) {
                          <span [class]="localAiStatus() === 'success' ? 'text-green-400' : 'text-red-400'">
                            {{ localAiStatus() === 'success' ? 'âœ… é€£æ¥æˆåŠŸ' : 'âŒ ' + localAiError() }}
                          </span>
                        }
                      </div>
                    </div>
                  }
                  
                  <!-- ä¿å­˜æŒ‰éˆ• -->
                  <div class="flex gap-3 pt-4">
                    <button (click)="saveAiSettings()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-2 px-6 rounded-lg transition-all shadow-lg">
                      âœ“ {{ t('saveSettings') }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          }
          @case ('chat') {
            <!-- AI è‡ªå‹•èŠå¤© Tab -->
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
              <h3 class="text-xl mb-4 font-semibold flex items-center gap-2">
                <span class="text-2xl">ğŸ’¬</span> {{ t('aiAutoChat') }}
              </h3>
              
              <!-- å•Ÿç”¨é–‹é—œ -->
              <div class="flex items-center justify-between p-4 bg-slate-800/30 rounded-lg mb-4">
                <div>
                  <h4 class="text-sm font-medium text-white">{{ t('enableAiAutoChat') }}</h4>
                  <p class="text-xs text-slate-400">{{ t('aiAutoChatHint') }}</p>
                </div>
                <input type="checkbox" [checked]="aiAutoChatEnabled()" (change)="aiAutoChatEnabled.set(!aiAutoChatEnabled())" class="form-checkbox text-cyan-500 rounded h-5 w-5">
              </div>
              
              <!-- æ¨¡å¼é¸æ“‡ -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-400 mb-2">{{ t('chatMode') }}</label>
                <div class="grid grid-cols-4 gap-2">
                  <button (click)="aiAutoChatMode.set('full')" [class]="aiAutoChatMode() === 'full' ? 'bg-cyan-500/30 border-cyan-500' : 'bg-slate-800/50 border-slate-700'"
                          class="p-3 rounded-lg border text-center transition-all">
                    <div class="text-lg mb-1">ğŸ¤–</div>
                    <div class="text-xs">å…¨è‡ªå‹•</div>
                  </button>
                  <button (click)="aiAutoChatMode.set('semi')" [class]="aiAutoChatMode() === 'semi' ? 'bg-cyan-500/30 border-cyan-500' : 'bg-slate-800/50 border-slate-700'"
                          class="p-3 rounded-lg border text-center transition-all">
                    <div class="text-lg mb-1">ğŸ¯</div>
                    <div class="text-xs">åŠè‡ªå‹•</div>
                  </button>
                  <button (click)="aiAutoChatMode.set('assist')" [class]="aiAutoChatMode() === 'assist' ? 'bg-cyan-500/30 border-cyan-500' : 'bg-slate-800/50 border-slate-700'"
                          class="p-3 rounded-lg border text-center transition-all">
                    <div class="text-lg mb-1">ğŸ’¡</div>
                    <div class="text-xs">è¼”åŠ©</div>
                  </button>
                  <button (click)="aiAutoChatMode.set('keyword')" [class]="aiAutoChatMode() === 'keyword' ? 'bg-cyan-500/30 border-cyan-500' : 'bg-slate-800/50 border-slate-700'"
                          class="p-3 rounded-lg border text-center transition-all">
                    <div class="text-lg mb-1">ğŸ”‘</div>
                    <div class="text-xs">é—œéµè©</div>
                  </button>
                </div>
              </div>
              
              <!-- ç³»çµ±æç¤ºè© -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-400 mb-2">{{ t('systemPrompt') }}</label>
                <textarea [ngModel]="aiSystemPrompt()" (ngModelChange)="aiSystemPrompt.set($event)" rows="4"
                          class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-cyan-500"
                          placeholder="ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å®¢æœåŠ©æ‰‹..."></textarea>
              </div>
              
              <!-- å›è¦†å»¶é² -->
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-400 mb-2">æœ€å°å»¶é²ï¼ˆç§’ï¼‰</label>
                  <input type="number" [ngModel]="aiReplyDelay()[0]" (ngModelChange)="aiReplyDelay.set([$event, aiReplyDelay()[1]])"
                         class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white" min="1" max="60">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-400 mb-2">æœ€å¤§å»¶é²ï¼ˆç§’ï¼‰</label>
                  <input type="number" [ngModel]="aiReplyDelay()[1]" (ngModelChange)="aiReplyDelay.set([aiReplyDelay()[0], $event])"
                         class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white" min="1" max="120">
                </div>
              </div>
            </div>
          }
          @case ('rag') {
            <!-- RAG çŸ¥è­˜åº« Tab -->
            <div class="space-y-6">
              <!-- RAG çµ±è¨ˆå¡ç‰‡ -->
              <div class="grid grid-cols-4 gap-4">
                <div class="bg-slate-900/50 border border-cyan-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">ğŸ’¡</div>
                  <div class="text-xl font-bold text-cyan-400">{{ ragStats().total_knowledge }}</div>
                  <div class="text-xs text-slate-400">ç¸½çŸ¥è­˜æ•¸</div>
                </div>
                <div class="bg-slate-900/50 border border-purple-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">â“</div>
                  <div class="text-xl font-bold text-purple-400">{{ ragStats().qa_count }}</div>
                  <div class="text-xs text-slate-400">å•ç­”å°</div>
                </div>
                <div class="bg-slate-900/50 border border-emerald-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">ğŸ“</div>
                  <div class="text-xl font-bold text-emerald-400">{{ ragStats().scripts_count }}</div>
                  <div class="text-xs text-slate-400">è©±è¡“</div>
                </div>
                <div class="bg-slate-900/50 border border-yellow-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">ğŸ“Š</div>
                  <div class="text-xl font-bold text-yellow-400">{{ (ragStats().avg_score * 100).toFixed(0) }}%</div>
                  <div class="text-xs text-slate-400">å¹³å‡è©•åˆ†</div>
                </div>
              </div>
              
              <!-- RAG æ“ä½œ -->
              <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl">
                <div class="flex items-center gap-3 mb-4">
                  <span class="px-3 py-1 rounded-lg text-sm" [class]="ragSystemInitialized() ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'">
                    {{ ragSystemInitialized() ? 'ğŸŸ¢ RAG ç³»çµ±åœ¨ç·š' : 'ğŸ”´ æœªåˆå§‹åŒ–' }}
                  </span>
                  <button (click)="initRagSystem()" [disabled]="isInitializingRag()" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg">
                    {{ isInitializingRag() ? 'â³ åˆå§‹åŒ–ä¸­...' : 'ğŸš€ åˆå§‹åŒ– RAG' }}
                  </button>
                  <button (click)="triggerRagLearning()" [disabled]="isRagLearning()" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg">
                    {{ isRagLearning() ? 'â³ å­¸ç¿’ä¸­...' : 'ğŸ“ è§¸ç™¼å­¸ç¿’' }}
                  </button>
                  <button (click)="showAddRagKnowledgeDialog.set(true)" class="px-4 py-2 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 rounded-lg">
                    â• æ‰‹å‹•æ·»åŠ 
                  </button>
                </div>
                
                <!-- RAG æœç´¢ -->
                <div class="flex gap-2 mb-4">
                  <input type="text" [(ngModel)]="ragSearchQuery" (keyup.enter)="searchRagKnowledge()"
                         placeholder="æœç´¢çŸ¥è­˜åº«..."
                         class="flex-1 bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white">
                  <button (click)="searchRagKnowledge()" [disabled]="isSearchingRag()" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg">
                    {{ isSearchingRag() ? 'ğŸ” æœç´¢ä¸­...' : 'ğŸ” æœç´¢' }}
                  </button>
                </div>
                
                <!-- æœç´¢çµæœ -->
                @if(ragSearchResults().length > 0) {
                  <div class="space-y-2 max-h-64 overflow-y-auto">
                    @for(result of ragSearchResults(); track result.id) {
                      <div class="p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                        <div class="flex justify-between items-start mb-2">
                          <span class="text-xs px-2 py-0.5 bg-cyan-500/20 text-cyan-400 rounded">{{ result.type }}</span>
                          <span class="text-xs text-slate-500">ç›¸ä¼¼åº¦: {{ (result.similarity * 100).toFixed(0) }}%</span>
                        </div>
                        @if(result.question) {
                          <div class="text-sm text-slate-400 mb-1">Q: {{ result.question }}</div>
                        }
                        <div class="text-sm text-white">{{ result.answer }}</div>
                      </div>
                    }
                  </div>
                }
              </div>
              
              <!-- RAG å•Ÿç”¨é–‹é—œ -->
              <div class="bg-slate-900/50 border border-slate-500/20 p-4 rounded-xl">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="text-sm font-medium text-white">{{ t('ragEnabled') }}</h4>
                    <p class="text-xs text-slate-400">{{ t('ragHint') }}</p>
                  </div>
                  <input type="checkbox" [checked]="ragEnabled()" (change)="ragEnabled.set(!ragEnabled())" class="form-checkbox text-cyan-500 rounded h-5 w-5">
                </div>
              </div>
            </div>
          }
          @case ('voice') {
            <!-- èªéŸ³æœå‹™ Tab -->
            <div class="space-y-6">
              <!-- TTS é…ç½® -->
              <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold flex items-center gap-2">
                    <span>ğŸ”Š</span> {{ t('ttsService') }}
                  </h3>
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-slate-400">{{ t('enableTts') }}</span>
                    <input type="checkbox" [checked]="ttsEnabled()" (change)="ttsEnabled.set(!ttsEnabled())" class="form-checkbox text-cyan-500 rounded">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-400 mb-1">{{ t('ttsEndpointLabel') }}</label>
                  <input [ngModel]="ttsEndpoint()" (ngModelChange)="ttsEndpoint.set($event)"
                         class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white font-mono text-sm"
                         placeholder="http://localhost:9881">
                </div>
                <div class="flex gap-2 mt-3">
                  <button (click)="testTtsService()" [disabled]="!ttsEndpoint() || isTestingTts()" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg">
                    {{ isTestingTts() ? 'â³ æ¸¬è©¦ä¸­...' : 'âš¡ æ¸¬è©¦ TTS' }}
                  </button>
                  @if(ttsStatus()) {
                    <span class="flex items-center" [class]="ttsStatus() === 'success' ? 'text-green-400' : 'text-red-400'">
                      {{ ttsStatus() === 'success' ? 'âœ… é€£æ¥æˆåŠŸ' : 'âŒ ' + ttsError() }}
                    </span>
                  }
                </div>
              </div>
              
              <!-- STT é…ç½® -->
              <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold flex items-center gap-2">
                    <span>ğŸ¤</span> {{ t('sttService') }}
                  </h3>
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-slate-400">{{ t('enableStt') }}</span>
                    <input type="checkbox" [checked]="sttEnabled()" (change)="sttEnabled.set(!sttEnabled())" class="form-checkbox text-cyan-500 rounded">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-400 mb-1">{{ t('sttEndpointLabel') }}</label>
                  <input [ngModel]="sttEndpoint()" (ngModelChange)="sttEndpoint.set($event)"
                         class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white font-mono text-sm"
                         placeholder="http://localhost:9000">
                </div>
                <div class="flex gap-2 mt-3">
                  <button (click)="testSttService()" [disabled]="!sttEndpoint() || isTestingStt()" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg">
                    {{ isTestingStt() ? 'â³ æ¸¬è©¦ä¸­...' : 'âš¡ æ¸¬è©¦ STT' }}
                  </button>
                  @if(sttStatus()) {
                    <span class="flex items-center" [class]="sttStatus() === 'success' ? 'text-green-400' : 'text-red-400'">
                      {{ sttStatus() === 'success' ? 'âœ… é€£æ¥æˆåŠŸ' : 'âŒ ' + sttError() }}
                    </span>
                  }
                </div>
              </div>
              
              <!-- ä¿å­˜æŒ‰éˆ• -->
              <button (click)="saveAiSettings()" class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-all shadow-lg">
                âœ“ {{ t('saveSettings') }}
              </button>
            </div>
          }
        }
        
        <!-- æ·»åŠ çŸ¥è­˜å°è©±æ¡† -->
        @if (showAddRagKnowledgeDialog()) {
          <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="showAddRagKnowledgeDialog.set(false)">
            <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-6 border border-purple-500/30" (click)="$event.stopPropagation()">
              <h3 class="text-lg font-bold text-white mb-4">â• æ‰‹å‹•æ·»åŠ çŸ¥è­˜</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm text-slate-400 mb-1">é¡å‹</label>
                  <select [(ngModel)]="newRagKnowledge.type" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white">
                    <option value="qa">å•ç­”å°</option>
                    <option value="script">è©±è¡“</option>
                    <option value="product">ç”¢å“ä¿¡æ¯</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">{{ t('ragQuestion') }}</label>
                  <input type="text" [(ngModel)]="newRagKnowledge.question" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white" placeholder="ç”¨æˆ¶å¯èƒ½å•çš„å•é¡Œ...">
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">{{ t('ragAnswer') }} *</label>
                  <textarea [(ngModel)]="newRagKnowledge.answer" rows="4" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white" placeholder="æ¨™æº–å›ç­”..."></textarea>
                </div>
              </div>
              <div class="flex gap-3 mt-6">
                <button (click)="showAddRagKnowledgeDialog.set(false)" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2.5 rounded-lg">{{ t('cancel') }}</button>
                <button (click)="addRagKnowledge()" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-2.5 rounded-lg">{{ t('addKnowledge') }}</button>
              </div>
            </div>
          </div>
        }
      }
      @case ('runtime-logs') {
        <!-- é‹è¡Œæ—¥èªŒé é¢ï¼ˆåˆä½µç›£æ§ä¸­å¿ƒå’Œå‘Šè­¦ï¼‰ -->
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ“Š</span> é‹è¡Œæ—¥èªŒ
        </h2>
        
        <!-- Tab å°èˆª -->
        <div class="flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-lg w-fit">
          <button (click)="runtimeLogsTab.set('analytics')" 
                  [class]="runtimeLogsTab() === 'analytics' ? 'bg-cyan-500/30 text-cyan-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“ˆ</span> {{ t('analytics') }}
          </button>
          <button (click)="runtimeLogsTab.set('logs')" 
                  [class]="runtimeLogsTab() === 'logs' ? 'bg-cyan-500/30 text-cyan-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“‹</span> {{ t('logs') }}
          </button>
          <button (click)="runtimeLogsTab.set('performance')" 
                  [class]="runtimeLogsTab() === 'performance' ? 'bg-cyan-500/30 text-cyan-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>âš¡</span> {{ t('performance') }}
          </button>
          <button (click)="runtimeLogsTab.set('alerts')" 
                  [class]="runtimeLogsTab() === 'alerts' ? 'bg-cyan-500/30 text-cyan-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2 relative">
            <span>ğŸ””</span> {{ t('alerts') }}
            @if(unacknowledgedAlertsCount() > 0) {
              <span class="absolute -top-1 -right-1 text-xs font-bold rounded-full w-4 h-4 flex items-center justify-center" style="background-color: var(--error); color: white;">{{ unacknowledgedAlertsCount() }}</span>
            }
          </button>
        </div>
        
        <!-- Tab å…§å®¹ -->
        @switch (runtimeLogsTab()) {
          @case ('analytics') {
            <!-- æ•¸æ“šåˆ†æ - åŸ analytics é é¢å…§å®¹ -->
            <div class="flex items-center justify-between mb-8">
              <h3 class="text-2xl font-bold text-slate-900 dark:text-white">{{ t('analyticsTitle') }}</h3>
              <div class="flex items-center gap-4">
                <select [ngModel]="selectedAnalyticsCampaignId()" (ngModelChange)="selectedAnalyticsCampaignId.set($event)" class="form-select bg-slate-800/50 border-slate-700 rounded-lg p-2 text-sm focus:ring-1 focus:ring-cyan-500">
                  <option value="all">{{t('allCampaigns')}}</option>
                  @for(campaign of campaigns(); track campaign.id) {
                    <option [value]="campaign.id">{{campaign.name}}</option>
                  }
                </select>
                <select [ngModel]="selectedDays()" (ngModelChange)="onDaysChange($event)" class="form-select bg-slate-800/50 border-slate-700 rounded-lg p-2 text-sm focus:ring-1 focus:ring-cyan-500">
                  <option [value]="7">{{t('last7Days')}}</option>
                  <option [value]="14">{{t('last14Days')}}</option>
                  <option [value]="30">{{t('last30Days')}}</option>
                </select>
                <button (click)="loadAllAnalytics(selectedDays())" class="bg-cyan-500 hover:bg-cyan-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                  <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                  {{t('refresh')}}
                </button>
              </div>
            </div>
            <app-analytics-charts [capturesData]="capturesChartData()" [conversionsData]="conversionsChartData()" [messagesData]="messagesChartData()" [funnelData]="funnelChartData()"></app-analytics-charts>
          }
          @case ('logs') {
            <!-- ç³»çµ±æ—¥å¿— - åŸ logs é é¢å…§å®¹ -->
            <div class="mb-4 flex items-center justify-between">
              <h3 class="text-2xl font-bold text-white">{{ t('logs') }}</h3>
              <div class="flex gap-2">
                <button (click)="clearLogs()" class="bg-red-500/20 hover:bg-red-500/30 text-red-400 py-2 px-4 rounded-lg">
                  ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ
                </button>
              </div>
            </div>
            <div class="bg-slate-900/50 border border-slate-500/20 rounded-xl p-4 max-h-[600px] overflow-y-auto font-mono text-sm">
              @for(log of logs().slice().reverse(); track $index) {
                <div class="py-1 border-b border-slate-800/50 flex gap-3" [class.text-red-400]="log.type === 'error'" [class.text-yellow-400]="log.type === 'warning'" [class.text-green-400]="log.type === 'success'" [class.text-slate-400]="log.type === 'info'">
                  <span class="text-slate-600 shrink-0">{{ log.timestamp | date:'HH:mm:ss' }}</span>
                  <span class="shrink-0">[{{ log.type.toUpperCase() }}]</span>
                  <span class="break-all">{{ log.message }}</span>
                </div>
              } @empty {
                <div class="text-center text-slate-500 py-8">æš«ç„¡æ—¥èªŒ</div>
              }
            </div>
          }
          @case ('performance') {
            <!-- æ€§èƒ½ç›£æ§ - åŸ performance é é¢å…§å®¹ -->
            <app-performance-monitor></app-performance-monitor>
          }
          @case ('alerts') {
            <!-- å‘Šè­¦ç®¡ç† -->
            <div class="mb-6">
              <!-- Alert Filter Section -->
              <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-6">
                  <div class="flex items-center justify-between mb-4">
                      <h3 class="text-lg font-semibold">è¿‡æ»¤é€‰é¡¹</h3>
                      <button (click)="loadAlerts()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg shadow-cyan-500/20">åˆ·æ–°</button>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                          <label class="block text-sm font-medium mb-2">å‘Šè­¦çº§åˆ«</label>
                          <select (change)="loadAlerts(false, $any($event.target).value || undefined)" class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                              <option value="">å…¨éƒ¨çº§åˆ«</option>
                              <option value="info">ä¿¡æ¯</option>
                              <option value="warning">è­¦å‘Š</option>
                              <option value="error">é”™è¯¯</option>
                              <option value="critical">ä¸¥é‡</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium mb-2">çŠ¶æ€</label>
                          <select (change)="loadAlerts($any($event.target).value === 'unresolved')" class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                              <option value="all">å…¨éƒ¨</option>
                              <option value="unresolved">æœªè§£å†³</option>
                          </select>
                      </div>
                      <div class="flex items-end">
                          <button (click)="loadAlerts(true)" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">ä»…æ˜¾ç¤ºæœªè§£å†³</button>
                      </div>
                  </div>
              </div>
              
              <!-- Alerts Display -->
              <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                  <div class="mb-4 text-sm text-slate-500 dark:text-slate-400">
                      æ˜¾ç¤º {{ alerts().length }} æ¡å‘Šè­¦
                      @if(unacknowledgedAlertsCount() > 0) {
                          <span class="ml-2 text-red-500 font-bold">{{ unacknowledgedAlertsCount() }} æ¡æœªç¡®è®¤</span>
                      }
                  </div>
                  <div class="space-y-3">
                      @for(alert of alerts(); track alert.id) {
                          <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg border-l-4" 
                               [class.border-blue-500]="alert.level === 'info'"
                               [class.border-yellow-500]="alert.level === 'warning'"
                               [class.border-orange-500]="alert.level === 'error'"
                               [class.border-red-500]="alert.level === 'critical'">
                              <div class="flex items-start justify-between">
                                  <div class="flex-1">
                                      <div class="flex items-center gap-3 mb-2">
                                          <span class="px-2.5 py-1 text-xs font-semibold rounded-full"
                                                [class.bg-blue-500/20]="alert.level === 'info'"
                                                [class.text-blue-400]="alert.level === 'info'"
                                                [class.bg-yellow-500/20]="alert.level === 'warning'"
                                                [class.text-yellow-400]="alert.level === 'warning'"
                                                [class.bg-orange-500/20]="alert.level === 'error'"
                                                [class.text-orange-400]="alert.level === 'error'"
                                                [class.bg-red-500/20]="alert.level === 'critical'"
                                                [class.text-red-400]="alert.level === 'critical'">
                                              {{ alert.level.toUpperCase() }}
                                          </span>
                                          <span class="text-xs text-slate-500 dark:text-slate-400">{{ alert.alert_type }}</span>
                                          <span class="text-xs text-slate-500 dark:text-slate-400">{{ formatDate(alert.timestamp) }}</span>
                                          @if(alert.acknowledged) {
                                              <span class="text-xs bg-green-500/20 text-green-400 px-2 py-0.5 rounded-full">å·²ç¡®è®¤</span>
                                          }
                                          @if(alert.resolved) {
                                              <span class="text-xs bg-gray-500/20 text-gray-400 px-2 py-0.5 rounded-full">å·²è§£å†³</span>
                                          }
                                      </div>
                                      <p class="text-slate-700 dark:text-slate-300 mb-2">{{ alert.message }}</p>
                                      @if(isValidAlertDetails(alert.details)) {
                                          <div class="text-xs text-slate-500 dark:text-slate-400 mt-2">
                                              <details>
                                                  <summary class="cursor-pointer hover:text-slate-600 dark:hover:text-slate-300">æŸ¥çœ‹è¯¦æƒ…</summary>
                                                  <pre class="mt-2 p-2 bg-slate-100 dark:bg-slate-900 rounded text-xs overflow-x-auto">{{ safeStringify(alert.details) }}</pre>
                                              </details>
                                          </div>
                                      }
                                  </div>
                                  <div class="flex gap-2 ml-4">
                                      @if(!alert.acknowledged) {
                                          <button (click)="acknowledgeAlert(alert.id)" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded transition duration-200" title="ç¡®è®¤å‘Šè­¦">ç¡®è®¤</button>
                                      }
                                      @if(!alert.resolved) {
                                          <button (click)="resolveAlert(alert.id)" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded transition duration-200" title="è§£å†³å‘Šè­¦">è§£å†³</button>
                                      }
                                  </div>
                              </div>
                          </div>
                      } @empty {
                          <p class="text-center text-slate-500 py-8">æš‚æ— å‘Šè­¦</p>
                      }
                  </div>
              </div>
            </div>
          }
        }
      }
      @case ('analytics') {
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-4xl font-bold text-slate-900 dark:text-white">{{ t('analyticsTitle') }}</h2>
            <div class="flex items-center gap-4">
                <select [ngModel]="selectedAnalyticsCampaignId()" (ngModelChange)="selectedAnalyticsCampaignId.set($event)" class="form-select bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500">
                    <option value="all">{{t('allCampaigns')}}</option>
                    @for(campaign of campaigns(); track campaign.id) {
                        <option [value]="campaign.id">{{campaign.name}}</option>
                    }
                </select>
                <button (click)="loadAllAnalytics(7)" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg shadow-cyan-500/20">åˆ·æ–°æ•°æ®</button>
            </div>
        </div>
        
        <!-- Sending Stats Chart -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-xl font-semibold mb-4">å‘é€è¶‹åŠ¿ï¼ˆæœ€è¿‘7å¤©ï¼‰</h3>
            <div class="h-64">
                @if(sendingStatsData()) {
                    <app-analytics-charts [chartType]="'line'" [data]="sendingStatsData" [title]="'å‘é€è¶‹åŠ¿'"></app-analytics-charts>
                } @else {
                    <p class="text-center text-slate-500 py-16">åŠ è½½ä¸­...</p>
                }
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Queue Length History -->
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4">é˜Ÿåˆ—é•¿åº¦å†å²</h3>
                <div class="h-64">
                    @if(queueLengthHistoryData()) {
                        <app-analytics-charts [chartType]="'line'" [data]="queueLengthHistoryData" [title]="'é˜Ÿåˆ—é•¿åº¦'"></app-analytics-charts>
                    } @else {
                        <p class="text-center text-slate-500 py-16">åŠ è½½ä¸­...</p>
                    }
                </div>
            </div>
            
            <!-- Account Comparison -->
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4">è´¦æˆ·å‘é€å¯¹æ¯”</h3>
                <div class="h-64">
                    @if(accountComparisonData()) {
                        <app-analytics-charts [chartType]="'bar'" [data]="accountComparisonData" [title]="'è´¦æˆ·å¯¹æ¯”'"></app-analytics-charts>
                    } @else {
                        <p class="text-center text-slate-500 py-16">åŠ è½½ä¸­...</p>
                    }
                </div>
            </div>
        </div>
        
        <!-- Campaign Performance -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-xl font-semibold mb-4">æ´»åŠ¨æ•ˆæœå¯¹æ¯”</h3>
            <div class="h-64">
                @if(campaignPerformanceData()) {
                    <app-analytics-charts [chartType]="'bar'" [data]="campaignPerformanceData" [title]="'æ´»åŠ¨æ•ˆæœ'"></app-analytics-charts>
                } @else {
                    <p class="text-center text-slate-500 py-16">åŠ è½½ä¸­...</p>
                }
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-2">{{ t('leadsOverTime') }}</h3><p class="text-sm text-slate-500 dark:text-slate-400 mb-6">{{ t('last7Days') }}</p>
                <div class="flex justify-between items-end h-64 space-x-2">
                    @for(day of analyticsData().leadsByDay; track day.date) {
                        <div class="flex flex-col items-center flex-1"><div class="w-full bg-cyan-500 rounded-t-md" [style.height.%]="(day.count / analyticsData().maxLeadsInPeriod) * 100"></div><span class="text-xs mt-2 text-slate-500 dark:text-slate-400">{{ day.date.toLocaleDateString(undefined, {weekday: 'short'}) }}</span></div>
                    }
                </div>
            </div>
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-2">{{ t('conversionFunnel') }}</h3>
                <div class="space-y-3 mt-6">
                    @let funnel = analyticsData().funnel;
                    @let total = funnel.new || 1;
                    <!-- æ–°å®¢æˆ¶ -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-blue-400">æ–°å®¢æˆ¶</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-blue-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" style="width: 100%">{{funnel.new || 0}}</div></div></div>
                    <!-- å·²è¯ç¹« -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-cyan-400">å·²è¯ç¹«</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-cyan-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.contacted || 0) / total) * 100">{{funnel.contacted || 0}}</div></div></div>
                    <!-- å·²å›å¾© -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-green-400">å·²å›å¾©</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-green-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.replied || 0) / total) * 100">{{funnel.replied || 0}}</div></div></div>
                    <!-- æœ‰èˆˆè¶£ -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-yellow-400">æœ‰èˆˆè¶£</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-yellow-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.interested || 0) / total) * 100">{{funnel.interested || 0}}</div></div></div>
                    <!-- æ´½è«‡ä¸­ -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-orange-400">æ´½è«‡ä¸­</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-orange-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.negotiating || 0) / total) * 100">{{funnel.negotiating || 0}}</div></div></div>
                    <!-- éœ€è·Ÿé€² -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-purple-400">éœ€è·Ÿé€²</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-purple-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.follow_up || 0) / total) * 100">{{funnel.follow_up || 0}}</div></div></div>
                    <!-- å·²æˆäº¤ -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-emerald-400">å·²æˆäº¤</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-emerald-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.converted || 0) / total) * 100">{{funnel.converted || 0}}</div></div></div>
                    <!-- å·²æµå¤± -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-red-400">å·²æµå¤±</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-red-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.churned || 0) / total) * 100">{{funnel.churned || 0}}</div></div></div>
                </div>
            </div>
            <div class="lg:col-span-3 bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-2">{{ t('campaignPerformance') }}</h3>
                <table class="w-full text-left mt-4">
                    <thead class="text-slate-600 dark:text-slate-300 uppercase text-sm"><tr><th class="py-2 px-4">{{ t('campaign') }}</th><th class="py-2 px-4">{{ t('status') }}</th><th class="py-2 px-4">{{ t('leads') }}</th><th class="py-2 px-4">{{ t('contacted') }}</th><th class="py-2 px-4">{{ t('replied') }}</th><th class="py-2 px-4">{{ t('replyRate') }}</th></tr></thead>
                    <tbody>
                        @for(stat of campaignPerformance(); track stat.id) {
                            <tr class="border-b border-slate-200 dark:border-slate-800">
                                <td class="py-3 px-4 font-semibold">{{ stat.name }}</td>
                                <td class="py-3 px-4"><span class="px-2.5 py-1 text-xs font-semibold rounded-full" [class.bg-green-500/10]="stat.isActive" [class.text-green-400]="stat.isActive" [class.bg-slate-500/10]="!stat.isActive" [class.text-slate-400]="!stat.isActive">{{ stat.isActive ? t('active') : t('inactive')}}</span></td>
                                <td class="py-3 px-4">{{ stat.leads }}</td>
                                <td class="py-3 px-4">{{ stat.contacted }}</td>
                                <td class="py-3 px-4">{{ stat.replied }}</td>
                                <td class="py-3 px-4">{{ stat.replyRate.toFixed(1) }}%</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
      }
      @case ('logs') {
        <h2 class="text-4xl font-bold mb-8 text-slate-900 dark:text-white">{{ t('actionLogs') }}</h2>
        
        <!-- Filter Section -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-6">
            <h3 class="text-lg font-semibold mb-4">è¿‡æ»¤å’Œæœç´¢</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Type Filter -->
                <div>
                    <label class="block text-sm font-medium mb-2">æ—¥å¿—çº§åˆ«</label>
                    <select [(ngModel)]="logFilterType" class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                        <option value="">å…¨éƒ¨</option>
                        <option value="info">ä¿¡æ¯</option>
                        <option value="success">æˆåŠŸ</option>
                        <option value="warning">è­¦å‘Š</option>
                        <option value="error">é”™è¯¯</option>
                    </select>
                </div>
                
                <!-- Start Date -->
                <div>
                    <label class="block text-sm font-medium mb-2">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" [(ngModel)]="logFilterStartDate" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                </div>
                
                <!-- End Date -->
                <div>
                    <label class="block text-sm font-medium mb-2">ç»“æŸæ—¥æœŸ</label>
                    <input type="date" [(ngModel)]="logFilterEndDate" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                </div>
                
                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium mb-2">æœç´¢å…³é”®è¯</label>
                    <input type="text" [ngModel]="logFilterSearch()" (ngModelChange)="logFilterSearch.set($event); onLogFilterChange()" placeholder="æœç´¢æ—¥å¿—å†…å®¹..." class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                </div>
            </div>
            
            <div class="flex gap-3 mt-4">
                <button (click)="applyLogFilter()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg text-sm shadow-lg shadow-cyan-500/20">åº”ç”¨è¿‡æ»¤</button>
                <button (click)="resetLogFilter()" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg text-sm">é‡ç½®</button>
                <button (click)="exportLogs()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg text-sm shadow-lg shadow-green-500/20">å¯¼å‡º Excel</button>
                <button (click)="clearLogs()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg text-sm shadow-lg shadow-red-500/20 ml-auto">{{ t('clearLogs') }}</button>
            </div>
        </div>
        
        <!-- Logs Display -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
            <div class="mb-4 text-sm text-slate-500 dark:text-slate-400">
                æ˜¾ç¤º {{ filteredLogs().length }} æ¡æ—¥å¿—
            </div>
            <div class="space-y-3 font-mono text-sm h-[calc(100vh-450px)] overflow-y-auto bg-slate-200/20 dark:bg-slate-800/20 p-4 rounded-lg">
                @for(log of filteredLogs(); track log.id) {
                    <div class="flex items-start">
                        <span class="text-slate-500 dark:text-slate-400 mr-4 min-w-[80px]">{{ log.timestamp.toLocaleString() }}</span>
                        <span [class]="getLogColor(log.type)" class="font-bold mr-2 w-16 text-right">{{ log.type.toUpperCase() }}</span>
                        <span class="flex-1 text-slate-700 dark:text-slate-300">{{ log.message }}</span>
                    </div>
                }
                @if(filteredLogs().length === 0) { 
                    <p class="text-center text-slate-500 py-8">{{ t('noRecentActivity') }}</p> 
                }
            </div>
        </div>
      }
      @case ('performance') {
        <app-performance-monitor></app-performance-monitor>
      }
      @case('settings') {
          <h2 class="text-4xl font-bold mb-8 text-slate-900 dark:text-white">{{ t('settingsTitle') }}</h2>
          
          <!-- Application Settings -->
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
              <h3 class="text-xl mb-4 font-semibold">åº”ç”¨è®¾ç½®</h3>
              
              <div class="space-y-4">
                  <div>
                      <label class="flex items-center gap-3 cursor-pointer">
                          <input type="checkbox" [ngModel]="spintaxEnabled()" (ngModelChange)="spintaxEnabled.set($event); saveSettings()" class="form-checkbox bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded text-cyan-500 h-5 w-5">
                          <span class="text-slate-700 dark:text-slate-300">{{ t('enableSpintax') }}</span>
                      </label>
                      <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 ml-8">{{ t('spintaxHint') }}</p>
                  </div>
                  
                  <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
                      <label class="flex items-center gap-3 cursor-pointer">
                          <input type="checkbox" [ngModel]="smartSendingEnabled()" (ngModelChange)="smartSendingEnabled.set($event); saveSettings()" class="form-checkbox bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded text-cyan-500 h-5 w-5">
                          <span class="text-slate-700 dark:text-slate-300">{{ t('enableSmartSending') }}</span>
                      </label>
                      <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 ml-8">{{ t('smartSendingHint') }}</p>
                  </div>
                  
                  <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
                      <label class="flex items-center gap-3 cursor-pointer">
                          <input type="checkbox" [ngModel]="autoReplyEnabled()" (ngModelChange)="autoReplyEnabled.set($event); saveSettings()" class="form-checkbox bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded text-cyan-500 h-5 w-5">
                          <span class="text-slate-700 dark:text-slate-300">{{ t('enableAutoReply') }}</span>
                      </label>
                      <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 ml-8">{{ t('autoReplyHint') }}</p>
                      <div class="mt-2 space-y-2">
                          <textarea 
                              [ngModel]="autoReplyMessage()" 
                              (ngModelChange)="autoReplyMessage.set($event)"
                              rows="3" 
                              class="form-textarea w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-3 text-sm resize-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 transition-all" 
                              [placeholder]="t('autoReplyMessage')">
                          </textarea>
                          <div class="flex items-center justify-between">
                              <p class="text-xs text-slate-500">{{ t('autoReplyEditHint') }}</p>
                              <button 
                                  (click)="saveSettings(); showSettingsSavedToast()"
                                  class="bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-medium py-1.5 px-4 rounded-lg transition-all duration-200 shadow-md shadow-cyan-500/20 hover:shadow-lg hover:shadow-cyan-500/30 flex items-center gap-2">
                                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                  {{ t('saveAutoReply') }}
                              </button>
                          </div>
                      </div>
                  </div>
                  
                  <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
                      <button (click)="saveSettings(); showSettingsSavedToast()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20 flex items-center gap-2">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                          {{ t('saveSettings') }}
                      </button>
                      <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">{{ t('settingsAutoSaveHint') }}</p>
                  </div>
              </div>
          </div>

          <!-- Message Templates (A/B Testing) -->
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
              <h3 class="text-xl mb-4 font-semibold flex items-center gap-2">
                  <span class="text-2xl">âœ¨</span> {{ t('aiConfiguration') }}
              </h3>
              <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">{{ t('aiConfigurationHint') }}</p>
              
              <div class="space-y-4">
                  <!-- API Type Selection -->
                  <div>
                      <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">{{ t('aiProvider') }}</label>
                      <div class="flex flex-wrap gap-4">
                          <label class="flex items-center gap-2 cursor-pointer">
                              <input type="radio" name="aiType" [checked]="aiApiType() === 'gemini'" (change)="aiApiType.set('gemini')" class="form-radio text-cyan-500">
                              <span class="text-sm">Google Gemini</span>
                          </label>
                          <label class="flex items-center gap-2 cursor-pointer">
                              <input type="radio" name="aiType" [checked]="aiApiType() === 'openai'" (change)="aiApiType.set('openai')" class="form-radio text-cyan-500">
                              <span class="text-sm">OpenAI</span>
                          </label>
                          <label class="flex items-center gap-2 cursor-pointer">
                              <input type="radio" name="aiType" [checked]="aiApiType() === 'custom'" (change)="aiApiType.set('custom')" class="form-radio text-cyan-500">
                              <span class="text-sm">{{ t('customApi') }}</span>
                          </label>
                          <label class="flex items-center gap-2 cursor-pointer">
                              <input type="radio" name="aiType" [checked]="aiApiType() === 'local'" (change)="aiApiType.set('local')" class="form-radio text-cyan-500">
                              <span class="text-sm bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent font-semibold">ğŸ  {{ t('localAi') }}</span>
                          </label>
                      </div>
                  </div>

                  <!-- API Key Input -->
                  <div>
                      <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">
                          {{ aiApiType() === 'gemini' ? 'Gemini API Key' : aiApiType() === 'openai' ? 'OpenAI API Key' : t('customApiKey') }}
                      </label>
                      <div class="relative">
                          <input 
                              [type]="showApiKey() ? 'text' : 'password'"
                              [ngModel]="aiApiKey()" 
                              (ngModelChange)="aiApiKey.set($event)"
                              class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 pr-20 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 font-mono text-sm"
                              [placeholder]="aiApiType() === 'gemini' ? 'AIza...' : aiApiType() === 'openai' ? 'sk-...' : 'Enter API Key'">
                          <button 
                              type="button"
                              (click)="showApiKey.set(!showApiKey())"
                              class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-300 p-1">
                              @if(showApiKey()) {
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>
                              } @else {
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                              }
                          </button>
                      </div>
                      <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                          @if(aiApiType() === 'gemini') {
                              {{ t('geminiKeyHint') }} <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-cyan-400 hover:underline">Google AI Studio</a>
                          } @else if(aiApiType() === 'openai') {
                              {{ t('openaiKeyHint') }} <a href="https://platform.openai.com/api-keys" target="_blank" class="text-cyan-400 hover:underline">OpenAI Platform</a>
                          } @else {
                              {{ t('customApiHint') }}
                          }
                      </p>
                  </div>

                  <!-- Custom API Endpoint (for custom type) -->
                  @if(aiApiType() === 'custom') {
                      <div>
                          <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('customApiEndpoint') }}</label>
                          <input 
                              [ngModel]="customApiEndpoint()" 
                              (ngModelChange)="customApiEndpoint.set($event)"
                              class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 font-mono text-sm"
                              placeholder="https://api.example.com/v1/chat/completions">
                      </div>
                  }

                  <!-- Local AI Configuration -->
                  @if(aiApiType() === 'local') {
                      <div class="space-y-4 p-4 bg-gradient-to-r from-purple-500/10 to-pink-500/10 rounded-lg border border-purple-500/20">
                          <h4 class="text-sm font-semibold text-purple-400 flex items-center gap-2">
                              <span>ğŸ </span> {{ t('localAiConfiguration') }}
                          </h4>
                          <p class="text-xs text-slate-400">{{ t('localAiHint') }}</p>
                          
                          <div>
                              <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('localAiEndpoint') }}</label>
                              <input 
                                  [ngModel]="localAiEndpoint()" 
                                  (ngModelChange)="localAiEndpoint.set($event)"
                                  class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm"
                                  placeholder="https://your-server.com:3002">
                              <p class="text-xs text-slate-500 mt-1">{{ t('remoteEndpointHint') }}</p>
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('localAiModel') }}</label>
                              <input 
                                  [ngModel]="localAiModel()" 
                                  (ngModelChange)="localAiModel.set($event)"
                                  class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm"
                                  [placeholder]="t('localAiModelPlaceholder')">
                          </div>

                          <!-- Test Local AI -->
                          <div class="flex items-center gap-2">
                              <button 
                                  (click)="testLocalAiConnection()"
                                  [disabled]="!localAiEndpoint() || isTestingLocalAi()"
                                  class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                  @if(isTestingLocalAi()) {
                                      <span class="animate-spin">âŸ³</span> {{ t('testing') }}
                                  } @else {
                                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                      {{ t('testLocalAi') }}
                                  }
                              </button>
                              @if(localAiStatus() === 'success') {
                                  <span class="text-green-400 text-sm">âœ“ {{ t('localAiSuccess') }}</span>
                              } @else if(localAiStatus() === 'error') {
                                  <span class="text-red-400 text-sm">âœ— {{ localAiError() }}</span>
                              }
                          </div>
                      </div>
                  }

                  <!-- Test Connection & Save (for non-local types) -->
                  @if(aiApiType() !== 'local') {
                      <div class="flex items-center gap-4 pt-2">
                          <button 
                              (click)="testAiConnection()"
                              [disabled]="!aiApiKey() || isTestingAi()"
                              class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                              @if(isTestingAi()) {
                                  <span class="animate-spin">âŸ³</span> {{ t('testing') }}
                              } @else {
                                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                  {{ t('testConnection') }}
                              }
                          </button>
                          <button 
                              (click)="saveAiSettings()"
                              [disabled]="!aiApiKey()"
                              class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20 disabled:bg-slate-400 disabled:shadow-none disabled:cursor-not-allowed flex items-center gap-2">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                              {{ t('saveApiKey') }}
                          </button>
                      </div>
                  }

                  <!-- Save Button for Local AI -->
                  @if(aiApiType() === 'local') {
                      <div class="flex items-center gap-4 pt-2">
                          <button 
                              (click)="saveAiSettings()"
                              [disabled]="!localAiEndpoint()"
                              class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg shadow-purple-500/20 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                              {{ t('saveLocalSettings') }}
                          </button>
                      </div>
                  }

                  <!-- Connection Status -->
                  @if(aiConnectionStatus()) {
                      <div class="p-3 rounded-lg text-sm" 
                           [class.bg-green-500/10]="aiConnectionStatus() === 'success'"
                           [class.border-green-500/20]="aiConnectionStatus() === 'success'"
                           [class.text-green-400]="aiConnectionStatus() === 'success'"
                           [class.bg-red-500/10]="aiConnectionStatus() === 'error'"
                           [class.border-red-500/20]="aiConnectionStatus() === 'error'"
                           [class.text-red-400]="aiConnectionStatus() === 'error'">
                          @if(aiConnectionStatus() === 'success') {
                              âœ“ {{ t('aiConnectionSuccess') }}
                          } @else {
                              âœ— {{ t('aiConnectionFailed') }}: {{ aiConnectionError() }}
                          }
                      </div>
                  }
              </div>
          </div>

          <!-- Voice Services Configuration (TTS/STT) -->
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
              <h3 class="text-xl mb-4 font-semibold flex items-center gap-2">
                  <span class="text-2xl">ğŸ™ï¸</span> {{ t('voiceServices') }}
              </h3>
              <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">{{ t('voiceServicesHint') }}</p>
              
              <div class="space-y-6">
                  <!-- TTS (Text-to-Speech) Configuration -->
                  <div class="p-4 bg-gradient-to-r from-blue-500/10 to-cyan-500/10 rounded-lg border border-blue-500/20">
                      <div class="flex items-center justify-between mb-4">
                          <h4 class="text-sm font-semibold text-blue-400 flex items-center gap-2">
                              <span>ğŸ”Š</span> {{ t('ttsService') }}
                          </h4>
                          <label class="flex items-center gap-2 cursor-pointer">
                              <input type="checkbox" [checked]="ttsEnabled()" (change)="ttsEnabled.set(!ttsEnabled())" class="form-checkbox text-blue-500 rounded">
                              <span class="text-sm text-slate-400">{{ t('ttsEnabled') }}</span>
                          </label>
                      </div>
                      
                      <div class="space-y-3">
                          <div>
                              <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('ttsEndpoint') }}</label>
                              <input 
                                  [ngModel]="ttsEndpoint()" 
                                  (ngModelChange)="ttsEndpoint.set($event)"
                                  class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                  placeholder="https://your-server.com:9881">
                              <p class="text-xs text-slate-500 mt-1">{{ t('remoteEndpointHint') }} (GPT-SoVITS ç«¯å£: 9881)</p>
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('ttsVoice') }}</label>
                              @if(clonedVoices().length > 0) {
                                  <select 
                                      [ngModel]="selectedClonedVoice()"
                                      (ngModelChange)="selectClonedVoice($event)"
                                      class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                      <option value="">-- é¸æ“‡å…‹éš†çš„è²éŸ³ --</option>
                                      @for(voice of clonedVoices(); track voice.id) {
                                          <option [value]="voice.id">{{ voice.name }}</option>
                                      }
                                  </select>
                              } @else {
                                  <input 
                                      [ngModel]="ttsVoice()" 
                                      (ngModelChange)="ttsVoice.set($event)"
                                      class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                      [placeholder]="t('ttsVoicePlaceholder')">
                              }
                          </div>

                          <div class="flex items-center gap-2">
                              <button 
                                  (click)="testTtsConnection()"
                                  [disabled]="!ttsEndpoint() || isTestingTts()"
                                  class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                  @if(isTestingTts()) {
                                      <span class="animate-spin">âŸ³</span> {{ t('testing') }}
                                  } @else {
                                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                      {{ t('testTts') }}
                                  }
                              </button>
                              @if(ttsStatus() === 'success') {
                                  <span class="text-green-400 text-sm">âœ“ {{ t('ttsSuccess') }}</span>
                              } @else if(ttsStatus() === 'error') {
                                  <span class="text-red-400 text-sm">âœ— {{ ttsError() }}</span>
                              }
                          </div>
                      </div>
                  </div>
                  
                  <!-- Voice Clone Section -->
                  <div class="p-4 bg-gradient-to-r from-purple-500/10 to-pink-500/10 rounded-lg border border-purple-500/20">
                      <h4 class="text-sm font-semibold text-purple-400 flex items-center gap-2 mb-3">
                          <span>ğŸ­</span> {{ t('voiceClone') }}
                      </h4>
                      <p class="text-xs text-slate-400 mb-4">{{ t('voiceCloneHint') }}</p>
                      
                      <!-- Record or Upload Options -->
                      <div class="grid grid-cols-2 gap-3 mb-4">
                          <!-- Record Voice Button -->
                          <button 
                              (click)="openRecordingDialog()"
                              class="flex flex-col items-center justify-center p-4 border-2 border-dashed border-red-500/30 rounded-lg cursor-pointer hover:border-red-500/50 hover:bg-red-500/5 transition-colors">
                              <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center mb-2">
                                  <svg class="w-6 h-6 text-red-400" fill="currentColor" viewBox="0 0 24 24">
                                      <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                      <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                                  </svg>
                              </div>
                              <span class="text-sm font-medium text-red-400">{{ t('recordVoice') }}</span>
                              <span class="text-xs text-slate-500 mt-1">3-10 {{ t('seconds') }}</span>
                          </button>
                          
                          <!-- Upload File -->
                          <label class="flex flex-col items-center justify-center p-4 border-2 border-dashed border-purple-500/30 rounded-lg cursor-pointer hover:border-purple-500/50 hover:bg-purple-500/5 transition-colors">
                              <input type="file" class="hidden" accept=".wav,.mp3,.ogg,.flac,audio/*" (change)="uploadVoiceSample($event)">
                              @if(isUploadingVoice()) {
                                  <div class="text-center">
                                      <div class="animate-spin text-2xl mb-1">âŸ³</div>
                                      <span class="text-sm text-purple-400">{{ voiceUploadProgress() }}%</span>
                                  </div>
                              } @else {
                                  <div class="w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center mb-2">
                                      <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                      </svg>
                                  </div>
                                  <span class="text-sm font-medium text-purple-400">{{ t('orUploadFile') }}</span>
                                  <span class="text-xs text-slate-500 mt-1">WAV, MP3, OGG, FLAC</span>
                              }
                          </label>
                      </div>
                      
                      @if(voiceCloneError()) {
                          <p class="text-red-400 text-xs mb-4">{{ voiceCloneError() }}</p>
                      }
                      
                      <!-- Cloned Voices List -->
                      <div>
                          <h5 class="text-xs font-medium text-slate-400 mb-2">{{ t('clonedVoices') }}</h5>
                          @if(clonedVoices().length === 0) {
                              <p class="text-xs text-slate-500 italic">{{ t('noClonedVoices') }}</p>
                          } @else {
                              <div class="space-y-2 max-h-48 overflow-y-auto">
                                  @for(voice of clonedVoices(); track voice.id) {
                                      <div class="flex items-center justify-between p-2 bg-slate-800/50 rounded-lg group"
                                           [class.ring-2]="selectedClonedVoice() === voice.id"
                                           [class.ring-purple-500]="selectedClonedVoice() === voice.id">
                                          <div class="flex items-center gap-2">
                                              <span class="text-lg">ğŸ¤</span>
                                              <div>
                                                  <p class="text-sm font-medium text-white">{{ voice.name }}</p>
                                                  <p class="text-xs text-slate-500">{{ voice.audioPath }}</p>
                                                  @if(voice.promptText) {
                                                      <p class="text-xs text-purple-400 italic">"{{ voice.promptText }}"</p>
                                                  }
                                              </div>
                                          </div>
                                          <div class="flex items-center gap-1">
                                              <button 
                                                  (click)="previewClonedVoice(voice.id)"
                                                  class="p-1.5 text-slate-400 hover:text-blue-400 rounded transition-colors"
                                                  [title]="t('previewVoice')">
                                                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                  </svg>
                                              </button>
                                              <button 
                                                  (click)="selectClonedVoice(voice.id)"
                                                  class="p-1.5 text-slate-400 hover:text-green-400 rounded transition-colors"
                                                  [class.text-green-400]="selectedClonedVoice() === voice.id"
                                                  [title]="t('useThisVoice')">
                                                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                  </svg>
                                              </button>
                                              <button 
                                                  (click)="deleteClonedVoice(voice.id)"
                                                  class="p-1.5 text-slate-400 hover:text-red-400 rounded transition-colors"
                                                  [title]="t('deleteVoice')">
                                                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                  </svg>
                                              </button>
                                          </div>
                                      </div>
                                  }
                              </div>
                          }
                      </div>
                  </div>
                  
                  <!-- Recording Dialog Modal -->
                  @if(showRecordingDialog()) {
                      <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="closeRecordingDialog()">
                          <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6 border border-purple-500/30" (click)="$event.stopPropagation()">
                              <div class="flex items-center justify-between mb-4">
                                  <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                      <span class="text-2xl">ğŸ™ï¸</span> {{ t('recordVoice') }}
                                  </h3>
                                  <button (click)="closeRecordingDialog()" class="text-slate-400 hover:text-white">
                                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                      </svg>
                                  </button>
                              </div>
                              
                              <p class="text-sm text-slate-400 mb-4">{{ t('recordingHint') }}</p>
                              
                              <!-- Voice Name Input -->
                              <div class="mb-4">
                                  <label class="block text-sm font-medium text-slate-300 mb-1">{{ t('voiceNameLabel') }} *</label>
                                  <input 
                                      type="text"
                                      [ngModel]="voiceName()"
                                      (ngModelChange)="voiceName.set($event)"
                                      class="form-input w-full bg-slate-700/50 border-slate-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                      [placeholder]="t('voiceNamePlaceholder')">
                              </div>
                              
                              <!-- Prompt Text Input -->
                              <div class="mb-4">
                                  <label class="block text-sm font-medium text-slate-300 mb-1">{{ t('promptTextLabel') }}</label>
                                  <textarea 
                                      [ngModel]="voicePromptText()"
                                      (ngModelChange)="voicePromptText.set($event)"
                                      rows="2"
                                      class="form-textarea w-full bg-slate-700/50 border-slate-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
                                      [placeholder]="t('promptTextPlaceholder')"></textarea>
                              </div>
                              
                              <!-- Recording Area -->
                              <div class="bg-slate-900/50 rounded-xl p-6 mb-4 text-center">
                                  @if(!recordedAudioUrl()) {
                                      <!-- Recording Button -->
                                      <div class="mb-4">
                                          @if(isRecording()) {
                                              <button 
                                                  (click)="stopRecording()"
                                                  class="w-20 h-20 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center mx-auto shadow-lg shadow-red-500/30 animate-pulse">
                                                  <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                                      <rect x="6" y="6" width="12" height="12" rx="2"/>
                                                  </svg>
                                              </button>
                                          } @else {
                                              <button 
                                                  (click)="startRecording()"
                                                  class="w-20 h-20 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 flex items-center justify-center mx-auto shadow-lg shadow-purple-500/30 transition-all">
                                                  <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                                      <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                                      <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                                                  </svg>
                                              </button>
                                          }
                                      </div>
                                      
                                      <!-- Recording Time -->
                                      <div class="text-2xl font-mono text-white mb-2">
                                          {{ recordingTime() }} {{ t('seconds') }}
                                      </div>
                                      
                                      <!-- Time Indicator -->
                                      <div class="flex items-center justify-center gap-2">
                                          @if(isRecording()) {
                                              <span class="text-red-400 animate-pulse">â— {{ t('recording') }}</span>
                                          } @else {
                                              <span class="text-slate-400">{{ t('startRecording') }}</span>
                                          }
                                      </div>
                                      
                                      <!-- Progress Bar -->
                                      @if(isRecording()) {
                                          <div class="mt-4 bg-slate-700 rounded-full h-2 overflow-hidden">
                                              <div 
                                                  class="h-full transition-all duration-1000"
                                                  [class.bg-green-500]="recordingTime() >= 3 && recordingTime() <= 10"
                                                  [class.bg-yellow-500]="recordingTime() < 3"
                                                  [class.bg-red-500]="recordingTime() > 10"
                                                  [style.width.%]="(recordingTime() / 10) * 100">
                                              </div>
                                          </div>
                                          <div class="flex justify-between text-xs text-slate-500 mt-1">
                                              <span>0s</span>
                                              <span class="text-green-400">3s (æœ€çŸ­)</span>
                                              <span class="text-red-400">10s (æœ€é•·)</span>
                                          </div>
                                      }
                                  } @else {
                                      <!-- Playback Preview -->
                                      <div class="mb-4">
                                          <div class="w-20 h-20 rounded-full bg-green-500/20 flex items-center justify-center mx-auto mb-4">
                                              <svg class="w-10 h-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                              </svg>
                                          </div>
                                          <p class="text-green-400 font-medium mb-2">éŒ„éŸ³å®Œæˆï¼</p>
                                          <p class="text-slate-400 text-sm">{{ recordingTime() }} {{ t('seconds') }}</p>
                                      </div>
                                      
                                      <!-- Audio Player -->
                                      <audio [src]="recordedAudioUrl()" controls class="w-full mb-4"></audio>
                                  }
                              </div>
                              
                              <!-- Error Message -->
                              @if(voiceCloneError()) {
                                  <p class="text-red-400 text-sm mb-4">{{ voiceCloneError() }}</p>
                              }
                              
                              <!-- Action Buttons -->
                              <div class="flex gap-3">
                                  @if(recordedAudioUrl()) {
                                      <button 
                                          (click)="resetRecording()"
                                          class="flex-1 bg-slate-600 hover:bg-slate-500 text-white font-medium py-2.5 px-4 rounded-lg transition-colors">
                                          {{ t('reRecord') }}
                                      </button>
                                      <button 
                                          (click)="confirmAndUploadRecording()"
                                          [disabled]="isUploadingVoice() || !voiceName()"
                                          class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-2.5 px-4 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                          @if(isUploadingVoice()) {
                                              <span class="animate-spin">âŸ³</span> {{ voiceUploadProgress() }}%
                                          } @else {
                                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                              </svg>
                                              {{ t('confirmUpload') }}
                                          }
                                      </button>
                                  } @else {
                                      <button 
                                          (click)="closeRecordingDialog()"
                                          class="flex-1 bg-slate-600 hover:bg-slate-500 text-white font-medium py-2.5 px-4 rounded-lg transition-colors">
                                          {{ t('cancel') }}
                                      </button>
                                  }
                              </div>
                          </div>
                      </div>
                  }

                  <!-- STT (Speech-to-Text) Configuration -->
                  <div class="p-4 bg-gradient-to-r from-green-500/10 to-emerald-500/10 rounded-lg border border-green-500/20">
                      <div class="flex items-center justify-between mb-4">
                          <h4 class="text-sm font-semibold text-green-400 flex items-center gap-2">
                              <span>ğŸ¤</span> {{ t('sttService') }}
                          </h4>
                          <label class="flex items-center gap-2 cursor-pointer">
                              <input type="checkbox" [checked]="sttEnabled()" (change)="sttEnabled.set(!sttEnabled())" class="form-checkbox text-green-500 rounded">
                              <span class="text-sm text-slate-400">{{ t('sttEnabled') }}</span>
                          </label>
                      </div>
                      
                      <div class="space-y-3">
                          <div>
                              <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('sttEndpoint') }}</label>
                              <input 
                                  [ngModel]="sttEndpoint()" 
                                  (ngModelChange)="sttEndpoint.set($event)"
                                  class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500 font-mono text-sm"
                                  placeholder="https://your-server.com:9000">
                              <p class="text-xs text-slate-500 mt-1">{{ t('remoteEndpointHint') }} (Whisper API ç«¯å£: 9000)</p>
                          </div>

                          <div class="flex items-center gap-2">
                              <button 
                                  (click)="testSttConnection()"
                                  [disabled]="!sttEndpoint() || isTestingStt()"
                                  class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                  @if(isTestingStt()) {
                                      <span class="animate-spin">âŸ³</span> {{ t('testing') }}
                                  } @else {
                                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                      {{ t('testStt') }}
                                  }
                              </button>
                              @if(sttStatus() === 'success') {
                                  <span class="text-green-400 text-sm">âœ“ {{ t('sttSuccess') }}</span>
                              } @else if(sttStatus() === 'error') {
                                  <span class="text-red-400 text-sm">âœ— {{ sttError() }}</span>
                              }
                          </div>
                      </div>
                  </div>

                  <!-- Save Voice Settings -->
                  <div class="flex items-center gap-4 pt-2">
                      <button 
                          (click)="saveAiSettings()"
                          class="bg-gradient-to-r from-blue-500 to-green-500 hover:from-blue-600 hover:to-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg shadow-blue-500/20 flex items-center gap-2">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                          {{ t('saveLocalSettings') }}
                      </button>
                  </div>
              </div>
          </div>

          <!-- AI Auto Chat Configuration -->
          <div id="ai-settings-section" class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg transition-all duration-300">
              <h3 class="text-xl mb-4 font-semibold flex items-center gap-2">
                  <span class="text-2xl">ğŸ¤–</span> {{ t('aiAutoChat') }}
                  <span class="ml-2 px-2 py-0.5 text-xs bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-full">{{ t('unlimitedContext') }}</span>
              </h3>
              <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">{{ t('aiAutoChatHint') }}</p>
              
              <div class="space-y-6">
                  <!-- Enable Auto Chat Toggle -->
                  <div class="flex items-center justify-between p-4 bg-gradient-to-r from-cyan-500/10 to-purple-500/10 rounded-lg border border-cyan-500/20">
                      <div>
                          <h4 class="text-sm font-semibold text-cyan-400">{{ t('enableAutoChat') }}</h4>
                          <p class="text-xs text-slate-400 mt-1">{{ t('aiAutoChatHint') }}</p>
                      </div>
                      <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" [checked]="aiAutoChatEnabled()" (change)="toggleAiAutoChat()" class="sr-only peer">
                          <div class="w-14 h-7 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-cyan-500 peer-checked:to-purple-500"></div>
                      </label>
                  </div>

                  <!-- Auto Chat Mode Selection -->
                  <div>
                      <label class="block text-sm font-medium text-slate-400 mb-3">{{ t('autoChatMode') }}</label>
                      <div class="grid grid-cols-2 gap-3">
                          <!-- Full Auto -->
                          <div 
                              (click)="aiAutoChatMode.set('full')"
                              class="p-3 rounded-lg border cursor-pointer transition-all"
                              [class.border-cyan-500]="aiAutoChatMode() === 'full'"
                              [class.bg-cyan-500/10]="aiAutoChatMode() === 'full'"
                              [class.border-slate-600]="aiAutoChatMode() !== 'full'"
                              [class.hover:border-slate-500]="aiAutoChatMode() !== 'full'">
                              <div class="flex items-center gap-2 mb-1">
                                  <span class="text-lg">ğŸš€</span>
                                  <span class="font-medium text-sm" [class.text-cyan-400]="aiAutoChatMode() === 'full'">{{ t('modeFullAuto') }}</span>
                              </div>
                              <p class="text-xs text-slate-500">{{ t('modeFullAutoDesc') }}</p>
                          </div>
                          
                          <!-- Semi Auto -->
                          <div 
                              (click)="aiAutoChatMode.set('semi')"
                              class="p-3 rounded-lg border cursor-pointer transition-all"
                              [class.border-green-500]="aiAutoChatMode() === 'semi'"
                              [class.bg-green-500/10]="aiAutoChatMode() === 'semi'"
                              [class.border-slate-600]="aiAutoChatMode() !== 'semi'"
                              [class.hover:border-slate-500]="aiAutoChatMode() !== 'semi'">
                              <div class="flex items-center gap-2 mb-1">
                                  <span class="text-lg">ğŸ‘¤</span>
                                  <span class="font-medium text-sm" [class.text-green-400]="aiAutoChatMode() === 'semi'">{{ t('modeSemiAuto') }}</span>
                              </div>
                              <p class="text-xs text-slate-500">{{ t('modeSemiAutoDesc') }}</p>
                          </div>
                          
                          <!-- Assist -->
                          <div 
                              (click)="aiAutoChatMode.set('assist')"
                              class="p-3 rounded-lg border cursor-pointer transition-all"
                              [class.border-purple-500]="aiAutoChatMode() === 'assist'"
                              [class.bg-purple-500/10]="aiAutoChatMode() === 'assist'"
                              [class.border-slate-600]="aiAutoChatMode() !== 'assist'"
                              [class.hover:border-slate-500]="aiAutoChatMode() !== 'assist'">
                              <div class="flex items-center gap-2 mb-1">
                                  <span class="text-lg">âœ¨</span>
                                  <span class="font-medium text-sm" [class.text-purple-400]="aiAutoChatMode() === 'assist'">{{ t('modeAssist') }}</span>
                              </div>
                              <p class="text-xs text-slate-500">{{ t('modeAssistDesc') }}</p>
                          </div>
                          
                          <!-- Keyword Trigger -->
                          <div 
                              (click)="aiAutoChatMode.set('keyword')"
                              class="p-3 rounded-lg border cursor-pointer transition-all"
                              [class.border-amber-500]="aiAutoChatMode() === 'keyword'"
                              [class.bg-amber-500/10]="aiAutoChatMode() === 'keyword'"
                              [class.border-slate-600]="aiAutoChatMode() !== 'keyword'"
                              [class.hover:border-slate-500]="aiAutoChatMode() !== 'keyword'">
                              <div class="flex items-center gap-2 mb-1">
                                  <span class="text-lg">ğŸ¯</span>
                                  <span class="font-medium text-sm" [class.text-amber-400]="aiAutoChatMode() === 'keyword'">{{ t('modeKeyword') }}</span>
                              </div>
                              <p class="text-xs text-slate-500">{{ t('modeKeywordDesc') }}</p>
                          </div>
                      </div>
                  </div>

                  <!-- System Prompt -->
                  <div>
                      <label class="block text-sm font-medium text-slate-400 mb-1">{{ t('systemPrompt') }}</label>
                      <p class="text-xs text-slate-500 mb-2">{{ t('systemPromptHint') }}</p>
                      <textarea 
                          [ngModel]="aiSystemPrompt()"
                          (ngModelChange)="aiSystemPrompt.set($event)"
                          rows="4"
                          class="form-textarea w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 resize-none text-sm"
                          [placeholder]="t('systemPromptPlaceholder')"></textarea>
                  </div>

                  <!-- Reply Settings -->
                  <div class="grid grid-cols-2 gap-4">
                      <!-- Typing Speed -->
                      <div>
                          <label class="block text-sm font-medium text-slate-400 mb-1">{{ t('typingSpeed') }}</label>
                          <p class="text-xs text-slate-500 mb-2">{{ t('typingSpeedHint') }}</p>
                          <div class="flex items-center gap-2">
                              <input 
                                  type="range" 
                                  [ngModel]="aiTypingSpeed()" 
                                  (ngModelChange)="aiTypingSpeed.set($event)"
                                  min="20" max="200" step="10"
                                  class="flex-1">
                              <span class="text-sm text-cyan-400 font-mono w-16">{{ aiTypingSpeed() }}/min</span>
                          </div>
                      </div>
                      
                      <!-- Max Context Messages -->
                      <div>
                          <label class="block text-sm font-medium text-slate-400 mb-1">{{ t('maxContextMessages') }}</label>
                          <p class="text-xs text-slate-500 mb-2">{{ t('maxContextHint') }}</p>
                          <div class="flex items-center gap-2">
                              <input 
                                  type="range" 
                                  [ngModel]="aiMaxContextMessages()" 
                                  (ngModelChange)="aiMaxContextMessages.set($event)"
                                  min="5" max="100" step="5"
                                  class="flex-1">
                              <span class="text-sm text-cyan-400 font-mono w-12">{{ aiMaxContextMessages() }}</span>
                          </div>
                      </div>
                  </div>

                  <!-- Reply Delay -->
                  <div>
                      <label class="block text-sm font-medium text-slate-400 mb-1">{{ t('replyDelay') }}</label>
                      <p class="text-xs text-slate-500 mb-2">{{ t('replyDelayHint') }}</p>
                      <div class="flex items-center gap-4">
                          <div class="flex items-center gap-2">
                              <span class="text-xs text-slate-500">Min:</span>
                              <input 
                                  type="number" 
                                  [ngModel]="aiReplyDelay()[0]" 
                                  (ngModelChange)="aiReplyDelay.set([$event, aiReplyDelay()[1]])"
                                  min="0" max="30"
                                  class="w-16 bg-slate-700 border-slate-600 rounded px-2 py-1 text-sm text-white">
                              <span class="text-xs text-slate-500">s</span>
                          </div>
                          <div class="flex items-center gap-2">
                              <span class="text-xs text-slate-500">Max:</span>
                              <input 
                                  type="number" 
                                  [ngModel]="aiReplyDelay()[1]" 
                                  (ngModelChange)="aiReplyDelay.set([aiReplyDelay()[0], $event])"
                                  min="1" max="60"
                                  class="w-16 bg-slate-700 border-slate-600 rounded px-2 py-1 text-sm text-white">
                              <span class="text-xs text-slate-500">s</span>
                          </div>
                      </div>
                  </div>

                  <!-- Memory & Greeting -->
                  <div class="grid grid-cols-2 gap-4">
                      <!-- Enable Memory -->
                      <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
                          <div>
                              <h4 class="text-sm font-medium text-slate-300">{{ t('enableMemory') }}</h4>
                              <p class="text-xs text-slate-500">{{ t('enableMemoryHint') }}</p>
                          </div>
                          <input type="checkbox" [checked]="aiEnableMemory()" (change)="aiEnableMemory.set(!aiEnableMemory())" class="form-checkbox text-cyan-500 rounded">
                      </div>
                      
                      <!-- Auto Greeting -->
                      <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
                          <div>
                              <h4 class="text-sm font-medium text-slate-300">{{ t('autoGreeting') }}</h4>
                              <p class="text-xs text-slate-500">{{ t('autoGreetingHint') }}</p>
                          </div>
                          <input type="checkbox" [checked]="aiAutoGreeting()" (change)="toggleAiAutoGreeting()" class="form-checkbox text-cyan-500 rounded">
                      </div>
                  </div>

                  <!-- Greeting Message (if auto greeting enabled) -->
                  @if(aiAutoGreeting()) {
                      <div>
                          <label class="block text-sm font-medium text-slate-400 mb-1">{{ t('greetingMessage') }}</label>
                          <input 
                              type="text"
                              [ngModel]="aiGreetingMessage()"
                              (ngModelChange)="aiGreetingMessage.set($event)"
                              class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 text-sm"
                              [placeholder]="t('greetingPlaceholder')">
                          <p class="text-xs text-slate-500 mt-1">å¯ç”¨è®Šé‡: {{ '{' }}name{{ '}' }} æ˜µç§°, {{ '{' }}username{{ '}' }} ç”¨æˆ·å, {{ '{' }}firstName{{ '}' }} åå­—, {{ '{' }}keyword{{ '}' }} è§¦å‘è¯</p>
                      </div>
                  }

                  <!-- Save Button -->
                  <div class="flex items-center gap-4 pt-2">
                      <button 
                          (click)="saveAiChatSettings()"
                          class="bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20 flex items-center gap-2">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                          {{ t('saveLocalSettings') }}
                      </button>
                  </div>
              </div>
          </div>

          <!-- Knowledge Base Management -->
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
              <h3 class="text-xl mb-4 font-semibold flex items-center gap-2">
                  <span class="text-2xl">ğŸ“š</span> {{ t('knowledgeBase') }}
              </h3>
              <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">{{ t('knowledgeBaseHint') }}</p>
              
              <!-- Stats Cards -->
              <div class="grid grid-cols-4 gap-3 mb-6">
                  <div class="p-3 bg-blue-500/10 rounded-lg border border-blue-500/20 text-center cursor-pointer hover:bg-blue-500/20 transition-colors" (click)="switchKnowledgeTab('documents')">
                      <div class="text-2xl mb-1">ğŸ“„</div>
                      <div class="text-lg font-bold text-blue-400">{{ knowledgeStats().documents }}</div>
                      <div class="text-xs text-slate-400">{{ t('documents') }}</div>
                  </div>
                  <div class="p-3 bg-green-500/10 rounded-lg border border-green-500/20 text-center cursor-pointer hover:bg-green-500/20 transition-colors" (click)="switchKnowledgeTab('images')">
                      <div class="text-2xl mb-1">ğŸ–¼ï¸</div>
                      <div class="text-lg font-bold text-green-400">{{ knowledgeStats().images }}</div>
                      <div class="text-xs text-slate-400">{{ t('images') }}</div>
                  </div>
                  <div class="p-3 bg-purple-500/10 rounded-lg border border-purple-500/20 text-center cursor-pointer hover:bg-purple-500/20 transition-colors" (click)="switchKnowledgeTab('videos')">
                      <div class="text-2xl mb-1">ğŸ¬</div>
                      <div class="text-lg font-bold text-purple-400">{{ knowledgeStats().videos }}</div>
                      <div class="text-xs text-slate-400">{{ t('videos') }}</div>
                  </div>
                  <div class="p-3 bg-amber-500/10 rounded-lg border border-amber-500/20 text-center cursor-pointer hover:bg-amber-500/20 transition-colors" (click)="switchKnowledgeTab('qa')">
                      <div class="text-2xl mb-1">â“</div>
                      <div class="text-lg font-bold text-amber-400">{{ knowledgeStats().qa_pairs }}</div>
                      <div class="text-xs text-slate-400">{{ t('qaPairs') }}</div>
                  </div>
              </div>
              
              <!-- Tab Navigation -->
              <div class="flex gap-2 mb-4 border-b border-slate-700 pb-2">
                  <button 
                      (click)="switchKnowledgeTab('documents')"
                      class="px-4 py-2 rounded-t-lg transition-colors"
                      [class.bg-blue-500]="knowledgeTab() === 'documents'"
                      [class.text-white]="knowledgeTab() === 'documents'"
                      [class.text-slate-400]="knowledgeTab() !== 'documents'">
                      ğŸ“„ {{ t('documents') }}
                  </button>
                  <button 
                      (click)="switchKnowledgeTab('images')"
                      class="px-4 py-2 rounded-t-lg transition-colors"
                      [class.bg-green-500]="knowledgeTab() === 'images'"
                      [class.text-white]="knowledgeTab() === 'images'"
                      [class.text-slate-400]="knowledgeTab() !== 'images'">
                      ğŸ–¼ï¸ {{ t('images') }}
                  </button>
                  <button 
                      (click)="switchKnowledgeTab('videos')"
                      class="px-4 py-2 rounded-t-lg transition-colors"
                      [class.bg-purple-500]="knowledgeTab() === 'videos'"
                      [class.text-white]="knowledgeTab() === 'videos'"
                      [class.text-slate-400]="knowledgeTab() !== 'videos'">
                      ğŸ¬ {{ t('videos') }}
                  </button>
                  <button 
                      (click)="switchKnowledgeTab('qa')"
                      class="px-4 py-2 rounded-t-lg transition-colors"
                      [class.bg-amber-500]="knowledgeTab() === 'qa'"
                      [class.text-white]="knowledgeTab() === 'qa'"
                      [class.text-slate-400]="knowledgeTab() !== 'qa'">
                      â“ {{ t('qaPairs') }}
                  </button>
                  
                  <div class="flex-1"></div>
                  
                  <!-- Add Button -->
                  @switch(knowledgeTab()) {
                      @case('documents') {
                          <button (click)="showAddDocumentDialog.set(true)" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-lg flex items-center gap-1">
                              <span>+</span> {{ t('addDocument') }}
                          </button>
                      }
                      @case('images') {
                          <button (click)="openAddImageDialog()" class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-sm rounded-lg flex items-center gap-1">
                              <span>+</span> {{ t('addImage') }}
                          </button>
                      }
                      @case('videos') {
                          <button (click)="openAddVideoDialog()" class="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white text-sm rounded-lg flex items-center gap-1">
                              <span>+</span> {{ t('addVideo') }}
                          </button>
                      }
                      @case('qa') {
                          <button (click)="showAddQaDialog.set(true)" class="px-3 py-1 bg-amber-500 hover:bg-amber-600 text-white text-sm rounded-lg flex items-center gap-1">
                              <span>+</span> {{ t('addQaPair') }}
                          </button>
                      }
                  }
              </div>
              
              <!-- Tab Content -->
              <div class="min-h-[200px] max-h-[400px] overflow-y-auto">
                  @switch(knowledgeTab()) {
                      @case('documents') {
                          @if(knowledgeDocuments().length === 0) {
                              <div class="text-center py-8 text-slate-500">
                                  <div class="text-4xl mb-2">ğŸ“„</div>
                                  <p>{{ t('noDocuments') }}</p>
                              </div>
                          } @else {
                              <div class="space-y-2">
                                  @for(doc of knowledgeDocuments(); track doc.id) {
                                      <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800 transition-colors">
                                          <div class="flex items-center gap-3">
                                              <span class="text-2xl">ğŸ“„</span>
                                              <div>
                                                  <p class="font-medium text-white">{{ doc.title }}</p>
                                                  <p class="text-xs text-slate-500">{{ doc.category }} Â· {{ doc.chunk_count }} {{ t('chunks') }} Â· {{ formatFileSize(doc.file_size) }}</p>
                                              </div>
                                          </div>
                                          <button (click)="deleteDocument(doc.id)" class="p-2 text-red-400 hover:bg-red-500/20 rounded transition-colors">
                                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                          </button>
                                      </div>
                                  }
                              </div>
                          }
                      }
                      @case('images') {
                          @if(knowledgeImages().length === 0) {
                              <div class="text-center py-8 text-slate-500">
                                  <div class="text-4xl mb-2">ğŸ–¼ï¸</div>
                                  <p>{{ t('noImages') }}</p>
                              </div>
                          } @else {
                              <div class="grid grid-cols-4 gap-3">
                                  @for(img of knowledgeImages(); track img.id) {
                                      <div class="relative group rounded-lg overflow-hidden border border-slate-700">
                                          <div class="aspect-square bg-slate-800 flex items-center justify-center">
                                              <span class="text-4xl">ğŸ–¼ï¸</span>
                                          </div>
                                          <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                                              <button (click)="deleteMedia(img.id, 'image')" class="p-2 bg-red-500 rounded-full text-white">
                                                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                              </button>
                                          </div>
                                          <div class="p-2 bg-slate-900">
                                              <p class="text-xs text-white truncate">{{ img.name }}</p>
                                              <p class="text-xs text-slate-500">{{ img.dimensions }}</p>
                                          </div>
                                      </div>
                                  }
                              </div>
                          }
                      }
                      @case('videos') {
                          @if(knowledgeVideos().length === 0) {
                              <div class="text-center py-8 text-slate-500">
                                  <div class="text-4xl mb-2">ğŸ¬</div>
                                  <p>{{ t('noVideos') }}</p>
                              </div>
                          } @else {
                              <div class="grid grid-cols-3 gap-3">
                                  @for(video of knowledgeVideos(); track video.id) {
                                      <div class="relative group rounded-lg overflow-hidden border border-slate-700">
                                          <div class="aspect-video bg-slate-800 flex items-center justify-center">
                                              <span class="text-4xl">ğŸ¬</span>
                                          </div>
                                          <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                                              <button (click)="deleteMedia(video.id, 'video')" class="p-2 bg-red-500 rounded-full text-white">
                                                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                              </button>
                                          </div>
                                          <div class="p-2 bg-slate-900">
                                              <p class="text-xs text-white truncate">{{ video.name }}</p>
                                              <p class="text-xs text-slate-500">{{ video.duration ? (video.duration + 's') : '' }}</p>
                                          </div>
                                      </div>
                                  }
                              </div>
                          }
                      }
                      @case('qa') {
                          @if(knowledgeQaPairs().length === 0) {
                              <div class="text-center py-8 text-slate-500">
                                  <div class="text-4xl mb-2">â“</div>
                                  <p>{{ t('noQaPairs') }}</p>
                              </div>
                          } @else {
                              <div class="space-y-2">
                                  @for(qa of knowledgeQaPairs(); track qa.id) {
                                      <div class="p-3 bg-slate-800/50 rounded-lg">
                                          <p class="font-medium text-amber-400 mb-1">Q: {{ qa.question }}</p>
                                          <p class="text-sm text-slate-300">A: {{ qa.answer }}</p>
                                          <div class="flex items-center justify-between mt-2">
                                              <span class="text-xs text-slate-500">{{ qa.category }} Â· ä½¿ç”¨ {{ qa.usage_count }} æ¬¡</span>
                                              <button (click)="deleteQaPair(qa.id)" class="text-red-400 hover:text-red-300 text-xs">åˆªé™¤</button>
                                          </div>
                                      </div>
                                  }
                              </div>
                          }
                      }
                  }
              </div>
              
              <!-- RAG Toggle -->
              <div class="mt-4 pt-4 border-t border-slate-700">
                  <div class="flex items-center justify-between">
                      <div>
                          <h4 class="text-sm font-medium text-slate-300">{{ t('ragEnabled') }}</h4>
                          <p class="text-xs text-slate-500">{{ t('ragHint') }}</p>
                      </div>
                      <input type="checkbox" [checked]="ragEnabled()" (change)="ragEnabled.set(!ragEnabled())" class="form-checkbox text-cyan-500 rounded">
                  </div>
              </div>
          </div>

          <!-- Add Keyword Dialog -->
          @if (showAddKeywordDialog()) {
              <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="showAddKeywordDialog.set(false)">
                  <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6 border border-cyan-500/30" (click)="$event.stopPropagation()">
                      <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                          <span>ğŸ”‘</span> {{ t('addKeyword') }}
                      </h3>
                      
                      <input type="text" [(ngModel)]="newResourceKeyword" 
                             (keyup.enter)="addDiscoveryKeyword()"
                             placeholder="è¼¸å…¥æœç´¢é—œéµè©..."
                             class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white mb-4">
                      
                      <div class="flex gap-3">
                          <button (click)="showAddKeywordDialog.set(false)" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2 rounded-lg">
                              {{ t('cancel') }}
                          </button>
                          <button (click)="addDiscoveryKeyword()" class="flex-1 bg-cyan-500 hover:bg-cyan-600 text-white py-2 rounded-lg">
                              {{ t('addKnowledge') }}
                          </button>
                      </div>
                  </div>
              </div>
          }

          <!-- Telegram RAG Auto-Learning System -->
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
              <h3 class="text-xl mb-4 font-semibold flex items-center gap-2">
                  <span class="text-2xl">ğŸ¤–</span> {{ t('telegramRagTitle') }}
              </h3>
              <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">{{ t('telegramRagHint') }}</p>
              
              <!-- RAG Stats Cards -->
              <div class="grid grid-cols-4 gap-3 mb-6">
                  <div class="p-3 bg-cyan-500/10 rounded-lg border border-cyan-500/20 text-center">
                      <div class="text-2xl mb-1">ğŸ’¡</div>
                      <div class="text-lg font-bold text-cyan-400">{{ ragStats().total_knowledge }}</div>
                      <div class="text-xs text-slate-400">{{ t('totalKnowledge') }}</div>
                  </div>
                  <div class="p-3 bg-green-500/10 rounded-lg border border-green-500/20 text-center">
                      <div class="text-2xl mb-1">â“</div>
                      <div class="text-lg font-bold text-green-400">{{ ragStats().qa_count }}</div>
                      <div class="text-xs text-slate-400">{{ t('qaLearned') }}</div>
                  </div>
                  <div class="p-3 bg-purple-500/10 rounded-lg border border-purple-500/20 text-center">
                      <div class="text-2xl mb-1">ğŸ’¬</div>
                      <div class="text-lg font-bold text-purple-400">{{ ragStats().scripts_count }}</div>
                      <div class="text-xs text-slate-400">{{ t('scriptsLearned') }}</div>
                  </div>
                  <div class="p-3 bg-amber-500/10 rounded-lg border border-amber-500/20 text-center">
                      <div class="text-2xl mb-1">ğŸ“Š</div>
                      <div class="text-lg font-bold text-amber-400">{{ ragStats().total_uses }}</div>
                      <div class="text-xs text-slate-400">{{ t('totalUses') }}</div>
                  </div>
              </div>
              
              <!-- System Status -->
              <div class="flex items-center gap-4 mb-4 p-3 bg-slate-800/50 rounded-lg">
                  <div class="flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full" [class.bg-green-500]="ragSystemInitialized()" [class.bg-red-500]="!ragSystemInitialized()"></span>
                      <span class="text-sm text-slate-300">{{ ragSystemInitialized() ? t('ragSystemOnline') : t('ragSystemOffline') }}</span>
                  </div>
                  <div class="flex items-center gap-2">
                      <span class="text-xs text-slate-500">{{ t('vectorDb') }}:</span>
                      <span class="text-xs" [class.text-green-400]="ragStats().chromadb_enabled" [class.text-slate-400]="!ragStats().chromadb_enabled">
                          {{ ragStats().chromadb_enabled ? 'ChromaDB' : 'SQLite' }}
                      </span>
                  </div>
                  <div class="flex items-center gap-2">
                      <span class="text-xs text-slate-500">{{ t('embedding') }}:</span>
                      <span class="text-xs" [class.text-green-400]="ragStats().neural_embedding" [class.text-slate-400]="!ragStats().neural_embedding">
                          {{ ragStats().neural_embedding ? 'Neural' : 'Simple' }}
                      </span>
                  </div>
              </div>

              <!-- Action Buttons -->
              <div class="flex flex-wrap gap-3 mb-4">
                  <button 
                      (click)="initRagSystem()" 
                      [disabled]="isInitializingRag()"
                      class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 disabled:bg-cyan-500/50 text-white text-sm rounded-lg flex items-center gap-2 transition-colors">
                      @if(isInitializingRag()) {
                          <svg class="animate-spin w-4 h-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                      } @else {
                          <span>ğŸš€</span>
                      }
                      {{ t('initRagSystem') }}
                  </button>
                  
                  <button 
                      (click)="triggerRagLearning()" 
                      [disabled]="isRagLearning()"
                      class="px-4 py-2 bg-green-500 hover:bg-green-600 disabled:bg-green-500/50 text-white text-sm rounded-lg flex items-center gap-2 transition-colors">
                      @if(isRagLearning()) {
                          <svg class="animate-spin w-4 h-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                      } @else {
                          <span>ğŸ“</span>
                      }
                      {{ t('learnFromChats') }}
                  </button>
                  
                  <button 
                      (click)="reindexHighValueConversations()" 
                      [disabled]="isReindexing()"
                      class="px-4 py-2 bg-purple-500 hover:bg-purple-600 disabled:bg-purple-500/50 text-white text-sm rounded-lg flex items-center gap-2 transition-colors">
                      @if(isReindexing()) {
                          <svg class="animate-spin w-4 h-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                      } @else {
                          <span>ğŸ”„</span>
                      }
                      {{ t('reindexHighValue') }}
                  </button>
                  
                  <button 
                      (click)="cleanupRagKnowledge()" 
                      [disabled]="isCleaningRag()"
                      class="px-4 py-2 bg-amber-500 hover:bg-amber-600 disabled:bg-amber-500/50 text-white text-sm rounded-lg flex items-center gap-2 transition-colors">
                      @if(isCleaningRag()) {
                          <svg class="animate-spin w-4 h-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                      } @else {
                          <span>ğŸ§¹</span>
                      }
                      {{ t('cleanupRag') }}
                  </button>
                  
                  <button 
                      (click)="refreshRagStats()" 
                      class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white text-sm rounded-lg flex items-center gap-2 transition-colors">
                      <span>ğŸ“Š</span> {{ t('refreshStats') }}
                  </button>
              </div>
              
              <!-- Search RAG Knowledge -->
              <div class="mb-4">
                  <div class="flex gap-2">
                      <input 
                          type="text" 
                          [(ngModel)]="ragSearchQuery" 
                          (keyup.enter)="searchRagKnowledge()"
                          class="flex-1 form-input bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white text-sm" 
                          [placeholder]="t('searchRagPlaceholder')">
                      <button 
                          (click)="searchRagKnowledge()"
                          [disabled]="isSearchingRag()"
                          class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white text-sm rounded-lg">
                          ğŸ” {{ t('search') }}
                      </button>
                  </div>
              </div>
              
              <!-- Search Results -->
              @if(ragSearchResults().length > 0) {
                  <div class="space-y-2 max-h-[300px] overflow-y-auto">
                      <h4 class="text-sm font-medium text-slate-400 mb-2">{{ t('searchResults') }} ({{ ragSearchResults().length }})</h4>
                      @for(result of ragSearchResults(); track result.id) {
                          <div class="p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800 transition-colors">
                              <div class="flex items-start justify-between gap-2">
                                  <div class="flex-1 min-w-0">
                                      <div class="flex items-center gap-2 mb-1">
                                          <span class="text-xs px-2 py-0.5 rounded-full" 
                                              [class.bg-blue-500/20]="result.type === 'qa'"
                                              [class.text-blue-400]="result.type === 'qa'"
                                              [class.bg-purple-500/20]="result.type === 'script'"
                                              [class.text-purple-400]="result.type === 'script'"
                                              [class.bg-amber-500/20]="result.type === 'objection'"
                                              [class.text-amber-400]="result.type === 'objection'">
                                              {{ result.type }}
                                          </span>
                                          <span class="text-xs text-green-400">{{ (result.similarity * 100).toFixed(0) }}%</span>
                                          <span class="text-xs text-slate-500">{{ t('score') }}: {{ (result.successScore * 100).toFixed(0) }}%</span>
                                      </div>
                                      @if(result.question) {
                                          <p class="text-sm text-cyan-400 truncate">Q: {{ result.question }}</p>
                                      }
                                      <p class="text-sm text-slate-300 line-clamp-2">A: {{ result.answer }}</p>
                                  </div>
                                  <div class="flex gap-1">
                                      <button 
                                          (click)="sendRagFeedback(result.id, true)"
                                          class="p-1 text-green-400 hover:bg-green-500/20 rounded" 
                                          title="Good">ğŸ‘</button>
                                      <button 
                                          (click)="sendRagFeedback(result.id, false)"
                                          class="p-1 text-red-400 hover:bg-red-500/20 rounded" 
                                          title="Bad">ğŸ‘</button>
                                  </div>
                              </div>
                          </div>
                      }
                  </div>
              }
              
              <!-- Knowledge by Type -->
              @if(ragStats().by_type && ragTypeKeys().length > 0) {
                  <div class="mt-4 pt-4 border-t border-slate-700">
                      <h4 class="text-sm font-medium text-slate-400 mb-3">{{ t('knowledgeByType') }}</h4>
                      <div class="grid grid-cols-2 gap-2">
                          @for(type of ragTypeKeys(); track type) {
                              <div class="p-2 bg-slate-800/50 rounded-lg flex items-center justify-between">
                                  <span class="text-sm text-slate-300">{{ type }}</span>
                                  <div class="flex items-center gap-3">
                                      <span class="text-xs text-cyan-400">{{ ragStats().by_type[type].count }} {{ t('items') }}</span>
                                      <span class="text-xs text-green-400">{{ (ragStats().by_type[type].avg_score * 100).toFixed(0) }}%</span>
                                  </div>
                              </div>
                          }
                      </div>
                  </div>
              }
              
              <!-- Add Manual Knowledge Button -->
              <div class="mt-4 pt-4 border-t border-slate-700">
                  <button 
                      (click)="showAddRagKnowledgeDialog.set(true)"
                      class="px-4 py-2 bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600 text-white text-sm rounded-lg flex items-center gap-2 transition-colors">
                      <span>â•</span> {{ t('addManualKnowledge') }}
                  </button>
              </div>
          </div>

          <!-- Add RAG Knowledge Dialog -->
          @if(showAddRagKnowledgeDialog()) {
              <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="showAddRagKnowledgeDialog.set(false)">
                  <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-6 border border-cyan-500/30" (click)="$event.stopPropagation()">
                      <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                          <span>ğŸ¤–</span> {{ t('addRagKnowledge') }}
                      </h3>
                      
                      <div class="space-y-4">
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('knowledgeType') }}</label>
                              <select [(ngModel)]="newRagKnowledge.type" class="form-select w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white">
                                  <option value="qa">Q&A å•ç­”</option>
                                  <option value="script">æˆåŠŸè©±è¡“</option>
                                  <option value="objection">ç•°è­°è™•ç†</option>
                                  <option value="product">ç”¢å“ä¿¡æ¯</option>
                                  <option value="faq">å¸¸è¦‹å•é¡Œ</option>
                                  <option value="greeting">é–‹å ´ç™½</option>
                                  <option value="closing">æˆäº¤è©±è¡“</option>
                              </select>
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('ragQuestion') }}</label>
                              <input type="text" [(ngModel)]="newRagKnowledge.question" class="form-input w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white" [placeholder]="t('questionPlaceholder')">
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('ragAnswer') }} *</label>
                              <textarea [(ngModel)]="newRagKnowledge.answer" rows="4" class="form-textarea w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white resize-none" [placeholder]="t('answerPlaceholder')"></textarea>
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('context') }}</label>
                              <input type="text" [(ngModel)]="newRagKnowledge.context" class="form-input w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white" [placeholder]="t('contextPlaceholder')">
                          </div>
                      </div>
                      
                      <div class="flex gap-3 mt-6">
                          <button (click)="showAddRagKnowledgeDialog.set(false)" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2 rounded-lg">{{ t('cancel') }}</button>
                          <button (click)="addRagKnowledge()" class="flex-1 bg-cyan-500 hover:bg-cyan-600 text-white py-2 rounded-lg">{{ t('addKnowledge') }}</button>
                      </div>
                  </div>
              </div>
          }

          <!-- Add Document Dialog -->
          @if(showAddDocumentDialog()) {
              <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="showAddDocumentDialog.set(false)">
                  <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-6 border border-blue-500/30" (click)="$event.stopPropagation()">
                      <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                          <span>ğŸ“„</span> {{ t('addDocument') }}
                      </h3>
                      
                      <div class="space-y-4">
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('documentTitle') }}</label>
                              <input type="text" [ngModel]="newDocument().title" (ngModelChange)="updateNewDocumentField('title', $event)" class="form-input w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white" placeholder="æ–‡æª”æ¨™é¡Œ">
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('documentCategory') }}</label>
                              <select [ngModel]="newDocument().category" (ngModelChange)="updateNewDocumentField('category', $event)" class="form-select w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white">
                                  <option value="general">{{ t('categoryGeneral') }}</option>
                                  <option value="products">{{ t('categoryProducts') }}</option>
                                  <option value="tutorials">{{ t('categoryTutorials') }}</option>
                                  <option value="faq">{{ t('categoryFaq') }}</option>
                              </select>
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('documentTags') }}</label>
                              <input type="text" [ngModel]="newDocument().tags" (ngModelChange)="updateNewDocumentField('tags', $event)" class="form-input w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white" placeholder="æ¨™ç±¤1, æ¨™ç±¤2, ...">
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('uploadFile') }}</label>
                              <label class="flex items-center justify-center w-full h-20 border-2 border-dashed border-blue-500/30 rounded-lg cursor-pointer hover:border-blue-500/50 transition-colors">
                                  <input type="file" class="hidden" accept=".txt,.md,.pdf,.docx" (change)="uploadDocumentFile($event)">
                                  <div class="text-center">
                                      <span class="text-blue-400">{{ t('dragDropHint') }}</span>
                                      <p class="text-xs text-slate-500 mt-1">{{ t('supportedFormats') }}: TXT, MD, PDF, DOCX</p>
                                  </div>
                              </label>
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('orPasteContent') }}</label>
                              <textarea [ngModel]="newDocument().content" (ngModelChange)="updateNewDocumentField('content', $event)" rows="5" class="form-textarea w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white resize-none" [placeholder]="t('contentPlaceholder')"></textarea>
                          </div>
                      </div>
                      
                      <div class="flex gap-3 mt-6">
                          <button (click)="showAddDocumentDialog.set(false)" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2 rounded-lg">{{ t('cancel') }}</button>
                          <button (click)="addDocument()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">{{ t('addDocument') }}</button>
                      </div>
                  </div>
              </div>
          }

          <!-- Add Media Dialog -->
          @if(showAddMediaDialog()) {
              <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="showAddMediaDialog.set(false)">
                  <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-6 border border-green-500/30" (click)="$event.stopPropagation()">
                      <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                          <span>{{ newMedia().mediaType === 'image' ? 'ğŸ–¼ï¸' : 'ğŸ¬' }}</span> 
                          {{ newMedia().mediaType === 'image' ? t('addImage') : t('addVideo') }}
                      </h3>
                      
                      <div class="space-y-4">
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">åç¨±</label>
                              <input type="text" [ngModel]="newMedia().name" (ngModelChange)="updateNewMediaField('name', $event)" class="form-input w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white" placeholder="åª’é«”åç¨±">
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('documentCategory') }}</label>
                              <select [ngModel]="newMedia().category" (ngModelChange)="updateNewMediaField('category', $event)" class="form-select w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white">
                                  <option value="general">{{ t('categoryGeneral') }}</option>
                                  <option value="products">{{ t('categoryProducts') }}</option>
                                  <option value="tutorials">{{ t('categoryTutorials') }}</option>
                              </select>
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">æè¿°</label>
                              <textarea [ngModel]="newMedia().description" (ngModelChange)="updateNewMediaField('description', $event)" rows="2" class="form-textarea w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white resize-none" placeholder="åª’é«”æè¿°..."></textarea>
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('uploadFile') }}</label>
                              <label class="flex items-center justify-center w-full h-32 border-2 border-dashed border-green-500/30 rounded-lg cursor-pointer hover:border-green-500/50 transition-colors">
                                  <input type="file" class="hidden" [accept]="newMedia().mediaType === 'image' ? 'image/*' : 'video/*'" (change)="uploadMediaFile($event)">
                                  <div class="text-center">
                                      <div class="text-4xl mb-2">{{ newMedia().mediaType === 'image' ? 'ğŸ–¼ï¸' : 'ğŸ¬' }}</div>
                                      <span class="text-green-400">{{ t('dragDropHint') }}</span>
                                  </div>
                              </label>
                          </div>
                      </div>
                      
                      <div class="flex gap-3 mt-6">
                          <button (click)="showAddMediaDialog.set(false)" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2 rounded-lg">{{ t('cancel') }}</button>
                      </div>
                  </div>
              </div>
          }

          <!-- Add QA Dialog -->
          @if(showAddQaDialog()) {
              <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="showAddQaDialog.set(false)">
                  <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-6 border border-amber-500/30" (click)="$event.stopPropagation()">
                      <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                          <span>â“</span> {{ t('addQaPair') }}
                      </h3>
                      
                      <div class="space-y-4">
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('question') }} *</label>
                              <input type="text" [ngModel]="newQaPair().question" (ngModelChange)="updateNewQaPairField('question', $event)" class="form-input w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white" placeholder="ç”¨æˆ¶å¯èƒ½æœƒå•çš„å•é¡Œ...">
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('answer') }} *</label>
                              <textarea [ngModel]="newQaPair().answer" (ngModelChange)="updateNewQaPairField('answer', $event)" rows="4" class="form-textarea w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white resize-none" placeholder="æ¨™æº–å›ç­”..."></textarea>
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('documentCategory') }}</label>
                              <select [ngModel]="newQaPair().category" (ngModelChange)="updateNewQaPairField('category', $event)" class="form-select w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white">
                                  <option value="general">{{ t('categoryGeneral') }}</option>
                                  <option value="products">{{ t('categoryProducts') }}</option>
                                  <option value="faq">{{ t('categoryFaq') }}</option>
                              </select>
                          </div>
                          
                          <div>
                              <label class="block text-sm text-slate-400 mb-1">{{ t('keywords') }}</label>
                              <input type="text" [ngModel]="newQaPair().keywords" (ngModelChange)="updateNewQaPairField('keywords', $event)" class="form-input w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white" placeholder="é—œéµè©1, é—œéµè©2, ...">
                          </div>
                      </div>
                      
                      <div class="flex gap-3 mt-6">
                          <button (click)="showAddQaDialog.set(false)" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2 rounded-lg">{{ t('cancel') }}</button>
                          <button (click)="addQaPair()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white py-2 rounded-lg">{{ t('addQaPair') }}</button>
                      </div>
                  </div>
              </div>
          }

          <!-- AI Greeting Suggestion Dialog (Semi-Auto Mode) -->
          @if(showAiGreetingDialog() && aiGreetingSuggestion()) {
              <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100]" (click)="dismissAiGreeting()">
                  <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-6 border border-cyan-500/30 animate-pulse-once" (click)="$event.stopPropagation()">
                      <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                          <span class="text-2xl">ğŸ¤–</span> AI å•å€™å»ºè­°
                          <span class="text-xs bg-cyan-500/20 text-cyan-400 px-2 py-1 rounded ml-2">åŠè‡ªå‹•æ¨¡å¼</span>
                      </h3>
                      
                      <!-- å®¢æˆ¶ä¿¡æ¯ -->
                      <div class="p-3 bg-slate-700/50 rounded-lg mb-4">
                          <div class="flex items-center gap-3">
                              <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">
                                  {{ (aiGreetingSuggestion()?.firstName || aiGreetingSuggestion()?.username || '?')[0].toUpperCase() }}
                              </div>
                              <div>
                                  <p class="font-medium text-white">
                                      @{{ aiGreetingSuggestion()?.username || aiGreetingSuggestion()?.firstName }}
                                  </p>
                                  <p class="text-xs text-slate-400">
                                      ä¾†æº: {{ aiGreetingSuggestion()?.sourceGroup || 'æœªçŸ¥ç¾¤çµ„' }}
                                  </p>
                              </div>
                          </div>
                      </div>
                      
                      <!-- AI ç”Ÿæˆçš„å•å€™ -->
                      <div class="mb-4">
                          <label class="block text-sm text-slate-400 mb-2">AI ç”Ÿæˆçš„å•å€™æ¶ˆæ¯ï¼ˆå¯ç·¨è¼¯ï¼‰ï¼š</label>
                          <textarea 
                              [value]="aiGreetingSuggestion()?.suggestedGreeting"
                              (input)="editAiGreeting($any($event.target).value)"
                              rows="4"
                              class="form-textarea w-full bg-slate-700 border-slate-600 rounded-lg py-2 px-3 text-white resize-none focus:ring-cyan-500">
                          </textarea>
                      </div>
                      
                      <!-- æ“ä½œæŒ‰éˆ• -->
                      <div class="flex gap-3">
                          <button (click)="dismissAiGreeting()" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2 rounded-lg flex items-center justify-center gap-2">
                              <span>âœ•</span> å¿½ç•¥
                          </button>
                          <button (click)="sendAiGreeting()" class="flex-1 bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600 text-white py-2 rounded-lg flex items-center justify-center gap-2 font-bold">
                              <span>âœ“</span> ç™¼é€å•å€™
                          </button>
                      </div>
                      
                      <p class="text-xs text-slate-500 mt-3 text-center">
                          ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥åœ¨è¨­ç½®ä¸­åˆ‡æ›åˆ°ã€Œå…¨è‡ªå‹•ã€æ¨¡å¼ä»¥è·³éæ­¤ç¢ºèª
                      </p>
                  </div>
              </div>
          }
          
          <!-- Message Templates (A/B Testing) -->
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
              <div class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-800">
                  <h3 class="text-xl mb-4 font-semibold">{{ t('abTesting') }}</h3><p class="text-xs text-slate-500 mt-1 mb-4">{{ t('abTestingHint') }}</p>
                  <form (submit)="addTemplate()" class="space-y-3 mb-4">
                      <input #settingsTemplateName [value]="newTemplate().name" (input)="updateTemplateName(settingsTemplateName.value)" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2" [placeholder]="t('templateName')">
                      <textarea #settingsTemplatePrompt [value]="newTemplate().prompt" (input)="updateTemplatePrompt(settingsTemplatePrompt.value)" rows="3" class="form-textarea w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2" [placeholder]="t('prompt')"></textarea>
                      <div class="space-y-2">
                          <p class="text-xs text-slate-400 dark:text-slate-500">ğŸ“ ç‚¹å‡»æ’å…¥å˜é‡:</p>
                          <div class="flex flex-wrap gap-1">
                              <!-- ç”¨æˆ·ä¿¡æ¯ -->
                              <button type="button" (click)="insertTemplateVariable(settingsTemplatePrompt, '{username}')" class="px-2 py-1 bg-cyan-600/30 hover:bg-cyan-600/50 text-cyan-400 rounded text-xs" title="æ’å…¥: {username}">ğŸ‘¤ ç”¨æˆ·å</button>
                              <button type="button" (click)="insertTemplateVariable(settingsTemplatePrompt, '{firstName}')" class="px-2 py-1 bg-cyan-600/30 hover:bg-cyan-600/50 text-cyan-400 rounded text-xs" title="æ’å…¥: {firstName}">ğŸ“› åå­—</button>
                              <button type="button" (click)="insertTemplateVariable(settingsTemplatePrompt, '{name}')" class="px-2 py-1 bg-cyan-600/30 hover:bg-cyan-600/50 text-cyan-400 rounded text-xs" title="æ’å…¥: {name}">ğŸ·ï¸ æ˜µç§°</button>
                              <!-- è§¦å‘ä¿¡æ¯ -->
                              <button type="button" (click)="insertTemplateVariable(settingsTemplatePrompt, '{keyword}')" class="px-2 py-1 bg-amber-600/30 hover:bg-amber-600/50 text-amber-400 rounded text-xs" title="æ’å…¥: {keyword}">ğŸ”‘ è§¦å‘å…³é”®è¯</button>
                              <button type="button" (click)="insertTemplateVariable(settingsTemplatePrompt, '{message}')" class="px-2 py-1 bg-amber-600/30 hover:bg-amber-600/50 text-amber-400 rounded text-xs" title="æ’å…¥: {message}">ğŸ’¬ ç”¨æˆ·æ¶ˆæ¯</button>
                              <button type="button" (click)="insertTemplateVariable(settingsTemplatePrompt, '{groupName}')" class="px-2 py-1 bg-green-600/30 hover:bg-green-600/50 text-green-400 rounded text-xs" title="æ’å…¥: {groupName}">ğŸ‘¥ ç¾¤ç»„åç§°</button>
                              <!-- æ—¶é—´å’Œéšæœº -->
                              <button type="button" (click)="insertTemplateVariable(settingsTemplatePrompt, '{time}')" class="px-2 py-1 bg-purple-600/30 hover:bg-purple-600/50 text-purple-400 rounded text-xs" title="æ’å…¥: {time}">ğŸ• å½“å‰æ—¶é—´</button>
                              <button type="button" (click)="insertTemplateVariable(settingsTemplatePrompt, '{date}')" class="px-2 py-1 bg-purple-600/30 hover:bg-purple-600/50 text-purple-400 rounded text-xs" title="æ’å…¥: {date}">ğŸ“… å½“å‰æ—¥æœŸ</button>
                              <button type="button" (click)="insertTemplateVariable(settingsTemplatePrompt, '{random}')" class="px-2 py-1 bg-pink-600/30 hover:bg-pink-600/50 text-pink-400 rounded text-xs" title="æ’å…¥: {random}">ğŸ² éšæœºè¡¨æƒ…</button>
                          </div>
                          <p class="text-xs text-slate-500 mt-1">ğŸ’¡ å˜é‡ä¼šåœ¨å‘é€æ—¶è‡ªåŠ¨æ›¿æ¢ä¸ºå®é™…å€¼ | é¼ æ ‡æ‚¬åœæŸ¥çœ‹å˜é‡ä»£ç </p>
                      </div>
                      <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20">{{ t('saveTemplate') }}</button>
                  </form>
                  <div class="space-y-2">
                      @for(template of messageTemplates(); track template.id) {
                          <div class="bg-slate-200/50 dark:bg-slate-800/50 p-2 rounded-lg flex justify-between items-center">
                              <div><p class="font-semibold">{{ template.name }}</p><p class="text-xs text-slate-500 dark:text-slate-400">{{ template.prompt.substring(0, 40) }}...</p></div>
                              <div class="flex items-center gap-2"><button (click)="toggleTemplateStatus(template.id)" [class.bg-green-500/20]="template.isActive" [class.text-green-300]="template.isActive" [class.bg-slate-700/50]="!template.isActive" [class.text-slate-300]="!template.isActive" class="text-xs px-2.5 py-1 rounded-full font-semibold">{{ template.isActive ? t('active') : t('inactive')}}</button><button (click)="removeById(messageTemplates, template.id, 'template')" class="text-red-400 hover:text-red-300 text-lg font-bold">Ã—</button></div>
                          </div>
                      }
                  </div>
              </div>
          </div>
      }
      
      @case ('profile') {
        <!-- å€‹äººä¸­å¿ƒ -->
        <app-profile></app-profile>
      }
      
      @case ('membership-center') {
        <!-- æœƒå“¡ä¸­å¿ƒ -->
        <app-membership-center></app-membership-center>
      }
    }
  </main>

  <!-- Lead Detail Modal -->
  @if (generationState().lead; as lead) {
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
      <div class="bg-slate-100 dark:bg-slate-900/80 border border-slate-500/20 rounded-2xl shadow-2xl p-6 w-full max-w-2xl transform transition-all text-slate-800 dark:text-slate-200">
        <div class="flex justify-between items-center border-b border-slate-500/20 pb-3 mb-4">
          <h3 class="text-2xl font-semibold text-slate-900 dark:text-white">{{ t('leadDetails') }}: @{{ lead.username }}</h3>
          <button (click)="closeLeadDetailModal()" class="text-slate-400 hover:text-slate-200 text-3xl leading-none transition-colors">&times;</button>
        </div>
        <div class="border-b border-slate-500/20"><nav class="-mb-px flex space-x-6" aria-label="Tabs"><a (click)="leadDetailView.set('sendMessage')" [class.border-cyan-400]="leadDetailView() === 'sendMessage'" [class.text-cyan-400]="leadDetailView() === 'sendMessage'" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm cursor-pointer text-slate-500 hover:text-cyan-400 transition-colors">{{ t('sendMessageTab') }}</a><a (click)="leadDetailView.set('history')" [class.border-cyan-400]="leadDetailView() === 'history'" [class.text-cyan-400]="leadDetailView() === 'history'" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm cursor-pointer text-slate-500 hover:text-cyan-400 transition-colors">{{ t('historyTab') }}</a></nav></div>
        @if(leadDetailView() === 'sendMessage') {
            <div class="py-4 space-y-4">
              <!-- ç™¼é€è³¬è™Ÿé¸æ“‡å™¨ -->
              <div>
                <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('selectSenderAccount') }}</label>
                <select 
                    [ngModel]="selectedSenderId()" 
                    (ngModelChange)="selectedSenderId.set($event)"
                    class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    @if(senderAccounts().length === 0) {
                        <option value="">{{ t('noSenderAccounts') }}</option>
                    } @else {
                        @for(account of senderAccounts(); track account.id) {
                            <option [value]="account.id">{{ account.phone }} ({{ account.status }})</option>
                        }
                    }
                </select>
                @if(senderAccounts().length === 0) {
                    <p class="text-xs text-amber-400 mt-1">âš ï¸ {{ t('noSenderAccountsHint') }}</p>
                }
              </div>

              <!-- æ¶ˆæ¯è¼¸å…¥æ–¹å¼é¸æ“‡ -->
              <div class="flex items-center gap-4 p-3 bg-slate-200/30 dark:bg-slate-800/30 rounded-lg">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="messageMode" [checked]="messageMode() === 'manual'" (change)="messageMode.set('manual')" class="form-radio text-cyan-500">
                    <span class="text-sm">{{ t('manualInput') }}</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="messageMode" [checked]="messageMode() === 'ai'" (change)="messageMode.set('ai')" class="form-radio text-cyan-500">
                    <span class="text-sm">{{ t('aiGenerate') }}</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="messageMode" [checked]="messageMode() === 'template'" (change)="messageMode.set('template')" class="form-radio text-cyan-500">
                    <span class="text-sm">{{ t('useTemplate') }}</span>
                </label>
              </div>

              <!-- AI ç”Ÿæˆæ¨¡å¼ -->
              @if(messageMode() === 'ai') {
                <div class="space-y-3">
                    <!-- AI é…ç½®ç‹€æ…‹ -->
                    <div class="flex items-center justify-between p-2 bg-slate-200/30 dark:bg-slate-800/30 rounded-lg">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">ğŸ¤–</span>
                            <span class="text-sm text-slate-400">
                                {{ aiApiType() === 'local' ? 'æœ¬åœ° AI' : aiApiType() === 'openai' ? 'OpenAI' : aiApiType() === 'custom' ? 'è‡ªå®šç¾© API' : 'Gemini' }}
                            </span>
                            @if(isAiConfigured()) {
                                <span class="text-xs text-green-400">âœ“ å·²é€£æ¥</span>
                            }
                        </div>
                        @if(ragEnabled()) {
                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">ğŸ“š RAG å·²å•Ÿç”¨</span>
                        }
                    </div>
                    
                    <!-- å®¢æˆ¶è³‡è¨Šæ‘˜è¦ -->
                    @if(generationState().lead) {
                        <div class="p-2 bg-cyan-500/10 border border-cyan-500/20 rounded-lg text-xs text-slate-400">
                            <strong class="text-cyan-400">å®¢æˆ¶è³‡è¨Šï¼š</strong>
                            @{{ generationState().lead.username }} 
                            @if(generationState().lead.sourceGroup) { | ä¾†æº: {{ generationState().lead.sourceGroup }} }
                            @if(generationState().lead.triggerKeyword) { | è§¸ç™¼è©: {{ generationState().lead.triggerKeyword }} }
                        </div>
                    }
                    
                    <!-- è‡ªå®šç¾©æç¤ºè© -->
                    <div>
                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('customizePrompt') }}</label>
                        <textarea 
                            [ngModel]="generationState().customPrompt" 
                            (ngModelChange)="updateCustomPrompt($event)"
                            rows="2" 
                            class="form-textarea w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            [placeholder]="t('aiPromptPlaceholder')">
                        </textarea>
                    </div>
                    
                    <!-- ç”ŸæˆæŒ‰éˆ• -->
                    <div class="flex items-center justify-center gap-3">
                        <button (click)="generateMessage()" [disabled]="generationState().status === 'loading' || !isAiConfigured()" class="bg-gradient-to-r from-purple-500 to-cyan-500 hover:from-purple-600 hover:to-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg disabled:from-slate-400 disabled:to-slate-500 disabled:shadow-none disabled:cursor-not-allowed flex items-center gap-2">
                            @if(generationState().status === 'loading') { 
                                <span class="animate-spin">âŸ³</span> <span>{{ t('generating') }}</span> 
                            } @else { 
                                <span>âœ¨</span> <span>{{ t('generateWithAi') }}</span> 
                            }
                        </button>
                        @if(generationState().status === 'success') {
                            <button (click)="generateMessage()" class="p-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg" title="é‡æ–°ç”Ÿæˆ">
                                ğŸ”„
                            </button>
                        }
                    </div>
                    
                    @if(!isAiConfigured()) {
                        <div class="p-3 bg-amber-500/10 border border-amber-500/20 text-amber-400 rounded-lg text-sm text-center">
                            âš ï¸ {{ t('aiNotConfigured') }} 
                            <a (click)="currentView.set('settings'); closeLeadDetailModal()" class="text-cyan-400 hover:underline cursor-pointer ml-1">{{ t('goToSettings') }}</a>
                        </div>
                    }
                    
                    @if(generationState().status === 'error') {
                        <div class="p-3 bg-red-500/10 border border-red-500/20 text-red-400 rounded-lg text-sm">
                            <strong>{{ t('error') }}:</strong> {{ generationState().error }}
                            <button (click)="generateMessage()" class="ml-2 text-cyan-400 hover:underline">é‡è©¦</button>
                        </div>
                    }
                    
                    <!-- ç”ŸæˆæˆåŠŸæç¤º -->
                    @if(generationState().status === 'success' && generationState().generatedMessage) {
                        <div class="p-3 bg-green-500/10 border border-green-500/20 rounded-lg">
                            <p class="text-xs text-green-400 mb-2">âœ“ AI å·²ç”Ÿæˆæ¶ˆæ¯ï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹æ–¹ç·¨è¼¯å¾Œç™¼é€</p>
                        </div>
                    }
                </div>
              }

              <!-- æ¨¡æ¿é¸æ“‡æ¨¡å¼ -->
              @if(messageMode() === 'template') {
                <div>
                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('selectTemplate') }}</label>
                    <select 
                        (change)="applyTemplate($event)"
                        class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <option value="">{{ t('selectTemplatePlaceholder') }}</option>
                        @for(template of messageTemplates(); track template.id) {
                            <option [value]="template.id">{{ template.name }}</option>
                        }
                    </select>
                </div>
              }

              <!-- æ¶ˆæ¯å…§å®¹ç·¨è¼¯å€ -->
              <div>
                <div class="flex items-center justify-between mb-1">
                    <label class="text-sm font-medium text-slate-500 dark:text-slate-400">{{ t('messageContent') }}</label>
                    <span class="text-xs text-slate-500">{{ editableMessage().length }} {{ t('characters') }}</span>
                </div>
                <textarea 
                    [ngModel]="editableMessage()" 
                    (ngModelChange)="editableMessage.set($event)"
                    rows="4" 
                    class="form-textarea w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-3 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 resize-none"
                    [placeholder]="t('messageContentPlaceholder')">
                </textarea>
              </div>

              <!-- é™„ä»¶å€åŸŸ -->
              <div class="flex items-center gap-4">
                <button (click)="imageUpload.click()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm font-medium py-2 px-4 rounded-lg transition duration-200">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    {{ t('attachImage') }}
                </button>
                <input #imageUpload type="file" (change)="onFileAttached($event, 'image')" accept="image/*" class="hidden">
                <button (click)="fileUpload.click()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm font-medium py-2 px-4 rounded-lg transition duration-200">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    {{ t('attachFile') }}
                </button>
                <input #fileUpload type="file" (change)="onFileAttached($event, 'file')" class="hidden">
              </div>
              @if(generationState().attachment; as attachment) {
                <div class="p-2 rounded-lg bg-slate-200/50 dark:bg-slate-800/50 flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2 truncate">
                       @if(attachment.type === 'image') { <svg class="h-4 w-4 flex-shrink-0 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg> }
                       @else { <svg class="h-4 w-4 flex-shrink-0 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg> }
                       <span class="truncate">{{ attachment.name }}</span>
                    </div>
                    <button (click)="removeAttachment()" class="text-red-400 hover:text-red-300 text-lg font-bold">&times;</button>
                </div>
              }

              <!-- åº•éƒ¨æ“ä½œæŒ‰éˆ• -->
              <div class="flex justify-between items-center pt-4 border-t border-slate-500/20">
                <button (click)="addToDoNotContact(lead.id)" [disabled]="lead.doNotContact" class="text-xs text-red-400 hover:text-red-300 disabled:text-slate-500 disabled:cursor-not-allowed flex items-center gap-1">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
                    {{ lead.doNotContact ? t('userOnDNC') : t('addToDNC') }}
                </button>
                <div class="flex gap-3">
                    <button (click)="closeLeadDetailModal()" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-white font-semibold py-2.5 px-5 rounded-lg transition-colors">
                        {{ t('cancel') }}
                    </button>
                    <button 
                        (click)="sendMessageToLead()" 
                        [disabled]="!canSendMessage() || lead.doNotContact" 
                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg shadow-green-500/20 disabled:bg-slate-400 disabled:dark:bg-slate-600 disabled:shadow-none disabled:cursor-not-allowed flex items-center gap-2 transition-all">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        {{ t('sendMessage') }}
                    </button>
                </div>
              </div>
            </div>
        }
        @if(leadDetailView() === 'history') {
            <div class="py-4">
                <!-- åŠ è¼‰å®Œæ•´èŠå¤©è¨˜éŒ„æŒ‰éˆ• -->
                <div class="mb-4 flex items-center justify-between">
                    <button 
                        (click)="loadChatHistory(lead.userId)" 
                        [disabled]="isLoadingChatHistory()"
                        class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm disabled:bg-slate-500 disabled:cursor-not-allowed flex items-center gap-2">
                        @if(isLoadingChatHistory()) {
                            <span class="animate-spin">âŸ³</span> <span>åŠ è¼‰ä¸­...</span>
                        } @else {
                            <span>ğŸ’¬</span> <span>åŠ è¼‰å®Œæ•´èŠå¤©è¨˜éŒ„</span>
                        }
                    </button>
                    @if(selectedChatUserId() === lead.userId && chatHistory().length > 0) {
                        <span class="text-xs text-slate-500">å…± {{ chatHistory().length }} æ¢æ¶ˆæ¯</span>
                    }
                </div>
                
                <!-- å®Œæ•´èŠå¤©è¨˜éŒ„ï¼ˆå¦‚æœå·²åŠ è¼‰ï¼‰ -->
                @if(selectedChatUserId() === lead.userId && chatHistory().length > 0) {
                    <div 
                        class="h-96 overflow-y-auto space-y-3 mb-4 bg-slate-200/30 dark:bg-slate-800/30 rounded-lg p-4"
                        (scroll)="onChatHistoryScroll($event)">
                        @for(message of chatHistory(); track trackByChatMessageId($index, message)) {
                            @if(message.role === 'user') {
                                <!-- ç”¨æˆ¶æ¶ˆæ¯ï¼ˆå·¦å´ï¼‰ -->
                                <div class="flex justify-start">
                                    <div class="max-w-[75%]">
                                        <div class="bg-slate-700 text-white rounded-2xl rounded-bl-sm px-4 py-2">
                                            <p class="text-sm">{{ message.content }}</p>
                                        </div>
                                        <p class="text-xs text-slate-500 mt-1">{{ formatTimestamp(message.timestamp) }}</p>
                                    </div>
                                </div>
                            } @else if(message.role === 'assistant') {
                                <!-- AI å›å¾©ï¼ˆå³å´ï¼‰ -->
                                <div class="flex justify-end">
                                    <div class="max-w-[75%]">
                                        <div class="bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-2xl rounded-br-sm px-4 py-2 shadow-lg">
                                            <p class="text-sm">{{ message.content }}</p>
                                        </div>
                                        <div class="flex items-center justify-end gap-2 mt-1">
                                            <span class="text-xs text-slate-500">{{ formatTimestamp(message.timestamp) }}</span>
                                            <span class="text-xs bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded">ğŸ¤– AI</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        
                        <!-- åŠ è¼‰æ›´å¤šæŒ‡ç¤ºå™¨ -->
                        @if(chatHistoryLoadingMore()) {
                            <div class="text-center py-4">
                                <span class="animate-spin text-cyan-400">âŸ³</span>
                                <span class="ml-2 text-sm text-slate-500">åŠ è¼‰ä¸­...</span>
                            </div>
                        }
                        
                        @if(chatHistoryHasMore() && !chatHistoryLoadingMore()) {
                            <div class="text-center py-2">
                                <button 
                                    (click)="loadMoreChatHistory()"
                                    class="text-sm text-cyan-400 hover:text-cyan-300">
                                    åŠ è¼‰æ›´å¤šæ¶ˆæ¯
                                </button>
                            </div>
                        }
                    </div>
                }
                
                <!-- äº’å‹•æ­·å²ï¼ˆåŸæœ‰é¡¯ç¤ºï¼‰ -->
                <div class="h-96 overflow-y-auto">
                    <div class="space-y-3 mb-4">
                        @for(item of lead.interactionHistory; track trackByChatMessageId($index, item)) {
                        @if(item.type.includes('Sent') || item.type.includes('Message')) {
                            <!-- æˆ‘æ–¹æ¶ˆæ¯ï¼ˆå³å´ï¼‰ -->
                            <div class="flex justify-end">
                                <div class="max-w-[75%]">
                                    <div class="bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-2xl rounded-br-sm px-4 py-2 shadow-lg">
                                        <p class="text-sm">{{ item.content }}</p>
                                    </div>
                                    <div class="flex items-center justify-end gap-2 mt-1">
                                        <span class="text-xs text-slate-500">{{ formatTimestamp(item.timestamp) }}</span>
                                        @if(item.type.includes('AI')) {
                                            <span class="text-xs bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded">ğŸ¤– AI</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        } @else if(item.type.includes('Reply') || item.type.includes('Received')) {
                            <!-- å°æ–¹å›å¾©ï¼ˆå·¦å´ï¼‰ -->
                            <div class="flex justify-start">
                                <div class="max-w-[75%]">
                                    <div class="bg-slate-700 text-white rounded-2xl rounded-bl-sm px-4 py-2">
                                        <p class="text-sm">{{ item.content }}</p>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">{{ formatTimestamp(item.timestamp) }}</p>
                                </div>
                            </div>
                        } @else {
                            <!-- ç³»çµ±æ¶ˆæ¯ï¼ˆå±…ä¸­ï¼‰ -->
                            <div class="flex justify-center">
                                <div class="bg-slate-800/50 text-slate-400 text-xs px-3 py-1 rounded-full">
                                    {{ item.type }}: {{ item.content }} Â· {{ formatTimestamp(item.timestamp) }}
                                </div>
                            </div>
                        }
                    }
                </div>
                </div>
                
                @if(lead.interactionHistory.length === 0 && (!selectedChatUserId() || chatHistory().length === 0)) { 
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">ğŸ’¬</div>
                        <p class="text-slate-500 dark:text-slate-400">{{ t('noHistoryFound') }}</p>
                        <p class="text-xs text-slate-500 mt-2">é»æ“Šã€ŒåŠ è¼‰å®Œæ•´èŠå¤©è¨˜éŒ„ã€æŸ¥çœ‹æ‰€æœ‰å°è©±</p>
                    </div>
                }
                
                <!-- AI åˆ†æé¢æ¿ -->
                @if(lead.interactionHistory.length > 0) {
                    <div class="mt-4 p-3 bg-slate-800/50 rounded-lg border border-cyan-500/20">
                        <h4 class="text-sm font-medium text-cyan-400 mb-2 flex items-center gap-2">
                            <span>ğŸ“Š</span> AI å°è©±åˆ†æ
                        </h4>
                        <div class="grid grid-cols-3 gap-2 text-center text-xs">
                            <div class="p-2 bg-slate-700/50 rounded">
                                <p class="text-slate-400">ç¸½äº’å‹•</p>
                                <p class="text-lg font-bold text-white">{{ lead.interactionHistory.length }}</p>
                            </div>
                            <div class="p-2 bg-slate-700/50 rounded">
                                <p class="text-slate-400">å°è©±éšæ®µ</p>
                                <p class="text-sm font-bold text-cyan-400">{{ lead.status || 'åˆæ¬¡æ¥è§¸' }}</p>
                            </div>
                            <div class="p-2 bg-slate-700/50 rounded">
                                <p class="text-slate-400">èˆˆè¶£ç¨‹åº¦</p>
                                <p class="text-lg">â­â­â­</p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
      </div>
    </div>
  }

  <!-- æ‰¹é‡æ“ä½œæ­·å²å°è©±æ¡† -->
  @if(showBatchOperationHistory()) {
    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" (click)="showBatchOperationHistory.set(false)">
      <div class="bg-slate-100 dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-300 dark:border-slate-700 w-full max-w-3xl max-h-[80vh] overflow-hidden" (click)="$event.stopPropagation()">
        <!-- æ¨™é¡Œ -->
        <div class="p-4 border-b border-slate-300 dark:border-slate-700 flex items-center justify-between bg-slate-200/50 dark:bg-slate-800/50">
          <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
            <svg class="h-5 w-5 text-purple-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>
            æ‰¹é‡æ“ä½œæ­·å²
          </h3>
          <button (click)="showBatchOperationHistory.set(false)" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-white">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        
        <!-- å…§å®¹ -->
        <div class="p-4 overflow-y-auto max-h-[60vh]">
          @if(batchOperationHistory().length === 0) {
            <div class="text-center py-8 text-slate-500">
              <svg class="h-12 w-12 mx-auto mb-3 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
              <p>æš«ç„¡æ“ä½œæ­·å²</p>
            </div>
          } @else {
            <div class="space-y-3">
              @for(op of batchOperationHistory(); track op.id) {
                <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-lg p-3 border border-slate-300 dark:border-slate-700"
                     [class.opacity-50]="op.reversed">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <div class="p-2 rounded-lg" 
                           [class.bg-cyan-500/20]="op.operationType === 'update_status'"
                           [class.bg-blue-500/20]="op.operationType === 'add_tag'"
                           [class.bg-red-500/20]="op.operationType === 'delete' || op.operationType === 'add_to_dnc'">
                        <svg class="h-4 w-4" 
                             [class.text-cyan-400]="op.operationType === 'update_status'"
                             [class.text-blue-400]="op.operationType === 'add_tag'"
                             [class.text-red-400]="op.operationType === 'delete' || op.operationType === 'add_to_dnc'"
                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                      </div>
                      <div>
                        <p class="font-medium text-slate-900 dark:text-white">{{ getOperationTypeName(op.operationType) }}</p>
                        <p class="text-xs text-slate-500">
                          {{ op.itemCount }} é … Â· {{ formatBatchOperationDate(op.createdAt) }}
                          @if(op.reversed) {
                            <span class="text-yellow-500 ml-2">ï¼ˆå·²æ’¤éŠ·ï¼‰</span>
                          }
                        </p>
                      </div>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="text-sm">
                        <span class="text-green-400">{{ op.successCount }} æˆåŠŸ</span>
                        @if(op.failureCount > 0) {
                          <span class="text-red-400 ml-2">{{ op.failureCount }} å¤±æ•—</span>
                        }
                      </div>
                      @if(op.isReversible && !op.reversed) {
                        <button (click)="undoBatchOperation(op.id)" 
                                class="text-xs bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 px-2 py-1 rounded">
                          æ’¤éŠ·
                        </button>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
        
        <!-- åº•éƒ¨ -->
        <div class="p-4 border-t border-slate-300 dark:border-slate-700 bg-slate-200/50 dark:bg-slate-800/50 flex justify-end">
          <button (click)="showBatchOperationHistory.set(false)" 
                  class="px-4 py-2 bg-slate-300 dark:bg-slate-700 hover:bg-slate-400 dark:hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors">
            é—œé–‰
          </button>
        </div>
      </div>
    </div>
  }
  
  <!-- é¦–æ¬¡å•Ÿå‹•æ­¡è¿å‘å° -->
  @if (showWelcomeDialog()) {
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100]">
      <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden border border-cyan-500/30">
        
        <!-- é ­éƒ¨ -->
        <div class="bg-gradient-to-r from-cyan-500 to-purple-500 p-6 text-center">
          <h1 class="text-3xl font-bold text-white mb-2">ğŸš€ æ­¡è¿ä½¿ç”¨ TG-AIæ™ºæ§ç‹</h1>
          <p class="text-cyan-100">AI é©…å‹•çš„ Telegram ç‡ŸéŠ·è‡ªå‹•åŒ–å¹³å°</p>
        </div>
        
        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div class="flex justify-center gap-2 py-4 bg-slate-800/50">
          <div class="w-3 h-3 rounded-full transition-all" 
               [class]="welcomeStep() >= 1 ? 'bg-cyan-500' : 'bg-slate-600'"></div>
          <div class="w-3 h-3 rounded-full transition-all" 
               [class]="welcomeStep() >= 2 ? 'bg-cyan-500' : 'bg-slate-600'"></div>
          <div class="w-3 h-3 rounded-full transition-all" 
               [class]="welcomeStep() >= 3 ? 'bg-cyan-500' : 'bg-slate-600'"></div>
        </div>
        
        <!-- å…§å®¹å€åŸŸ -->
        <div class="p-6">
          @switch (welcomeStep()) {
            @case (1) {
              <!-- æ­¥é©Ÿ 1: æ­¡è¿ä»‹ç´¹ -->
              <div class="text-center space-y-6">
                <div class="grid grid-cols-3 gap-4 mb-6">
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <div class="text-3xl mb-2">ğŸ¤–</div>
                    <div class="text-sm font-medium text-white">AI è‡ªå‹•å›è¦†</div>
                    <div class="text-xs text-slate-400">æ™ºèƒ½å®¢æœåŠ©æ‰‹</div>
                  </div>
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <div class="text-3xl mb-2">ğŸ”</div>
                    <div class="text-sm font-medium text-white">è³‡æºç™¼ç¾</div>
                    <div class="text-xs text-slate-400">è‡ªå‹•æœç´¢ç¾¤çµ„</div>
                  </div>
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <div class="text-3xl mb-2">ğŸ“Š</div>
                    <div class="text-sm font-medium text-white">æ•¸æ“šåˆ†æ</div>
                    <div class="text-xs text-slate-400">è½‰åŒ–è¿½è¹¤å ±è¡¨</div>
                  </div>
                </div>
                
                <p class="text-slate-300">
                  TG-AIæ™ºæ§ç‹ å°‡å¹«åŠ©æ‚¨è‡ªå‹•åŒ– Telegram ç‡ŸéŠ·æµç¨‹ï¼Œ<br>
                  è®“æ‚¨å°ˆæ³¨æ–¼æ¥­å‹™å¢é•·è€Œéé‡è¤‡æ“ä½œã€‚
                </p>
              </div>
            }
            @case (2) {
              <!-- æ­¥é©Ÿ 2: AI è¨­ç½® -->
              <div class="space-y-4">
                <h3 class="text-lg font-semibold text-white text-center mb-4">ğŸ¦™ AI æœå‹™é…ç½®</h3>
                
                <!-- Ollama æª¢æ¸¬ç‹€æ…‹ -->
                <div class="p-4 rounded-xl" 
                     [class]="ollamaDetected() ? 'bg-green-500/20 border border-green-500/30' : 'bg-yellow-500/20 border border-yellow-500/30'">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">{{ ollamaDetected() ? 'âœ…' : 'âš ï¸' }}</span>
                      <div>
                        <div class="font-medium text-white">
                          {{ ollamaDetected() ? 'Ollama å·²æª¢æ¸¬åˆ°' : 'Ollama æœªé‹è¡Œ' }}
                        </div>
                        <div class="text-sm text-slate-400">
                          {{ ollamaDetected() ? 'æœ¬åœ° AI æœå‹™å¯ç”¨' : 'å»ºè­°å®‰è£ Ollama ç²å¾—å…è²» AI èƒ½åŠ›' }}
                        </div>
                      </div>
                    </div>
                    <button (click)="detectOllama()" [disabled]="isDetectingOllama()"
                            class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm text-white disabled:opacity-50">
                      {{ isDetectingOllama() ? 'æª¢æ¸¬ä¸­...' : 'é‡æ–°æª¢æ¸¬' }}
                    </button>
                  </div>
                </div>
                
                @if (ollamaDetected()) {
                  <!-- æ¨¡å‹é¸æ“‡ -->
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <label class="block text-sm font-medium text-slate-300 mb-2">é¸æ“‡ AI æ¨¡å‹</label>
                    @if (detectedOllamaModels().length > 0) {
                      <select [ngModel]="localAiModel()" (ngModelChange)="localAiModel.set($event)"
                              class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2 px-3 text-white">
                        @for (model of detectedOllamaModels(); track model) {
                          <option [value]="model">{{ model }}</option>
                        }
                      </select>
                    } @else {
                      <input [ngModel]="localAiModel()" (ngModelChange)="localAiModel.set($event)"
                             class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2 px-3 text-white"
                             placeholder="qwen2:7b">
                    }
                    <p class="text-xs text-slate-500 mt-1">æ¨è–¦ï¼šqwen2:7bï¼ˆä¸­è‹±æ–‡é€šç”¨ï¼‰</p>
                  </div>
                } @else {
                  <!-- Ollama å®‰è£æŒ‡å— -->
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <div class="text-sm text-slate-300 space-y-2">
                      <p class="font-medium">ğŸ“¦ å®‰è£ Ollamaï¼ˆå…è²»ï¼‰ï¼š</p>
                      <code class="block bg-slate-800 p-2 rounded text-cyan-400 text-xs">
                        curl -fsSL https://ollama.com/install.sh | sh
                      </code>
                      <p class="text-xs text-slate-500">
                        å®‰è£å¾Œé‹è¡Œ <code class="text-cyan-400">ollama pull qwen2:7b</code> ä¸‹è¼‰æ¨¡å‹
                      </p>
                    </div>
                  </div>
                  
                  <!-- å‚™é¸ï¼šé›²ç«¯ AI -->
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" [checked]="aiAutoFallback()" (change)="aiAutoFallback.set(!aiAutoFallback())"
                             class="w-4 h-4 text-cyan-500 rounded">
                      <span class="text-sm text-slate-300">ä½¿ç”¨é›²ç«¯ AI ä½œç‚ºå‚™é¸</span>
                    </label>
                    @if (aiAutoFallback()) {
                      <div class="mt-2">
                        <select [ngModel]="aiBackupProvider()" (ngModelChange)="aiBackupProvider.set($event)"
                                class="w-full bg-slate-800 border border-slate-600 rounded py-1 px-2 text-sm text-white">
                          <option value="gemini">Google Geminiï¼ˆå…è²»é¡åº¦ï¼‰</option>
                          <option value="openai">OpenAI GPT</option>
                        </select>
                      </div>
                    }
                  </div>
                }
              </div>
            }
            @case (3) {
              <!-- æ­¥é©Ÿ 3: å®Œæˆ -->
              <div class="text-center space-y-6">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <h3 class="text-2xl font-bold text-white">è¨­ç½®å®Œæˆï¼</h3>
                <p class="text-slate-300">
                  æ‚¨å·²æº–å‚™å¥½é–‹å§‹ä½¿ç”¨ TG-AIæ™ºæ§ç‹ã€‚<br>
                  æ¥ä¸‹ä¾†è«‹æ·»åŠ æ‚¨çš„ç¬¬ä¸€å€‹ Telegram å¸³è™Ÿã€‚
                </p>
                
                <div class="p-4 bg-cyan-500/10 rounded-xl border border-cyan-500/30">
                  <div class="text-sm text-slate-300 space-y-1">
                    <p>âœ… AI æœå‹™ï¼š{{ ollamaDetected() ? 'Ollama æœ¬åœ° AI' : 'é›²ç«¯ AI' }}</p>
                    @if (ollamaDetected()) {
                      <p>âœ… æ¨¡å‹ï¼š{{ localAiModel() }}</p>
                    }
                    <p>âœ… è‡ªå‹•é™ç´šï¼š{{ aiAutoFallback() ? 'å·²å•Ÿç”¨' : 'å·²ç¦ç”¨' }}</p>
                  </div>
                </div>
              </div>
            }
          }
        </div>
        
        <!-- åº•éƒ¨æŒ‰éˆ• -->
        <div class="p-6 bg-slate-800/50 flex justify-between items-center">
          <button (click)="skipFirstRunSetup()" class="text-sm text-slate-400 hover:text-white transition-colors">
            è·³éè¨­ç½®
          </button>
          
          <div class="flex gap-3">
            @if (welcomeStep() > 1) {
              <button (click)="welcomeStep.set(welcomeStep() - 1)"
                      class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                ä¸Šä¸€æ­¥
              </button>
            }
            
            @if (welcomeStep() < 3) {
              <button (click)="welcomeStep.set(welcomeStep() + 1)"
                      class="px-6 py-2 bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600 text-white font-medium rounded-lg transition-all">
                ä¸‹ä¸€æ­¥
              </button>
            } @else {
              <button (click)="completeFirstRunSetup()"
                      class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-medium rounded-lg transition-all">
                é–‹å§‹ä½¿ç”¨ ğŸš€
              </button>
            }
          </div>
        </div>
      </div>
    </div>
  }
  
  <!-- å¾Œç«¯éŒ¯èª¤æç¤ºå°è©±æ¡† -->
  @if (showBackendErrorDialog()) {
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100]">
      <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden border border-red-500/50">
        
        <!-- é ­éƒ¨ -->
        <div class="bg-red-500/20 p-6 text-center border-b border-red-500/30">
          <div class="text-5xl mb-3">âš ï¸</div>
          <h2 class="text-xl font-bold text-red-400">Python å¾Œç«¯æœªé‹è¡Œ</h2>
        </div>
        
        <!-- å…§å®¹ -->
        <div class="p-6 space-y-4">
          <p class="text-slate-300">
            ç¨‹åºéœ€è¦ Python ç’°å¢ƒæ‰èƒ½æ­£å¸¸é‹è¡Œã€‚è«‹ç¢ºä¿ï¼š
          </p>
          
          <div class="bg-slate-700/50 rounded-lg p-4 space-y-3">
            <div class="flex items-start gap-3">
              <span class="text-cyan-400">1.</span>
              <div>
                <p class="text-white font-medium">å®‰è£ Python 3.9+</p>
                <a href="https://www.python.org/downloads/" target="_blank" 
                   class="text-cyan-400 text-sm hover:underline">
                  https://www.python.org/downloads/
                </a>
              </div>
            </div>
            
            <div class="flex items-start gap-3">
              <span class="text-cyan-400">2.</span>
              <div>
                <p class="text-white font-medium">å®‰è£æ™‚å‹¾é¸ "Add Python to PATH"</p>
                <p class="text-slate-400 text-sm">ç¢ºä¿ Python æ·»åŠ åˆ°ç³»çµ±ç’°å¢ƒè®Šé‡</p>
              </div>
            </div>
            
            <div class="flex items-start gap-3">
              <span class="text-cyan-400">3.</span>
              <div>
                <p class="text-white font-medium">å®‰è£ä¾è³´</p>
                <code class="block bg-slate-800 text-green-400 text-sm p-2 rounded mt-1">
                  pip install pyrogram tgcrypto aiosqlite
                </code>
              </div>
            </div>
            
            <div class="flex items-start gap-3">
              <span class="text-cyan-400">4.</span>
              <div>
                <p class="text-white font-medium">é‡æ–°å•Ÿå‹•ç¨‹åº</p>
              </div>
            </div>
          </div>
          
          @if (backendError()) {
            <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
              <p class="text-red-400 text-sm">
                <span class="font-medium">éŒ¯èª¤è©³æƒ…ï¼š</span>
                {{ backendError() }}
              </p>
            </div>
          }
        </div>
        
        <!-- åº•éƒ¨æŒ‰éˆ• -->
        <div class="p-4 bg-slate-700/30 flex justify-end gap-3">
          <button (click)="showBackendErrorDialog.set(false)" 
                  class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors">
            æˆ‘çŸ¥é“äº†
          </button>
        </div>
      </div>
    </div>
  }
  
    <!-- å¾Œç«¯ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    @if (!backendRunning()) {
      <div class="fixed bottom-4 right-4 z-50 bg-red-500/90 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 cursor-pointer hover:bg-red-600"
           (click)="showBackendErrorDialog.set(true)">
        <span class="animate-pulse">âš ï¸</span>
        <span class="text-sm font-medium">Python å¾Œç«¯æœªé‹è¡Œ</span>
      </div>
    }
  </div>
} <!-- çµæŸ @if (isAuthenticated()) -->