<!-- å…¨å±€é€šçŸ¥å’Œå°è©±æ¡† -->
<app-toast></app-toast>
<app-loading-overlay></app-loading-overlay>
<app-membership-dialog></app-membership-dialog>
<app-payment></app-payment>
<app-upgrade-prompt></app-upgrade-prompt>

<!-- QR æƒç¢¼ç™»å…¥å½ˆçª— -->
@if (showQrLoginDialog()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" (click)="closeQrLogin()"></div>
    <div class="relative z-10">
      <app-qr-login 
        (closed)="closeQrLogin()" 
        (loginSuccess)="onQrLoginSuccess($event)">
      </app-qr-login>
    </div>
  </div>
}

<!-- ç™»å…¥é é¢ï¼ˆæœªèªè­‰æ™‚é¡¯ç¤ºï¼‰ -->
@if (!isAuthenticated()) {
  <app-login></app-login>
} @else {
  <!-- ä¸»æ‡‰ç”¨ç•Œé¢ï¼ˆå·²èªè­‰ï¼‰ -->
  <div class="flex h-screen" style="background-color: var(--bg-primary); color: var(--text-primary);">
    
    <!-- Onboarding -->
    <app-onboarding></app-onboarding>
    
    <!-- Progress Dialog -->
    <app-progress-dialog
      [show]="progressDialog().show"
      [title]="progressDialog().title"
      [progress]="progressDialog().progress"
      [cancellable]="progressDialog().cancellable">
    </app-progress-dialog>
    
    <!-- Sidebar -->
    <aside class="w-64 backdrop-blur-sm flex-shrink-0 flex flex-col sidebar" 
           style="background-color: var(--bg-sidebar); border-right: 1px solid var(--border-default);">
      <div>
        <!-- Logo - TG-AIæ™ºæ§ç‹ -->
        <div class="flex items-center gap-3 p-4">
           <div class="relative">
             <!-- Logo ç™¼å…‰æ•ˆæœ -->
             <div class="absolute inset-0 rounded-xl blur-md opacity-50" 
                  style="background: linear-gradient(135deg, #06b6d4, #8b5cf6);"></div>
             <!-- Logo SVG -->
             <svg class="h-10 w-10 relative z-10" viewBox="0 0 64 64" fill="none">
               <!-- ä¸­å¿ƒå…­é‚Šå½¢ -->
               <path d="M32 8L52 20V44L32 56L12 44V20L32 8Z" fill="url(#sidebarLogoGrad)" stroke="url(#sidebarLogoStroke)" stroke-width="1.5"/>
               <!-- ç´™é£›æ©Ÿ -->
               <path d="M22 28L40 22L34 36L28 32L22 28Z" fill="white" opacity="0.95"/>
               <path d="M28 32L34 36L32 42L28 32Z" fill="white" opacity="0.8"/>
               <!-- çš‡å†  -->
               <path d="M24 12L28 8L32 11L36 8L40 12L38 16H26L24 12Z" fill="#fbbf24"/>
               <circle cx="32" cy="8" r="1.2" fill="#fef3c7"/>
               <!-- æ¼¸è®Š -->
               <defs>
                 <linearGradient id="sidebarLogoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                   <stop offset="0%" stop-color="#0891b2"/>
                   <stop offset="100%" stop-color="#7c3aed"/>
                 </linearGradient>
                 <linearGradient id="sidebarLogoStroke" x1="0%" y1="0%" x2="100%" y2="100%">
                   <stop offset="0%" stop-color="#22d3ee"/>
                   <stop offset="100%" stop-color="#a78bfa"/>
                 </linearGradient>
               </defs>
             </svg>
           </div>
          <div>
            <h1 class="text-xl font-bold bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">{{ t('title') }}</h1>
            <p class="text-xs" style="color: var(--text-muted);">{{ t('subtitle') }}</p>
          </div>
        </div>
        
        <!-- ç”¨æˆ¶ä¿¡æ¯å€åŸŸï¼ˆç¾åŒ–ç‰ˆ - ç‹è€…æ¦®è€€é¢¨æ ¼ï¼‰ -->
        <div class="user-profile-card mx-3 mb-4 p-3 rounded-xl cursor-pointer transition-all duration-300 hover:scale-[1.02] group"
             [class.level-bronze]="userMembershipLevel() === 'bronze'"
             [class.level-silver]="userMembershipLevel() === 'silver'"
             [class.level-gold]="userMembershipLevel() === 'gold'"
             [class.level-diamond]="userMembershipLevel() === 'diamond'"
             [class.level-star]="userMembershipLevel() === 'star'"
             [class.level-king]="userMembershipLevel() === 'king'"
             (click)="changeView('profile')">
          <div class="flex items-center gap-3">
            <!-- é ­åƒæ¡†ï¼ˆå¸¶ç­‰ç´šé‚Šæ¡†ï¼‰ -->
            <div class="avatar-wrapper relative">
              <!-- å‹•æ…‹å…‰ç’° -->
              <div class="avatar-glow absolute inset-0 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                   [class.glow-bronze]="userMembershipLevel() === 'bronze'"
                   [class.glow-silver]="userMembershipLevel() === 'silver'"
                   [class.glow-gold]="userMembershipLevel() === 'gold'"
                   [class.glow-diamond]="userMembershipLevel() === 'diamond'"
                   [class.glow-star]="userMembershipLevel() === 'star'"
                   [class.glow-king]="userMembershipLevel() === 'king'">
              </div>
              <!-- é ­åƒé‚Šæ¡† -->
              <div class="avatar-border w-12 h-12 rounded-full p-[2px]"
                   [class.border-bronze]="userMembershipLevel() === 'bronze'"
                   [class.border-silver]="userMembershipLevel() === 'silver'"
                   [class.border-gold]="userMembershipLevel() === 'gold'"
                   [class.border-diamond]="userMembershipLevel() === 'diamond'"
                   [class.border-star]="userMembershipLevel() === 'star'"
                   [class.border-king]="userMembershipLevel() === 'king'">
                <!-- é ­åƒå…§å®¹ -->
                <div class="w-full h-full rounded-full flex items-center justify-center text-white font-bold text-lg avatar-inner"
                     [class.avatar-bronze]="userMembershipLevel() === 'bronze'"
                     [class.avatar-silver]="userMembershipLevel() === 'silver'"
                     [class.avatar-gold]="userMembershipLevel() === 'gold'"
                     [class.avatar-diamond]="userMembershipLevel() === 'diamond'"
                     [class.avatar-star]="userMembershipLevel() === 'star'"
                     [class.avatar-king]="userMembershipLevel() === 'king'">
                  {{ currentUser()?.username?.charAt(0).toUpperCase() || '?' }}
                </div>
              </div>
              <!-- æœƒå“¡å¾½ç« ï¼ˆå³ä¸‹è§’ï¼‰ -->
              @if (userMembershipLevel() !== 'bronze') {
                <div class="vip-badge absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-lg"
                     [class.badge-silver]="userMembershipLevel() === 'silver'"
                     [class.badge-gold]="userMembershipLevel() === 'gold'"
                     [class.badge-diamond]="userMembershipLevel() === 'diamond'"
                     [class.badge-star]="userMembershipLevel() === 'star'"
                     [class.badge-king]="userMembershipLevel() === 'king'">
                  @switch (userMembershipLevel()) {
                    @case ('silver') { <span class="animate-pulse">ğŸ¥ˆ</span> }
                    @case ('gold') { <span class="animate-pulse">ğŸ¥‡</span> }
                    @case ('diamond') { <span class="animate-pulse">ğŸ’</span> }
                    @case ('star') { <span class="animate-pulse">ğŸŒŸ</span> }
                    @case ('king') { <span class="animate-bounce">ğŸ‘‘</span> }
                  }
                </div>
              }
            </div>
            
            <!-- ç”¨æˆ¶ä¿¡æ¯ -->
            <div class="flex-1 min-w-0">
              <div class="text-sm font-semibold truncate" style="color: var(--text-primary);">
                {{ currentUser()?.username || 'ç”¨æˆ¶' }}
              </div>
              <div class="flex items-center gap-1.5 mt-0.5">
                <!-- æœƒå“¡æ¨™ç±¤ï¼ˆç‹è€…æ¦®è€€é¢¨æ ¼ï¼‰ -->
                @switch (userMembershipLevel()) {
                  @case ('silver') {
                    <span class="vip-tag vip-tag-silver">
                      <span class="vip-icon">ğŸ¥ˆ</span>
                      <span class="vip-text">ç™½éŠ€ç²¾è‹±</span>
                    </span>
                  }
                  @case ('gold') {
                    <span class="vip-tag vip-tag-gold">
                      <span class="vip-icon">ğŸ¥‡</span>
                      <span class="vip-text">é»ƒé‡‘å¤§å¸«</span>
                    </span>
                  }
                  @case ('diamond') {
                    <span class="vip-tag vip-tag-diamond">
                      <span class="vip-icon">ğŸ’</span>
                      <span class="vip-text">é‘½çŸ³ç‹ç‰Œ</span>
                    </span>
                  }
                  @case ('star') {
                    <span class="vip-tag vip-tag-star">
                      <span class="vip-icon">ğŸŒŸ</span>
                      <span class="vip-text">æ˜Ÿè€€å‚³èªª</span>
                    </span>
                  }
                  @case ('king') {
                    <span class="vip-tag vip-tag-king">
                      <span class="vip-icon">ğŸ‘‘</span>
                      <span class="vip-text">æ¦®è€€ç‹è€…</span>
                    </span>
                  }
                  @default {
                    <span class="vip-tag vip-tag-bronze">
                      <span class="vip-icon">âš”ï¸</span>
                      <span class="vip-text">é’éŠ…æˆ°å£«</span>
                    </span>
                  }
                }
              </div>
            </div>
            
            <!-- ç®­é ­ -->
            <div class="arrow-icon transition-transform duration-300 group-hover:translate-x-1">
              <svg class="w-4 h-4" style="color: var(--text-muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </div>
          </div>
        </div>
      <nav class="mt-6 px-2">
        @let view = currentView();
        
        <!-- æœƒå“¡ä¸­å¿ƒï¼ˆç§»åˆ°ç¬¬ä¸€å€‹ï¼‰ -->
        <a (click)="changeView('membership-center')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'membership-center'"
           [style.background-color]="view === 'membership-center' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'membership-center' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
           <span>æœƒå“¡ä¸­å¿ƒ</span>
        </a>
        
        <!-- å„€è¡¨ç›¤ -->
        <a (click)="changeView('dashboard')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'dashboard'"
           [style.background-color]="view === 'dashboard' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'dashboard' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
          <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
          <span>{{ t('dashboard') }}</span>
        </a>
        
        <!-- åˆ†éš”ç·šï¼šè³‡æºç®¡ç† -->
        <div class="px-3 py-2 mt-2">
          <span class="sidebar-group-title text-xs uppercase tracking-wider" style="color: var(--sidebar-group-title);">{{ t('resourceManagement') }}</span>
        </div>
        
        <!-- å¸³è™Ÿç®¡ç† -->
        <a (click)="changeView('accounts')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'accounts' || view === 'add-account' || view === 'api-credentials'"
           [style.background-color]="(view === 'accounts' || view === 'add-account' || view === 'api-credentials') ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="(view === 'accounts' || view === 'add-account' || view === 'api-credentials') ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
           <span>{{ t('accounts') }}</span>
        </a>
        
        <!-- è³‡æºç™¼ç¾ -->
        <a (click)="changeView('resources'); autoInitResourceDiscovery()" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'resources'"
           [style.background-color]="view === 'resources' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'resources' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
           <span>{{ t('resourceDiscoveryMenu') }}</span>
        </a>
        
        <!-- åˆ†éš”ç·šï¼šç‡ŸéŠ·è‡ªå‹•åŒ– -->
        <div class="px-3 py-2 mt-2">
          <span class="sidebar-group-title text-xs uppercase tracking-wider" style="color: var(--sidebar-group-title);">{{ t('marketingAutomation') }}</span>
        </div>
        
        <!-- è‡ªå‹•åŒ–ä¸­å¿ƒ -->
        <a (click)="changeView('automation')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'automation'"
           [style.background-color]="view === 'automation' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'automation' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
            <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8" /><rect x="4" y="4" width="16" height="16" rx="2" /><path d="M12 12h.01" /><path d="M16 12h.01" /><path d="M12 16h.01" /><path d="M16 16h.01" /></svg>
            <span>{{ t('automation') }}</span>
        </a>
        
        <!-- æ½›åœ¨å®¢æˆ¶ -->
        <a (click)="changeView('leads')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'leads'"
           [style.background-color]="view === 'leads' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'leads' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="19" x2="19" y1="8" y2="14"></line><line x1="22" x2="16" y1="11" y2="11"></line></svg>
           <span>{{ t('leads') }}</span>
        </a>
        
        <!-- ğŸ†• å®¢æˆ¶åŸ¹è‚² (AIæŒçºŒè·Ÿé€²) -->
        <a (click)="changeView('lead-nurturing')"
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'lead-nurturing'"
           [style.background-color]="view === 'lead-nurturing' ? 'rgba(236, 72, 153, 0.15)' : 'transparent'"
           [style.color]="view === 'lead-nurturing' ? '#f472b6' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/><circle cx="12" cy="12" r="4"/></svg>
           <span>å®¢æˆ¶åŸ¹è‚²</span>
           <span class="ml-auto px-1.5 py-0.5 text-xs bg-pink-500/20 text-pink-400 rounded">AI</span>
        </a>
        
        <!-- ğŸ†• Phase 4: åˆ†æå„€è¡¨æ¿ -->
        <a (click)="changeView('nurturing-analytics')"
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'nurturing-analytics'"
           [style.background-color]="view === 'nurturing-analytics' ? 'rgba(139, 92, 246, 0.15)' : 'transparent'"
           [style.color]="view === 'nurturing-analytics' ? '#a78bfa' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
           <span>æ•¸æ“šåˆ†æ</span>
           <span class="ml-auto px-1.5 py-0.5 text-xs bg-purple-500/20 text-purple-400 rounded">P4</span>
        </a>
        
        <!-- ğŸ†• Phase 2 æ•¸æ“šåˆ†æä¸­å¿ƒ -->
        <a (click)="changeView('analytics-center')"
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'analytics-center'"
           [style.background-color]="view === 'analytics-center' ? 'rgba(6, 182, 212, 0.15)' : 'transparent'"
           [style.color]="view === 'analytics-center' ? '#22d3ee' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/><path d="M16.24 7.76l-1.41 1.41"/><path d="M18 12h2"/></svg>
           <span>åˆ†æä¸­å¿ƒ</span>
           <span class="ml-auto px-1.5 py-0.5 text-xs bg-cyan-500/20 text-cyan-400 rounded">æ–°</span>
        </a>

        <!-- å»£å‘Šç™¼é€ -->
        <a (click)="changeView('ads'); loadAdSystemData()" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'ads'"
           [class.opacity-50]="!membershipService.hasFeature('adBroadcast')"
           [class.cursor-not-allowed]="!membershipService.hasFeature('adBroadcast')"
           [style.background-color]="view === 'ads' ? 'rgba(249, 115, 22, 0.15)' : 'transparent'"
           [style.color]="view === 'ads' ? '#fb923c' : (!membershipService.hasFeature('adBroadcast') ? 'var(--sidebar-text-muted)' : 'var(--sidebar-text)')"
           [title]="!membershipService.hasFeature('adBroadcast') ? 'éœ€è¦ ç™½éŠ€ç²¾è‹± æˆ–ä»¥ä¸Šæœƒå“¡' : ''">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
           <span>å»£å‘Šç™¼é€</span>
           @if (!membershipService.hasFeature('adBroadcast')) {
             <span class="ml-auto text-xs opacity-60">ğŸ¥ˆ</span>
           }
        </a>
        
        <!-- ç”¨æˆ¶è¿½è¹¤ -->
        <a (click)="changeView('user-tracking'); loadUserTrackingData()" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'user-tracking'"
           [class.opacity-50]="!membershipService.hasFeature('advancedAnalytics')"
           [class.cursor-not-allowed]="!membershipService.hasFeature('advancedAnalytics')"
           [style.background-color]="view === 'user-tracking' ? 'rgba(16, 185, 129, 0.15)' : 'transparent'"
           [style.color]="view === 'user-tracking' ? '#34d399' : (!membershipService.hasFeature('advancedAnalytics') ? 'var(--sidebar-text-muted)' : 'var(--sidebar-text)')"
           [title]="!membershipService.hasFeature('advancedAnalytics') ? 'éœ€è¦ é‘½çŸ³ç‹ç‰Œ æˆ–ä»¥ä¸Šæœƒå“¡' : ''">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6"/><path d="M23 11h-6"/></svg>
           <span>ç”¨æˆ¶è¿½è¹¤</span>
           @if (!membershipService.hasFeature('advancedAnalytics')) {
             <span class="ml-auto text-xs opacity-60">ğŸ’</span>
           }
        </a>
        
        <!-- ç‡ŸéŠ·æ´»å‹• -->
        <a (click)="changeView('campaigns'); loadCampaignData()" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'campaigns'"
           [class.opacity-50]="!membershipService.hasFeature('aiSalesFunnel')"
           [class.cursor-not-allowed]="!membershipService.hasFeature('aiSalesFunnel')"
           [style.background-color]="view === 'campaigns' ? 'rgba(236, 72, 153, 0.15)' : 'transparent'"
           [style.color]="view === 'campaigns' ? '#f472b6' : (!membershipService.hasFeature('aiSalesFunnel') ? 'var(--sidebar-text-muted)' : 'var(--sidebar-text)')"
           [title]="!membershipService.hasFeature('aiSalesFunnel') ? 'éœ€è¦ é‘½çŸ³ç‹ç‰Œ æˆ–ä»¥ä¸Šæœƒå“¡' : ''">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
           <span>ç‡ŸéŠ·æ´»å‹•</span>
           @if (!membershipService.hasFeature('aiSalesFunnel')) {
             <span class="ml-auto text-xs opacity-60">ğŸ’</span>
           }
        </a>
        
        <!-- å¤šè§’è‰²å”ä½œ -->
        <a (click)="changeView('multi-role'); loadMultiRoleData()" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'multi-role'"
           [class.opacity-50]="!membershipService.hasFeature('multiRole')"
           [class.cursor-not-allowed]="!membershipService.hasFeature('multiRole')"
           [style.background-color]="view === 'multi-role' ? 'rgba(99, 102, 241, 0.15)' : 'transparent'"
           [style.color]="view === 'multi-role' ? '#a5b4fc' : (!membershipService.hasFeature('multiRole') ? 'var(--sidebar-text-muted)' : 'var(--sidebar-text)')"
           [title]="!membershipService.hasFeature('multiRole') ? 'éœ€è¦ é‘½çŸ³ç‹ç‰Œ æˆ–ä»¥ä¸Šæœƒå“¡' : ''">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
           <span>å¤šè§’è‰²å”ä½œ</span>
           @if (!membershipService.hasFeature('multiRole')) {
             <span class="ml-auto text-xs opacity-60">ğŸ’</span>
           }
        </a>
        
        <!-- åˆ†éš”ç·šï¼šAI èˆ‡æ™ºèƒ½ -->
        <div class="px-3 py-2 mt-2">
          <span class="sidebar-group-title text-xs uppercase tracking-wider" style="color: var(--sidebar-group-title);">{{ t('aiIntelligence') }}</span>
        </div>
        
        <!-- AI ä¸­å¿ƒ -->
        <a (click)="changeView('ai-center')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'ai-center'"
           [style.background-color]="view === 'ai-center' ? 'rgba(168, 85, 247, 0.15)' : 'transparent'"
           [style.color]="view === 'ai-center' ? '#c084fc' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m9 0a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3"></path></svg>
           <span>{{ t('aiCenter') }}</span>
        </a>
        
        <!-- åˆ†éš”ç·šï¼šç³»çµ±ç›£æ§ -->
        <div class="px-3 py-2 mt-2">
          <span class="sidebar-group-title text-xs uppercase tracking-wider" style="color: var(--sidebar-group-title);">{{ t('systemMonitor') }}</span>
        </div>
        
        <!-- é‹è¡Œæ—¥èªŒï¼ˆåˆä½µç›£æ§ä¸­å¿ƒå’Œå‘Šè­¦ï¼‰ -->
        <a (click)="changeView('runtime-logs')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1 relative"
           [class.active]="view === 'runtime-logs'"
           [style.background-color]="view === 'runtime-logs' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'runtime-logs' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18.7 8a2.3 2.3 0 0 0-3.4 0l-3.3 3.4-3.4-3.4a2.3 2.3 0 0 0-3.4 0L3 13.3"></path></svg>
           <span>é‹è¡Œæ—¥èªŒ</span>
           @if(unacknowledgedAlertsCount() > 0) {
             <span class="absolute right-2 text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center" style="background-color: var(--error); color: white;">{{ unacknowledgedAlertsCount() }}</span>
           }
        </a>
        
        <!-- è¨­ç½® -->
        <a (click)="changeView('settings')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'settings'"
           [style.background-color]="view === 'settings' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'settings' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
           <span>{{ t('settings') }}</span>
        </a>
      </nav>
    </div>
    
    <!-- å´é‚Šæ¬„åº•éƒ¨ -->
    <div class="mt-auto p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--sidebar-group-title);">{{ t('language') }}</label>
          <app-language-switcher-compact></app-language-switcher-compact>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--sidebar-group-title);">{{ t('appearance') }}</label>
          <div class="flex rounded-md shadow-sm p-1" style="background-color: var(--bg-tertiary);">
            <button (click)="theme.set('light')" 
                    class="w-full text-sm py-1.5 rounded transition-colors flex items-center justify-center gap-2"
                    [style.background-color]="theme() === 'light' ? 'var(--bg-card)' : 'transparent'"
                    [style.color]="theme() === 'light' ? 'var(--primary)' : 'var(--text-muted)'"
                    [style.box-shadow]="theme() === 'light' ? 'var(--shadow-sm)' : 'none'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            </button>
            <button (click)="theme.set('dark')" 
                    class="w-full text-sm py-1.5 rounded transition-colors flex items-center justify-center gap-2"
                    [style.background-color]="theme() === 'dark' ? 'var(--primary-bg)' : 'transparent'"
                    [style.color]="theme() === 'dark' ? 'var(--primary)' : 'var(--text-muted)'"
                    [style.box-shadow]="theme() === 'dark' ? 'var(--shadow-sm)' : 'none'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
              </svg>
            </button>
          </div>
        </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 overflow-y-auto" style="background-color: var(--bg-primary);">
    @switch (currentView()) {
      @case ('dashboard') {
        <h2 class="text-4xl font-bold mb-8" style="color: var(--text-primary);">{{ t('dashboard') }}</h2>
        
        <!-- ğŸš€ ä¸€éµé‹è¡Œä¸­å¿ƒ -->
        <div class="rounded-xl p-6 mb-8" style="background: linear-gradient(to right, var(--primary-bg), rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1)); border: 1px solid var(--primary); box-shadow: var(--shadow-lg);">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <span class="text-3xl">ğŸš€</span>
              <h3 class="text-xl font-bold" style="color: var(--text-primary);">ä¸€éµé‹è¡Œä¸­å¿ƒ</h3>
            </div>
            <button (click)="loadSystemStatus()" class="transition-colors" style="color: var(--text-muted);" title="åˆ·æ–°ç‹€æ…‹">
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            </button>
          </div>
          
          <!-- å¿«é€Ÿç‹€æ…‹æŒ‡ç¤ºå™¨ -->
          @let status = systemStatus();
          <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="rounded-lg p-4 text-center" style="background-color: var(--bg-card);">
              <div class="text-2xl mb-1">ğŸ”‘</div>
              <div class="text-sm" style="color: var(--text-muted);">å¸³è™Ÿåœ¨ç·š</div>
              <div class="text-xl font-bold" [style.color]="status.accounts.online > 0 ? 'var(--success)' : 'var(--error)'">
                {{ status.accounts.online }}/{{ status.accounts.total }}
              </div>
            </div>
            <div class="rounded-lg p-4 text-center" style="background-color: var(--bg-card);">
              <div class="text-2xl mb-1">ğŸ“¡</div>
              <div class="text-sm" style="color: var(--text-muted);">ç›£æ§ç‹€æ…‹</div>
              <div class="text-xl font-bold" [style.color]="isMonitoring() ? 'var(--success)' : 'var(--error)'">
                {{ isMonitoring() ? 'é‹è¡Œä¸­' : 'æœªå•Ÿå‹•' }}
              </div>
            </div>
            <div class="rounded-lg p-4 text-center" style="background-color: var(--bg-card);">
              <div class="text-2xl mb-1">ğŸ¤–</div>
              <div class="text-sm" style="color: var(--text-muted);">AI èŠå¤©</div>
              <div class="text-xl font-bold" [style.color]="status.ai.enabled ? 'var(--success)' : 'var(--error)'">
                {{ status.ai.enabled ? (status.ai.mode === 'full' ? 'å…¨è‡ªå‹•' : 'åŠè‡ªå‹•') : 'æœªå•Ÿç”¨' }}
              </div>
            </div>
          </div>
          
          <!-- ä¸€éµå•Ÿå‹•æŒ‰éˆ• -->
          @if (oneClickStarting()) {
            <div class="bg-slate-800/50 rounded-lg p-4 mb-4">
              <div class="flex items-center gap-3 mb-2">
                <div class="animate-spin h-5 w-5 border-2 border-cyan-500 border-t-transparent rounded-full"></div>
                <span class="text-cyan-300">{{ oneClickMessage() }}</span>
              </div>
              <div class="w-full bg-slate-700 rounded-full h-2">
                <div class="bg-gradient-to-r from-cyan-500 to-purple-500 h-2 rounded-full transition-all duration-300" [style.width.%]="oneClickProgress()"></div>
              </div>
            </div>
          }
          
          <div class="flex gap-4">
            @if (!isMonitoring() || !status.ai.enabled) {
              <button 
                (click)="oneClickStart()" 
                [disabled]="oneClickStarting()"
                class="flex-1 bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-lg flex items-center justify-center gap-2">
                <span class="text-xl">âš¡</span>
                <span>ä¸€éµå…¨éƒ¨å•Ÿå‹•</span>
              </button>
            } @else {
              <button 
                (click)="oneClickStop()" 
                class="flex-1 bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-lg flex items-center justify-center gap-2">
                <span class="text-xl">ğŸ›‘</span>
                <span>ä¸€éµåœæ­¢æ‰€æœ‰</span>
              </button>
            }
          </div>
          
          <!-- è©³ç´°ç‹€æ…‹ï¼ˆå¯å±•é–‹ï¼‰ -->
          <details class="mt-4">
            <summary class="text-slate-400 text-sm cursor-pointer hover:text-white">ğŸ“Š æŸ¥çœ‹è©³ç´°ç‹€æ…‹</summary>
            <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div class="bg-slate-800/30 rounded p-2">
                <span class="text-slate-500">é—œéµè©é›†:</span>
                <span class="text-white ml-1">{{ status.keywords.sets }} å€‹</span>
              </div>
              <div class="bg-slate-800/30 rounded p-2">
                <span class="text-slate-500">ç›£æ§ç¾¤çµ„:</span>
                <span class="text-white ml-1">{{ status.monitoring.groups }} å€‹</span>
              </div>
              <div class="bg-slate-800/30 rounded p-2">
                <span class="text-slate-500">æ´»å‹•è¦å‰‡:</span>
                <span class="text-white ml-1">{{ status.campaigns.active }}/{{ status.campaigns.total }}</span>
              </div>
              <div class="bg-slate-800/30 rounded p-2">
                <span class="text-slate-500">æ¶ˆæ¯æ¨¡æ¿:</span>
                <span class="text-white ml-1">{{ status.templates.active }}/{{ status.templates.total }}</span>
              </div>
            </div>
          </details>
          
          <!-- ğŸš€ å•Ÿå‹•å ±å‘Šé¢æ¿ -->
          @if (showStartReport() && oneClickStartReport()) {
            @let report = oneClickStartReport();
            <div class="mt-4 bg-slate-900/60 rounded-lg border border-slate-700 overflow-hidden">
              <div class="flex items-center justify-between px-4 py-2 bg-slate-800/50 border-b border-slate-700">
                <div class="flex items-center gap-2">
                  <span class="text-lg">{{ report.overall_success ? 'âœ…' : 'âš ï¸' }}</span>
                  <span class="font-semibold text-white">å•Ÿå‹•å ±å‘Š</span>
                </div>
                <button (click)="showStartReport.set(false)" class="text-slate-400 hover:text-white">
                  <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
              <div class="p-4 space-y-3">
                <!-- å¸³è™Ÿç‹€æ…‹ -->
                <div class="flex items-start gap-3">
                  <span class="text-2xl">ğŸ‘¥</span>
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-white">å¸³è™Ÿé€£æ¥</span>
                      <span class="px-2 py-0.5 rounded text-xs {{ report.accounts?.success > 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400' }}">
                        {{ report.accounts?.success || 0 }}/{{ report.accounts?.total || 0 }}
                      </span>
                    </div>
                    @if (report.accounts?.details?.length) {
                      <div class="mt-2 space-y-1 text-sm">
                        @for (acc of report.accounts.details; track acc.phone) {
                          <div class="flex items-center gap-2 text-slate-400">
                            <span>{{ acc.success ? 'âœ“' : 'âœ—' }}</span>
                            <span>{{ acc.phone }}</span>
                            <span class="text-slate-500">{{ acc.message }}</span>
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>
                
                <!-- ç¾¤çµ„ç‹€æ…‹ -->
                @if (report.groups) {
                  <div class="flex items-start gap-3">
                    <span class="text-2xl">ğŸ“¢</span>
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-white">ç¾¤çµ„åŠ å…¥</span>
                        <span class="px-2 py-0.5 rounded text-xs bg-green-500/20 text-green-400">{{ report.groups.success?.length || 0 }} æˆåŠŸ</span>
                        @if (report.groups.pending?.length) {
                          <span class="px-2 py-0.5 rounded text-xs bg-yellow-500/20 text-yellow-400">{{ report.groups.pending.length }} å¾…å¯©æ ¸</span>
                        }
                        @if (report.groups.failed?.length) {
                          <span class="px-2 py-0.5 rounded text-xs bg-red-500/20 text-red-400">{{ report.groups.failed.length }} å¤±æ•—</span>
                        }
                      </div>
                      @if (report.groups.failed?.length) {
                        <div class="mt-2 space-y-1 text-sm">
                          @for (fail of report.groups.failed; track fail.url) {
                            <div class="text-red-400">âœ— {{ fail.url }}: {{ fail.reason }}</div>
                          }
                        </div>
                      }
                    </div>
                  </div>
                }
                
                <!-- ç›£æ§ç‹€æ…‹ -->
                <div class="flex items-start gap-3">
                  <span class="text-2xl">ğŸ‘ï¸</span>
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-white">ç›£æ§æœå‹™</span>
                      <span class="px-2 py-0.5 rounded text-xs {{ report.monitoring?.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400' }}">
                        {{ report.monitoring?.success ? 'å·²å•Ÿå‹•' : 'å•Ÿå‹•å¤±æ•—' }}
                      </span>
                    </div>
                    @if (report.monitoring?.groups) {
                      <div class="text-slate-400 text-sm mt-1">ç›£æ§ {{ report.monitoring.groups }} å€‹ç¾¤çµ„</div>
                    }
                  </div>
                </div>
                
                <!-- AI ç‹€æ…‹ -->
                <div class="flex items-start gap-3">
                  <span class="text-2xl">ğŸ¤–</span>
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-white">AI è‡ªå‹•èŠå¤©</span>
                      <span class="px-2 py-0.5 rounded text-xs {{ report.ai?.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400' }}">
                        {{ report.ai?.success ? 'å…¨è‡ªå‹•æ¨¡å¼' : 'æœªå•Ÿç”¨' }}
                      </span>
                    </div>
                  </div>
                </div>
                
                <!-- æ¼æ–—ç‹€æ…‹ -->
                @if (report.funnel) {
                  <div class="flex items-start gap-3">
                    <span class="text-2xl">ğŸ¯</span>
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-white">æ¼æ–—è‡ªå‹•æµè½‰</span>
                        <span class="px-2 py-0.5 rounded text-xs {{ report.funnel?.success ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400' }}">
                          {{ report.funnel?.success ? 'å·²å•Ÿç”¨' : 'æœªå•Ÿç”¨' }}
                        </span>
                      </div>
                      @if (report.funnel?.success) {
                        <div class="text-slate-400 text-sm mt-1">è‡ªå‹•è·Ÿé€² + éšæ®µåˆ†æ</div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
        
        @let stats = dashboardStats();
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><div class="flex items-center gap-4"><div class="p-3 rounded-full bg-cyan-500/20"><svg class="h-6 w-6 text-cyan-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div><div><h3 class="text-slate-500 dark:text-slate-400 text-sm font-medium">{{ t('totalAccounts') }}</h3><p class="text-3xl font-semibold">{{ stats.totalAccounts }}</p></div></div></div>
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><div class="flex items-center gap-4"><div class="p-3 rounded-full bg-green-500/20"><svg class="h-6 w-6 text-green-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div><div><h3 class="text-slate-500 dark:text-slate-400 text-sm font-medium">{{ t('onlineAccounts') }}</h3><p class="text-3xl font-semibold">{{ stats.onlineAccounts }}</p></div></div></div>
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><div class="flex items-center gap-4"><div class="p-3 rounded-full bg-blue-500/20"><svg class="h-6 w-6 text-blue-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg></div><div><h3 class="text-slate-500 dark:text-slate-400 text-sm font-medium">{{ t('leadsToday') }}</h3><p class="text-3xl font-semibold">{{ stats.leadsToday }}</p></div></div></div>
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><div class="flex items-center gap-4"><div class="p-3 rounded-full bg-purple-500/20"><svg class="h-6 w-6 text-purple-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></div><div><h3 class="text-slate-500 dark:text-slate-400 text-sm font-medium">{{ t('messagesSentToday') }}</h3><p class="text-3xl font-semibold">{{ stats.messagesSentToday }}</p></div></div></div>
        </div>
        
        <!-- æœƒå“¡é…é¡ä½¿ç”¨æƒ…æ³ -->
        <div class="bg-gradient-to-r from-slate-100/50 to-slate-200/50 dark:from-slate-900/50 dark:to-slate-800/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200">
              {{ membershipService.levelIcon() }} é…é¡ä½¿ç”¨æƒ…æ³ 
              <span class="text-sm font-normal text-slate-500">({{ membershipService.levelName() }})</span>
            </h3>
            <button (click)="showMembershipDialog.set(true)" 
                    class="text-sm px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg hover:opacity-90 transition-opacity">
              å‡ç´šæœƒå“¡
            </button>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- è³¬æˆ¶é…é¡ -->
            <div class="bg-white/50 dark:bg-slate-700/50 p-4 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-slate-500">è³¬æˆ¶æ•¸é‡</span>
                <span class="text-xs px-2 py-0.5 rounded-full"
                      [class]="membershipService.quotas().maxAccounts === -1 ? 'bg-emerald-500/20 text-emerald-400' : 
                               (accounts().length >= membershipService.quotas().maxAccounts ? 'bg-red-500/20 text-red-400' : 'bg-cyan-500/20 text-cyan-400')">
                  {{ accounts().length }}/{{ membershipService.quotas().maxAccounts === -1 ? 'âˆ' : membershipService.quotas().maxAccounts }}
                </span>
              </div>
              <div class="h-2 bg-slate-200 dark:bg-slate-600 rounded-full overflow-hidden">
                <div class="h-full transition-all duration-300"
                     [class]="accounts().length >= membershipService.quotas().maxAccounts && membershipService.quotas().maxAccounts !== -1 ? 'bg-red-500' : 'bg-cyan-500'"
                     [style.width.%]="membershipService.quotas().maxAccounts === -1 ? 30 : Math.min((accounts().length / membershipService.quotas().maxAccounts) * 100, 100)"></div>
              </div>
            </div>
            <!-- æ¶ˆæ¯é…é¡ -->
            <div class="bg-white/50 dark:bg-slate-700/50 p-4 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-slate-500">ä»Šæ—¥æ¶ˆæ¯</span>
                <span class="text-xs px-2 py-0.5 rounded-full"
                      [class]="membershipService.quotas().dailyMessages === -1 ? 'bg-emerald-500/20 text-emerald-400' : 
                               (membershipService.usage().todayMessages >= membershipService.quotas().dailyMessages ? 'bg-red-500/20 text-red-400' : 'bg-purple-500/20 text-purple-400')">
                  {{ membershipService.usage().todayMessages }}/{{ membershipService.quotas().dailyMessages === -1 ? 'âˆ' : membershipService.quotas().dailyMessages }}
                </span>
              </div>
              <div class="h-2 bg-slate-200 dark:bg-slate-600 rounded-full overflow-hidden">
                <div class="h-full transition-all duration-300"
                     [class]="membershipService.usage().todayMessages >= membershipService.quotas().dailyMessages && membershipService.quotas().dailyMessages !== -1 ? 'bg-red-500' : 'bg-purple-500'"
                     [style.width.%]="membershipService.quotas().dailyMessages === -1 ? 30 : Math.min((membershipService.usage().todayMessages / membershipService.quotas().dailyMessages) * 100, 100)"></div>
              </div>
            </div>
            <!-- AI é…é¡ -->
            <div class="bg-white/50 dark:bg-slate-700/50 p-4 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-slate-500">ä»Šæ—¥ AI</span>
                <span class="text-xs px-2 py-0.5 rounded-full"
                      [class]="membershipService.quotas().dailyAiCalls === -1 ? 'bg-emerald-500/20 text-emerald-400' : 
                               (membershipService.usage().todayAiCalls >= membershipService.quotas().dailyAiCalls ? 'bg-red-500/20 text-red-400' : 'bg-blue-500/20 text-blue-400')">
                  {{ membershipService.usage().todayAiCalls }}/{{ membershipService.quotas().dailyAiCalls === -1 ? 'âˆ' : membershipService.quotas().dailyAiCalls }}
                </span>
              </div>
              <div class="h-2 bg-slate-200 dark:bg-slate-600 rounded-full overflow-hidden">
                <div class="h-full transition-all duration-300"
                     [class]="membershipService.usage().todayAiCalls >= membershipService.quotas().dailyAiCalls && membershipService.quotas().dailyAiCalls !== -1 ? 'bg-red-500' : 'bg-blue-500'"
                     [style.width.%]="membershipService.quotas().dailyAiCalls === -1 ? 30 : Math.min((membershipService.usage().todayAiCalls / membershipService.quotas().dailyAiCalls) * 100, 100)"></div>
              </div>
            </div>
            <!-- ç¾¤çµ„é…é¡ -->
            <div class="bg-white/50 dark:bg-slate-700/50 p-4 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-slate-500">ç›£æ§ç¾¤çµ„</span>
                <span class="text-xs px-2 py-0.5 rounded-full"
                      [class]="membershipService.quotas().maxGroups === -1 ? 'bg-emerald-500/20 text-emerald-400' : 
                               (monitoredGroups().length >= membershipService.quotas().maxGroups ? 'bg-red-500/20 text-red-400' : 'bg-orange-500/20 text-orange-400')">
                  {{ monitoredGroups().length }}/{{ membershipService.quotas().maxGroups === -1 ? 'âˆ' : membershipService.quotas().maxGroups }}
                </span>
              </div>
              <div class="h-2 bg-slate-200 dark:bg-slate-600 rounded-full overflow-hidden">
                <div class="h-full transition-all duration-300"
                     [class]="monitoredGroups().length >= membershipService.quotas().maxGroups && membershipService.quotas().maxGroups !== -1 ? 'bg-red-500' : 'bg-orange-500'"
                     [style.width.%]="membershipService.quotas().maxGroups === -1 ? 30 : Math.min((monitoredGroups().length / membershipService.quotas().maxGroups) * 100, 100)"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
          <h3 class="text-xl font-semibold mb-4 text-slate-800 dark:text-slate-200">{{ t('systemControl') }}</h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <span class="text-slate-600 dark:text-slate-300">{{ t('monitoringStatus') }} <span [class.text-green-400]="isMonitoring()" [class.text-red-400]="!isMonitoring()" class="font-bold">{{ isMonitoring() ? t('active') : t('inactive') }}</span></span>
              @if(isMonitoring()) {
                <button (click)="stopMonitoring()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-red-500/20">{{ t('stop') }}</button>
              } @else {
                <button (click)="startMonitoring()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-green-500/20">{{ t('start') }}</button>
              }
            </div>
            <div class="flex gap-2">
              <button (click)="checkMonitoringStatus()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1.5 px-3 rounded-lg text-sm transition duration-200">ğŸ” æª¢æŸ¥ç›£æ§ç‹€æ…‹</button>
              <button (click)="checkMonitoringHealth()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1.5 px-3 rounded-lg text-sm transition duration-200">ğŸ¥ å¥åº·æª¢æŸ¥</button>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold mb-4">{{ t('recentLeads') }}</h3>
            <div class="space-y-3">
              @for(lead of leads().slice(0, 5); track lead.id) {
                <div class="bg-slate-200/50 dark:bg-slate-800/50 p-3 rounded-lg"><p class="font-bold text-cyan-600 dark:text-cyan-400">@{{ lead.username }}</p><p class="text-sm text-slate-500 dark:text-slate-400">{{ t('sourceGroup') }}: {{ lead.sourceGroup }}</p></div>
              } @empty { <p class="text-slate-500">{{ t('noRecentActivity') }}</p> }
            </div>
          </div>
          <!-- ä½¿ç”¨å¢å¼·ç‰ˆéšŠåˆ—é€²åº¦çµ„ä»¶ -->
          <app-queue-progress 
            [accountStatuses]="getAccountQueueStatuses()"
            (pauseQueue)="pauseAllQueues()"
            (resumeQueue)="resumeAllQueues()"
            (retryFailed)="retryAllFailed()"
            (refreshStatus)="refreshQueueStatusThrottled()">
          </app-queue-progress>
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold mb-4">{{ t('recentLogs') }}</h3>
            <div class="space-y-2 text-sm font-mono">
              @for(log of logs().slice(0, 5); track trackByLogId($index, log)) {
                <div><span [class]="getLogColor(log.type)">[{{ log.type.toUpperCase() }}]</span><span class="ml-2 text-slate-600 dark:text-slate-400">{{ log.message }}</span></div>
              } @empty { <p class="text-slate-500">{{ t('noRecentActivity') }}</p> }
            </div>
          </div>
        </div>
        
        <!-- ğŸ†• å¿«é€Ÿå·¥ä½œæµå…¥å£ -->
        <div class="mt-8">
          <app-quick-workflow 
            (navigateTo)="handleWorkflowNavigation($event)"
            (workflowCompleted)="onWorkflowCompleted($event)">
          </app-quick-workflow>
        </div>
      }
      @case ('accounts') {
        <!-- å¸³æˆ¶ç®¡ç†é é¢ - ä½¿ç”¨å¡ç‰‡è¦–åœ– -->
        <div class="flex items-center justify-between mb-6">
          <h2 id="accounts-section" class="text-4xl font-bold text-slate-900 dark:text-white">{{ t('manageAccounts') }}</h2>
          <!-- è³¬æˆ¶é…é¡é¡¯ç¤º -->
          <div class="flex items-center gap-3">
            <span class="text-sm text-slate-500">è³¬æˆ¶é…é¡:</span>
            <span class="text-lg font-bold px-3 py-1 rounded-lg"
                  [class]="membershipService.quotas().maxAccounts === -1 ? 'bg-emerald-500/20 text-emerald-400' : 
                           (accounts().length >= membershipService.quotas().maxAccounts ? 'bg-red-500/20 text-red-400' : 'bg-cyan-500/20 text-cyan-400')">
              {{ accounts().length }}/{{ membershipService.quotas().maxAccounts === -1 ? 'âˆ' : membershipService.quotas().maxAccounts }}
            </span>
            @if (membershipService.quotas().maxAccounts !== -1 && accounts().length >= membershipService.quotas().maxAccounts) {
              <button (click)="showMembershipDialog.set(true)" class="text-xs px-3 py-1 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-full hover:opacity-90 transition-opacity">
                å‡ç´šè§£é–æ›´å¤š
              </button>
            }
          </div>
        </div>
        
        <!-- å¿«é€Ÿæ“ä½œå·¥å…·æ¬„ -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-4 rounded-xl shadow-lg mb-6">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex flex-wrap items-center gap-3">
              <!-- æ·»åŠ å¸³æˆ¶ -->
              <button (click)="changeView('add-account')" class="flex items-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                æ·»åŠ å¸³æˆ¶
              </button>
              
              <!-- API æ†‘æ“šæ±  -->
              <button (click)="changeView('api-credentials')" class="flex items-center gap-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-amber-500/20">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                API æ†‘æ“šæ± 
              </button>
              
              <button (click)="openQrLogin()" class="flex items-center gap-2 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-emerald-500/20">
                <span>ğŸ“±</span>
                æƒç¢¼ç™»å…¥
              </button>
              
              <button (click)="importSession()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                <span>ğŸ“¥</span>
                å°å…¥ Session
              </button>
            </div>
            
            <div class="flex items-center gap-3">
              <button (click)="reloadSessionsAndAccounts()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm py-2 px-3 rounded-lg transition duration-200" title="åˆ·æ–°å¸³æˆ¶åˆ—è¡¨">
                <span>ğŸ”„</span>
              </button>
              <button (click)="refreshQueueStatusThrottled()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm py-2 px-3 rounded-lg transition duration-200" title="åˆ·æ–°éšŠåˆ—ç‹€æ…‹">
                <span>ğŸ“Š</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- å¸³æˆ¶å¡ç‰‡åˆ—è¡¨çµ„ä»¶ -->
        <app-account-card-list
          [accounts]="accounts()"
          (addAccount)="goToAddAccount()"
          (accountLogin)="loginAccount($event.id)"
          (accountLogout)="logoutAccount($event.id)"
          (accountRemove)="removeById(accounts, $event.id, 'account')"
          (accountExport)="exportSession($event.phone)"
          (accountEdit)="editAccount($event)">
        </app-account-card-list>
        
        <!-- Queue Details Modal -->
        @if(selectedQueuePhone()) {
          <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-slate-100 dark:bg-slate-900 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden border border-slate-500/20 flex flex-col">
              <div class="p-6 border-b border-slate-300 dark:border-slate-700 flex items-center justify-between">
                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">é˜Ÿåˆ—è¯¦æƒ… - {{ selectedQueuePhone() }}</h3>
                <button (click)="closeQueueDetails()" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 text-2xl font-bold">&times;</button>
              </div>
              <div class="flex-1 overflow-y-auto p-6">
                <div class="mb-4 flex gap-2">
                  <select (change)="getQueueMessages(selectedQueuePhone()!, $any($event.target).value)" class="form-select bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="pending">å¾…å‘é€</option>
                    <option value="processing">å‘é€ä¸­</option>
                    <option value="retrying">é‡è¯•ä¸­</option>
                    <option value="failed">å¤±è´¥</option>
                    <option value="completed">å·²å®Œæˆ</option>
                  </select>
                  <button (click)="getQueueMessages(selectedQueuePhone()!)" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm">åˆ·æ–°</button>
                </div>
                <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-lg overflow-hidden">
                  <table class="w-full text-sm">
                    <thead class="bg-slate-300/50 dark:bg-slate-700/50">
                      <tr>
                        <th class="py-2 px-4 text-left">ID</th>
                        <th class="py-2 px-4 text-left">ç”¨æˆ·ID</th>
                        <th class="py-2 px-4 text-left">æ¶ˆæ¯å†…å®¹</th>
                        <th class="py-2 px-4 text-left">ä¼˜å…ˆçº§</th>
                        <th class="py-2 px-4 text-left">çŠ¶æ€</th>
                        <th class="py-2 px-4 text-left">å°è¯•æ¬¡æ•°</th>
                        <th class="py-2 px-4 text-left">åˆ›å»ºæ—¶é—´</th>
                        <th class="py-2 px-4 text-left">æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for(msg of queueMessages(); track msg.id) {
                        <tr class="border-b border-slate-300 dark:border-slate-700 hover:bg-slate-200/50 dark:hover:bg-slate-700/50">
                          <td class="py-2 px-4 font-mono text-xs">{{ msg.id.substring(0, 8) }}...</td>
                          <td class="py-2 px-4">{{ msg.user_id }}</td>
                          <td class="py-2 px-4 max-w-xs truncate" [title]="msg.text">{{ msg.text }}</td>
                          <td class="py-2 px-4">
                            <select [value]="msg.priority" (change)="updateQueueMessagePriority(selectedQueuePhone()!, msg.id, $any($event.target).value)" class="form-select bg-slate-100 dark:bg-slate-800 border-slate-300 dark:border-slate-600 rounded text-xs p-1">
                              <option value="HIGH">é«˜</option>
                              <option value="NORMAL">ä¸­</option>
                              <option value="LOW">ä½</option>
                            </select>
                          </td>
                          <td class="py-2 px-4">
                            <span class="px-2 py-1 text-xs rounded-full" 
                                  [class.bg-yellow-500/20]="msg.status === 'pending'"
                                  [class.text-yellow-500]="msg.status === 'pending'"
                                  [class.bg-blue-500/20]="msg.status === 'processing'"
                                  [class.text-blue-500]="msg.status === 'processing'"
                                  [class.bg-orange-500/20]="msg.status === 'retrying'"
                                  [class.text-orange-500]="msg.status === 'retrying'"
                                  [class.bg-red-500/20]="msg.status === 'failed'"
                                  [class.text-red-500]="msg.status === 'failed'"
                                  [class.bg-green-500/20]="msg.status === 'completed'"
                                  [class.text-green-500]="msg.status === 'completed'">
                              {{ msg.status === 'pending' ? 'å¾…å‘é€' : msg.status === 'processing' ? 'å‘é€ä¸­' : msg.status === 'retrying' ? 'é‡è¯•ä¸­' : msg.status === 'failed' ? 'å¤±è´¥' : 'å·²å®Œæˆ' }}
                            </span>
                          </td>
                          <td class="py-2 px-4">{{ msg.attempts }} / {{ msg.max_attempts }}</td>
                          <td class="py-2 px-4 text-xs">{{ formatDate(msg.created_at) }}</td>
                          <td class="py-2 px-4">
                            <button (click)="deleteQueueMessage(selectedQueuePhone()!, msg.id)" class="text-red-400 hover:text-red-300 text-sm font-bold">åˆ é™¤</button>
                          </td>
                        </tr>
                      } @empty {
                        <tr>
                          <td colspan="8" class="py-8 text-center text-slate-500">æš‚æ— æ¶ˆæ¯</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        }
        
        <!-- Login Code Dialog -->
        @if(loginState().requiresCode || loginState().isSubmittingCode) {
          <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
            <div class="bg-slate-100 dark:bg-slate-900 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 border border-slate-500/20">
              @if(loginState().isSubmittingCode) {
                <!-- Loading State -->
                <div class="text-center">
                  <div class="mb-4">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500"></div>
                  </div>
                  <h3 class="text-xl font-bold mb-2 text-slate-900 dark:text-white">æ­£åœ¨éªŒè¯éªŒè¯ç ...</h3>
                  <p class="text-sm text-slate-600 dark:text-slate-400">
                    è¯·ç¨å€™ï¼Œæ­£åœ¨éªŒè¯æ‚¨çš„éªŒè¯ç 
                  </p>
                </div>
              } @else {
                <!-- Code Input State -->
                <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">è¾“å…¥éªŒè¯ç </h3>
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
                  éªŒè¯ç å·²å‘é€åˆ° <strong>{{loginState().phone}}</strong>
                </p>
                    <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 mb-4">
                      <p class="text-xs text-amber-800 dark:text-amber-300 font-semibold mb-2">
                        âš ï¸ é‡è¦æç¤ºï¼š
                      </p>
                      <ul class="text-xs text-amber-700 dark:text-amber-400 space-y-1 list-disc list-inside">
                        <li>éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„ Telegram åº”ç”¨ï¼ˆä¸æ˜¯çŸ­ä¿¡ï¼‰</li>
                        <li>è¯·æ£€æŸ¥æ‚¨æ‰‹æœºä¸Šå·²ç™»å½•çš„ Telegram åº”ç”¨ï¼ŒæŸ¥çœ‹éªŒè¯ç æ¶ˆæ¯</li>
                        <li>æ‰“å¼€ Telegram åº”ç”¨ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰æ¥è‡ª Telegram çš„éªŒè¯ç æ¶ˆæ¯</li>
                        <li>å¦‚æœæœªæ”¶åˆ°ï¼Œè¯·ç‚¹å‡»"é‡æ–°å‘é€"æŒ‰é’®ï¼Œç³»ç»Ÿå°†é‡æ–°å‘é€éªŒè¯ç åˆ°æ‚¨çš„ Telegram åº”ç”¨</li>
                      </ul>
                    </div>
                <div class="space-y-4">
                  <input 
                    type="text" 
                    [(ngModel)]="loginCode" 
                    (keyup.enter)="submitLoginCode()"
                    placeholder="è¾“å…¥éªŒè¯ç "
                    class="w-full bg-slate-200/50 dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-lg text-center font-mono tracking-widest"
                    maxlength="6"
                    autofocus>
                  <div class="flex gap-3">
                    <button 
                      (click)="submitLoginCode()" 
                      [disabled]="!loginCode().trim() || loginCode().length < 5"
                      class="flex-1 bg-cyan-500 hover:bg-cyan-600 disabled:bg-slate-400 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                      æäº¤
                    </button>
                    <button 
                      (click)="resendVerificationCode()" 
                      class="px-4 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-900 dark:text-white font-bold py-2 rounded-lg transition duration-200">
                      é‡æ–°å‘é€
                    </button>
                    <button 
                      (click)="cancelLogin()" 
                      class="flex-1 bg-slate-300 dark:bg-slate-700 hover:bg-slate-400 dark:hover:bg-slate-600 text-slate-900 dark:text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                      å–æ¶ˆ
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- Login 2FA Dialog -->
        @if(loginState().requires2FA) {
          <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
            <div class="bg-slate-100 dark:bg-slate-900 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 border border-slate-500/20">
              <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">è¾“å…¥ 2FA å¯†ç </h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
                è´¦æˆ· <strong>{{loginState().phone}}</strong> éœ€è¦ä¸¤æ­¥éªŒè¯å¯†ç 
              </p>
              <div class="space-y-4">
                <input 
                  type="password" 
                  [(ngModel)]="login2FAPassword" 
                  (keyup.enter)="submitLogin2FA()"
                  placeholder="è¾“å…¥ 2FA å¯†ç "
                  class="w-full bg-slate-200/50 dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-lg"
                  autofocus>
                <div class="flex gap-3">
                  <button 
                    (click)="submitLogin2FA()" 
                    class="flex-1 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    æäº¤
                  </button>
                  <button 
                    (click)="cancelLogin()" 
                    class="flex-1 bg-slate-300 dark:bg-slate-700 hover:bg-slate-400 dark:hover:bg-slate-600 text-slate-900 dark:text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    å–æ¶ˆ
                  </button>
                </div>
              </div>
            </div>
          </div>
        }
      }
      @case ('add-account') {
        <!-- æ·»åŠ å¸³æˆ¶é é¢ -->
        <app-add-account-page
          (back)="changeView('accounts')"
          (accountAdded)="onAccountAdded($event)">
        </app-add-account-page>
      }
      @case ('api-credentials') {
        <!-- API æ†‘æ“šæ± ç®¡ç†é é¢ -->
        <div class="mb-4">
          <button (click)="changeView('accounts')" class="flex items-center gap-2 text-sm text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 transition-colors">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            è¿”å›å¸³è™Ÿç®¡ç†
          </button>
        </div>
        <app-api-credential-manager></app-api-credential-manager>
      }
      @case ('resources') {
        <!-- èµ„æºå‘ç°é¡µé¢ -->
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ”</span> {{ t('resourceDiscoveryTitle') }}
        </h2>
        
        <!-- Tab å¯¼èˆª -->
        <div class="flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-lg w-fit">
          <button (click)="resourcesTab.set('resources')" 
                  [class]="resourcesTab() === 'resources' ? 'bg-cyan-500/30 text-cyan-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ”</span> {{ t('groupsAndChannels') }}
          </button>
          <button (click)="resourcesTab.set('discussions'); loadChannelDiscussions(); refreshDiscussionStats()" 
                  [class]="resourcesTab() === 'discussions' ? 'bg-cyan-500/30 text-cyan-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ’¬</span> {{ t('discussionMonitor') }}
          </button>
        </div>
        
        @if (resourcesTab() === 'resources') {
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-blue-500/30 p-4 rounded-xl text-center">
            <div class="text-3xl mb-2">ğŸ“Š</div>
            <div class="text-2xl font-bold text-blue-400">{{ resourceStats().total_resources }}</div>
            <div class="text-sm text-slate-400">{{ t('totalResources') }}</div>
          </div>
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-green-500/30 p-4 rounded-xl text-center">
            <div class="text-3xl mb-2">ğŸ†•</div>
            <div class="text-2xl font-bold text-green-400">{{ resourceStats().today_discovered }}</div>
            <div class="text-sm text-slate-400">{{ t('todayDiscovered') }}</div>
          </div>
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-yellow-500/30 p-4 rounded-xl text-center">
            <div class="text-3xl mb-2">ğŸ“‹</div>
            <div class="text-2xl font-bold text-yellow-400">{{ resourceStats().pending_joins }}</div>
            <div class="text-sm text-slate-400">{{ t('pendingJoins') }}</div>
          </div>
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-emerald-500/30 p-4 rounded-xl text-center">
            <div class="text-3xl mb-2">âœ…</div>
            <div class="text-2xl font-bold text-emerald-400">{{ resourceStats().joined_count }}</div>
            <div class="text-sm text-slate-400">{{ t('joinedCount') }}</div>
          </div>
        </div>
        
        <!-- æ“ä½œåŒº -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-6">
          <!-- ä½¿ç”¨è´¦å·é€‰æ‹©å™¨ -->
          <div class="flex items-center gap-4 mb-4 bg-slate-800/50 p-3 rounded-xl border border-slate-700/50">
            <div class="flex items-center gap-2">
              <span class="text-slate-400 text-sm">{{ t('useAccount') }}:</span>
              @if (getSelectedResourceAccount(); as account) {
                <div class="relative">
                  <button (click)="showResourceAccountSelector.set(!showResourceAccountSelector())"
                          class="flex items-center gap-2 px-3 py-2 bg-slate-700/50 hover:bg-slate-600/50 rounded-lg border border-slate-600/50 transition-all">
                    <span class="w-2 h-2 rounded-full" [class.bg-green-400]="account.status === 'Online'" [class.bg-slate-400]="account.status !== 'Online'"></span>
                    <span class="font-mono text-sm text-white">{{ account.phone }}</span>
                    <span class="text-xs px-1.5 py-0.5 rounded" 
                          [style.background]="account.role === 'Explorer' ? 'rgba(245, 158, 11, 0.2)' : account.role === 'Listener' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(59, 130, 246, 0.2)'"
                          [style.color]="account.role === 'Explorer' ? '#f59e0b' : account.role === 'Listener' ? '#22c55e' : '#3b82f6'">
                      {{ getRoleDisplayName(account.role) }}
                    </span>
                    <span class="text-slate-400 text-xs">â–¼</span>
                  </button>
                  
                  <!-- è´¦å·ä¸‹æ‹‰é€‰æ‹©å™¨ -->
                  @if (showResourceAccountSelector()) {
                    <div class="absolute top-full left-0 mt-1 w-64 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-50 overflow-hidden">
                      <div class="p-2 border-b border-slate-700 text-xs text-slate-400">{{ t('selectAccount') }}</div>
                      <div class="max-h-60 overflow-y-auto">
                        @for (acc of getResourceDiscoveryAccounts(); track acc.id) {
                          <button (click)="selectResourceAccount(acc.id)"
                                  class="w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-700/50 transition-all text-left"
                                  [class.bg-cyan-500/10]="acc.id === resourceAccountId() || (!resourceAccountId() && acc.id === getSelectedResourceAccount()?.id)">
                            <span class="w-2 h-2 rounded-full bg-green-400"></span>
                            <span class="font-mono text-sm text-white flex-1">{{ acc.phone }}</span>
                            <span class="text-xs">{{ getRoleDisplayName(acc.role) }}</span>
                            @if (acc.id === resourceAccountId() || (!resourceAccountId() && acc.id === getSelectedResourceAccount()?.id)) {
                              <span class="text-green-400">âœ“</span>
                            }
                          </button>
                        }
                        @if (getResourceDiscoveryAccounts().length === 0) {
                          <div class="px-3 py-4 text-center text-slate-400 text-sm">
                            {{ t('noOnlineAccount') }}<br>
                            <span class="text-xs">{{ t('goToAccountManagement') }}</span>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <span class="text-red-400 text-sm px-3 py-2 bg-red-500/10 rounded-lg border border-red-500/30">
                  âš ï¸ {{ t('noAvailableAccount') }}
                </span>
              }
            </div>
            
            <div class="h-6 w-px bg-slate-600"></div>
            
            <span class="px-3 py-1.5 rounded-lg text-sm" [class]="resourceDiscoveryInitialized() ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'">
              {{ resourceDiscoveryInitialized() ? 'ğŸŸ¢ ' + t('systemOnline') : 'ğŸ”´ ' + t('notInitialized') }}
            </span>
          </div>

          <!-- æ“ä½œæŒ‰é’®å€åŸŸå·²ç§»è‡³ç¯©é¸å™¨æ—é‚Š -->
          
          <!-- èµ„æºæ‰¹é‡æ“ä½œå·¥å…·æ  -->
          @if (showResourceBatchMenu() || hasSelectedResources()) {
            <div class="mb-4 bg-purple-500/10 border border-purple-500/20 rounded-xl p-4">
              <div class="flex flex-wrap items-center gap-3">
                <!-- é€‰æ‹©ä¿¡æ¯ -->
                <div class="flex items-center gap-3">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" [checked]="selectedResourceIds().length === discoveredResources().length && discoveredResources().length > 0" 
                           (change)="toggleSelectAllResources()" 
                           class="w-4 h-4 rounded border-purple-400 text-purple-500 focus:ring-purple-500">
                    <span class="text-sm text-purple-400">{{ t('selectAllResources') }}</span>
                  </label>
                  <span class="text-sm text-slate-400">{{ t('selectedResources') }} <span class="font-bold text-purple-400">{{ selectedResourceCount() }}</span> {{ t('resourcesUnit') }}</span>
                  @if (hasSelectedResources()) {
                    <button (click)="selectedResourceIds.set([])" class="text-xs text-slate-400 hover:text-slate-300 underline">{{ t('clearSelection') }}</button>
                  }
                </div>
                
                <div class="h-6 w-px bg-slate-600"></div>
                
                <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
                @if (hasSelectedResources()) {
                  <button (click)="batchApproveResources()" class="flex items-center gap-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 text-sm px-3 py-1.5 rounded-lg">
                    âœ… {{ t('batchApprove') }}
                  </button>
                  <button (click)="batchRejectResources()" class="flex items-center gap-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 text-sm px-3 py-1.5 rounded-lg">
                    âŒ {{ t('batchReject') }}
                  </button>
                  <div class="relative">
                    <select (change)="batchSetResourcePriority($any($event.target).value); $any($event.target).value = ''" 
                            class="bg-yellow-500/20 border border-yellow-500/30 text-yellow-400 text-sm rounded-lg px-3 py-1.5 appearance-none cursor-pointer hover:bg-yellow-500/30">
                      <option value="" disabled selected>â­ {{ t('batchSetPriority') }}</option>
                      <option value="high">{{ t('highPriority') }}</option>
                      <option value="medium">{{ t('mediumPriority') }}</option>
                      <option value="low">{{ t('lowPriority') }}</option>
                    </select>
                  </div>
                  <button (click)="batchDeleteResources()" class="flex items-center gap-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 text-sm px-3 py-1.5 rounded-lg border border-red-500/30">
                    ğŸ—‘ï¸ {{ t('batchDelete') }}
                  </button>
                  <!-- æ‰¹é‡åŠ å…¥ -->
                  <button (click)="batchJoinSelected()" class="flex items-center gap-1 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 text-sm px-3 py-1.5 rounded-lg">
                    ğŸš€ {{ t('batchJoin') }}
                  </button>
                  <button (click)="addSelectedToJoinQueue()" class="flex items-center gap-1 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 text-sm px-3 py-1.5 rounded-lg">
                    ğŸ“‹ {{ t('addToQueue') }}
                  </button>
                }
              </div>
            </div>
          }
          
          <!-- æœç´¢æ¡† -->
          <div class="flex gap-3 mb-4">
            <input type="text" [(ngModel)]="resourceSearchQuery" (keyup.enter)="searchResources()"
                   [placeholder]="t('searchPlaceholder')"
                   class="flex-1 bg-slate-700/50 border border-slate-600 rounded-lg py-3 px-4 text-white focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500">
            <button (click)="showSearchOptions.set(!showSearchOptions())" 
                    class="px-4 py-3 bg-slate-600/50 hover:bg-slate-600 text-slate-300 rounded-lg transition-all border border-slate-500/30"
                    [title]="t('searchOptions')">
              âš™ï¸
            </button>
            <button (click)="searchResources()" [disabled]="isSearchingResources()"
                    class="px-6 py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg transition-all disabled:opacity-50 font-medium">
              {{ isSearchingResources() ? 'ğŸ” ' + t('searching') : 'ğŸ” ' + t('search') }}
            </button>
          </div>
          
          <!-- æœç´¢æ¨¡å¼é€‰é¡¹ -->
          <div class="flex items-center gap-4 mb-4 text-sm flex-wrap">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" [checked]="searchReplaceMode()" (change)="searchReplaceMode.set(!searchReplaceMode())"
                     class="w-4 h-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-500">
              <span class="text-slate-300">{{ t('replaceMode') }}</span>
              <span class="text-slate-500 text-xs">ï¼ˆ{{ t('replaceModeHint') }}ï¼‰</span>
            </label>
          </div>
          
          <!-- ğŸ” å¤šæ¸ é“é€‰æ‹©é¢æ¿ -->
          <div class="bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-lg p-4 mb-4 border border-blue-500/30">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-lg">ğŸ”—</span>
              <span class="font-semibold text-white">{{ t('searchChannelSelect') }}</span>
              <span class="text-xs text-slate-400">ï¼ˆ{{ t('canMultiSelect') }}ï¼‰</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <!-- å®˜æ–¹æœç´¢ -->
              <label class="flex items-center gap-2 p-3 bg-slate-800/50 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-all border-2"
                     [class.border-cyan-500]="selectedSearchSources().includes('telegram')"
                     [class.border-slate-700]="!selectedSearchSources().includes('telegram')">
                <input type="checkbox" 
                       [checked]="selectedSearchSources().includes('telegram')"
                       (change)="toggleSearchSource('telegram')"
                       class="rounded text-cyan-500 focus:ring-cyan-500">
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <span>ğŸ“±</span>
                    <span class="font-medium text-sm">{{ t('officialSearch') }}</span>
                  </div>
                </div>
              </label>
              
              <!-- ä¸­æ–‡æœç´¢ -->
              <label class="flex items-center gap-2 p-3 bg-slate-800/50 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-all border-2"
                     [class.border-cyan-500]="selectedSearchSources().includes('jiso')"
                     [class.border-slate-700]="!selectedSearchSources().includes('jiso')">
                <input type="checkbox" 
                       [checked]="selectedSearchSources().includes('jiso')"
                       (change)="toggleSearchSource('jiso')"
                       class="rounded text-cyan-500 focus:ring-cyan-500">
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <span>ğŸ”</span>
                    <span class="font-medium text-sm">{{ t('chineseSearch') }}</span>
                  </div>
                </div>
              </label>
              
              <!-- TGStatæ•¸æ“šåˆ†æ -->
              <label class="flex items-center gap-2 p-3 bg-slate-800/50 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-all border-2"
                     [class.border-cyan-500]="selectedSearchSources().includes('tgstat')"
                     [class.border-slate-700]="!selectedSearchSources().includes('tgstat')">
                <input type="checkbox" 
                       [checked]="selectedSearchSources().includes('tgstat')"
                       (change)="toggleSearchSource('tgstat')"
                       class="rounded text-cyan-500 focus:ring-cyan-500">
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <span>ğŸ“Š</span>
                    <span class="font-medium text-sm">{{ t('tgstatAnalysis') }}</span>
                  </div>
                </div>
              </label>
              
              <!-- æœ¬åœ°ç´¢å¼• -->
              <label class="flex items-center gap-2 p-3 bg-slate-800/50 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-all border-2"
                     [class.border-cyan-500]="selectedSearchSources().includes('local')"
                     [class.border-slate-700]="!selectedSearchSources().includes('local')">
                <input type="checkbox" 
                       [checked]="selectedSearchSources().includes('local')"
                       (change)="toggleSearchSource('local')"
                       class="rounded text-cyan-500 focus:ring-cyan-500">
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <span>ğŸ’¾</span>
                    <span class="font-medium text-sm">{{ t('localIndex') }}</span>
                  </div>
                </div>
              </label>
            </div>
            <div class="mt-3 flex items-center justify-between">
              <span class="text-xs text-slate-400">
                {{ t('selectedChannels') }} {{ selectedSearchSources().length }} {{ t('channels') }}
              </span>
              <div class="flex items-center gap-3">
                <button (click)="selectAllSearchSources()" class="text-xs text-cyan-400 hover:text-cyan-300">
                  {{ t('selectAll') }}
                </button>
                <button (click)="openChannelManageDialog()" class="text-xs text-purple-400 hover:text-purple-300 flex items-center gap-1">
                  <span>âš™ï¸</span>
                  <span>ç®¡ç†æ¸ é“</span>
                </button>
              </div>
            </div>
          </div>
          
          <!-- æœç´¢é€‰é¡¹é¢æ¿ -->
          @if (showSearchOptions()) {
            <div class="bg-slate-800/50 rounded-lg p-4 mb-4 border border-slate-600/50">
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm text-slate-400 mb-1">{{ t('resourceTypeLabel') }}</label>
                  <select [ngModel]="resourceSearchType()" (ngModelChange)="resourceSearchType.set($event)"
                          class="w-full bg-slate-700/50 border border-slate-600 rounded-lg py-2 px-3 text-white">
                    <option value="all">{{ t('allTypes') }}</option>
                    <option value="group">{{ t('group') }}</option>
                    <option value="supergroup">{{ t('supergroup') }}</option>
                    <option value="channel">{{ t('channel') }}</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">{{ t('minMembers') }}</label>
                  <input type="number" [ngModel]="resourceMinMembers()" (ngModelChange)="resourceMinMembers.set($event)"
                         min="0" step="100" placeholder="0"
                         class="w-full bg-slate-700/50 border border-slate-600 rounded-lg py-2 px-3 text-white">
                </div>
                <div class="flex items-end">
                  <button (click)="resourceSearchType.set('all'); resourceMinMembers.set(0)"
                          class="px-4 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-all">
                    {{ t('resetFilter') }}
                  </button>
                </div>
              </div>
            </div>
          }
          
        </div>
        
        <!-- è³‡æºåˆ—è¡¨ -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
          <!-- è¿‡æ»¤å™¨å’Œæ“ä½œæŒ‰é’® -->
          <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
            <div class="flex items-center gap-2 flex-wrap">
              <!-- ç¯©é¸å™¨ -->
              <select [(ngModel)]="resourceFilterStatus" (ngModelChange)="resourceFilterStatus.set($event); loadResources()" 
                      class="bg-slate-700/50 border border-slate-600 rounded-lg py-2 px-3 text-white text-sm">
                <option value="">{{ t('allStatus') }}</option>
                <option value="discovered">{{ t('discovered') }}</option>
                <option value="queued">{{ t('queued') }}</option>
                <option value="joined">{{ t('joined') }}</option>
                <option value="blocked">{{ t('blocked') }}</option>
              </select>
              <select [(ngModel)]="resourceFilterType" (ngModelChange)="resourceFilterType.set($event); loadResources()"
                      class="bg-slate-700/50 border border-slate-600 rounded-lg py-2 px-3 text-white text-sm">
                <option value="">{{ t('allTypes') }}</option>
                <option value="group">ğŸ‘¥ {{ t('group') }}</option>
                <option value="supergroup">ğŸ‘¥ {{ t('supergroup') }}</option>
                <option value="channel">ğŸ“¢ {{ t('channel') }}</option>
                <option value="bot">ğŸ¤– {{ t('bot') || 'æ©Ÿå™¨äºº' }}</option>
              </select>
              <select [(ngModel)]="resourceFilterLink" (ngModelChange)="resourceFilterLink.set($event); filterResourcesByLink()"
                      class="bg-slate-700/50 border border-slate-600 rounded-lg py-2 px-3 text-white text-sm">
                <option value="">{{ t('allLinks') || 'å…¨éƒ¨éˆæ¥' }}</option>
                <option value="has_link">âœ… {{ t('hasLink') || 'æœ‰å…¬é–‹éˆæ¥' }}</option>
                <option value="no_link">âš ï¸ {{ t('noLink') || 'ç„¡å…¬é–‹éˆæ¥' }}</option>
              </select>
              
              <div class="h-6 w-px bg-slate-600 mx-1"></div>
              
              <!-- æ“ä½œæŒ‰éˆ• -->
              <button (click)="initResourceDiscovery()" 
                      [disabled]="!getSelectedResourceAccount()"
                      class="px-3 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg transition-all text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                      title="{{ t('initResourceDiscovery') }}">
                ğŸš€ {{ t('initResourceDiscovery') }}
              </button>
              <button (click)="processJoinQueue()" [disabled]="isProcessingJoinQueue() || resourceStats().pending_joins === 0"
                      class="px-3 py-2 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded-lg transition-all text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                      title="{{ t('processJoinQueue') }}">
                {{ isProcessingJoinQueue() ? 'â³' : 'ğŸš€' }} {{ t('processJoinQueue') }}
              </button>
              <button (click)="refreshAllResources()" [disabled]="isRefreshing()" 
                      class="px-3 py-2 bg-slate-500/20 hover:bg-slate-500/30 text-slate-400 rounded-lg transition-all text-sm disabled:opacity-50"
                      title="{{ t('refresh') }}">
                ğŸ”„ {{ t('refresh') }}
              </button>
              <button (click)="clearSearchResults()" 
                      class="px-3 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-all text-sm"
                      title="{{ t('clearResults') }}">
                ğŸ—‘ï¸ {{ t('clearResults') }}
              </button>
              <button (click)="showResourceBatchMenu.set(!showResourceBatchMenu())" 
                      class="px-3 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg transition-all text-sm"
                      [class.ring-2]="hasSelectedResources()"
                      [class.ring-purple-500]="hasSelectedResources()"
                      title="{{ t('batchOperation') }}">
                ğŸ“¦ {{ t('batchOperation') }}
                @if (hasSelectedResources()) {
                  <span class="ml-1 bg-purple-500 text-white text-xs px-1.5 py-0.5 rounded-full">{{ selectedResourceCount() }}</span>
                }
              </button>
            </div>
            
            @if (selectedResourceIds().length > 0) {
              <div class="flex items-center gap-3 flex-wrap">
                <span class="text-sm text-slate-400 font-medium">{{ t('selected') }} {{ selectedResourceIds().length }} {{ t('groupsUnit') }}</span>
                
                <!-- æ‰¹é‡æ“ä½œæŒ‰é’®ç»„ -->
                <div class="flex items-center gap-2 flex-wrap">
                  <!-- è¿›å…¥ç¾¤ç»„æŸ¥çœ‹æˆå‘˜ -->
                  <button (click)="batchEnterGroups()" 
                          class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg border border-cyan-500/30 transition-all flex items-center gap-2"
                          [title]="t('enterGroup')">
                    <span>ğŸ‘¥</span>
                    <span>{{ t('enterGroup') }}</span>
                  </button>
                  
                  <!-- æ‰¹é‡åŠ å…¥ -->
                  <div class="relative group">
                    <button (click)="showBatchJoinMenu.set(!showBatchJoinMenu())" 
                            class="px-4 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg border border-green-500/30 transition-all flex items-center gap-2">
                      <span>ğŸš€</span>
                      <span>{{ t('batchJoin') }}</span>
                      <span class="text-xs">â–¼</span>
                    </button>
                    @if (showBatchJoinMenu()) {
                      <div class="absolute right-0 top-full mt-1 bg-slate-800 rounded-lg shadow-xl border border-slate-700 py-2 min-w-48 z-10"
                           (click)="$event.stopPropagation()">
                        <button (click)="addSelectedToJoinQueue(); showBatchJoinMenu.set(false)"
                                class="w-full text-left px-4 py-2 hover:bg-slate-700 transition-colors flex items-center gap-2">
                          <span>ğŸ“‹</span>
                          <span>{{ t('addToQueue') }}</span>
                        </button>
                        <button (click)="batchJoinSelected(); showBatchJoinMenu.set(false)"
                                class="w-full text-left px-4 py-2 hover:bg-slate-700 transition-colors flex items-center gap-2">
                          <span>âœ…</span>
                          <span>{{ t('joinNow') }}</span>
                        </button>
                        <button (click)="batchJoinAndMonitor(); showBatchJoinMenu.set(false)"
                                class="w-full text-left px-4 py-2 hover:bg-slate-700 transition-colors flex items-center gap-2">
                          <span>ğŸ¯</span>
                          <span>{{ t('joinAndMonitor') }}</span>
                        </button>
                      </div>
                    }
                  </div>
                  
                  <!-- æ‰¹é‡ç¾¤å‘ -->
                  <button (click)="showBatchMessageDialog.set(true)" 
                          [disabled]="!membershipService.hasFeature('batchOperations')"
                          class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg border border-purple-500/30 transition-all flex items-center gap-2 disabled:opacity-50"
                          [title]="t('batchSend')">
                    <span>ğŸ“¨</span>
                    <span>{{ t('batchSend') }}</span>
                    @if (!membershipService.hasFeature('batchOperations')) {
                      <span class="text-xs">ğŸ”’</span>
                    }
                  </button>
                  
                  <!-- æ‰¹é‡æ‹‰ç¾¤ -->
                  <button (click)="showBatchInviteDialog.set(true)" 
                          [disabled]="!membershipService.hasFeature('batchOperations')"
                          class="px-4 py-2 bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 rounded-lg border border-orange-500/30 transition-all flex items-center gap-2 disabled:opacity-50"
                          [title]="t('batchInvite')">
                    <span>â•</span>
                    <span>{{ t('batchInvite') }}</span>
                    @if (!membershipService.hasFeature('batchOperations')) {
                      <span class="text-xs">ğŸ”’</span>
                    }
                  </button>
                </div>
              </div>
            }
          </div>
          
          <!-- ğŸ¯ å¿«æ·æ“ä½œæ¬„ï¼ˆé¸æ“‡è³‡æºå¾Œé¡¯ç¤ºï¼‰ -->
          @if (selectedResourceIds().length > 0) {
            <div class="mb-4 bg-gradient-to-r from-cyan-500/10 via-purple-500/10 to-pink-500/10 border border-cyan-500/30 rounded-xl p-4">
              <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3 flex-wrap">
                  <span class="text-lg font-bold text-white">âš¡ å¿«æ·æ“ä½œ</span>
                  <span class="px-3 py-1 bg-cyan-500/20 text-cyan-400 rounded-full text-sm font-medium">
                    å·²é¸ {{ selectedResourceIds().length }} å€‹
                  </span>
                  <!-- é »é“çµ±è¨ˆæç¤º -->
                  @if (getSelectedChannelCount() > 0) {
                    <span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded-full text-xs flex items-center gap-1">
                      ğŸ“¢ {{ getSelectedChannelCount() }} å€‹é »é“
                    </span>
                  }
                  @if (getSelectedGroupCount() > 0) {
                    <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded-full text-xs flex items-center gap-1">
                      ğŸ‘¥ {{ getSelectedGroupCount() }} å€‹ç¾¤çµ„
                    </span>
                  }
                  <button (click)="selectedResourceIds.set([])" class="text-xs text-slate-400 hover:text-white underline">
                    æ¸…é™¤
                  </button>
                </div>
                
                <div class="flex items-center gap-2 flex-wrap">
                  <!-- ğŸš€ æ‰¹é‡åŠ å…¥ä¸¦ç›£æ§ -->
                  <button (click)="openBatchJoinMonitorDialog()"
                          class="px-5 py-2.5 bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600 text-white rounded-xl font-medium shadow-lg shadow-cyan-500/25 flex items-center gap-2 transition-all transform hover:scale-105">
                    <span class="text-lg">ğŸš€</span>
                    <span>æ‰¹é‡åŠ å…¥</span>
                  </button>
                  
                  <!-- ğŸ‘¥ æå–æˆå“¡ - é »é“æ™‚ç¦ç”¨ -->
                  @if (getSelectedChannelCount() === selectedResourceIds().length) {
                    <button [disabled]="true"
                            class="px-4 py-2.5 bg-slate-500/20 text-slate-500 rounded-xl font-medium border border-slate-500/30 flex items-center gap-2 cursor-not-allowed"
                            title="é »é“ç„¡æ³•æå–æˆå“¡">
                      <span>ğŸ‘¥</span>
                      <span>æå–æˆå“¡</span>
                      <span>ğŸ”’</span>
                    </button>
                  } @else {
                    <button (click)="openBatchMemberExtractDialog()"
                            class="px-4 py-2.5 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded-xl font-medium border border-blue-500/30 flex items-center gap-2 transition-all">
                      <span>ğŸ‘¥</span>
                      <span>æå–æˆå“¡</span>
                      @if (getSelectedChannelCount() > 0) {
                        <span class="text-xs text-orange-400">(åƒ…ç¾¤çµ„)</span>
                      }
                    </button>
                  }
                  
                  <!-- ğŸ“¨ æ‰¹é‡ç¾¤ç™¼ - é »é“æ™‚ç¦ç”¨ -->
                  @if (getSelectedChannelCount() === selectedResourceIds().length) {
                    <button [disabled]="true"
                            class="px-4 py-2.5 bg-slate-500/20 text-slate-500 rounded-xl font-medium border border-slate-500/30 flex items-center gap-2 cursor-not-allowed"
                            title="é »é“ç„¡æ³•ç™¼é€æ¶ˆæ¯">
                      <span>ğŸ“¨</span>
                      <span>æ‰¹é‡ç¾¤ç™¼</span>
                      <span>ğŸ”’</span>
                    </button>
                  } @else {
                    <button (click)="openBatchMessageWithFilter()"
                            [disabled]="!membershipService.hasFeature('batchOperations')"
                            class="px-4 py-2.5 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-xl font-medium border border-purple-500/30 flex items-center gap-2 transition-all disabled:opacity-50">
                      <span>ğŸ“¨</span>
                      <span>æ‰¹é‡ç¾¤ç™¼</span>
                      @if (getSelectedChannelCount() > 0) {
                        <span class="text-xs text-orange-400">(åƒ…ç¾¤çµ„)</span>
                      }
                      @if (!membershipService.hasFeature('batchOperations')) {
                        <span class="text-xs">ğŸ”’</span>
                      }
                    </button>
                  }
                </div>
              </div>
              
              <!-- é »é“è­¦å‘Šæç¤º -->
              @if (getSelectedChannelCount() > 0 && getSelectedGroupCount() > 0) {
                <div class="mt-3 p-2 bg-orange-500/10 border border-orange-500/30 rounded-lg text-sm text-orange-400 flex items-center gap-2">
                  <span>âš ï¸</span>
                  <span>å·²é¸æ“‡çš„è³‡æºä¸­åŒ…å« {{ getSelectedChannelCount() }} å€‹é »é“ï¼Œéƒ¨åˆ†æ“ä½œå°‡è‡ªå‹•è·³éé »é“</span>
                </div>
              }
            </div>
          }
          
          <!-- è¡¨æ ¼ -->
          <div class="overflow-x-auto" (click)="closeResourceMenu()">
            @if (discoveredResources().length === 0) {
              <div class="text-center py-12 text-slate-500">
                <div class="text-5xl mb-4">ğŸ”</div>
                <p class="text-lg">{{ t('noResourcesFound') }}</p>
                <p class="text-sm mt-2">{{ t('useSearchAbove') }}</p>
              </div>
            } @else {
              <table class="w-full">
                <thead class="text-slate-400 text-left bg-slate-800/50">
                  <tr>
                    <th class="p-3 w-10">
                      <input type="checkbox" [checked]="selectedResourceIds().length === discoveredResources().length && discoveredResources().length > 0"
                             (change)="toggleSelectAllResources()" class="form-checkbox rounded text-cyan-500">
                    </th>
                    <th class="p-3">{{ t('resourceType') }}</th>
                    <th class="p-3">{{ t('resourceTitle') }}</th>
                    <th class="p-3">{{ t('memberCount') }}</th>
                    <th class="p-3">è¦æ¨¡</th>
                    <th class="p-3 min-w-[280px]">{{ t('resourceActions') }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (resource of discoveredResources(); track resource.id) {
                    <tr class="border-b border-slate-700/50 hover:bg-slate-700/30 transition-colors">
                      <td class="p-3">
                        <input type="checkbox" [checked]="selectedResourceIds().includes(resource.id)"
                               (change)="toggleResourceSelection(resource.id)" class="form-checkbox rounded text-cyan-500">
                      </td>
                      <td class="p-3">
                        <div class="flex flex-col gap-1">
                          <div class="flex items-center gap-1.5">
                            <!-- é¡å‹åœ–æ¨™å’Œæ¨™ç±¤ -->
                            <span class="text-base">{{ getResourceTypeStyle(resource.resource_type).icon }}</span>
                            <span class="px-1.5 py-0.5 rounded text-xs" 
                                  [class]="getResourceTypeStyle(resource.resource_type).bgClass + ' ' + getResourceTypeStyle(resource.resource_type).textClass">
                              {{ getResourceTypeStyle(resource.resource_type).label }}
                            </span>
                            <!-- é©—è­‰é¡å‹æŒ‰éˆ• -->
                            <button (click)="verifyResourceType(resource); $event.stopPropagation()" 
                                    class="text-slate-500 hover:text-cyan-400 transition-colors p-0.5" 
                                    title="é©—è­‰é¡å‹ï¼ˆé€šé Telegram APIï¼‰">
                              ğŸ”„
                            </button>
                          </div>
                          <!-- é »é“é™åˆ¶æç¤º -->
                          @if (isChannel(resource)) {
                            <span class="text-xs text-purple-400/70 flex items-center gap-0.5" title="é »é“ç„¡æ³•ç™¼é€æ¶ˆæ¯å’Œæå–æˆå“¡">
                              ğŸ”’ åƒ…è¨‚é–±
                            </span>
                          }
                        </div>
                      </td>
                      <td class="p-3">
                        <div class="flex items-start gap-2">
                          <div class="flex-1 min-w-0">
                            <!-- æ¨™é¡Œè¡Œ -->
                            <div class="font-medium text-white truncate max-w-sm" [title]="resource.title">{{ resource.title }}</div>
                            <!-- éˆæ¥ç‹€æ…‹è¡Œ -->
                            <div class="flex items-center gap-2 mt-0.5">
                              @if (resource.username) {
                                <button (click)="copyUsername(resource.username); $event.stopPropagation()" 
                                        class="text-xs text-cyan-400 hover:text-cyan-300 cursor-pointer transition-colors"
                                        title="é»æ“Šè¤‡è£½ç”¨æˆ¶å">
                                  &#64;{{ resource.username }}
                                </button>
                              } @else {
                                <span class="text-xs text-orange-400/80" 
                                      title="æ­¤ç¾¤çµ„æ²’æœ‰å…¬é–‹éˆæ¥">
                                  ç„¡å…¬é–‹éˆæ¥
                                </span>
                              }
                            </div>
                            <!-- æè¿°é è¦½ -->
                            @if (resource.description) {
                              <div class="text-xs text-slate-500 truncate max-w-sm mt-0.5" [title]="resource.description">
                                ğŸ“ {{ resource.description | slice:0:60 }}{{ resource.description.length > 60 ? '...' : '' }}
                              </div>
                            }
                          </div>
                        </div>
                      </td>
                      <td class="p-3">
                        <span class="text-slate-300 font-medium">{{ formatMemberCount(resource.member_count) }}</span>
                        <span class="text-xs text-slate-500 ml-1">{{ t('person') }}</span>
                      </td>
                      <td class="p-3">
                        <div class="flex items-center gap-2">
                          <!-- è¦æ¨¡ç­‰ç´šæ¨™ç±¤ï¼ˆåŸºæ–¼æˆå“¡æ•¸ï¼‰ -->
                          <span class="px-2 py-0.5 text-xs font-bold rounded border"
                                [class]="getSizeGrade(resource.member_count).bgColor + ' ' + getSizeGrade(resource.member_count).color"
                                [title]="'è¦æ¨¡ç­‰ç´šï¼š' + getSizeGrade(resource.member_count).label">
                            {{ getSizeGrade(resource.member_count).grade }}
                          </span>
                          <span class="text-xs text-slate-500">{{ getSizeGrade(resource.member_count).label }}</span>
                        </div>
                      </td>
                      <td class="p-3">
                        <div class="flex items-center gap-2 flex-wrap">
                          <!-- ä¸»æ“ä½œæŒ‰éˆ•çµ„ -->
                          @if (resource.status !== 'joined' && resource.status !== 'monitoring') {
                            @if (resource.username) {
                              <!-- ğŸš€ åŠ å…¥ä¸¦ç›£æ§ - ä¸»æŒ‰éˆ• -->
                              <button (click)="openJoinAndMonitorDialog(resource)" 
                                      class="px-3 py-1.5 bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-lg text-xs font-medium hover:from-cyan-600 hover:to-purple-600 transition-all shadow-lg shadow-cyan-500/20 flex items-center gap-1.5"
                                      title="é¸æ“‡å¸³è™ŸåŠ å…¥ç¾¤çµ„ä¸¦è¨­ç½®ç›£æ§">
                                <span>ğŸš€</span>
                                <span>åŠ å…¥ç›£æ§</span>
                              </button>
                            } @else {
                              <!-- ç„¡éˆæ¥ï¼šéœ€è¦å…ˆé©—è­‰ -->
                              <button (click)="copyTelegramLink(resource)" 
                                      class="px-3 py-1.5 bg-orange-500/20 text-orange-400 rounded-lg text-xs font-medium hover:bg-orange-500/30 transition-colors border border-orange-500/30 flex items-center gap-1.5"
                                      title="è¤‡è£½ç¾¤çµ„åç¨±ï¼Œåœ¨ Telegram ä¸­æ‰‹å‹•æœç´¢">
                                <span>ğŸ”</span>
                                <span>æ‰‹å‹•æœç´¢</span>
                              </button>
                            }
                          } @else if (resource.status === 'monitoring') {
                            <!-- âœ… å·²ç›‘æ§çŠ¶æ€ -->
                            <span class="px-3 py-1.5 bg-green-500/20 text-green-400 rounded-lg text-xs font-medium flex items-center gap-1.5 border border-green-500/30">
                              <span>âœ…</span>
                              <span>ç›£æ§ä¸­</span>
                            </span>
                          } @else {
                            <!-- å·²åŠ å…¥ä½†æœªç›‘æ§ -->
                            <button (click)="openJoinAndMonitorDialog(resource)" 
                                    class="px-3 py-1.5 bg-purple-500/20 text-purple-400 rounded-lg text-xs font-medium hover:bg-purple-500/30 transition-colors border border-purple-500/30 flex items-center gap-1.5"
                                    title="è¨­ç½®ç›£æ§">
                              <span>ğŸ”</span>
                              <span>è¨­ç½®ç›£æ§</span>
                            </button>
                          }
                          
                          <!-- ğŸ‘¥ æŸ¥çœ‹æˆå“¡ - é »é“ç„¡æ³•æå–æˆå“¡ -->
                          @if (isChannel(resource)) {
                            <button [disabled]="true"
                                    (click)="showChannelMemberWarning()"
                                    class="px-3 py-1.5 bg-slate-500/20 text-slate-500 rounded-lg text-xs font-medium border border-slate-500/30 flex items-center gap-1.5 cursor-not-allowed"
                                    title="é »é“ç„¡æ³•æå–æˆå“¡åˆ—è¡¨">
                              <span>ğŸ‘¥</span>
                              <span>æˆå“¡</span>
                              <span>ğŸ”’</span>
                            </button>
                          } @else {
                            <button (click)="openMemberListDialog(resource)"
                                    class="px-3 py-1.5 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded-lg text-xs font-medium border border-blue-500/30 flex items-center gap-1.5 transition-all"
                                    title="æŸ¥çœ‹ä¸¦æå–ç¾¤çµ„æˆå“¡">
                              <span>ğŸ‘¥</span>
                              <span>æˆå“¡</span>
                            </button>
                          }
                          
                          <!-- ğŸ“¨ ç™¼é€æ¶ˆæ¯ - é »é“ç„¡æ³•ç™¼é€æ¶ˆæ¯ -->
                          @if (resource.status === 'joined' || resource.status === 'monitoring') {
                            @if (isChannel(resource)) {
                              <button [disabled]="true"
                                      (click)="showChannelMessageWarning()"
                                      class="px-3 py-1.5 bg-slate-500/20 text-slate-500 rounded-lg text-xs font-medium border border-slate-500/30 flex items-center gap-1.5 cursor-not-allowed"
                                      title="é »é“ç„¡æ³•ç™¼é€æ¶ˆæ¯ï¼Œåªæœ‰ç®¡ç†å“¡å¯ä»¥ç™¼å¸ƒ">
                                <span>ğŸ“¨</span>
                                <span>ç™¼æ¶ˆæ¯</span>
                                <span>ğŸ”’</span>
                              </button>
                            } @else {
                              <button (click)="openSingleMessageDialog(resource)"
                                      [disabled]="!membershipService.hasFeature('batchOperations')"
                                      class="px-3 py-1.5 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg text-xs font-medium border border-purple-500/30 flex items-center gap-1.5 transition-all disabled:opacity-50"
                                      title="ç™¼é€æ¶ˆæ¯åˆ°æ­¤ç¾¤çµ„">
                                <span>ğŸ“¨</span>
                                <span>ç™¼æ¶ˆæ¯</span>
                              </button>
                            }
                          }

                          <!-- âš™ï¸ ç›£æ§è¨­ç½® (å·²ç›£æ§çš„ç¾¤çµ„) -->
                          @if (resource.status === 'monitoring') {
                            <button (click)="openMonitorSettings(resource)"
                                    class="px-2 py-1.5 bg-slate-500/20 text-slate-400 rounded-lg text-xs hover:bg-slate-500/30 transition-colors"
                                    title="ç›£æ§è¨­ç½®">
                              âš™ï¸
                            </button>
                          }
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            }
          </div>
        </div>
        
        <!-- âš™ï¸ æ¸ é“ç®¡ç†å°è©±æ¡† -->
        @if (showChannelManageDialog()) {
          <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="closeChannelManageDialog()">
            <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl mx-4 p-6 border border-purple-500/30 max-h-[80vh] overflow-y-auto" (click)="$event.stopPropagation()">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                  <span>âš™ï¸</span> æœç´¢æ¸ é“ç®¡ç†
                </h3>
                <button (click)="openAddChannelDialog()" class="px-3 py-1.5 bg-cyan-500 hover:bg-cyan-600 text-white text-sm rounded-lg flex items-center gap-1">
                  <span>+</span> æ·»åŠ æ¸ é“
                </button>
              </div>

              <!-- ä½¿ç”¨æŒ‡ç¤º -->
              <div class="mb-6 p-4 bg-gradient-to-r from-cyan-500/10 to-purple-500/10 rounded-xl border border-cyan-500/20">
                <h4 class="text-sm font-semibold text-cyan-400 mb-2 flex items-center gap-2">
                  <span>ğŸ’¡</span> ä½¿ç”¨æŒ‡ç¤º
                </h4>
                <ul class="text-xs text-slate-300 space-y-1.5">
                  <li class="flex items-start gap-2">
                    <span class="text-cyan-400">1.</span>
                    <span>é»æ“Šå³ä¸Šè§’ã€Œæ·»åŠ æ¸ é“ã€æŒ‰éˆ•ï¼Œè¼¸å…¥æœç´¢ Bot çš„ç”¨æˆ¶åï¼ˆå¦‚ &#64;SearcheeBotï¼‰</span>
                  </li>
                  <li class="flex items-start gap-2">
                    <span class="text-cyan-400">2.</span>
                    <span>æ·»åŠ å¾Œé»æ“Šã€Œæ¸¬è©¦ã€ç¢ºèªæ¸ é“å¯ç”¨ï¼Œç¶ ç‡ˆè¡¨ç¤ºæ­£å¸¸</span>
                  </li>
                  <li class="flex items-start gap-2">
                    <span class="text-cyan-400">3.</span>
                    <span>å¯æ·»åŠ å¤šå€‹æ¸ é“ï¼Œç³»çµ±æœƒè‡ªå‹•è¼ªæ›ä½¿ç”¨ï¼Œæé«˜æœç´¢æˆåŠŸç‡</span>
                  </li>
                  <li class="flex items-start gap-2">
                    <span class="text-cyan-400">4.</span>
                    <span>å¸¸ç”¨æœç´¢ Botï¼š&#64;jaborotã€&#64;haborotã€&#64;qunzudaquan_bot ç­‰</span>
                  </li>
                </ul>
              </div>

              <!-- æˆ‘çš„æœç´¢æ¸ é“ -->
              <div>
                <h4 class="text-sm font-semibold text-slate-400 mb-3 flex items-center gap-2">
                  <span>ğŸ”</span> æˆ‘çš„æœç´¢æ¸ é“
                </h4>
                @if (customChannels().length === 0) {
                  <div class="text-center py-8 text-slate-500">
                    <div class="text-3xl mb-2">ğŸ“­</div>
                    <div>å°šæœªæ·»åŠ æœç´¢æ¸ é“</div>
                    <div class="text-xs mt-1">è«‹æŒ‰ç…§ä¸Šæ–¹æŒ‡ç¤ºæ·»åŠ æœç´¢ Bot</div>
                  </div>
                } @else {
                  <div class="space-y-2">
                    @for (channel of customChannels(); track channel.id) {
                      <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg">
                        <div class="flex items-center gap-3">
                          <span>{{ getChannelStatusIcon(channel.status) }}</span>
                          <div>
                            <div class="font-medium text-white">{{ channel.display_name }}</div>
                            <div class="text-xs text-slate-400">&#64;{{ channel.bot_username }} Â· {{ channel.priority === 'primary' ? 'ä¸»åŠ›' : 'å‚™ç”¨' }}</div>
                          </div>
                        </div>
                        <div class="flex items-center gap-2">
                          <label class="flex items-center gap-1">
                            <input type="checkbox"
                                   [checked]="channel.enabled"
                                   (change)="toggleChannelEnabled(channel.id, channel.enabled)"
                                   class="rounded text-cyan-500">
                            <span class="text-xs text-slate-400">å•Ÿç”¨</span>
                          </label>
                          <button (click)="testSearchChannel(channel.bot_username)"
                                  [disabled]="isTestingChannel()"
                                  class="px-2 py-1 text-xs bg-slate-600 hover:bg-slate-500 text-white rounded disabled:opacity-50">
                            æ¸¬è©¦
                          </button>
                          <button (click)="deleteSearchChannel(channel.id)"
                                  class="px-2 py-1 text-xs bg-red-500/20 hover:bg-red-500/40 text-red-400 rounded">
                            åˆªé™¤
                          </button>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>

              <div class="mt-6 flex justify-end">
                <button (click)="closeChannelManageDialog()" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">
                  é—œé–‰
                </button>
              </div>
            </div>
          </div>
        }

        <!-- â• æ·»åŠ æ¸ é“å°è©±æ¡† -->
        @if (showAddChannelDialog()) {
          <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60]" (click)="closeAddChannelDialog()">
            <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6 border border-cyan-500/30" (click)="$event.stopPropagation()">
              <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <span>â•</span> æ·»åŠ æœç´¢æ¸ é“
              </h3>

              <div class="space-y-4">
                <div>
                  <label class="block text-sm text-slate-400 mb-1">Bot ç”¨æˆ¶å *</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">&#64;</span>
                    <input type="text"
                           [(ngModel)]="newChannelUsername"
                           placeholder="SearcheeBot"
                           class="w-full pl-8 pr-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500">
                  </div>
                </div>

                <div>
                  <label class="block text-sm text-slate-400 mb-1">é¡¯ç¤ºåç¨±</label>
                  <input type="text"
                         [(ngModel)]="newChannelDisplayName"
                         placeholder="æˆ‘çš„æœç´¢æ©Ÿå™¨äºº"
                         class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:border-cyan-500">
                </div>

                <div>
                  <label class="block text-sm text-slate-400 mb-1">æœç´¢æŒ‡ä»¤æ ¼å¼</label>
                  <input type="text"
                         [(ngModel)]="newChannelQueryFormat"
                         placeholder="{keyword}"
                         class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:border-cyan-500">
                  <p class="text-xs text-slate-500 mt-1">&#123;keyword&#125; æœƒè¢«æ›¿æ›ç‚ºæœç´¢è©ï¼Œä¾‹å¦‚: /search &#123;keyword&#125;</p>
                </div>

                <div>
                  <label class="block text-sm text-slate-400 mb-1">å„ªå…ˆç´š</label>
                  <div class="flex gap-4">
                    <label class="flex items-center gap-2">
                      <input type="radio"
                             [(ngModel)]="newChannelPriority"
                             value="primary"
                             name="priority"
                             class="text-cyan-500">
                      <span class="text-white">èˆ‡ä¸»åŠ›ä¸¦è¡Œ</span>
                    </label>
                    <label class="flex items-center gap-2">
                      <input type="radio"
                             [(ngModel)]="newChannelPriority"
                             value="backup"
                             name="priority"
                             class="text-cyan-500">
                      <span class="text-white">å‚™ç”¨</span>
                    </label>
                  </div>
                </div>

                <div>
                  <label class="block text-sm text-slate-400 mb-1">å‚™è¨»</label>
                  <input type="text"
                         [(ngModel)]="newChannelNotes"
                         placeholder="å¯é¸å‚™è¨»"
                         class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:border-cyan-500">
                </div>
              </div>

              <div class="flex gap-3 mt-6">
                <button (click)="closeAddChannelDialog()" class="flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">
                  å–æ¶ˆ
                </button>
                <button (click)="addSearchChannel()" class="flex-1 px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg">
                  æ·»åŠ ä¸¦æ¸¬è©¦
                </button>
              </div>
            </div>
          </div>
        }

        <!-- ğŸš€ åŠ å…¥ä¸¦ç›£æ§å°è©±æ¡† -->
        @if (showJoinMonitorDialog()) {
          <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60]" (click)="closeJoinMonitorDialog()">
            <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-6 border border-cyan-500/30" (click)="$event.stopPropagation()">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                  <span>ğŸš€</span> 
                  @if (joinMonitorResource()?.status === 'joined') {
                    è¨­ç½®ç›£æ§
                  } @else {
                    åŠ å…¥ä¸¦ç›£æ§
                  }
                </h3>
                <button (click)="closeJoinMonitorDialog()" class="text-slate-400 hover:text-white">âœ•</button>
              </div>

              <!-- ç›®æ¨™ç¾¤çµ„ä¿¡æ¯ -->
              @if (joinMonitorResource(); as resource) {
                <div class="bg-slate-700/50 rounded-lg p-4 mb-4">
                  <div class="flex items-start gap-3">
                    <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center text-2xl">
                      {{ resource.resource_type === 'channel' ? 'ğŸ“¢' : 'ğŸ‘¥' }}
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="font-medium text-white truncate">{{ resource.title }}</div>
                      <div class="text-sm text-slate-400">
                        {{ formatMemberCount(resource.member_count) }} æˆå“¡
                        @if (resource.username) {
                          <span class="mx-1">Â·</span>
                          <span class="text-cyan-400">&#64;{{ resource.username }}</span>
                        }
                      </div>
                    </div>
                  </div>
                </div>
              }

              <!-- é¸æ“‡å¸³è™Ÿ -->
              @if (joinMonitorResource()?.status !== 'joined' && joinMonitorResource()?.status !== 'monitoring') {
                <div class="mb-4">
                  <label class="block text-sm font-medium text-slate-300 mb-2">
                    <span>ğŸ“±</span> é¸æ“‡åŠ å…¥å¸³è™Ÿ
                  </label>
                  <div class="space-y-2 max-h-48 overflow-y-auto">
                    @for (account of accountQuotas(); track account.phone) {
                      <label class="flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors border-2"
                             [class.border-cyan-500]="joinMonitorSelectedPhone() === account.phone"
                             [class.border-transparent]="joinMonitorSelectedPhone() !== account.phone">
                        <input type="radio"
                               [value]="account.phone"
                               [checked]="joinMonitorSelectedPhone() === account.phone"
                               (change)="joinMonitorSelectedPhone.set(account.phone)"
                               class="text-cyan-500">
                        <div class="flex-1">
                          <div class="flex items-center gap-2">
                            <span class="font-medium text-white">{{ account.nickname }}</span>
                            @if (account.isRecommended) {
                              <span class="text-xs bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded">â­ æ¨è–¦</span>
                            }
                          </div>
                          <div class="text-xs text-slate-400">
                            {{ account.phone }} Â· å·²åŠ å…¥ {{ account.joinedGroups }} å€‹ç¾¤çµ„ Â· ä»Šæ—¥å‰©é¤˜ {{ account.dailyLimit - account.dailyUsed }} å€‹é…é¡
                          </div>
                        </div>
                      </label>
                    } @empty {
                      <div class="text-center py-4 text-slate-500">
                        <div class="text-2xl mb-2">ğŸ“µ</div>
                        <div>æ²’æœ‰å¯ç”¨çš„å¸³è™Ÿ</div>
                        <div class="text-xs">è«‹å…ˆæ·»åŠ ä¸¦é€£æ¥ Telegram å¸³è™Ÿ</div>
                      </div>
                    }
                  </div>
                </div>
              } @else {
                <!-- å·²åŠ å…¥ç¾¤çµ„é¡¯ç¤ºä½¿ç”¨çš„å¸³è™Ÿ -->
                @if (joinMonitorResource()?.joined_by_phone) {
                  <div class="mb-4 p-3 bg-green-500/10 border border-green-500/30 rounded-lg">
                    <div class="text-sm text-green-400 flex items-center gap-2">
                      <span>âœ…</span>
                      <span>å·²ä½¿ç”¨ {{ joinMonitorResource()?.joined_by_phone }} åŠ å…¥</span>
                    </div>
                  </div>
                }
              }

              <!-- ç›£æ§é—œéµè©è¨­ç½® -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  <span>ğŸ”</span> ç›£æ§é—œéµè©
                </label>
                
                <!-- å·²æ·»åŠ çš„é—œéµè© -->
                <div class="flex flex-wrap gap-2 mb-2">
                  @for (keyword of joinMonitorKeywords(); track keyword) {
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-cyan-500/20 text-cyan-400 rounded-lg text-sm">
                      {{ keyword }}
                      <button (click)="removeMonitorKeyword(keyword)" class="hover:text-cyan-200">âœ•</button>
                    </span>
                  } @empty {
                    <span class="text-sm text-slate-500">æš«ç„¡é—œéµè©ï¼Œå¯è¼¸å…¥æ·»åŠ æˆ–é¸æ“‡æ¨è–¦</span>
                  }
                </div>
                
                <!-- è¼¸å…¥æ–°é—œéµè© -->
                <div class="flex gap-2 mb-2">
                  <input type="text"
                         [(ngModel)]="joinMonitorNewKeyword"
                         (keyup.enter)="addMonitorKeyword()"
                         placeholder="è¼¸å…¥é—œéµè©ï¼Œå›è»Šæ·»åŠ "
                         class="flex-1 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:border-cyan-500 text-sm">
                  <button (click)="addMonitorKeyword()" class="px-3 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg text-sm">
                    æ·»åŠ 
                  </button>
                </div>
                
                <!-- æ¨è–¦é—œéµè© -->
                @if (getRecommendedKeywords().length > 0) {
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-xs text-slate-500">ğŸ’¡ æ¨è–¦ï¼š</span>
                    @for (keyword of getRecommendedKeywords(); track keyword) {
                      <button (click)="addRecommendedKeyword(keyword)"
                              class="px-2 py-0.5 bg-slate-600 hover:bg-slate-500 text-slate-300 rounded text-xs">
                        + {{ keyword }}
                      </button>
                    }
                  </div>
                }
              </div>

              <!-- é¸é … -->
              <div class="mb-6">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox"
                         [checked]="joinMonitorAutoEnable()"
                         (change)="joinMonitorAutoEnable.set(!joinMonitorAutoEnable())"
                         class="rounded text-cyan-500">
                  <span class="text-sm text-slate-300">åŠ å…¥å¾Œè‡ªå‹•å•Ÿç”¨ç›£æ§</span>
                </label>
              </div>

              <!-- æ“ä½œæŒ‰éˆ• -->
              <div class="flex gap-3">
                <button (click)="closeJoinMonitorDialog()" 
                        class="flex-1 px-4 py-2.5 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">
                  å–æ¶ˆ
                </button>
                <button (click)="executeJoinAndMonitor()"
                        [disabled]="isJoiningResource() || (!joinMonitorSelectedPhone() && joinMonitorResource()?.status !== 'joined')"
                        class="flex-1 px-4 py-2.5 bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600 text-white rounded-lg font-medium disabled:opacity-50 flex items-center justify-center gap-2">
                  @if (isJoiningResource()) {
                    <span class="animate-spin">â³</span>
                    <span>è™•ç†ä¸­...</span>
                  } @else if (joinMonitorResource()?.status === 'joined' || joinMonitorResource()?.status === 'monitoring') {
                    <span>ğŸ”</span>
                    <span>ä¿å­˜ç›£æ§è¨­ç½®</span>
                  } @else {
                    <span>ğŸš€</span>
                    <span>åŠ å…¥ä¸¦ç›£æ§</span>
                  }
                </button>
              </div>
            </div>
          </div>
        }
        
        <!-- ğŸš€ æ‰¹é‡åŠ å…¥ä¸¦ç›£æ§å°è©±æ¡† -->
        @if (showBatchJoinMonitorDialog()) {
          <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60]" (click)="closeBatchJoinMonitorDialog()">
            <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl mx-4 p-6 border border-cyan-500/30 max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                  <span>ğŸš€</span> æ‰¹é‡åŠ å…¥ä¸¦ç›£æ§
                </h3>
                <button (click)="closeBatchJoinMonitorDialog()" class="text-slate-400 hover:text-white text-xl">âœ•</button>
              </div>
              
              <!-- å·²é¸ç¾¤çµ„æ‘˜è¦ -->
              <div class="bg-gradient-to-r from-cyan-500/10 to-purple-500/10 rounded-xl p-4 mb-4 border border-cyan-500/20">
                <div class="flex items-center justify-between">
                  <div>
                    <span class="text-lg font-bold text-white">{{ batchJoinResources().length }}</span>
                    <span class="text-slate-400 ml-1">å€‹ç¾¤çµ„å¾…åŠ å…¥</span>
                  </div>
                  <div class="text-sm text-slate-400">
                    ç¸½æˆå“¡: {{ getBatchJoinTotalMembers() | number }}
                  </div>
                </div>
                <div class="mt-2 flex flex-wrap gap-1">
                  @for (resource of batchJoinResources().slice(0, 5); track resource.id) {
                    <span class="px-2 py-0.5 bg-slate-700/50 rounded text-xs text-slate-300 truncate max-w-[120px]">
                      {{ resource.title }}
                    </span>
                  }
                  @if (batchJoinResources().length > 5) {
                    <span class="px-2 py-0.5 bg-slate-600 rounded text-xs text-slate-400">
                      +{{ batchJoinResources().length - 5 }} æ›´å¤š
                    </span>
                  }
                </div>
              </div>
              
              <!-- é¸æ“‡å¸³è™Ÿï¼ˆå¤šé¸ï¼‰ -->
              <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                  <label class="text-sm font-medium text-slate-300 flex items-center gap-2">
                    <span>ğŸ“±</span> é¸æ“‡åŠ å…¥å¸³è™Ÿï¼ˆå¯å¤šé¸ï¼‰
                  </label>
                  <button (click)="selectAllAccounts()" class="text-xs text-cyan-400 hover:text-cyan-300">
                    å…¨é¸
                  </button>
                </div>
                
                <div class="space-y-2 max-h-48 overflow-y-auto">
                  @for (account of accountQuotas(); track account.phone) {
                    <label class="flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors border-2"
                           [class.border-cyan-500]="joinMonitorSelectedPhones().includes(account.phone)"
                           [class.border-transparent]="!joinMonitorSelectedPhones().includes(account.phone)">
                      <input type="checkbox"
                             [checked]="joinMonitorSelectedPhones().includes(account.phone)"
                             (change)="toggleAccountSelection(account.phone)"
                             class="w-4 h-4 text-cyan-500 rounded">
                      <div class="flex-1">
                        <div class="flex items-center gap-2">
                          <span class="font-medium text-white">{{ account.phone }}</span>
                          @if (account.isRecommended) {
                            <span class="text-xs bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded">â­ æ¨è–¦</span>
                          }
                        </div>
                        <div class="text-xs text-slate-400">
                          å·²åŠ å…¥ {{ account.joinedGroups }} å€‹ç¾¤çµ„ Â· ä»Šæ—¥å‰©é¤˜ {{ account.dailyLimit - account.dailyUsed }} å€‹é…é¡
                        </div>
                      </div>
                    </label>
                  } @empty {
                    <div class="text-center py-4 text-slate-500">
                      <div class="text-2xl mb-2">ğŸ“µ</div>
                      <div>æ²’æœ‰å¯ç”¨çš„å¸³è™Ÿ</div>
                    </div>
                  }
                </div>
                
                @if (joinMonitorSelectedPhones().length > 0) {
                  <div class="mt-2 p-2 bg-cyan-500/10 rounded-lg text-sm text-cyan-400">
                    å·²é¸æ“‡ {{ joinMonitorSelectedPhones().length }} å€‹å¸³è™Ÿï¼Œå°‡è¼ªæ›åˆ†é…åŠ å…¥ä»»å‹™
                  </div>
                }
              </div>
              
              <!-- åŠ å…¥ç­–ç•¥ -->
              <div class="mb-4 p-4 bg-slate-700/30 rounded-xl border border-slate-600">
                <label class="text-sm font-medium text-slate-300 mb-3 flex items-center gap-2">
                  <span>âš™ï¸</span> åŠ å…¥ç­–ç•¥
                </label>
                
                <div class="space-y-3">
                  <label class="flex items-center gap-3 cursor-pointer">
                    <input type="radio" [checked]="joinMonitorBatchMode()" (change)="joinMonitorBatchMode.set(true)"
                           class="text-cyan-500">
                    <div>
                      <span class="text-white">åˆ†æ‰¹åŠ å…¥ï¼ˆæ¨è–¦ï¼‰</span>
                      <p class="text-xs text-slate-400">æ¯å€‹ç¾¤çµ„é–“éš”ä¸€æ®µæ™‚é–“åŠ å…¥ï¼Œæ›´å®‰å…¨</p>
                    </div>
                  </label>
                  
                  @if (joinMonitorBatchMode()) {
                    <div class="ml-7 flex items-center gap-2">
                      <span class="text-sm text-slate-400">é–“éš”æ™‚é–“:</span>
                      <select [(ngModel)]="joinMonitorBatchInterval" class="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-white text-sm">
                        <option [value]="30">30 ç§’</option>
                        <option [value]="45">45 ç§’</option>
                        <option [value]="60">1 åˆ†é˜</option>
                        <option [value]="120">2 åˆ†é˜</option>
                      </select>
                    </div>
                  }
                  
                  <label class="flex items-center gap-3 cursor-pointer">
                    <input type="radio" [checked]="!joinMonitorBatchMode()" (change)="joinMonitorBatchMode.set(false)"
                           class="text-cyan-500">
                    <div>
                      <span class="text-white">ç«‹å³å…¨éƒ¨åŠ å…¥</span>
                      <p class="text-xs text-slate-400">å¿«é€Ÿä½†é¢¨éšªè¼ƒé«˜</p>
                    </div>
                  </label>
                </div>
              </div>
              
              <!-- ç›£æ§é—œéµè© -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  <span>ğŸ”</span> ç›£æ§é—œéµè©ï¼ˆå¯é¸ï¼‰
                </label>
                <div class="flex gap-2 mb-2">
                  <input type="text" [(ngModel)]="joinMonitorNewKeyword" (keyup.enter)="addMonitorKeyword()"
                         placeholder="è¼¸å…¥é—œéµè©ï¼Œå›è»Šæ·»åŠ "
                         class="flex-1 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm">
                  <button (click)="addMonitorKeyword()" class="px-3 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg text-sm">
                    æ·»åŠ 
                  </button>
                </div>
                <div class="flex flex-wrap gap-2">
                  @for (keyword of joinMonitorKeywords(); track keyword) {
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-cyan-500/20 text-cyan-400 rounded-lg text-sm">
                      {{ keyword }}
                      <button (click)="removeMonitorKeyword(keyword)" class="hover:text-cyan-200">âœ•</button>
                    </span>
                  }
                </div>
              </div>
              
              <!-- è‡ªå‹•ç›£æ§é¸é … -->
              <div class="mb-6">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" [checked]="joinMonitorAutoEnable()" (change)="joinMonitorAutoEnable.set(!joinMonitorAutoEnable())"
                         class="w-4 h-4 rounded text-cyan-500">
                  <span class="text-sm text-slate-300">åŠ å…¥å¾Œè‡ªå‹•å•Ÿç”¨ç›£æ§</span>
                </label>
              </div>
              
              <!-- æ“ä½œæŒ‰éˆ• -->
              <div class="flex gap-3">
                <button (click)="closeBatchJoinMonitorDialog()" 
                        class="flex-1 px-4 py-2.5 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">
                  å–æ¶ˆ
                </button>
                <button (click)="executeBatchJoinMonitor()"
                        [disabled]="isJoiningResource() || joinMonitorSelectedPhones().length === 0"
                        class="flex-1 px-4 py-2.5 bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600 text-white rounded-lg font-medium disabled:opacity-50 flex items-center justify-center gap-2">
                  @if (isJoiningResource()) {
                    <span class="animate-spin">â³</span>
                    <span>è™•ç†ä¸­... {{ batchJoinProgress().current }}/{{ batchJoinProgress().total }}</span>
                  } @else {
                    <span>ğŸš€</span>
                    <span>é–‹å§‹æ‰¹é‡åŠ å…¥</span>
                  }
                </button>
              </div>
            </div>
          </div>
        }
        
        <!-- ğŸ‘¥ æˆå“¡åˆ—è¡¨å°è©±æ¡†ï¼ˆå¢å¼·ç‰ˆï¼‰ -->
        @if (showMemberListDialog()) {
          <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60]" (click)="closeMemberListDialog()">
            <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-5xl mx-4 p-6 border border-blue-500/30 max-h-[90vh] flex flex-col" (click)="$event.stopPropagation()">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                  <span>ğŸ‘¥</span> æˆå“¡æå–
                  @if (memberListResource(); as resource) {
                    <span class="text-slate-400 font-normal text-sm">- {{ resource.title }}</span>
                  }
                </h3>
                <div class="flex items-center gap-2">
                  @if (memberListLoading()) {
                    <button (click)="toggleMemberExtractBackground()" 
                            class="px-3 py-1.5 bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 rounded-lg text-sm border border-orange-500/30">
                      ğŸ“¤ è½‰ç‚ºå¾Œå°é‹è¡Œ
                    </button>
                  }
                  <button (click)="closeMemberListDialog()" class="text-slate-400 hover:text-white text-xl">âœ•</button>
                </div>
              </div>
              
              <!-- âš ï¸ é »é“è­¦å‘Š -->
              @if (isChannel(memberListResource())) {
                <div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-500/30 rounded-xl p-6 text-center">
                  <div class="text-5xl mb-4">ğŸ“¢</div>
                  <h4 class="text-xl font-bold text-white mb-2">ç„¡æ³•æå–é »é“æˆå“¡</h4>
                  <p class="text-slate-300 mb-4">
                    Telegram ä¸å…è¨±æŸ¥çœ‹é »é“çš„è¨‚é–±è€…åˆ—è¡¨ã€‚<br>
                    é€™æ˜¯ Telegram çš„éš±ç§ä¿è­·æ©Ÿåˆ¶ã€‚
                  </p>
                  <div class="bg-slate-700/50 rounded-lg p-4 text-left max-w-md mx-auto">
                    <h5 class="text-sm font-medium text-cyan-400 mb-2">ğŸ’¡ æ›¿ä»£æ–¹æ¡ˆ</h5>
                    <ul class="text-sm text-slate-300 space-y-1">
                      <li>â€¢ å°‹æ‰¾è©²é »é“çš„é—œè¯è¨è«–ç¾¤çµ„</li>
                      <li>â€¢ åˆ†æé »é“å¸–å­çš„äº’å‹•ç”¨æˆ¶</li>
                      <li>â€¢ æœç´¢ç›¸é—œçš„å…¬é–‹ç¾¤çµ„</li>
                    </ul>
                  </div>
                  <button (click)="closeMemberListDialog()" 
                          class="mt-6 px-6 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">
                    æˆ‘çŸ¥é“äº†
                  </button>
                </div>
              } @else {

              <!-- æå–è¨­ç½®é¢æ¿ -->
              @if (!memberExtractStarted()) {
                <!-- é æª¢ç‹€æ…‹é¢æ¿ -->
                <div class="bg-gradient-to-r from-slate-700/30 to-slate-600/30 rounded-xl p-4 mb-4 border border-slate-600">
                  <h4 class="text-sm font-medium text-white mb-3 flex items-center gap-2">
                    <span>ğŸ“‹</span> æå–ç‹€æ…‹æª¢æŸ¥
                  </h4>
                  <div class="space-y-2">
                    <!-- ç¾¤çµ„é¡å‹æª¢æŸ¥ -->
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-slate-400">ç¾¤çµ„é¡å‹</span>
                      @if (memberListResource()?.resource_type === 'supergroup' || memberListResource()?.resource_type === 'group') {
                        <span class="text-green-400 flex items-center gap-1">
                          <span>âœ…</span> {{ memberListResource()?.resource_type === 'supergroup' ? 'è¶…ç´šç¾¤çµ„' : 'æ™®é€šç¾¤çµ„' }} (å¯æå–)
                        </span>
                      } @else if (memberListResource()?.resource_type === 'channel') {
                        <span class="text-red-400 flex items-center gap-1">
                          <span>âŒ</span> é »é“ (ç„¡æ³•æå–)
                        </span>
                      } @else {
                        <span class="text-yellow-400 flex items-center gap-1">
                          <span>âš ï¸</span> æœªçŸ¥é¡å‹
                        </span>
                      }
                    </div>
                    <!-- æˆå“¡æ•¸é‡ -->
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-slate-400">ç¾¤çµ„æˆå“¡æ•¸</span>
                      <span class="text-cyan-400">{{ formatMemberCount(memberListResource()?.member_count) }} äºº</span>
                    </div>
                    <!-- å¸³è™Ÿç‹€æ…‹ -->
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-slate-400">ä½¿ç”¨å¸³è™Ÿ</span>
                      @if (getFirstOnlineAccount()) {
                        <span class="text-green-400 flex items-center gap-1">
                          <span>âœ…</span> {{ getFirstOnlineAccount()?.phone }}
                        </span>
                      } @else {
                        <span class="text-red-400 flex items-center gap-1">
                          <span>âŒ</span> ç„¡åœ¨ç·šå¸³è™Ÿ
                        </span>
                      }
                    </div>
                    <!-- æç¤º -->
                    @if (memberListResource()?.status !== 'joined' && memberListResource()?.status !== 'monitoring') {
                      <div class="mt-2 p-2 bg-orange-500/10 border border-orange-500/30 rounded-lg text-xs text-orange-400 flex items-start gap-2">
                        <span>âš ï¸</span>
                        <span>å¸³è™Ÿå¯èƒ½å°šæœªåŠ å…¥æ­¤ç¾¤çµ„ï¼Œæå–å¯èƒ½å¤±æ•—ã€‚å»ºè­°å…ˆä½¿ç”¨ã€ŒåŠ å…¥ç›£æ§ã€åŠŸèƒ½ã€‚</span>
                      </div>
                    }
                  </div>
                </div>
                
                <div class="bg-slate-700/30 rounded-xl p-4 mb-4 border border-slate-600">
                  <h4 class="text-sm font-medium text-white mb-3 flex items-center gap-2">
                    <span>âš™ï¸</span> æå–è¨­ç½®
                  </h4>

                  <div class="grid grid-cols-2 gap-4 mb-4">
                    <!-- æå–æ•¸é‡ -->
                    <div>
                      <label class="block text-xs text-slate-400 mb-2">ğŸ“Š æå–æ•¸é‡</label>
                      <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="radio" name="extractLimit" [checked]="memberExtractConfig().limit === 100" 
                                 (change)="setMemberExtractLimit(100)" class="text-cyan-500">
                          <span class="text-sm text-slate-300">å¿«é€Ÿæå– (100äºº)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="radio" name="extractLimit" [checked]="memberExtractConfig().limit === 500" 
                                 (change)="setMemberExtractLimit(500)" class="text-cyan-500">
                          <span class="text-sm text-slate-300">æ¨™æº–æå– (500äºº)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="radio" name="extractLimit" [checked]="memberExtractConfig().limit === 0" 
                                 (change)="setMemberExtractLimit(0)" class="text-cyan-500">
                          <span class="text-sm text-slate-300">å®Œæ•´æå– (å…¨éƒ¨)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="radio" name="extractLimit" [checked]="memberExtractConfig().limit === -1" 
                                 (change)="setMemberExtractLimit(-1)" class="text-cyan-500">
                          <span class="text-sm text-slate-300">è‡ªå®šç¾©:</span>
                          <input type="number" [(ngModel)]="memberExtractConfig().customLimit" min="1" max="10000"
                                 class="w-20 px-2 py-1 bg-slate-700 border border-slate-600 rounded text-white text-sm">
                        </label>
                      </div>
                    </div>
                    
                    <!-- æ™ºèƒ½ç¯©é¸ -->
                    <div>
                      <label class="block text-xs text-slate-400 mb-2">ğŸ” æ™ºèƒ½ç¯©é¸</label>
                      <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" [(ngModel)]="memberExtractConfig().onlineOnly" class="rounded text-cyan-500">
                          <span class="text-sm text-slate-300">ğŸŸ¢ åªæå–åœ¨ç·š/æœ€è¿‘ä¸Šç·š</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" [(ngModel)]="memberExtractConfig().chineseOnly" class="rounded text-cyan-500">
                          <span class="text-sm text-slate-300">ğŸ‡¨ğŸ‡³ åªæå–è¯äººç”¨æˆ¶</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" [(ngModel)]="memberExtractConfig().premiumOnly" class="rounded text-cyan-500">
                          <span class="text-sm text-slate-300">â­ åªæå– Premium ç”¨æˆ¶</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" [(ngModel)]="memberExtractConfig().hasUsername" class="rounded text-cyan-500">
                          <span class="text-sm text-slate-300">ğŸ“› åªæå–æœ‰ç”¨æˆ¶åçš„</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" [(ngModel)]="memberExtractConfig().excludeBots" class="rounded text-cyan-500">
                          <span class="text-sm text-slate-300">ğŸ¤– æ’é™¤ Bot</span>
                        </label>
                      </div>
                    </div>
                  </div>
                  
                  <!-- é‹è¡Œæ¨¡å¼ -->
                  <div class="pt-3 border-t border-slate-600">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" [(ngModel)]="memberExtractConfig().backgroundMode" class="rounded text-cyan-500">
                      <span class="text-sm text-slate-300">ğŸ“¤ å¾Œå°é‹è¡Œï¼ˆå¯é—œé–‰å½ˆçª—ï¼Œå®Œæˆå¾Œé€šçŸ¥ï¼‰</span>
                    </label>
                  </div>
                  
                  <!-- é–‹å§‹æå–æŒ‰éˆ• -->
                  <div class="mt-4">
                    <button (click)="startMemberExtraction()"
                            class="w-full px-4 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white rounded-xl font-medium flex items-center justify-center gap-2">
                      <span>ğŸš€</span>
                      <span>é–‹å§‹æå–æˆå“¡</span>
                    </button>
                  </div>
                </div>
              } @else {
                <!-- é€²åº¦æ¢å€åŸŸ -->
                <div class="bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-xl p-4 mb-4 border border-blue-500/20">
                  <!-- é€²åº¦æ¢ -->
                  @if (memberListLoading()) {
                    <div class="mb-3">
                      <div class="flex items-center justify-between mb-1">
                        <span class="text-sm text-slate-300">æå–é€²åº¦</span>
                        <span class="text-sm text-cyan-400">{{ getMemberExtractPercent() }}%</span>
                      </div>
                      <div class="w-full bg-slate-700 rounded-full h-3 overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full transition-all duration-300"
                             [style.width.%]="getMemberExtractPercent()"></div>
                      </div>
                      <div class="flex items-center justify-between mt-2 text-xs text-slate-400">
                        <span>å·²æå–: {{ memberListData().length }} / {{ memberListProgress().total | number }}</span>
                        <span>{{ memberListProgress().status }}</span>
                      </div>
                    </div>
                  }
                  
                  <!-- çµ±è¨ˆä¿¡æ¯ -->
                  <div class="flex items-center justify-between flex-wrap gap-3">
                    <div class="flex items-center gap-4">
                      <div class="text-center">
                        <div class="text-2xl font-bold text-white">{{ memberListData().length }}</div>
                        <div class="text-xs text-slate-400">å·²æå–</div>
                      </div>
                      <div class="text-center">
                        <div class="text-2xl font-bold text-red-400">{{ getChineseMemberCount() }}</div>
                        <div class="text-xs text-slate-400">ğŸ‡¨ğŸ‡³ è¯äºº</div>
                      </div>
                      <div class="text-center">
                        <div class="text-2xl font-bold text-green-400">{{ getOnlineMemberCount() }}</div>
                        <div class="text-xs text-slate-400">ğŸŸ¢ åœ¨ç·š</div>
                      </div>
                      <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-400">{{ getPremiumMemberCount() }}</div>
                        <div class="text-xs text-slate-400">â­ Premium</div>
                      </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                      @if (memberListLoading()) {
                        <button (click)="pauseMemberExtraction()"
                                class="px-3 py-1.5 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 rounded-lg text-sm border border-yellow-500/30">
                          â¸ï¸ æš«åœ
                        </button>
                        <button (click)="stopMemberExtraction()"
                                class="px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm border border-red-500/30">
                          â¹ï¸ åœæ­¢
                        </button>
                      } @else {
                        <button (click)="extractMoreMembers()" 
                                class="px-3 py-1.5 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg text-sm border border-cyan-500/30">
                          ğŸ”„ ç¹¼çºŒæå–
                        </button>
                      }
                      <button (click)="exportMembersToCSV()" [disabled]="memberListData().length === 0"
                              class="px-3 py-1.5 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg text-sm border border-green-500/30 disabled:opacity-50">
                        ğŸ“¥ å°å‡º
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- ç¯©é¸å·¥å…·æ¬„ -->
                <div class="flex items-center gap-2 mb-3 flex-wrap">
                  <span class="text-xs text-slate-400">ç¯©é¸:</span>
                  <button (click)="setMemberFilter('all')" 
                          class="px-2 py-1 rounded text-xs transition-colors"
                          [class]="memberListFilter() === 'all' ? 'bg-cyan-500 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'">
                    å…¨éƒ¨
                  </button>
                  <button (click)="setMemberFilter('chinese')" 
                          class="px-2 py-1 rounded text-xs transition-colors"
                          [class]="memberListFilter() === 'chinese' ? 'bg-red-500 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'">
                    ğŸ‡¨ğŸ‡³ è¯äºº
                  </button>
                  <button (click)="setMemberFilter('online')" 
                          class="px-2 py-1 rounded text-xs transition-colors"
                          [class]="memberListFilter() === 'online' ? 'bg-green-500 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'">
                    ğŸŸ¢ åœ¨ç·š
                  </button>
                  <button (click)="setMemberFilter('premium')" 
                          class="px-2 py-1 rounded text-xs transition-colors"
                          [class]="memberListFilter() === 'premium' ? 'bg-yellow-500 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'">
                    â­ Premium
                  </button>
                  <button (click)="setMemberFilter('hasUsername')" 
                          class="px-2 py-1 rounded text-xs transition-colors"
                          [class]="memberListFilter() === 'hasUsername' ? 'bg-purple-500 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'">
                    ğŸ“› æœ‰ç”¨æˆ¶å
                  </button>
                </div>
              }
              
              <!-- æˆå“¡åˆ—è¡¨ -->
              <div class="flex-1 overflow-y-auto">
                @if (memberListData().length === 0 && !memberListLoading() && memberExtractStarted()) {
                  <div class="text-center py-12">
                    @if (memberListProgress().status === 'éœ€è¦å…ˆåŠ å…¥ç¾¤çµ„') {
                      <!-- éœ€è¦åŠ å…¥ç¾¤çµ„çš„éŒ¯èª¤ç‹€æ…‹ -->
                      <div class="text-5xl mb-4">ğŸ”</div>
                      <p class="text-lg text-orange-400 mb-2">ç„¡æ³•æå–æˆå“¡</p>
                      <p class="text-sm text-slate-400 mb-4">å¸³è™Ÿå°šæœªåŠ å…¥æ­¤ç¾¤çµ„ï¼ŒTelegram è¦æ±‚å…ˆæˆç‚ºæˆå“¡</p>
                      <div class="flex items-center justify-center gap-3">
                        <button (click)="autoJoinAndExtract()" 
                                class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg flex items-center gap-2">
                          <span>ğŸš€</span> åŠ å…¥ç¾¤çµ„ä¸¦é‡è©¦
                        </button>
                        <button (click)="closeMemberListDialog()" 
                                class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">
                          å–æ¶ˆ
                        </button>
                      </div>
                    } @else if (memberListProgress().status === 'å»ºè­°ä½¿ç”¨æ¶ˆæ¯ç›£æ§') {
                      <!-- éœ€è¦ç®¡ç†å“¡æ¬Šé™çš„éŒ¯èª¤ç‹€æ…‹ -->
                      <div class="text-5xl mb-4">ğŸ”’</div>
                      <p class="text-lg text-orange-400 mb-2">æˆå“¡åˆ—è¡¨å—é™</p>
                      <p class="text-sm text-slate-400 mb-4">ç¾¤çµ„è¨­ç½®é™åˆ¶äº†æˆå“¡åˆ—è¡¨è¨ªå•ï¼Œåªæœ‰ç®¡ç†å“¡å¯æŸ¥çœ‹</p>
                      <div class="bg-slate-700/50 rounded-lg p-4 max-w-md mx-auto mb-4">
                        <p class="text-sm text-cyan-400 mb-2">ğŸ’¡ æ›¿ä»£æ–¹æ¡ˆ</p>
                        <ul class="text-sm text-slate-300 text-left space-y-1">
                          <li>â€¢ å•Ÿå‹•æ¶ˆæ¯ç›£æ§ï¼Œå¾ç™¼è¨€è€…ä¸­æ”¶é›†ç”¨æˆ¶</li>
                          <li>â€¢ åˆ†æç¾¤çµ„æ´»èºç”¨æˆ¶</li>
                        </ul>
                      </div>
                      <button (click)="closeMemberListDialog()" 
                              class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">
                        æˆ‘çŸ¥é“äº†
                      </button>
                    } @else if (memberListProgress().status === 'æå–å¤±æ•—') {
                      <!-- é€šç”¨éŒ¯èª¤ç‹€æ…‹ -->
                      <div class="text-5xl mb-4">âŒ</div>
                      <p class="text-lg text-red-400 mb-2">æå–å¤±æ•—</p>
                      <p class="text-sm text-slate-400 mb-4">è«‹ç¨å¾Œé‡è©¦æˆ–å˜—è©¦å…¶ä»–ç¾¤çµ„</p>
                      <button (click)="startMemberExtraction()" 
                              class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg">
                        ğŸ”„ é‡è©¦
                      </button>
                    } @else {
                      <!-- æ­£å¸¸ç„¡æ•¸æ“šç‹€æ…‹ -->
                      <div class="text-5xl mb-4 text-slate-500">ğŸ‘¥</div>
                      <p class="text-lg text-slate-500">æš«ç„¡ç¬¦åˆæ¢ä»¶çš„æˆå“¡</p>
                    }
                  </div>
                } @else if (memberExtractStarted()) {
                  <table class="w-full text-sm">
                    <thead class="text-slate-400 text-left bg-slate-700/50 sticky top-0">
                      <tr>
                        <th class="p-2 w-10">
                          <input type="checkbox" [checked]="isAllMembersSelected()" (change)="toggleSelectAllMembersList()" class="form-checkbox rounded text-blue-500">
                        </th>
                        <th class="p-2">ID</th>
                        <th class="p-2">ç”¨æˆ¶</th>
                        <th class="p-2">ç”¨æˆ¶å</th>
                        <th class="p-2">é›»è©±</th>
                        <th class="p-2">ç‹€æ…‹</th>
                        <th class="p-2">ä¿¡æ¯</th>
                        <th class="p-2">æ¨™ç±¤</th>
                        <th class="p-2">æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (member of getFilteredMembers(); track member.user_id) {
                        <tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
                          <td class="p-2">
                            <input type="checkbox" [checked]="selectedMemberIds().includes(member.user_id)"
                                   (change)="toggleMemberIdSelection(member.user_id)" class="form-checkbox rounded text-blue-500">
                          </td>
                          <td class="p-2">
                            <span class="text-slate-400 text-xs font-mono">{{ member.user_id }}</span>
                          </td>
                          <td class="p-2">
                            <div class="flex items-center gap-2">
                              <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium"
                                   [class]="member.has_photo ? 'bg-gradient-to-br from-blue-500 to-purple-500' : 'bg-slate-600'">
                                {{ (member.first_name || '?').charAt(0) }}
                              </div>
                              <div>
                                <div class="text-white text-sm flex items-center gap-1">
                                  {{ member.first_name }} {{ member.last_name }}
                                  @if (isChineseMember(member)) {
                                    <span class="text-xs">ğŸ‡¨ğŸ‡³</span>
                                  }
                                </div>
                                @if (member.bio) {
                                  <div class="text-xs text-slate-500 truncate max-w-[150px]" [title]="member.bio">
                                    ğŸ“ {{ member.bio }}
                                  </div>
                                }
                              </div>
                            </div>
                          </td>
                          <td class="p-2">
                            @if (member.username) {
                              <span class="text-cyan-400 text-sm">&#64;{{ member.username }}</span>
                            } @else {
                              <span class="text-slate-500 text-sm">-</span>
                            }
                          </td>
                          <td class="p-2">
                            @if (member.phone) {
                              <span class="text-green-400 text-xs font-mono">{{ member.phone }}</span>
                            } @else {
                              <span class="text-slate-500 text-xs">-</span>
                            }
                          </td>
                          <td class="p-2">
                            <span class="px-2 py-0.5 rounded text-xs"
                                  [class]="member.online_status === 'online' ? 'bg-green-500/20 text-green-400' : 
                                           member.online_status === 'recently' ? 'bg-yellow-500/20 text-yellow-400' : 
                                           'bg-slate-500/20 text-slate-400'">
                              {{ member.online_status === 'online' ? 'ğŸŸ¢ åœ¨ç·š' : 
                                 member.online_status === 'recently' ? 'ğŸŸ¡ æœ€è¿‘' : 'âšª é›¢ç·š' }}
                            </span>
                          </td>
                          <td class="p-2">
                            <div class="flex flex-col gap-0.5 text-xs">
                              @if (member.language_code) {
                                <span class="text-slate-400">ğŸŒ {{ member.language_code }}</span>
                              }
                              @if (member.dc_id) {
                                <span class="text-slate-400">DC{{ member.dc_id }}</span>
                              }
                              @if (member.chat_member_status && member.chat_member_status !== 'member') {
                                <span class="text-orange-400">{{ member.chat_member_status }}</span>
                              }
                            </div>
                          </td>
                          <td class="p-2">
                            <div class="flex items-center gap-1 flex-wrap">
                              @if (isChineseMember(member)) {
                                <span class="px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded text-xs" title="è¯äºº">ğŸ‡¨ğŸ‡³</span>
                              }
                              @if (member.is_premium) {
                                <span class="px-1.5 py-0.5 bg-yellow-500/20 text-yellow-400 rounded text-xs" title="Premium">â­</span>
                              }
                              @if (member.is_verified) {
                                <span class="px-1.5 py-0.5 bg-blue-500/20 text-blue-400 rounded text-xs" title="å·²èªè­‰">âœ“</span>
                              }
                              @if (member.is_bot) {
                                <span class="px-1.5 py-0.5 bg-purple-500/20 text-purple-400 rounded text-xs" title="Bot">ğŸ¤–</span>
                              }
                              @if (member.is_scam) {
                                <span class="px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded text-xs" title="è©é¨™">âš ï¸</span>
                              }
                              @if (member.is_deleted) {
                                <span class="px-1.5 py-0.5 bg-slate-500/20 text-slate-400 rounded text-xs" title="å·²åˆªé™¤">ğŸ—‘ï¸</span>
                              }
                              @if (member.has_photo) {
                                <span class="px-1.5 py-0.5 bg-green-500/20 text-green-400 rounded text-xs" title="æœ‰é ­åƒ">ğŸ“·</span>
                              }
                            </div>
                          </td>
                          <td class="p-2">
                            <div class="flex items-center gap-1">
                              @if (member.username) {
                                <button (click)="sendPrivateMessage(member)"
                                        class="px-2 py-1 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded text-xs"
                                        title="ç™¼é€ç§ä¿¡">
                                  ğŸ’¬
                                </button>
                              }
                            </div>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                }
              </div>
              
              <!-- æ‰¹é‡æ“ä½œæ¬„ -->
              @if (selectedMemberIds().length > 0) {
                <div class="mt-4 p-3 bg-purple-500/10 border border-purple-500/30 rounded-xl flex items-center justify-between">
                  <span class="text-sm text-purple-400">å·²é¸æ“‡ {{ selectedMemberIds().length }} å€‹æˆå“¡</span>
                  <div class="flex items-center gap-2">
                    <button (click)="batchSendPrivateMessage()"
                            class="px-3 py-1.5 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg text-sm">
                      ğŸ’¬ æ‰¹é‡ç§ä¿¡
                    </button>
                    <button (click)="batchAddFriend()"
                            class="px-3 py-1.5 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg text-sm">
                      â• æ‰¹é‡åŠ å¥½å‹
                    </button>
                  </div>
                </div>
              }
              } <!-- é—œé–‰éé »é“çš„ @else -->
            </div>
          </div>
        }

        <!-- ğŸ“¨ å–®å€‹ç¾¤çµ„ç™¼æ¶ˆæ¯å°è©±æ¡† -->
        @if (showSingleMessageDialog()) {
          <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60]" (click)="closeSingleMessageDialog()">
            <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-6 border border-purple-500/30" (click)="$event.stopPropagation()">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                  <span>ğŸ“¨</span> ç™¼é€æ¶ˆæ¯
                </h3>
                <button (click)="closeSingleMessageDialog()" class="text-slate-400 hover:text-white text-xl">âœ•</button>
              </div>
              
              <!-- ç›®æ¨™ç¾¤çµ„ -->
              @if (singleMessageResource(); as resource) {
                <div class="bg-slate-700/50 rounded-lg p-3 mb-4">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">{{ resource.resource_type === 'channel' ? 'ğŸ“¢' : 'ğŸ‘¥' }}</span>
                    <div>
                      <div class="font-medium text-white">{{ resource.title }}</div>
                      <div class="text-xs text-slate-400">{{ formatMemberCount(resource.member_count) }} æˆå“¡</div>
                    </div>
                  </div>
                </div>
              }
              
              <!-- é¸æ“‡ç™¼é€å¸³è™Ÿ -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  <span>ğŸ“±</span> é¸æ“‡ç™¼é€å¸³è™Ÿ
                </label>
                <select [(ngModel)]="singleMessageAccountId" 
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white">
                  <option value="">-- é¸æ“‡å¸³è™Ÿ --</option>
                  @for (account of accountQuotas(); track account.phone) {
                    <option [value]="account.phone">{{ account.phone }} (å‰©é¤˜ {{ account.dailyLimit - account.dailyUsed }} æ¢)</option>
                  }
                </select>
              </div>
              
              <!-- æ¶ˆæ¯å…§å®¹ -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  <span>ğŸ’¬</span> æ¶ˆæ¯å…§å®¹
                </label>
                <textarea [(ngModel)]="singleMessageContent" rows="4"
                          placeholder="è¼¸å…¥è¦ç™¼é€çš„æ¶ˆæ¯..."
                          class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white resize-none"></textarea>
              </div>
              
              <!-- å®šæ™‚ç™¼é€ -->
              <div class="mb-6">
                <label class="flex items-center gap-2 cursor-pointer mb-2">
                  <input type="checkbox" [checked]="singleMessageScheduled()" (change)="singleMessageScheduled.set(!singleMessageScheduled())"
                         class="w-4 h-4 rounded text-purple-500">
                  <span class="text-sm text-slate-300">â° å®šæ™‚ç™¼é€</span>
                </label>
                @if (singleMessageScheduled()) {
                  <input type="datetime-local" [(ngModel)]="singleMessageScheduleTime"
                         class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white">
                }
              </div>
              
              <!-- æ“ä½œæŒ‰éˆ• -->
              <div class="flex gap-3">
                <button (click)="closeSingleMessageDialog()" 
                        class="flex-1 px-4 py-2.5 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">
                  å–æ¶ˆ
                </button>
                <button (click)="executeSingleMessage()"
                        [disabled]="!singleMessageContent.trim() || !singleMessageAccountId()"
                        class="flex-1 px-4 py-2.5 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-lg font-medium disabled:opacity-50 flex items-center justify-center gap-2">
                  @if (singleMessageScheduled()) {
                    <span>â°</span>
                    <span>æ’ç¨‹ç™¼é€</span>
                  } @else {
                    <span>ğŸ“¨</span>
                    <span>ç«‹å³ç™¼é€</span>
                  }
                </button>
              </div>
            </div>
          </div>
        }
        
        <!-- ğŸ“¨ æ‰¹é‡ç¾¤å‘å¯¹è¯æ¡†ï¼ˆå¢å¼·ç‰ˆï¼‰ -->
        @if (showBatchMessageDialog()) {
          <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="showBatchMessageDialog.set(false)">
            <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl mx-4 p-6 border border-purple-500/30 max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                  <span>ğŸ“¨</span> {{ t('batchSendTitle') }}
                </h3>
                <button (click)="showBatchMessageDialog.set(false)" class="text-slate-400 hover:text-white text-xl">âœ•</button>
              </div>
              
              <div class="mb-4 p-3 bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/30 rounded-xl">
                <p class="text-sm text-purple-300">
                  {{ t('willSendTo') }} <span class="font-bold text-purple-400">{{ selectedResourceIds().length }}</span> {{ t('groupsCount') }}
                </p>
              </div>
              
              <!-- é¸æ“‡ç™¼é€å¸³è™Ÿ -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  <span>ğŸ“±</span> é¸æ“‡ç™¼é€å¸³è™Ÿ
                </label>
                <div class="space-y-2 max-h-32 overflow-y-auto">
                  <label class="flex items-center gap-3 p-2 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-700 border-2"
                         [class.border-purple-500]="batchMessageConfig.accountMode === 'rotate'"
                         [class.border-transparent]="batchMessageConfig.accountMode !== 'rotate'">
                    <input type="radio" name="batchAccountMode" value="rotate" 
                           [(ngModel)]="batchMessageConfig.accountMode" class="text-purple-500">
                    <div>
                      <span class="text-white">ğŸ”„ è¼ªæ›ç™¼é€ï¼ˆæ¨è–¦ï¼‰</span>
                      <p class="text-xs text-slate-400">å¤šå¸³è™Ÿå¹³å‡åˆ†é…ç™¼é€ä»»å‹™</p>
                    </div>
                  </label>
                  @for (account of accountQuotas(); track account.phone) {
                    <label class="flex items-center gap-3 p-2 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-700 border-2"
                           [class.border-purple-500]="batchMessageConfig.accountMode === account.phone"
                           [class.border-transparent]="batchMessageConfig.accountMode !== account.phone">
                      <input type="radio" name="batchAccountMode" [value]="account.phone" 
                             [(ngModel)]="batchMessageConfig.accountMode" class="text-purple-500">
                      <div class="flex-1">
                        <span class="text-white">{{ account.phone }}</span>
                        @if (account.isRecommended) {
                          <span class="text-xs bg-green-500/20 text-green-400 px-1 rounded ml-1">â­</span>
                        }
                        <p class="text-xs text-slate-400">ä»Šæ—¥å‰©é¤˜ {{ account.dailyLimit - account.dailyUsed }} æ¢</p>
                      </div>
                    </label>
                  }
                </div>
              </div>
              
              <!-- æ¶ˆæ¯å…§å®¹ -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-300 mb-2">{{ t('messageContent') }}</label>
                <textarea [(ngModel)]="batchMessageContent" rows="5"
                          [placeholder]="t('enterMessageContent')"
                          class="w-full bg-slate-700 border border-slate-600 rounded-lg py-3 px-4 text-white resize-none"></textarea>
                <p class="text-xs text-slate-500 mt-1">{{ t('variableHint') }}</p>
              </div>
              
              <!-- æ¶ˆæ¯é è¦½ -->
              @if (batchMessageContent.trim()) {
                <div class="mb-4 p-3 bg-slate-700/30 rounded-lg border border-slate-600">
                  <div class="text-xs text-slate-400 mb-1">ğŸ‘ï¸ é è¦½ç¬¬ä¸€æ¢æ¶ˆæ¯ï¼š</div>
                  <div class="text-sm text-white">{{ batchMessageContent.replace('{group_name}', 'ç¤ºä¾‹ç¾¤çµ„').replace('{member_count}', '1234') }}</div>
                </div>
              }
              
              <!-- ç™¼é€è¨­ç½® -->
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-sm text-slate-400 mb-2">{{ t('sendInterval') }}</label>
                  <select [(ngModel)]="batchMessageConfig.delayMin" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white">
                    <option [value]="30">30-60 {{ t('seconds') }}</option>
                    <option [value]="60">1-2 {{ t('minutes') }}</option>
                    <option [value]="120">2-3 {{ t('minutes') }}</option>
                    <option [value]="300">5-10 {{ t('minutes') }}</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-2">{{ t('dailyLimit') }}</label>
                  <select [(ngModel)]="batchMessageConfig.dailyLimit" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white">
                    <option [value]="20">20 {{ t('messages') }}</option>
                    <option [value]="50">50 {{ t('messages') }}</option>
                    <option [value]="100">100 {{ t('messages') }}</option>
                    <option [value]="200">200 {{ t('messages') }}</option>
                  </select>
                </div>
              </div>
              
              <!-- å®šæ™‚ç™¼é€é¸é … -->
              <div class="mb-4 p-3 bg-slate-700/30 rounded-lg border border-slate-600">
                <label class="flex items-center gap-2 cursor-pointer mb-2">
                  <input type="checkbox" [(ngModel)]="batchMessageConfig.scheduled" 
                         class="w-4 h-4 rounded text-purple-500">
                  <span class="text-sm text-slate-300">â° å®šæ™‚ç™¼é€</span>
                </label>
                @if (batchMessageConfig.scheduled) {
                  <input type="datetime-local" [(ngModel)]="batchMessageConfig.scheduleTime"
                         class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white mt-2">
                }
              </div>
              
              <div class="mb-4">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" [(ngModel)]="batchMessageConfig.smartAntiBlock" 
                         class="w-4 h-4 rounded text-purple-500">
                  <span class="text-sm text-slate-300">ğŸ›¡ï¸ {{ t('smartAntiBlock') }}</span>
                </label>
              </div>
              
              <div class="flex gap-3">
                <button (click)="showBatchMessageDialog.set(false)" 
                        class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2.5 rounded-lg transition-colors">
                  {{ t('cancel') }}
                </button>
                <button (click)="executeBatchMessage()" 
                        [disabled]="!batchMessageContent.trim()"
                        class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:opacity-90 text-white py-2.5 rounded-lg transition-all disabled:opacity-50 font-medium flex items-center justify-center gap-2">
                  @if (batchMessageConfig.scheduled) {
                    <span>â°</span>
                    <span>æ’ç¨‹ç™¼é€</span>
                  } @else {
                    <span>ğŸ“¨</span>
                    <span>{{ t('startSending') }}</span>
                  }
                </button>
              </div>
            </div>
          </div>
        }
        
        <!-- â• æ‰¹é‡æ‹‰ç¾¤å¯¹è¯æ¡† -->
        @if (showBatchInviteDialog()) {
          <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="showBatchInviteDialog.set(false)">
            <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl mx-4 p-6 border border-orange-500/30" (click)="$event.stopPropagation()">
              <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <span>â•</span> {{ t('batchInvite') }}
              </h3>
              
              <div class="mb-4 p-3 bg-orange-500/10 border border-orange-500/30 rounded-lg">
                <p class="text-sm text-orange-300">
                  {{ t('willInviteTo') }} <span class="font-bold text-orange-400">{{ selectedResourceIds().length }}</span> {{ t('groupsCount') }}
                </p>
              </div>
              
              <div class="mb-4">
                <label class="block text-sm text-slate-400 mb-2">{{ t('selectMembersToInvite') }}</label>
                <div class="bg-slate-700/50 rounded-lg p-4 max-h-48 overflow-y-auto border border-slate-600">
                  @if (availableMembersForInvite().length === 0) {
                    <p class="text-sm text-slate-500 text-center py-4">{{ t('noAvailableMembers') }}</p>
                  } @else {
                    <div class="space-y-2">
                      <label class="flex items-center gap-2 p-2 hover:bg-slate-600/50 rounded cursor-pointer">
                        <input type="checkbox" 
                               [checked]="batchInviteConfig.selectAll"
                               (change)="toggleSelectAllMembers($event)"
                               class="rounded text-orange-500 bg-slate-600 border-slate-500">
                        <span class="text-sm text-slate-300">{{ t('selectAll') }} ({{ availableMembersForInvite().length }} {{ t('person') }})</span>
                      </label>
                      @for (member of availableMembersForInvite().slice(0, 10); track member.id) {
                        <label class="flex items-center gap-2 p-2 hover:bg-slate-600/50 rounded cursor-pointer">
                          <input type="checkbox" 
                                 [checked]="batchInviteConfig.selectedMemberIds.includes(member.id)"
                                 (change)="toggleMemberSelection(member.id, $event)"
                                 class="rounded text-orange-500 bg-slate-600 border-slate-500">
                          <span class="text-sm text-slate-300">{{ member.name || member.username || member.id }}</span>
                          @if (member.username) {
                            <span class="text-xs text-slate-500">@{{ member.username }}</span>
                          }
                        </label>
                      }
                      @if (availableMembersForInvite().length > 10) {
                        <p class="text-xs text-slate-500 text-center pt-2">
                          {{ t('moreMembers', {count: availableMembersForInvite().length - 10}) }}
                        </p>
                      }
                    </div>
                  }
                </div>
                <p class="text-xs text-slate-500 mt-2">
                  {{ t('selectedMembers') }} {{ batchInviteConfig.selectedMemberIds.length }} {{ t('membersUnit') }}
                </p>
              </div>
              
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-sm text-slate-400 mb-2">{{ t('inviteInterval') }}</label>
                  <select [(ngModel)]="batchInviteConfig.delayMin" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white">
                    <option [value]="60">1-2 {{ t('minutes') }}</option>
                    <option [value]="120">2-3 {{ t('minutes') }}</option>
                    <option [value]="300">5-10 {{ t('minutes') }}</option>
                    <option [value]="600">10-15 {{ t('minutes') }}</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-2">{{ t('perGroupLimit') }}</label>
                  <input type="number" [(ngModel)]="batchInviteConfig.perGroupLimit" min="1" max="50" value="10"
                         class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white">
                </div>
              </div>
              
              <div class="mb-4">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" [(ngModel)]="batchInviteConfig.smartAntiBlock" 
                         class="rounded text-orange-500 bg-slate-700 border-slate-600">
                  <span class="text-sm text-slate-300">{{ t('smartAntiBlockInvite') }}</span>
                </label>
              </div>
              
              <div class="flex gap-3">
                <button (click)="showBatchInviteDialog.set(false)" 
                        class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2.5 rounded-lg transition-colors">
                  {{ t('cancel') }}
                </button>
                <button (click)="executeBatchInvite()" 
                        [disabled]="batchInviteConfig.selectedMemberIds.length === 0"
                        class="flex-1 bg-gradient-to-r from-orange-500 to-red-500 hover:opacity-90 text-white py-2.5 rounded-lg transition-all disabled:opacity-50 font-medium">
                  {{ t('startInvite') }}
                </button>
              </div>
            </div>
          </div>
        }
        } @else {
        <!-- è®¨è®ºç»„ç›‘æ§ Tab -->
        
        <!-- è¨è«–çµ„çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-slate-900/50 border border-purple-500/30 p-4 rounded-xl text-center">
            <div class="text-2xl mb-1">ğŸ’¬</div>
            <div class="text-xl font-bold text-purple-400">{{ discussionStats().total_discussions }}</div>
            <div class="text-xs text-slate-400">è¨è«–çµ„ç¸½æ•¸</div>
          </div>
          <div class="bg-slate-900/50 border border-green-500/30 p-4 rounded-xl text-center">
            <div class="text-2xl mb-1">ğŸŸ¢</div>
            <div class="text-xl font-bold text-green-400">{{ discussionStats().monitoring_count }}</div>
            <div class="text-xs text-slate-400">ç›£æ§ä¸­</div>
          </div>
          <div class="bg-slate-900/50 border border-cyan-500/30 p-4 rounded-xl text-center">
            <div class="text-2xl mb-1">ğŸ“¨</div>
            <div class="text-xl font-bold text-cyan-400">{{ discussionStats().today_messages }}</div>
            <div class="text-xs text-slate-400">ä»Šæ—¥æ¶ˆæ¯</div>
          </div>
          <div class="bg-slate-900/50 border border-yellow-500/30 p-4 rounded-xl text-center">
            <div class="text-2xl mb-1">ğŸ‘¤</div>
            <div class="text-xl font-bold text-yellow-400">{{ discussionStats().leads_from_discussions }}</div>
            <div class="text-xs text-slate-400">æ•ç²çš„ Lead</div>
          </div>
        </div>
        
        <!-- æ“ä½œå€ -->
        <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl mb-6">
          <div class="flex items-center gap-4 mb-4">
            <span class="px-3 py-1.5 rounded-lg text-sm" [class]="discussionWatcherInitialized() ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'">
              {{ discussionWatcherInitialized() ? 'ğŸŸ¢ æœå‹™åœ¨ç·š' : 'ğŸ”´ æœªåˆå§‹åŒ–' }}
            </span>
            <button (click)="initDiscussionWatcher()" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg border border-purple-500/30">
              ğŸš€ åˆå§‹åŒ–ç›£æ§æœå‹™
            </button>
            <button (click)="discoverDiscussionsFromResources()" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg border border-cyan-500/30">
              ğŸ”„ å¾è³‡æºç™¼ç¾è¨è«–çµ„
            </button>
            <button (click)="refreshDiscussionStats()" class="px-4 py-2 bg-slate-500/20 hover:bg-slate-500/30 text-slate-400 rounded-lg">
              ğŸ”„ åˆ·æ–°
            </button>
          </div>
          
          <!-- æ‰‹å‹•æ·»åŠ é »é“ -->
          <div class="flex gap-3">
            <input type="text" [(ngModel)]="discoverChannelId" (keyup.enter)="discoverDiscussion()"
                   placeholder="è¼¸å…¥é »é“ ID æˆ– @username ç™¼ç¾è¨è«–çµ„..."
                   class="flex-1 bg-slate-700/50 border border-slate-600 rounded-lg py-2 px-3 text-white">
            <button (click)="discoverDiscussion()" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg">
              ğŸ” ç™¼ç¾è¨è«–çµ„
            </button>
          </div>
        </div>
        
        <!-- è¨è«–çµ„åˆ—è¡¨ -->
        <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl">
          <h3 class="text-lg font-semibold text-white mb-4">ğŸ“‹ é »é“-è¨è«–çµ„åˆ—è¡¨</h3>
          
          @if (channelDiscussions().length === 0) {
            <div class="text-center py-12 text-slate-500">
              <div class="text-5xl mb-4">ğŸ’¬</div>
              <p class="text-lg">æš«ç„¡è¨è«–çµ„</p>
              <p class="text-sm mt-2">å¾å·²åŠ å…¥çš„é »é“ç™¼ç¾è¨è«–çµ„ï¼Œæˆ–æ‰‹å‹•æ·»åŠ é »é“</p>
            </div>
          } @else {
            <div class="space-y-3">
              @for (disc of channelDiscussions(); track disc.id) {
                <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700 hover:border-purple-500/30 transition-all">
                  <div class="flex items-center justify-between">
                    <div class="flex-1">
                      <div class="flex items-center gap-3 mb-2">
                        <span class="text-lg">ğŸ“º</span>
                        <span class="font-medium text-white">{{ disc.channel_title }}</span>
                        <span class="text-slate-500">â†’</span>
                        <span class="text-lg">ğŸ’¬</span>
                        <span class="font-medium text-purple-400">{{ disc.discussion_title }}</span>
                      </div>
                      <div class="flex items-center gap-4 text-sm text-slate-400">
                        <span>ğŸ“¨ {{ disc.message_count }} æ¶ˆæ¯</span>
                        <span>ğŸ‘¤ {{ disc.lead_count }} Lead</span>
                        @if (disc.last_message_at) {
                          <span>ğŸ• {{ disc.last_message_at | date:'MM/dd HH:mm' }}</span>
                        }
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      @if (disc.is_monitoring) {
                        <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs">ç›£æ§ä¸­</span>
                        <button (click)="stopDiscussionMonitoring(disc.discussion_id)" class="px-3 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded">
                          åœæ­¢
                        </button>
                      } @else {
                        <button (click)="startDiscussionMonitoring(disc.discussion_id)" class="px-3 py-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded">
                          é–‹å§‹ç›£æ§
                        </button>
                      }
                      <button (click)="loadDiscussionMessages(disc.discussion_id)" class="px-3 py-1 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded">
                        æŸ¥çœ‹æ¶ˆæ¯
                      </button>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
        
        <!-- è¨è«–çµ„æ¶ˆæ¯åˆ—è¡¨ï¼ˆç•¶é¸ä¸­æ™‚é¡¯ç¤ºï¼‰ -->
        @if (selectedDiscussionId()) {
          <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl mt-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-white">ğŸ“¨ è¨è«–çµ„æ¶ˆæ¯</h3>
              <div class="flex items-center gap-3">
                <button (click)="loadDiscussionMessages(selectedDiscussionId())" 
                        class="px-3 py-1.5 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg text-sm flex items-center gap-2">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                  </svg>
                  åˆ·æ–°
                </button>
                <button (click)="selectedDiscussionId.set('')" class="text-slate-400 hover:text-white">âœ• é—œé–‰</button>
              </div>
            </div>
            
            @if (isLoadingDiscussionMessages()) {
              <div class="text-center py-8 text-slate-400">
                <svg class="animate-spin h-8 w-8 mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
                </svg>
                åŠ è¼‰ä¸­...
              </div>
            } @else if (discussionMessages().length === 0) {
              <div class="text-center py-8 text-slate-500">
                <p>æš«ç„¡æ¶ˆæ¯</p>
              </div>
            } @else {
              <div class="space-y-3 max-h-[600px] overflow-y-auto">
                @for (msg of discussionMessages(); track msg.id) {
                  <div class="p-4 rounded-lg border transition-all" 
                       [class.bg-yellow-500/10]="msg.is_matched" 
                       [class.border-yellow-500/30]="msg.is_matched"
                       [class.bg-slate-800/50]="!msg.is_matched"
                       [class.border-slate-700]="!msg.is_matched">
                    <div class="flex items-start justify-between mb-2">
                      <div class="flex items-center gap-2 flex-1">
                        <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 font-semibold">
                          {{ (msg.first_name || msg.username || '?').charAt(0).toUpperCase() }}
                        </div>
                        <div>
                          <div class="flex items-center gap-2">
                            <span class="font-medium text-white">{{ msg.first_name || '@' + msg.username || 'æœªçŸ¥ç”¨æˆ·' }}</span>
                            @if (msg.username) {
                              <span class="text-xs text-slate-400">@{{ msg.username }}</span>
                            }
                            @if (msg.is_matched) {
                              <span class="px-2 py-0.5 bg-yellow-500/20 text-yellow-400 rounded text-xs">ğŸ¯ åŒ¹é…</span>
                            }
                            @if (msg.is_replied) {
                              <span class="px-2 py-0.5 bg-green-500/20 text-green-400 rounded text-xs">âœ“ å·²å›å¤</span>
                            }
                          </div>
                          <span class="text-xs text-slate-500">{{ msg.created_at | date:'yyyy-MM-dd HH:mm:ss' }}</span>
                        </div>
                      </div>
                    </div>
                    
                    <p class="text-sm text-slate-300 mb-2 whitespace-pre-wrap">{{ msg.message_text || '(æ— æ–‡æœ¬å†…å®¹)' }}</p>
                    
                    @if (msg.matched_keywords && msg.matched_keywords.length > 0) {
                      <div class="mb-2">
                        <span class="text-xs text-slate-400 mr-2">åŒ¹é…å…³é”®è¯:</span>
                        @for (kw of msg.matched_keywords; track kw) {
                          <span class="px-2 py-0.5 bg-yellow-500/20 text-yellow-400 rounded text-xs mr-1">{{ kw }}</span>
                        }
                      </div>
                    }
                    
                    @if (msg.sentiment !== undefined) {
                      <div class="mb-2">
                        <span class="text-xs text-slate-400">æƒ…æ„Ÿåˆ†æ:</span>
                        <div class="inline-flex items-center gap-2 ml-2">
                          <div class="w-24 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all" 
                                 [class.bg-red-500]="msg.sentiment < 0.3"
                                 [class.bg-yellow-500]="msg.sentiment >= 0.3 && msg.sentiment < 0.7"
                                 [class.bg-green-500]="msg.sentiment >= 0.7"
                                 [style.width.%]="msg.sentiment * 100">
                            </div>
                          </div>
                          <span class="text-xs text-slate-400">{{ (msg.sentiment * 100).toFixed(0) }}%</span>
                        </div>
                      </div>
                    }
                    
                    @if (msg.intent) {
                      <div class="mb-2">
                        <span class="text-xs text-slate-400">æ„å›¾:</span>
                        <span class="ml-2 px-2 py-0.5 bg-blue-500/20 text-blue-400 rounded text-xs">{{ msg.intent }}</span>
                      </div>
                    }
                    
                    @if (!msg.is_replied) {
                      <div class="mt-3 pt-3 border-t border-slate-700">
                        <div class="flex items-center gap-2">
                          <input type="text" 
                                 [(ngModel)]="discussionReplyText"
                                 (keyup.enter)="replyToDiscussion(msg.message_id, msg.discussion_id, discussionReplyText())"
                                 placeholder="è¾“å…¥å›å¤æ¶ˆæ¯..." 
                                 class="flex-1 bg-slate-700/50 border border-slate-600 rounded-lg py-2 px-3 text-white text-sm">
                          <button (click)="replyToDiscussion(msg.message_id, msg.discussion_id, discussionReplyText())" 
                                  class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg text-sm">
                            å›å¤
                          </button>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
        }
      }
      @case ('automation') {
        <!-- ğŸ†• æ•´åˆç‰ˆè‡ªå‹•åŒ–ä¸­å¿ƒ -->
        <app-automation-center 
          class="block h-full -m-8"
          [isMonitoring]="isMonitoring()"
          [realKeywordSets]="keywordSets()"
          [realMonitoredGroups]="monitoredGroups()"
          [realAccounts]="accounts()"
          [realtimeMatches]="realtimeMatches()"
          [todayStats]="todayStats()"
          (startMonitoringClick)="startMonitoring()"
          (stopMonitoringClick)="stopMonitoring()"
          (addAccountClick)="changeView('add-account')"
          (addGroupClick)="showAddGroupDialog()"
          (addKeywordSetClick)="showAddKeywordSetDialog()"
          (saveGroupConfig)="handleSaveGroupConfig($event)"
          (saveKeywordSetConfig)="handleSaveKeywordSetConfig($event)">
        </app-automation-center>
      }
      @case ('automation-legacy') {
        <!-- èˆŠç‰ˆè‡ªå‹•åŒ–ä¸­å¿ƒï¼ˆå·²æ£„ç”¨ï¼Œä¿ç•™å‚™ä»½ï¼‰ -->
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-4xl font-bold text-slate-900 dark:text-white">{{ t('automationHub') }}</h2>
          <div class="flex items-center gap-4">
            <span class="text-sm" [class.text-green-400]="isMonitoring()" [class.text-slate-400]="!isMonitoring()">
              {{ isMonitoring() ? 'ç›‘æ§ä¸­' : 'ç›‘æ§å·²åœæ­¢' }}
              <span class="inline-block w-2 h-2 rounded-full ml-2" [class.bg-green-400]="isMonitoring()" [class.bg-slate-400]="!isMonitoring()" [class.animate-pulse]="isMonitoring()"></span>
            </span>
            @if(!isMonitoring()) {
              <button (click)="startMonitoring()" [disabled]="isStartingMonitoring()" [class.opacity-50]="isStartingMonitoring()" [class.cursor-not-allowed]="isStartingMonitoring()" class="bg-green-500 hover:bg-green-600 disabled:bg-green-400 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg shadow-green-500/20 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                å¼€å§‹ç›‘æ§
              </button>
            } @else {
              <button (click)="stopMonitoring()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg shadow-red-500/20 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/></svg>
                åœæ­¢ç›‘æ§
              </button>
            }
          </div>
        </div>
        
        <!-- ğŸ†• å¿«é€Ÿè¨­ç½®å¼•å°é¢æ¿ï¼ˆæœªæª¢æŸ¥æˆ–æœ‰å•é¡Œæ™‚é¡¯ç¤ºï¼‰ -->
        @if (!lastConfigCheck() || !lastConfigCheck()!.passed) {
          <div class="mb-6 bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border border-cyan-500/30 rounded-xl p-4">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸš€</span>
                <h3 class="text-lg font-semibold text-white">å¿«é€Ÿè¨­ç½®å¼•å°</h3>
              </div>
              <button (click)="checkAutomationConfig()" 
                      class="px-3 py-1.5 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg text-sm border border-cyan-500/30">
                ğŸ” æª¢æŸ¥é…ç½®
              </button>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <!-- æ­¥é©Ÿ1: å¸³è™Ÿ -->
              <div class="bg-slate-800/50 rounded-lg p-3 cursor-pointer hover:bg-slate-700/50 transition-all"
                   (click)="navigateToView('accounts')">
                <div class="flex items-center gap-2 mb-2">
                  <span class="w-6 h-6 bg-slate-700 rounded-full flex items-center justify-center text-xs font-bold"
                        [class.bg-green-500]="getListenerAccounts().length > 0"
                        [class.text-white]="getListenerAccounts().length > 0">1</span>
                  <span class="font-medium text-sm text-white">ç›£æ§å¸³è™Ÿ</span>
                </div>
                @if (getListenerAccounts().length > 0) {
                  <div class="text-xs text-green-400">âœ“ å·²è¨­ç½® {{ getListenerAccounts().length }} å€‹ç›£æ§è™Ÿ</div>
                } @else {
                  <div class="text-xs text-slate-400">éœ€è¦è‡³å°‘ 1 å€‹ã€Œç›£æ§è™Ÿã€</div>
                }
              </div>
              
              <!-- æ­¥é©Ÿ2: ç›£æ§ç¾¤çµ„ -->
              <div class="bg-slate-800/50 rounded-lg p-3 cursor-pointer hover:bg-slate-700/50 transition-all"
                   (click)="navigateToAutomationTab('targets')">
                <div class="flex items-center gap-2 mb-2">
                  <span class="w-6 h-6 bg-slate-700 rounded-full flex items-center justify-center text-xs font-bold"
                        [class.bg-green-500]="monitoredGroups().length > 0"
                        [class.text-white]="monitoredGroups().length > 0">2</span>
                  <span class="font-medium text-sm text-white">ç›£æ§ç¾¤çµ„</span>
                </div>
                @if (monitoredGroups().length > 0) {
                  <div class="text-xs text-green-400">âœ“ å·²æ·»åŠ  {{ monitoredGroups().length }} å€‹ç¾¤çµ„</div>
                } @else {
                  <div class="text-xs text-slate-400">æ·»åŠ è¦ç›£æ§çš„ç¾¤çµ„</div>
                }
              </div>
              
              <!-- æ­¥é©Ÿ3: é—œéµè© -->
              <div class="bg-slate-800/50 rounded-lg p-3 cursor-pointer hover:bg-slate-700/50 transition-all"
                   (click)="navigateToAutomationTab('keywords')">
                <div class="flex items-center gap-2 mb-2">
                  <span class="w-6 h-6 bg-slate-700 rounded-full flex items-center justify-center text-xs font-bold"
                        [class.bg-green-500]="keywordSets().length > 0"
                        [class.text-white]="keywordSets().length > 0">3</span>
                  <span class="font-medium text-sm text-white">é—œéµè©</span>
                </div>
                @if (keywordSets().length > 0) {
                  <div class="text-xs text-green-400">âœ“ å·²è¨­ç½® {{ keywordSets().length }} çµ„é—œéµè©</div>
                } @else {
                  <div class="text-xs text-slate-400">è¨­ç½®è§¸ç™¼é—œéµè©</div>
                }
              </div>
              
              <!-- æ­¥é©Ÿ4: ç™¼é€å¸³è™Ÿ -->
              <div class="bg-slate-800/50 rounded-lg p-3 cursor-pointer hover:bg-slate-700/50 transition-all"
                   (click)="navigateToView('accounts')">
                <div class="flex items-center gap-2 mb-2">
                  <span class="w-6 h-6 bg-slate-700 rounded-full flex items-center justify-center text-xs font-bold"
                        [class.bg-green-500]="getSenderAccounts().length > 0"
                        [class.text-white]="getSenderAccounts().length > 0">4</span>
                  <span class="font-medium text-sm text-white">ç™¼é€å¸³è™Ÿ</span>
                </div>
                @if (getSenderAccounts().length > 0) {
                  <div class="text-xs text-green-400">âœ“ å·²è¨­ç½® {{ getSenderAccounts().length }} å€‹ç™¼é€è™Ÿ</div>
                } @else {
                  <div class="text-xs text-yellow-400">å»ºè­°è¨­ç½®ç™¼é€è™Ÿ</div>
                }
              </div>
            </div>
            
            <!-- ä¸€éµå¿«é€Ÿé…ç½®æç¤º -->
            @if (getListenerAccounts().length === 0 && getOnlineAccountsCount() > 0) {
              <div class="mt-4 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="text-yellow-400">ğŸ’¡</span>
                  <span class="text-sm text-yellow-300">æ‚¨æœ‰ {{ getOnlineAccountsCount() }} å€‹åœ¨ç·šå¸³è™Ÿï¼Œä½†å°šæœªåˆ†é…è§’è‰²</span>
                </div>
                <button (click)="navigateToView('accounts')" class="px-3 py-1.5 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 rounded-lg text-sm">
                  å‰å¾€åˆ†é…è§’è‰² â†’
                </button>
              </div>
            }
          </div>
        }
        
        <!-- é…ç½®æª¢æŸ¥ç‹€æ…‹é¢æ¿ -->
        @if(lastConfigCheck()) {
            <div class="mb-6 bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border rounded-xl shadow-lg overflow-hidden"
                 [class.border-red-500/50]="!lastConfigCheck()!.passed"
                 [class.border-yellow-500/50]="lastConfigCheck()!.passed && lastConfigCheck()!.warnings.length > 0"
                 [class.border-green-500/50]="lastConfigCheck()!.passed && lastConfigCheck()!.warnings.length === 0">
                
                <!-- æ¨™é¡Œæ¬„ -->
                <div class="px-4 py-3 flex items-center justify-between"
                     [class.bg-red-500/10]="!lastConfigCheck()!.passed"
                     [class.bg-yellow-500/10]="lastConfigCheck()!.passed && lastConfigCheck()!.warnings.length > 0"
                     [class.bg-green-500/10]="lastConfigCheck()!.passed && lastConfigCheck()!.warnings.length === 0">
                    <div class="flex items-center gap-2">
                        @if(!lastConfigCheck()!.passed) {
                            <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span class="font-semibold text-red-400">é…ç½®æª¢æŸ¥å¤±æ•—</span>
                        } @else if(lastConfigCheck()!.warnings.length > 0) {
                            <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span class="font-semibold text-yellow-400">é…ç½®æœ‰è­¦å‘Š</span>
                        } @else {
                            <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="font-semibold text-green-400">é…ç½®æª¢æŸ¥é€šé</span>
                        }
                    </div>
                    <button (click)="lastConfigCheck.set(null)" class="text-slate-400 hover:text-slate-300 text-sm">é—œé–‰</button>
                </div>
                
                <div class="px-4 py-3 space-y-2">
                    <!-- åš´é‡å•é¡Œ -->
                    @for(issue of lastConfigCheck()!.critical_issues; track issue.code) {
                        <div (click)="navigateToError(issue.code)" 
                             class="flex items-start gap-2 p-2 bg-red-500/10 rounded-lg cursor-pointer hover:bg-red-500/20 transition-colors group">
                            <span class="text-red-400">âœ—</span>
                            <div class="flex-1">
                                <p class="text-sm text-red-400 font-medium">{{ issue.message }}</p>
                                <p class="text-xs text-slate-400 mt-1">ä¿®å¾©: {{ issue.fix }}</p>
                            </div>
                            <span class="text-xs text-slate-500 group-hover:text-cyan-400 transition-colors">é»æ“Šå‰å¾€ â†’</span>
                        </div>
                    }
                    
                    <!-- è­¦å‘Š -->
                    @for(warning of lastConfigCheck()!.warnings; track warning.code) {
                        <div (click)="navigateToError(warning.code)" 
                             class="flex items-start gap-2 p-2 bg-yellow-500/10 rounded-lg cursor-pointer hover:bg-yellow-500/20 transition-colors group">
                            <span class="text-yellow-400">âš </span>
                            <div class="flex-1">
                                <p class="text-sm text-yellow-400 font-medium">{{ warning.message }}</p>
                                <p class="text-xs text-slate-400 mt-1">ä¿®å¾©: {{ warning.fix }}</p>
                            </div>
                            <span class="text-xs text-slate-500 group-hover:text-cyan-400 transition-colors">é»æ“Šå‰å¾€ â†’</span>
                        </div>
                    }
                    
                    <!-- ä¿¡æ¯ï¼ˆæ‘ºç–Šé¡¯ç¤ºï¼‰ -->
                    @if(lastConfigCheck()!.info.length > 0) {
                        <details class="mt-2">
                            <summary class="text-sm text-slate-400 cursor-pointer hover:text-slate-300">
                                æŸ¥çœ‹ {{ lastConfigCheck()!.info.length }} é …é…ç½®è©³æƒ…
                            </summary>
                            <div class="mt-2 space-y-1 pl-4">
                                @for(info of lastConfigCheck()!.info; track info) {
                                    <p class="text-sm text-slate-400">{{ info }}</p>
                                }
                            </div>
                        </details>
                    }
                    
                    <!-- æ‘˜è¦ -->
                    @if(lastConfigCheck()!.summary) {
                        <div class="flex items-center gap-4 mt-3 pt-3 border-t border-slate-700/50 text-xs text-slate-400">
                            <span [class.text-green-400]="lastConfigCheck()!.summary.can_monitor" [class.text-red-400]="!lastConfigCheck()!.summary.can_monitor">
                                ç›£æ§: {{ lastConfigCheck()!.summary.can_monitor ? 'å¯å•Ÿå‹•' : 'ç„¡æ³•å•Ÿå‹•' }}
                            </span>
                            <span [class.text-green-400]="lastConfigCheck()!.summary.can_send_messages" [class.text-yellow-400]="!lastConfigCheck()!.summary.can_send_messages">
                                ç™¼é€æ¶ˆæ¯: {{ lastConfigCheck()!.summary.can_send_messages ? 'å¯ç™¼é€' : 'ç„¡æ³•ç™¼é€' }}
                            </span>
                        </div>
                    }
                </div>
            </div>
        }
        
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8 items-start">
            <!-- Column 1: Monitoring Targets -->
            <div class="space-y-8">
                <div id="keyword-sets-section" class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg transition-all duration-300">
                    <h3 class="text-xl mb-4 font-semibold">{{ t('monitoringTargets') }}</h3>
                    <div class="space-y-4">
                        <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-semibold">{{ t('keywordSets') }}</h4>
                                <!-- é—œéµè©é›†é…é¡é¡¯ç¤º -->
                                <span class="text-xs px-2 py-1 rounded-full"
                                      [class]="membershipService.quotas().maxKeywordSets === -1 ? 'bg-emerald-500/20 text-emerald-400' : 
                                               (keywordSets().length >= membershipService.quotas().maxKeywordSets ? 'bg-red-500/20 text-red-400' : 'bg-slate-500/20 text-slate-400')">
                                    {{ keywordSets().length }}/{{ membershipService.quotas().maxKeywordSets === -1 ? 'âˆ' : membershipService.quotas().maxKeywordSets }}
                                </span>
                            </div>
                            <form (submit)="addKeywordSet()" class="flex items-end gap-2">
                                <div class="flex-grow"><input [(ngModel)]="newKeywordSet().name" name="keywordSetName" class="form-input w-full bg-slate-100 dark:bg-slate-700/50 border-slate-300 dark:border-slate-600 rounded-lg p-2 text-sm" [placeholder]="t('newKeywordSet')"></div>
                                <button type="submit" 
                                        [disabled]="membershipService.quotas().maxKeywordSets !== -1 && keywordSets().length >= membershipService.quotas().maxKeywordSets"
                                        [class.opacity-50]="membershipService.quotas().maxKeywordSets !== -1 && keywordSets().length >= membershipService.quotas().maxKeywordSets"
                                        [class.cursor-not-allowed]="membershipService.quotas().maxKeywordSets !== -1 && keywordSets().length >= membershipService.quotas().maxKeywordSets"
                                        class="bg-cyan-500 hover:bg-cyan-600 disabled:hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20 text-sm">{{ t('add') }}</button>
                            </form>
                             @for(set of keywordSets(); track set.id) {
                                <div class="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg mt-3 border border-slate-200 dark:border-slate-600">
                                    <div class="flex justify-between items-center mb-3">
                                        <h5 class="font-semibold">{{set.name}}</h5>
                                        <button (click)="removeById(keywordSets, set.id, 'keyword-set')" class="text-red-400 hover:text-red-300 hover:bg-red-500/10 text-lg font-bold px-1 rounded transition-colors" title="åˆªé™¤é—œéµè©é›†">Ã—</button>
                                    </div>
                                    
                                    <!-- é—œéµè©è¼¸å…¥è¡¨å–® -->
                                    <form (submit)="addKeyword(); $event.preventDefault()" class="space-y-2">
                                        <div class="flex items-end gap-2">
                                            <div class="flex-1">
                                                <input 
                                                    [(ngModel)]="newKeyword().keyword" 
                                                    (focus)="newKeyword.set({setId: set.id, keyword: '', isRegex: newKeyword().isRegex})" 
                                                    (keyup.enter)="addKeyword()"
                                                    name="keyword" 
                                                    class="form-input w-full bg-slate-200 dark:bg-slate-800/50 border-slate-300 dark:border-slate-600 rounded-lg p-2 text-sm" 
                                                    [placeholder]="t('addKeywordPlaceholder')"
                                                    [class.border-red-400]="newKeyword().isRegex && newKeyword().keyword && !isRegexValid(newKeyword().keyword)">
                                                @if(newKeyword().isRegex && newKeyword().keyword && !isRegexValid(newKeyword().keyword)) {
                                                    <p class="text-xs text-red-400 mt-1">âš ï¸ {{ t('invalidRegex') }}: {{ getRegexError(newKeyword().keyword) }}</p>
                                                }
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="relative group">
                                                    <label class="flex items-center gap-2 text-sm h-full cursor-pointer">
                                                        <input 
                                                            type="checkbox" 
                                                            [(ngModel)]="newKeyword().isRegex" 
                                                            (focus)="newKeyword.set({setId: set.id, keyword: newKeyword().keyword, isRegex: false})" 
                                                            name="isRegex" 
                                                            class="form-checkbox bg-slate-200 dark:bg-slate-800/50 border-slate-300 dark:border-slate-600 rounded text-cyan-500"> 
                                                        <span class="text-slate-700 dark:text-slate-300">{{ t('regex') }}</span>
                                                    </label>
                                                    <!-- æ­£å‰‡è¡¨é”å¼å·¥å…·æç¤º -->
                                                    <div class="absolute z-10 hidden group-hover:block bottom-full mb-2 left-0 w-80 bg-slate-900 text-white text-xs rounded-lg p-3 shadow-lg">
                                                        <h4 class="font-bold mb-2">{{ t('regexTooltip') }}</h4>
                                                        <div class="space-y-1 text-slate-300">
                                                            <p class="font-semibold text-cyan-400 mb-1">{{ t('regexExamples') }}:</p>
                                                            <p>â€¢ {{ t('regexExample1') }}</p>
                                                            <p>â€¢ {{ t('regexExample2') }}</p>
                                                            <p>â€¢ {{ t('regexExample3') }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button 
                                                    type="submit" 
                                                    [disabled]="newKeyword().setId !== set.id || !newKeyword().keyword.trim()" 
                                                    [title]="newKeyword().setId !== set.id ? t('selectKeywordSetFirst') : (newKeyword().keyword.trim() ? t('addKeywordButton') : t('keywordEmpty'))"
                                                    class="bg-cyan-500 hover:bg-cyan-600 disabled:bg-slate-400 disabled:cursor-not-allowed text-white font-bold py-2 px-3 rounded-lg text-sm transition duration-200 flex items-center gap-1">
                                                    <span>+</span>
                                                    <span class="hidden sm:inline">{{ t('addKeywordButton') }}</span>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- æ¸¬è©¦åŠŸèƒ½ -->
                                        @if(newKeyword().setId === set.id && newKeyword().keyword.trim()) {
                                            <div class="bg-slate-100 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-300 dark:border-slate-600">
                                                <p class="text-xs text-slate-600 dark:text-slate-400 mb-1">{{ t('testKeyword') }}:</p>
                                                <div class="flex gap-2">
                                                    <input 
                                                        [(ngModel)]="testKeywordText" 
                                                        (keyup.enter)="testKeyword()"
                                                        (input)="onTestTextInput($event)"
                                                        name="testKeywordText"
                                                        [placeholder]="t('testKeywordPlaceholder')" 
                                                        class="flex-1 form-input bg-slate-200 dark:bg-slate-700/50 border-slate-300 dark:border-slate-600 rounded-lg p-1.5 text-xs">
                                                    <button 
                                                        type="button"
                                                        (click)="testKeyword()" 
                                                        [disabled]="!testKeywordText().trim()"
                                                        class="bg-blue-500 hover:bg-blue-600 disabled:bg-slate-400 disabled:cursor-not-allowed text-white font-bold py-1.5 px-3 rounded-lg text-xs transition duration-200">
                                                        {{ t('testKeyword') }}
                                                    </button>
                                                </div>
                                                @if(keywordTestResult()) {
                                                    <div class="mt-2 p-1.5 rounded text-xs" [class.bg-green-500/20]="keywordTestResult()!.matches" [class.bg-red-500/20]="!keywordTestResult()!.matches" [class.text-green-400]="keywordTestResult()!.matches" [class.text-red-400]="!keywordTestResult()!.matches">
                                                        @if(keywordTestResult()!.matches) {
                                                            âœ“ {{ t('keywordMatches') }}
                                                        } @else {
                                                            âœ— {{ t('keywordNoMatch') }}
                                                            @if(keywordTestResult()!.error) {
                                                                <span class="block mt-1 text-xs opacity-75">{{ keywordTestResult()!.error }}</span>
                                                            }
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </form>
                                    
                                    <!-- é—œéµè©åˆ—è¡¨ -->
                                    <div class="space-y-1 mt-3 max-h-32 overflow-y-auto">
                                        @if(set.keywords.length > 0) {
                                            @for(key of set.keywords; track key.id) {
                                                <div class="bg-slate-200 dark:bg-slate-800/50 p-1.5 rounded-md flex justify-between items-center text-sm border border-slate-300 dark:border-slate-600">
                                                    <div class="flex items-center gap-2 flex-1 min-w-0">
                                                        <p class="font-mono text-xs truncate" [title]="key.keyword">{{ key.keyword }}</p>
                                                        @if(key.isRegex) {
                                                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full flex-shrink-0" title="æ­£å‰‡è¡¨é”å¼">Regex</span>
                                                        }
                                                    </div>
                                                    <button 
                                                        (click)="removeKeywordFromSet(set.id, key.id)" 
                                                        class="text-red-400 hover:text-red-300 hover:bg-red-500/10 font-bold px-1 rounded transition-colors flex-shrink-0" 
                                                        title="åˆªé™¤é—œéµè©">Ã—</button>
                                                </div>
                                            }
                                        } @else {
                                            <p class="text-xs text-slate-500 dark:text-slate-400 text-center py-2">å°šæœªæ·»åŠ é—œéµè©</p>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                        <div id="monitored-groups-section" class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg transition-all duration-300">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-semibold">{{ t('monitoredGroups') }}</h4>
                                <!-- ç¾¤çµ„é…é¡é¡¯ç¤º -->
                                <span class="text-xs px-2 py-1 rounded-full"
                                      [class]="membershipService.quotas().maxGroups === -1 ? 'bg-emerald-500/20 text-emerald-400' : 
                                               (monitoredGroups().length >= membershipService.quotas().maxGroups ? 'bg-red-500/20 text-red-400' : 'bg-slate-500/20 text-slate-400')">
                                    {{ monitoredGroups().length }}/{{ membershipService.quotas().maxGroups === -1 ? 'âˆ' : membershipService.quotas().maxGroups }}
                                </span>
                            </div>
                             <form (submit)="addGroup()" class="space-y-3">
                                <div><input [(ngModel)]="newGroup().url" name="groupUrl" class="form-input w-full bg-slate-100 dark:bg-slate-700/50 border-slate-300 dark:border-slate-600 rounded-lg p-2" [placeholder]="t('groupUrl')"></div>
                                <div>
                                    <div class="max-h-32 overflow-y-auto bg-slate-100 dark:bg-slate-700/50 border border-slate-300 dark:border-slate-600 rounded-lg p-2 space-y-1">
                                        @for(set of keywordSets(); track set.id) {
                                            <label class="flex items-center gap-2 p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-600/50"><input type="checkbox" [checked]="newGroup().keywordSetIds.includes(set.id)" (change)="toggleKeywordSetForNewGroup(set.id)" class="form-checkbox rounded text-cyan-500"> {{set.name}}</label>
                                        }
                                    </div>
                                </div>
                                <button type="submit" 
                                        [disabled]="membershipService.quotas().maxGroups !== -1 && monitoredGroups().length >= membershipService.quotas().maxGroups"
                                        [class.opacity-50]="membershipService.quotas().maxGroups !== -1 && monitoredGroups().length >= membershipService.quotas().maxGroups"
                                        [class.cursor-not-allowed]="membershipService.quotas().maxGroups !== -1 && monitoredGroups().length >= membershipService.quotas().maxGroups"
                                        class="w-full bg-cyan-500 hover:bg-cyan-600 disabled:hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20 text-sm">{{ t('add') }} {{t('group')}}</button>
                            </form>
                             <div class="space-y-2 mt-4 max-h-48 overflow-y-auto">
                                @for(group of monitoredGroups(); track group.id){
                                    <div class="bg-slate-50 dark:bg-slate-700/50 p-2 rounded-lg border border-slate-200 dark:border-slate-600">
                                        <div class="flex justify-between items-center">
                                            <div class="flex-1 min-w-0">
                                                <p class="font-mono font-semibold text-sm truncate" [title]="group.url">{{ group.name || group.url }}</p>
                                                <p class="text-xs text-slate-500 dark:text-slate-400 truncate mt-0.5" [title]="group.url">{{ group.url }}</p>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <button (click)="joinGroup(group.url)" 
                                                    class="text-xs bg-green-500/20 hover:bg-green-500/30 text-green-400 px-2 py-1 rounded transition-colors" 
                                                    title="è®“ç›£æ§è™ŸåŠ å…¥æ­¤ç¾¤çµ„">
                                                    åŠ å…¥
                                                </button>
                                                <button (click)="removeById(monitoredGroups, group.id, 'group')" class="text-red-400 hover:text-red-300 hover:bg-red-500/10 text-lg font-bold px-1 rounded transition-colors" title="åˆªé™¤ç¾¤çµ„">Ã—</button>
                                            </div>
                                        </div>
                                        <div class="flex flex-wrap gap-1 mt-2">
                                            @if(group.keywordSetIds?.length > 0) {
                                                @for(id of group.keywordSetIds; track id) { 
                                                    <span class="text-xs bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded-full">{{ getKeywordSetName(id) }}</span> 
                                                }
                                            } @else {
                                                <span class="text-xs text-slate-400 italic">æœªåˆ†é…é—œéµè©é›†</span>
                                            }
                                        </div>
                                    </div>
                                } @empty {
                                    <p class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">å°šæœªæ·»åŠ ç›£æ§ç¾¤çµ„</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 2: Automation Campaigns -->
             <div class="space-y-8">
                <div id="campaign-rules-section" class="bg-slate-100/50 dark:bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl shadow-lg transition-all duration-300">
                    <h3 class="text-xl mb-4 font-semibold">{{t('automationRules')}}</h3>
                    <form (submit)="addCampaign()" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-1">{{t('campaignName')}}</label>
                            <input [(ngModel)]="newCampaign().name" name="campaignName" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2">
                        </div>
                        <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
                            <h4 class="font-semibold mb-2">{{t('triggers')}}</h4>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">{{t('campaignTriggerHint')}}</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{t('sourceGroups')}}</label>
                                    <div class="max-h-32 overflow-y-auto bg-slate-200/50 dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 rounded-lg p-2 space-y-1">
                                        @for(group of monitoredGroups(); track group.id) {
                                            <label class="flex items-center gap-2 p-1 rounded hover:bg-slate-300 dark:hover:bg-slate-700/50"><input type="checkbox" [checked]="newCampaign().trigger.sourceGroupIds.includes(group.id)" (change)="toggleNewCampaignSourceGroup(group.id)" class="form-checkbox rounded text-cyan-500"> {{group.name}}</label>
                                        }
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{t('keywordSets')}}</label>
                                    <div class="max-h-32 overflow-y-auto bg-slate-200/50 dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 rounded-lg p-2 space-y-1">
                                        @for(set of keywordSets(); track set.id) {
                                            <label class="flex items-center gap-2 p-1 rounded hover:bg-slate-300 dark:hover:bg-slate-700/50"><input type="checkbox" [checked]="newCampaign().trigger.keywordSetIds.includes(set.id)" (change)="toggleNewCampaignKeywordSet(set.id)" class="form-checkbox rounded text-cyan-500"> {{set.name}}</label>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
                             <h4 class="font-semibold mb-2">{{t('actions')}}</h4>
                             <div class="space-y-3">
                                <div>
                                    <div class="flex items-center justify-between mb-1">
                                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">{{t('messageTemplate')}}</label>
                                        <button type="button" (click)="showTemplateCreator.set(!showTemplateCreator())" class="text-xs bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-300 px-2 py-1 rounded transition-colors flex items-center gap-1">
                                            <span>{{ showTemplateCreator() ? 'âˆ’' : '+' }}</span>
                                            <span>{{ showTemplateCreator() ? 'æ”¶èµ·' : 'å‰µå»ºæ–°æ¨¡æ¿' }}</span>
                                        </button>
                                    </div>
                                    <select [(ngModel)]="newCampaign().action.templateId" name="actionTemplate" class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2">
                                        <option value="0" disabled>{{t('selectTemplate')}}</option>
                                        @for(template of messageTemplates(); track template.id) {
                                            <option [value]="template.id">{{template.name}}</option>
                                        }
                                    </select>
                                    @if(messageTemplates().length > 0) {
                                        <div class="mt-2 p-2 bg-slate-200/30 dark:bg-slate-800/30 rounded-lg border border-slate-300 dark:border-slate-700">
                                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-2 font-semibold">ğŸ“‹ æ¨¡æ¿åˆ—è¡¨ ({{messageTemplates().length}})ï¼š</p>
                                            <div class="space-y-1 max-h-32 overflow-y-auto">
                                                @for(template of messageTemplates(); track template.id) {
                                                    <div class="flex items-center justify-between p-1.5 bg-slate-100 dark:bg-slate-700/50 rounded text-sm border border-slate-200 dark:border-slate-600">
                                                        <div class="flex-1 min-w-0">
                                                            <div class="flex items-center gap-2">
                                                                <p class="font-medium text-slate-700 dark:text-slate-300 truncate">{{template.name}}</p>
                                                                @if(!template.isActive) {
                                                                    <span class="text-xs bg-slate-500/20 text-slate-400 px-1.5 py-0.5 rounded">å·²åœç”¨</span>
                                                                }
                                                            </div>
                                                            <p class="text-xs text-slate-500 dark:text-slate-400 truncate mt-0.5" [title]="template.prompt">{{template.prompt.substring(0, 50)}}{{template.prompt.length > 50 ? '...' : ''}}</p>
                                                        </div>
                                                        <button 
                                                            type="button" 
                                                            (click)="removeTemplate(template.id)" 
                                                            class="ml-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 px-2 py-1 rounded transition-colors flex-shrink-0"
                                                            title="åˆªé™¤æ¨¡æ¿">
                                                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                    @if(messageTemplates().length === 0 && !showTemplateCreator()) {
                                        <p class="text-xs text-amber-400 mt-1">âš ï¸ è¯·å…ˆåˆ›å»ºæ¶ˆæ¯æ¨¡æ¿</p>
                                    }
                                    @if(showTemplateCreator() || messageTemplates().length === 0) {
                                        <div class="mt-2 p-3 bg-slate-700/50 rounded-lg space-y-2">
                                            <input #quickTemplateName [value]="newTemplate().name" (input)="updateTemplateName(quickTemplateName.value)" class="form-input w-full bg-slate-800/50 border-slate-600 rounded-lg p-2 text-sm" placeholder="æ¨¡æ¿åç§° (å¦‚: æ‰“æ‹›å‘¼)">
                                            <div class="relative">
                                                <textarea #quickTemplatePrompt [value]="newTemplate().prompt" (input)="updateTemplatePrompt(quickTemplatePrompt.value)" rows="3" class="form-textarea w-full bg-slate-800/50 border-slate-600 rounded-lg p-2 text-sm" placeholder="æ¶ˆæ¯å†…å®¹..."></textarea>
                                            </div>
                                            <div class="space-y-2">
                                                <p class="text-xs text-slate-400">ğŸ“ ç‚¹å‡»æ’å…¥å˜é‡:</p>
                                                <div class="flex flex-wrap gap-1">
                                                    <!-- ç”¨æˆ·ä¿¡æ¯ -->
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{username}')" class="px-2 py-1 bg-cyan-600/30 hover:bg-cyan-600/50 text-cyan-300 rounded text-xs" title="æ’å…¥: {username}">ğŸ‘¤ ç”¨æˆ·å</button>
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{firstName}')" class="px-2 py-1 bg-cyan-600/30 hover:bg-cyan-600/50 text-cyan-300 rounded text-xs" title="æ’å…¥: {firstName}">ğŸ“› åå­—</button>
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{name}')" class="px-2 py-1 bg-cyan-600/30 hover:bg-cyan-600/50 text-cyan-300 rounded text-xs" title="æ’å…¥: {name}">ğŸ·ï¸ æ˜µç§°</button>
                                                    <!-- è§¦å‘ä¿¡æ¯ -->
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{keyword}')" class="px-2 py-1 bg-amber-600/30 hover:bg-amber-600/50 text-amber-300 rounded text-xs" title="æ’å…¥: {keyword}">ğŸ”‘ è§¦å‘å…³é”®è¯</button>
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{message}')" class="px-2 py-1 bg-amber-600/30 hover:bg-amber-600/50 text-amber-300 rounded text-xs" title="æ’å…¥: {message}">ğŸ’¬ ç”¨æˆ·æ¶ˆæ¯</button>
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{groupName}')" class="px-2 py-1 bg-green-600/30 hover:bg-green-600/50 text-green-300 rounded text-xs" title="æ’å…¥: {groupName}">ğŸ‘¥ ç¾¤ç»„åç§°</button>
                                                    <!-- æ—¶é—´å’Œéšæœº -->
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{time}')" class="px-2 py-1 bg-purple-600/30 hover:bg-purple-600/50 text-purple-300 rounded text-xs" title="æ’å…¥: {time}">ğŸ• å½“å‰æ—¶é—´</button>
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{date}')" class="px-2 py-1 bg-purple-600/30 hover:bg-purple-600/50 text-purple-300 rounded text-xs" title="æ’å…¥: {date}">ğŸ“… å½“å‰æ—¥æœŸ</button>
                                                    <button type="button" (click)="insertTemplateVariable(quickTemplatePrompt, '{random}')" class="px-2 py-1 bg-pink-600/30 hover:bg-pink-600/50 text-pink-300 rounded text-xs" title="æ’å…¥: {random}">ğŸ² éšæœºè¡¨æƒ…</button>
                                                </div>
                                                <p class="text-xs text-slate-500 mt-1">ğŸ’¡ å˜é‡ä¼šè‡ªåŠ¨æ›¿æ¢ä¸ºå®é™…å€¼ | é¼ æ ‡æ‚¬åœæŸ¥çœ‹å˜é‡ä»£ç </p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button type="button" (click)="addTemplateQuick(quickTemplateName.value, quickTemplatePrompt.value); showTemplateCreator.set(false)" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-1.5 px-3 rounded-lg text-sm">âœ“ æ·»åŠ æ¨¡æ¿</button>
                                                @if(messageTemplates().length > 0) {
                                                    <button type="button" (click)="showTemplateCreator.set(false)" class="px-3 bg-slate-600 hover:bg-slate-700 text-white font-bold py-1.5 rounded-lg text-sm">å–æ¶ˆ</button>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div>
                                     <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{t('sendingDelays')}}</label>
                                     <div class="flex items-center gap-4">
                                         <div class="flex-1"><label class="block text-xs font-medium">{{t('min')}}</label><input type="number" [(ngModel)]="newCampaign().action.minDelaySeconds" name="minDelay" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2"></div>
                                         <div class="flex-1"><label class="block text-xs font-medium">{{t('max')}}</label><input type="number" [(ngModel)]="newCampaign().action.maxDelaySeconds" name="maxDelay" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2"></div>
                                     </div>
                                </div>
                             </div>
                        </div>
                        <button type="submit" [disabled]="isSubmittingCampaign()" [class.opacity-50]="isSubmittingCampaign()" [class.cursor-not-allowed]="isSubmittingCampaign()" class="w-full bg-cyan-500 hover:bg-cyan-600 disabled:bg-cyan-400 text-white font-bold py-2.5 px-4 rounded-lg transition duration-200 shadow-lg shadow-cyan-500/20">{{isSubmittingCampaign() ? 'å‰µå»ºä¸­...' : t('createCampaign')}}</button>
                    </form>
                </div>
                 <div id="campaign-list-section" class="bg-slate-100/50 dark:bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl shadow-lg transition-all duration-300">
                    <h3 class="text-xl mb-4 font-semibold">{{t('campaigns')}}</h3>
                    <div class="space-y-4 max-h-96 overflow-y-auto">
                        @for(campaign of campaigns(); track campaign.id) {
                            <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-xl">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold">{{ campaign.name }}</span>
                                    <div class="flex items-center gap-3">
                                        <label class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" [checked]="campaign.isActive" (change)="toggleCampaignStatus(campaign.id)" class="sr-only"><div class="block bg-slate-600 w-10 h-6 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition" [class.translate-x-full]="campaign.isActive" [class.bg-cyan-400]="campaign.isActive"></div></div></label>
                                        <button (click)="removeById(campaigns, campaign.id, 'campaign')" class="text-red-400 hover:text-red-300 font-medium transition-colors" [title]="t('remove')"><svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                                    </div>
                                </div>
                                <div class="mt-3 text-xs space-y-2"><p><strong class="text-slate-500 dark:text-slate-400">{{t('triggers')}}:</strong> {{ campaign.trigger?.sourceGroupIds?.length || 0 }} {{t('groups')}}, {{ campaign.trigger?.keywordSetIds?.length || 0 }} {{t('keywordSets')}}</p><p><strong class="text-slate-500 dark:text-slate-400">{{t('actions')}}:</strong> {{t('sendMessage')}} ({{ campaign.actions?.[0]?.minDelaySeconds || 0 }}s-{{ campaign.actions?.[0]?.maxDelaySeconds || 0 }}s)</p></div>
                            </div>
                        } @empty {
                            <p class="text-slate-500 text-center py-8">{{t('noCampaignsFound')}}</p>
                        }
                    </div>
                </div>
            </div>

            <!-- Column 3: Global Config & Status -->
            <div class="space-y-8">
                <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl mb-4 font-semibold">{{ t('globalSendingConfig') }}</h3>
                    <div class="space-y-4">
                        <div><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" [ngModel]="spintaxEnabled()" (ngModelChange)="spintaxEnabled.set($event)" class="form-checkbox bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded text-cyan-500 h-5 w-5"><span class="text-slate-700 dark:text-slate-300">{{ t('enableSpintax') }}</span></label><p class="text-xs text-slate-500 mt-1 pl-8">{{ t('spintaxHint') }}</p></div>
                        <div class="pt-4 border-t border-slate-200 dark:border-slate-700"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" [ngModel]="smartSendingEnabled()" (ngModelChange)="smartSendingEnabled.set($event)" class="form-checkbox bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded text-cyan-500 h-5 w-5"><span class="text-slate-700 dark:text-slate-300">{{ t('enableSmartSending') }}</span></label><p class="text-xs text-slate-500 dark:text-slate-400 mt-1 pl-8">{{ t('smartSendingHint') }}</p></div>
                        <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" [ngModel]="autoReplyEnabled()" (ngModelChange)="autoReplyEnabled.set($event); saveSettings()" class="form-checkbox bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded text-cyan-500 h-5 w-5">
                                <span class="text-slate-700 dark:text-slate-300">{{ t('enableAutoReply') }}</span>
                            </label>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 pl-8">{{ t('autoReplyHint') }}</p>
                            <div class="mt-2 space-y-2">
                                <textarea 
                                    [ngModel]="autoReplyMessage()" 
                                    (ngModelChange)="autoReplyMessage.set($event)"
                                    rows="3" 
                                    class="form-textarea w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-3 text-sm resize-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 transition-all" 
                                    [placeholder]="t('autoReplyMessage')">
                                </textarea>
                                <div class="flex items-center justify-between">
                                    <p class="text-xs text-slate-500">{{ t('autoReplyEditHint') }}</p>
                                    <button 
                                        (click)="saveSettings(); showSettingsSavedToast()"
                                        class="bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-medium py-1.5 px-4 rounded-lg transition-all duration-200 shadow-md shadow-cyan-500/20 hover:shadow-lg hover:shadow-cyan-500/30 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        {{ t('saveAutoReply') }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl mb-4 font-semibold">{{ t('accountStatus') }}</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-2">{{ t('activeListenerAccounts') }} ({{listenerAccounts().length}})</h4>
                            <div class="space-y-2 max-h-32 overflow-y-auto">@for(acc of listenerAccounts(); track acc.id) { <div class="flex items-center justify-between p-2 bg-slate-200/50 dark:bg-slate-800/50 rounded-lg text-sm"><span class="font-mono">{{acc.phone}}</span><span class="px-2 py-0.5 text-xs font-semibold rounded-full" [class]="getStatusColor(acc.status)">{{ acc.status }}</span></div> } @empty {<p class="text-slate-500 text-sm">{{t('noActiveListeners')}}</p>}</div>
                        </div>
                         <div>
                            <h4 class="font-semibold mb-2">{{ t('activeSenderAccounts') }} ({{senderAccounts().length}})</h4>
                            <div class="space-y-2 max-h-32 overflow-y-auto">@for(acc of senderAccounts(); track acc.id) { <div class="flex items-center justify-between p-2 bg-slate-200/50 dark:bg-slate-800/50 rounded-lg text-sm"><span class="font-mono">{{acc.phone}}</span><span class="px-2 py-0.5 text-xs font-semibold rounded-full" [class]="getStatusColor(acc.status)">{{ acc.status }}</span></div> } @empty {<p class="text-slate-500 text-sm">{{t('noActiveSenders')}}</p>}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      }
      @case ('leads') {
        <!-- æœç´¢æ¡† -->
        <div class="mb-4">
            <div class="relative">
                <input type="text" 
                       [(ngModel)]="leadSearchQuery"
                       (input)="onLeadSearchInput()"
                       (keyup.enter)="searchLeads()"
                       placeholder="æœç´¢æ½œåœ¨å®¢æˆ·ï¼ˆç”¨æˆ·åã€å§“åã€ç¾¤ç»„ã€å…³é”®è¯ï¼‰..." 
                       class="w-full bg-slate-100/50 dark:bg-slate-800/50 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 pl-10 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                @if(leadSearchQuery()) {
                    <button (click)="clearLeadSearch()" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                    </button>
                }
            </div>
            @if(isSearchingLeads()) {
                <div class="mt-2 text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2">
                    <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
                    </svg>
                    æœç´¢ä¸­...
                </div>
            }
            @if(leadSearchResults().length > 0 && leadSearchQuery()) {
                <div class="mt-2 text-sm text-cyan-400">
                    æ‰¾åˆ° {{ leadSearchResults().length }} ä¸ªç»“æœ
                </div>
            }
        </div>
        
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-4xl font-bold text-slate-900 dark:text-white">{{ t('leadPipeline') }}</h2>
            <div class="flex items-center gap-4">
                <button (click)="loadFunnelStats(); loadFunnelOverview()" class="flex items-center gap-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                    åˆ·æ–°çµ±è¨ˆ
                </button>
                <!-- Leads å­é ç±¤ -->
                <div class="flex rounded-md shadow-sm bg-slate-200/50 dark:bg-slate-800/50 p-1">
                    <button (click)="leadsTab.set('kanban')" 
                            [class.bg-white]="leadsTab() === 'kanban'" 
                            [class.dark:bg-slate-700]="leadsTab() === 'kanban'" 
                            class="px-3 py-1.5 text-sm rounded transition-colors flex items-center gap-2">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg> 
                        çœ‹æ¿
                    </button>
                    <button (click)="leadsTab.set('funnel'); loadFunnelOverview()" 
                            [class.bg-white]="leadsTab() === 'funnel'" 
                            [class.dark:bg-slate-700]="leadsTab() === 'funnel'" 
                            class="px-3 py-1.5 text-sm rounded transition-colors flex items-center gap-2">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"/></svg> 
                        æ¼æ–—
                    </button>
                    <button (click)="leadsTab.set('journey')" 
                            [class.bg-white]="leadsTab() === 'journey'" 
                            [class.dark:bg-slate-700]="leadsTab() === 'journey'" 
                            class="px-3 py-1.5 text-sm rounded transition-colors flex items-center gap-2">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> 
                        æ—…ç¨‹
                    </button>
                </div>
                <div class="flex rounded-md shadow-sm bg-slate-200/50 dark:bg-slate-800/50 p-1">
                    <button (click)="leadsViewMode.set('kanban')" [class.bg-white]="leadsViewMode() === 'kanban'" [class.dark:bg-slate-700]="leadsViewMode() === 'kanban'" class="px-3 py-1.5 text-sm rounded transition-colors flex items-center gap-2"><svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg> {{t('kanbanView')}}</button>
                    <button (click)="leadsViewMode.set('list')" [class.bg-white]="leadsViewMode() === 'list'" [class.dark:bg-slate-700]="leadsViewMode() === 'list'" class="px-3 py-1.5 text-sm rounded transition-colors flex items-center gap-2"><svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg> {{t('listView')}}</button>
                </div>
                <button (click)="exportLeads()" 
                        [disabled]="!membershipService.hasFeature('dataExport')"
                        [class.opacity-50]="!membershipService.hasFeature('dataExport')"
                        [class.cursor-not-allowed]="!membershipService.hasFeature('dataExport')"
                        [title]="!membershipService.hasFeature('dataExport') ? 'éœ€è¦ é»ƒé‡‘å¤§å¸« æˆ–ä»¥ä¸Šæœƒå“¡' : ''"
                        class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 disabled:hover:bg-slate-200 dark:disabled:hover:bg-slate-800/50 text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    {{t('exportToExcel')}}
                    @if (!membershipService.hasFeature('dataExport')) {
                      <span class="text-xs opacity-60">ğŸ¥‡</span>
                    }
                </button>
                <!-- æ‰¹é‡æ“ä½œæŒ‰éˆ• -->
                <button (click)="showBatchOperationMenu.set(!showBatchOperationMenu()); loadAllTags()" 
                        [disabled]="!membershipService.hasFeature('batchOperations')"
                        [class.opacity-50]="!membershipService.hasFeature('batchOperations')"
                        [class.cursor-not-allowed]="!membershipService.hasFeature('batchOperations')"
                        [title]="!membershipService.hasFeature('batchOperations') ? 'éœ€è¦ é»ƒé‡‘å¤§å¸« æˆ–ä»¥ä¸Šæœƒå“¡' : ''"
                        class="flex items-center gap-2 bg-purple-500/20 hover:bg-purple-500/30 disabled:hover:bg-purple-500/20 text-purple-400 text-sm font-bold py-2 px-4 rounded-lg transition duration-200"
                        [class.ring-2]="hasSelectedLeads() && membershipService.hasFeature('batchOperations')"
                        [class.ring-purple-500]="hasSelectedLeads() && membershipService.hasFeature('batchOperations')">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    æ‰¹é‡æ“ä½œ
                    @if(hasSelectedLeads() && membershipService.hasFeature('batchOperations')) {
                        <span class="bg-purple-500 text-white text-xs px-1.5 py-0.5 rounded-full">{{ selectedLeadsCount() }}</span>
                    }
                    @if (!membershipService.hasFeature('batchOperations')) {
                      <span class="text-xs opacity-60">ğŸ¥‡</span>
                    }
                </button>
                <!-- æ“ä½œæ­·å²æŒ‰éˆ• -->
                <button (click)="loadBatchOperationHistory()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>
                    æ­·å²
                </button>
            </div>
        </div>
        
        <!-- æ‰¹é‡æ“ä½œå·¥å…·æ¬„ -->
        @if((hasSelectedLeads() || showBatchOperationMenu()) && membershipService.hasFeature('batchOperations')) {
        <div class="mb-4 bg-purple-500/10 border border-purple-500/20 rounded-xl p-4">
            <div class="flex flex-wrap items-center gap-3">
                <!-- é¸æ“‡ä¿¡æ¯ -->
                <div class="flex items-center gap-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" [checked]="isSelectAllLeads()" (change)="toggleSelectAllLeads()" 
                               class="w-4 h-4 rounded border-purple-400 text-purple-500 focus:ring-purple-500">
                        <span class="text-sm text-purple-400">å…¨é¸</span>
                    </label>
                    <span class="text-sm text-slate-400">å·²é¸æ“‡ <span class="font-bold text-purple-400">{{ selectedLeadsCount() }}</span> å€‹ Lead</span>
                    @if(hasSelectedLeads()) {
                        <button (click)="clearLeadSelection()" class="text-xs text-slate-400 hover:text-slate-300 underline">æ¸…é™¤é¸æ“‡</button>
                    }
                </div>
                
                <div class="h-6 w-px bg-slate-600"></div>
                
                <!-- æ‰¹é‡æ“ä½œæŒ‰éˆ• -->
                @if(hasSelectedLeads()) {
                    <!-- æ›´æ–°ç‹€æ…‹ä¸‹æ‹‰é¸å–® -->
                    <div class="relative">
                        <select (change)="batchUpdateLeadStatus($any($event.target).value); $any($event.target).value = ''" 
                                class="bg-cyan-500/20 border border-cyan-500/30 text-cyan-400 text-sm rounded-lg px-3 py-1.5 appearance-none cursor-pointer hover:bg-cyan-500/30">
                            <option value="" disabled selected>æ›´æ–°ç‹€æ…‹</option>
                            <option value="New">New</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Replied">Replied</option>
                            <option value="Follow-up">Follow-up</option>
                            <option value="Closed-Won">Closed-Won</option>
                            <option value="Closed-Lost">Closed-Lost</option>
                        </select>
                    </div>
                    
                    <!-- æ·»åŠ æ¨™ç±¤ -->
                    <div class="relative">
                        <button (click)="showBatchTagSelector.set(!showBatchTagSelector())" 
                                class="flex items-center gap-1 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 text-sm px-3 py-1.5 rounded-lg">
                            <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                            æ·»åŠ æ¨™ç±¤
                        </button>
                        @if(showBatchTagSelector()) {
                            <div class="absolute top-full mt-1 left-0 z-50 bg-slate-800 border border-slate-600 rounded-lg shadow-xl p-3 min-w-[200px]">
                                <input [(ngModel)]="batchTagInput" 
                                       (keyup.enter)="batchAddTag(batchTagInput()); batchTagInput.set('')"
                                       placeholder="è¼¸å…¥æ–°æ¨™ç±¤..." 
                                       class="w-full bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm mb-2">
                                <button (click)="batchAddTag(batchTagInput()); batchTagInput.set('')" 
                                        class="w-full bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 rounded mb-2">æ·»åŠ </button>
                                @if(allTags().length > 0) {
                                    <div class="border-t border-slate-600 pt-2 max-h-32 overflow-y-auto">
                                        <p class="text-xs text-slate-400 mb-1">ç¾æœ‰æ¨™ç±¤:</p>
                                        @for(tag of allTags(); track tag.id) {
                                            <button (click)="batchAddTag(tag.name)" 
                                                    class="block w-full text-left text-sm px-2 py-1 rounded hover:bg-slate-700" 
                                                    [style.color]="tag.color">
                                                {{ tag.name }} ({{ tag.usageCount }})
                                            </button>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    
                    <!-- ç§»é™¤æ¨™ç±¤ -->
                    <div class="relative">
                        <button (click)="showBatchRemoveTagSelector.set(!showBatchRemoveTagSelector())" 
                                class="flex items-center gap-1 bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 text-sm px-3 py-1.5 rounded-lg">
                            <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                            ç§»é™¤æ¨™ç±¤
                        </button>
                        @if(showBatchRemoveTagSelector()) {
                            <div class="absolute top-full mt-1 left-0 z-50 bg-slate-800 border border-slate-600 rounded-lg shadow-xl p-3 min-w-[200px]">
                                @if(allTags().length > 0) {
                                    <div class="max-h-32 overflow-y-auto">
                                        <p class="text-xs text-slate-400 mb-1">é¸æ“‡è¦ç§»é™¤çš„æ¨™ç±¤:</p>
                                        @for(tag of allTags(); track tag.id) {
                                            <button (click)="batchRemoveTag(tag.name); showBatchRemoveTagSelector.set(false)" 
                                                    class="block w-full text-left text-sm px-2 py-1 rounded hover:bg-slate-700" 
                                                    [style.color]="tag.color">
                                                {{ tag.name }}
                                            </button>
                                        }
                                    </div>
                                } @else {
                                    <p class="text-xs text-slate-400">æš«ç„¡æ¨™ç±¤</p>
                                }
                            </div>
                        }
                    </div>
                    
                    <!-- æ›´æ–°æ¼æ–—éšæ®µ -->
                    <div class="relative">
                        <select (change)="batchUpdateFunnelStage($any($event.target).value); $any($event.target).value = ''" 
                                class="bg-purple-500/20 border border-purple-500/30 text-purple-400 text-sm rounded-lg px-3 py-1.5 appearance-none cursor-pointer hover:bg-purple-500/30">
                            <option value="" disabled selected>æ›´æ–°æ¼æ–—éšæ®µ</option>
                            @for(stage of funnelStages; track stage.key) {
                                <option [value]="stage.key">{{ stage.name }}</option>
                            }
                        </select>
                    </div>
                    
                    <!-- æ·»åŠ åˆ° DNC -->
                    <button (click)="batchAddToDnc()" 
                            class="flex items-center gap-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 text-sm px-3 py-1.5 rounded-lg">
                        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                        åŠ å…¥ DNC
                    </button>
                    
                    <!-- å¾ DNC ç§»é™¤ -->
                    <button (click)="batchRemoveFromDnc()" 
                            class="flex items-center gap-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 text-sm px-3 py-1.5 rounded-lg">
                        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        ç§»å‡º DNC
                    </button>
                    
                    <!-- åˆªé™¤ -->
                    <button (click)="batchDeleteLeads()" 
                            class="flex items-center gap-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 text-sm px-3 py-1.5 rounded-lg">
                        <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        åˆªé™¤
                    </button>
                }
                
                <!-- åŠ è¼‰ä¸­æŒ‡ç¤ºå™¨ -->
                @if(batchOperationInProgress()) {
                    <div class="flex items-center gap-2 text-purple-400">
                        <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg>
                        <span class="text-sm">è™•ç†ä¸­...</span>
                    </div>
                }
            </div>
        </div>
        }
        
        <!-- æ¼æ–—çµ±è¨ˆå„€è¡¨æ¿ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- ä»Šæ—¥æ–°å¢ -->
            <div class="bg-blue-500/10 border border-blue-500/20 p-4 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-blue-500/20">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400">ä»Šæ—¥æ–°å¢</p>
                        <p class="text-2xl font-bold text-blue-400">{{ funnelStats().today_new }}</p>
                    </div>
                </div>
            </div>
            <!-- æœ¬é€±æˆäº¤ -->
            <div class="bg-emerald-500/10 border border-emerald-500/20 p-4 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-emerald-500/20">
                        <svg class="h-5 w-5 text-emerald-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400">æœ¬é€±æˆäº¤</p>
                        <p class="text-2xl font-bold text-emerald-400">{{ funnelStats().week_converted }}</p>
                    </div>
                </div>
            </div>
            <!-- æœ‰èˆˆè¶£ -->
            <div class="bg-yellow-500/10 border border-yellow-500/20 p-4 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-yellow-500/20">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400">æœ‰èˆˆè¶£</p>
                        <p class="text-2xl font-bold text-yellow-400">{{ funnelStats().stages['interested']?.count || 0 }}</p>
                    </div>
                </div>
            </div>
            <!-- æ´½è«‡ä¸­ -->
            <div class="bg-orange-500/10 border border-orange-500/20 p-4 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-orange-500/20">
                        <svg class="h-5 w-5 text-orange-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400">æ´½è«‡ä¸­</p>
                        <p class="text-2xl font-bold text-orange-400">{{ funnelStats().stages['negotiating']?.count || 0 }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ¼æ–—éšæ®µåˆ†ä½ˆ -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-4 rounded-xl mb-6">
            <h3 class="text-lg font-semibold mb-3">æ¼æ–—éšæ®µåˆ†ä½ˆ</h3>
            <div class="flex gap-2 flex-wrap">
                @for(stage of funnelStages; track stage.key) {
                    <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-200/50 dark:bg-slate-800/50">
                        <div class="w-3 h-3 rounded-full {{ stage.color }}"></div>
                        <span class="text-sm">{{ stage.name }}</span>
                        <span class="text-sm font-bold">{{ funnelStats().stages[stage.key]?.count || 0 }}</span>
                    </div>
                }
            </div>
            
            <!-- ç†±é–€æ¨™ç±¤ -->
            @if(funnelStats().tags.length > 0) {
                <div class="mt-4 pt-4 border-t border-slate-500/20">
                    <h4 class="text-sm font-semibold mb-2 text-slate-500">ç†±é–€æ¨™ç±¤</h4>
                    <div class="flex gap-2 flex-wrap">
                        @for(tag of funnelStats().tags.slice(0, 10); track tag[0]) {
                            <span class="px-2 py-1 text-xs bg-cyan-500/20 text-cyan-400 rounded-full">
                                {{ tag[0] }} ({{ tag[1] }})
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
        
        @switch (leadsTab()) {
          @case ('funnel') {
            <!-- éŠ·å”®æ¼æ–—å¯è¦–åŒ– -->
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl mb-6">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                  ğŸ“Š è½‰åŒ–æ¼æ–—åˆ†æ
                </h3>
                <button (click)="loadFunnelOverview()" [disabled]="isLoadingFunnel()" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg">
                  {{ isLoadingFunnel() ? 'â³ åŠ è¼‰ä¸­...' : 'ğŸ”„ åˆ·æ–°' }}
                </button>
              </div>
              
              <!-- ç¸½é«”æŒ‡æ¨™ -->
              <div class="grid grid-cols-4 gap-4 mb-8">
                <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-300 dark:border-slate-700">
                  <div class="text-sm text-slate-500">ç¸½ç·šç´¢</div>
                  <div class="text-2xl font-bold text-white mt-1">{{ funnelOverview().totalLeads }}</div>
                </div>
                <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-300 dark:border-slate-700">
                  <div class="text-sm text-slate-500">å·²è½‰åŒ–</div>
                  <div class="text-2xl font-bold text-green-400 mt-1">{{ funnelOverview().convertedLeads }}</div>
                </div>
                <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-300 dark:border-slate-700">
                  <div class="text-sm text-slate-500">ç¸½è½‰åŒ–ç‡</div>
                  <div class="text-2xl font-bold text-cyan-400 mt-1">{{ (funnelOverview().conversionRate * 100).toFixed(1) }}%</div>
                </div>
                <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-300 dark:border-slate-700">
                  <div class="text-sm text-slate-500">å¹³å‡è½‰åŒ–å¤©æ•¸</div>
                  <div class="text-2xl font-bold text-purple-400 mt-1">{{ funnelOverview().averageConversionDays | number:'1.0-0' }} å¤©</div>
                </div>
              </div>
              
              <!-- æ¼æ–—åœ– -->
              <div class="funnel-chart mb-8">
                @for(stage of funnelStages; track stage.key; let i = $index) {
                  @let stageData = funnelStats().stages[stage.key];
                  @let stageCount = stageData?.count || 0;
                  @let maxCount = funnelStats().stages['new']?.count || 1;
                  @let widthPercent = (stageCount / maxCount) * 100;
                  <div class="funnel-stage mb-3">
                    <div class="flex items-center justify-between mb-1">
                      <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full {{ stage.color }}"></div>
                        <span class="text-white font-medium">{{ stage.name }}</span>
                      </div>
                      <div class="flex items-center gap-4">
                        <span class="text-slate-300">{{ stageCount }}</span>
                        @if(i > 0 && funnelStats().stages[funnelStages[i-1].key]?.count > 0) {
                          @let prevCount = funnelStats().stages[funnelStages[i-1].key]?.count || 1;
                          @let conversionRate = (stageCount / prevCount) * 100;
                          <span class="text-sm" 
                                [class.text-green-400]="conversionRate >= 50"
                                [class.text-yellow-400]="conversionRate >= 30 && conversionRate < 50"
                                [class.text-red-400]="conversionRate < 30">
                            {{ conversionRate | number:'1.1-1' }}%
                          </span>
                        }
                      </div>
                    </div>
                    <div class="relative h-10 bg-slate-700 rounded-lg overflow-hidden">
                      <div class="absolute inset-y-0 left-0 rounded-lg transition-all duration-500 {{ stage.color }}"
                           [style.width.%]="widthPercent">
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
          @case ('journey') {
            <!-- ç”¨æˆ¶æ—…ç¨‹è¿½è¹¤ -->
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl mb-6">
              <h3 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2 mb-6">
                ğŸš€ å®¢æˆ¶æ—…ç¨‹è¿½è¹¤
              </h3>
              
              <!-- æœç´¢ç”¨æˆ¶ -->
              <div class="flex gap-2 mb-6">
                <input type="text" [(ngModel)]="selectedJourneyUserId" 
                       placeholder="è¼¸å…¥ç”¨æˆ¶ ID æˆ–é¸æ“‡ç”¨æˆ¶..."
                       class="flex-1 bg-slate-200/50 dark:bg-slate-800/50 border border-slate-300 dark:border-slate-600 rounded-lg py-2 px-3 text-slate-900 dark:text-white">
                <button (click)="loadUserJourney(selectedJourneyUserId())" [disabled]="isLoadingJourney() || !selectedJourneyUserId()" 
                        class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg disabled:opacity-50">
                  {{ isLoadingJourney() ? 'â³ åŠ è¼‰ä¸­...' : 'ğŸ” æŸ¥çœ‹æ—…ç¨‹' }}
                </button>
              </div>
              
              <!-- æ—…ç¨‹è©³æƒ… -->
              @if(userJourneyData()) {
                <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-6 border border-slate-300 dark:border-slate-700">
                  <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                      <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                        {{ userJourneyData()!.userId.charAt(0) }}
                      </div>
                      <div>
                        <div class="font-medium text-slate-900 dark:text-white">ç”¨æˆ¶: {{ userJourneyData()!.userId }}</div>
                        <div class="text-sm text-slate-500">ç•¶å‰éšæ®µ: {{ userJourneyData()!.currentStage }}</div>
                      </div>
                    </div>
                    @if(userJourneyData()!.isConverted) {
                      <span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm">âœ“ å·²è½‰åŒ–</span>
                    }
                  </div>
                  
                  <!-- æ—…ç¨‹æ™‚é–“ç·š -->
                  <div class="mt-6">
                    <h4 class="text-sm font-semibold text-slate-500 mb-4">æ—…ç¨‹æ™‚é–“ç·š</h4>
                    <div class="relative">
                      <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-slate-600"></div>
                      @for(transition of userJourneyData()!.stages; track transition.timestamp; let i = $index; let last = $last) {
                        <div class="relative pl-10 pb-6">
                          <div class="absolute left-2 w-5 h-5 rounded-full flex items-center justify-center"
                               [class.bg-green-500]="last && userJourneyData()!.isConverted"
                               [class.bg-cyan-500]="last && !userJourneyData()!.isConverted"
                               [class.bg-slate-600]="!last">
                            @if(last) {
                              <span class="text-xs">{{ userJourneyData()!.isConverted ? 'âœ“' : 'â—‰' }}</span>
                            }
                          </div>
                          <div class="bg-slate-300/50 dark:bg-slate-700/50 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-1">
                              <span class="font-medium text-slate-900 dark:text-white">{{ transition.stage }}</span>
                              <span class="text-xs text-slate-500">{{ transition.timestamp | date:'yyyy-MM-dd HH:mm' }}</span>
                            </div>
                            @if(transition.reason) {
                              <p class="text-sm text-slate-500">{{ transition.reason }}</p>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                  
                  <!-- è½‰æ›éšæ®µæ“ä½œ -->
                  <div class="mt-6 pt-4 border-t border-slate-500/20">
                    <h4 class="text-sm font-semibold text-slate-500 mb-3">æ‰‹å‹•è½‰æ›éšæ®µ</h4>
                    <div class="flex flex-wrap gap-2">
                      @for(stage of funnelStages; track stage.key) {
                        @if(stage.key !== userJourneyData()!.currentStage) {
                          <button (click)="transitionFunnelStage(userJourneyData()!.userId, stage.key)"
                                  class="px-3 py-1.5 text-sm rounded-lg transition-colors {{ stage.color.replace('bg-', 'bg-').replace('-500', '-500/20') }} hover:opacity-80">
                            {{ stage.name }}
                          </button>
                        }
                      }
                    </div>
                  </div>
                </div>
              } @else {
                <div class="text-center py-12 text-slate-400">
                  <div class="text-4xl mb-3">ğŸ”</div>
                  <p>è¼¸å…¥ç”¨æˆ¶ ID æŸ¥çœ‹å…¶å®Œæ•´æ—…ç¨‹</p>
                </div>
              }
              
              <!-- æœ€è¿‘è½‰æ›çš„ç”¨æˆ¶ -->
              <div class="mt-6">
                <h4 class="text-sm font-semibold text-slate-500 mb-3">å¿«é€Ÿé¸æ“‡æœ€è¿‘çš„ Leads</h4>
                <div class="flex flex-wrap gap-2">
                  @for(lead of leads().slice(0, 10); track lead.id) {
                    <button (click)="loadUserJourney(lead.userId)"
                            class="px-3 py-1.5 text-sm bg-slate-200/50 dark:bg-slate-700/50 hover:bg-cyan-500/20 rounded-lg transition-colors">
                      @{{ lead.username || lead.userId }}
                    </button>
                  }
                </div>
              </div>
            </div>
          }
          @default {
            <!-- é»˜èªçœ‹æ¿/åˆ—è¡¨è¦–åœ– -->
        @if(leadsViewMode() === 'kanban') {
            <div class="flex gap-4 overflow-x-auto pb-4 -mx-8 px-8">
                @for(status of leadStatuses; track status) {
                    @let leads = leadsByStatus().get(status) ?? [];
                    <div class="w-80 bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 rounded-xl shadow-lg flex-shrink-0">
                        <h3 class="text-lg font-semibold p-4 border-b border-slate-500/20 flex justify-between"><span>{{ t(status) }}</span><span class="text-sm font-normal bg-slate-200/80 dark:bg-slate-800/80 text-slate-600 dark:text-slate-300 rounded-full px-2.5 py-0.5">{{ leads.length }}</span></h3>
                        <div class="p-2 space-y-2 h-[calc(100vh-300px)] overflow-y-auto">
                            @for(lead of leads; track lead.id) {
                                <div class="bg-slate-50 dark:bg-slate-800/70 p-3 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700/50 transition-shadow hover:shadow-md"
                                     (click)="closeLeadMenu()">
                                    <div (click)="openLeadDetailModal(lead)" class="cursor-pointer">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <p class="font-bold text-cyan-500 dark:text-cyan-400">@{{ lead.username }}</p>
                                                <p class="text-sm text-slate-600 dark:text-slate-300">{{lead.firstName}} {{lead.lastName}}</p>
                                                <p class="text-xs text-slate-400">ID: {{lead.userId}}</p>
                                            </div>
                                            <span class="h-2.5 w-2.5 rounded-full mt-1.5" [class]="getOnlineStatusColor(lead.onlineStatus)" [title]="t(lead.onlineStatus)"></span>
                                        </div>
                                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">{{ lead.sourceGroup }}</p>
                                        <p class="text-xs font-mono bg-slate-200/80 dark:bg-slate-700/50 rounded px-1.5 py-0.5 inline-block my-1.5">{{ lead.triggeredKeyword }}</p>
                                        @if (getCampaignById(lead.campaignId); as campaign) {
                                        <div class="relative group">
                                            <p class="text-xs text-slate-400">{{ t('campaign') }}: <span class="font-semibold text-slate-500 dark:text-slate-300">{{ getCampaignName(lead.campaignId) }}</span></p>
                                            <div class="absolute hidden group-hover:block bottom-full mb-2 w-72 bg-slate-900 text-white text-xs rounded-lg p-3 shadow-lg z-10">
                                                <h4 class="font-bold border-b border-slate-600 pb-1 mb-1">{{ t('campaignDetails') }}</h4>
                                                <p><strong>{{t('triggers')}}:</strong> {{ (campaign.trigger?.sourceGroupIds || []).map(getGroupName).join(', ') }}; {{ (campaign.trigger?.keywordSetIds || []).map(getKeywordSetName).join(', ') }}</p>
                                                <p><strong>{{t('actions')}}:</strong> {{ getTemplateName(campaign.actions?.[0]?.templateId) }} ({{ campaign.actions?.[0]?.minDelaySeconds || 0 }}s-{{ campaign.actions?.[0]?.maxDelaySeconds || 0 }}s)</p>
                                            </div>
                                        </div>
                                        }
                                    </div>
                                    <div class="relative mt-2 pt-2 border-t border-slate-200 dark:border-slate-700/50">
                                        <button 
                                            (click)="$event.stopPropagation(); toggleLeadMenu(lead.id)" 
                                            class="w-full text-xs text-center text-slate-500 dark:text-slate-400 hover:text-cyan-400 transition-colors py-1">
                                            {{ t('moveTo') }} &#9662;
                                        </button>
                                        @if(openLeadMenuId() === lead.id) {
                                            <div class="absolute z-50 left-0 right-0 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden"
                                                 (click)="$event.stopPropagation()">
                                                @for(s of leadStatuses; track s) {
                                                    @if(s !== lead.status) {
                                                        <a (click)="updateLeadStatus(lead.id, s); closeLeadMenu()" 
                                                           class="block px-3 py-2.5 text-sm hover:bg-cyan-500/20 dark:hover:bg-cyan-500/20 hover:text-cyan-400 cursor-pointer transition-colors">
                                                            {{ t(s) }}
                                                        </a>
                                                    }
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        } @else {
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 rounded-xl shadow-lg overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-200/50 dark:bg-slate-800/50 text-slate-600 dark:text-slate-300 uppercase text-sm">
                        <tr>
                            <th class="py-3 px-4 w-10">
                                <input type="checkbox" [checked]="isSelectAllLeads()" (change)="toggleSelectAllLeads()" 
                                       class="w-4 h-4 rounded border-purple-400 text-purple-500 focus:ring-purple-500 cursor-pointer">
                            </th>
                            <th class="py-3 px-6">{{t('leadName')}}</th>
                            <th class="py-3 px-6">{{t('campaign')}}</th>
                            <th class="py-3 px-6">{{t('status')}}</th>
                            <th class="py-3 px-6">{{t('onlineStatus')}}</th>
                            <th class="py-3 px-6">{{t('sourceGroup')}}</th>
                            <th class="py-3 px-6">{{t('capturedAt')}}</th>
                            <th class="py-3 px-6 text-right">{{t('actions')}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for(lead of leads(); track trackByChatId($index, lead)) {
                             <tr class="border-b border-slate-200 dark:border-slate-800 hover:bg-slate-200/50 dark:hover:bg-slate-800/50 transition-colors"
                                 [class.bg-purple-500/10]="isLeadSelected(lead.id)"
                                 [class.dark:bg-purple-500/10]="isLeadSelected(lead.id)">
                                <td class="py-4 px-4">
                                    <input type="checkbox" [checked]="isLeadSelected(lead.id)" (change)="toggleLeadSelection(lead.id)" 
                                           class="w-4 h-4 rounded border-purple-400 text-purple-500 focus:ring-purple-500 cursor-pointer">
                                </td>
                                <td class="py-4 px-6">
                                    <div class="font-semibold cursor-pointer hover:text-cyan-400" (click)="openLeadDetailModal(lead)">@{{lead.username}}</div>
                                    <div class="text-xs text-slate-500 dark:text-slate-400">ID: {{lead.userId}}</div>
                                </td>
                                <td class="py-4 px-6 text-sm">
                                     @if (getCampaignById(lead.campaignId); as campaign) {
                                        <div class="relative group">
                                            <span class="px-2.5 py-1 rounded-full bg-slate-500/10 text-slate-300 cursor-pointer">{{getCampaignName(lead.campaignId)}}</span>
                                            <div class="absolute hidden group-hover:block bottom-full mb-2 w-72 bg-slate-900 text-white text-xs rounded-lg p-3 shadow-lg z-10">
                                                <h4 class="font-bold border-b border-slate-600 pb-1 mb-1">{{ t('campaignDetails') }}</h4>
                                                <p><strong>{{t('triggers')}}:</strong> {{ (campaign.trigger?.sourceGroupIds || []).map(getGroupName).join(', ') }}; {{ (campaign.trigger?.keywordSetIds || []).map(getKeywordSetName).join(', ') }}</p>
                                                <p><strong>{{t('actions')}}:</strong> {{ getTemplateName(campaign.actions?.[0]?.templateId) }} ({{ campaign.actions?.[0]?.minDelaySeconds || 0 }}s-{{ campaign.actions?.[0]?.maxDelaySeconds || 0 }}s)</p>
                                            </div>
                                        </div>
                                     } @else {
                                        <span class="px-2.5 py-1 rounded-full bg-slate-500/10 text-slate-300">{{getCampaignName(lead.campaignId)}}</span>
                                     }
                                </td>
                                <td class="py-4 px-6"><span class="px-2.5 py-1 text-xs font-semibold rounded-full" [class]="getStatusColor(lead.status)">{{ t(lead.status) }}</span></td>
                                <td class="py-4 px-6"><span class="inline-flex items-center gap-2 px-2.5 py-1 text-xs font-semibold rounded-full bg-slate-500/10 text-slate-400"><span class="h-2 w-2 rounded-full" [class]="getOnlineStatusColor(lead.onlineStatus)"></span> {{ t(lead.onlineStatus) }}</span></td>
                                <td class="py-4 px-6">{{lead.sourceGroup}}</td>
                                <td class="py-4 px-6 text-sm text-slate-500 dark:text-slate-400">{{lead.timestamp.toLocaleString()}}</td>
                                <td class="py-4 px-6 text-right"><button (click)="openLeadDetailModal(lead)" class="text-cyan-400 hover:text-cyan-300 font-medium transition-colors" [title]="t('sendMessageTab')"><svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></button></td>
                            </tr>
                        } @empty {
                            <tr><td colspan="8" class="text-center p-8 text-slate-500">{{t('noRecentActivity')}}</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        }
          }
        }
      }
      @case ('lead-nurturing') {
        <!-- ğŸ†• å®¢æˆ¶åŸ¹è‚²ç³»çµ±é é¢ -->
        <app-lead-management class="block h-full -m-8"></app-lead-management>
      }
      @case ('nurturing-analytics') {
        <!-- ğŸ†• Phase 4: åˆ†æå„€è¡¨æ¿ -->
        <app-analytics-dashboard class="block h-full -m-8"></app-analytics-dashboard>
      }
      @case ('analytics-center') {
        <!-- ğŸ†• Phase 2: æ•¸æ“šåˆ†æä¸­å¿ƒ -->
        <app-analytics-center class="block h-full -m-8"></app-analytics-center>
      }
      @case ('ads') {
        <!-- å»£å‘Šç™¼é€ç³»çµ±é é¢ -->
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ“¢</span> å»£å‘Šç™¼é€ç³»çµ±
        </h2>
        
        <!-- Tab å°èˆª -->
        <div class="flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-lg w-fit">
          <button (click)="adSystemTab.set('templates')" 
                  [class]="adSystemTab() === 'templates' ? 'bg-orange-500/30 text-orange-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“</span> æ¨¡æ¿ç®¡ç†
          </button>
          <button (click)="adSystemTab.set('schedules')" 
                  [class]="adSystemTab() === 'schedules' ? 'bg-orange-500/30 text-orange-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“…</span> ç™¼é€è¨ˆåŠƒ
          </button>
          <button (click)="adSystemTab.set('logs'); loadAdSendLogs()" 
                  [class]="adSystemTab() === 'logs' ? 'bg-orange-500/30 text-orange-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“Š</span> ç™¼é€è¨˜éŒ„
          </button>
          <button (click)="adSystemTab.set('analytics'); loadAdOverviewStats()" 
                  [class]="adSystemTab() === 'analytics' ? 'bg-orange-500/30 text-orange-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“ˆ</span> æ•ˆæœåˆ†æ
          </button>
        </div>
        
        <!-- æ¨¡æ¿ç®¡ç† Tab -->
        @if (adSystemTab() === 'templates') {
          <div class="space-y-4">
            <!-- å·¥å…·æ¬„ -->
            <div class="flex justify-between items-center">
              <span class="text-slate-400">å…± {{ adTemplates().length }} å€‹æ¨¡æ¿</span>
              <button (click)="showAdTemplateForm.set(true)" 
                      [disabled]="!membershipService.hasFeature('adBroadcast')"
                      [class.opacity-50]="!membershipService.hasFeature('adBroadcast')"
                      [class.cursor-not-allowed]="!membershipService.hasFeature('adBroadcast')"
                      [title]="!membershipService.hasFeature('adBroadcast') ? 'éœ€è¦ ç™½éŠ€ç²¾è‹± æˆ–ä»¥ä¸Šæœƒå“¡' : ''"
                      class="px-4 py-2 bg-orange-500/20 text-orange-400 rounded-lg hover:bg-orange-500/30 disabled:hover:bg-orange-500/20 transition-colors flex items-center gap-2">
                <span>+</span> æ–°å»ºæ¨¡æ¿
                @if (!membershipService.hasFeature('adBroadcast')) {
                  <span class="text-xs opacity-60">ğŸ¥ˆ</span>
                }
              </button>
            </div>
            
            <!-- å‰µå»ºæ¨¡æ¿è¡¨å–® -->
            @if (showAdTemplateForm()) {
              <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                <h3 class="text-lg font-semibold text-white mb-4">å‰µå»ºå»£å‘Šæ¨¡æ¿</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">æ¨¡æ¿åç¨±</label>
                    <input type="text" 
                           [value]="newAdTemplate().name"
                           (input)="updateAdTemplateName($any($event.target).value)"
                           class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500/50"
                           placeholder="ä¾‹å¦‚ï¼šç”¢å“æ¨å»£æ¨¡æ¿">
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">æ¨¡æ¿å…§å®¹ (æ”¯æŒ Spintax)</label>
                    <textarea [value]="newAdTemplate().content"
                              (input)="updateAdTemplateContent($any($event.target).value)"
                              rows="5"
                              class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500/50 font-mono"
                              [placeholder]="'{ä½ å¥½|å—¨|Hi}ï¼æˆ‘å€‘æä¾›{å„ªè³ª|å°ˆæ¥­}çš„æœå‹™...'"></textarea>
                    <p class="text-xs text-slate-500 mt-1">ä½¿ç”¨ {{ '{' }}é¸é …1|é¸é …2|é¸é …3{{ '}' }} èªæ³•å‰µå»ºè®Šé«”</p>
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">åª’é«”é¡å‹</label>
                    <select [value]="newAdTemplate().mediaType"
                            (change)="updateAdTemplateMediaType($any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                      <option value="text">ç´”æ–‡å­—</option>
                      <option value="photo">åœ–ç‰‡</option>
                      <option value="video">å½±ç‰‡</option>
                      <option value="document">æ–‡ä»¶</option>
                    </select>
                  </div>
                  <!-- Spintax é è¦½ -->
                  <div>
                    <button (click)="previewSpintax(newAdTemplate().content)" 
                            [disabled]="isPreviewingSpintax()"
                            class="px-4 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                      {{ isPreviewingSpintax() ? 'ç”Ÿæˆä¸­...' : 'é è¦½è®Šé«”' }}
                    </button>
                    @if (spintaxPreview().length > 0) {
                      <div class="mt-3 p-3 bg-slate-700/30 rounded-lg space-y-2">
                        <p class="text-xs text-slate-400 mb-2">è®Šé«”é è¦½ï¼š</p>
                        @for (variant of spintaxPreview(); track $index) {
                          <div class="p-2 bg-slate-800/50 rounded text-sm text-slate-300" [textContent]="variant"></div>
                        }
                      </div>
                    }
                  </div>
                  <div class="flex gap-3">
                    <button (click)="createAdTemplate()" 
                            class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                      å‰µå»ºæ¨¡æ¿
                    </button>
                    <button (click)="showAdTemplateForm.set(false); spintaxPreview.set([])" 
                            class="px-6 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                      å–æ¶ˆ
                    </button>
                  </div>
                </div>
              </div>
            }
            
            <!-- æ¨¡æ¿åˆ—è¡¨ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              @for (template of adTemplates(); track template.id) {
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <div class="flex justify-between items-start mb-3">
                    <div>
                      <h4 class="font-semibold text-white">{{ template.name }}</h4>
                      <span class="text-xs px-2 py-0.5 rounded-full" 
                            [class]="template.isActive ? 'bg-green-500/20 text-green-400' : 'bg-slate-500/20 text-slate-400'">
                        {{ template.isActive ? 'å•Ÿç”¨ä¸­' : 'å·²åœç”¨' }}
                      </span>
                    </div>
                    <div class="flex gap-2">
                      <button (click)="toggleAdTemplateStatus(template.id)" 
                              class="p-2 text-slate-400 hover:text-white transition-colors"
                              [title]="template.isActive ? 'åœç”¨' : 'å•Ÿç”¨'">
                        @if (template.isActive) {
                          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4" y1="21" x2="20" y2="3"/></svg>
                        } @else {
                          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>
                        }
                      </button>
                      <button (click)="deleteAdTemplate(template.id)" 
                              class="p-2 text-red-400 hover:text-red-300 transition-colors"
                              title="åˆªé™¤">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/></svg>
                      </button>
                    </div>
                  </div>
                  <p class="text-sm text-slate-400 mb-3 line-clamp-3 font-mono" [textContent]="template.content"></p>
                  <div class="flex gap-4 text-xs text-slate-500">
                    <span>ä½¿ç”¨: {{ template.useCount }}</span>
                    <span class="text-green-400">æˆåŠŸ: {{ template.successCount }}</span>
                    <span class="text-red-400">å¤±æ•—: {{ template.failCount }}</span>
                  </div>
                </div>
              } @empty {
                <div class="col-span-2 text-center py-12 text-slate-500">
                  <p class="text-4xl mb-2">ğŸ“</p>
                  <p>é‚„æ²’æœ‰å»£å‘Šæ¨¡æ¿</p>
                  <p class="text-sm">é»æ“Šã€Œæ–°å»ºæ¨¡æ¿ã€å‰µå»ºä½ çš„ç¬¬ä¸€å€‹å»£å‘Šæ¨¡æ¿</p>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- ç™¼é€è¨ˆåŠƒ Tab -->
        @if (adSystemTab() === 'schedules') {
          <div class="space-y-4">
            <!-- å·¥å…·æ¬„ -->
            <div class="flex justify-between items-center">
              <span class="text-slate-400">å…± {{ adSchedules().length }} å€‹è¨ˆåŠƒ</span>
              <button (click)="showAdScheduleForm.set(true)" 
                      [disabled]="!membershipService.hasFeature('adBroadcast')"
                      [class.opacity-50]="!membershipService.hasFeature('adBroadcast')"
                      [class.cursor-not-allowed]="!membershipService.hasFeature('adBroadcast')"
                      [title]="!membershipService.hasFeature('adBroadcast') ? 'éœ€è¦ ç™½éŠ€ç²¾è‹± æˆ–ä»¥ä¸Šæœƒå“¡' : ''"
                      class="px-4 py-2 bg-orange-500/20 text-orange-400 rounded-lg hover:bg-orange-500/30 disabled:hover:bg-orange-500/20 transition-colors flex items-center gap-2">
                <span>+</span> æ–°å»ºè¨ˆåŠƒ
                @if (!membershipService.hasFeature('adBroadcast')) {
                  <span class="text-xs opacity-60">ğŸ¥ˆ</span>
                }
              </button>
            </div>
            
            <!-- å‰µå»ºè¨ˆåŠƒè¡¨å–® -->
            @if (showAdScheduleForm()) {
              <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                <h3 class="text-lg font-semibold text-white mb-4">å‰µå»ºç™¼é€è¨ˆåŠƒ</h3>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">è¨ˆåŠƒåç¨±</label>
                    <input type="text" 
                           [value]="newAdSchedule().name"
                           (input)="updateAdScheduleName($any($event.target).value)"
                           class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500/50"
                           placeholder="ä¾‹å¦‚ï¼šæ¯æ—¥æ¨å»£è¨ˆåŠƒ">
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">é¸æ“‡æ¨¡æ¿</label>
                    <select [value]="newAdSchedule().templateId"
                            (change)="updateAdScheduleTemplateId(+$any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                      <option value="0">-- é¸æ“‡æ¨¡æ¿ --</option>
                      @for (template of adTemplates(); track template.id) {
                        <option [value]="template.id">{{ template.name }}</option>
                      }
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">ç™¼é€æ¨¡å¼</label>
                    <select [value]="newAdSchedule().sendMode"
                            (change)="updateAdScheduleSendMode($any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                      <option value="scheduled">å®šæ™‚ç™¼é€</option>
                      <option value="interval">é–“éš”å¾ªç’°</option>
                      <option value="triggered">é—œéµè©è§¸ç™¼</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">è¨ˆåŠƒé¡å‹</label>
                    <select [value]="newAdSchedule().scheduleType"
                            (change)="updateAdScheduleType($any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                      <option value="once">ä¸€æ¬¡æ€§</option>
                      <option value="daily">æ¯æ—¥</option>
                      <option value="interval">é–“éš”é‡è¤‡</option>
                    </select>
                  </div>
                  @if (newAdSchedule().scheduleType === 'daily') {
                    <div>
                      <label class="block text-sm text-slate-400 mb-1">ç™¼é€æ™‚é–“</label>
                      <input type="time" 
                             [value]="newAdSchedule().scheduleTime"
                             (input)="updateAdScheduleTime($any($event.target).value)"
                             class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                    </div>
                  }
                  @if (newAdSchedule().scheduleType === 'interval') {
                    <div>
                      <label class="block text-sm text-slate-400 mb-1">é–“éš”åˆ†é˜</label>
                      <input type="number" 
                             [value]="newAdSchedule().intervalMinutes"
                             (input)="updateAdScheduleInterval(+$any($event.target).value)"
                             min="5"
                             class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                    </div>
                  }
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">å¸³è™Ÿç­–ç•¥</label>
                    <select [value]="newAdSchedule().accountStrategy"
                            (change)="updateAdScheduleStrategy($any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none">
                      <option value="rotate">è¼ªæ›å¸³è™Ÿ</option>
                      <option value="single">å–®ä¸€å¸³è™Ÿ</option>
                      <option value="random">éš¨æ©Ÿé¸æ“‡</option>
                    </select>
                  </div>
                  <div class="col-span-2">
                    <label class="block text-sm text-slate-400 mb-1">ç™¼é€å¸³è™Ÿ</label>
                    <div class="flex flex-wrap gap-2 p-3 bg-slate-700/30 rounded-lg min-h-[60px]">
                      @for (account of accounts(); track account.id) {
                        @if (account.status === 'Online') {
                          <label class="flex items-center gap-2 px-3 py-1.5 bg-slate-600/50 rounded-lg cursor-pointer hover:bg-slate-600 transition-colors">
                            <input type="checkbox" 
                                   [checked]="newAdSchedule().assignedAccounts.includes(account.phone)"
                                   (change)="toggleAccountForSchedule(account.phone)"
                                   class="rounded border-slate-500">
                            <span class="text-sm text-slate-300">{{ account.phone }}</span>
                          </label>
                        }
                      } @empty {
                        <span class="text-slate-500 text-sm">æ²’æœ‰åœ¨ç·šå¸³è™Ÿ</span>
                      }
                    </div>
                  </div>
                  <div class="col-span-2">
                    <label class="block text-sm text-slate-400 mb-1">ç›®æ¨™ç¾¤çµ„ (è¼¸å…¥ç¾¤çµ„ ID æˆ– username)</label>
                    <textarea [value]="newAdSchedule().targetGroups.join('\n')"
                              (input)="updateScheduleTargetGroups($any($event.target).value)"
                              rows="3"
                              class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500/50 font-mono"
                              placeholder="æ¯è¡Œä¸€å€‹ç¾¤çµ„ ID æˆ– @username"></textarea>
                  </div>
                </div>
                <div class="flex gap-3 mt-4">
                  <button (click)="createAdSchedule()" 
                          class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                    å‰µå»ºè¨ˆåŠƒ
                  </button>
                  <button (click)="showAdScheduleForm.set(false)" 
                          class="px-6 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                    å–æ¶ˆ
                  </button>
                </div>
              </div>
            }
            
            <!-- è¨ˆåŠƒåˆ—è¡¨ -->
            <div class="space-y-3">
              @for (schedule of adSchedules(); track schedule.id) {
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <div class="flex items-center gap-3 mb-2">
                        <h4 class="font-semibold text-white">{{ schedule.name }}</h4>
                        <span class="text-xs px-2 py-0.5 rounded-full" 
                              [class]="schedule.isActive ? 'bg-green-500/20 text-green-400' : 'bg-slate-500/20 text-slate-400'">
                          {{ schedule.isActive ? 'å•Ÿç”¨ä¸­' : 'å·²åœç”¨' }}
                        </span>
                      </div>
                      <div class="grid grid-cols-4 gap-4 text-sm text-slate-400">
                        <div>
                          <span class="text-slate-500">æ¨¡å¼:</span> 
                          {{ getSendModeLabel(schedule.sendMode) }}
                        </div>
                        <div>
                          <span class="text-slate-500">é¡å‹:</span> 
                          {{ getScheduleTypeLabel(schedule.scheduleType) }}
                        </div>
                        <div>
                          <span class="text-slate-500">ç›®æ¨™:</span> 
                          {{ schedule.targetGroups.length }} å€‹ç¾¤çµ„
                        </div>
                        <div>
                          <span class="text-slate-500">å¸³è™Ÿ:</span> 
                          {{ getAccountStrategyLabel(schedule.accountStrategy) }}
                        </div>
                      </div>
                      <div class="flex gap-6 mt-2 text-xs">
                        <span class="text-slate-500">åŸ·è¡Œæ¬¡æ•¸: {{ schedule.runCount }}</span>
                        <span class="text-green-400">æˆåŠŸ: {{ schedule.successCount }}</span>
                        <span class="text-red-400">å¤±æ•—: {{ schedule.failCount }}</span>
                        @if (schedule.nextRunAt) {
                          <span class="text-cyan-400">ä¸‹æ¬¡åŸ·è¡Œ: {{ formatBatchOperationDate(schedule.nextRunAt) }}</span>
                        }
                      </div>
                    </div>
                    <div class="flex gap-2">
                      <button (click)="runAdScheduleNow(schedule.id)" 
                              class="px-3 py-1.5 bg-cyan-500/20 text-cyan-400 rounded-lg hover:bg-cyan-500/30 transition-colors text-sm"
                              title="ç«‹å³åŸ·è¡Œ">
                        â–¶ åŸ·è¡Œ
                      </button>
                      <button (click)="toggleAdScheduleStatus(schedule.id)" 
                              class="p-2 text-slate-400 hover:text-white transition-colors"
                              [title]="schedule.isActive ? 'åœç”¨' : 'å•Ÿç”¨'">
                        @if (schedule.isActive) {
                          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                        } @else {
                          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5,3 19,12 5,21 5,3"/></svg>
                        }
                      </button>
                      <button (click)="deleteAdSchedule(schedule.id)" 
                              class="p-2 text-red-400 hover:text-red-300 transition-colors"
                              title="åˆªé™¤">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/></svg>
                      </button>
                    </div>
                  </div>
                </div>
              } @empty {
                <div class="text-center py-12 text-slate-500">
                  <p class="text-4xl mb-2">ğŸ“…</p>
                  <p>é‚„æ²’æœ‰ç™¼é€è¨ˆåŠƒ</p>
                  <p class="text-sm">é»æ“Šã€Œæ–°å»ºè¨ˆåŠƒã€å‰µå»ºä½ çš„ç¬¬ä¸€å€‹ç™¼é€è¨ˆåŠƒ</p>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- ç™¼é€è¨˜éŒ„ Tab -->
        @if (adSystemTab() === 'logs') {
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-slate-400">æœ€è¿‘ {{ adSendLogs().length }} æ¢ç™¼é€è¨˜éŒ„</span>
              <button (click)="loadAdSendLogs()" 
                      class="px-4 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                åˆ·æ–°
              </button>
            </div>
            
            <div class="bg-slate-800/50 rounded-xl border border-slate-700/50 overflow-hidden">
              <table class="w-full">
                <thead class="bg-slate-700/30">
                  <tr>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">æ™‚é–“</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">ç¾¤çµ„</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">å¸³è™Ÿ</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">å…§å®¹</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">ç‹€æ…‹</th>
                  </tr>
                </thead>
                <tbody>
                  @for (log of adSendLogs(); track log.id) {
                    <tr class="border-t border-slate-700/30 hover:bg-slate-700/20">
                      <td class="py-3 px-4 text-sm text-slate-300">{{ formatBatchOperationDate(log.sentAt) }}</td>
                      <td class="py-3 px-4 text-sm text-slate-300">{{ log.targetGroupTitle || log.targetGroupId }}</td>
                      <td class="py-3 px-4 text-sm text-slate-400 font-mono">{{ log.accountPhone }}</td>
                      <td class="py-3 px-4 text-sm text-slate-400 max-w-xs truncate" [title]="log.variantContent">{{ log.variantContent }}</td>
                      <td class="py-3 px-4">
                        <span class="text-xs px-2 py-0.5 rounded-full" [class]="getAdStatusColor(log.status)">
                          {{ log.status === 'sent' ? 'å·²ç™¼é€' : log.status === 'failed' ? 'å¤±æ•—' : log.status === 'banned' ? 'è¢«å°ç¦' : 'å·²åˆªé™¤' }}
                        </span>
                      </td>
                    </tr>
                  } @empty {
                    <tr>
                      <td colspan="5" class="py-12 text-center text-slate-500">
                        <p class="text-4xl mb-2">ğŸ“Š</p>
                        <p>æš«ç„¡ç™¼é€è¨˜éŒ„</p>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }
        
        <!-- æ•ˆæœåˆ†æ Tab -->
        @if (adSystemTab() === 'analytics') {
          <div class="space-y-6">
            @if (adOverviewStats()) {
              @let stats = adOverviewStats();
              <!-- ç¸½è¦½å¡ç‰‡ -->
              <div class="grid grid-cols-4 gap-4">
                <div class="bg-gradient-to-br from-cyan-500/20 to-blue-500/20 rounded-xl p-5 border border-cyan-500/30">
                  <p class="text-3xl font-bold text-white">{{ stats.totalSends }}</p>
                  <p class="text-sm text-slate-400">ç¸½ç™¼é€æ¬¡æ•¸</p>
                </div>
                <div class="bg-gradient-to-br from-green-500/20 to-emerald-500/20 rounded-xl p-5 border border-green-500/30">
                  <p class="text-3xl font-bold text-green-400">{{ stats.successRate }}%</p>
                  <p class="text-sm text-slate-400">æˆåŠŸç‡</p>
                </div>
                <div class="bg-gradient-to-br from-orange-500/20 to-amber-500/20 rounded-xl p-5 border border-orange-500/30">
                  <p class="text-3xl font-bold text-orange-400">{{ stats.groupsReached }}</p>
                  <p class="text-sm text-slate-400">è§¸é”ç¾¤çµ„</p>
                </div>
                <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-xl p-5 border border-purple-500/30">
                  <p class="text-3xl font-bold text-purple-400">{{ stats.todaySends }}</p>
                  <p class="text-sm text-slate-400">ä»Šæ—¥ç™¼é€</p>
                </div>
              </div>
              
              <!-- è©³ç´°çµ±è¨ˆ -->
              <div class="grid grid-cols-2 gap-6">
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <h4 class="font-semibold text-white mb-4">ç™¼é€çµ±è¨ˆ</h4>
                  <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">æˆåŠŸç™¼é€</span>
                      <span class="text-green-400">{{ stats.successfulSends }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">ç™¼é€å¤±æ•—</span>
                      <span class="text-red-400">{{ stats.failedSends }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">è¢«å°ç¦</span>
                      <span class="text-red-500">{{ stats.bannedSends }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">å·²åˆªé™¤</span>
                      <span class="text-yellow-400">{{ stats.deletedSends }}</span>
                    </div>
                  </div>
                </div>
                
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <h4 class="font-semibold text-white mb-4">ç³»çµ±ç‹€æ…‹</h4>
                  <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">æ´»èºæ¨¡æ¿</span>
                      <span class="text-cyan-400">{{ stats.activeTemplates }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">æ´»èºè¨ˆåŠƒ</span>
                      <span class="text-cyan-400">{{ stats.activeSchedules }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-slate-400">ä»Šæ—¥æˆåŠŸ</span>
                      <span class="text-green-400">{{ stats.todaySuccess }}</span>
                    </div>
                  </div>
                </div>
              </div>
            } @else {
              <div class="text-center py-12 text-slate-500">
                <p class="text-4xl mb-2">ğŸ“ˆ</p>
                <p>æ­£åœ¨åŠ è¼‰çµ±è¨ˆæ•¸æ“š...</p>
              </div>
            }
          </div>
        }
      }
      @case ('user-tracking') {
        <!-- ç”¨æˆ¶è¿½è¹¤ç³»çµ±é é¢ -->
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ‘¤</span> ç”¨æˆ¶è¿½è¹¤ç³»çµ±
        </h2>
        
        <!-- Tab å°èˆª -->
        <div class="flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-lg w-fit">
          <button (click)="userTrackingTab.set('users')" 
                  [class]="userTrackingTab() === 'users' ? 'bg-emerald-500/30 text-emerald-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ‘¥</span> è¿½è¹¤ç”¨æˆ¶
          </button>
          <button (click)="userTrackingTab.set('groups'); loadHighValueGroups()" 
                  [class]="userTrackingTab() === 'groups' ? 'bg-emerald-500/30 text-emerald-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ†</span> é«˜åƒ¹å€¼ç¾¤çµ„
          </button>
          <button (click)="userTrackingTab.set('analytics'); loadTrackingStats()" 
                  [class]="userTrackingTab() === 'analytics' ? 'bg-emerald-500/30 text-emerald-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“Š</span> çµ±è¨ˆåˆ†æ
          </button>
        </div>
        
        <!-- è¿½è¹¤ç”¨æˆ¶ Tab -->
        @if (userTrackingTab() === 'users') {
          <div class="space-y-4">
            <!-- å·¥å…·æ¬„ -->
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-3">
                <span class="text-slate-400">å…± {{ trackedUsers().length }} å€‹è¿½è¹¤ç”¨æˆ¶</span>
                <select [value]="userValueFilter()" 
                        (change)="userValueFilter.set($any($event.target).value); loadTrackedUsers()"
                        class="px-3 py-1.5 bg-slate-700/50 border border-slate-600/50 rounded-lg text-sm text-slate-300">
                  <option value="">å…¨éƒ¨ç­‰ç´š</option>
                  <option value="vip">VIP</option>
                  <option value="high">é«˜åƒ¹å€¼</option>
                  <option value="medium">ä¸­ç­‰</option>
                  <option value="low">ä½</option>
                </select>
              </div>
              <button (click)="showAddUserForm.set(true)" 
                      class="px-4 py-2 bg-emerald-500/20 text-emerald-400 rounded-lg hover:bg-emerald-500/30 transition-colors flex items-center gap-2">
                <span>+</span> æ·»åŠ ç”¨æˆ¶
              </button>
            </div>
            
            <!-- æ·»åŠ ç”¨æˆ¶è¡¨å–® -->
            @if (showAddUserForm()) {
              <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                <h3 class="text-lg font-semibold text-white mb-4">æ·»åŠ è¿½è¹¤ç”¨æˆ¶</h3>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">ç”¨æˆ¶ ID *</label>
                    <input type="text" 
                           [value]="newTrackedUser().userId"
                           (input)="updateTrackedUserId($any($event.target).value)"
                           class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500/50"
                           placeholder="ä¾‹å¦‚ï¼š123456789">
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">ç”¨æˆ¶å</label>
                    <input type="text" 
                           [value]="newTrackedUser().username"
                           (input)="updateTrackedUserName($any($event.target).value)"
                           class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none"
                           placeholder="@username">
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">å‚™è¨»</label>
                    <input type="text" 
                           [value]="newTrackedUser().notes"
                           (input)="updateTrackedUserNotes($any($event.target).value)"
                           class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none"
                           placeholder="å¯é¸">
                  </div>
                </div>
                <div class="flex gap-3 mt-4">
                  <button (click)="addUserToTrack()" 
                          class="px-6 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-colors">
                    æ·»åŠ ç”¨æˆ¶
                  </button>
                  <button (click)="showAddUserForm.set(false)" 
                          class="px-6 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                    å–æ¶ˆ
                  </button>
                </div>
              </div>
            }
            
            <!-- ç”¨æˆ¶åˆ—è¡¨ -->
            <div class="bg-slate-800/50 rounded-xl border border-slate-700/50 overflow-hidden">
              <table class="w-full">
                <thead class="bg-slate-700/30">
                  <tr>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">ç”¨æˆ¶</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">åƒ¹å€¼ç­‰ç´š</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">ç¾¤çµ„æ•¸</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">é«˜åƒ¹å€¼ç¾¤çµ„</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">ç‹€æ…‹</th>
                    <th class="text-left py-3 px-4 text-sm font-medium text-slate-400">ä¾†æº</th>
                    <th class="text-right py-3 px-4 text-sm font-medium text-slate-400">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  @for (user of trackedUsers(); track user.id) {
                    <tr class="border-t border-slate-700/30 hover:bg-slate-700/20">
                      <td class="py-3 px-4">
                        <div class="font-medium text-white">{{ user.displayName }}</div>
                        <div class="text-xs text-slate-500">ID: {{ user.userId }}</div>
                      </td>
                      <td class="py-3 px-4">
                        <select [value]="user.valueLevel"
                                (change)="updateUserValueLevel(user.userId, $any($event.target).value)"
                                class="px-2 py-1 rounded-lg text-xs border" 
                                [class]="getValueLevelColor(user.valueLevel)">
                          <option value="vip">VIP</option>
                          <option value="high">é«˜åƒ¹å€¼</option>
                          <option value="medium">ä¸­ç­‰</option>
                          <option value="low">ä½</option>
                        </select>
                      </td>
                      <td class="py-3 px-4 text-sm text-slate-300">{{ user.groupsCount }}</td>
                      <td class="py-3 px-4 text-sm text-orange-400">{{ user.highValueGroups }}</td>
                      <td class="py-3 px-4">
                        <span class="text-xs px-2 py-0.5 rounded-full" [class]="getTrackingStatusColor(user.trackingStatus)">
                          {{ getTrackingStatusLabel(user.trackingStatus) }}
                        </span>
                      </td>
                      <td class="py-3 px-4 text-sm text-slate-400">{{ user.source }}</td>
                      <td class="py-3 px-4 text-right">
                        <div class="flex gap-2 justify-end">
                          <button (click)="trackUserGroups(user.userId)" 
                                  [disabled]="isTrackingUser()"
                                  class="px-3 py-1 bg-cyan-500/20 text-cyan-400 rounded text-xs hover:bg-cyan-500/30 disabled:opacity-50"
                                  title="è¿½è¹¤ç¾¤çµ„">
                            {{ isTrackingUser() ? '...' : 'ğŸ” è¿½è¹¤' }}
                          </button>
                          <button (click)="viewUserGroups(user)" 
                                  class="px-3 py-1 bg-slate-600/50 text-slate-300 rounded text-xs hover:bg-slate-600"
                                  title="æŸ¥çœ‹ç¾¤çµ„">
                            ğŸ“‹ ç¾¤çµ„
                          </button>
                          <button (click)="removeTrackedUser(user.userId)" 
                                  class="p-1 text-red-400 hover:text-red-300"
                                  title="ç§»é™¤">
                            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/></svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  } @empty {
                    <tr>
                      <td colspan="7" class="py-12 text-center text-slate-500">
                        <p class="text-4xl mb-2">ğŸ‘¤</p>
                        <p>é‚„æ²’æœ‰è¿½è¹¤ç”¨æˆ¶</p>
                        <p class="text-sm">é»æ“Šã€Œæ·»åŠ ç”¨æˆ¶ã€é–‹å§‹è¿½è¹¤é«˜åƒ¹å€¼ç”¨æˆ¶</p>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
            
            <!-- ç”¨æˆ¶ç¾¤çµ„è©³æƒ…å°è©±æ¡† -->
            @if (selectedTrackedUser()) {
              <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" (click)="selectedTrackedUser.set(null)">
                <div class="bg-slate-800 rounded-xl p-6 w-[700px] max-h-[80vh] overflow-auto" (click)="$event.stopPropagation()">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-white">
                      {{ selectedTrackedUser().displayName }} çš„ç¾¤çµ„
                    </h3>
                    <button (click)="selectedTrackedUser.set(null)" class="text-slate-400 hover:text-white">
                      <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                  </div>
                  <div class="space-y-2">
                    @for (group of userGroups(); track group.id) {
                      <div class="p-3 rounded-lg" [class]="group.isHighValue ? 'bg-orange-500/10 border border-orange-500/30' : 'bg-slate-700/30'">
                        <div class="flex justify-between items-center">
                          <div>
                            <span class="font-medium text-white">{{ group.groupTitle }}</span>
                            @if (group.groupUsername) {
                              <span class="text-slate-400 text-sm ml-2">@{{ group.groupUsername }}</span>
                            }
                          </div>
                          <div class="flex items-center gap-3">
                            <span class="text-sm text-slate-400">{{ group.memberCount }} æˆå“¡</span>
                            @if (group.isHighValue) {
                              <span class="text-xs px-2 py-0.5 bg-orange-500/20 text-orange-400 rounded-full">é«˜åƒ¹å€¼</span>
                            }
                          </div>
                        </div>
                      </div>
                    } @empty {
                      <p class="text-center text-slate-500 py-8">å°šæœªç™¼ç¾ç¾¤çµ„ï¼Œè«‹å…ˆåŸ·è¡Œè¿½è¹¤</p>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        }
        
        <!-- é«˜åƒ¹å€¼ç¾¤çµ„ Tab -->
        @if (userTrackingTab() === 'groups') {
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-slate-400">é€šéç”¨æˆ¶è¿½è¹¤ç™¼ç¾çš„é«˜åƒ¹å€¼ç¾¤çµ„</span>
              <button (click)="loadHighValueGroups()" 
                      class="px-4 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                åˆ·æ–°
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              @for (group of highValueGroups(); track group.groupId) {
                <div class="bg-gradient-to-br from-orange-500/10 to-amber-500/10 rounded-xl p-5 border border-orange-500/30">
                  <div class="flex justify-between items-start mb-3">
                    <div>
                      <h4 class="font-semibold text-white">{{ group.groupTitle }}</h4>
                      @if (group.groupUsername) {
                        <span class="text-sm text-slate-400">@{{ group.groupUsername }}</span>
                      }
                    </div>
                    <span class="text-xs px-2 py-1 bg-orange-500/20 text-orange-400 rounded-full">
                      é«˜åƒ¹å€¼
                    </span>
                  </div>
                  <div class="grid grid-cols-3 gap-4 text-sm">
                    <div>
                      <p class="text-2xl font-bold text-white">{{ group.memberCount }}</p>
                      <p class="text-slate-400">æˆå“¡æ•¸</p>
                    </div>
                    <div>
                      <p class="text-2xl font-bold text-cyan-400">{{ group.usersCount }}</p>
                      <p class="text-slate-400">è¿½è¹¤ç”¨æˆ¶</p>
                    </div>
                    <div>
                      <p class="text-2xl font-bold text-emerald-400">{{ (group.valueScore * 100).toFixed(0) }}%</p>
                      <p class="text-slate-400">åƒ¹å€¼åˆ†</p>
                    </div>
                  </div>
                </div>
              } @empty {
                <div class="col-span-2 text-center py-12 text-slate-500">
                  <p class="text-4xl mb-2">ğŸ†</p>
                  <p>é‚„æ²’æœ‰ç™¼ç¾é«˜åƒ¹å€¼ç¾¤çµ„</p>
                  <p class="text-sm">è¿½è¹¤æ›´å¤šç”¨æˆ¶ä»¥ç™¼ç¾é«˜åƒ¹å€¼ç¾¤çµ„</p>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- çµ±è¨ˆåˆ†æ Tab -->
        @if (userTrackingTab() === 'analytics') {
          <div class="space-y-6">
            @if (trackingStats()) {
              @let stats = trackingStats();
              <!-- ç¸½è¦½å¡ç‰‡ -->
              <div class="grid grid-cols-4 gap-4">
                <div class="bg-gradient-to-br from-cyan-500/20 to-blue-500/20 rounded-xl p-5 border border-cyan-500/30">
                  <p class="text-3xl font-bold text-white">{{ stats.totalUsers }}</p>
                  <p class="text-sm text-slate-400">è¿½è¹¤ç”¨æˆ¶</p>
                </div>
                <div class="bg-gradient-to-br from-emerald-500/20 to-green-500/20 rounded-xl p-5 border border-emerald-500/30">
                  <p class="text-3xl font-bold text-emerald-400">{{ stats.totalGroupsDiscovered }}</p>
                  <p class="text-sm text-slate-400">ç™¼ç¾ç¾¤çµ„</p>
                </div>
                <div class="bg-gradient-to-br from-orange-500/20 to-amber-500/20 rounded-xl p-5 border border-orange-500/30">
                  <p class="text-3xl font-bold text-orange-400">{{ stats.highValueGroups }}</p>
                  <p class="text-sm text-slate-400">é«˜åƒ¹å€¼ç¾¤çµ„</p>
                </div>
                <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-xl p-5 border border-purple-500/30">
                  <p class="text-3xl font-bold text-purple-400">{{ stats.todayTracked }}</p>
                  <p class="text-sm text-slate-400">ä»Šæ—¥è¿½è¹¤</p>
                </div>
              </div>
              
              <!-- è©³ç´°çµ±è¨ˆ -->
              <div class="grid grid-cols-2 gap-6">
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <h4 class="font-semibold text-white mb-4">ç”¨æˆ¶åƒ¹å€¼åˆ†ä½ˆ</h4>
                  <div class="space-y-3">
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">VIP</span>
                      <span class="px-3 py-1 bg-purple-500/20 text-purple-400 rounded-full text-sm">{{ stats.byValueLevel.vip }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">é«˜åƒ¹å€¼</span>
                      <span class="px-3 py-1 bg-orange-500/20 text-orange-400 rounded-full text-sm">{{ stats.byValueLevel.high }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">ä¸­ç­‰</span>
                      <span class="px-3 py-1 bg-cyan-500/20 text-cyan-400 rounded-full text-sm">{{ stats.byValueLevel.medium }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">ä½</span>
                      <span class="px-3 py-1 bg-slate-500/20 text-slate-400 rounded-full text-sm">{{ stats.byValueLevel.low }}</span>
                    </div>
                  </div>
                </div>
                
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <h4 class="font-semibold text-white mb-4">è¿½è¹¤ç‹€æ…‹åˆ†ä½ˆ</h4>
                  <div class="space-y-3">
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">å¾…è¿½è¹¤</span>
                      <span class="px-3 py-1 bg-yellow-500/20 text-yellow-400 rounded-full text-sm">{{ stats.byStatus.pending }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">è¿½è¹¤ä¸­</span>
                      <span class="px-3 py-1 bg-blue-500/20 text-blue-400 rounded-full text-sm">{{ stats.byStatus.tracking }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">å·²å®Œæˆ</span>
                      <span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm">{{ stats.byStatus.completed }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">å¤±æ•—</span>
                      <span class="px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-sm">{{ stats.byStatus.failed }}</span>
                    </div>
                  </div>
                </div>
              </div>
            } @else {
              <div class="text-center py-12 text-slate-500">
                <p class="text-4xl mb-2">ğŸ“Š</p>
                <p>æ­£åœ¨åŠ è¼‰çµ±è¨ˆæ•¸æ“š...</p>
              </div>
            }
          </div>
        }
      }
      @case ('campaigns') {
        <!-- ç‡ŸéŠ·æ´»å‹•é é¢ -->
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ“ˆ</span> ç‡ŸéŠ·æ´»å‹•å”èª¿å™¨
        </h2>
        
        <!-- çµ±ä¸€æ¦‚è¦½ -->
        @if (unifiedOverview()) {
          @let overview = unifiedOverview();
          <div class="grid grid-cols-6 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-xl p-4 border border-blue-500/30">
              <p class="text-2xl font-bold text-white">{{ overview.totals.resourcesDiscovered }}</p>
              <p class="text-xs text-slate-400">ç™¼ç¾è³‡æº</p>
            </div>
            <div class="bg-gradient-to-br from-emerald-500/20 to-green-500/20 rounded-xl p-4 border border-emerald-500/30">
              <p class="text-2xl font-bold text-emerald-400">{{ overview.totals.leadsGenerated }}</p>
              <p class="text-xs text-slate-400">ç”Ÿæˆæ½›å®¢</p>
            </div>
            <div class="bg-gradient-to-br from-orange-500/20 to-amber-500/20 rounded-xl p-4 border border-orange-500/30">
              <p class="text-2xl font-bold text-orange-400">{{ overview.totals.adsSent }}</p>
              <p class="text-xs text-slate-400">ç™¼é€å»£å‘Š</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-xl p-4 border border-purple-500/30">
              <p class="text-2xl font-bold text-purple-400">{{ overview.totals.usersTracked }}</p>
              <p class="text-xs text-slate-400">è¿½è¹¤ç”¨æˆ¶</p>
            </div>
            <div class="bg-gradient-to-br from-pink-500/20 to-rose-500/20 rounded-xl p-4 border border-pink-500/30">
              <p class="text-2xl font-bold text-pink-400">{{ overview.totals.highValueGroups }}</p>
              <p class="text-xs text-slate-400">é«˜åƒ¹å€¼ç¾¤</p>
            </div>
            <div class="bg-gradient-to-br from-cyan-500/20 to-teal-500/20 rounded-xl p-4 border border-cyan-500/30">
              <p class="text-2xl font-bold text-cyan-400">{{ overview.totals.activeCampaigns }}</p>
              <p class="text-xs text-slate-400">æ´»èºæ´»å‹•</p>
            </div>
          </div>
        }
        
        <!-- æ¼æ–—åˆ†æ -->
        @if (funnelAnalysis()) {
          @let funnel = funnelAnalysis();
          <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50 mb-6">
            <h3 class="font-semibold text-white mb-4">ç‡ŸéŠ·æ¼æ–—åˆ†æ</h3>
            <div class="flex items-end gap-1">
              @for (stage of funnel.funnel; track stage.stage; let i = $index) {
                <div class="flex-1 text-center">
                  <div class="h-32 flex flex-col justify-end">
                    <div class="bg-gradient-to-t from-pink-500 to-pink-400 rounded-t-lg transition-all" 
                         [style.height.%]="stage.count > 0 ? Math.max(20, stage.conversionRate) : 10">
                    </div>
                  </div>
                  <p class="text-lg font-bold text-white mt-2">{{ stage.count }}</p>
                  <p class="text-xs text-slate-400">{{ stage.stage }}</p>
                  @if (i > 0) {
                    <p class="text-xs text-slate-500">{{ stage.conversionRate }}%</p>
                  }
                </div>
              }
            </div>
            <p class="text-center text-sm text-slate-400 mt-4">
              æ•´é«”è½‰åŒ–ç‡: <span class="text-pink-400 font-semibold">{{ funnel.overallConversion }}%</span>
            </p>
          </div>
        }
        
        <!-- ç‡ŸéŠ·å¤–å±•çµ±è¨ˆ (Phase 4) -->
        <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50 mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-white flex items-center gap-2">
              <span>ğŸ“Š</span> ç‡ŸéŠ·å¤–å±•çµ±è¨ˆ
            </h3>
            <button (click)="loadMarketingStats()" [disabled]="isLoadingMarketing()" class="px-3 py-1.5 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 text-sm rounded-lg">
              {{ isLoadingMarketing() ? 'â³ åŠ è¼‰ä¸­...' : 'ğŸ”„ åˆ·æ–°' }}
            </button>
          </div>
          <div class="grid grid-cols-6 gap-4">
            <div class="bg-slate-700/50 rounded-lg p-3 text-center">
              <p class="text-xl font-bold text-cyan-400">{{ marketingStats().totalCampaigns }}</p>
              <p class="text-xs text-slate-400">ç¸½æ´»å‹•æ•¸</p>
            </div>
            <div class="bg-slate-700/50 rounded-lg p-3 text-center">
              <p class="text-xl font-bold text-green-400">{{ marketingStats().running }}</p>
              <p class="text-xs text-slate-400">é‹è¡Œä¸­</p>
            </div>
            <div class="bg-slate-700/50 rounded-lg p-3 text-center">
              <p class="text-xl font-bold text-blue-400">{{ marketingStats().completed }}</p>
              <p class="text-xs text-slate-400">å·²å®Œæˆ</p>
            </div>
            <div class="bg-slate-700/50 rounded-lg p-3 text-center">
              <p class="text-xl font-bold text-purple-400">{{ marketingStats().totalMessages }}</p>
              <p class="text-xs text-slate-400">ç¸½ç§ä¿¡</p>
            </div>
            <div class="bg-slate-700/50 rounded-lg p-3 text-center">
              <p class="text-xl font-bold text-orange-400">{{ marketingStats().totalInvites }}</p>
              <p class="text-xs text-slate-400">ç¸½é‚€è«‹</p>
            </div>
            <div class="bg-slate-700/50 rounded-lg p-3 text-center">
              <p class="text-xl font-bold text-yellow-400">{{ (marketingStats().successRate * 100).toFixed(1) }}%</p>
              <p class="text-xs text-slate-400">æˆåŠŸç‡</p>
            </div>
          </div>
        </div>
        
        <!-- æ´»å‹•åˆ—è¡¨ -->
        <div class="space-y-4">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold text-white">ç‡ŸéŠ·æ´»å‹•</h3>
            <button (click)="showCampaignForm.set(true)" 
                    [disabled]="!membershipService.hasFeature('aiSalesFunnel')"
                    [class.opacity-50]="!membershipService.hasFeature('aiSalesFunnel')"
                    [class.cursor-not-allowed]="!membershipService.hasFeature('aiSalesFunnel')"
                    [title]="!membershipService.hasFeature('aiSalesFunnel') ? 'éœ€è¦ é‘½çŸ³ç‹ç‰Œ æˆ–ä»¥ä¸Šæœƒå“¡' : ''"
                    class="px-4 py-2 bg-pink-500/20 text-pink-400 rounded-lg hover:bg-pink-500/30 disabled:hover:bg-pink-500/20 transition-colors flex items-center gap-2">
              <span>+</span> å‰µå»ºæ´»å‹•
              @if (!membershipService.hasFeature('aiSalesFunnel')) {
                <span class="text-xs opacity-60">ğŸ’</span>
              }
            </button>
          </div>
          
          <!-- å‰µå»ºæ´»å‹•è¡¨å–® -->
          @if (showCampaignForm()) {
            <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
              <h4 class="text-lg font-semibold text-white mb-4">å‰µå»ºç‡ŸéŠ·æ´»å‹•</h4>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-slate-400 mb-1">æ´»å‹•åç¨± *</label>
                  <input type="text" 
                         [value]="campaignFormData().name"
                         (input)="updateCampaignFormName($any($event.target).value)"
                         class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-pink-500/50"
                         placeholder="ä¾‹å¦‚ï¼šQ1 ç²å®¢æ´»å‹•">
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">æ´»å‹•æè¿°</label>
                  <input type="text" 
                         [value]="campaignFormData().description"
                         (input)="updateCampaignFormDesc($any($event.target).value)"
                         class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none"
                         placeholder="å¯é¸">
                </div>
                <div class="col-span-2">
                  <label class="block text-sm text-slate-400 mb-2">æ´»å‹•éšæ®µ</label>
                  <div class="flex gap-2 flex-wrap">
                    @for (phase of ['discovery', 'monitoring', 'outreach', 'tracking', 'conversion']; track phase) {
                      <button (click)="toggleCampaignPhase(phase)"
                              class="px-3 py-1.5 rounded-lg text-sm transition-colors"
                              [class]="campaignFormData().phases.includes(phase) ? 'bg-pink-500/30 text-pink-300 border border-pink-500/50' : 'bg-slate-600/50 text-slate-400 border border-slate-600'">
                        {{ getPhaseLabel(phase) }}
                      </button>
                    }
                  </div>
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">é—œéµè©</label>
                  <div class="flex gap-2">
                    <input type="text" 
                           [value]="campaignKeywordInput()"
                           (input)="campaignKeywordInput.set($any($event.target).value)"
                           (keyup.enter)="addCampaignKeyword()"
                           class="flex-1 px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none"
                           placeholder="è¼¸å…¥é—œéµè©">
                    <button (click)="addCampaignKeyword()" class="px-3 py-2 bg-slate-600/50 text-slate-300 rounded-lg">+</button>
                  </div>
                  <div class="flex gap-1 flex-wrap mt-2">
                    @for (keyword of campaignFormData().keywords; track keyword) {
                      <span class="px-2 py-0.5 bg-slate-600/50 text-slate-300 rounded text-xs flex items-center gap-1">
                        {{ keyword }}
                        <button (click)="removeCampaignKeyword(keyword)" class="text-slate-500 hover:text-white">&times;</button>
                      </span>
                    }
                  </div>
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">é¸æ“‡å¸³è™Ÿ *</label>
                  <div class="flex flex-wrap gap-2 p-2 bg-slate-700/30 rounded-lg min-h-[42px]">
                    @for (account of accounts(); track account.id) {
                      @if (account.status === 'Online') {
                        <label class="flex items-center gap-1.5 px-2 py-1 bg-slate-600/50 rounded cursor-pointer hover:bg-slate-600 text-xs">
                          <input type="checkbox" 
                                 [checked]="campaignFormData().assignedAccounts.includes(account.phone)"
                                 (change)="toggleCampaignAccount(account.phone)"
                                 class="rounded border-slate-500 w-3 h-3">
                          <span class="text-slate-300">{{ account.phone }}</span>
                        </label>
                      }
                    }
                  </div>
                </div>
              </div>
              <div class="flex gap-3 mt-4">
                <button (click)="createCampaignFromForm()" 
                        class="px-6 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors">
                  å‰µå»ºæ´»å‹•
                </button>
                <button (click)="showCampaignForm.set(false)" 
                        class="px-6 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                  å–æ¶ˆ
                </button>
              </div>
            </div>
          }
          
          <!-- æ´»å‹•åˆ—è¡¨ -->
          @for (campaign of campaigns(); track campaign.id) {
            <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-2">
                    <h4 class="font-semibold text-white text-lg">{{ campaign.name }}</h4>
                    <span class="text-xs px-2 py-0.5 rounded-full" [class]="getCampaignStatusColor(campaign.status)">
                      {{ getCampaignStatusLabel(campaign.status) }}
                    </span>
                  </div>
                  @if (campaign.description) {
                    <p class="text-sm text-slate-400 mb-2">{{ campaign.description }}</p>
                  }
                  <div class="flex gap-2 mb-3">
                    @for (phase of campaign.phases; track phase) {
                      <span class="text-xs px-2 py-0.5 bg-slate-600/50 text-slate-300 rounded">{{ getPhaseLabel(phase) }}</span>
                    }
                  </div>
                  <div class="grid grid-cols-5 gap-4 text-sm">
                    <div>
                      <span class="text-slate-500">ç¾¤çµ„ç™¼ç¾:</span>
                      <span class="text-white ml-1">{{ campaign.stats.groupsDiscovered }}</span>
                    </div>
                    <div>
                      <span class="text-slate-500">æ½›å®¢:</span>
                      <span class="text-emerald-400 ml-1">{{ campaign.stats.leadsGenerated }}</span>
                    </div>
                    <div>
                      <span class="text-slate-500">å»£å‘Š:</span>
                      <span class="text-orange-400 ml-1">{{ campaign.stats.adsSent }}</span>
                    </div>
                    <div>
                      <span class="text-slate-500">è¿½è¹¤:</span>
                      <span class="text-purple-400 ml-1">{{ campaign.stats.usersTracked }}</span>
                    </div>
                    <div>
                      <span class="text-slate-500">æˆäº¤:</span>
                      <span class="text-pink-400 ml-1">{{ campaign.stats.conversions }}</span>
                    </div>
                  </div>
                </div>
                <div class="flex gap-2">
                  @if (campaign.status === 'draft' || campaign.status === 'paused') {
                    <button (click)="startCampaign(campaign.id)" 
                            class="px-3 py-1.5 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30 text-sm">
                      â–¶ å•Ÿå‹•
                    </button>
                  }
                  @if (campaign.status === 'running') {
                    <button (click)="pauseCampaign(campaign.id)" 
                            class="px-3 py-1.5 bg-yellow-500/20 text-yellow-400 rounded-lg hover:bg-yellow-500/30 text-sm">
                      â¸ æš«åœ
                    </button>
                    <button (click)="stopCampaign(campaign.id)" 
                            class="px-3 py-1.5 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 text-sm">
                      â¹ åœæ­¢
                    </button>
                  }
                  @if (campaign.status !== 'running') {
                    <button (click)="deleteCampaign(campaign.id)" 
                            class="p-2 text-red-400 hover:text-red-300">
                      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/></svg>
                    </button>
                  }
                </div>
              </div>
            </div>
          } @empty {
            <div class="text-center py-12 text-slate-500 bg-slate-800/30 rounded-xl">
              <p class="text-4xl mb-2">ğŸ“ˆ</p>
              <p>é‚„æ²’æœ‰ç‡ŸéŠ·æ´»å‹•</p>
              <p class="text-sm">å‰µå»ºä¸€å€‹å…¨æµç¨‹è‡ªå‹•åŒ–ç‡ŸéŠ·æ´»å‹•</p>
            </div>
          }
        </div>
      }
      @case ('multi-role') {
        <!-- å¤šè§’è‰²å”ä½œé é¢ - ä½¿ç”¨æ•´åˆçµ„ä»¶ -->
        <app-multi-role-center class="block h-full -m-4"></app-multi-role-center>
        
        <!-- èˆŠç‰ˆ UIï¼ˆå·²éš±è—ï¼Œä¿ç•™ä½œç‚ºå‚™ä»½ï¼‰-->
        <div class="hidden">
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ­</span> å¤šè§’è‰²å”ä½œç³»çµ±
        </h2>
        
        <!-- Tab å°èˆª -->
        <div class="flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-lg w-fit">
          <button (click)="multiRoleTab.set('roles')" 
                  [class]="multiRoleTab() === 'roles' ? 'bg-indigo-500/30 text-indigo-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ‘¤</span> è§’è‰²é…ç½®
          </button>
          <button (click)="multiRoleTab.set('scripts')" 
                  [class]="multiRoleTab() === 'scripts' ? 'bg-indigo-500/30 text-indigo-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“œ</span> åŠ‡æœ¬æ¨¡æ¿
          </button>
          <button (click)="multiRoleTab.set('collab')" 
                  [class]="multiRoleTab() === 'collab' ? 'bg-indigo-500/30 text-indigo-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ‘¥</span> å”ä½œç¾¤çµ„
          </button>
          <button (click)="multiRoleTab.set('stats')" 
                  [class]="multiRoleTab() === 'stats' ? 'bg-indigo-500/30 text-indigo-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“Š</span> çµ±è¨ˆåˆ†æ
          </button>
        </div>
        
        <!-- è§’è‰²é…ç½® Tab -->
        @if (multiRoleTab() === 'roles') {
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-slate-400">å…± {{ allRoles().length }} å€‹è§’è‰²åˆ†é…</span>
              <button (click)="showRoleAssignForm.set(true)" 
                      class="px-4 py-2 bg-indigo-500/20 text-indigo-400 rounded-lg hover:bg-indigo-500/30 transition-colors flex items-center gap-2">
                <span>+</span> åˆ†é…è§’è‰²
              </button>
            </div>
            
            <!-- åˆ†é…è§’è‰²è¡¨å–® -->
            @if (showRoleAssignForm()) {
              <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                <h3 class="text-lg font-semibold text-white mb-4">åˆ†é…è§’è‰²çµ¦å¸³è™Ÿ</h3>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">é¸æ“‡å¸³è™Ÿ *</label>
                    <select [value]="newRoleAssign().accountPhone"
                            (change)="updateRoleAssignPhone($any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white">
                      <option value="">é¸æ“‡å¸³è™Ÿ</option>
                      @for (account of accounts(); track account.id) {
                        @if (account.status === 'Online') {
                          <option [value]="account.phone">{{ account.phone }}</option>
                        }
                      }
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">è§’è‰²é¡å‹ *</label>
                    <select [value]="newRoleAssign().roleType"
                            (change)="updateRoleAssignType($any($event.target).value)"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white">
                      <option value="seller">ğŸ§‘â€ğŸ’¼ éŠ·å”®é¡§å•</option>
                      <option value="expert">ğŸ‘¨â€ğŸ”¬ å°ˆæ¥­é¡§å•</option>
                      <option value="satisfied">ğŸ˜Š æ»¿æ„å®¢æˆ¶</option>
                      <option value="hesitant">ğŸ¤” çŒ¶è±«å®¢æˆ¶</option>
                      <option value="converted">ğŸ‰ æˆäº¤å®¢æˆ¶</option>
                      <option value="curious">â“ å¥½å¥‡è€…</option>
                      <option value="manager">ğŸ‘” ç¶“ç†ä¸»ç®¡</option>
                      <option value="support">ğŸ› ï¸ å”®å¾Œå®¢æœ</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">è§’è‰²åç¨± *</label>
                    <input type="text" 
                           [value]="newRoleAssign().roleName"
                           (input)="updateRoleAssignName($any($event.target).value)"
                           class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg text-white focus:outline-none"
                           placeholder="ä¾‹å¦‚ï¼šå°æ˜">
                  </div>
                </div>
                <div class="flex gap-3 mt-4">
                  <button (click)="assignRole()" 
                          class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors">
                    åˆ†é…è§’è‰²
                  </button>
                  <button (click)="showRoleAssignForm.set(false)" 
                          class="px-6 py-2 bg-slate-600/50 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors">
                    å–æ¶ˆ
                  </button>
                </div>
              </div>
            }
            
            <!-- è§’è‰²é¡å‹ç¸½è¦½ -->
            <div class="grid grid-cols-4 gap-4">
              @for (roleType of ['seller', 'expert', 'satisfied', 'hesitant', 'converted', 'curious', 'manager', 'support']; track roleType) {
                @let rolesOfType = getRolesOfType(roleType);
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">{{ getRoleIcon(roleType) }}</span>
                    <div>
                      <p class="font-semibold text-white">{{ getRoleLabel(roleType) }}</p>
                      <p class="text-xs text-slate-400">{{ rolesOfType.length }} å€‹å¸³è™Ÿ</p>
                    </div>
                  </div>
                  <div class="space-y-1">
                    @for (role of rolesOfType; track role.id) {
                      <div class="flex justify-between items-center text-sm bg-slate-700/30 px-2 py-1 rounded">
                        <span class="text-slate-300">{{ role.roleName }}</span>
                        <button (click)="removeRole(role.id)" class="text-red-400 hover:text-red-300 text-xs">âœ•</button>
                      </div>
                    } @empty {
                      <p class="text-xs text-slate-500">æš«ç„¡å¸³è™Ÿ</p>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- åŠ‡æœ¬æ¨¡æ¿ Tab -->
        @if (multiRoleTab() === 'scripts') {
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-slate-400">å…± {{ scriptTemplates().length }} å€‹åŠ‡æœ¬æ¨¡æ¿</span>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              @for (template of scriptTemplates(); track template.id) {
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <div class="flex justify-between items-start mb-3">
                    <div>
                      <h4 class="font-semibold text-white text-lg">{{ template.name }}</h4>
                      <p class="text-sm text-slate-400">{{ template.description }}</p>
                    </div>
                    <span class="text-xs px-2 py-1 bg-indigo-500/20 text-indigo-400 rounded">
                      {{ getScenarioLabel(template.scenario) }}
                    </span>
                  </div>
                  <div class="space-y-2 text-sm">
                    <div class="flex gap-2">
                      <span class="text-slate-500">éœ€è¦è§’è‰²:</span>
                      <div class="flex gap-1 flex-wrap">
                        @for (role of template.requiredRoles.slice(0, 4); track role) {
                          <span class="px-1.5 py-0.5 bg-slate-600/50 text-slate-300 rounded text-xs">
                            {{ getRoleIcon(role) }} {{ getRoleLabel(role) }}
                          </span>
                        }
                        @if (template.requiredRoles.length > 4) {
                          <span class="text-slate-500">+{{ template.requiredRoles.length - 4 }}</span>
                        }
                      </div>
                    </div>
                    <div class="flex gap-4">
                      <span class="text-slate-500">éšæ®µ: <span class="text-white">{{ template.stages.length }}</span></span>
                      <span class="text-slate-500">æ™‚é•·: <span class="text-white">{{ template.durationMinutes }}åˆ†é˜</span></span>
                      <span class="text-slate-500">ä½¿ç”¨: <span class="text-cyan-400">{{ template.useCount }}æ¬¡</span></span>
                    </div>
                  </div>
                </div>
              } @empty {
                <div class="col-span-2 text-center py-12 text-slate-500 bg-slate-800/30 rounded-xl">
                  <p class="text-4xl mb-2">ğŸ“œ</p>
                  <p>æš«ç„¡åŠ‡æœ¬æ¨¡æ¿</p>
                </div>
              }
            </div>
          </div>
        }
        
        <!-- å”ä½œç¾¤çµ„ Tab -->
        @if (multiRoleTab() === 'collab') {
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-slate-400">å…± {{ collabGroups().length }} å€‹å”ä½œç¾¤çµ„</span>
            </div>
            
            @for (group of collabGroups(); track group.id) {
              <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                <div class="flex justify-between items-start">
                  <div>
                    <div class="flex items-center gap-3 mb-2">
                      <h4 class="font-semibold text-white">{{ group.groupTitle }}</h4>
                      <span class="text-xs px-2 py-0.5 rounded" [class]="getCollabStatusColor(group.status)">
                        {{ getCollabStatusLabel(group.status) }}
                      </span>
                    </div>
                    <div class="text-sm space-y-1">
                      @if (group.targetUsername) {
                        <p class="text-slate-400">ç›®æ¨™ç”¨æˆ¶: <span class="text-cyan-400">&#64;{{ group.targetUsername }}</span></p>
                      }
                      <p class="text-slate-500">æˆå“¡æ•¸: {{ group.memberCount }} | å‰µå»ºæ–¼: {{ group.createdAt | date:'MM/dd HH:mm' }}</p>
                    </div>
                  </div>
                  @if (group.outcome) {
                    <span class="text-xs px-2 py-1 rounded"
                          [class]="group.outcome === 'converted' ? 'bg-green-500/20 text-green-400' : 'bg-slate-500/20 text-slate-400'">
                      {{ group.outcome === 'converted' ? 'å·²æˆäº¤' : group.outcome }}
                    </span>
                  }
                </div>
              </div>
            } @empty {
              <div class="text-center py-12 text-slate-500 bg-slate-800/30 rounded-xl">
                <p class="text-4xl mb-2">ğŸ‘¥</p>
                <p>æš«ç„¡å”ä½œç¾¤çµ„</p>
              </div>
            }
          </div>
        }
        
        <!-- çµ±è¨ˆåˆ†æ Tab -->
        @if (multiRoleTab() === 'stats') {
          <div class="space-y-6">
            @if (collabStats() && roleStats()) {
              <!-- ç¸½è¦½å¡ç‰‡ -->
              <div class="grid grid-cols-4 gap-4">
                <div class="bg-gradient-to-br from-indigo-500/20 to-purple-500/20 rounded-xl p-5 border border-indigo-500/30">
                  <p class="text-3xl font-bold text-white">{{ roleStats().total }}</p>
                  <p class="text-sm text-slate-400">å·²åˆ†é…è§’è‰²</p>
                </div>
                <div class="bg-gradient-to-br from-cyan-500/20 to-blue-500/20 rounded-xl p-5 border border-cyan-500/30">
                  <p class="text-3xl font-bold text-cyan-400">{{ roleStats().accountsWithRoles }}</p>
                  <p class="text-sm text-slate-400">æœ‰è§’è‰²å¸³è™Ÿ</p>
                </div>
                <div class="bg-gradient-to-br from-emerald-500/20 to-green-500/20 rounded-xl p-5 border border-emerald-500/30">
                  <p class="text-3xl font-bold text-emerald-400">{{ collabStats().activeGroups }}</p>
                  <p class="text-sm text-slate-400">æ´»èºå”ä½œç¾¤çµ„</p>
                </div>
                <div class="bg-gradient-to-br from-pink-500/20 to-rose-500/20 rounded-xl p-5 border border-pink-500/30">
                  <p class="text-3xl font-bold text-pink-400">{{ collabStats().conversionRate }}%</p>
                  <p class="text-sm text-slate-400">å”ä½œè½‰åŒ–ç‡</p>
                </div>
              </div>
              
              <!-- è©³ç´°çµ±è¨ˆ -->
              <div class="grid grid-cols-2 gap-6">
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <h4 class="font-semibold text-white mb-4">è§’è‰²åˆ†ä½ˆ</h4>
                  <div class="space-y-2">
                    @for (roleType of ['seller', 'expert', 'satisfied', 'hesitant', 'converted', 'curious', 'manager', 'support']; track roleType) {
                      @let count = roleStats().byType[roleType] || 0;
                      <div class="flex justify-between items-center">
                        <span class="text-slate-400">{{ getRoleIcon(roleType) }} {{ getRoleLabel(roleType) }}</span>
                        <span class="px-2 py-0.5 bg-indigo-500/20 text-indigo-400 rounded text-sm">{{ count }}</span>
                      </div>
                    }
                  </div>
                </div>
                
                <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50">
                  <h4 class="font-semibold text-white mb-4">å”ä½œçµ±è¨ˆ</h4>
                  <div class="space-y-3">
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">ç¸½å”ä½œç¾¤çµ„</span>
                      <span class="text-white">{{ collabStats().total }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">ç¸½æ¶ˆæ¯æ•¸</span>
                      <span class="text-cyan-400">{{ collabStats().totalMessages }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">ç›®æ¨™ç”¨æˆ¶å›è¦†</span>
                      <span class="text-emerald-400">{{ collabStats().targetResponses }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-slate-400">å·²å®Œæˆ</span>
                      <span class="text-purple-400">{{ collabStats().byStatus?.completed || 0 }}</span>
                    </div>
                  </div>
                </div>
              </div>
            } @else {
              <div class="text-center py-12 text-slate-500">
                <p class="text-4xl mb-2">ğŸ“Š</p>
                <p>æ­£åœ¨åŠ è¼‰çµ±è¨ˆæ•¸æ“š...</p>
              </div>
            }
          </div>
        }
        </div> <!-- é—œé–‰éš±è—çš„èˆŠç‰ˆå¤šè§’è‰² UI -->
      }
      @case ('ai-center') {
        <!-- AI ä¸­å¿ƒé é¢ - ä½¿ç”¨æ•´åˆçµ„ä»¶ -->
        <app-ai-center class="block h-full -m-4"></app-ai-center>
        
        <!-- èˆŠç‰ˆ UIï¼ˆå·²éš±è—ï¼Œä¿ç•™ä½œç‚ºå‚™ä»½ï¼‰-->
        <div class="hidden">
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ§ </span> {{ t('aiCenter') }}
        </h2>
        
        <!-- Tab å°èˆª -->
        <div class="flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-lg w-fit">
          <button (click)="aiCenterTab.set('config')" 
                  [class]="aiCenterTab() === 'config' ? 'bg-purple-500/30 text-purple-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>âš™ï¸</span> {{ t('aiConfiguration') }}
          </button>
          <button (click)="aiCenterTab.set('chat')" 
                  [class]="aiCenterTab() === 'chat' ? 'bg-purple-500/30 text-purple-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ’¬</span> {{ t('aiAutoChat') }}
          </button>
          <button (click)="aiCenterTab.set('rag')" 
                  [class]="aiCenterTab() === 'rag' ? 'bg-purple-500/30 text-purple-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“š</span> {{ t('ragKnowledge') }}
          </button>
          <button (click)="aiCenterTab.set('voice')" 
                  [class]="aiCenterTab() === 'voice' ? 'bg-purple-500/30 text-purple-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ™ï¸</span> {{ t('voiceService') }}
          </button>
          <button (click)="aiCenterTab.set('memory')" 
                  [class]="aiCenterTab() === 'memory' ? 'bg-purple-500/30 text-purple-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ§ </span> å‘é‡è¨˜æ†¶
          </button>
        </div>
        
        <!-- Tab å…§å®¹ -->
        @switch (aiCenterTab()) {
          @case ('config') {
            <!-- AI é…ç½® Tab - å°‡å¾è¨­ç½®é é¢ç§»å‹•éä¾†çš„å…§å®¹ -->
            <div class="space-y-6">
              <!-- AI API Configuration -->
              <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl mb-4 font-semibold flex items-center gap-2">
                  <span class="text-2xl">âœ¨</span> {{ t('aiConfiguration') }}
                </h3>
                <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">{{ t('aiConfigurationHint') }}</p>
                
                <div class="space-y-4">
                  <!-- API Type Selection -->
                  <div>
                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">{{ t('aiProvider') }}</label>
                    <div class="flex flex-wrap gap-4">
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="aiTypeCenter" [checked]="aiApiType() === 'gemini'" (change)="aiApiType.set('gemini')" class="form-radio text-cyan-500">
                        <span class="text-sm">Google Gemini</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="aiTypeCenter" [checked]="aiApiType() === 'openai'" (change)="aiApiType.set('openai')" class="form-radio text-cyan-500">
                        <span class="text-sm">OpenAI</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="aiTypeCenter" [checked]="aiApiType() === 'custom'" (change)="aiApiType.set('custom')" class="form-radio text-cyan-500">
                        <span class="text-sm">{{ t('customApi') }}</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="aiTypeCenter" [checked]="aiApiType() === 'local'" (change)="aiApiType.set('local')" class="form-radio text-purple-500">
                        <span class="text-sm bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent font-semibold">ğŸ  {{ t('localAi') }}</span>
                      </label>
                    </div>
                  </div>
                  
                  <!-- API Key (éæœ¬åœ° AI) -->
                  @if(aiApiType() !== 'local') {
                    <div>
                      <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">API Key</label>
                      <div class="relative">
                        <input [type]="showApiKey() ? 'text' : 'password'" [ngModel]="aiApiKey()" (ngModelChange)="aiApiKey.set($event)"
                               class="form-input w-full bg-slate-800/50 border-slate-700 rounded-lg py-2 px-3 pr-12 text-white focus:ring-2 focus:ring-cyan-500 font-mono text-sm"
                               [placeholder]="aiApiType() === 'gemini' ? 'AIza...' : 'sk-...'">
                        <button type="button" (click)="showApiKey.set(!showApiKey())" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white">
                          {{ showApiKey() ? 'ğŸ‘ï¸' : 'ğŸ™ˆ' }}
                        </button>
                      </div>
                    </div>
                  }
                  
                  <!-- æœ¬åœ° AI é…ç½® -->
                  @if(aiApiType() === 'local') {
                    <div class="space-y-4 p-4 bg-gradient-to-r from-purple-500/10 to-pink-500/10 rounded-lg border border-purple-500/20">
                      <h4 class="text-sm font-semibold text-purple-400 flex items-center gap-2">
                        <span>ğŸ </span> æœ¬åœ° AI é…ç½®
                      </h4>
                      
                      <!-- æœ¬åœ° AI æä¾›è€…é¸æ“‡ -->
                      <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æœå‹™æä¾›è€…</label>
                        <div class="flex flex-wrap gap-3">
                          <button (click)="setLocalAiPresets('ollama')" 
                                  [class]="localAiProvider() === 'ollama' ? 'bg-purple-500 text-white' : 'bg-slate-700 text-slate-300'"
                                  class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            <span>ğŸ¦™</span> Ollama
                          </button>
                          <button (click)="setLocalAiPresets('lmstudio')"
                                  [class]="localAiProvider() === 'lmstudio' ? 'bg-purple-500 text-white' : 'bg-slate-700 text-slate-300'"
                                  class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            <span>ğŸ“¦</span> LM Studio
                          </button>
                          <button (click)="setLocalAiPresets('custom')"
                                  [class]="localAiProvider() === 'custom' ? 'bg-purple-500 text-white' : 'bg-slate-700 text-slate-300'"
                                  class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            <span>âš™ï¸</span> è‡ªå®šç¾©
                          </button>
                        </div>
                      </div>
                      
                      <!-- æœå‹™åœ°å€ -->
                      <div>
                        <label class="block text-sm font-medium text-slate-400 mb-1">æœå‹™åœ°å€</label>
                        <input [ngModel]="localAiEndpoint()" (ngModelChange)="localAiEndpoint.set($event)"
                               class="form-input w-full bg-slate-800/50 border-slate-700 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-purple-500 font-mono text-sm"
                               [placeholder]="localAiProvider() === 'ollama' ? 'http://localhost:11434' : 'http://localhost:1234'">
                        <p class="text-xs text-slate-500 mt-1">
                          {{ localAiProvider() === 'ollama' ? 'Ollama é»˜èªç«¯å£ 11434' : 
                             localAiProvider() === 'lmstudio' ? 'LM Studio é»˜èªç«¯å£ 1234' : 'è¼¸å…¥è‡ªå®šç¾©æœå‹™åœ°å€' }}
                        </p>
                      </div>
                      
                      <!-- æ¨¡å‹é¸æ“‡ -->
                      <div>
                        <label class="block text-sm font-medium text-slate-400 mb-1">æ¨¡å‹</label>
                        <div class="flex gap-2">
                          @if(localAiProvider() === 'ollama' && availableOllamaModels().length > 0) {
                            <select [ngModel]="localAiModel()" (ngModelChange)="localAiModel.set($event)"
                                    class="flex-1 bg-slate-800/50 border-slate-700 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-purple-500">
                              @for(model of availableOllamaModels(); track model) {
                                <option [value]="model">{{ model }}</option>
                              }
                            </select>
                            <button (click)="refreshOllamaModels()" 
                                    class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg transition-colors"
                                    title="åˆ·æ–°æ¨¡å‹åˆ—è¡¨">
                              ğŸ”„
                            </button>
                          } @else {
                            <input [ngModel]="localAiModel()" (ngModelChange)="localAiModel.set($event)"
                                   class="flex-1 bg-slate-800/50 border-slate-700 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-purple-500 font-mono text-sm"
                                   [placeholder]="localAiProvider() === 'ollama' ? 'qwen2:7b' : 'gpt-3.5-turbo'">
                            @if(localAiProvider() === 'ollama') {
                              <button (click)="refreshOllamaModels()" 
                                      class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg transition-colors"
                                      title="ç²å–æ¨¡å‹åˆ—è¡¨">
                                ğŸ”
                              </button>
                            }
                          }
                        </div>
                        <p class="text-xs text-slate-500 mt-1">
                          æ¨è–¦æ¨¡å‹ï¼šqwen2:7bï¼ˆä¸­è‹±æ–‡ï¼‰ã€llama3:8bï¼ˆè‹±æ–‡ï¼‰ã€mistral:7bï¼ˆå¿«é€Ÿï¼‰
                        </p>
                      </div>
                      
                      <!-- è‡ªå‹•é™ç´šè¨­ç½® -->
                      <div class="p-3 bg-slate-800/50 rounded-lg">
                        <label class="flex items-center gap-3 cursor-pointer">
                          <input type="checkbox" [checked]="aiAutoFallback()" (change)="aiAutoFallback.set(!aiAutoFallback())"
                                 class="w-4 h-4 text-purple-500 bg-slate-700 border-slate-600 rounded focus:ring-purple-500">
                          <div>
                            <span class="text-sm text-slate-300">è‡ªå‹•é™ç´šåˆ°é›²ç«¯æœå‹™</span>
                            <p class="text-xs text-slate-500">æœ¬åœ° AI ä¸å¯ç”¨æ™‚è‡ªå‹•åˆ‡æ›åˆ°å‚™ç”¨é›²ç«¯æœå‹™</p>
                          </div>
                        </label>
                        @if(aiAutoFallback()) {
                          <div class="mt-3 ml-7">
                            <label class="block text-xs text-slate-400 mb-1">å‚™ç”¨æœå‹™</label>
                            <select [ngModel]="aiBackupProvider()" (ngModelChange)="aiBackupProvider.set($event)"
                                    class="bg-slate-700 border-slate-600 rounded py-1 px-2 text-sm text-white">
                              <option value="gemini">Google Gemini</option>
                              <option value="openai">OpenAI</option>
                            </select>
                          </div>
                        }
                      </div>
                      
                      <!-- æ¸¬è©¦é€£æ¥ -->
                      <div class="flex items-center gap-3">
                        <button (click)="testLocalAiConnection()" [disabled]="!localAiEndpoint() || isTestingLocalAi()"
                                class="bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-lg transition-colors disabled:opacity-50">
                          {{ isTestingLocalAi() ? 'â³ æ¸¬è©¦ä¸­...' : 'âš¡ æ¸¬è©¦é€£æ¥' }}
                        </button>
                        @if(localAiStatus()) {
                          <span [class]="localAiStatus() === 'success' ? 'text-green-400' : 'text-red-400'">
                            {{ localAiStatus() === 'success' ? 'âœ… é€£æ¥æˆåŠŸ' : 'âŒ ' + localAiError() }}
                          </span>
                        }
                      </div>
                    </div>
                  }
                  
                  <!-- ä¿å­˜æŒ‰éˆ• -->
                  <div class="flex gap-3 pt-4">
                    <button (click)="saveAiSettings()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-2 px-6 rounded-lg transition-all shadow-lg">
                      âœ“ {{ t('saveSettings') }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          }
          @case ('chat') {
            <!-- AI è‡ªå‹•èŠå¤© Tab -->
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
              <h3 class="text-xl mb-4 font-semibold flex items-center gap-2">
                <span class="text-2xl">ğŸ’¬</span> {{ t('aiAutoChat') }}
              </h3>
              
              <!-- å•Ÿç”¨é–‹é—œ -->
              <div class="flex items-center justify-between p-4 bg-slate-800/30 rounded-lg mb-4">
                <div>
                  <h4 class="text-sm font-medium text-white">{{ t('enableAiAutoChat') }}</h4>
                  <p class="text-xs text-slate-400">{{ t('aiAutoChatHint') }}</p>
                </div>
                <input type="checkbox" [checked]="aiAutoChatEnabled()" (change)="aiAutoChatEnabled.set(!aiAutoChatEnabled())" class="form-checkbox text-cyan-500 rounded h-5 w-5">
              </div>
              
              <!-- æ¨¡å¼é¸æ“‡ -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-400 mb-2">{{ t('chatMode') }}</label>
                <div class="grid grid-cols-4 gap-2">
                  <button (click)="aiAutoChatMode.set('full')" [class]="aiAutoChatMode() === 'full' ? 'bg-cyan-500/30 border-cyan-500' : 'bg-slate-800/50 border-slate-700'"
                          class="p-3 rounded-lg border text-center transition-all">
                    <div class="text-lg mb-1">ğŸ¤–</div>
                    <div class="text-xs">å…¨è‡ªå‹•</div>
                  </button>
                  <button (click)="aiAutoChatMode.set('semi')" [class]="aiAutoChatMode() === 'semi' ? 'bg-cyan-500/30 border-cyan-500' : 'bg-slate-800/50 border-slate-700'"
                          class="p-3 rounded-lg border text-center transition-all">
                    <div class="text-lg mb-1">ğŸ¯</div>
                    <div class="text-xs">åŠè‡ªå‹•</div>
                  </button>
                  <button (click)="aiAutoChatMode.set('assist')" [class]="aiAutoChatMode() === 'assist' ? 'bg-cyan-500/30 border-cyan-500' : 'bg-slate-800/50 border-slate-700'"
                          class="p-3 rounded-lg border text-center transition-all">
                    <div class="text-lg mb-1">ğŸ’¡</div>
                    <div class="text-xs">è¼”åŠ©</div>
                  </button>
                  <button (click)="aiAutoChatMode.set('keyword')" [class]="aiAutoChatMode() === 'keyword' ? 'bg-cyan-500/30 border-cyan-500' : 'bg-slate-800/50 border-slate-700'"
                          class="p-3 rounded-lg border text-center transition-all">
                    <div class="text-lg mb-1">ğŸ”‘</div>
                    <div class="text-xs">é—œéµè©</div>
                  </button>
                </div>
              </div>
              
              <!-- ç³»çµ±æç¤ºè© -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-400 mb-2">{{ t('systemPrompt') }}</label>
                <textarea [ngModel]="aiSystemPrompt()" (ngModelChange)="aiSystemPrompt.set($event)" rows="4"
                          class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-cyan-500"
                          placeholder="ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å®¢æœåŠ©æ‰‹..."></textarea>
              </div>
              
              <!-- å›è¦†å»¶é² -->
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-400 mb-2">æœ€å°å»¶é²ï¼ˆç§’ï¼‰</label>
                  <input type="number" [ngModel]="aiReplyDelay()[0]" (ngModelChange)="aiReplyDelay.set([$event, aiReplyDelay()[1]])"
                         class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white" min="1" max="60">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-400 mb-2">æœ€å¤§å»¶é²ï¼ˆç§’ï¼‰</label>
                  <input type="number" [ngModel]="aiReplyDelay()[1]" (ngModelChange)="aiReplyDelay.set([aiReplyDelay()[0], $event])"
                         class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white" min="1" max="120">
                </div>
              </div>
            </div>
          }
          @case ('rag') {
            <!-- RAG çŸ¥è­˜åº« Tab -->
            <div class="space-y-6">
              <!-- RAG çµ±è¨ˆå¡ç‰‡ -->
              <div class="grid grid-cols-5 gap-4">
                <div class="bg-slate-900/50 border border-cyan-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">ğŸ’¡</div>
                  <div class="text-xl font-bold text-cyan-400">{{ ragStats().total_knowledge }}</div>
                  <div class="text-xs text-slate-400">ç¸½çŸ¥è­˜æ•¸</div>
                </div>
                <div class="bg-slate-900/50 border border-purple-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">â“</div>
                  <div class="text-xl font-bold text-purple-400">{{ ragStats().qa_count }}</div>
                  <div class="text-xs text-slate-400">å•ç­”å°</div>
                </div>
                <div class="bg-slate-900/50 border border-emerald-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">ğŸ“</div>
                  <div class="text-xl font-bold text-emerald-400">{{ ragStats().scripts_count }}</div>
                  <div class="text-xs text-slate-400">è©±è¡“</div>
                </div>
                <div class="bg-slate-900/50 border border-yellow-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">ğŸ“Š</div>
                  <div class="text-xl font-bold text-yellow-400">{{ (ragStats().avg_score * 100).toFixed(0) }}%</div>
                  <div class="text-xs text-slate-400">å¹³å‡è©•åˆ†</div>
                </div>
                <div class="bg-slate-900/50 border border-pink-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">ğŸ”¥</div>
                  <div class="text-xl font-bold text-pink-400">{{ ragStats().total_uses }}</div>
                  <div class="text-xs text-slate-400">ç¸½ä½¿ç”¨æ¬¡æ•¸</div>
                </div>
              </div>
              
              <!-- ç³»çµ±ç‹€æ…‹å’Œæ“ä½œ -->
              <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-3">
                    <span class="px-3 py-1 rounded-lg text-sm" [class]="ragSystemInitialized() ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'">
                      {{ ragSystemInitialized() ? 'ğŸŸ¢ RAG ç³»çµ±åœ¨ç·š' : 'ğŸ”´ æœªåˆå§‹åŒ–' }}
                    </span>
                    @if(ragStats().chromadb_enabled) {
                      <span class="px-2 py-1 bg-cyan-500/20 text-cyan-400 text-xs rounded">ğŸ—„ï¸ ChromaDB</span>
                    }
                    @if(ragStats().neural_embedding) {
                      <span class="px-2 py-1 bg-purple-500/20 text-purple-400 text-xs rounded">ğŸ§  ç¥ç¶“åµŒå…¥</span>
                    }
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-slate-400">{{ t('ragEnabled') }}</span>
                    <input type="checkbox" [checked]="ragEnabled()" (change)="ragEnabled.set(!ragEnabled())" class="form-checkbox text-cyan-500 rounded">
                  </div>
                </div>
                
                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="flex flex-wrap items-center gap-2 mb-4">
                  <button (click)="initRagSystem()" [disabled]="isInitializingRag()" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg text-sm">
                    {{ isInitializingRag() ? 'â³ åˆå§‹åŒ–ä¸­...' : 'ğŸš€ åˆå§‹åŒ– RAG' }}
                  </button>
                  <button (click)="triggerRagLearning()" [disabled]="isRagLearning()" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg text-sm">
                    {{ isRagLearning() ? 'â³ å­¸ç¿’ä¸­...' : 'ğŸ“ è§¸ç™¼å­¸ç¿’' }}
                  </button>
                  <button (click)="reindexConversations()" [disabled]="isReindexing()" class="px-4 py-2 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 rounded-lg text-sm">
                    {{ isReindexing() ? 'â³ é‡å»ºä¸­...' : 'ğŸ”„ é‡å»ºç´¢å¼•' }}
                  </button>
                  <button (click)="cleanupRagKnowledge()" [disabled]="isCleaningRag()" class="px-4 py-2 bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 rounded-lg text-sm">
                    {{ isCleaningRag() ? 'â³ æ¸…ç†ä¸­...' : 'ğŸ§¹ æ¸…ç†çŸ¥è­˜' }}
                  </button>
                  <button (click)="showAddRagKnowledgeDialog.set(true)" class="px-4 py-2 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 rounded-lg text-sm">
                    â• æ‰‹å‹•æ·»åŠ 
                  </button>
                  <button (click)="refreshRagStats()" class="px-4 py-2 bg-slate-600/50 hover:bg-slate-600/70 text-slate-300 rounded-lg text-sm">
                    ğŸ”„ åˆ·æ–°çµ±è¨ˆ
                  </button>
                </div>
                
                <!-- RAG æœç´¢ -->
                <div class="flex gap-2 mb-4">
                  <input type="text" [(ngModel)]="ragSearchQuery" (keyup.enter)="searchRagKnowledge()"
                         placeholder="æœç´¢çŸ¥è­˜åº«..."
                         class="flex-1 bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white">
                  <button (click)="searchRagKnowledge()" [disabled]="isSearchingRag()" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg">
                    {{ isSearchingRag() ? 'ğŸ” æœç´¢ä¸­...' : 'ğŸ” æœç´¢' }}
                  </button>
                </div>
                
                <!-- æœç´¢çµæœ -->
                @if(ragSearchResults().length > 0) {
                  <div class="space-y-2 max-h-64 overflow-y-auto">
                    @for(result of ragSearchResults(); track result.id) {
                      <div class="p-3 bg-slate-800/50 rounded-lg border border-slate-700 hover:border-cyan-500/30 transition-all">
                        <div class="flex justify-between items-start mb-2">
                          <div class="flex items-center gap-2">
                            <span class="text-xs px-2 py-0.5 bg-cyan-500/20 text-cyan-400 rounded">{{ result.type }}</span>
                            <span class="text-xs text-slate-500">ä½¿ç”¨ {{ result.useCount }} æ¬¡</span>
                          </div>
                          <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-500">è©•åˆ†: {{ (result.successScore * 100).toFixed(0) }}%</span>
                            <span class="text-xs text-slate-500">ç›¸ä¼¼åº¦: {{ (result.similarity * 100).toFixed(0) }}%</span>
                          </div>
                        </div>
                        @if(result.question) {
                          <div class="text-sm text-slate-400 mb-1">Q: {{ result.question }}</div>
                        }
                        <div class="text-sm text-white mb-2">{{ result.answer }}</div>
                        <div class="flex gap-2">
                          <button (click)="sendRagFeedback(result.id, true)" class="text-xs px-2 py-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded">
                            ğŸ‘ æœ‰ç”¨
                          </button>
                          <button (click)="sendRagFeedback(result.id, false)" class="text-xs px-2 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded">
                            ğŸ‘ ç„¡ç”¨
                          </button>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
              
              <!-- çŸ¥è­˜é¡å‹åˆ†ä½ˆ -->
              <div class="bg-slate-900/50 border border-slate-500/20 p-4 rounded-xl">
                <h4 class="text-sm font-semibold text-slate-300 mb-3">çŸ¥è­˜é¡å‹åˆ†ä½ˆ</h4>
                <div class="grid grid-cols-3 gap-3">
                  @for(type of ragTypeKeys(); track type) {
                    <div class="p-3 bg-slate-800/50 rounded-lg">
                      <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-white">{{ type }}</span>
                        <span class="text-lg font-bold text-cyan-400">{{ ragStats().by_type[type]?.count || 0 }}</span>
                      </div>
                      <div class="flex justify-between text-xs text-slate-400">
                        <span>è©•åˆ†: {{ ((ragStats().by_type[type]?.avg_score || 0) * 100).toFixed(0) }}%</span>
                        <span>ä½¿ç”¨: {{ ragStats().by_type[type]?.uses || 0 }}</span>
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
          @case ('voice') {
            <!-- èªéŸ³æœå‹™ Tab -->
            <div class="space-y-6">
              <!-- èªéŸ³æœå‹™å­æ¨™ç±¤ -->
              <div class="flex gap-2 bg-slate-800/30 p-1 rounded-lg w-fit">
                <button (click)="voiceCloneTab.set('manage')" 
                        [class]="voiceCloneTab() === 'manage' ? 'bg-purple-500/30 text-purple-300' : 'text-slate-400 hover:text-white'"
                        class="px-3 py-1.5 rounded-md text-sm transition-all">
                  ğŸ™ï¸ è²éŸ³ç®¡ç†
                </button>
                <button (click)="voiceCloneTab.set('upload')" 
                        [class]="voiceCloneTab() === 'upload' ? 'bg-purple-500/30 text-purple-300' : 'text-slate-400 hover:text-white'"
                        class="px-3 py-1.5 rounded-md text-sm transition-all">
                  ğŸ“¤ ä¸Šå‚³æ¨£æœ¬
                </button>
                <button (click)="voiceCloneTab.set('record')" 
                        [class]="voiceCloneTab() === 'record' ? 'bg-purple-500/30 text-purple-300' : 'text-slate-400 hover:text-white'"
                        class="px-3 py-1.5 rounded-md text-sm transition-all">
                  ğŸ¤ éŒ„è£½èªéŸ³
                </button>
              </div>
              
              @switch (voiceCloneTab()) {
                @case ('manage') {
                  <!-- è²éŸ³ç®¡ç† -->
                  <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
                      <span>ğŸ™ï¸</span> {{ t('clonedVoices') }}
                    </h3>
                    @if(clonedVoices().length === 0) {
                      <div class="text-center py-8 text-slate-400">
                        <div class="text-4xl mb-3">ğŸ¤</div>
                        <p>{{ t('noClonedVoices') }}</p>
                        <div class="mt-4 flex gap-3 justify-center">
                          <button (click)="voiceCloneTab.set('upload')" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg">
                            ğŸ“¤ ä¸Šå‚³æ¨£æœ¬
                          </button>
                          <button (click)="voiceCloneTab.set('record')" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg">
                            ğŸ¤ éŒ„è£½èªéŸ³
                          </button>
                        </div>
                      </div>
                    } @else {
                      <div class="grid grid-cols-2 gap-4">
                        @for(voice of clonedVoices(); track voice.id) {
                          <div class="p-4 rounded-lg border transition-all"
                               [class]="selectedClonedVoice() === voice.id ? 'bg-purple-500/20 border-purple-500' : 'bg-slate-800/50 border-slate-700 hover:border-slate-600'">
                            <div class="flex items-center justify-between mb-2">
                              <span class="font-medium text-white">{{ voice.name }}</span>
                              <span class="text-xs text-slate-500">{{ voice.createdAt | date:'yyyy-MM-dd' }}</span>
                            </div>
                            @if(voice.promptText) {
                              <p class="text-xs text-slate-400 mb-3 truncate">{{ voice.promptText }}</p>
                            }
                            <div class="flex gap-2">
                              <button (click)="previewClonedVoice(voice.id)" class="px-3 py-1.5 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 text-xs rounded-lg">
                                {{ t('previewVoice') }}
                              </button>
                              <button (click)="selectClonedVoice(voice.id)" class="px-3 py-1.5 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 text-xs rounded-lg">
                                {{ t('useThisVoice') }}
                              </button>
                              <button (click)="deleteClonedVoice(voice.id)" class="px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 text-red-400 text-xs rounded-lg">
                                {{ t('deleteVoice') }}
                              </button>
                            </div>
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
                @case ('upload') {
                  <!-- ä¸Šå‚³èªéŸ³æ¨£æœ¬ -->
                  <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
                      <span>ğŸ“¤</span> {{ t('uploadVoiceSample') }}
                    </h3>
                    <p class="text-sm text-slate-400 mb-4">{{ t('voiceCloneHint') }}</p>
                    <label class="flex flex-col items-center justify-center p-8 border-2 border-dashed border-purple-500/30 rounded-xl cursor-pointer hover:border-purple-500/50 hover:bg-purple-500/5 transition-colors">
                      <input type="file" class="hidden" accept=".wav,.mp3,.ogg,.flac,audio/*" (change)="uploadVoiceSample($event)">
                      @if(isUploadingVoice()) {
                        <div class="text-center">
                          <div class="animate-spin text-4xl mb-2">âŸ³</div>
                          <span class="text-purple-400">{{ voiceUploadProgress() }}%</span>
                        </div>
                      } @else {
                        <div class="w-16 h-16 rounded-full bg-purple-500/20 flex items-center justify-center mb-3">
                          <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                          </svg>
                        </div>
                        <span class="text-lg font-medium text-purple-400">é»æ“Šä¸Šå‚³éŸ³é »æ–‡ä»¶</span>
                        <span class="text-sm text-slate-500 mt-2">æ”¯æŒ WAV, MP3, OGG, FLAC æ ¼å¼ï¼ˆæœ€å¤§ 50MBï¼‰</span>
                      }
                    </label>
                  </div>
                }
                @case ('record') {
                  <!-- éŒ„è£½èªéŸ³ -->
                  <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2 mb-4">
                      <span>ğŸ¤</span> {{ t('recordVoice') }}
                    </h3>
                    <p class="text-sm text-slate-400 mb-4">{{ t('recordingHint') }}</p>
                    
                    <div class="space-y-4">
                      <!-- è²éŸ³åç¨± -->
                      <div>
                        <label class="block text-sm font-medium text-slate-400 mb-1">{{ t('voiceNameLabel') }}</label>
                        <input [ngModel]="voiceName()" (ngModelChange)="voiceName.set($event)"
                               class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white"
                               [placeholder]="t('voiceNamePlaceholder')">
                      </div>
                      
                      <!-- åƒè€ƒæ–‡æœ¬ -->
                      <div>
                        <label class="block text-sm font-medium text-slate-400 mb-1">{{ t('promptTextLabel') }}</label>
                        <textarea [ngModel]="voicePromptText()" (ngModelChange)="voicePromptText.set($event)" rows="2"
                                  class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white"
                                  [placeholder]="t('promptTextPlaceholder')"></textarea>
                      </div>
                      
                      <!-- éŒ„éŸ³æ§åˆ¶ -->
                      <div class="flex flex-col items-center py-6">
                        @if(!isRecordingVoice()) {
                          <button (click)="startRecording()" class="w-20 h-20 rounded-full bg-red-500 hover:bg-red-600 text-white flex items-center justify-center transition-all shadow-lg shadow-red-500/30">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                              <circle cx="12" cy="12" r="6"/>
                            </svg>
                          </button>
                          <span class="text-sm text-slate-400 mt-3">{{ t('startRecording') }}</span>
                        } @else {
                          <button (click)="stopRecording()" class="w-20 h-20 rounded-full bg-red-500 animate-pulse text-white flex items-center justify-center transition-all shadow-lg shadow-red-500/50">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                              <rect x="6" y="6" width="12" height="12" rx="2"/>
                            </svg>
                          </button>
                          <span class="text-sm text-red-400 mt-3">{{ t('recording') }} {{ recordingTime() }}s</span>
                        }
                      </div>
                      
                      <!-- éŒ„éŸ³é è¦½ -->
                      @if(recordedAudioBlob()) {
                        <div class="p-4 bg-slate-800/50 rounded-lg">
                          <div class="flex items-center justify-between mb-3">
                            <span class="text-sm text-slate-400">éŒ„éŸ³é è¦½</span>
                            <span class="text-xs text-slate-500">{{ recordingTime() }} {{ t('seconds') }}</span>
                          </div>
                          <div class="flex gap-2">
                            <button (click)="confirmAndUploadRecording()" [disabled]="isUploadingVoice()" class="flex-1 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg">
                              {{ isUploadingVoice() ? 'â³ ä¸Šå‚³ä¸­...' : 'âœ“ ' + t('confirmUpload') }}
                            </button>
                            <button (click)="recordedAudioBlob.set(null)" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">
                              {{ t('reRecord') }}
                            </button>
                          </div>
                        </div>
                      }
                      
                      @if(voiceCloneError()) {
                        <p class="text-red-400 text-sm">{{ voiceCloneError() }}</p>
                      }
                    </div>
                  </div>
                }
              }
              
              <!-- TTS/STT é…ç½® -->
              <div class="grid grid-cols-2 gap-6">
                <!-- TTS é…ç½® -->
                <div class="bg-slate-900/50 border border-slate-500/20 p-4 rounded-xl">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold flex items-center gap-2">
                      <span>ğŸ”Š</span> {{ t('ttsService') }}
                    </h4>
                    <input type="checkbox" [checked]="ttsEnabled()" (change)="ttsEnabled.set(!ttsEnabled())" class="form-checkbox text-cyan-500 rounded">
                  </div>
                  <input [ngModel]="ttsEndpoint()" (ngModelChange)="ttsEndpoint.set($event)"
                         class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white font-mono text-sm mb-2"
                         placeholder="http://localhost:9881">
                  <div class="flex gap-2">
                    <button (click)="testTtsService()" [disabled]="!ttsEndpoint() || isTestingTts()" class="px-3 py-1.5 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 text-sm rounded-lg">
                      {{ isTestingTts() ? 'â³' : 'âš¡' }} æ¸¬è©¦
                    </button>
                    @if(ttsStatus()) {
                      <span class="text-sm flex items-center" [class]="ttsStatus() === 'success' ? 'text-green-400' : 'text-red-400'">
                        {{ ttsStatus() === 'success' ? 'âœ…' : 'âŒ' }}
                      </span>
                    }
                  </div>
                </div>
                
                <!-- STT é…ç½® -->
                <div class="bg-slate-900/50 border border-slate-500/20 p-4 rounded-xl">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold flex items-center gap-2">
                      <span>ğŸ¤</span> {{ t('sttService') }}
                    </h4>
                    <input type="checkbox" [checked]="sttEnabled()" (change)="sttEnabled.set(!sttEnabled())" class="form-checkbox text-cyan-500 rounded">
                  </div>
                  <input [ngModel]="sttEndpoint()" (ngModelChange)="sttEndpoint.set($event)"
                         class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white font-mono text-sm mb-2"
                         placeholder="http://localhost:9000">
                  <div class="flex gap-2">
                    <button (click)="testSttService()" [disabled]="!sttEndpoint() || isTestingStt()" class="px-3 py-1.5 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 text-sm rounded-lg">
                      {{ isTestingStt() ? 'â³' : 'âš¡' }} æ¸¬è©¦
                    </button>
                    @if(sttStatus()) {
                      <span class="text-sm flex items-center" [class]="sttStatus() === 'success' ? 'text-green-400' : 'text-red-400'">
                        {{ sttStatus() === 'success' ? 'âœ…' : 'âŒ' }}
                      </span>
                    }
                  </div>
                </div>
              </div>
              
              <!-- ä¿å­˜æŒ‰éˆ• -->
              <button (click)="saveAiSettings()" class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-all shadow-lg">
                âœ“ {{ t('saveSettings') }}
              </button>
            </div>
          }
          @case ('memory') {
            <!-- å‘é‡è¨˜æ†¶ Tab -->
            <div class="space-y-6">
              <!-- è¨˜æ†¶çµ±è¨ˆå¡ç‰‡ -->
              <div class="grid grid-cols-4 gap-4">
                <div class="bg-slate-900/50 border border-purple-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">ğŸ§ </div>
                  <div class="text-xl font-bold text-purple-400">{{ vectorMemoryStats().totalMemories }}</div>
                  <div class="text-xs text-slate-400">ç¸½è¨˜æ†¶æ•¸</div>
                </div>
                <div class="bg-slate-900/50 border border-cyan-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">ğŸ‘¥</div>
                  <div class="text-xl font-bold text-cyan-400">{{ vectorMemoryStats().totalUsers }}</div>
                  <div class="text-xs text-slate-400">ç”¨æˆ¶æ•¸</div>
                </div>
                <div class="bg-slate-900/50 border border-emerald-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">ğŸ’¬</div>
                  <div class="text-xl font-bold text-emerald-400">{{ vectorMemoryStats().byType['conversation'] || 0 }}</div>
                  <div class="text-xs text-slate-400">å°è©±è¨˜æ†¶</div>
                </div>
                <div class="bg-slate-900/50 border border-yellow-500/30 p-4 rounded-xl text-center">
                  <div class="text-2xl mb-1">â­</div>
                  <div class="text-xl font-bold text-yellow-400">{{ (vectorMemoryStats().avgImportance * 100).toFixed(0) }}%</div>
                  <div class="text-xs text-slate-400">å¹³å‡é‡è¦åº¦</div>
                </div>
              </div>
              
              <!-- æ“ä½œå€åŸŸ -->
              <div class="bg-slate-900/50 border border-slate-500/20 p-6 rounded-xl">
                <div class="flex items-center gap-3 mb-4">
                  <button (click)="refreshMemoryStats()" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg">
                    ğŸ”„ åˆ·æ–°çµ±è¨ˆ
                  </button>
                  <button (click)="showAddMemoryDialog.set(true)" class="px-4 py-2 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 rounded-lg">
                    â• æ·»åŠ è¨˜æ†¶
                  </button>
                  <button (click)="cleanupOldMemories()" class="px-4 py-2 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 rounded-lg">
                    ğŸ§¹ æ¸…ç†èˆŠè¨˜æ†¶
                  </button>
                  <button (click)="mergeSimilarMemories()" [disabled]="!selectedMemoryUserId()" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg disabled:opacity-50">
                    ğŸ”— åˆä½µç›¸ä¼¼
                  </button>
                </div>
                
                <!-- æœç´¢è¨˜æ†¶ -->
                <div class="flex gap-2 mb-4">
                  <select [ngModel]="selectedMemoryUserId()" (ngModelChange)="selectedMemoryUserId.set($event)"
                          class="bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white">
                    <option value="">æ‰€æœ‰ç”¨æˆ¶</option>
                    @for(userId of memoryUserList(); track userId) {
                      <option [value]="userId">{{ userId }}</option>
                    }
                  </select>
                  <input type="text" [(ngModel)]="vectorMemorySearchQuery" (keyup.enter)="searchVectorMemory()"
                         placeholder="æœç´¢è¨˜æ†¶å…§å®¹..."
                         class="flex-1 bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white">
                  <button (click)="searchVectorMemory()" [disabled]="isSearchingMemory()" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg">
                    {{ isSearchingMemory() ? 'ğŸ” æœç´¢ä¸­...' : 'ğŸ” æœç´¢' }}
                  </button>
                </div>
                
                <!-- æœç´¢çµæœ -->
                @if(vectorMemorySearchResults().length > 0) {
                  <div class="space-y-2 max-h-96 overflow-y-auto">
                    @for(memory of vectorMemorySearchResults(); track memory.id) {
                      <div class="p-3 bg-slate-800/50 rounded-lg border border-slate-700 hover:border-purple-500/30 transition-all">
                        <div class="flex justify-between items-start mb-2">
                          <div class="flex items-center gap-2">
                            <span class="text-xs px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded">{{ memory.memoryType }}</span>
                            <span class="text-xs text-slate-500">ç”¨æˆ¶: {{ memory.userId }}</span>
                          </div>
                          <div class="flex items-center gap-2">
                            @if(memory.similarity > 0) {
                              <span class="text-xs text-slate-500">ç›¸ä¼¼åº¦: {{ (memory.similarity * 100).toFixed(0) }}%</span>
                            }
                            <span class="text-xs text-slate-500">é‡è¦åº¦: {{ (memory.importance * 100).toFixed(0) }}%</span>
                          </div>
                        </div>
                        <p class="text-sm text-white mb-2">{{ memory.content }}</p>
                        <div class="flex justify-between items-center">
                          <span class="text-xs text-slate-500">{{ memory.createdAt | date:'yyyy-MM-dd HH:mm' }}</span>
                          <button (click)="deleteVectorMemory(memory.id)" class="text-xs text-red-400 hover:text-red-300">
                            ğŸ—‘ï¸ åˆªé™¤
                          </button>
                        </div>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="text-center py-8 text-slate-400">
                    <div class="text-4xl mb-3">ğŸ§ </div>
                    <p>æœç´¢è¨˜æ†¶æˆ–æ·»åŠ æ–°è¨˜æ†¶</p>
                  </div>
                }
              </div>
              
              <!-- è¨˜æ†¶é¡å‹åˆ†ä½ˆ -->
              <div class="bg-slate-900/50 border border-slate-500/20 p-4 rounded-xl">
                <h4 class="text-sm font-semibold text-slate-300 mb-3">è¨˜æ†¶é¡å‹åˆ†ä½ˆ</h4>
                <div class="flex flex-wrap gap-2">
                  @for(type of ['conversation', 'fact', 'preference', 'summary']; track type) {
                    <div class="px-3 py-1.5 bg-slate-800/50 rounded-lg flex items-center gap-2">
                      <span class="text-sm">
                        @switch(type) {
                          @case('conversation') { ğŸ’¬ }
                          @case('fact') { ğŸ“‹ }
                          @case('preference') { â¤ï¸ }
                          @case('summary') { ğŸ“ }
                        }
                      </span>
                      <span class="text-sm text-slate-400">{{ type }}</span>
                      <span class="text-sm font-medium text-purple-400">{{ vectorMemoryStats().byType[type] || 0 }}</span>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        }
        
        <!-- æ·»åŠ çŸ¥è­˜å°è©±æ¡† -->
        @if (showAddRagKnowledgeDialog()) {
          <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="showAddRagKnowledgeDialog.set(false)">
            <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-6 border border-purple-500/30" (click)="$event.stopPropagation()">
              <h3 class="text-lg font-bold text-white mb-4">â• æ‰‹å‹•æ·»åŠ çŸ¥è­˜</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm text-slate-400 mb-1">é¡å‹</label>
                  <select [(ngModel)]="newRagKnowledge.type" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white">
                    <option value="qa">å•ç­”å°</option>
                    <option value="script">è©±è¡“</option>
                    <option value="product">ç”¢å“ä¿¡æ¯</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">{{ t('ragQuestion') }}</label>
                  <input type="text" [(ngModel)]="newRagKnowledge.question" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white" placeholder="ç”¨æˆ¶å¯èƒ½å•çš„å•é¡Œ...">
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">{{ t('ragAnswer') }} *</label>
                  <textarea [(ngModel)]="newRagKnowledge.answer" rows="4" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white" placeholder="æ¨™æº–å›ç­”..."></textarea>
                </div>
              </div>
              <div class="flex gap-3 mt-6">
                <button (click)="showAddRagKnowledgeDialog.set(false)" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2.5 rounded-lg">{{ t('cancel') }}</button>
                <button (click)="addRagKnowledge()" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-2.5 rounded-lg">{{ t('addKnowledge') }}</button>
              </div>
            </div>
          </div>
        }
        
        <!-- æ·»åŠ è¨˜æ†¶å°è©±æ¡† -->
        @if (showAddMemoryDialog()) {
          <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" (click)="showAddMemoryDialog.set(false)">
            <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-6 border border-purple-500/30" (click)="$event.stopPropagation()">
              <h3 class="text-lg font-bold text-white mb-4">ğŸ§  æ·»åŠ å‘é‡è¨˜æ†¶</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm text-slate-400 mb-1">ç”¨æˆ¶ ID</label>
                  <input type="text" [(ngModel)]="newMemory.userId" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white" placeholder="ç•™ç©ºå‰‡ç‚ºæ‰‹å‹•è¨˜æ†¶">
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">é¡å‹</label>
                  <select [(ngModel)]="newMemory.type" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white">
                    <option value="conversation">å°è©±è¨˜æ†¶</option>
                    <option value="fact">äº‹å¯¦ä¿¡æ¯</option>
                    <option value="preference">ç”¨æˆ¶åå¥½</option>
                    <option value="summary">æ‘˜è¦</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">è¨˜æ†¶å…§å®¹ *</label>
                  <textarea [(ngModel)]="newMemory.content" rows="4" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white" placeholder="è¼¸å…¥è¦è¨˜ä½çš„å…§å®¹..."></textarea>
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">é‡è¦åº¦: {{ (newMemory.importance * 100).toFixed(0) }}%</label>
                  <input type="range" [(ngModel)]="newMemory.importance" min="0" max="1" step="0.1" class="w-full">
                </div>
              </div>
              <div class="flex gap-3 mt-6">
                <button (click)="showAddMemoryDialog.set(false)" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2.5 rounded-lg">{{ t('cancel') }}</button>
                <button (click)="addVectorMemory()" [disabled]="isAddingMemory()" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-2.5 rounded-lg">
                  {{ isAddingMemory() ? 'â³ æ·»åŠ ä¸­...' : 'â• æ·»åŠ è¨˜æ†¶' }}
                </button>
              </div>
            </div>
          </div>
        }
        </div> <!-- é—œé–‰éš±è—çš„èˆŠç‰ˆ AI ä¸­å¿ƒ UI -->
      }
      @case ('runtime-logs') {
        <!-- é‹è¡Œæ—¥èªŒé é¢ï¼ˆåˆä½µç›£æ§ä¸­å¿ƒå’Œå‘Šè­¦ï¼‰ -->
        <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-3">
          <span class="text-3xl">ğŸ“Š</span> é‹è¡Œæ—¥èªŒ
        </h2>
        
        <!-- Tab å°èˆª -->
        <div class="flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-lg w-fit">
          <button (click)="runtimeLogsTab.set('analytics')" 
                  [class]="runtimeLogsTab() === 'analytics' ? 'bg-cyan-500/30 text-cyan-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“ˆ</span> {{ t('analytics') }}
          </button>
          <button (click)="runtimeLogsTab.set('logs')" 
                  [class]="runtimeLogsTab() === 'logs' ? 'bg-cyan-500/30 text-cyan-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>ğŸ“‹</span> {{ t('logs') }}
          </button>
          <button (click)="runtimeLogsTab.set('performance')" 
                  [class]="runtimeLogsTab() === 'performance' ? 'bg-cyan-500/30 text-cyan-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2">
            <span>âš¡</span> {{ t('performance') }}
          </button>
          <button (click)="runtimeLogsTab.set('alerts')" 
                  [class]="runtimeLogsTab() === 'alerts' ? 'bg-cyan-500/30 text-cyan-300' : 'text-slate-400 hover:text-white'"
                  class="px-4 py-2 rounded-lg transition-all flex items-center gap-2 relative">
            <span>ğŸ””</span> {{ t('alerts') }}
            @if(unacknowledgedAlertsCount() > 0) {
              <span class="absolute -top-1 -right-1 text-xs font-bold rounded-full w-4 h-4 flex items-center justify-center" style="background-color: var(--error); color: white;">{{ unacknowledgedAlertsCount() }}</span>
            }
          </button>
        </div>
        
        <!-- Tab å…§å®¹ -->
        @switch (runtimeLogsTab()) {
          @case ('analytics') {
            <!-- æ•¸æ“šåˆ†æ - åŸ analytics é é¢å…§å®¹ -->
            <div class="flex items-center justify-between mb-8">
              <h3 class="text-2xl font-bold text-slate-900 dark:text-white">{{ t('analyticsTitle') }}</h3>
              <div class="flex items-center gap-4">
                <select [ngModel]="selectedAnalyticsCampaignId()" (ngModelChange)="selectedAnalyticsCampaignId.set($event)" class="form-select bg-slate-800/50 border-slate-700 rounded-lg p-2 text-sm focus:ring-1 focus:ring-cyan-500">
                  <option value="all">{{t('allCampaigns')}}</option>
                  @for(campaign of campaigns(); track campaign.id) {
                    <option [value]="campaign.id">{{campaign.name}}</option>
                  }
                </select>
                <select [ngModel]="selectedDays()" (ngModelChange)="onDaysChange($event)" class="form-select bg-slate-800/50 border-slate-700 rounded-lg p-2 text-sm focus:ring-1 focus:ring-cyan-500">
                  <option [value]="7">{{t('last7Days')}}</option>
                  <option [value]="14">{{t('last14Days')}}</option>
                  <option [value]="30">{{t('last30Days')}}</option>
                </select>
                <button (click)="loadAllAnalytics(selectedDays())" class="bg-cyan-500 hover:bg-cyan-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                  <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                  {{t('refresh')}}
                </button>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="bg-slate-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-white mb-4">æ•è·è¶‹åŠ¿</h4>
                <app-analytics-charts [data]="capturesChartData()" [chartType]="'line'" [title]="''"></app-analytics-charts>
              </div>
              <div class="bg-slate-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-white mb-4">è½¬åŒ–è¶‹åŠ¿</h4>
                <app-analytics-charts [data]="conversionsChartData()" [chartType]="'line'" [title]="''"></app-analytics-charts>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-slate-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-white mb-4">æ¶ˆæ¯å‘é€</h4>
                <app-analytics-charts [data]="messagesChartData()" [chartType]="'line'" [title]="''"></app-analytics-charts>
              </div>
              <div class="bg-slate-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-white mb-4">æ¼æ–—åˆ†æ</h4>
                <app-analytics-charts [data]="funnelChartData()" [chartType]="'bar'" [title]="''"></app-analytics-charts>
              </div>
            </div>
          }
          @case ('logs') {
            <!-- ç³»çµ±æ—¥å¿— - åŸ logs é é¢å…§å®¹ -->
            <div class="mb-4 flex items-center justify-between">
              <h3 class="text-2xl font-bold text-white">{{ t('logs') }}</h3>
              <div class="flex gap-2">
                <button (click)="clearLogs()" class="bg-red-500/20 hover:bg-red-500/30 text-red-400 py-2 px-4 rounded-lg">
                  ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ
                </button>
              </div>
            </div>
            <div class="bg-slate-900/50 border border-slate-500/20 rounded-xl p-4 max-h-[600px] overflow-y-auto font-mono text-sm">
              @for(log of logs().slice().reverse(); track $index) {
                <div class="py-1 border-b border-slate-800/50 flex gap-3" [class.text-red-400]="log.type === 'error'" [class.text-yellow-400]="log.type === 'warning'" [class.text-green-400]="log.type === 'success'" [class.text-slate-400]="log.type === 'info'">
                  <span class="text-slate-600 shrink-0">{{ log.timestamp | date:'HH:mm:ss' }}</span>
                  <span class="shrink-0">[{{ log.type.toUpperCase() }}]</span>
                  <span class="break-all">{{ log.message }}</span>
                </div>
              } @empty {
                <div class="text-center text-slate-500 py-8">æš«ç„¡æ—¥èªŒ</div>
              }
            </div>
          }
          @case ('performance') {
            <!-- æ€§èƒ½ç›£æ§ - åŸ performance é é¢å…§å®¹ -->
            <app-performance-monitor></app-performance-monitor>
          }
          @case ('alerts') {
            <!-- å‘Šè­¦ç®¡ç† -->
            <div class="mb-6">
              <!-- Alert Tabs -->
              <div class="flex gap-2 mb-6 border-b border-slate-700">
                <button (click)="alertManagementTab.set('alerts')" 
                        [class]="alertManagementTab() === 'alerts' ? 'border-b-2 border-cyan-500 text-cyan-400' : 'text-slate-400 hover:text-white'"
                        class="px-4 py-2 font-medium">
                  å‘Šè­¦åˆ—è¡¨
                </button>
                <button (click)="alertManagementTab.set('rules')" 
                        [class]="alertManagementTab() === 'rules' ? 'border-b-2 border-cyan-500 text-cyan-400' : 'text-slate-400 hover:text-white'"
                        class="px-4 py-2 font-medium">
                  å‘Šè­¦è§„åˆ™
                </button>
                <button (click)="alertManagementTab.set('history')" 
                        [class]="alertManagementTab() === 'history' ? 'border-b-2 border-cyan-500 text-cyan-400' : 'text-slate-400 hover:text-white'"
                        class="px-4 py-2 font-medium">
                  å†å²è®°å½•
                </button>
              </div>
              
              @switch (alertManagementTab()) {
                @case ('alerts') {
              <!-- Alert Filter Section -->
              <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-6">
                  <div class="flex items-center justify-between mb-4">
                      <h3 class="text-lg font-semibold">è¿‡æ»¤é€‰é¡¹</h3>
                      <button (click)="loadAlerts()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg shadow-cyan-500/20">åˆ·æ–°</button>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                          <label class="block text-sm font-medium mb-2">å‘Šè­¦çº§åˆ«</label>
                          <select (change)="loadAlerts(false, $any($event.target).value || undefined)" class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                              <option value="">å…¨éƒ¨çº§åˆ«</option>
                              <option value="info">ä¿¡æ¯</option>
                              <option value="warning">è­¦å‘Š</option>
                              <option value="error">é”™è¯¯</option>
                              <option value="critical">ä¸¥é‡</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium mb-2">çŠ¶æ€</label>
                          <select (change)="loadAlerts($any($event.target).value === 'unresolved')" class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                              <option value="all">å…¨éƒ¨</option>
                              <option value="unresolved">æœªè§£å†³</option>
                          </select>
                      </div>
                      <div class="flex items-end">
                          <button (click)="loadAlerts(true)" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">ä»…æ˜¾ç¤ºæœªè§£å†³</button>
                      </div>
                  </div>
              </div>
              
              <!-- Alerts Display -->
              <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                  <div class="mb-4 text-sm text-slate-500 dark:text-slate-400">
                      æ˜¾ç¤º {{ alerts().length }} æ¡å‘Šè­¦
                      @if(unacknowledgedAlertsCount() > 0) {
                          <span class="ml-2 text-red-500 font-bold">{{ unacknowledgedAlertsCount() }} æ¡æœªç¡®è®¤</span>
                      }
                  </div>
                  <div class="space-y-3">
                      @for(alert of alerts(); track alert.id) {
                          <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg border-l-4" 
                               [class.border-blue-500]="alert.level === 'info'"
                               [class.border-yellow-500]="alert.level === 'warning'"
                               [class.border-orange-500]="alert.level === 'error'"
                               [class.border-red-500]="alert.level === 'critical'">
                              <div class="flex items-start justify-between">
                                  <div class="flex-1">
                                      <div class="flex items-center gap-3 mb-2">
                                          <span class="px-2.5 py-1 text-xs font-semibold rounded-full"
                                                [class.bg-blue-500/20]="alert.level === 'info'"
                                                [class.text-blue-400]="alert.level === 'info'"
                                                [class.bg-yellow-500/20]="alert.level === 'warning'"
                                                [class.text-yellow-400]="alert.level === 'warning'"
                                                [class.bg-orange-500/20]="alert.level === 'error'"
                                                [class.text-orange-400]="alert.level === 'error'"
                                                [class.bg-red-500/20]="alert.level === 'critical'"
                                                [class.text-red-400]="alert.level === 'critical'">
                                              {{ alert.level.toUpperCase() }}
                                          </span>
                                          <span class="text-xs text-slate-500 dark:text-slate-400">{{ alert.alert_type }}</span>
                                          <span class="text-xs text-slate-500 dark:text-slate-400">{{ formatDate(alert.timestamp) }}</span>
                                          @if(alert.acknowledged) {
                                              <span class="text-xs bg-green-500/20 text-green-400 px-2 py-0.5 rounded-full">å·²ç¡®è®¤</span>
                                          }
                                          @if(alert.resolved) {
                                              <span class="text-xs bg-gray-500/20 text-gray-400 px-2 py-0.5 rounded-full">å·²è§£å†³</span>
                                          }
                                      </div>
                                      <p class="text-slate-700 dark:text-slate-300 mb-2">{{ alert.message }}</p>
                                      @if(isValidAlertDetails(alert.details)) {
                                          <div class="text-xs text-slate-500 dark:text-slate-400 mt-2">
                                              <details>
                                                  <summary class="cursor-pointer hover:text-slate-600 dark:hover:text-slate-300">æŸ¥çœ‹è¯¦æƒ…</summary>
                                                  <pre class="mt-2 p-2 bg-slate-100 dark:bg-slate-900 rounded text-xs overflow-x-auto">{{ safeStringify(alert.details) }}</pre>
                                              </details>
                                          </div>
                                      }
                                  </div>
                                  <div class="flex gap-2 ml-4">
                                      @if(!alert.acknowledged) {
                                          <button (click)="acknowledgeAlert(alert.id)" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded transition duration-200" title="ç¡®è®¤å‘Šè­¦">ç¡®è®¤</button>
                                      }
                                      @if(!alert.resolved) {
                                          <button (click)="resolveAlert(alert.id)" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded transition duration-200" title="è§£å†³å‘Šè­¦">è§£å†³</button>
                                      }
                                  </div>
                              </div>
                          </div>
                      } @empty {
                          <p class="text-center text-slate-500 py-8">æš‚æ— å‘Šè­¦</p>
                      }
                  </div>
              </div>
                }
                @case ('rules') {
                  <!-- Alert Rules Configuration -->
                  <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-6">
                    <div class="flex items-center justify-between mb-4">
                      <h3 class="text-lg font-semibold">å‘Šè­¦è§„åˆ™é…ç½®</h3>
                      <button (click)="showAddAlertRuleDialog.set(true)" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
                        + æ·»åŠ è§„åˆ™
                      </button>
                    </div>
                    
                    <div class="space-y-3">
                      @for(rule of alertRules(); track rule.id) {
                        <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                          <div class="flex items-center justify-between mb-2">
                            <div>
                              <span class="font-semibold text-white">{{ rule.name }}</span>
                              <span class="ml-2 px-2 py-0.5 text-xs rounded" 
                                    [class.bg-green-500/20]="rule.enabled"
                                    [class.text-green-400]="rule.enabled"
                                    [class.bg-gray-500/20]="!rule.enabled"
                                    [class.text-gray-400]="!rule.enabled">
                                {{ rule.enabled ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                              </span>
                            </div>
                            <div class="flex gap-2">
                              <button (click)="toggleAlertRule(rule.id)" 
                                      class="px-3 py-1 text-xs rounded"
                                      [class.bg-yellow-500/20]="rule.enabled"
                                      [class.text-yellow-400]="rule.enabled"
                                      [class.bg-green-500/20]="!rule.enabled"
                                      [class.text-green-400]="!rule.enabled">
                                {{ rule.enabled ? 'ç¦ç”¨' : 'å¯ç”¨' }}
                              </button>
                              <button (click)="editAlertRule(rule)" class="px-3 py-1 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 text-xs rounded">
                                ç¼–è¾‘
                              </button>
                              <button (click)="deleteAlertRule(rule.id)" class="px-3 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 text-xs rounded">
                                åˆ é™¤
                              </button>
                            </div>
                          </div>
                          <div class="text-sm text-slate-400">
                            <p>ç±»å‹: {{ rule.alert_type }}</p>
                            <p>æ¡ä»¶: {{ rule.condition }}</p>
                            <p>çº§åˆ«: <span [class.text-blue-400]="rule.level === 'info'"
                                          [class.text-yellow-400]="rule.level === 'warning'"
                                          [class.text-orange-400]="rule.level === 'error'"
                                          [class.text-red-400]="rule.level === 'critical'">{{ rule.level }}</span></p>
                          </div>
                        </div>
                      } @empty {
                        <p class="text-center text-slate-500 py-8">æš‚æ— å‘Šè­¦è§„åˆ™</p>
                      }
                    </div>
                  </div>
                }
                @case ('history') {
                  <!-- Alert History -->
                  <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-6">
                    <div class="flex items-center justify-between mb-4">
                      <h3 class="text-lg font-semibold">å‘Šè­¦å†å²è®°å½•</h3>
                      <div class="flex gap-2">
                        <select (change)="loadAlertHistory($any($event.target).value)" class="form-select bg-slate-800/50 border-slate-700 rounded-lg p-2 text-sm">
                          <option value="7">æœ€è¿‘7å¤©</option>
                          <option value="30">æœ€è¿‘30å¤©</option>
                          <option value="90">æœ€è¿‘90å¤©</option>
                        </select>
                        <button (click)="loadAlertHistory(30)" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
                          åˆ·æ–°
                        </button>
                      </div>
                    </div>
                    
                    <div class="space-y-2 max-h-[600px] overflow-y-auto">
                      @for(alert of alertHistory(); track alert.id) {
                        <div class="bg-slate-800/50 p-3 rounded-lg border-l-4"
                             [class.border-blue-500]="alert.level === 'info'"
                             [class.border-yellow-500]="alert.level === 'warning'"
                             [class.border-orange-500]="alert.level === 'error'"
                             [class.border-red-500]="alert.level === 'critical'">
                          <div class="flex items-center justify-between">
                            <div class="flex-1">
                              <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-semibold"
                                      [class.text-blue-400]="alert.level === 'info'"
                                      [class.text-yellow-400]="alert.level === 'warning'"
                                      [class.text-orange-400]="alert.level === 'error'"
                                      [class.text-red-400]="alert.level === 'critical'">
                                  {{ alert.level.toUpperCase() }}
                                </span>
                                <span class="text-sm text-white">{{ alert.message }}</span>
                              </div>
                              <div class="text-xs text-slate-400">
                                {{ formatDate(alert.timestamp) }} | {{ alert.alert_type }}
                                @if(alert.resolved_at) {
                                  | è§£å†³äº: {{ formatDate(alert.resolved_at) }}
                                }
                              </div>
                            </div>
                            <div class="flex gap-2">
                              @if(alert.acknowledged) {
                                <span class="text-xs bg-green-500/20 text-green-400 px-2 py-0.5 rounded">å·²ç¡®è®¤</span>
                              }
                              @if(alert.resolved) {
                                <span class="text-xs bg-gray-500/20 text-gray-400 px-2 py-0.5 rounded">å·²è§£å†³</span>
                              }
                            </div>
                          </div>
                        </div>
                      } @empty {
                        <p class="text-center text-slate-500 py-8">æš‚æ— å†å²è®°å½•</p>
                      }
                    </div>
                  </div>
                }
              }
            </div>
          }
        }
      }
      @case ('analytics') {
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-4xl font-bold text-slate-900 dark:text-white">{{ t('analyticsTitle') }}</h2>
            <div class="flex items-center gap-4">
                <select [ngModel]="selectedAnalyticsCampaignId()" (ngModelChange)="selectedAnalyticsCampaignId.set($event)" class="form-select bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500">
                    <option value="all">{{t('allCampaigns')}}</option>
                    @for(campaign of campaigns(); track campaign.id) {
                        <option [value]="campaign.id">{{campaign.name}}</option>
                    }
                </select>
                <button (click)="loadAllAnalytics(7)" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg shadow-cyan-500/20">åˆ·æ–°æ•°æ®</button>
            </div>
        </div>
        
        <!-- Sending Stats Chart -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-xl font-semibold mb-4">å‘é€è¶‹åŠ¿ï¼ˆæœ€è¿‘7å¤©ï¼‰</h3>
            <div class="h-64">
                @if(sendingStatsData()) {
                    <app-analytics-charts [chartType]="'line'" [data]="sendingStatsData" [title]="'å‘é€è¶‹åŠ¿'"></app-analytics-charts>
                } @else {
                    <p class="text-center text-slate-500 py-16">åŠ è½½ä¸­...</p>
                }
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Queue Length History -->
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4">é˜Ÿåˆ—é•¿åº¦å†å²</h3>
                <div class="h-64">
                    @if(queueLengthHistoryData()) {
                        <app-analytics-charts [chartType]="'line'" [data]="queueLengthHistoryData" [title]="'é˜Ÿåˆ—é•¿åº¦'"></app-analytics-charts>
                    } @else {
                        <p class="text-center text-slate-500 py-16">åŠ è½½ä¸­...</p>
                    }
                </div>
            </div>
            
            <!-- Account Comparison -->
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4">è´¦æˆ·å‘é€å¯¹æ¯”</h3>
                <div class="h-64">
                    @if(accountComparisonData()) {
                        <app-analytics-charts [chartType]="'bar'" [data]="accountComparisonData" [title]="'è´¦æˆ·å¯¹æ¯”'"></app-analytics-charts>
                    } @else {
                        <p class="text-center text-slate-500 py-16">åŠ è½½ä¸­...</p>
                    }
                </div>
            </div>
        </div>
        
        <!-- Campaign Performance -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-xl font-semibold mb-4">æ´»åŠ¨æ•ˆæœå¯¹æ¯”</h3>
            <div class="h-64">
                @if(campaignPerformanceData()) {
                    <app-analytics-charts [chartType]="'bar'" [data]="campaignPerformanceData" [title]="'æ´»åŠ¨æ•ˆæœ'"></app-analytics-charts>
                } @else {
                    <p class="text-center text-slate-500 py-16">åŠ è½½ä¸­...</p>
                }
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-2">{{ t('leadsOverTime') }}</h3><p class="text-sm text-slate-500 dark:text-slate-400 mb-6">{{ t('last7Days') }}</p>
                <div class="flex justify-between items-end h-64 space-x-2">
                    @for(day of analyticsData().leadsByDay; track day.date) {
                        <div class="flex flex-col items-center flex-1"><div class="w-full bg-cyan-500 rounded-t-md" [style.height.%]="(day.count / analyticsData().maxLeadsInPeriod) * 100"></div><span class="text-xs mt-2 text-slate-500 dark:text-slate-400">{{ day.date.toLocaleDateString(undefined, {weekday: 'short'}) }}</span></div>
                    }
                </div>
            </div>
            <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-2">{{ t('conversionFunnel') }}</h3>
                <div class="space-y-3 mt-6">
                    @let funnel = analyticsData().funnel;
                    @let total = funnel.new || 1;
                    <!-- æ–°å®¢æˆ¶ -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-blue-400">æ–°å®¢æˆ¶</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-blue-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" style="width: 100%">{{funnel.new || 0}}</div></div></div>
                    <!-- å·²è¯ç¹« -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-cyan-400">å·²è¯ç¹«</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-cyan-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.contacted || 0) / total) * 100">{{funnel.contacted || 0}}</div></div></div>
                    <!-- å·²å›å¾© -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-green-400">å·²å›å¾©</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-green-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.replied || 0) / total) * 100">{{funnel.replied || 0}}</div></div></div>
                    <!-- æœ‰èˆˆè¶£ -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-yellow-400">æœ‰èˆˆè¶£</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-yellow-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.interested || 0) / total) * 100">{{funnel.interested || 0}}</div></div></div>
                    <!-- æ´½è«‡ä¸­ -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-orange-400">æ´½è«‡ä¸­</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-orange-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.negotiating || 0) / total) * 100">{{funnel.negotiating || 0}}</div></div></div>
                    <!-- éœ€è·Ÿé€² -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-purple-400">éœ€è·Ÿé€²</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-purple-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.follow_up || 0) / total) * 100">{{funnel.follow_up || 0}}</div></div></div>
                    <!-- å·²æˆäº¤ -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-emerald-400">å·²æˆäº¤</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-emerald-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.converted || 0) / total) * 100">{{funnel.converted || 0}}</div></div></div>
                    <!-- å·²æµå¤± -->
                    <div class="flex items-center"><span class="w-20 text-sm font-medium text-red-400">å·²æµå¤±</span><div class="flex-1 bg-slate-700 rounded-full h-5 mx-2"><div class="bg-red-500 h-5 rounded-full flex items-center justify-end px-2 text-white text-xs" [style.width.%]="((funnel.churned || 0) / total) * 100">{{funnel.churned || 0}}</div></div></div>
                </div>
            </div>
            <div class="lg:col-span-3 bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-2">{{ t('campaignPerformance') }}</h3>
                <table class="w-full text-left mt-4">
                    <thead class="text-slate-600 dark:text-slate-300 uppercase text-sm"><tr><th class="py-2 px-4">{{ t('campaign') }}</th><th class="py-2 px-4">{{ t('status') }}</th><th class="py-2 px-4">{{ t('leads') }}</th><th class="py-2 px-4">{{ t('contacted') }}</th><th class="py-2 px-4">{{ t('replied') }}</th><th class="py-2 px-4">{{ t('replyRate') }}</th></tr></thead>
                    <tbody>
                        @for(stat of campaignPerformance(); track stat.id) {
                            <tr class="border-b border-slate-200 dark:border-slate-800">
                                <td class="py-3 px-4 font-semibold">{{ stat.name }}</td>
                                <td class="py-3 px-4"><span class="px-2.5 py-1 text-xs font-semibold rounded-full" [class.bg-green-500/10]="stat.isActive" [class.text-green-400]="stat.isActive" [class.bg-slate-500/10]="!stat.isActive" [class.text-slate-400]="!stat.isActive">{{ stat.isActive ? t('active') : t('inactive')}}</span></td>
                                <td class="py-3 px-4">{{ stat.leads }}</td>
                                <td class="py-3 px-4">{{ stat.contacted }}</td>
                                <td class="py-3 px-4">{{ stat.replied }}</td>
                                <td class="py-3 px-4">{{ stat.replyRate.toFixed(1) }}%</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
      }
      @case ('logs') {
        <h2 class="text-4xl font-bold mb-8 text-slate-900 dark:text-white">{{ t('actionLogs') }}</h2>
        
        <!-- Filter Section -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-6">
            <h3 class="text-lg font-semibold mb-4">è¿‡æ»¤å’Œæœç´¢</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Type Filter -->
                <div>
                    <label class="block text-sm font-medium mb-2">æ—¥å¿—çº§åˆ«</label>
                    <select [(ngModel)]="logFilterType" class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                        <option value="">å…¨éƒ¨</option>
                        <option value="info">ä¿¡æ¯</option>
                        <option value="success">æˆåŠŸ</option>
                        <option value="warning">è­¦å‘Š</option>
                        <option value="error">é”™è¯¯</option>
                    </select>
                </div>
                
                <!-- Start Date -->
                <div>
                    <label class="block text-sm font-medium mb-2">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" [(ngModel)]="logFilterStartDate" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                </div>
                
                <!-- End Date -->
                <div>
                    <label class="block text-sm font-medium mb-2">ç»“æŸæ—¥æœŸ</label>
                    <input type="date" [(ngModel)]="logFilterEndDate" class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                </div>
                
                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium mb-2">æœç´¢å…³é”®è¯</label>
                    <input type="text" [ngModel]="logFilterSearch()" (ngModelChange)="logFilterSearch.set($event); onLogFilterChange()" placeholder="æœç´¢æ—¥å¿—å†…å®¹..." class="form-input w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg p-2 text-sm">
                </div>
            </div>
            
            <div class="flex gap-3 mt-4">
                <button (click)="applyLogFilter()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg text-sm shadow-lg shadow-cyan-500/20">åº”ç”¨è¿‡æ»¤</button>
                <button (click)="resetLogFilter()" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg text-sm">é‡ç½®</button>
                <button (click)="exportLogs()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg text-sm shadow-lg shadow-green-500/20">å¯¼å‡º Excel</button>
                <button (click)="clearLogs()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg text-sm shadow-lg shadow-red-500/20 ml-auto">{{ t('clearLogs') }}</button>
            </div>
        </div>
        
        <!-- Logs Display -->
        <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg">
            <div class="mb-4 text-sm text-slate-500 dark:text-slate-400">
                æ˜¾ç¤º {{ filteredLogs().length }} æ¡æ—¥å¿—
            </div>
            <div class="space-y-3 font-mono text-sm h-[calc(100vh-450px)] overflow-y-auto bg-slate-200/20 dark:bg-slate-800/20 p-4 rounded-lg">
                @for(log of filteredLogs(); track log.id) {
                    <div class="flex items-start">
                        <span class="text-slate-500 dark:text-slate-400 mr-4 min-w-[80px]">{{ log.timestamp.toLocaleString() }}</span>
                        <span [class]="getLogColor(log.type)" class="font-bold mr-2 w-16 text-right">{{ log.type.toUpperCase() }}</span>
                        <span class="flex-1 text-slate-700 dark:text-slate-300">{{ log.message }}</span>
                    </div>
                }
                @if(filteredLogs().length === 0) { 
                    <p class="text-center text-slate-500 py-8">{{ t('noRecentActivity') }}</p> 
                }
            </div>
        </div>
      }
      @case ('performance') {
        <app-performance-monitor></app-performance-monitor>
      }
      @case('settings') {
          <h2 class="text-4xl font-bold mb-6 text-slate-900 dark:text-white">{{ t('settingsTitle') }}</h2>
          
          <!-- è¨­ç½®å­æ¨™ç±¤ -->
          <div class="flex gap-2 mb-6 bg-slate-200/50 dark:bg-slate-800/50 p-1 rounded-lg w-fit">
            <button (click)="settingsTab.set('backup'); loadBackups()" 
                    [class]="settingsTab() === 'backup' ? 'bg-white dark:bg-slate-700 shadow' : 'text-slate-500 hover:text-slate-700 dark:hover:text-white'"
                    class="px-4 py-2 rounded-lg transition-all flex items-center gap-2 text-sm">
              ğŸ’¾ å‚™ä»½ç®¡ç†
            </button>
            <button (click)="settingsTab.set('migration'); loadMigrationStatus()" 
                    [class]="settingsTab() === 'migration' ? 'bg-white dark:bg-slate-700 shadow' : 'text-slate-500 hover:text-slate-700 dark:hover:text-white'"
                    class="px-4 py-2 rounded-lg transition-all flex items-center gap-2 text-sm">
              ğŸ—ƒï¸ æ•¸æ“šåº«é·ç§»
            </button>
            <button (click)="settingsTab.set('scheduler'); loadSchedulerStatus()" 
                    [class]="settingsTab() === 'scheduler' ? 'bg-white dark:bg-slate-700 shadow' : 'text-slate-500 hover:text-slate-700 dark:hover:text-white'"
                    class="px-4 py-2 rounded-lg transition-all flex items-center gap-2 text-sm">
              â° ä»»å‹™èª¿åº¦
            </button>
          </div>
          

          @if (settingsTab() === 'backup') {
          <!-- Backup Management -->
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
              <h3 class="text-xl mb-4 font-semibold flex items-center gap-2">
                  <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="17 8 12 3 7 8"></polyline>
                      <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                  å¤‡ä»½ç®¡ç†
              </h3>
              <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">åˆ›å»ºå’Œç®¡ç†æ•°æ®å¤‡ä»½ï¼Œç¡®ä¿æ•°æ®å®‰å…¨</p>
              
              <div class="space-y-4">
                  <!-- Create Backup Button -->
                  <div class="flex items-center gap-4">
                      <button (click)="createBackup()" 
                              [disabled]="isCreatingBackup()"
                              class="bg-cyan-500 hover:bg-cyan-600 text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                          @if(isCreatingBackup()) {
                              <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
                              </svg>
                              åˆ›å»ºä¸­...
                          } @else {
                              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                  <polyline points="17 8 12 3 7 8"></polyline>
                                  <line x1="12" y1="3" x2="12" y2="15"></line>
                              </svg>
                              åˆ›å»ºå¤‡ä»½
                          }
                      </button>
                      <button (click)="loadBackups()" 
                              class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                          </svg>
                          åˆ·æ–°åˆ—è¡¨
                      </button>
                  </div>
                  
                  <!-- Backup List -->
                  @if(backups().length > 0) {
                      <div class="border border-slate-300 dark:border-slate-600 rounded-lg overflow-hidden">
                          <table class="w-full text-sm">
                              <thead class="bg-slate-200/50 dark:bg-slate-800/50">
                                  <tr>
                                      <th class="text-left p-3 text-slate-700 dark:text-slate-300">å¤‡ä»½åç§°</th>
                                      <th class="text-left p-3 text-slate-700 dark:text-slate-300">åˆ›å»ºæ—¶é—´</th>
                                      <th class="text-left p-3 text-slate-700 dark:text-slate-300">å¤§å°</th>
                                      <th class="text-right p-3 text-slate-700 dark:text-slate-300">æ“ä½œ</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  @for(backup of backups(); track backup.id) {
                                      <tr class="border-t border-slate-300 dark:border-slate-600 hover:bg-slate-100/50 dark:hover:bg-slate-800/50">
                                          <td class="p-3 text-slate-800 dark:text-slate-200">{{ backup.name }}</td>
                                          <td class="p-3 text-slate-600 dark:text-slate-400">{{ backup.created_at }}</td>
                                          <td class="p-3 text-slate-600 dark:text-slate-400">{{ backup.size || 'N/A' }}</td>
                                          <td class="p-3 text-right">
                                              <div class="flex items-center justify-end gap-2">
                                                  <button (click)="restoreBackup(backup.id)" 
                                                          class="text-cyan-400 hover:text-cyan-300 text-xs px-2 py-1 rounded hover:bg-cyan-500/10">
                                                      æ¢å¤
                                                  </button>
                                                  <button (click)="deleteBackup(backup.id)" 
                                                          class="text-red-400 hover:text-red-300 text-xs px-2 py-1 rounded hover:bg-red-500/10">
                                                      åˆ é™¤
                                                  </button>
                                              </div>
                                          </td>
                                      </tr>
                                  }
                              </tbody>
                          </table>
                      </div>
                  } @else {
                      <p class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">æš‚æ— å¤‡ä»½</p>
                  }
              </div>
          </div>
          }
          
          @if (settingsTab() === 'migration') {
          <!-- æ•¸æ“šåº«é·ç§»ç®¡ç† -->
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold flex items-center gap-2">
                ğŸ—ƒï¸ æ•¸æ“šåº«é·ç§»ç®¡ç†
              </h3>
              <button (click)="loadMigrationStatus()" [disabled]="isLoadingMigration()" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg">
                {{ isLoadingMigration() ? 'â³ åŠ è¼‰ä¸­...' : 'ğŸ”„ åˆ·æ–°ç‹€æ…‹' }}
              </button>
            </div>
            
            <!-- é·ç§»ç‹€æ…‹æ¦‚è¦½ -->
            <div class="grid grid-cols-4 gap-4 mb-6">
              <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-300 dark:border-slate-700">
                <div class="text-sm text-slate-500">ç•¶å‰ç‰ˆæœ¬</div>
                <div class="text-2xl font-bold text-cyan-400">v{{ migrationStatus().currentVersion }}</div>
              </div>
              <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-300 dark:border-slate-700">
                <div class="text-sm text-slate-500">æœ€æ–°ç‰ˆæœ¬</div>
                <div class="text-2xl font-bold text-green-400">v{{ migrationStatus().latestVersion }}</div>
              </div>
              <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-300 dark:border-slate-700">
                <div class="text-sm text-slate-500">å·²æ‡‰ç”¨</div>
                <div class="text-2xl font-bold text-blue-400">{{ migrationStatus().appliedCount }}</div>
              </div>
              <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-300 dark:border-slate-700">
                <div class="text-sm text-slate-500">å¾…è™•ç†</div>
                <div class="text-2xl font-bold" [class.text-orange-400]="migrationStatus().pendingCount > 0" [class.text-slate-400]="migrationStatus().pendingCount === 0">{{ migrationStatus().pendingCount }}</div>
              </div>
            </div>
            
            <!-- å¾…è™•ç†é·ç§» -->
            @if (migrationStatus().pendingCount > 0) {
              <div class="bg-orange-500/10 border border-orange-500/30 rounded-xl p-4 mb-6">
                <h4 class="font-semibold text-orange-400 mb-3">âš ï¸ å¾…è™•ç†çš„é·ç§»</h4>
                <div class="space-y-2">
                  @for (migration of migrationStatus().pendingMigrations; track migration.version) {
                    <div class="flex items-center justify-between bg-slate-800/50 rounded-lg p-3">
                      <div>
                        <span class="text-sm font-mono text-orange-300">v{{ migration.version }}</span>
                        <span class="text-sm text-slate-400 ml-2">{{ migration.description }}</span>
                      </div>
                    </div>
                  }
                </div>
                <button (click)="runMigration()" [disabled]="isRunningMigration()" class="mt-4 px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg disabled:opacity-50">
                  {{ isRunningMigration() ? 'â³ é·ç§»ä¸­...' : 'ğŸš€ åŸ·è¡Œæ‰€æœ‰å¾…è™•ç†é·ç§»' }}
                </button>
              </div>
            }
            
            <!-- å·²æ‡‰ç”¨é·ç§» -->
            <div>
              <h4 class="font-semibold text-slate-700 dark:text-slate-300 mb-3">âœ… å·²æ‡‰ç”¨çš„é·ç§»</h4>
              @if (migrationStatus().appliedMigrations.length > 0) {
                <div class="space-y-2 max-h-64 overflow-y-auto">
                  @for (migration of migrationStatus().appliedMigrations; track migration.version) {
                    <div class="flex items-center justify-between bg-slate-200/50 dark:bg-slate-800/50 rounded-lg p-3">
                      <div>
                        <span class="text-sm font-mono text-green-400">v{{ migration.version }}</span>
                        <span class="text-sm text-slate-600 dark:text-slate-400 ml-2">{{ migration.description }}</span>
                      </div>
                      <span class="text-xs text-slate-500">{{ migration.appliedAt }}</span>
                    </div>
                  }
                </div>
              } @else {
                <p class="text-sm text-slate-500 text-center py-4">æš«ç„¡å·²æ‡‰ç”¨çš„é·ç§»</p>
              }
            </div>
          </div>
          }
          
          @if (settingsTab() === 'logs') {
          <!-- æ—¥èªŒæ–‡ä»¶ç®¡ç† -->
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold flex items-center gap-2">
                ğŸ“œ æ—¥èªŒæ–‡ä»¶ç®¡ç†
              </h3>
              <div class="flex gap-2">
                <button (click)="rotateLogs()" [disabled]="isRotatingLogs()" class="px-4 py-2 bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 rounded-lg">
                  {{ isRotatingLogs() ? 'â³ è¼ªè½‰ä¸­...' : 'ğŸ”„ è¼ªè½‰æ—¥èªŒ' }}
                </button>
                <button (click)="loadLogFiles(); loadLogStats()" [disabled]="isLoadingLogs()" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg">
                  {{ isLoadingLogs() ? 'â³ åŠ è¼‰ä¸­...' : 'ğŸ”„ åˆ·æ–°' }}
                </button>
              </div>
            </div>
            
            <!-- æ—¥èªŒçµ±è¨ˆ -->
            <div class="grid grid-cols-4 gap-4 mb-6">
              <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-300 dark:border-slate-700">
                <div class="text-sm text-slate-500">ç¸½æ–‡ä»¶æ•¸</div>
                <div class="text-2xl font-bold text-cyan-400">{{ logStats().totalFiles }}</div>
              </div>
              <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-300 dark:border-slate-700">
                <div class="text-sm text-slate-500">ç¸½å¤§å°</div>
                <div class="text-2xl font-bold text-blue-400">{{ logStats().totalSizeFormatted }}</div>
              </div>
              <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-300 dark:border-slate-700">
                <div class="text-sm text-slate-500">å·²å£“ç¸®</div>
                <div class="text-2xl font-bold text-green-400">{{ logStats().compressedFiles }}</div>
              </div>
              <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-300 dark:border-slate-700">
                <div class="text-sm text-slate-500">æœªå£“ç¸®</div>
                <div class="text-2xl font-bold text-orange-400">{{ logStats().totalFiles - logStats().compressedFiles }}</div>
              </div>
            </div>
            
            <!-- æ—¥èªŒæ–‡ä»¶åˆ—è¡¨ -->
            <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl border border-slate-300 dark:border-slate-700 overflow-hidden">
              <table class="w-full">
                <thead class="bg-slate-300/50 dark:bg-slate-700/50">
                  <tr>
                    <th class="text-left p-3 text-sm font-semibold">æ–‡ä»¶å</th>
                    <th class="text-left p-3 text-sm font-semibold">å¤§å°</th>
                    <th class="text-left p-3 text-sm font-semibold">ä¿®æ”¹æ™‚é–“</th>
                    <th class="text-left p-3 text-sm font-semibold">é¡å‹</th>
                    <th class="text-right p-3 text-sm font-semibold">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  @for (file of logFiles(); track file.name) {
                    <tr class="border-t border-slate-300 dark:border-slate-600 hover:bg-slate-100/50 dark:hover:bg-slate-700/50">
                      <td class="p-3 font-mono text-sm">{{ file.name }}</td>
                      <td class="p-3 text-sm text-slate-600 dark:text-slate-400">{{ file.sizeFormatted }}</td>
                      <td class="p-3 text-sm text-slate-600 dark:text-slate-400">{{ file.modifiedAt }}</td>
                      <td class="p-3">
                        @if (file.isCompressed) {
                          <span class="px-2 py-1 text-xs bg-green-500/20 text-green-400 rounded-full">å£“ç¸®</span>
                        } @else {
                          <span class="px-2 py-1 text-xs bg-blue-500/20 text-blue-400 rounded-full">åŸå§‹</span>
                        }
                      </td>
                      <td class="p-3 text-right">
                        <div class="flex items-center justify-end gap-2">
                          <button (click)="viewLogFile(file.name)" class="text-cyan-400 hover:text-cyan-300 text-xs px-2 py-1 rounded hover:bg-cyan-500/10">æŸ¥çœ‹</button>
                          <button (click)="downloadLogFile(file.name)" class="text-blue-400 hover:text-blue-300 text-xs px-2 py-1 rounded hover:bg-blue-500/10">ä¸‹è¼‰</button>
                          <button (click)="deleteLogFile(file.name)" class="text-red-400 hover:text-red-300 text-xs px-2 py-1 rounded hover:bg-red-500/10">åˆªé™¤</button>
                        </div>
                      </td>
                    </tr>
                  } @empty {
                    <tr><td colspan="5" class="text-center p-8 text-slate-500">æš«ç„¡æ—¥èªŒæ–‡ä»¶</td></tr>
                  }
                </tbody>
              </table>
            </div>
            
            <!-- æ—¥èªŒå…§å®¹æŸ¥çœ‹ -->
            @if (selectedLogFile()) {
              <div class="mt-6 bg-slate-800 rounded-xl p-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="font-semibold text-white">ğŸ“„ {{ selectedLogFile() }}</h4>
                  <button (click)="selectedLogFile.set(null)" class="text-slate-400 hover:text-white">âœ• é—œé–‰</button>
                </div>
                <pre class="text-xs text-slate-300 font-mono overflow-auto max-h-64 p-3 bg-slate-900 rounded-lg">{{ logFileContent() }}</pre>
              </div>
            }
          </div>
          }
          
          @if (settingsTab() === 'scheduler') {
          <!-- ä»»å‹™èª¿åº¦ç®¡ç† -->
          <div class="bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm border border-slate-500/20 p-6 rounded-xl shadow-lg mb-8">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold flex items-center gap-2">
                â° ä»»å‹™èª¿åº¦ç®¡ç†
              </h3>
              <div class="flex gap-2">
                @if (schedulerStatus().isRunning) {
                  <button (click)="stopScheduler()" class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg">
                    â¹ï¸ åœæ­¢èª¿åº¦å™¨
                  </button>
                } @else {
                  <button (click)="startScheduler()" class="px-4 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg">
                    â–¶ï¸ å•Ÿå‹•èª¿åº¦å™¨
                  </button>
                }
                <button (click)="loadSchedulerStatus()" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg">
                  ğŸ”„ åˆ·æ–°ç‹€æ…‹
                </button>
              </div>
            </div>
            
            <!-- èª¿åº¦å™¨ç‹€æ…‹ -->
            <div class="flex items-center gap-4 mb-6 p-4 rounded-xl" 
                 [class.bg-green-500/10]="schedulerStatus().isRunning" 
                 [class.border-green-500/30]="schedulerStatus().isRunning"
                 [class.bg-slate-500/10]="!schedulerStatus().isRunning"
                 [class.border-slate-500/30]="!schedulerStatus().isRunning"
                 class="border">
              <div class="w-4 h-4 rounded-full" [class.bg-green-500]="schedulerStatus().isRunning" [class.bg-slate-500]="!schedulerStatus().isRunning" [class.animate-pulse]="schedulerStatus().isRunning"></div>
              <span class="font-semibold" [class.text-green-400]="schedulerStatus().isRunning" [class.text-slate-400]="!schedulerStatus().isRunning">
                {{ schedulerStatus().isRunning ? 'èª¿åº¦å™¨é‹è¡Œä¸­' : 'èª¿åº¦å™¨å·²åœæ­¢' }}
              </span>
            </div>
            
            <!-- ä»»å‹™åˆ—è¡¨ -->
            <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-xl border border-slate-300 dark:border-slate-700 overflow-hidden">
              <table class="w-full">
                <thead class="bg-slate-300/50 dark:bg-slate-700/50">
                  <tr>
                    <th class="text-left p-3 text-sm font-semibold">ä»»å‹™åç¨±</th>
                    <th class="text-left p-3 text-sm font-semibold">åŸ·è¡Œé–“éš”</th>
                    <th class="text-left p-3 text-sm font-semibold">ä¸Šæ¬¡åŸ·è¡Œ</th>
                    <th class="text-left p-3 text-sm font-semibold">ä¸‹æ¬¡åŸ·è¡Œ</th>
                    <th class="text-left p-3 text-sm font-semibold">åŸ·è¡Œæ¬¡æ•¸</th>
                    <th class="text-left p-3 text-sm font-semibold">ç‹€æ…‹</th>
                    <th class="text-right p-3 text-sm font-semibold">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  @for (task of schedulerStatus().tasks; track task.name) {
                    <tr class="border-t border-slate-300 dark:border-slate-600 hover:bg-slate-100/50 dark:hover:bg-slate-700/50">
                      <td class="p-3 font-semibold">{{ task.name }}</td>
                      <td class="p-3 text-sm text-slate-600 dark:text-slate-400">{{ task.interval }} ç§’</td>
                      <td class="p-3 text-sm text-slate-600 dark:text-slate-400">{{ task.lastRun || 'å¾æœª' }}</td>
                      <td class="p-3 text-sm text-slate-600 dark:text-slate-400">{{ task.nextRun || '-' }}</td>
                      <td class="p-3 text-sm text-slate-600 dark:text-slate-400">{{ task.runCount }}</td>
                      <td class="p-3">
                        @switch (task.status) {
                          @case ('running') {
                            <span class="px-2 py-1 text-xs bg-green-500/20 text-green-400 rounded-full">é‹è¡Œä¸­</span>
                          }
                          @case ('idle') {
                            <span class="px-2 py-1 text-xs bg-slate-500/20 text-slate-400 rounded-full">ç©ºé–’</span>
                          }
                          @case ('error') {
                            <span class="px-2 py-1 text-xs bg-red-500/20 text-red-400 rounded-full">éŒ¯èª¤</span>
                          }
                        }
                      </td>
                      <td class="p-3 text-right">
                        <button (click)="runSchedulerTask(task.name)" [disabled]="task.status === 'running'" class="text-cyan-400 hover:text-cyan-300 text-xs px-2 py-1 rounded hover:bg-cyan-500/10 disabled:opacity-50">
                          ç«‹å³åŸ·è¡Œ
                        </button>
                      </td>
                    </tr>
                  } @empty {
                    <tr><td colspan="7" class="text-center p-8 text-slate-500">æš«ç„¡èª¿åº¦ä»»å‹™</td></tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
          }
      }
      
      @case ('profile') {
        <!-- å€‹äººä¸­å¿ƒ -->
        <app-profile></app-profile>
      }
      
      @case ('membership-center') {
        <!-- æœƒå“¡ä¸­å¿ƒ -->
        <app-membership-center></app-membership-center>
      }
    }
  </main>

  <!-- Lead Detail Modal -->
  @if (generationState().lead; as lead) {
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
      <div class="bg-slate-100 dark:bg-slate-900/80 border border-slate-500/20 rounded-2xl shadow-2xl p-6 w-full max-w-2xl transform transition-all text-slate-800 dark:text-slate-200">
        <div class="flex justify-between items-center border-b border-slate-500/20 pb-3 mb-4">
          <h3 class="text-2xl font-semibold text-slate-900 dark:text-white">{{ t('leadDetails') }}: @{{ lead.username }}</h3>
          <button (click)="closeLeadDetailModal()" class="text-slate-400 hover:text-slate-200 text-3xl leading-none transition-colors">&times;</button>
        </div>
        <div class="border-b border-slate-500/20"><nav class="-mb-px flex space-x-6" aria-label="Tabs"><a (click)="leadDetailView.set('sendMessage')" [class.border-cyan-400]="leadDetailView() === 'sendMessage'" [class.text-cyan-400]="leadDetailView() === 'sendMessage'" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm cursor-pointer text-slate-500 hover:text-cyan-400 transition-colors">{{ t('sendMessageTab') }}</a><a (click)="leadDetailView.set('history')" [class.border-cyan-400]="leadDetailView() === 'history'" [class.text-cyan-400]="leadDetailView() === 'history'" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm cursor-pointer text-slate-500 hover:text-cyan-400 transition-colors">{{ t('historyTab') }}</a></nav></div>
        @if(leadDetailView() === 'sendMessage') {
            <div class="py-4 space-y-4">
              <!-- ç™¼é€è³¬è™Ÿé¸æ“‡å™¨ -->
              <div>
                <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('selectSenderAccount') }}</label>
                <select 
                    [ngModel]="selectedSenderId()" 
                    (ngModelChange)="selectedSenderId.set($event)"
                    class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    @if(senderAccounts().length === 0) {
                        <option value="">{{ t('noSenderAccounts') }}</option>
                    } @else {
                        @for(account of senderAccounts(); track account.id) {
                            <option [value]="account.id">{{ account.phone }} ({{ account.status }})</option>
                        }
                    }
                </select>
                @if(senderAccounts().length === 0) {
                    <p class="text-xs text-amber-400 mt-1">âš ï¸ {{ t('noSenderAccountsHint') }}</p>
                }
              </div>

              <!-- æ¶ˆæ¯è¼¸å…¥æ–¹å¼é¸æ“‡ -->
              <div class="flex items-center gap-4 p-3 bg-slate-200/30 dark:bg-slate-800/30 rounded-lg">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="messageMode" [checked]="messageMode() === 'manual'" (change)="messageMode.set('manual')" class="form-radio text-cyan-500">
                    <span class="text-sm">{{ t('manualInput') }}</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="messageMode" [checked]="messageMode() === 'ai'" (change)="messageMode.set('ai')" class="form-radio text-cyan-500">
                    <span class="text-sm">{{ t('aiGenerate') }}</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="messageMode" [checked]="messageMode() === 'template'" (change)="messageMode.set('template')" class="form-radio text-cyan-500">
                    <span class="text-sm">{{ t('useTemplate') }}</span>
                </label>
              </div>

              <!-- AI ç”Ÿæˆæ¨¡å¼ -->
              @if(messageMode() === 'ai') {
                <div class="space-y-3">
                    <!-- AI é…ç½®ç‹€æ…‹ -->
                    <div class="flex items-center justify-between p-2 bg-slate-200/30 dark:bg-slate-800/30 rounded-lg">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">ğŸ¤–</span>
                            <span class="text-sm text-slate-400">
                                {{ aiApiType() === 'local' ? 'æœ¬åœ° AI' : aiApiType() === 'openai' ? 'OpenAI' : aiApiType() === 'custom' ? 'è‡ªå®šç¾© API' : 'Gemini' }}
                            </span>
                            @if(isAiConfigured()) {
                                <span class="text-xs text-green-400">âœ“ å·²é€£æ¥</span>
                            }
                        </div>
                        @if(ragEnabled()) {
                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">ğŸ“š RAG å·²å•Ÿç”¨</span>
                        }
                    </div>
                    
                    <!-- å®¢æˆ¶è³‡è¨Šæ‘˜è¦ -->
                    @if(generationState().lead) {
                        <div class="p-2 bg-cyan-500/10 border border-cyan-500/20 rounded-lg text-xs text-slate-400">
                            <strong class="text-cyan-400">å®¢æˆ¶è³‡è¨Šï¼š</strong>
                            @{{ generationState().lead.username }} 
                            @if(generationState().lead.sourceGroup) { | ä¾†æº: {{ generationState().lead.sourceGroup }} }
                            @if(generationState().lead.triggerKeyword) { | è§¸ç™¼è©: {{ generationState().lead.triggerKeyword }} }
                        </div>
                    }
                    
                    <!-- è‡ªå®šç¾©æç¤ºè© -->
                    <div>
                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('customizePrompt') }}</label>
                        <textarea 
                            [ngModel]="generationState().customPrompt" 
                            (ngModelChange)="updateCustomPrompt($event)"
                            rows="2" 
                            class="form-textarea w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            [placeholder]="t('aiPromptPlaceholder')">
                        </textarea>
                    </div>
                    
                    <!-- ç”ŸæˆæŒ‰éˆ• -->
                    <div class="flex items-center justify-center gap-3">
                        <button (click)="generateMessage()" [disabled]="generationState().status === 'loading' || !isAiConfigured()" class="bg-gradient-to-r from-purple-500 to-cyan-500 hover:from-purple-600 hover:to-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg disabled:from-slate-400 disabled:to-slate-500 disabled:shadow-none disabled:cursor-not-allowed flex items-center gap-2">
                            @if(generationState().status === 'loading') { 
                                <span class="animate-spin">âŸ³</span> <span>{{ t('generating') }}</span> 
                            } @else { 
                                <span>âœ¨</span> <span>{{ t('generateWithAi') }}</span> 
                            }
                        </button>
                        @if(generationState().status === 'success') {
                            <button (click)="generateMessage()" class="p-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg" title="é‡æ–°ç”Ÿæˆ">
                                ğŸ”„
                            </button>
                        }
                    </div>
                    
                    @if(!isAiConfigured()) {
                        <div class="p-3 bg-amber-500/10 border border-amber-500/20 text-amber-400 rounded-lg text-sm text-center">
                            âš ï¸ {{ t('aiNotConfigured') }} 
                            <a (click)="currentView.set('settings'); closeLeadDetailModal()" class="text-cyan-400 hover:underline cursor-pointer ml-1">{{ t('goToSettings') }}</a>
                        </div>
                    }
                    
                    @if(generationState().status === 'error') {
                        <div class="p-3 bg-red-500/10 border border-red-500/20 text-red-400 rounded-lg text-sm">
                            <strong>{{ t('error') }}:</strong> {{ generationState().error }}
                            <button (click)="generateMessage()" class="ml-2 text-cyan-400 hover:underline">é‡è©¦</button>
                        </div>
                    }
                    
                    <!-- ç”ŸæˆæˆåŠŸæç¤º -->
                    @if(generationState().status === 'success' && generationState().generatedMessage) {
                        <div class="p-3 bg-green-500/10 border border-green-500/20 rounded-lg">
                            <p class="text-xs text-green-400 mb-2">âœ“ AI å·²ç”Ÿæˆæ¶ˆæ¯ï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹æ–¹ç·¨è¼¯å¾Œç™¼é€</p>
                        </div>
                    }
                </div>
              }

              <!-- æ¨¡æ¿é¸æ“‡æ¨¡å¼ -->
              @if(messageMode() === 'template') {
                <div>
                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('selectTemplate') }}</label>
                    <select 
                        (change)="applyTemplate($event)"
                        class="form-select w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <option value="">{{ t('selectTemplatePlaceholder') }}</option>
                        @for(template of messageTemplates(); track template.id) {
                            <option [value]="template.id">{{ template.name }}</option>
                        }
                    </select>
                </div>
              }

              <!-- æ¶ˆæ¯å…§å®¹ç·¨è¼¯å€ -->
              <div>
                <div class="flex items-center justify-between mb-1">
                    <label class="text-sm font-medium text-slate-500 dark:text-slate-400">{{ t('messageContent') }}</label>
                    <span class="text-xs text-slate-500">{{ editableMessage().length }} {{ t('characters') }}</span>
                </div>
                <textarea 
                    [ngModel]="editableMessage()" 
                    (ngModelChange)="editableMessage.set($event)"
                    rows="4" 
                    class="form-textarea w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-3 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 resize-none"
                    [placeholder]="t('messageContentPlaceholder')">
                </textarea>
              </div>

              <!-- é™„ä»¶å€åŸŸ -->
              <div class="flex items-center gap-4">
                <button (click)="imageUpload.click()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm font-medium py-2 px-4 rounded-lg transition duration-200">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    {{ t('attachImage') }}
                </button>
                <input #imageUpload type="file" (change)="onFileAttached($event, 'image')" accept="image/*" class="hidden">
                <button (click)="fileUpload.click()" class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800/50 hover:bg-slate-300 dark:hover:bg-slate-700/50 text-sm font-medium py-2 px-4 rounded-lg transition duration-200">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    {{ t('attachFile') }}
                </button>
                <input #fileUpload type="file" (change)="onFileAttached($event, 'file')" class="hidden">
              </div>
              @if(generationState().attachment; as attachment) {
                <div class="p-2 rounded-lg bg-slate-200/50 dark:bg-slate-800/50 flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2 truncate">
                       @if(attachment.type === 'image') { <svg class="h-4 w-4 flex-shrink-0 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg> }
                       @else { <svg class="h-4 w-4 flex-shrink-0 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg> }
                       <span class="truncate">{{ attachment.name }}</span>
                    </div>
                    <button (click)="removeAttachment()" class="text-red-400 hover:text-red-300 text-lg font-bold">&times;</button>
                </div>
              }

              <!-- åº•éƒ¨æ“ä½œæŒ‰éˆ• -->
              <div class="flex justify-between items-center pt-4 border-t border-slate-500/20">
                <button (click)="addToDoNotContact(lead.id)" [disabled]="lead.doNotContact" class="text-xs text-red-400 hover:text-red-300 disabled:text-slate-500 disabled:cursor-not-allowed flex items-center gap-1">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
                    {{ lead.doNotContact ? t('userOnDNC') : t('addToDNC') }}
                </button>
                <div class="flex gap-3">
                    <button (click)="closeLeadDetailModal()" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-white font-semibold py-2.5 px-5 rounded-lg transition-colors">
                        {{ t('cancel') }}
                    </button>
                    <button 
                        (click)="sendMessageToLead()" 
                        [disabled]="!canSendMessage() || lead.doNotContact" 
                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg shadow-green-500/20 disabled:bg-slate-400 disabled:dark:bg-slate-600 disabled:shadow-none disabled:cursor-not-allowed flex items-center gap-2 transition-all">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        {{ t('sendMessage') }}
                    </button>
                </div>
              </div>
            </div>
        }
        @if(leadDetailView() === 'history') {
            <div class="py-4">
                <!-- åŠ è¼‰å®Œæ•´èŠå¤©è¨˜éŒ„æŒ‰éˆ• -->
                <div class="mb-4 flex items-center justify-between">
                    <button 
                        (click)="loadChatHistory(lead.userId)" 
                        [disabled]="isLoadingChatHistory()"
                        class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm disabled:bg-slate-500 disabled:cursor-not-allowed flex items-center gap-2">
                        @if(isLoadingChatHistory()) {
                            <span class="animate-spin">âŸ³</span> <span>åŠ è¼‰ä¸­...</span>
                        } @else {
                            <span>ğŸ’¬</span> <span>åŠ è¼‰å®Œæ•´èŠå¤©è¨˜éŒ„</span>
                        }
                    </button>
                    @if(selectedChatUserId() === lead.userId && chatHistory().length > 0) {
                        <span class="text-xs text-slate-500">å…± {{ chatHistory().length }} æ¢æ¶ˆæ¯</span>
                    }
                </div>
                
                <!-- å®Œæ•´èŠå¤©è¨˜éŒ„ï¼ˆå¦‚æœå·²åŠ è¼‰ï¼‰ -->
                @if(selectedChatUserId() === lead.userId && chatHistory().length > 0) {
                    <div 
                        class="h-96 overflow-y-auto space-y-3 mb-4 bg-slate-200/30 dark:bg-slate-800/30 rounded-lg p-4"
                        (scroll)="onChatHistoryScroll($event)">
                        @for(message of chatHistory(); track trackByChatMessageId($index, message)) {
                            @if(message.role === 'user') {
                                <!-- ç”¨æˆ¶æ¶ˆæ¯ï¼ˆå·¦å´ï¼‰ -->
                                <div class="flex justify-start">
                                    <div class="max-w-[75%]">
                                        <div class="bg-slate-700 text-white rounded-2xl rounded-bl-sm px-4 py-2">
                                            <p class="text-sm">{{ message.content }}</p>
                                        </div>
                                        <p class="text-xs text-slate-500 mt-1">{{ formatTimestamp(message.timestamp) }}</p>
                                    </div>
                                </div>
                            } @else if(message.role === 'assistant') {
                                <!-- AI å›å¾©ï¼ˆå³å´ï¼‰ -->
                                <div class="flex justify-end">
                                    <div class="max-w-[75%]">
                                        <div class="bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-2xl rounded-br-sm px-4 py-2 shadow-lg">
                                            <p class="text-sm">{{ message.content }}</p>
                                        </div>
                                        <div class="flex items-center justify-end gap-2 mt-1">
                                            <span class="text-xs text-slate-500">{{ formatTimestamp(message.timestamp) }}</span>
                                            <span class="text-xs bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded">ğŸ¤– AI</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        
                        <!-- åŠ è¼‰æ›´å¤šæŒ‡ç¤ºå™¨ -->
                        @if(chatHistoryLoadingMore()) {
                            <div class="text-center py-4">
                                <span class="animate-spin text-cyan-400">âŸ³</span>
                                <span class="ml-2 text-sm text-slate-500">åŠ è¼‰ä¸­...</span>
                            </div>
                        }
                        
                        @if(chatHistoryHasMore() && !chatHistoryLoadingMore()) {
                            <div class="text-center py-2">
                                <button 
                                    (click)="loadMoreChatHistory()"
                                    class="text-sm text-cyan-400 hover:text-cyan-300">
                                    åŠ è¼‰æ›´å¤šæ¶ˆæ¯
                                </button>
                            </div>
                        }
                    </div>
                }
                
                <!-- äº’å‹•æ­·å²ï¼ˆåŸæœ‰é¡¯ç¤ºï¼‰ -->
                <div class="h-96 overflow-y-auto">
                    <div class="space-y-3 mb-4">
                        @for(item of lead.interactionHistory; track trackByChatMessageId($index, item)) {
                        @if(item.type.includes('Sent') || item.type.includes('Message')) {
                            <!-- æˆ‘æ–¹æ¶ˆæ¯ï¼ˆå³å´ï¼‰ -->
                            <div class="flex justify-end">
                                <div class="max-w-[75%]">
                                    <div class="bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-2xl rounded-br-sm px-4 py-2 shadow-lg">
                                        <p class="text-sm">{{ item.content }}</p>
                                    </div>
                                    <div class="flex items-center justify-end gap-2 mt-1">
                                        <span class="text-xs text-slate-500">{{ formatTimestamp(item.timestamp) }}</span>
                                        @if(item.type.includes('AI')) {
                                            <span class="text-xs bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded">ğŸ¤– AI</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        } @else if(item.type.includes('Reply') || item.type.includes('Received')) {
                            <!-- å°æ–¹å›å¾©ï¼ˆå·¦å´ï¼‰ -->
                            <div class="flex justify-start">
                                <div class="max-w-[75%]">
                                    <div class="bg-slate-700 text-white rounded-2xl rounded-bl-sm px-4 py-2">
                                        <p class="text-sm">{{ item.content }}</p>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">{{ formatTimestamp(item.timestamp) }}</p>
                                </div>
                            </div>
                        } @else {
                            <!-- ç³»çµ±æ¶ˆæ¯ï¼ˆå±…ä¸­ï¼‰ -->
                            <div class="flex justify-center">
                                <div class="bg-slate-800/50 text-slate-400 text-xs px-3 py-1 rounded-full">
                                    {{ item.type }}: {{ item.content }} Â· {{ formatTimestamp(item.timestamp) }}
                                </div>
                            </div>
                        }
                    }
                </div>
                </div>
                
                @if(lead.interactionHistory.length === 0 && (!selectedChatUserId() || chatHistory().length === 0)) { 
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">ğŸ’¬</div>
                        <p class="text-slate-500 dark:text-slate-400">{{ t('noHistoryFound') }}</p>
                        <p class="text-xs text-slate-500 mt-2">é»æ“Šã€ŒåŠ è¼‰å®Œæ•´èŠå¤©è¨˜éŒ„ã€æŸ¥çœ‹æ‰€æœ‰å°è©±</p>
                    </div>
                }
                
                <!-- AI åˆ†æé¢æ¿ -->
                @if(lead.interactionHistory.length > 0) {
                    <div class="mt-4 p-3 bg-slate-800/50 rounded-lg border border-cyan-500/20">
                        <h4 class="text-sm font-medium text-cyan-400 mb-2 flex items-center gap-2">
                            <span>ğŸ“Š</span> AI å°è©±åˆ†æ
                        </h4>
                        <div class="grid grid-cols-3 gap-2 text-center text-xs">
                            <div class="p-2 bg-slate-700/50 rounded">
                                <p class="text-slate-400">ç¸½äº’å‹•</p>
                                <p class="text-lg font-bold text-white">{{ lead.interactionHistory.length }}</p>
                            </div>
                            <div class="p-2 bg-slate-700/50 rounded">
                                <p class="text-slate-400">å°è©±éšæ®µ</p>
                                <p class="text-sm font-bold text-cyan-400">{{ lead.status || 'åˆæ¬¡æ¥è§¸' }}</p>
                            </div>
                            <div class="p-2 bg-slate-700/50 rounded">
                                <p class="text-slate-400">èˆˆè¶£ç¨‹åº¦</p>
                                <p class="text-lg">â­â­â­</p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
      </div>
    </div>
  }

  <!-- æ‰¹é‡æ“ä½œæ­·å²å°è©±æ¡† -->
  @if(showBatchOperationHistory()) {
    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" (click)="showBatchOperationHistory.set(false)">
      <div class="bg-slate-100 dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-300 dark:border-slate-700 w-full max-w-3xl max-h-[80vh] overflow-hidden" (click)="$event.stopPropagation()">
        <!-- æ¨™é¡Œ -->
        <div class="p-4 border-b border-slate-300 dark:border-slate-700 flex items-center justify-between bg-slate-200/50 dark:bg-slate-800/50">
          <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
            <svg class="h-5 w-5 text-purple-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>
            æ‰¹é‡æ“ä½œæ­·å²
          </h3>
          <button (click)="showBatchOperationHistory.set(false)" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-white">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        
        <!-- å…§å®¹ -->
        <div class="p-4 overflow-y-auto max-h-[60vh]">
          @if(batchOperationHistory().length === 0) {
            <div class="text-center py-8 text-slate-500">
              <svg class="h-12 w-12 mx-auto mb-3 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
              <p>æš«ç„¡æ“ä½œæ­·å²</p>
            </div>
          } @else {
            <div class="space-y-3">
              @for(op of batchOperationHistory(); track op.id) {
                <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-lg p-3 border border-slate-300 dark:border-slate-700"
                     [class.opacity-50]="op.reversed">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <div class="p-2 rounded-lg" 
                           [class.bg-cyan-500/20]="op.operationType === 'update_status'"
                           [class.bg-blue-500/20]="op.operationType === 'add_tag'"
                           [class.bg-red-500/20]="op.operationType === 'delete' || op.operationType === 'add_to_dnc'">
                        <svg class="h-4 w-4" 
                             [class.text-cyan-400]="op.operationType === 'update_status'"
                             [class.text-blue-400]="op.operationType === 'add_tag'"
                             [class.text-red-400]="op.operationType === 'delete' || op.operationType === 'add_to_dnc'"
                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                      </div>
                      <div>
                        <p class="font-medium text-slate-900 dark:text-white">{{ getOperationTypeName(op.operationType) }}</p>
                        <p class="text-xs text-slate-500">
                          {{ op.itemCount }} é … Â· {{ formatBatchOperationDate(op.createdAt) }}
                          @if(op.reversed) {
                            <span class="text-yellow-500 ml-2">ï¼ˆå·²æ’¤éŠ·ï¼‰</span>
                          }
                        </p>
                      </div>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="text-sm">
                        <span class="text-green-400">{{ op.successCount }} æˆåŠŸ</span>
                        @if(op.failureCount > 0) {
                          <span class="text-red-400 ml-2">{{ op.failureCount }} å¤±æ•—</span>
                        }
                      </div>
                      @if(op.isReversible && !op.reversed) {
                        <button (click)="undoBatchOperation(op.id)" 
                                class="text-xs bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 px-2 py-1 rounded">
                          æ’¤éŠ·
                        </button>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
        
        <!-- åº•éƒ¨ -->
        <div class="p-4 border-t border-slate-300 dark:border-slate-700 bg-slate-200/50 dark:bg-slate-800/50 flex justify-end">
          <button (click)="showBatchOperationHistory.set(false)" 
                  class="px-4 py-2 bg-slate-300 dark:bg-slate-700 hover:bg-slate-400 dark:hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors">
            é—œé–‰
          </button>
        </div>
      </div>
    </div>
  }
  
  <!-- é¦–æ¬¡å•Ÿå‹•æ­¡è¿å‘å° -->
  @if (showWelcomeDialog()) {
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100]">
      <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden border border-cyan-500/30">
        
        <!-- é ­éƒ¨ -->
        <div class="bg-gradient-to-r from-cyan-500 to-purple-500 p-6 text-center">
          <h1 class="text-3xl font-bold text-white mb-2">ğŸš€ æ­¡è¿ä½¿ç”¨ TG-AIæ™ºæ§ç‹</h1>
          <p class="text-cyan-100">AI é©…å‹•çš„ Telegram ç‡ŸéŠ·è‡ªå‹•åŒ–å¹³å°</p>
        </div>
        
        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div class="flex justify-center gap-2 py-4 bg-slate-800/50">
          <div class="w-3 h-3 rounded-full transition-all" 
               [class]="welcomeStep() >= 1 ? 'bg-cyan-500' : 'bg-slate-600'"></div>
          <div class="w-3 h-3 rounded-full transition-all" 
               [class]="welcomeStep() >= 2 ? 'bg-cyan-500' : 'bg-slate-600'"></div>
          <div class="w-3 h-3 rounded-full transition-all" 
               [class]="welcomeStep() >= 3 ? 'bg-cyan-500' : 'bg-slate-600'"></div>
        </div>
        
        <!-- å…§å®¹å€åŸŸ -->
        <div class="p-6">
          @switch (welcomeStep()) {
            @case (1) {
              <!-- æ­¥é©Ÿ 1: æ­¡è¿ä»‹ç´¹ -->
              <div class="text-center space-y-6">
                <div class="grid grid-cols-3 gap-4 mb-6">
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <div class="text-3xl mb-2">ğŸ¤–</div>
                    <div class="text-sm font-medium text-white">AI è‡ªå‹•å›è¦†</div>
                    <div class="text-xs text-slate-400">æ™ºèƒ½å®¢æœåŠ©æ‰‹</div>
                  </div>
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <div class="text-3xl mb-2">ğŸ”</div>
                    <div class="text-sm font-medium text-white">è³‡æºç™¼ç¾</div>
                    <div class="text-xs text-slate-400">è‡ªå‹•æœç´¢ç¾¤çµ„</div>
                  </div>
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <div class="text-3xl mb-2">ğŸ“Š</div>
                    <div class="text-sm font-medium text-white">æ•¸æ“šåˆ†æ</div>
                    <div class="text-xs text-slate-400">è½‰åŒ–è¿½è¹¤å ±è¡¨</div>
                  </div>
                </div>
                
                <p class="text-slate-300">
                  TG-AIæ™ºæ§ç‹ å°‡å¹«åŠ©æ‚¨è‡ªå‹•åŒ– Telegram ç‡ŸéŠ·æµç¨‹ï¼Œ<br>
                  è®“æ‚¨å°ˆæ³¨æ–¼æ¥­å‹™å¢é•·è€Œéé‡è¤‡æ“ä½œã€‚
                </p>
              </div>
            }
            @case (2) {
              <!-- æ­¥é©Ÿ 2: AI è¨­ç½® -->
              <div class="space-y-4">
                <h3 class="text-lg font-semibold text-white text-center mb-4">ğŸ¦™ AI æœå‹™é…ç½®</h3>
                
                <!-- Ollama æª¢æ¸¬ç‹€æ…‹ -->
                <div class="p-4 rounded-xl" 
                     [class]="ollamaDetected() ? 'bg-green-500/20 border border-green-500/30' : 'bg-yellow-500/20 border border-yellow-500/30'">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">{{ ollamaDetected() ? 'âœ…' : 'âš ï¸' }}</span>
                      <div>
                        <div class="font-medium text-white">
                          {{ ollamaDetected() ? 'Ollama å·²æª¢æ¸¬åˆ°' : 'Ollama æœªé‹è¡Œ' }}
                        </div>
                        <div class="text-sm text-slate-400">
                          {{ ollamaDetected() ? 'æœ¬åœ° AI æœå‹™å¯ç”¨' : 'å»ºè­°å®‰è£ Ollama ç²å¾—å…è²» AI èƒ½åŠ›' }}
                        </div>
                      </div>
                    </div>
                    <button (click)="detectOllama()" [disabled]="isDetectingOllama()"
                            class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm text-white disabled:opacity-50">
                      {{ isDetectingOllama() ? 'æª¢æ¸¬ä¸­...' : 'é‡æ–°æª¢æ¸¬' }}
                    </button>
                  </div>
                </div>
                
                @if (ollamaDetected()) {
                  <!-- æ¨¡å‹é¸æ“‡ -->
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <label class="block text-sm font-medium text-slate-300 mb-2">é¸æ“‡ AI æ¨¡å‹</label>
                    @if (detectedOllamaModels().length > 0) {
                      <select [ngModel]="localAiModel()" (ngModelChange)="localAiModel.set($event)"
                              class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2 px-3 text-white">
                        @for (model of detectedOllamaModels(); track model) {
                          <option [value]="model">{{ model }}</option>
                        }
                      </select>
                    } @else {
                      <input [ngModel]="localAiModel()" (ngModelChange)="localAiModel.set($event)"
                             class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2 px-3 text-white"
                             placeholder="qwen2:7b">
                    }
                    <p class="text-xs text-slate-500 mt-1">æ¨è–¦ï¼šqwen2:7bï¼ˆä¸­è‹±æ–‡é€šç”¨ï¼‰</p>
                  </div>
                } @else {
                  <!-- Ollama å®‰è£æŒ‡å— -->
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <div class="text-sm text-slate-300 space-y-2">
                      <p class="font-medium">ğŸ“¦ å®‰è£ Ollamaï¼ˆå…è²»ï¼‰ï¼š</p>
                      <code class="block bg-slate-800 p-2 rounded text-cyan-400 text-xs">
                        curl -fsSL https://ollama.com/install.sh | sh
                      </code>
                      <p class="text-xs text-slate-500">
                        å®‰è£å¾Œé‹è¡Œ <code class="text-cyan-400">ollama pull qwen2:7b</code> ä¸‹è¼‰æ¨¡å‹
                      </p>
                    </div>
                  </div>
                  
                  <!-- å‚™é¸ï¼šé›²ç«¯ AI -->
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" [checked]="aiAutoFallback()" (change)="aiAutoFallback.set(!aiAutoFallback())"
                             class="w-4 h-4 text-cyan-500 rounded">
                      <span class="text-sm text-slate-300">ä½¿ç”¨é›²ç«¯ AI ä½œç‚ºå‚™é¸</span>
                    </label>
                    @if (aiAutoFallback()) {
                      <div class="mt-2">
                        <select [ngModel]="aiBackupProvider()" (ngModelChange)="aiBackupProvider.set($event)"
                                class="w-full bg-slate-800 border border-slate-600 rounded py-1 px-2 text-sm text-white">
                          <option value="gemini">Google Geminiï¼ˆå…è²»é¡åº¦ï¼‰</option>
                          <option value="openai">OpenAI GPT</option>
                        </select>
                      </div>
                    }
                  </div>
                }
              </div>
            }
            @case (3) {
              <!-- æ­¥é©Ÿ 3: å®Œæˆ -->
              <div class="text-center space-y-6">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <h3 class="text-2xl font-bold text-white">è¨­ç½®å®Œæˆï¼</h3>
                <p class="text-slate-300">
                  æ‚¨å·²æº–å‚™å¥½é–‹å§‹ä½¿ç”¨ TG-AIæ™ºæ§ç‹ã€‚<br>
                  æ¥ä¸‹ä¾†è«‹æ·»åŠ æ‚¨çš„ç¬¬ä¸€å€‹ Telegram å¸³è™Ÿã€‚
                </p>
                
                <div class="p-4 bg-cyan-500/10 rounded-xl border border-cyan-500/30">
                  <div class="text-sm text-slate-300 space-y-1">
                    <p>âœ… AI æœå‹™ï¼š{{ ollamaDetected() ? 'Ollama æœ¬åœ° AI' : 'é›²ç«¯ AI' }}</p>
                    @if (ollamaDetected()) {
                      <p>âœ… æ¨¡å‹ï¼š{{ localAiModel() }}</p>
                    }
                    <p>âœ… è‡ªå‹•é™ç´šï¼š{{ aiAutoFallback() ? 'å·²å•Ÿç”¨' : 'å·²ç¦ç”¨' }}</p>
                  </div>
                </div>
              </div>
            }
          }
        </div>
        
        <!-- åº•éƒ¨æŒ‰éˆ• -->
        <div class="p-6 bg-slate-800/50 flex justify-between items-center">
          <button (click)="skipFirstRunSetup()" class="text-sm text-slate-400 hover:text-white transition-colors">
            è·³éè¨­ç½®
          </button>
          
          <div class="flex gap-3">
            @if (welcomeStep() > 1) {
              <button (click)="welcomeStep.set(welcomeStep() - 1)"
                      class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                ä¸Šä¸€æ­¥
              </button>
            }
            
            @if (welcomeStep() < 3) {
              <button (click)="welcomeStep.set(welcomeStep() + 1)"
                      class="px-6 py-2 bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600 text-white font-medium rounded-lg transition-all">
                ä¸‹ä¸€æ­¥
              </button>
            } @else {
              <button (click)="completeFirstRunSetup()"
                      class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-medium rounded-lg transition-all">
                é–‹å§‹ä½¿ç”¨ ğŸš€
              </button>
            }
          </div>
        </div>
      </div>
    </div>
  }
  
  <!-- å­¤ç«‹ Session æ¢å¾©å°è©±æ¡† -->
  @if (showOrphanSessionDialog()) {
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100]">
      <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden border border-amber-500/50">
        
        <!-- é ­éƒ¨ -->
        <div class="bg-amber-500/20 p-6 text-center border-b border-amber-500/30">
          <div class="text-5xl mb-3">ğŸ”„</div>
          <h2 class="text-xl font-bold text-amber-400">ç™¼ç¾å¯æ¢å¾©çš„å¸³è™Ÿ</h2>
          <p class="text-slate-400 text-sm mt-2">
            ç™¼ç¾ {{ orphanSessions().length }} å€‹ Session æ–‡ä»¶éœ€è¦æ‰‹å‹•æ¢å¾©
          </p>
        </div>
        
        <!-- å…§å®¹ -->
        <div class="p-6 space-y-4">
          <p class="text-slate-300 text-sm">
            é€™äº› Session æ–‡ä»¶å­˜åœ¨æ–¼ç³»çµ±ä¸­ï¼Œä½†æœªåœ¨æ•¸æ“šåº«ä¸­æ‰¾åˆ°å°æ‡‰çš„å¸³è™Ÿè¨˜éŒ„ã€‚
            æ‚¨å¯ä»¥å˜—è©¦æ¢å¾©é€™äº›å¸³è™Ÿï¼Œæˆ–é¸æ“‡å¿½ç•¥ã€‚
          </p>
          
          <!-- Session åˆ—è¡¨ -->
          <div class="bg-slate-700/50 rounded-lg p-3 max-h-48 overflow-y-auto space-y-2">
            @for (session of orphanSessions(); track session.phone) {
              <div class="flex items-center justify-between p-2 bg-slate-600/50 rounded-lg">
                <div class="flex items-center gap-3">
                  <span class="text-2xl">ğŸ“±</span>
                  <div>
                    <p class="text-white font-medium">+{{ session.phone }}</p>
                    @if (session.hasMetadata && session.metadata) {
                      <p class="text-green-400 text-xs">
                        âœ“ æœ‰å…ƒæ•¸æ“š: {{ session.metadata.firstName || '' }} {{ session.metadata.username ? '@' + session.metadata.username : '' }}
                      </p>
                    } @else {
                      <p class="text-amber-400 text-xs">âš  ç„¡å…ƒæ•¸æ“šï¼Œéœ€è¦é‡æ–°ç™»éŒ„é©—è­‰</p>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
          
          <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3">
            <p class="text-blue-400 text-sm">
              ğŸ’¡ <strong>æç¤ºï¼š</strong> æ¢å¾©å¾Œï¼Œå¸³è™Ÿå°‡ä»¥ã€Œé›¢ç·šã€ç‹€æ…‹æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚
              æ‚¨éœ€è¦é»æ“Šã€Œç™»éŒ„ã€ä¾†é‡æ–°é€£æ¥å¸³è™Ÿã€‚
            </p>
          </div>
        </div>
        
        <!-- åº•éƒ¨æŒ‰éˆ• -->
        <div class="p-4 bg-slate-700/30 flex justify-end gap-3">
          <button (click)="dismissOrphanSessionDialog()" 
                  class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors">
            ç¨å¾Œè™•ç†
          </button>
          <button (click)="recoverOrphanSessions()" 
                  [disabled]="isRecoveringOrphanSessions()"
                  class="px-4 py-2 bg-amber-500 hover:bg-amber-600 disabled:opacity-50 text-white rounded-lg transition-colors flex items-center gap-2">
            @if (isRecoveringOrphanSessions()) {
              <span class="animate-spin">â³</span>
              <span>æ¢å¾©ä¸­...</span>
            } @else {
              <span>ğŸ”„</span>
              <span>æ¢å¾©å¸³è™Ÿ</span>
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- å¾Œç«¯éŒ¯èª¤æç¤ºå°è©±æ¡† -->
  @if (showBackendErrorDialog()) {
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100]">
      <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden border border-red-500/50">
        
        <!-- é ­éƒ¨ -->
        <div class="bg-red-500/20 p-6 text-center border-b border-red-500/30">
          <div class="text-5xl mb-3">âš ï¸</div>
          <h2 class="text-xl font-bold text-red-400">Python å¾Œç«¯æœªé‹è¡Œ</h2>
        </div>
        
        <!-- å…§å®¹ -->
        <div class="p-6 space-y-4">
          <p class="text-slate-300">
            ç¨‹åºéœ€è¦ Python ç’°å¢ƒæ‰èƒ½æ­£å¸¸é‹è¡Œã€‚è«‹ç¢ºä¿ï¼š
          </p>
          
          <div class="bg-slate-700/50 rounded-lg p-4 space-y-3">
            <div class="flex items-start gap-3">
              <span class="text-cyan-400">1.</span>
              <div>
                <p class="text-white font-medium">å®‰è£ Python 3.9+</p>
                <a href="https://www.python.org/downloads/" target="_blank" 
                   class="text-cyan-400 text-sm hover:underline">
                  https://www.python.org/downloads/
                </a>
              </div>
            </div>
            
            <div class="flex items-start gap-3">
              <span class="text-cyan-400">2.</span>
              <div>
                <p class="text-white font-medium">å®‰è£æ™‚å‹¾é¸ "Add Python to PATH"</p>
                <p class="text-slate-400 text-sm">ç¢ºä¿ Python æ·»åŠ åˆ°ç³»çµ±ç’°å¢ƒè®Šé‡</p>
              </div>
            </div>
            
            <div class="flex items-start gap-3">
              <span class="text-cyan-400">3.</span>
              <div>
                <p class="text-white font-medium">å®‰è£ä¾è³´</p>
                <code class="block bg-slate-800 text-green-400 text-sm p-2 rounded mt-1">
                  pip install pyrogram tgcrypto aiosqlite
                </code>
              </div>
            </div>
            
            <div class="flex items-start gap-3">
              <span class="text-cyan-400">4.</span>
              <div>
                <p class="text-white font-medium">é‡æ–°å•Ÿå‹•ç¨‹åº</p>
              </div>
            </div>
          </div>
          
          @if (backendError()) {
            <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
              <p class="text-red-400 text-sm">
                <span class="font-medium">éŒ¯èª¤è©³æƒ…ï¼š</span>
                {{ backendError() }}
              </p>
            </div>
          }
        </div>
        
        <!-- åº•éƒ¨æŒ‰éˆ• -->
        <div class="p-4 bg-slate-700/30 flex justify-end gap-3">
          <button (click)="showBackendErrorDialog.set(false)" 
                  class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors">
            æˆ‘çŸ¥é“äº†
          </button>
        </div>
      </div>
    </div>
  }
  
    <!-- å¾Œç«¯ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    @if (!backendRunning()) {
      <div class="fixed bottom-4 right-4 z-50 bg-red-500/90 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 cursor-pointer hover:bg-red-600"
           (click)="showBackendErrorDialog.set(true)">
        <span class="animate-pulse">âš ï¸</span>
        <span class="text-sm font-medium">Python å¾Œç«¯æœªé‹è¡Œ</span>
      </div>
    }
    
    <!-- å‰µå»ºé—œéµè©é›†å°è©±æ¡† -->
    @if (showKeywordSetCreator()) {
      <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100]"
           (click)="cancelNewKeywordSet()">
        <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden border border-cyan-500/30"
             (click)="$event.stopPropagation()">
          
          <!-- é ­éƒ¨ -->
          <div class="bg-gradient-to-r from-cyan-500/20 to-blue-500/20 p-4 border-b border-slate-700/50">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
              <span>ğŸ”‘</span> å‰µå»ºé—œéµè©é›†
            </h2>
          </div>
          
          <!-- å…§å®¹ -->
          <div class="p-6">
            <label class="block text-sm text-slate-400 mb-2">é—œéµè©é›†åç¨±</label>
            <input type="text" 
                   class="w-full bg-slate-900/50 border border-slate-600 rounded-lg px-4 py-3 text-white 
                          focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-colors"
                   placeholder="ä¾‹å¦‚ï¼šè²·å®¶æ„å‘ã€ç”¢å“è«®è©¢..."
                   [value]="newKeywordSet().name"
                   (input)="newKeywordSet.set({ name: $any($event.target).value })"
                   (keyup.enter)="submitNewKeywordSet()"
                   autofocus>
            <p class="text-xs text-slate-500 mt-2">
              ğŸ’¡ å‰µå»ºå¾Œå¯åœ¨è©é›†ä¸­æ·»åŠ å¤šå€‹é—œéµè©
            </p>
          </div>
          
          <!-- åº•éƒ¨æŒ‰éˆ• -->
          <div class="p-4 bg-slate-700/30 flex justify-end gap-3">
            <button (click)="cancelNewKeywordSet()" 
                    class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors">
              å–æ¶ˆ
            </button>
            <button (click)="submitNewKeywordSet()" 
                    class="px-4 py-2 bg-cyan-500 hover:bg-cyan-400 text-white rounded-lg transition-colors font-medium">
              å‰µå»º
            </button>
          </div>
        </div>
      </div>
    }
  </div>
} <!-- çµæŸ @if (isAuthenticated()) -->