<!-- ğŸ†• å…¨å±€ç¶²çµ¡ç‹€æ…‹å’Œèªè­‰éæ¸¡å‹•ç•« -->
<app-network-status></app-network-status>
<app-auth-transition></app-auth-transition>

<!-- å…¨å±€é€šçŸ¥å’Œå°è©±æ¡† -->
<app-toast></app-toast>
<app-global-confirm-dialog></app-global-confirm-dialog>
<app-global-input-dialog></app-global-input-dialog>

<!-- ğŸ†• P2 å„ªåŒ–ï¼šæ™ºèƒ½é€£æ¥ç‹€æ…‹æŒ‡ç¤ºå™¨ï¼ˆæ”¯æŒé›¢ç·šæ¨¡å¼ï¼‰ -->
@if (backendConnectionState() !== 'connected' || !offlineCache.isOnline()) {
  <div class="fixed bottom-4 right-4 z-50">
    <!-- ğŸ†• P2-2: é›¢ç·šæ¨¡å¼ï¼šç°é» -->
    @if (!offlineCache.isOnline()) {
      <div class="group relative">
        <div class="w-3 h-3 rounded-full bg-slate-500 cursor-default"></div>
        <div class="absolute bottom-full right-0 mb-2 hidden group-hover:block">
          <div class="bg-slate-800/95 backdrop-blur-sm rounded-lg px-3 py-2 shadow-lg border border-slate-700 whitespace-nowrap">
            <p class="text-xs text-slate-400">ğŸ“´ é›¢ç·šæ¨¡å¼</p>
            @if (offlineCache.isCacheValid()) {
              <p class="text-xs text-slate-500 mt-1">ä½¿ç”¨ç·©å­˜æ•¸æ“š</p>
            }
            @if (offlineCache.hasPendingOperations()) {
              <p class="text-xs text-amber-400 mt-1">{{ offlineCache.pendingOperations().length }} å€‹å¾…åŒæ­¥æ“ä½œ</p>
            }
          </div>
        </div>
      </div>
    }
    
    <!-- é€£æ¥ä¸­ï¼šå°è—é» -->
    @else if (backendConnectionState() === 'connecting') {
      <div class="group relative">
        <div class="w-3 h-3 rounded-full bg-cyan-500 animate-pulse cursor-default"></div>
        <div class="absolute bottom-full right-0 mb-2 hidden group-hover:block">
          <div class="bg-slate-800/95 backdrop-blur-sm rounded-lg px-3 py-2 shadow-lg border border-slate-700 whitespace-nowrap">
            <p class="text-xs text-slate-300">{{ backendConnectionMessage() }}</p>
          </div>
        </div>
      </div>
    }
    
    <!-- é™ç´šæ¨¡å¼ï¼šå°é»ƒé» -->
    @else if (backendConnectionState() === 'timeout') {
      <div class="group relative">
        <div class="w-3 h-3 rounded-full bg-amber-500 cursor-pointer" (click)="retryConnection()"></div>
        <div class="absolute bottom-full right-0 mb-2 hidden group-hover:block">
          <div class="bg-slate-800/95 backdrop-blur-sm rounded-lg px-3 py-2 shadow-lg border border-slate-700 whitespace-nowrap">
            <p class="text-xs text-amber-400">é™ç´šæ¨¡å¼ï¼ˆé»æ“Šé‡é€£ï¼‰</p>
          </div>
        </div>
      </div>
    }
    
    <!-- éŒ¯èª¤ï¼šå°ç´…é» -->
    @else if (backendConnectionState() === 'error') {
      <div class="group relative">
        <div class="w-3 h-3 rounded-full bg-red-500 cursor-pointer animate-pulse" (click)="retryConnection()"></div>
        <div class="absolute bottom-full right-0 mb-2 hidden group-hover:block">
          <div class="bg-slate-800/95 backdrop-blur-sm rounded-lg px-3 py-2 shadow-lg border border-slate-700 whitespace-nowrap">
            <p class="text-xs text-red-400">{{ backendConnectionMessage() }}</p>
            <p class="text-xs text-slate-500 mt-1">é»æ“Šé‡è©¦</p>
          </div>
        </div>
      </div>
    }
  </div>
}

<!-- ğŸ†• æˆåŠŸå‹•ç•«è¦†è“‹å±¤ -->
@if (showSuccessOverlay()) {
  <div class="fixed inset-0 z-[100] flex items-center justify-center pointer-events-none">
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="absolute inset-0 bg-black/40 animate-fade-in"></div>
    
    <!-- æˆåŠŸå‹•ç•«å¡ç‰‡ -->
    <div class="relative z-10 animate-success-pop">
      <!-- å…‰åœˆæ•ˆæœ -->
      <div class="absolute inset-0 -m-8 rounded-full bg-gradient-to-r from-emerald-500/20 to-cyan-500/20 blur-xl animate-pulse"></div>
      
      <!-- ä¸»å¡ç‰‡ -->
      <div class="relative bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 shadow-2xl border border-emerald-500/30">
        <!-- æˆåŠŸåœ–æ¨™ -->
        <div class="flex justify-center mb-4">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-emerald-500 to-cyan-500 flex items-center justify-center shadow-lg shadow-emerald-500/30">
            <span class="text-4xl animate-bounce">{{ successOverlayConfig()?.icon || 'âœ…' }}</span>
          </div>
        </div>
        
        <!-- æ¨™é¡Œ -->
        <div class="text-center">
          <h3 class="text-xl font-bold text-white mb-1">{{ successOverlayConfig()?.title || 'æ“ä½œæˆåŠŸ' }}</h3>
          @if (successOverlayConfig()?.subtitle) {
            <p class="text-sm text-slate-400">{{ successOverlayConfig()?.subtitle }}</p>
          }
        </div>
        
        <!-- è£é£¾ç²’å­ -->
        <div class="absolute -top-2 -left-2 w-4 h-4 bg-emerald-400 rounded-full animate-ping"></div>
        <div class="absolute -top-1 -right-3 w-3 h-3 bg-cyan-400 rounded-full animate-ping" style="animation-delay: 0.1s"></div>
        <div class="absolute -bottom-2 -left-1 w-2 h-2 bg-emerald-300 rounded-full animate-ping" style="animation-delay: 0.2s"></div>
        <div class="absolute -bottom-1 -right-2 w-3 h-3 bg-cyan-300 rounded-full animate-ping" style="animation-delay: 0.3s"></div>
      </div>
    </div>
  </div>
}

<!-- å…¨å±€å‘½ä»¤é¢æ¿ (Cmd+K) -->
<app-command-palette (navigate)="handleCommandNavigation($event)"></app-command-palette>

<!-- æ‰¹é‡ç™¼é€å°è©±æ¡† - ğŸ”§ P0: çµ±ä¸€ä½¿ç”¨ DialogService ç‹€æ…‹ -->
<app-batch-send-dialog
  [isOpen]="dialogService.showBatchMessageDialog()"
  [targets]="dialogService.batchSendTargets()"
  (closeDialog)="dialogService.closeBatchSend()"
  (sendComplete)="handleBatchSendComplete($event)">
</app-batch-send-dialog>

<!-- æ‰¹é‡æ‹‰ç¾¤å°è©±æ¡† - ğŸ”§ P0: çµ±ä¸€ä½¿ç”¨ DialogService ç‹€æ…‹ -->
<app-batch-invite-dialog
  [isOpen]="dialogService.showBatchInviteDialog()"
  [targets]="dialogService.batchInviteTargets()"
  [accounts]="accounts()"
  (closeDialog)="dialogService.closeBatchInvite()"
  (inviteComplete)="handleBatchInviteComplete($event)">
</app-batch-invite-dialog>

<!-- æˆå“¡æå–é…ç½®å°è©±æ¡† - ğŸ”§ P0: çµ±ä¸€ä½¿ç”¨ DialogService ç‹€æ…‹ -->
<app-member-extraction-dialog
  [isOpen]="dialogService.showMemberExtractionDialog() || showMemberExtractionDialog()"
  [group]="dialogService.memberExtractionGroup() || memberExtractionGroup()"
  (closeDialog)="closeMemberExtractionDialogUnified()"
  (startExtractionEvent)="handleMemberExtractionStart($event)"
  (memberCountRefreshed)="handleMemberCountRefreshed($event)">
</app-member-extraction-dialog>

<app-membership-dialog></app-membership-dialog>
<app-payment></app-payment>
<app-upgrade-prompt></app-upgrade-prompt>

<!-- QR æƒç¢¼ç™»å…¥å½ˆçª— -->
@if (showQrLoginDialog()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" (click)="closeQrLogin()"></div>
    <div class="relative z-10">
      <app-qr-login 
        (closed)="closeQrLogin()" 
        (loginSuccess)="onQrLoginSuccess($event)">
      </app-qr-login>
    </div>
  </div>
}

<!-- ä¸»æ‡‰ç”¨ç•Œé¢ -->
<!-- ğŸ†• P1.3: çµ±ä¸€ä½¿ç”¨ Router è™•ç†ç™»å…¥/æœªç™»å…¥ç‹€æ…‹ -->
<!-- æœªèªè­‰ç”¨æˆ¶æœƒè¢« AuthGuard è‡ªå‹•é‡å®šå‘åˆ° /auth/login -->
@if (isAuthenticated()) {
  <!-- å·²èªè­‰ç”¨æˆ¶é¡¯ç¤ºä¸»ç•Œé¢ -->
  <div class="flex h-screen" style="background-color: var(--bg-primary); color: var(--text-primary);">
    
    <!-- Onboarding æ–°æ‰‹å¼•å¯¼ -->
    <app-onboarding #onboardingRef
                    (navigateEvent)="handleOnboardingNavigate($event)">
    </app-onboarding>
    
    <!-- Progress Dialog -->
    <app-progress-dialog
      [show]="progressDialog().show"
      [title]="progressDialog().title"
      [progress]="progressDialog().progress"
      [cancellable]="progressDialog().cancellable">
    </app-progress-dialog>
    
    <!-- åˆªé™¤ç¢ºèªå°è©±æ¡† -->
    @if(deleteConfirmDialog().show) {
      <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center" 
           (click)="cancelDeleteLeads()">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden"
             (click)="$event.stopPropagation()">
          <!-- æ¨™é¡Œ -->
          <div class="px-6 py-4 border-b border-slate-700 flex items-center gap-3">
            <div class="p-2 bg-red-500/20 rounded-lg">
              <svg class="h-6 w-6 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
              </svg>
            </div>
            <h3 class="text-lg font-bold text-white">ç¢ºèªåˆªé™¤</h3>
          </div>
          
          <!-- å…§å®¹ -->
          <div class="px-6 py-6">
            @if(deleteConfirmDialog().type === 'single') {
              <p class="text-slate-300 mb-4">
                ç¢ºå®šè¦åˆªé™¤å®¢æˆ¶ <span class="font-bold text-cyan-400">@{{ deleteConfirmDialog().lead?.username || deleteConfirmDialog().lead?.userId }}</span> å—ï¼Ÿ
              </p>
            } @else {
              <p class="text-slate-300 mb-4">
                ç¢ºå®šè¦åˆªé™¤ <span class="font-bold text-red-400">{{ deleteConfirmDialog().count }}</span> å€‹é¸ä¸­çš„å®¢æˆ¶å—ï¼Ÿ
              </p>
            }
            <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-3 text-sm text-red-300">
              âš ï¸ æ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼Œæ‰€æœ‰ç›¸é—œè¨˜éŒ„å°‡è¢«æ°¸ä¹…åˆªé™¤ã€‚
            </div>
          </div>
          
          <!-- æŒ‰éˆ• -->
          <div class="px-6 py-4 border-t border-slate-700 flex justify-end gap-3">
            <button (click)="cancelDeleteLeads()" 
                    class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg transition-colors">
              å–æ¶ˆ
            </button>
            <button (click)="executeDeleteLeads()" 
                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors flex items-center gap-2">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
              </svg>
              ç¢ºèªåˆªé™¤
            </button>
          </div>
        </div>
      </div>
    }
    
    <!-- é‚€è«‹é€²ç¾¤å°è©±æ¡† -->
    @if(showInviteGroupDialog()) {
      <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center" 
           (click)="showInviteGroupDialog.set(false)">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden"
             (click)="$event.stopPropagation()">
          <!-- æ¨™é¡Œ -->
          <div class="px-6 py-4 border-b border-slate-700 flex items-center gap-3">
            <div class="p-2 bg-emerald-500/20 rounded-lg">
              <span class="text-xl">ğŸ‘¥</span>
            </div>
            <div>
              <h3 class="text-lg font-bold text-white">é‚€è«‹é€²ç¾¤</h3>
              <p class="text-sm text-slate-400">é¸æ“‡å”ä½œç¾¤çµ„</p>
            </div>
          </div>
          
          <!-- ç¾¤çµ„åˆ—è¡¨ -->
          <div class="px-6 py-4 max-h-64 overflow-y-auto">
            @if(collabGroups().length === 0) {
              <div class="text-center py-8 text-slate-400">
                <p class="mb-2">æš«ç„¡å”ä½œç¾¤çµ„</p>
                <button (click)="currentView.set('multi-role'); showInviteGroupDialog.set(false)" 
                        class="text-cyan-400 hover:underline text-sm">
                  å»å‰µå»ºç¾¤çµ„ â†’
                </button>
              </div>
            } @else {
              <div class="space-y-2">
                @for(group of collabGroups(); track group.id) {
                  <button (click)="executeInviteToGroup(group.id)"
                          class="w-full p-3 bg-slate-800/50 hover:bg-emerald-500/20 border border-slate-700 hover:border-emerald-500/50 rounded-xl text-left transition-all group">
                    <div class="flex items-center justify-between">
                      <div>
                        <p class="font-medium text-white group-hover:text-emerald-400">{{ group.name }}</p>
                        <p class="text-xs text-slate-500">{{ group.members?.length || 0 }} å€‹æˆå“¡</p>
                      </div>
                      <span class="text-emerald-400 opacity-0 group-hover:opacity-100 transition-opacity">â†’</span>
                    </div>
                  </button>
                }
              </div>
            }
          </div>
          
          <!-- å–æ¶ˆæŒ‰éˆ• -->
          <div class="px-6 py-4 border-t border-slate-700">
            <button (click)="showInviteGroupDialog.set(false)" 
                    class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg transition-colors">
              å–æ¶ˆ
            </button>
          </div>
        </div>
      </div>
    }
    
    <!-- Sidebar -->
    <aside class="backdrop-blur-sm flex-shrink-0 flex flex-col sidebar h-screen transition-all duration-300" 
           [class.w-64]="!sidebarCollapsed()"
           [class.w-16]="sidebarCollapsed()"
           style="background-color: var(--bg-sidebar); border-right: 1px solid var(--border-default);">
      <!-- é ‚éƒ¨å›ºå®šå€åŸŸï¼šLogo + ç”¨æˆ¶ä¿¡æ¯ -->
      <div class="flex-shrink-0">
        <!-- æ”¶ç¸®/å±•é–‹æŒ‰éˆ• -->
        <button (click)="toggleSidebarCollapse()" 
                class="absolute top-3 -right-3 z-50 w-6 h-6 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110"
                style="background: linear-gradient(135deg, #06b6d4, #8b5cf6); box-shadow: 0 2px 8px rgba(6, 182, 212, 0.4);"
                [title]="sidebarCollapsed() ? 'å±•é–‹å´é‚Šæ¬„' : 'æ”¶ç¸®å´é‚Šæ¬„'">
          <svg class="w-3.5 h-3.5 text-white transition-transform duration-200" 
               [class.rotate-180]="sidebarCollapsed()"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        
        <!-- Logo - TG-AIæ™ºæ§ç‹ -->
        <div class="flex items-center gap-3 p-4" [class.justify-center]="sidebarCollapsed()">
           <div class="relative flex-shrink-0">
             <!-- Logo ç™¼å…‰æ•ˆæœ -->
             <div class="absolute inset-0 rounded-xl blur-md opacity-50" 
                  style="background: linear-gradient(135deg, #06b6d4, #8b5cf6);"></div>
             <!-- Logo SVG -->
             <svg class="h-10 w-10 relative z-10" viewBox="0 0 64 64" fill="none">
               <!-- ä¸­å¿ƒå…­é‚Šå½¢ -->
               <path d="M32 8L52 20V44L32 56L12 44V20L32 8Z" fill="url(#sidebarLogoGrad)" stroke="url(#sidebarLogoStroke)" stroke-width="1.5"/>
               <!-- ç´™é£›æ©Ÿ -->
               <path d="M22 28L40 22L34 36L28 32L22 28Z" fill="white" opacity="0.95"/>
               <path d="M28 32L34 36L32 42L28 32Z" fill="white" opacity="0.8"/>
               <!-- çš‡å†  -->
               <path d="M24 12L28 8L32 11L36 8L40 12L38 16H26L24 12Z" fill="#fbbf24"/>
               <circle cx="32" cy="8" r="1.2" fill="#fef3c7"/>
               <!-- æ¼¸è®Š -->
               <defs>
                 <linearGradient id="sidebarLogoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                   <stop offset="0%" stop-color="#0891b2"/>
                   <stop offset="100%" stop-color="#7c3aed"/>
                 </linearGradient>
                 <linearGradient id="sidebarLogoStroke" x1="0%" y1="0%" x2="100%" y2="100%">
                   <stop offset="0%" stop-color="#22d3ee"/>
                   <stop offset="100%" stop-color="#a78bfa"/>
                 </linearGradient>
               </defs>
             </svg>
           </div>
          @if (!sidebarCollapsed()) {
            <div>
              <h1 class="text-xl font-bold bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">{{ t('title') }}</h1>
              <p class="text-xs" style="color: var(--text-muted);">{{ t('subtitle') }}</p>
            </div>
          }
        </div>
        
        <!-- ç”¨æˆ¶ä¿¡æ¯å€åŸŸï¼ˆç¾åŒ–ç‰ˆ - ç‹è€…æ¦®è€€é¢¨æ ¼ï¼‰ -->
        <div class="user-profile-card mx-3 mb-4 p-3 rounded-xl cursor-pointer transition-all duration-300 hover:scale-[1.02] group"
             [class.level-bronze]="userMembershipLevel() === 'bronze'"
             [class.level-silver]="userMembershipLevel() === 'silver'"
             [class.level-gold]="userMembershipLevel() === 'gold'"
             [class.level-diamond]="userMembershipLevel() === 'diamond'"
             [class.level-star]="userMembershipLevel() === 'star'"
             [class.level-king]="userMembershipLevel() === 'king'"
             (click)="changeView('profile')">
          <div class="flex items-center gap-3">
            <!-- é ­åƒæ¡†ï¼ˆå¸¶ç­‰ç´šé‚Šæ¡†ï¼‰ -->
            <div class="avatar-wrapper relative">
              <!-- å‹•æ…‹å…‰ç’° -->
              <div class="avatar-glow absolute inset-0 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                   [class.glow-bronze]="userMembershipLevel() === 'bronze'"
                   [class.glow-silver]="userMembershipLevel() === 'silver'"
                   [class.glow-gold]="userMembershipLevel() === 'gold'"
                   [class.glow-diamond]="userMembershipLevel() === 'diamond'"
                   [class.glow-star]="userMembershipLevel() === 'star'"
                   [class.glow-king]="userMembershipLevel() === 'king'">
              </div>
              <!-- é ­åƒé‚Šæ¡† -->
              <div class="avatar-border w-12 h-12 rounded-full p-[2px]"
                   [class.border-bronze]="userMembershipLevel() === 'bronze'"
                   [class.border-silver]="userMembershipLevel() === 'silver'"
                   [class.border-gold]="userMembershipLevel() === 'gold'"
                   [class.border-diamond]="userMembershipLevel() === 'diamond'"
                   [class.border-star]="userMembershipLevel() === 'star'"
                   [class.border-king]="userMembershipLevel() === 'king'">
                <!-- é ­åƒå…§å®¹ -->
                <div class="w-full h-full rounded-full flex items-center justify-center text-white font-bold text-lg avatar-inner"
                     [class.avatar-bronze]="userMembershipLevel() === 'bronze'"
                     [class.avatar-silver]="userMembershipLevel() === 'silver'"
                     [class.avatar-gold]="userMembershipLevel() === 'gold'"
                     [class.avatar-diamond]="userMembershipLevel() === 'diamond'"
                     [class.avatar-star]="userMembershipLevel() === 'star'"
                     [class.avatar-king]="userMembershipLevel() === 'king'">
                  {{ (currentUser()?.displayName || currentUser()?.username)?.charAt(0).toUpperCase() || '?' }}
                </div>
              </div>
              <!-- æœƒå“¡å¾½ç« ï¼ˆå³ä¸‹è§’ï¼‰ -->
              @if (userMembershipLevel() !== 'bronze') {
                <div class="vip-badge absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-lg"
                     [class.badge-silver]="userMembershipLevel() === 'silver'"
                     [class.badge-gold]="userMembershipLevel() === 'gold'"
                     [class.badge-diamond]="userMembershipLevel() === 'diamond'"
                     [class.badge-star]="userMembershipLevel() === 'star'"
                     [class.badge-king]="userMembershipLevel() === 'king'">
                  @switch (userMembershipLevel()) {
                    @case ('silver') { <span class="animate-pulse">ğŸ¥ˆ</span> }
                    @case ('gold') { <span class="animate-pulse">ğŸ¥‡</span> }
                    @case ('diamond') { <span class="animate-pulse">ğŸ’</span> }
                    @case ('star') { <span class="animate-pulse">ğŸŒŸ</span> }
                    @case ('king') { <span class="animate-bounce">ğŸ‘‘</span> }
                  }
                </div>
              }
            </div>
            
            <!-- ç”¨æˆ¶ä¿¡æ¯ -->
            <div class="flex-1 min-w-0">
              <div class="text-sm font-semibold truncate" style="color: var(--text-primary);">
                {{ currentUser()?.displayName || currentUser()?.username || 'ç”¨æˆ¶' }}
              </div>
              <div class="flex items-center gap-1.5 mt-0.5">
                <!-- æœƒå“¡æ¨™ç±¤ï¼ˆç‹è€…æ¦®è€€é¢¨æ ¼ï¼‰ -->
                @switch (userMembershipLevel()) {
                  @case ('silver') {
                    <span class="vip-tag vip-tag-silver">
                      <span class="vip-icon">ğŸ¥ˆ</span>
                      <span class="vip-text">ç™½éŠ€ç²¾è‹±</span>
                    </span>
                  }
                  @case ('gold') {
                    <span class="vip-tag vip-tag-gold">
                      <span class="vip-icon">ğŸ¥‡</span>
                      <span class="vip-text">é»ƒé‡‘å¤§å¸«</span>
                    </span>
                  }
                  @case ('diamond') {
                    <span class="vip-tag vip-tag-diamond">
                      <span class="vip-icon">ğŸ’</span>
                      <span class="vip-text">é‘½çŸ³ç‹ç‰Œ</span>
                    </span>
                  }
                  @case ('star') {
                    <span class="vip-tag vip-tag-star">
                      <span class="vip-icon">ğŸŒŸ</span>
                      <span class="vip-text">æ˜Ÿè€€å‚³èªª</span>
                    </span>
                  }
                  @case ('king') {
                    <span class="vip-tag vip-tag-king">
                      <span class="vip-icon">ğŸ‘‘</span>
                      <span class="vip-text">æ¦®è€€ç‹è€…</span>
                    </span>
                  }
                  @default {
                    <span class="vip-tag vip-tag-bronze">
                      <span class="vip-icon">âš”ï¸</span>
                      <span class="vip-text">é’éŠ…æˆ°å£«</span>
                    </span>
                  }
                }
              </div>
            </div>
            
            <!-- ç®­é ­ -->
            <div class="arrow-icon transition-transform duration-300 group-hover:translate-x-1">
              <svg class="w-4 h-4" style="color: var(--text-muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å¯æ»¾å‹•çš„å°èˆªå€åŸŸ -->
      <nav class="flex-1 overflow-y-auto overflow-x-hidden sidebar-nav mt-2 px-2 pb-2">
        @let view = currentView();
        
        <!-- æœƒå“¡ä¸­å¿ƒï¼ˆç§»åˆ°ç¬¬ä¸€å€‹ï¼‰ -->
        <a (click)="changeView('membership-center')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'membership-center'"
           [style.background-color]="view === 'membership-center' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'membership-center' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
           <span>æœƒå“¡ä¸­å¿ƒ</span>
        </a>
        
        <!-- æˆ‘çš„éŒ¢åŒ… -->
        <a (click)="changeView('wallet')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'wallet'"
           [style.background-color]="view === 'wallet' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'wallet' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
           <span>æˆ‘çš„éŒ¢åŒ…</span>
        </a>
        
        <!-- å„€è¡¨ç›¤ -->
        <a (click)="changeView('dashboard')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'dashboard'"
           [style.background-color]="view === 'dashboard' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'dashboard' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
          <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
          <span>{{ t('dashboard') }}</span>
        </a>
        
        <!-- åˆ†çµ„ï¼šğŸ”§ æ‰‹å‹•æ“ä½œï¼ˆå¯æŠ˜ç–Šï¼‰ -->
        <div class="sidebar-group">
          <button (click)="toggleSidebarGroup('manual')" 
                  class="w-full flex items-center justify-between px-3 py-2 mt-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer group">
            <span class="sidebar-group-title text-xs uppercase tracking-wider flex items-center gap-1" style="color: var(--sidebar-group-title);">
              ğŸ”§ æ‰‹å‹•æ“ä½œ
            </span>
            <svg class="w-3.5 h-3.5 transition-transform duration-200" 
                 [class.rotate-180]="!isSidebarGroupExpanded('manual')"
                 style="color: var(--sidebar-group-title);" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          @if (isSidebarGroupExpanded('manual')) {
            <div class="sidebar-group-content overflow-hidden">
              <!-- å¸³è™Ÿç®¡ç† -->
              <a (click)="changeView('accounts')" 
                 data-tour="accounts"
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'accounts' || view === 'add-account' || view === 'api-credentials'"
                 [style.background-color]="(view === 'accounts' || view === 'add-account' || view === 'api-credentials') ? 'var(--sidebar-item-active)' : 'transparent'"
                 [style.color]="(view === 'accounts' || view === 'add-account' || view === 'api-credentials') ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                 <span>{{ t('accounts') }}</span>
              </a>
              
              <!-- ğŸ” æœç´¢ç™¼ç¾ (ç¨ç«‹é é¢) -->
              <a (click)="changeView('search-discovery')" 
                 data-tour="search-discovery"
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1 relative"
                 [class.active]="view === 'search-discovery'"
                 [style.background-color]="view === 'search-discovery' ? 'rgba(6, 182, 212, 0.2)' : 'transparent'"
                 [style.color]="view === 'search-discovery' ? '#22d3ee' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                 <span>æœç´¢ç™¼ç¾</span>
                 <span class="absolute right-2 px-1.5 py-0.5 text-[10px] bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-full font-bold">NEW</span>
              </a>
              
              <!-- ğŸ“¦ è³‡æºä¸­å¿ƒ (æˆ‘çš„è³‡æº + çµ±è¨ˆ) -->
              <a (click)="changeView('resource-center')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1 relative"
                 [class.active]="view === 'resource-center' || view === 'resources'"
                 [style.background-color]="(view === 'resource-center' || view === 'resources') ? 'rgba(6, 182, 212, 0.2)' : 'transparent'"
                 [style.color]="(view === 'resource-center' || view === 'resources') ? '#22d3ee' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                 <span>è³‡æºä¸­å¿ƒ</span>
              </a>
              
              <!-- ğŸ“¤ ç™¼é€æ§åˆ¶å° -->
              <a (click)="changeView('leads')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'leads'"
                 [style.background-color]="view === 'leads' ? 'var(--sidebar-item-active)' : 'transparent'"
                 [style.color]="view === 'leads' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
                 <span>ç™¼é€æ§åˆ¶å°</span>
              </a>
            </div>
          }
        </div>
        
        <!-- åˆ†çµ„ï¼šğŸ“¡ ç›£æ§ä¸­å¿ƒï¼ˆå¯æŠ˜ç–Šï¼‰ -->
        <div class="sidebar-group">
          <button (click)="toggleSidebarGroup('monitoring')" 
                  class="w-full flex items-center justify-between px-3 py-2 mt-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer group">
            <span class="sidebar-group-title text-xs uppercase tracking-wider font-semibold flex items-center gap-1" style="color: var(--sidebar-group-title);">
              <span class="inline-block w-5 h-5 rounded bg-gradient-to-br from-cyan-500 to-blue-500 text-center leading-5 text-[10px]">ğŸ“¡</span>
              ç›£æ§ä¸­å¿ƒ
            </span>
            <svg class="w-3.5 h-3.5 transition-transform duration-200" 
                 [class.rotate-180]="!isSidebarGroupExpanded('monitoring')"
                 style="color: var(--sidebar-group-title);" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          @if (isSidebarGroupExpanded('monitoring')) {
            <div class="sidebar-group-content overflow-hidden">
              <!-- âš™ï¸ è‡ªå‹•åŒ–ç¸½è¦½ -->
              <a (click)="changeView('automation')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 cursor-pointer mb-1 relative group"
                 [class.active]="view === 'automation'"
                 [style.background-color]="view === 'automation' ? 'rgba(6, 182, 212, 0.15)' : 'transparent'"
                 [style.color]="view === 'automation' ? '#22d3ee' : 'var(--sidebar-text)'">
                  <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-all"
                       [class.bg-gradient-to-br]="view === 'automation'"
                       [class.from-cyan-500]="view === 'automation'"
                       [class.to-blue-500]="view === 'automation'"
                       [class.bg-slate-700/50]="view !== 'automation'"
                       [class.group-hover:bg-slate-700]="view !== 'automation'">
                     <span class="text-lg">ğŸ“Š</span>
                  </div>
                  <div class="flex flex-col">
                     <span class="font-medium">è‡ªå‹•åŒ–ç¸½è¦½</span>
                     <span class="text-[10px] opacity-60">é…ç½®èˆ‡ç›£æ§ç‹€æ…‹</span>
                  </div>
              </a>
              
              <!-- ğŸ“± ç›£æ§å¸³è™Ÿ -->
              <a (click)="changeView('monitoring-accounts')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'monitoring-accounts'"
                 [style.background-color]="view === 'monitoring-accounts' ? 'rgba(6, 182, 212, 0.1)' : 'transparent'"
                 [style.color]="view === 'monitoring-accounts' ? '#22d3ee' : 'var(--sidebar-text)'">
                 <span class="text-lg ml-1">ğŸ“±</span>
                 <span>ç›£æ§å¸³è™Ÿ</span>
              </a>
              
              <!-- ğŸ’¬ ç›£æ§ç¾¤çµ„ -->
              <a (click)="changeView('monitoring-groups')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'monitoring-groups'"
                 [style.background-color]="view === 'monitoring-groups' ? 'rgba(16, 185, 129, 0.1)' : 'transparent'"
                 [style.color]="view === 'monitoring-groups' ? '#34d399' : 'var(--sidebar-text)'">
                 <span class="text-lg ml-1">ğŸ’¬</span>
                 <span>ç›£æ§ç¾¤çµ„</span>
              </a>
              
              <!-- ğŸ”‘ é—œéµè©é›† -->
              <a (click)="changeView('keyword-sets')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'keyword-sets'"
                 [style.background-color]="view === 'keyword-sets' ? 'rgba(139, 92, 246, 0.1)' : 'transparent'"
                 [style.color]="view === 'keyword-sets' ? '#a78bfa' : 'var(--sidebar-text)'">
                 <span class="text-lg ml-1">ğŸ”‘</span>
                 <span>é—œéµè©é›†</span>
              </a>
              
              <!-- ğŸ“ èŠå¤©æ¨¡æ¿ -->
              <a (click)="changeView('chat-templates')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'chat-templates'"
                 [style.background-color]="view === 'chat-templates' ? 'rgba(236, 72, 153, 0.1)' : 'transparent'"
                 [style.color]="view === 'chat-templates' ? '#f472b6' : 'var(--sidebar-text)'">
                 <span class="text-lg ml-1">ğŸ“</span>
                 <span>èŠå¤©æ¨¡æ¿</span>
              </a>
              
              <!-- âš¡ è§¸ç™¼è¦å‰‡ -->
              <a (click)="changeView('trigger-rules')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'trigger-rules'"
                 [style.background-color]="view === 'trigger-rules' ? 'rgba(251, 146, 60, 0.1)' : 'transparent'"
                 [style.color]="view === 'trigger-rules' ? '#fb923c' : 'var(--sidebar-text)'">
                 <span class="text-lg ml-1">âš¡</span>
                 <span>è§¸ç™¼è¦å‰‡</span>
              </a>
              
              <!-- ğŸ‘¥ æ”¶é›†ç”¨æˆ¶ï¼ˆå»£å‘Šè­˜åˆ¥ï¼‰ -->
              <a (click)="changeView('collected-users')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'collected-users'"
                 [style.background-color]="view === 'collected-users' ? 'rgba(139, 92, 246, 0.1)' : 'transparent'"
                 [style.color]="view === 'collected-users' ? '#a78bfa' : 'var(--sidebar-text)'">
                 <span class="text-lg ml-1">ğŸ‘¥</span>
                 <span>æ”¶é›†ç”¨æˆ¶</span>
                 <span class="ml-auto text-xs px-1.5 py-0.5 bg-violet-500/20 text-violet-400 rounded">NEW</span>
              </a>
            </div>
          }
        </div>
        
        <!-- åˆ†çµ„ï¼šAI æ™ºèƒ½ç‡ŸéŠ·ï¼ˆå¯æŠ˜ç–Šï¼‰ -->
        <div class="sidebar-group">
          <button (click)="toggleSidebarGroup('marketing')" 
                  class="w-full flex items-center justify-between px-3 py-2 mt-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer group">
            <span class="sidebar-group-title text-xs uppercase tracking-wider font-semibold flex items-center gap-1" style="color: var(--sidebar-group-title);">
              <span class="inline-block w-5 h-5 rounded bg-gradient-to-br from-violet-500 to-fuchsia-500 text-center leading-5 text-[10px]">AI</span>
              æ™ºèƒ½ç‡ŸéŠ·
            </span>
            <svg class="w-3.5 h-3.5 transition-transform duration-200" 
                 [class.rotate-180]="!isSidebarGroupExpanded('marketing')"
                 style="color: var(--sidebar-group-title);" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          @if (isSidebarGroupExpanded('marketing')) {
            <div class="sidebar-group-content overflow-hidden">
              <!-- 1ï¸âƒ£ AI ç‡ŸéŠ·åŠ©æ‰‹ (ç¬¬ä¸€æ­¥ï¼šç­–åŠƒ) - é‘½çŸ³åŠŸèƒ½ -->
              <a (click)="changeView('ai-assistant')" 
           data-tour="ai-assistant"
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 cursor-pointer mb-1.5 relative group"
           [class.active]="view === 'ai-assistant'"
           [class.opacity-50]="!membershipService.hasFeature('strategyPlanning')"
           [style.background-color]="view === 'ai-assistant' ? 'rgba(249, 115, 22, 0.15)' : 'transparent'"
           [style.color]="view === 'ai-assistant' ? '#fb923c' : 'var(--sidebar-text)'"
           [title]="!membershipService.hasFeature('strategyPlanning') ? 'éœ€è¦ é‘½çŸ³ç‹ç‰Œ æˆ–ä»¥ä¸Šæœƒå“¡' : ''">
           <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-all"
                [class.bg-gradient-to-br]="view === 'ai-assistant'"
                [class.from-orange-500]="view === 'ai-assistant'"
                [class.to-amber-500]="view === 'ai-assistant'"
                [class.bg-slate-700/50]="view !== 'ai-assistant'"
                [class.group-hover:bg-slate-700]="view !== 'ai-assistant'">
             <span class="text-lg">ğŸ¯</span>
           </div>
           <div class="flex flex-col">
             <span class="font-medium">ç­–ç•¥è¦åŠƒ</span>
             <span class="text-[10px] opacity-60">AI ç‡ŸéŠ·åŠ©æ‰‹</span>
           </div>
           @if (membershipService.hasFeature('strategyPlanning')) {
             <span class="absolute right-2 px-2 py-0.5 text-[9px] bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-full font-bold shadow-lg shadow-orange-500/20">1</span>
           } @else {
             <span class="absolute right-2 text-xs">ğŸ’</span>
           }
        </a>
        
        <!-- 2ï¸âƒ£ AI åœ˜éšŠéŠ·å”® (ç¬¬äºŒæ­¥ï¼šåŸ·è¡Œ) - é‘½çŸ³åŠŸèƒ½ -->
        <a (click)="changeView('ai-team')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 cursor-pointer mb-1.5 relative group"
           [class.active]="view === 'ai-team'"
           [class.opacity-50]="!membershipService.hasFeature('autoExecution')"
           [style.background-color]="view === 'ai-team' ? 'rgba(168, 85, 247, 0.15)' : 'transparent'"
           [style.color]="view === 'ai-team' ? '#c084fc' : 'var(--sidebar-text)'"
           [title]="!membershipService.hasFeature('autoExecution') ? 'éœ€è¦ é‘½çŸ³ç‹ç‰Œ æˆ–ä»¥ä¸Šæœƒå“¡' : ''">
           <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-all"
                [class.bg-gradient-to-br]="view === 'ai-team'"
                [class.from-purple-500]="view === 'ai-team'"
                [class.to-pink-500]="view === 'ai-team'"
                [class.bg-slate-700/50]="view !== 'ai-team'"
                [class.group-hover:bg-slate-700]="view !== 'ai-team'">
             <span class="text-lg">ğŸ¤–</span>
           </div>
           <div class="flex flex-col">
             <span class="font-medium">è‡ªå‹•åŸ·è¡Œ</span>
             <span class="text-[10px] opacity-60">AI åœ˜éšŠéŠ·å”®</span>
           </div>
           @if (membershipService.hasFeature('autoExecution')) {
             <span class="absolute right-2 px-2 py-0.5 text-[9px] bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full font-bold shadow-lg shadow-purple-500/20">2</span>
           } @else {
             <span class="absolute right-2 text-xs">ğŸ’</span>
           }
        </a>
        
        <!-- 3ï¸âƒ£ æ™ºèƒ½åˆ†æ (ç¬¬ä¸‰æ­¥ï¼šåˆ†æ) - é»ƒé‡‘åŠŸèƒ½ -->
        <a (click)="changeView('analytics')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 cursor-pointer mb-1.5 relative group"
           [class.active]="view === 'analytics'"
           [class.opacity-50]="!membershipService.hasFeature('dataInsightsBasic')"
           [style.background-color]="view === 'analytics' ? 'rgba(6, 182, 212, 0.15)' : 'transparent'"
           [style.color]="view === 'analytics' ? '#22d3ee' : 'var(--sidebar-text)'"
           [title]="!membershipService.hasFeature('dataInsightsBasic') ? 'éœ€è¦ é»ƒé‡‘å¤§å¸« æˆ–ä»¥ä¸Šæœƒå“¡' : ''">
           <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-all"
                [class.bg-gradient-to-br]="view === 'analytics'"
                [class.from-cyan-500]="view === 'analytics'"
                [class.to-blue-500]="view === 'analytics'"
                [class.bg-slate-700/50]="view !== 'analytics'"
                [class.group-hover:bg-slate-700]="view !== 'analytics'">
             <span class="text-lg">ğŸ“Š</span>
           </div>
           <div class="flex flex-col">
             <span class="font-medium">æ•¸æ“šæ´å¯Ÿ</span>
             <span class="text-[10px] opacity-60">æ™ºèƒ½åˆ†æå ±å‘Š</span>
           </div>
           @if (membershipService.hasFeature('dataInsightsBasic')) {
                 <span class="absolute right-2 px-2 py-0.5 text-[9px] bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-full font-bold shadow-lg shadow-cyan-500/20">3</span>
               } @else {
                 <span class="absolute right-2 text-xs">ğŸ¥‡</span>
               }
              </a>
            </div>
          }
        </div>
        
        <!-- åˆ†çµ„ï¼šğŸ“Š æ•¸æ“šåˆ†æï¼ˆå¯æŠ˜ç–Šï¼‰ -->
        <div class="sidebar-group">
          <button (click)="toggleSidebarGroup('analytics')" 
                  class="w-full flex items-center justify-between px-3 py-2 mt-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer group">
            <span class="sidebar-group-title text-xs uppercase tracking-wider flex items-center gap-1" style="color: var(--sidebar-group-title);">
              ğŸ“Š æ•¸æ“šåˆ†æ
            </span>
            <svg class="w-3.5 h-3.5 transition-transform duration-200" 
                 [class.rotate-180]="!isSidebarGroupExpanded('analytics')"
                 style="color: var(--sidebar-group-title);" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          @if (isSidebarGroupExpanded('analytics')) {
            <div class="sidebar-group-content overflow-hidden">
              <!-- åˆ†æä¸­å¿ƒ (è©³ç´°æ•¸æ“š) -->
              <a (click)="changeView('analytics-center')"
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'analytics-center' || view === 'nurturing-analytics'"
                 [style.background-color]="(view === 'analytics-center' || view === 'nurturing-analytics') ? 'rgba(6, 182, 212, 0.15)' : 'transparent'"
                 [style.color]="(view === 'analytics-center' || view === 'nurturing-analytics') ? '#22d3ee' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
                 <span>åˆ†æä¸­å¿ƒ</span>
              </a>
              
              <!-- å®¢æˆ¶åŸ¹è‚² (ä¿ç•™ AI è·Ÿé€²åŠŸèƒ½) -->
              <a (click)="changeView('lead-nurturing')"
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'lead-nurturing'"
                 [style.background-color]="view === 'lead-nurturing' ? 'rgba(236, 72, 153, 0.15)' : 'transparent'"
                 [style.color]="view === 'lead-nurturing' ? '#f472b6' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/><circle cx="12" cy="12" r="4"/></svg>
                 <span>å®¢æˆ¶åŸ¹è‚²</span>
                 <span class="ml-auto px-1.5 py-0.5 text-xs bg-pink-500/20 text-pink-400 rounded">AI</span>
              </a>
              
              <!-- å¤šè§’è‰²å”ä½œ (é€²éšè¨­ç½®) -->
              <a (click)="changeView('multi-role'); loadMultiRoleData()" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'multi-role'"
                 [class.opacity-50]="!membershipService.hasFeature('multiRole')"
                 [class.cursor-not-allowed]="!membershipService.hasFeature('multiRole')"
                 [style.background-color]="view === 'multi-role' ? 'rgba(99, 102, 241, 0.15)' : 'transparent'"
                 [style.color]="view === 'multi-role' ? '#a5b4fc' : (!membershipService.hasFeature('multiRole') ? 'var(--sidebar-text-muted)' : 'var(--sidebar-text)')"
                 [title]="!membershipService.hasFeature('multiRole') ? 'éœ€è¦ é‘½çŸ³ç‹ç‰Œ æˆ–ä»¥ä¸Šæœƒå“¡' : ''">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                 <span>å¤šè§’è‰²å”ä½œ</span>
                 @if (!membershipService.hasFeature('multiRole')) {
                   <span class="ml-auto text-xs opacity-60">ğŸ’</span>
                 }
              </a>
            </div>
          }
        </div>
        
        <!-- åˆ†çµ„ï¼šAI æ™ºèƒ½ï¼ˆå¯æŠ˜ç–Šï¼‰ -->
        <div class="sidebar-group">
          <button (click)="toggleSidebarGroup('ai')" 
                  class="w-full flex items-center justify-between px-3 py-2 mt-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer group">
            <span class="sidebar-group-title text-xs uppercase tracking-wider flex items-center gap-1" style="color: var(--sidebar-group-title);">
              ğŸ§  {{ t('aiIntelligence') }}
            </span>
            <svg class="w-3.5 h-3.5 transition-transform duration-200" 
                 [class.rotate-180]="!isSidebarGroupExpanded('ai')"
                 style="color: var(--sidebar-group-title);" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          @if (isSidebarGroupExpanded('ai')) {
            <div class="sidebar-group-content overflow-hidden">
        
        <!-- ğŸ†• çŸ¥è­˜å¤§è…¦ï¼ˆå¯å±•é–‹èœå–®ï¼‰ -->
        <div class="knowledge-menu">
          <!-- ä¸»èœå–®é … -->
          <a (click)="toggleKnowledgeMenu()" 
             class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
             [class.active]="isKnowledgeView()"
             [style.background-color]="isKnowledgeView() ? 'rgba(236, 72, 153, 0.15)' : 'transparent'"
             [style.color]="isKnowledgeView() ? '#f472b6' : 'var(--sidebar-text)'">
             <span class="text-lg">ğŸ§ </span>
             <span class="flex-1">çŸ¥è­˜å¤§è…¦</span>
             <span class="text-xs transition-transform duration-200" [class.rotate-180]="knowledgeMenuExpanded()">â–¼</span>
          </a>
          
          <!-- å­èœå–®é … -->
          @if (knowledgeMenuExpanded()) {
            <div class="pl-6 space-y-1">
              <a (click)="changeView('knowledge-brain')" 
                 class="sidebar-item flex items-center gap-2 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer text-sm"
                 [class.active]="view === 'knowledge-brain'"
                 [style.background-color]="view === 'knowledge-brain' ? 'rgba(236, 72, 153, 0.1)' : 'transparent'"
                 [style.color]="view === 'knowledge-brain' ? '#f472b6' : 'var(--sidebar-text-muted)'">
                 <span>ğŸ“Š</span>
                 <span>ç¸½è¦½</span>
              </a>
              <a (click)="changeView('knowledge-manage')" 
                 class="sidebar-item flex items-center gap-2 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer text-sm"
                 [class.active]="view === 'knowledge-manage'"
                 [style.background-color]="view === 'knowledge-manage' ? 'rgba(236, 72, 153, 0.1)' : 'transparent'"
                 [style.color]="view === 'knowledge-manage' ? '#f472b6' : 'var(--sidebar-text-muted)'">
                 <span>ğŸ“</span>
                 <span>çŸ¥è­˜ç®¡ç†</span>
              </a>
              <a (click)="changeView('knowledge-gaps')" 
                 class="sidebar-item flex items-center gap-2 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer text-sm relative"
                 [class.active]="view === 'knowledge-gaps'"
                 [style.background-color]="view === 'knowledge-gaps' ? 'rgba(236, 72, 153, 0.1)' : 'transparent'"
                 [style.color]="view === 'knowledge-gaps' ? '#f472b6' : 'var(--sidebar-text-muted)'">
                 <span>â“</span>
                 <span>çŸ¥è­˜ç¼ºå£</span>
                 @if (ragBrainService.gapsCount() > 0) {
                   <span class="ml-auto text-xs font-bold rounded-full px-1.5 py-0.5" style="background-color: rgba(239, 68, 68, 0.2); color: #f87171;">{{ ragBrainService.gapsCount() }}</span>
                 }
              </a>
            </div>
          }
        </div>
        
              <!-- AI ä¸­å¿ƒï¼ˆæ¨¡å‹é…ç½®ï¼‰ -->
              <a (click)="changeView('ai-center')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'ai-center'"
                 [style.background-color]="view === 'ai-center' ? 'rgba(168, 85, 247, 0.15)' : 'transparent'"
                 [style.color]="view === 'ai-center' ? '#c084fc' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m9 0a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3"></path></svg>
                 <span>{{ t('aiCenter') }}</span>
              </a>
            </div>
          }
        </div>
        
        <!-- åˆ†çµ„ï¼šç³»çµ±ç›£æ§ï¼ˆå¯æŠ˜ç–Šï¼‰ -->
        <div class="sidebar-group">
          <button (click)="toggleSidebarGroup('system')" 
                  class="w-full flex items-center justify-between px-3 py-2 mt-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer group">
            <span class="sidebar-group-title text-xs uppercase tracking-wider flex items-center gap-1" style="color: var(--sidebar-group-title);">
              âš™ï¸ {{ t('systemMonitor') }}
            </span>
            <svg class="w-3.5 h-3.5 transition-transform duration-200" 
                 [class.rotate-180]="!isSidebarGroupExpanded('system')"
                 style="color: var(--sidebar-group-title);" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          @if (isSidebarGroupExpanded('system')) {
            <div class="sidebar-group-content overflow-hidden">
              <!-- è¨­ç½® -->
              <a (click)="changeView('settings')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'settings'"
                 [style.background-color]="view === 'settings' ? 'var(--sidebar-item-active)' : 'transparent'"
                 [style.color]="view === 'settings' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                 <span>{{ t('settings') }}</span>
              </a>
            </div>
          }
        </div>
      </nav>
    
    <!-- å´é‚Šæ¬„åº•éƒ¨ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰ -->
    <div class="flex-shrink-0 p-4 space-y-3 border-t" style="border-color: var(--border-default); background-color: var(--bg-sidebar);">
        <!-- ğŸ†• å¸®åŠ©æŒ‰é’® - æ‰“å¼€æ–°æ‰‹å¼•å¯¼ -->
        <button (click)="openOnboarding()"
                class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-gradient-to-r from-cyan-500/10 to-blue-500/10 hover:from-cyan-500/20 hover:to-blue-500/20 border border-cyan-500/30 hover:border-cyan-500/50 text-cyan-400 rounded-xl transition-all text-sm font-medium group">
          <span class="text-lg group-hover:animate-bounce">â“</span>
          <span>ä½¿ç”¨å¸®åŠ©</span>
        </button>
        
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--sidebar-group-title);">{{ t('language') }}</label>
          <app-language-switcher-compact></app-language-switcher-compact>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--sidebar-group-title);">{{ t('appearance') }}</label>
          <div class="flex rounded-md shadow-sm p-1" style="background-color: var(--bg-tertiary);">
            <button (click)="theme.set('light')" 
                    class="w-full text-sm py-1.5 rounded transition-colors flex items-center justify-center gap-2"
                    [style.background-color]="theme() === 'light' ? 'var(--bg-card)' : 'transparent'"
                    [style.color]="theme() === 'light' ? 'var(--primary)' : 'var(--text-muted)'"
                    [style.box-shadow]="theme() === 'light' ? 'var(--shadow-sm)' : 'none'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            </button>
            <button (click)="theme.set('dark')" 
                    class="w-full text-sm py-1.5 rounded transition-colors flex items-center justify-center gap-2"
                    [style.background-color]="theme() === 'dark' ? 'var(--primary-bg)' : 'transparent'"
                    [style.color]="theme() === 'dark' ? 'var(--primary)' : 'var(--text-muted)'"
                    [style.box-shadow]="theme() === 'dark' ? 'var(--shadow-sm)' : 'none'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
              </svg>
            </button>
          </div>
        </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 overflow-y-auto" style="background-color: var(--bg-primary);">
    <!-- ä½¿ç”¨ @switch æ§åˆ¶è¦–åœ–ï¼ˆæš«æ™‚ç¦ç”¨ Angular Routerï¼‰ -->
    @switch (currentView()) {
      @case ('dashboard') {
        <app-dashboard-view></app-dashboard-view>
      }
      @case ('accounts') {
        <app-accounts-view></app-accounts-view>
      }
      @case ('add-account') {
        <app-add-account-page (accountAdded)="onAccountAdded($event)" (back)="changeView('accounts')"></app-add-account-page>
      }
      @case ('api-credentials') {
        <app-api-credentials-view></app-api-credentials-view>
      }
      @case ('settings') {
        <app-settings-view></app-settings-view>
      }
      @case ('leads') {
        <app-leads-view></app-leads-view>
      }
      @case ('automation') {
        <app-automation-view></app-automation-view>
      }
      @case ('resource-discovery') {
        <app-resource-discovery-view></app-resource-discovery-view>
      }
      @case ('resources') {
        <app-resource-discovery-view></app-resource-discovery-view>
      }
      @case ('ai-center') {
        <app-ai-center-view></app-ai-center-view>
      }
      @case ('knowledge-brain') {
        <!-- ğŸ†• çŸ¥è­˜å¤§è…¦ç¨ç«‹é é¢ -->
        <div class="h-full p-6 overflow-auto">
          <app-ai-brain></app-ai-brain>
        </div>
      }
      @case ('knowledge-gaps') {
        <!-- ğŸ†• çŸ¥è­˜ç¼ºå£ç¨ç«‹é é¢ -->
        <div class="h-full overflow-auto">
          <app-knowledge-gaps></app-knowledge-gaps>
        </div>
      }
      @case ('knowledge-manage') {
        <!-- ğŸ†• çŸ¥è­˜ç®¡ç†é é¢ -->
        <div class="h-full overflow-auto">
          <app-knowledge-manage></app-knowledge-manage>
        </div>
      }
      @case ('multi-role') {
        <app-multi-role-view></app-multi-role-view>
      }
      @case ('analytics') {
        <app-analytics-view></app-analytics-view>
      }
      @case ('monitoring') {
        <app-monitoring-view></app-monitoring-view>
      }
      @case ('monitoring-accounts') {
        <app-monitoring-view></app-monitoring-view>
      }
      @case ('monitoring-groups') {
        <app-monitoring-view></app-monitoring-view>
      }
      @case ('keyword-sets') {
        <app-monitoring-view></app-monitoring-view>
      }
      @case ('chat-templates') {
        <app-monitoring-view></app-monitoring-view>
      }
      @case ('trigger-rules') {
        <app-monitoring-view></app-monitoring-view>
      }
      @case ('collected-users') {
        <app-monitoring-view></app-monitoring-view>
      }
      @case ('runtime-logs') {
        <app-runtime-logs-view></app-runtime-logs-view>
      }
      <!-- ğŸ†• Phase P0: è£œå…¨ç¼ºå¤±çš„è¦–åœ– -->
      @case ('membership-center') {
        <app-membership-center></app-membership-center>
      }
      @case ('wallet') {
        <app-wallet-view></app-wallet-view>
      }
      @case ('wallet-recharge') {
        <app-wallet-recharge></app-wallet-recharge>
      }
      @case ('wallet-withdraw') {
        <app-wallet-withdraw></app-wallet-withdraw>
      }
      @case ('wallet-transactions') {
        <app-wallet-transactions></app-wallet-transactions>
      }
      @case ('wallet-orders') {
        <app-wallet-orders></app-wallet-orders>
      }
      @case ('wallet-analytics') {
        <app-wallet-analytics></app-wallet-analytics>
      }
      @case ('profile') {
        <app-profile></app-profile>
      }
      @case ('resource-center') {
        <app-resource-center></app-resource-center>
      }
      @case ('search-discovery') {
        <app-search-discovery></app-search-discovery>
      }
      @case ('ai-assistant') {
        <app-ai-marketing-assistant></app-ai-marketing-assistant>
      }
      @case ('ai-team') {
        <app-ai-team-hub></app-ai-team-hub>
      }
      @case ('member-database') {
        <app-member-database></app-member-database>
      }
      @case ('lead-nurturing') {
        <app-leads-view></app-leads-view>
      }
      @case ('nurturing-analytics') {
        <app-analytics-view></app-analytics-view>
      }
      @case ('user-tracking') {
        <app-analytics-view></app-analytics-view>
      }
      @case ('ads') {
        <app-automation-view></app-automation-view>
      }
      @case ('campaigns') {
        <app-automation-view></app-automation-view>
      }
      @case ('analytics-center') {
        <app-analytics-view></app-analytics-view>
      }
      @case ('marketing-report') {
        <app-marketing-report></app-marketing-report>
      }
      @case ('performance') {
        <app-runtime-logs-view></app-runtime-logs-view>
      }
      @case ('alerts') {
        <app-runtime-logs-view></app-runtime-logs-view>
      }
      @case ('logs') {
        <app-runtime-logs-view></app-runtime-logs-view>
      }
      @default {
        <app-dashboard-view></app-dashboard-view>
      }
    }
  </main>

  <!-- Lead Detail Modal - å®¢æˆ¶æ“ä½œä¸­å¿ƒ -->
  @if (generationState().lead; as lead) {
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50" (click)="closeLeadDetailModal()">
      <div class="bg-gradient-to-br from-slate-900 via-slate-900 to-slate-800 border border-cyan-500/30 rounded-2xl shadow-2xl shadow-cyan-500/10 w-full max-w-2xl max-h-[90vh] overflow-hidden text-slate-200" (click)="$event.stopPropagation()">
        
        <!-- å®¢æˆ¶ä¿¡æ¯é ­éƒ¨ -->
        <div class="bg-gradient-to-r from-cyan-500/10 via-blue-500/10 to-purple-500/10 border-b border-cyan-500/20 p-5">
          <div class="flex justify-between items-start">
            <div class="flex items-center gap-4">
              <!-- é ­åƒ -->
              <div class="w-14 h-14 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-cyan-500/30">
                {{ (lead.username || lead.firstName || lead.userId || '?')[0].toUpperCase() }}
              </div>
              <!-- ç”¨æˆ¶ä¿¡æ¯ -->
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="text-xl font-bold text-white">
                    @if(lead.username) { @{{ lead.username }} }
                    @else if(lead.firstName) { {{ lead.firstName }} {{ lead.lastName || '' }} }
                    @else { ID: {{ lead.userId | slice:0:12 }} }
                  </h3>
                  <span class="h-2.5 w-2.5 rounded-full animate-pulse" [class]="getOnlineStatusColor(lead.onlineStatus)"></span>
                </div>
                @if(lead.phone) {
                  <p class="text-sm text-cyan-400">ğŸ“± {{ lead.phone }}</p>
                }
                <div class="flex items-center gap-2 mt-1 flex-wrap">
                  @if(lead.sourceGroup) {
                    <span class="text-xs px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-400 border border-purple-500/30">ğŸ“ {{ lead.sourceGroup | slice:0:20 }}</span>
                  }
                  @if(lead.triggeredKeyword && lead.triggeredKeyword !== 'ç„¡') {
                    <span class="text-xs px-2 py-0.5 rounded-full bg-cyan-500/20 text-cyan-400 border border-cyan-500/30">ğŸ”‘ {{ lead.triggeredKeyword | slice:0:15 }}</span>
                  }
                  @if(lead.intentLevel) {
                    <span class="text-xs px-2 py-0.5 rounded-full" [class]="getIntentLevelColor(lead.intentLevel)">{{ getIntentLevelEmoji(lead.intentLevel) }} {{ t(lead.intentLevel) }}</span>
                  }
                </div>
              </div>
            </div>
            <button (click)="closeLeadDetailModal()" class="text-slate-400 hover:text-white text-2xl leading-none transition-colors p-2 hover:bg-white/10 rounded-lg">âœ•</button>
          </div>
        </div>

        <!-- Tab å°èˆª -->
        <div class="border-b border-cyan-500/20 bg-slate-900/50">
          <nav class="flex px-5" aria-label="Tabs">
            <a (click)="leadDetailView.set('sendMessage')" 
               [class.border-cyan-400]="leadDetailView() === 'sendMessage'" 
               [class.text-cyan-400]="leadDetailView() === 'sendMessage'" 
               [class.bg-cyan-500/10]="leadDetailView() === 'sendMessage'"
               class="whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm cursor-pointer text-slate-400 hover:text-cyan-400 hover:bg-cyan-500/5 transition-all rounded-t-lg flex items-center gap-2">
              ğŸ’¬ {{ t('sendMessageTab') }}
            </a>
            <a (click)="leadDetailView.set('history')" 
               [class.border-cyan-400]="leadDetailView() === 'history'" 
               [class.text-cyan-400]="leadDetailView() === 'history'"
               [class.bg-cyan-500/10]="leadDetailView() === 'history'"
               class="whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm cursor-pointer text-slate-400 hover:text-cyan-400 hover:bg-cyan-500/5 transition-all rounded-t-lg flex items-center gap-2">
              ğŸ“‹ {{ t('historyTab') }}
            </a>
          </nav>
        </div>
        
        <!-- å…§å®¹å€åŸŸ - å¯æ»¾å‹• -->
        <div class="overflow-y-auto max-h-[calc(90vh-220px)] p-5">
        @if(leadDetailView() === 'sendMessage') {
            <div class="space-y-4">
              <!-- ç™¼é€å¸³è™Ÿé¸æ“‡å™¨ -->
              <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                <label class="block text-sm font-medium text-cyan-400 mb-2">ğŸ“¤ {{ t('selectSenderAccount') }}</label>
                <select 
                    [ngModel]="selectedSenderId()" 
                    (ngModelChange)="selectedSenderId.set($event)"
                    class="form-select w-full bg-slate-900/50 border-cyan-500/30 rounded-lg py-2.5 px-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                    @if(senderAccounts().length === 0) {
                        <option value="">{{ t('noSenderAccounts') }}</option>
                    } @else {
                        <option value="">é¸æ“‡ç™¼é€å¸³è™Ÿ...</option>
                        @for(account of senderAccounts(); track account.id) {
                            <option [value]="account.id">{{ account.phone }} ({{ account.username || t(account.status) }})</option>
                        }
                    }
                </select>
                @if(senderAccounts().length === 0) {
                    <div class="mt-2 p-2 bg-amber-500/10 border border-amber-500/30 rounded-lg">
                      <p class="text-xs text-amber-400">âš ï¸ {{ t('noSenderAccountsHint') }}</p>
                      <a (click)="currentView.set('accounts'); closeLeadDetailModal()" class="text-xs text-cyan-400 hover:underline cursor-pointer mt-1 inline-block">å‰å¾€å¸³è™Ÿç®¡ç† â†’</a>
                    </div>
                }
              </div>

              <!-- æ¶ˆæ¯è¼¸å…¥æ–¹å¼é¸æ“‡ - é’è—è‰²ä¸»é¡Œå¡ç‰‡å¼ -->
              <div class="grid grid-cols-3 gap-3">
                <label (click)="messageMode.set('manual')"
                       class="cursor-pointer p-3 rounded-xl border-2 transition-all text-center"
                       [class]="messageMode() === 'manual' ? 'bg-cyan-500/20 border-cyan-500 text-cyan-400' : 'bg-slate-800/50 border-slate-700/50 text-slate-400 hover:border-cyan-500/30'">
                    <div class="text-2xl mb-1">ğŸ“</div>
                    <span class="text-sm font-medium">{{ t('manualInput') }}</span>
                </label>
                <label (click)="messageMode.set('ai')"
                       class="cursor-pointer p-3 rounded-xl border-2 transition-all text-center"
                       [class]="messageMode() === 'ai' ? 'bg-gradient-to-br from-cyan-500/20 to-purple-500/20 border-cyan-500 text-cyan-400' : 'bg-slate-800/50 border-slate-700/50 text-slate-400 hover:border-cyan-500/30'">
                    <div class="text-2xl mb-1">ğŸ¤–</div>
                    <span class="text-sm font-medium">{{ t('aiGenerate') }}</span>
                </label>
                <label (click)="messageMode.set('template')"
                       class="cursor-pointer p-3 rounded-xl border-2 transition-all text-center"
                       [class]="messageMode() === 'template' ? 'bg-cyan-500/20 border-cyan-500 text-cyan-400' : 'bg-slate-800/50 border-slate-700/50 text-slate-400 hover:border-cyan-500/30'">
                    <div class="text-2xl mb-1">ğŸ“‹</div>
                    <span class="text-sm font-medium">{{ t('useTemplate') }}</span>
                </label>
              </div>

              <!-- AI ç”Ÿæˆæ¨¡å¼ -->
              @if(messageMode() === 'ai') {
                <div class="space-y-3">
                    <!-- AI é…ç½®ç‹€æ…‹ -->
                    <div class="flex items-center justify-between p-2 bg-slate-200/30 dark:bg-slate-800/30 rounded-lg">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">ğŸ¤–</span>
                            <span class="text-sm text-slate-400">
                                {{ aiApiType() === 'local' ? 'æœ¬åœ° AI' : aiApiType() === 'openai' ? 'OpenAI' : aiApiType() === 'custom' ? 'è‡ªå®šç¾© API' : 'Gemini' }}
                            </span>
                            @if(isAiConfigured()) {
                                <span class="text-xs text-green-400">âœ“ å·²é€£æ¥</span>
                            }
                        </div>
                        @if(ragEnabled()) {
                            <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded">ğŸ“š RAG å·²å•Ÿç”¨</span>
                        }
                    </div>
                    
                    <!-- å®¢æˆ¶è³‡è¨Šæ‘˜è¦ -->
                    @if(generationState().lead) {
                        <div class="p-2 bg-cyan-500/10 border border-cyan-500/20 rounded-lg text-xs text-slate-400">
                            <strong class="text-cyan-400">å®¢æˆ¶è³‡è¨Šï¼š</strong>
                            @{{ generationState().lead.username }} 
                            @if(generationState().lead.sourceGroup) { | ä¾†æº: {{ generationState().lead.sourceGroup }} }
                            @if(generationState().lead.triggerKeyword) { | è§¸ç™¼è©: {{ generationState().lead.triggerKeyword }} }
                        </div>
                    }
                    
                    <!-- è‡ªå®šç¾©æç¤ºè© -->
                    <div>
                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ t('customizePrompt') }}</label>
                        <textarea 
                            [ngModel]="generationState().customPrompt" 
                            (ngModelChange)="updateCustomPrompt($event)"
                            rows="2" 
                            class="form-textarea w-full bg-slate-200/50 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg py-2 px-3 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            [placeholder]="t('aiPromptPlaceholder')">
                        </textarea>
                    </div>
                    
                    <!-- ç”ŸæˆæŒ‰éˆ• -->
                    <div class="flex items-center justify-center gap-3">
                        <button (click)="generateMessage()" [disabled]="generationState().status === 'loading' || !isAiConfigured()" class="bg-gradient-to-r from-purple-500 to-cyan-500 hover:from-purple-600 hover:to-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-lg disabled:from-slate-400 disabled:to-slate-500 disabled:shadow-none disabled:cursor-not-allowed flex items-center gap-2">
                            @if(generationState().status === 'loading') { 
                                <span class="animate-spin">âŸ³</span> <span>{{ t('generating') }}</span> 
                            } @else { 
                                <span>âœ¨</span> <span>{{ t('generateWithAi') }}</span> 
                            }
                        </button>
                        @if(generationState().status === 'success') {
                            <button (click)="generateMessage()" class="p-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg" title="é‡æ–°ç”Ÿæˆ">
                                ğŸ”„
                            </button>
                        }
                    </div>
                    
                    @if(!isAiConfigured()) {
                        <div class="p-3 bg-amber-500/10 border border-amber-500/20 text-amber-400 rounded-lg text-sm text-center">
                            âš ï¸ {{ t('aiNotConfigured') }} 
                            <a (click)="currentView.set('settings'); closeLeadDetailModal()" class="text-cyan-400 hover:underline cursor-pointer ml-1">{{ t('goToSettings') }}</a>
                        </div>
                    }
                    
                    @if(generationState().status === 'error') {
                        <div class="p-3 bg-red-500/10 border border-red-500/20 text-red-400 rounded-lg text-sm">
                            <strong>{{ t('error') }}:</strong> {{ generationState().error }}
                            <button (click)="generateMessage()" class="ml-2 text-cyan-400 hover:underline">é‡è©¦</button>
                        </div>
                    }
                    
                    <!-- ç”ŸæˆæˆåŠŸæç¤º -->
                    @if(generationState().status === 'success' && generationState().generatedMessage) {
                        <div class="p-3 bg-green-500/10 border border-green-500/20 rounded-lg">
                            <p class="text-xs text-green-400 mb-2">âœ“ AI å·²ç”Ÿæˆæ¶ˆæ¯ï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹æ–¹ç·¨è¼¯å¾Œç™¼é€</p>
                        </div>
                    }
                </div>
              }

              <!-- æ¨¡æ¿é¸æ“‡æ¨¡å¼ -->
              @if(messageMode() === 'template') {
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                    <label class="block text-sm font-medium text-cyan-400 mb-2">ğŸ“‹ {{ t('selectTemplate') }}</label>
                    <select 
                        (change)="applyTemplate($event)"
                        class="form-select w-full bg-slate-900/50 border-cyan-500/30 rounded-lg py-2.5 px-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <option value="">{{ t('selectTemplatePlaceholder') }}</option>
                        @for(template of messageTemplates(); track template.id) {
                            <option [value]="template.id">{{ template.name }}</option>
                        }
                    </select>
                </div>
              }

              <!-- æ¶ˆæ¯å…§å®¹ç·¨è¼¯å€ -->
              <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                <div class="flex items-center justify-between mb-2">
                    <label class="text-sm font-medium text-cyan-400">âœï¸ {{ t('messageContent') }}</label>
                    <span class="text-xs text-slate-500 bg-slate-700/50 px-2 py-1 rounded">{{ editableMessage().length }} {{ t('characters') }}</span>
                </div>
                <textarea 
                    [ngModel]="editableMessage()" 
                    (ngModelChange)="editableMessage.set($event)"
                    rows="5" 
                    class="form-textarea w-full bg-slate-900/50 border-cyan-500/30 rounded-lg py-3 px-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 resize-none placeholder-slate-500"
                    [placeholder]="t('messageContentPlaceholder')">
                </textarea>
              </div>

              <!-- é™„ä»¶å€åŸŸ - æ”¯æŒå¤šæ–‡ä»¶é¸æ“‡ -->
              <div class="space-y-3">
                <div class="flex items-center gap-3 flex-wrap">
                  <button (click)="selectAttachment('image', true)" class="flex items-center gap-2 bg-slate-800/50 hover:bg-cyan-500/20 text-slate-300 hover:text-cyan-400 text-sm font-medium py-2 px-4 rounded-lg transition-all border border-slate-700/50 hover:border-cyan-500/30">
                      ğŸ–¼ï¸ {{ t('attachImage') }}
                  </button>
                  <button (click)="selectAttachment('file', true)" class="flex items-center gap-2 bg-slate-800/50 hover:bg-cyan-500/20 text-slate-300 hover:text-cyan-400 text-sm font-medium py-2 px-4 rounded-lg transition-all border border-slate-700/50 hover:border-cyan-500/30">
                      ğŸ“ {{ t('attachFile') }}
                  </button>
                  @if(generationState().attachments.length > 0) {
                    <button (click)="addMoreAttachments('file')" class="flex items-center gap-2 bg-green-500/20 hover:bg-green-500/30 text-green-400 text-sm font-medium py-2 px-3 rounded-lg transition-all border border-green-500/30">
                        â• æ·»åŠ æ›´å¤š
                    </button>
                    <button (click)="clearAllAttachments()" class="flex items-center gap-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 text-sm font-medium py-2 px-3 rounded-lg transition-all border border-red-500/30">
                        ğŸ—‘ï¸ æ¸…ç©º
                    </button>
                  }
                </div>
                
                <!-- é™„ä»¶åˆ—è¡¨ -->
                @if(generationState().attachments.length > 0) {
                  <div class="p-3 rounded-xl bg-cyan-500/10 border border-cyan-500/30">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm text-cyan-400 font-medium">ğŸ“ é™„ä»¶åˆ—è¡¨ ({{ generationState().attachments.length }})</span>
                      <span class="text-xs text-slate-500">
                        ç¸½å¤§å°: {{ getTotalAttachmentSize() }} MB
                      </span>
                    </div>
                    <div class="space-y-2 max-h-40 overflow-y-auto">
                      @for(attachment of generationState().attachments; track attachment.name; let i = $index) {
                        <div class="flex items-center justify-between text-sm bg-slate-800/50 rounded-lg px-3 py-2">
                          <div class="flex items-center gap-2 truncate flex-1 min-w-0">
                            @if(attachment.type === 'image') { <span class="text-green-400">ğŸ–¼ï¸</span> }
                            @else { <span class="text-blue-400">ğŸ“„</span> }
                            <span class="truncate text-white">{{ attachment.name }}</span>
                            @if(attachment.fileSize) {
                              <span class="text-slate-500 text-xs whitespace-nowrap">
                                ({{ (attachment.fileSize / 1024 / 1024).toFixed(2) }} MB)
                              </span>
                            }
                            @if(attachment.filePath) {
                              <span class="text-green-500 text-xs">âœ“</span>
                            }
                          </div>
                          <button (click)="removeAttachmentByIndex(i)" class="text-red-400 hover:text-red-300 text-lg font-bold p-1 hover:bg-red-500/20 rounded ml-2">&times;</button>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>

              <!-- ç™¼é€ç‹€æ…‹æç¤º -->
              @if(!canSendMessage() && !lead.doNotContact) {
                <div class="p-3 bg-amber-500/10 border border-amber-500/30 rounded-xl">
                  <p class="text-sm text-amber-400">
                    @if(senderAccounts().length === 0) {
                      âš ï¸ ç„¡å¯ç”¨ç™¼é€å¸³è™Ÿ
                    } @else if(!selectedSenderId()) {
                      âš ï¸ è«‹é¸æ“‡ç™¼é€å¸³è™Ÿ
                    } @else if(editableMessage().trim().length === 0 && !generationState().attachment && generationState().attachments.length === 0) {
                      âš ï¸ è«‹è¼¸å…¥è¨Šæ¯å…§å®¹æˆ–æ·»åŠ é™„ä»¶
                    }
                  </p>
                </div>
              }
              @if(lead.doNotContact) {
                <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-xl">
                  <p class="text-sm text-red-400">ğŸš« æ­¤å®¢æˆ¶å·²åŠ å…¥é»‘åå–®ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯</p>
                </div>
              }

              <!-- åº•éƒ¨æ“ä½œæŒ‰éˆ• - é’è—è‰²ä¸»é¡Œ -->
              <div class="flex justify-between items-center pt-4 border-t border-cyan-500/20">
                <button (click)="addToDoNotContact(lead.id)" [disabled]="lead.doNotContact" class="text-sm text-red-400 hover:text-red-300 disabled:text-slate-500 disabled:cursor-not-allowed flex items-center gap-1.5 px-3 py-2 rounded-lg hover:bg-red-500/10 transition-all">
                    ğŸš« {{ lead.doNotContact ? t('userOnDNC') : t('addToDNC') }}
                </button>
                <div class="flex gap-3">
                    <button (click)="closeLeadDetailModal()" class="bg-slate-700/80 hover:bg-slate-600 text-slate-300 font-medium py-2.5 px-5 rounded-xl transition-all border border-slate-600/50 hover:border-slate-500">
                        {{ t('cancel') }}
                    </button>
                    <button 
                        (click)="sendMessageToLead()" 
                        [disabled]="!canSendMessage() || lead.doNotContact" 
                        class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg shadow-cyan-500/30 disabled:from-slate-500 disabled:to-slate-600 disabled:shadow-none disabled:cursor-not-allowed flex items-center gap-2 transition-all">
                        âœˆï¸ {{ t('sendMessage') }}
                    </button>
                </div>
              </div>
            </div>
        }
        @if(leadDetailView() === 'history') {
            <div class="py-4">
                <!-- åŠ è¼‰å®Œæ•´èŠå¤©è¨˜éŒ„æŒ‰éˆ• -->
                <div class="mb-4 flex items-center justify-between">
                    <button 
                        (click)="loadChatHistory(lead.userId)" 
                        [disabled]="isLoadingChatHistory()"
                        class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm disabled:bg-slate-500 disabled:cursor-not-allowed flex items-center gap-2">
                        @if(isLoadingChatHistory()) {
                            <span class="animate-spin">âŸ³</span> <span>åŠ è¼‰ä¸­...</span>
                        } @else {
                            <span>ğŸ’¬</span> <span>åŠ è¼‰å®Œæ•´èŠå¤©è¨˜éŒ„</span>
                        }
                    </button>
                    @if(selectedChatUserId() === lead.userId && chatHistory().length > 0) {
                        <span class="text-xs text-slate-500">å…± {{ chatHistory().length }} æ¢æ¶ˆæ¯</span>
                    }
                </div>
                
                <!-- å®Œæ•´èŠå¤©è¨˜éŒ„ï¼ˆå¦‚æœå·²åŠ è¼‰ï¼‰ -->
                @if(selectedChatUserId() === lead.userId && chatHistory().length > 0) {
                    <div 
                        class="h-96 overflow-y-auto space-y-3 mb-4 bg-slate-200/30 dark:bg-slate-800/30 rounded-lg p-4"
                        (scroll)="onChatHistoryScroll($event)">
                        @for(message of chatHistory(); track trackByChatMessageId($index, message)) {
                            @if(message.role === 'user') {
                                <!-- ç”¨æˆ¶æ¶ˆæ¯ï¼ˆå·¦å´ï¼‰ -->
                                <div class="flex justify-start">
                                    <div class="max-w-[75%]">
                                        <div class="bg-slate-700 text-white rounded-2xl rounded-bl-sm px-4 py-2">
                                            <p class="text-sm">{{ message.content }}</p>
                                        </div>
                                        <p class="text-xs text-slate-500 mt-1">{{ formatTimestamp(message.timestamp) }}</p>
                                    </div>
                                </div>
                            } @else if(message.role === 'assistant') {
                                <!-- AI å›å¾©ï¼ˆå³å´ï¼‰ -->
                                <div class="flex justify-end">
                                    <div class="max-w-[75%]">
                                        <div class="bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-2xl rounded-br-sm px-4 py-2 shadow-lg">
                                            <p class="text-sm">{{ message.content }}</p>
                                        </div>
                                        <div class="flex items-center justify-end gap-2 mt-1">
                                            <span class="text-xs text-slate-500">{{ formatTimestamp(message.timestamp) }}</span>
                                            <span class="text-xs bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded">ğŸ¤– AI</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        
                        <!-- åŠ è¼‰æ›´å¤šæŒ‡ç¤ºå™¨ -->
                        @if(chatHistoryLoadingMore()) {
                            <div class="text-center py-4">
                                <span class="animate-spin text-cyan-400">âŸ³</span>
                                <span class="ml-2 text-sm text-slate-500">åŠ è¼‰ä¸­...</span>
                            </div>
                        }
                        
                        @if(chatHistoryHasMore() && !chatHistoryLoadingMore()) {
                            <div class="text-center py-2">
                                <button 
                                    (click)="loadMoreChatHistory()"
                                    class="text-sm text-cyan-400 hover:text-cyan-300">
                                    åŠ è¼‰æ›´å¤šæ¶ˆæ¯
                                </button>
                            </div>
                        }
                    </div>
                }
                
                <!-- äº’å‹•æ­·å²ï¼ˆåŸæœ‰é¡¯ç¤ºï¼‰ -->
                <div class="h-96 overflow-y-auto">
                    <div class="space-y-3 mb-4">
                        @for(item of lead.interactionHistory; track trackByChatMessageId($index, item)) {
                        @if(item.type.includes('Sent') || item.type.includes('Message')) {
                            <!-- æˆ‘æ–¹æ¶ˆæ¯ï¼ˆå³å´ï¼‰ -->
                            <div class="flex justify-end">
                                <div class="max-w-[75%]">
                                    <div class="bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-2xl rounded-br-sm px-4 py-2 shadow-lg">
                                        <p class="text-sm">{{ item.content }}</p>
                                    </div>
                                    <div class="flex items-center justify-end gap-2 mt-1">
                                        <span class="text-xs text-slate-500">{{ formatTimestamp(item.timestamp) }}</span>
                                        @if(item.type.includes('AI')) {
                                            <span class="text-xs bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded">ğŸ¤– AI</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        } @else if(item.type.includes('Reply') || item.type.includes('Received')) {
                            <!-- å°æ–¹å›å¾©ï¼ˆå·¦å´ï¼‰ -->
                            <div class="flex justify-start">
                                <div class="max-w-[75%]">
                                    <div class="bg-slate-700 text-white rounded-2xl rounded-bl-sm px-4 py-2">
                                        <p class="text-sm">{{ item.content }}</p>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">{{ formatTimestamp(item.timestamp) }}</p>
                                </div>
                            </div>
                        } @else {
                            <!-- ç³»çµ±æ¶ˆæ¯ï¼ˆå±…ä¸­ï¼‰ -->
                            <div class="flex justify-center">
                                <div class="bg-slate-800/50 text-slate-400 text-xs px-3 py-1 rounded-full">
                                    {{ item.type }}: {{ item.content }} Â· {{ formatTimestamp(item.timestamp) }}
                                </div>
                            </div>
                        }
                    }
                </div>
                </div>
                
                @if(lead.interactionHistory.length === 0 && (!selectedChatUserId() || chatHistory().length === 0)) { 
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">ğŸ’¬</div>
                        <p class="text-slate-500 dark:text-slate-400">{{ t('noHistoryFound') }}</p>
                        <p class="text-xs text-slate-500 mt-2">é»æ“Šã€ŒåŠ è¼‰å®Œæ•´èŠå¤©è¨˜éŒ„ã€æŸ¥çœ‹æ‰€æœ‰å°è©±</p>
                    </div>
                }
                
                <!-- AI åˆ†æé¢æ¿ -->
                @if(lead.interactionHistory.length > 0) {
                    <div class="mt-4 p-3 bg-slate-800/50 rounded-lg border border-cyan-500/20">
                        <h4 class="text-sm font-medium text-cyan-400 mb-2 flex items-center gap-2">
                            <span>ğŸ“Š</span> AI å°è©±åˆ†æ
                        </h4>
                        <div class="grid grid-cols-3 gap-2 text-center text-xs">
                            <div class="p-2 bg-slate-700/50 rounded">
                                <p class="text-slate-400">ç¸½äº’å‹•</p>
                                <p class="text-lg font-bold text-white">{{ lead.interactionHistory.length }}</p>
                            </div>
                            <div class="p-2 bg-slate-700/50 rounded">
                                <p class="text-slate-400">å°è©±éšæ®µ</p>
                                <p class="text-sm font-bold text-cyan-400">{{ lead.status || 'åˆæ¬¡æ¥è§¸' }}</p>
                            </div>
                            <div class="p-2 bg-slate-700/50 rounded">
                                <p class="text-slate-400">èˆˆè¶£ç¨‹åº¦</p>
                                <p class="text-lg">â­â­â­</p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        </div><!-- å…§å®¹å€åŸŸçµæŸ -->
      </div>
    </div>
  }

  <!-- æ‰¹é‡æ“ä½œæ­·å²å°è©±æ¡† -->
  @if(showBatchOperationHistory()) {
    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" (click)="showBatchOperationHistory.set(false)">
      <div class="bg-slate-100 dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-300 dark:border-slate-700 w-full max-w-3xl max-h-[80vh] overflow-hidden" (click)="$event.stopPropagation()">
        <!-- æ¨™é¡Œ -->
        <div class="p-4 border-b border-slate-300 dark:border-slate-700 flex items-center justify-between bg-slate-200/50 dark:bg-slate-800/50">
          <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
            <svg class="h-5 w-5 text-purple-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>
            æ‰¹é‡æ“ä½œæ­·å²
          </h3>
          <button (click)="showBatchOperationHistory.set(false)" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-white">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        
        <!-- å…§å®¹ -->
        <div class="p-4 overflow-y-auto max-h-[60vh]">
          @if(batchOperationHistory().length === 0) {
            <div class="text-center py-8 text-slate-500">
              <svg class="h-12 w-12 mx-auto mb-3 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
              <p>æš«ç„¡æ“ä½œæ­·å²</p>
            </div>
          } @else {
            <div class="space-y-3">
              @for(op of batchOperationHistory(); track op.id) {
                <div class="bg-slate-200/50 dark:bg-slate-800/50 rounded-lg p-3 border border-slate-300 dark:border-slate-700"
                     [class.opacity-50]="op.reversed">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <div class="p-2 rounded-lg" 
                           [class.bg-cyan-500/20]="op.operationType === 'update_status'"
                           [class.bg-blue-500/20]="op.operationType === 'add_tag'"
                           [class.bg-red-500/20]="op.operationType === 'delete' || op.operationType === 'add_to_dnc'">
                        <svg class="h-4 w-4" 
                             [class.text-cyan-400]="op.operationType === 'update_status'"
                             [class.text-blue-400]="op.operationType === 'add_tag'"
                             [class.text-red-400]="op.operationType === 'delete' || op.operationType === 'add_to_dnc'"
                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                      </div>
                      <div>
                        <p class="font-medium text-slate-900 dark:text-white">{{ getOperationTypeName(op.operationType) }}</p>
                        <p class="text-xs text-slate-500">
                          {{ op.itemCount }} é … Â· {{ formatBatchOperationDate(op.createdAt) }}
                          @if(op.reversed) {
                            <span class="text-yellow-500 ml-2">ï¼ˆå·²æ’¤éŠ·ï¼‰</span>
                          }
                        </p>
                      </div>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="text-sm">
                        <span class="text-green-400">{{ op.successCount }} æˆåŠŸ</span>
                        @if(op.failureCount > 0) {
                          <span class="text-red-400 ml-2">{{ op.failureCount }} å¤±æ•—</span>
                        }
                      </div>
                      @if(op.isReversible && !op.reversed) {
                        <button (click)="undoBatchOperation(op.id)" 
                                class="text-xs bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 px-2 py-1 rounded">
                          æ’¤éŠ·
                        </button>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
        
        <!-- åº•éƒ¨ -->
        <div class="p-4 border-t border-slate-300 dark:border-slate-700 bg-slate-200/50 dark:bg-slate-800/50 flex justify-end">
          <button (click)="showBatchOperationHistory.set(false)" 
                  class="px-4 py-2 bg-slate-300 dark:bg-slate-700 hover:bg-slate-400 dark:hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors">
            é—œé–‰
          </button>
        </div>
      </div>
    </div>
  }
  
  <!-- é¦–æ¬¡å•Ÿå‹•æ­¡è¿å‘å° -->
  @if (showWelcomeDialog()) {
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100]">
      <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden border border-cyan-500/30">
        
        <!-- é ­éƒ¨ -->
        <div class="bg-gradient-to-r from-cyan-500 to-purple-500 p-6 text-center">
          <h1 class="text-3xl font-bold text-white mb-2">ğŸš€ æ­¡è¿ä½¿ç”¨ TG-AIæ™ºæ§ç‹</h1>
          <p class="text-cyan-100">AI é©…å‹•çš„ Telegram ç‡ŸéŠ·è‡ªå‹•åŒ–å¹³å°</p>
        </div>
        
        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div class="flex justify-center gap-2 py-4 bg-slate-800/50">
          <div class="w-3 h-3 rounded-full transition-all" 
               [class]="welcomeStep() >= 1 ? 'bg-cyan-500' : 'bg-slate-600'"></div>
          <div class="w-3 h-3 rounded-full transition-all" 
               [class]="welcomeStep() >= 2 ? 'bg-cyan-500' : 'bg-slate-600'"></div>
          <div class="w-3 h-3 rounded-full transition-all" 
               [class]="welcomeStep() >= 3 ? 'bg-cyan-500' : 'bg-slate-600'"></div>
        </div>
        
        <!-- å…§å®¹å€åŸŸ -->
        <div class="p-6">
          @switch (welcomeStep()) {
            @case (1) {
              <!-- æ­¥é©Ÿ 1: æ­¡è¿ä»‹ç´¹ -->
              <div class="text-center space-y-6">
                <div class="grid grid-cols-3 gap-4 mb-6">
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <div class="text-3xl mb-2">ğŸ¤–</div>
                    <div class="text-sm font-medium text-white">AI è‡ªå‹•å›è¦†</div>
                    <div class="text-xs text-slate-400">æ™ºèƒ½å®¢æœåŠ©æ‰‹</div>
                  </div>
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <div class="text-3xl mb-2">ğŸ”</div>
                    <div class="text-sm font-medium text-white">è³‡æºç™¼ç¾</div>
                    <div class="text-xs text-slate-400">è‡ªå‹•æœç´¢ç¾¤çµ„</div>
                  </div>
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <div class="text-3xl mb-2">ğŸ“Š</div>
                    <div class="text-sm font-medium text-white">æ•¸æ“šåˆ†æ</div>
                    <div class="text-xs text-slate-400">è½‰åŒ–è¿½è¹¤å ±è¡¨</div>
                  </div>
                </div>
                
                <p class="text-slate-300">
                  TG-AIæ™ºæ§ç‹ å°‡å¹«åŠ©æ‚¨è‡ªå‹•åŒ– Telegram ç‡ŸéŠ·æµç¨‹ï¼Œ<br>
                  è®“æ‚¨å°ˆæ³¨æ–¼æ¥­å‹™å¢é•·è€Œéé‡è¤‡æ“ä½œã€‚
                </p>
              </div>
            }
            @case (2) {
              <!-- æ­¥é©Ÿ 2: AI è¨­ç½® -->
              <div class="space-y-4">
                <h3 class="text-lg font-semibold text-white text-center mb-4">ğŸ¦™ AI æœå‹™é…ç½®</h3>
                
                <!-- Ollama æª¢æ¸¬ç‹€æ…‹ -->
                <div class="p-4 rounded-xl" 
                     [class]="ollamaDetected() ? 'bg-green-500/20 border border-green-500/30' : 'bg-yellow-500/20 border border-yellow-500/30'">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">{{ ollamaDetected() ? 'âœ…' : 'âš ï¸' }}</span>
                      <div>
                        <div class="font-medium text-white">
                          {{ ollamaDetected() ? 'Ollama å·²æª¢æ¸¬åˆ°' : 'Ollama æœªé‹è¡Œ' }}
                        </div>
                        <div class="text-sm text-slate-400">
                          {{ ollamaDetected() ? 'æœ¬åœ° AI æœå‹™å¯ç”¨' : 'å»ºè­°å®‰è£ Ollama ç²å¾—å…è²» AI èƒ½åŠ›' }}
                        </div>
                      </div>
                    </div>
                    <button (click)="detectOllama()" [disabled]="isDetectingOllama()"
                            class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm text-white disabled:opacity-50">
                      {{ isDetectingOllama() ? 'æª¢æ¸¬ä¸­...' : 'é‡æ–°æª¢æ¸¬' }}
                    </button>
                  </div>
                </div>
                
                @if (ollamaDetected()) {
                  <!-- æ¨¡å‹é¸æ“‡ -->
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <label class="block text-sm font-medium text-slate-300 mb-2">é¸æ“‡ AI æ¨¡å‹</label>
                    @if (detectedOllamaModels().length > 0) {
                      <select [ngModel]="localAiModel()" (ngModelChange)="localAiModel.set($event)"
                              class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2 px-3 text-white">
                        @for (model of detectedOllamaModels(); track model) {
                          <option [value]="model">{{ model }}</option>
                        }
                      </select>
                    } @else {
                      <input [ngModel]="localAiModel()" (ngModelChange)="localAiModel.set($event)"
                             class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2 px-3 text-white"
                             placeholder="qwen2:7b">
                    }
                    <p class="text-xs text-slate-500 mt-1">æ¨è–¦ï¼šqwen2:7bï¼ˆä¸­è‹±æ–‡é€šç”¨ï¼‰</p>
                  </div>
                } @else {
                  <!-- Ollama å®‰è£æŒ‡å— -->
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <div class="text-sm text-slate-300 space-y-2">
                      <p class="font-medium">ğŸ“¦ å®‰è£ Ollamaï¼ˆå…è²»ï¼‰ï¼š</p>
                      <code class="block bg-slate-800 p-2 rounded text-cyan-400 text-xs">
                        curl -fsSL https://ollama.com/install.sh | sh
                      </code>
                      <p class="text-xs text-slate-500">
                        å®‰è£å¾Œé‹è¡Œ <code class="text-cyan-400">ollama pull qwen2:7b</code> ä¸‹è¼‰æ¨¡å‹
                      </p>
                    </div>
                  </div>
                  
                  <!-- å‚™é¸ï¼šé›²ç«¯ AI -->
                  <div class="p-4 bg-slate-700/50 rounded-xl">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" [checked]="aiAutoFallback()" (change)="aiAutoFallback.set(!aiAutoFallback())"
                             class="w-4 h-4 text-cyan-500 rounded">
                      <span class="text-sm text-slate-300">ä½¿ç”¨é›²ç«¯ AI ä½œç‚ºå‚™é¸</span>
                    </label>
                    @if (aiAutoFallback()) {
                      <div class="mt-2">
                        <select [ngModel]="aiBackupProvider()" (ngModelChange)="aiBackupProvider.set($event)"
                                class="w-full bg-slate-800 border border-slate-600 rounded py-1 px-2 text-sm text-white">
                          <option value="gemini">Google Geminiï¼ˆå…è²»é¡åº¦ï¼‰</option>
                          <option value="openai">OpenAI GPT</option>
                        </select>
                      </div>
                    }
                  </div>
                }
              </div>
            }
            @case (3) {
              <!-- æ­¥é©Ÿ 3: å®Œæˆ -->
              <div class="text-center space-y-6">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <h3 class="text-2xl font-bold text-white">è¨­ç½®å®Œæˆï¼</h3>
                <p class="text-slate-300">
                  æ‚¨å·²æº–å‚™å¥½é–‹å§‹ä½¿ç”¨ TG-AIæ™ºæ§ç‹ã€‚<br>
                  æ¥ä¸‹ä¾†è«‹æ·»åŠ æ‚¨çš„ç¬¬ä¸€å€‹ Telegram å¸³è™Ÿã€‚
                </p>
                
                <div class="p-4 bg-cyan-500/10 rounded-xl border border-cyan-500/30">
                  <div class="text-sm text-slate-300 space-y-1">
                    <p>âœ… AI æœå‹™ï¼š{{ ollamaDetected() ? 'Ollama æœ¬åœ° AI' : 'é›²ç«¯ AI' }}</p>
                    @if (ollamaDetected()) {
                      <p>âœ… æ¨¡å‹ï¼š{{ localAiModel() }}</p>
                    }
                    <p>âœ… è‡ªå‹•é™ç´šï¼š{{ aiAutoFallback() ? 'å·²å•Ÿç”¨' : 'å·²ç¦ç”¨' }}</p>
                  </div>
                </div>
              </div>
            }
          }
        </div>
        
        <!-- åº•éƒ¨æŒ‰éˆ• -->
        <div class="p-6 bg-slate-800/50 flex justify-between items-center">
          <button (click)="skipFirstRunSetup()" class="text-sm text-slate-400 hover:text-white transition-colors">
            è·³éè¨­ç½®
          </button>
          
          <div class="flex gap-3">
            @if (welcomeStep() > 1) {
              <button (click)="welcomeStep.set(welcomeStep() - 1)"
                      class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                ä¸Šä¸€æ­¥
              </button>
            }
            
            @if (welcomeStep() < 3) {
              <button (click)="welcomeStep.set(welcomeStep() + 1)"
                      class="px-6 py-2 bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600 text-white font-medium rounded-lg transition-all">
                ä¸‹ä¸€æ­¥
              </button>
            } @else {
              <button (click)="completeFirstRunSetup()"
                      class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-medium rounded-lg transition-all">
                é–‹å§‹ä½¿ç”¨ ğŸš€
              </button>
            }
          </div>
        </div>
      </div>
    </div>
  }
  
  <!-- å­¤ç«‹ Session æ¢å¾©å°è©±æ¡† -->
  @if (showOrphanSessionDialog()) {
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100]">
      <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden border border-amber-500/50">
        
        <!-- é ­éƒ¨ -->
        <div class="bg-amber-500/20 p-6 text-center border-b border-amber-500/30">
          <div class="text-5xl mb-3">ğŸ”„</div>
          <h2 class="text-xl font-bold text-amber-400">ç™¼ç¾å¯æ¢å¾©çš„å¸³è™Ÿ</h2>
          <p class="text-slate-400 text-sm mt-2">
            ç™¼ç¾ {{ orphanSessions().length }} å€‹ Session æ–‡ä»¶éœ€è¦æ‰‹å‹•æ¢å¾©
          </p>
        </div>
        
        <!-- å…§å®¹ -->
        <div class="p-6 space-y-4">
          <p class="text-slate-300 text-sm">
            é€™äº› Session æ–‡ä»¶å­˜åœ¨æ–¼ç³»çµ±ä¸­ï¼Œä½†æœªåœ¨æ•¸æ“šåº«ä¸­æ‰¾åˆ°å°æ‡‰çš„å¸³è™Ÿè¨˜éŒ„ã€‚
            æ‚¨å¯ä»¥å˜—è©¦æ¢å¾©é€™äº›å¸³è™Ÿï¼Œæˆ–é¸æ“‡å¿½ç•¥ã€‚
          </p>
          
          <!-- Session åˆ—è¡¨ -->
          <div class="bg-slate-700/50 rounded-lg p-3 max-h-48 overflow-y-auto space-y-2">
            @for (session of orphanSessions(); track session.phone) {
              <div class="flex items-center justify-between p-2 bg-slate-600/50 rounded-lg">
                <div class="flex items-center gap-3">
                  <span class="text-2xl">ğŸ“±</span>
                  <div>
                    <p class="text-white font-medium">+{{ session.phone }}</p>
                    @if (session.hasMetadata && session.metadata) {
                      <p class="text-green-400 text-xs">
                        âœ“ æœ‰å…ƒæ•¸æ“š: {{ session.metadata.firstName || '' }} {{ session.metadata.username ? '@' + session.metadata.username : '' }}
                      </p>
                    } @else {
                      <p class="text-amber-400 text-xs">âš  ç„¡å…ƒæ•¸æ“šï¼Œéœ€è¦é‡æ–°ç™»éŒ„é©—è­‰</p>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
          
          <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3">
            <p class="text-blue-400 text-sm">
              ğŸ’¡ <strong>æç¤ºï¼š</strong> æ¢å¾©å¾Œï¼Œå¸³è™Ÿå°‡ä»¥ã€Œé›¢ç·šã€ç‹€æ…‹æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚
              æ‚¨éœ€è¦é»æ“Šã€Œç™»éŒ„ã€ä¾†é‡æ–°é€£æ¥å¸³è™Ÿã€‚
            </p>
          </div>
        </div>
        
        <!-- åº•éƒ¨æŒ‰éˆ• -->
        <div class="p-4 bg-slate-700/30 flex justify-end gap-3">
          <button (click)="dismissOrphanSessionDialog()" 
                  class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors">
            ç¨å¾Œè™•ç†
          </button>
          <button (click)="recoverOrphanSessions()" 
                  [disabled]="isRecoveringOrphanSessions()"
                  class="px-4 py-2 bg-amber-500 hover:bg-amber-600 disabled:opacity-50 text-white rounded-lg transition-colors flex items-center gap-2">
            @if (isRecoveringOrphanSessions()) {
              <span class="animate-spin">â³</span>
              <span>æ¢å¾©ä¸­...</span>
            } @else {
              <span>ğŸ”„</span>
              <span>æ¢å¾©å¸³è™Ÿ</span>
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- å¾Œç«¯éŒ¯èª¤æç¤ºå°è©±æ¡† -->
  @if (showBackendErrorDialog()) {
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100]">
      <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden border border-red-500/50">
        
        <!-- é ­éƒ¨ -->
        <div class="bg-red-500/20 p-6 text-center border-b border-red-500/30">
          <div class="text-5xl mb-3">âš ï¸</div>
          <h2 class="text-xl font-bold text-red-400">Python å¾Œç«¯æœªé‹è¡Œ</h2>
        </div>
        
        <!-- å…§å®¹ -->
        <div class="p-6 space-y-4">
          <p class="text-slate-300">
            ç¨‹åºéœ€è¦ Python ç’°å¢ƒæ‰èƒ½æ­£å¸¸é‹è¡Œã€‚è«‹ç¢ºä¿ï¼š
          </p>
          
          <div class="bg-slate-700/50 rounded-lg p-4 space-y-3">
            <div class="flex items-start gap-3">
              <span class="text-cyan-400">1.</span>
              <div>
                <p class="text-white font-medium">å®‰è£ Python 3.9+</p>
                <a href="https://www.python.org/downloads/" target="_blank" 
                   class="text-cyan-400 text-sm hover:underline">
                  https://www.python.org/downloads/
                </a>
              </div>
            </div>
            
            <div class="flex items-start gap-3">
              <span class="text-cyan-400">2.</span>
              <div>
                <p class="text-white font-medium">å®‰è£æ™‚å‹¾é¸ "Add Python to PATH"</p>
                <p class="text-slate-400 text-sm">ç¢ºä¿ Python æ·»åŠ åˆ°ç³»çµ±ç’°å¢ƒè®Šé‡</p>
              </div>
            </div>
            
            <div class="flex items-start gap-3">
              <span class="text-cyan-400">3.</span>
              <div>
                <p class="text-white font-medium">å®‰è£ä¾è³´</p>
                <code class="block bg-slate-800 text-green-400 text-sm p-2 rounded mt-1">
                  pip install pyrogram tgcrypto aiosqlite
                </code>
              </div>
            </div>
            
            <div class="flex items-start gap-3">
              <span class="text-cyan-400">4.</span>
              <div>
                <p class="text-white font-medium">é‡æ–°å•Ÿå‹•ç¨‹åº</p>
              </div>
            </div>
          </div>
          
          @if (backendError()) {
            <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
              <p class="text-red-400 text-sm">
                <span class="font-medium">éŒ¯èª¤è©³æƒ…ï¼š</span>
                {{ backendError() }}
              </p>
            </div>
          }
        </div>
        
        <!-- åº•éƒ¨æŒ‰éˆ• -->
        <div class="p-4 bg-slate-700/30 flex justify-end gap-3">
          <button (click)="showBackendErrorDialog.set(false)" 
                  class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors">
            æˆ‘çŸ¥é“äº†
          </button>
        </div>
      </div>
    </div>
  }
  
    <!-- å¾Œç«¯ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    @if (!backendRunning()) {
      <div class="fixed bottom-4 right-4 z-50 bg-red-500/90 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 cursor-pointer hover:bg-red-600"
           (click)="showBackendErrorDialog.set(true)">
        <span class="animate-pulse">âš ï¸</span>
        <span class="text-sm font-medium">Python å¾Œç«¯æœªé‹è¡Œ</span>
      </div>
    }
    
    <!-- å‰µå»ºé—œéµè©é›†å°è©±æ¡† -->
    @if (showKeywordSetCreator()) {
      <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100]"
           (click)="cancelNewKeywordSet()">
        <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden border border-cyan-500/30"
             (click)="$event.stopPropagation()">
          
          <!-- é ­éƒ¨ -->
          <div class="bg-gradient-to-r from-cyan-500/20 to-blue-500/20 p-4 border-b border-slate-700/50">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
              <span>ğŸ”‘</span> å‰µå»ºé—œéµè©é›†
            </h2>
          </div>
          
          <!-- å…§å®¹ -->
          <div class="p-6">
            <label class="block text-sm text-slate-400 mb-2">é—œéµè©é›†åç¨±</label>
            <input type="text" 
                   class="w-full bg-slate-900/50 border border-slate-600 rounded-lg px-4 py-3 text-white 
                          focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-colors"
                   placeholder="ä¾‹å¦‚ï¼šè²·å®¶æ„å‘ã€ç”¢å“è«®è©¢..."
                   [value]="newKeywordSet().name"
                   (input)="newKeywordSet.set({ name: $any($event.target).value })"
                   (keyup.enter)="submitNewKeywordSet()"
                   autofocus>
            <p class="text-xs text-slate-500 mt-2">
              ğŸ’¡ å‰µå»ºå¾Œå¯åœ¨è©é›†ä¸­æ·»åŠ å¤šå€‹é—œéµè©
            </p>
          </div>
          
          <!-- åº•éƒ¨æŒ‰éˆ• -->
          <div class="p-4 bg-slate-700/30 flex justify-end gap-3">
            <button (click)="cancelNewKeywordSet()" 
                    class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors">
              å–æ¶ˆ
            </button>
            <button (click)="submitNewKeywordSet()" 
                    class="px-4 py-2 bg-cyan-500 hover:bg-cyan-400 text-white rounded-lg transition-colors font-medium">
              å‰µå»º
            </button>
          </div>
        </div>
      </div>
    }
  </div>
} @else {
  <!-- æœªèªè­‰ç”¨æˆ¶ï¼šé¡¯ç¤ºè·¯ç”±å…§å®¹ï¼ˆç™»å…¥é é¢ç­‰ï¼‰ -->
  <div class="auth-wrapper" style="min-height: 100vh; background: linear-gradient(to bottom right, #0f172a, #1e293b, #0f172a);">
    <router-outlet></router-outlet>
  </div>
} <!-- çµæŸ @if (isAuthenticated()) -->