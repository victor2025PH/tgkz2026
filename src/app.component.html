<!-- ğŸ†• å…¨å±€ç¶²çµ¡ç‹€æ…‹å’Œèªè­‰éæ¸¡å‹•ç•« -->
<app-network-status></app-network-status>
<app-auth-transition></app-auth-transition>

<!-- å…¨å±€é€šçŸ¥å’Œå°è©±æ¡† -->
<app-toast></app-toast>
<app-global-confirm-dialog></app-global-confirm-dialog>
<app-global-input-dialog></app-global-input-dialog>
<!-- ğŸ†• å®æ—¶å‘Šè­¦é€šçŸ¥ -->
<app-alert-notification></app-alert-notification>
<!-- ğŸ”§ P8-1: é›¢ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ï¼ˆé›¢ç·š/æ…¢é€Ÿ/åŒæ­¥ä¸­ï¼‰ -->
<app-offline-indicator></app-offline-indicator>

<!-- ğŸ†• P2 å„ªåŒ–ï¼šæ™ºèƒ½é€£æ¥ç‹€æ…‹æŒ‡ç¤ºå™¨ï¼ˆæ”¯æŒé›¢ç·šæ¨¡å¼ï¼‰ -->
@if (backendConnectionState() !== 'connected' || !offlineCache.isOnline()) {
  <div class="fixed bottom-4 right-4 z-50">
    <!-- ğŸ†• P2-2: é›¢ç·šæ¨¡å¼ï¼šç°é» -->
    @if (!offlineCache.isOnline()) {
      <div class="group relative">
        <div class="w-3 h-3 rounded-full bg-slate-500 cursor-default"></div>
        <div class="absolute bottom-full right-0 mb-2 hidden group-hover:block">
          <div class="bg-slate-800/95 backdrop-blur-sm rounded-lg px-3 py-2 shadow-lg border border-slate-700 whitespace-nowrap">
            <p class="text-xs text-slate-400">ğŸ“´ é›¢ç·šæ¨¡å¼</p>
            @if (offlineCache.isCacheValid()) {
              <p class="text-xs text-slate-500 mt-1">ä½¿ç”¨ç·©å­˜æ•¸æ“š</p>
            }
            @if (offlineCache.hasPendingOperations()) {
              <p class="text-xs text-amber-400 mt-1">{{ offlineCache.pendingOperations().length }} å€‹å¾…åŒæ­¥æ“ä½œ</p>
            }
          </div>
        </div>
      </div>
    }
    
    <!-- é€£æ¥ä¸­ï¼šå°è—é» -->
    @else if (backendConnectionState() === 'connecting') {
      <div class="group relative">
        <div class="w-3 h-3 rounded-full bg-cyan-500 animate-pulse cursor-default"></div>
        <div class="absolute bottom-full right-0 mb-2 hidden group-hover:block">
          <div class="bg-slate-800/95 backdrop-blur-sm rounded-lg px-3 py-2 shadow-lg border border-slate-700 whitespace-nowrap">
            <p class="text-xs text-slate-300">{{ backendConnectionMessage() }}</p>
          </div>
        </div>
      </div>
    }
    
    <!-- é™ç´šæ¨¡å¼ï¼šå°é»ƒé» -->
    @else if (backendConnectionState() === 'timeout') {
      <div class="group relative">
        <div class="w-3 h-3 rounded-full bg-amber-500 cursor-pointer" (click)="retryConnection()"></div>
        <div class="absolute bottom-full right-0 mb-2 hidden group-hover:block">
          <div class="bg-slate-800/95 backdrop-blur-sm rounded-lg px-3 py-2 shadow-lg border border-slate-700 whitespace-nowrap">
            <p class="text-xs text-amber-400">é™ç´šæ¨¡å¼ï¼ˆé»æ“Šé‡é€£ï¼‰</p>
          </div>
        </div>
      </div>
    }
    
    <!-- éŒ¯èª¤ï¼šå°ç´…é» -->
    @else if (backendConnectionState() === 'error') {
      <div class="group relative">
        <div class="w-3 h-3 rounded-full bg-red-500 cursor-pointer animate-pulse" (click)="retryConnection()"></div>
        <div class="absolute bottom-full right-0 mb-2 hidden group-hover:block">
          <div class="bg-slate-800/95 backdrop-blur-sm rounded-lg px-3 py-2 shadow-lg border border-slate-700 whitespace-nowrap">
            <p class="text-xs text-red-400">{{ backendConnectionMessage() }}</p>
            <p class="text-xs text-slate-500 mt-1">é»æ“Šé‡è©¦</p>
          </div>
        </div>
      </div>
    }
  </div>
}

<!-- ğŸ†• æˆåŠŸå‹•ç•«è¦†è“‹å±¤ -->
@if (showSuccessOverlay()) {
  <div class="fixed inset-0 z-[100] flex items-center justify-center pointer-events-none">
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="absolute inset-0 bg-black/40 animate-fade-in"></div>
    
    <!-- æˆåŠŸå‹•ç•«å¡ç‰‡ -->
    <div class="relative z-10 animate-success-pop">
      <!-- å…‰åœˆæ•ˆæœ -->
      <div class="absolute inset-0 -m-8 rounded-full bg-gradient-to-r from-emerald-500/20 to-cyan-500/20 blur-xl animate-pulse"></div>
      
      <!-- ä¸»å¡ç‰‡ -->
      <div class="relative bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 shadow-2xl border border-emerald-500/30">
        <!-- æˆåŠŸåœ–æ¨™ -->
        <div class="flex justify-center mb-4">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-emerald-500 to-cyan-500 flex items-center justify-center shadow-lg shadow-emerald-500/30">
            <span class="text-4xl animate-bounce">{{ successOverlayConfig()?.icon || 'âœ…' }}</span>
          </div>
        </div>
        
        <!-- æ¨™é¡Œ -->
        <div class="text-center">
          <h3 class="text-xl font-bold text-white mb-1">{{ successOverlayConfig()?.title || 'æ“ä½œæˆåŠŸ' }}</h3>
          @if (successOverlayConfig()?.subtitle) {
            <p class="text-sm text-slate-400">{{ successOverlayConfig()?.subtitle }}</p>
          }
        </div>
        
        <!-- è£é£¾ç²’å­ -->
        <div class="absolute -top-2 -left-2 w-4 h-4 bg-emerald-400 rounded-full animate-ping"></div>
        <div class="absolute -top-1 -right-3 w-3 h-3 bg-cyan-400 rounded-full animate-ping" style="animation-delay: 0.1s"></div>
        <div class="absolute -bottom-2 -left-1 w-2 h-2 bg-emerald-300 rounded-full animate-ping" style="animation-delay: 0.2s"></div>
        <div class="absolute -bottom-1 -right-2 w-3 h-3 bg-cyan-300 rounded-full animate-ping" style="animation-delay: 0.3s"></div>
      </div>
    </div>
  </div>
}

<!-- å…¨å±€å‘½ä»¤é¢æ¿ (Cmd+K) -->
<app-command-palette (navigate)="handleCommandNavigation($event)"></app-command-palette>

<!-- ğŸ”§ Phase6-2: å°è©±æ¡†ä½¿ç”¨ @defer æ‡¶åŠ è¼‰ â€” é¦–æ¬¡æ‰“é–‹æ™‚åŠ è¼‰ï¼Œæ¸›å°‘åˆå§‹åŒ…å¤§å° -->
<!-- æ‰¹é‡ç™¼é€å°è©±æ¡† -->
@defer (when dialogService.showBatchMessageDialog()) {
  <app-batch-send-dialog
    [isOpen]="dialogService.showBatchMessageDialog()"
    [targets]="dialogService.batchSendTargets()"
    (closeDialog)="dialogService.closeBatchSend()"
    (sendComplete)="handleBatchSendComplete($event)">
  </app-batch-send-dialog>
}

<!-- æ‰¹é‡æ‹‰ç¾¤å°è©±æ¡† -->
@defer (when dialogService.showBatchInviteDialog()) {
  <app-batch-invite-dialog
    [isOpen]="dialogService.showBatchInviteDialog()"
    [targets]="dialogService.batchInviteTargets()"
    [accounts]="accounts()"
    (closeDialog)="dialogService.closeBatchInvite()"
    (inviteComplete)="handleBatchInviteComplete($event)">
  </app-batch-invite-dialog>
}

<!-- æˆå“¡æå–é…ç½®å°è©±æ¡† -->
@defer (when dialogService.showMemberExtractionDialog() || showMemberExtractionDialog()) {
  <app-member-extraction-dialog
    [isOpen]="dialogService.showMemberExtractionDialog() || showMemberExtractionDialog()"
    [group]="dialogService.memberExtractionGroup() || memberExtractionGroup()"
    (closeDialog)="closeMemberExtractionDialogUnified()"
    (startExtractionEvent)="handleMemberExtractionStart($event)"
    (memberCountRefreshed)="handleMemberCountRefreshed($event)">
  </app-member-extraction-dialog>
}

<!-- ğŸ”§ Phase6-2: æœƒå“¡/æ”¯ä»˜çµ„ä»¶å»¶é²åŠ è¼‰ -->
<app-membership-dialog></app-membership-dialog>
@defer (on idle) {
  <app-payment></app-payment>
  <app-upgrade-prompt></app-upgrade-prompt>
}

<!-- QR æƒç¢¼ç™»å…¥å½ˆçª— -->
@if (showQrLoginDialog()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" (click)="closeQrLogin()"></div>
    <div class="relative z-10">
      <app-qr-login 
        (closed)="closeQrLogin()" 
        (loginSuccess)="onQrLoginSuccess($event)">
      </app-qr-login>
    </div>
  </div>
}

<!-- ä¸»æ‡‰ç”¨ç•Œé¢ -->
<!-- ğŸ†• P1.3: çµ±ä¸€ä½¿ç”¨ Router è™•ç†ç™»å…¥/æœªç™»å…¥ç‹€æ…‹ -->
<!-- æœªèªè­‰ç”¨æˆ¶æœƒè¢« AuthGuard è‡ªå‹•é‡å®šå‘åˆ° /auth/login -->
@if (isAuthenticated()) {
  <!-- å·²èªè­‰ç”¨æˆ¶é¡¯ç¤ºä¸»ç•Œé¢ -->
  <div class="flex h-screen" style="background-color: var(--bg-primary); color: var(--text-primary);">
    
    <!-- Onboarding æ–°æ‰‹å¼•å¯¼ -->
    <app-onboarding #onboardingRef
                    (navigateEvent)="handleOnboardingNavigate($event)">
    </app-onboarding>
    
    <!-- Progress Dialog -->
    <app-progress-dialog
      [show]="progressDialog().show"
      [title]="progressDialog().title"
      [progress]="progressDialog().progress"
      [cancellable]="progressDialog().cancellable">
    </app-progress-dialog>
    
    <!-- åˆªé™¤ç¢ºèªå°è©±æ¡† -->
    <!-- Phase 10: Delete Confirm Dialog Component -->
    @if(deleteConfirmDialog().show) {
      <app-delete-confirm-dialog
        [dialogData]="deleteConfirmDialog()"
        (cancel)="cancelDeleteLeads()"
        (confirm)="executeDeleteLeads()" />
    }
    
    <!-- Phase 10: Invite Group Dialog Component -->
    @if(showInviteGroupDialog()) {
      <app-invite-group-dialog
        [groups]="collabGroups()"
        (close)="showInviteGroupDialog.set(false)"
        (inviteToGroup)="executeInviteToGroup($event)"
        (goCreateGroup)="currentView.set('multi-role'); showInviteGroupDialog.set(false)" />
    }
    
    <!-- ğŸ”§ P8-3: ç§»å‹•ç«¯æ¼¢å ¡é¸å–®æŒ‰éˆ•ï¼ˆå›ºå®šåœ¨å·¦ä¸Šè§’ï¼‰ -->
    @if (isMobile()) {
      <button (click)="toggleMobileMenu()" 
              class="fixed top-3 left-3 z-[9999] w-10 h-10 rounded-lg flex items-center justify-center transition-all duration-200"
              style="background: linear-gradient(135deg, #06b6d4, #8b5cf6); box-shadow: 0 2px 12px rgba(6, 182, 212, 0.5);"
              [attr.aria-expanded]="mobileMenuOpen()"
              aria-controls="mobile-sidebar"
              [attr.aria-label]="mobileMenuOpen() ? 'é—œé–‰é¸å–®' : 'é–‹å•Ÿé¸å–®'">
        @if (mobileMenuOpen()) {
          <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        } @else {
          <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        }
      </button>
    }
    
    <!-- ğŸ”§ P8-3: ç§»å‹•ç«¯åŠé€æ˜é®ç½© -->
    @if (isMobile() && mobileMenuOpen()) {
      <div class="fixed inset-0 bg-black/50 z-[998] backdrop-blur-sm transition-opacity"
           (click)="mobileMenuOpen.set(false)"></div>
    }
    
    <!-- Sidebar -->
    <aside id="mobile-sidebar" role="navigation" aria-label="ä¸»å°èˆª"
           class="backdrop-blur-sm flex-shrink-0 flex flex-col sidebar h-screen transition-all duration-300" 
           [class.w-64]="!sidebarCollapsed() || (isMobile() && mobileMenuOpen())"
           [class.w-16]="sidebarCollapsed() && !isMobile()"
           [class.mobile-sidebar-hidden]="isMobile() && !mobileMenuOpen()"
           [class.mobile-sidebar-visible]="isMobile() && mobileMenuOpen()"
           style="background-color: var(--bg-sidebar); border-right: 1px solid var(--border-default);">
      <!-- é ‚éƒ¨å›ºå®šå€åŸŸï¼šLogo + ç”¨æˆ¶ä¿¡æ¯ -->
      <div class="flex-shrink-0">
        <!-- æ”¶ç¸®/å±•é–‹æŒ‰éˆ•ï¼ˆæ¡Œé¢ç«¯æ‰é¡¯ç¤ºï¼‰ -->
        @if (!isMobile()) {
        <button (click)="toggleSidebarCollapse()" 
                class="absolute top-3 -right-3 z-50 w-6 h-6 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110"
                style="background: linear-gradient(135deg, #06b6d4, #8b5cf6); box-shadow: 0 2px 8px rgba(6, 182, 212, 0.4);"
                [title]="sidebarCollapsed() ? 'å±•é–‹å´é‚Šæ¬„' : 'æ”¶ç¸®å´é‚Šæ¬„'">
          <svg class="w-3.5 h-3.5 text-white transition-transform duration-200" 
               [class.rotate-180]="sidebarCollapsed()"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        }
        
        <!-- Logo - TG-AIæ™ºæ§ç‹ -->
        <div class="flex items-center gap-3 p-4" [class.justify-center]="sidebarCollapsed()">
           <div class="relative flex-shrink-0">
             <!-- Logo ç™¼å…‰æ•ˆæœ -->
             <div class="absolute inset-0 rounded-xl blur-md opacity-50" 
                  style="background: linear-gradient(135deg, #06b6d4, #8b5cf6);"></div>
             <!-- Logo SVG -->
             <svg class="h-10 w-10 relative z-10" viewBox="0 0 64 64" fill="none">
               <!-- ä¸­å¿ƒå…­é‚Šå½¢ -->
               <path d="M32 8L52 20V44L32 56L12 44V20L32 8Z" fill="url(#sidebarLogoGrad)" stroke="url(#sidebarLogoStroke)" stroke-width="1.5"/>
               <!-- ç´™é£›æ©Ÿ -->
               <path d="M22 28L40 22L34 36L28 32L22 28Z" fill="white" opacity="0.95"/>
               <path d="M28 32L34 36L32 42L28 32Z" fill="white" opacity="0.8"/>
               <!-- çš‡å†  -->
               <path d="M24 12L28 8L32 11L36 8L40 12L38 16H26L24 12Z" fill="#fbbf24"/>
               <circle cx="32" cy="8" r="1.2" fill="#fef3c7"/>
               <!-- æ¼¸è®Š -->
               <defs>
                 <linearGradient id="sidebarLogoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                   <stop offset="0%" stop-color="#0891b2"/>
                   <stop offset="100%" stop-color="#7c3aed"/>
                 </linearGradient>
                 <linearGradient id="sidebarLogoStroke" x1="0%" y1="0%" x2="100%" y2="100%">
                   <stop offset="0%" stop-color="#22d3ee"/>
                   <stop offset="100%" stop-color="#a78bfa"/>
                 </linearGradient>
               </defs>
             </svg>
           </div>
          @if (!sidebarCollapsed()) {
            <div>
              <h1 class="text-xl font-bold bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">{{ t('app.title') }}</h1>
              <p class="text-xs" style="color: var(--text-muted);">{{ t('app.subtitle') }}</p>
            </div>
          }
        </div>

        <!-- ğŸ”§ è¨­ç½®å„ªåŒ–ï¼šéˆ´éºåƒ…ä½œå…¥å£ï¼Œé»æ“Šè·³è½‰è¨­ç½®-é€šçŸ¥èˆ‡æé†’ -->
        <div class="px-3 mb-2 flex justify-end">
          <a [routerLink]="['/settings']" [queryParams]="{ tab: 'notifications' }" 
             class="p-2 rounded-lg hover:bg-slate-700/50 text-slate-400 hover:text-cyan-400 transition-colors"
             [title]="t('settings.tabs.notifications')">
            <span class="text-lg" aria-hidden="true">ğŸ””</span>
          </a>
        </div>

        <!-- ğŸ”§ P3-4: ç”¨æˆ¶ä¿¡æ¯å€åŸŸ â€”â€” å¸¶éª¨æ¶å±é˜²æ­¢åç¨±é–ƒçˆ -->
        @if (!currentUser()) {
          <!-- éª¨æ¶å±ï¼šç”¨æˆ¶æ•¸æ“šæœªè¼‰å…¥æ™‚é¡¯ç¤º -->
          <div class="user-profile-card mx-3 mb-4 p-3 rounded-xl level-bronze">
            <div class="flex items-center gap-3 animate-pulse">
              <div class="w-12 h-12 rounded-full bg-slate-600/40"></div>
              <div class="flex-1 min-w-0">
                <div class="h-4 w-20 bg-slate-600/40 rounded mb-2"></div>
                <div class="h-3 w-14 bg-slate-600/30 rounded"></div>
              </div>
            </div>
          </div>
        } @else {
          <!-- å¯¦éš›ç”¨æˆ¶ä¿¡æ¯ï¼ˆç¾åŒ–ç‰ˆ - ç‹è€…æ¦®è€€é¢¨æ ¼ï¼‰ -->
          <div class="user-profile-card mx-3 mb-4 p-3 rounded-xl cursor-pointer transition-all duration-300 hover:scale-[1.02] group"
               [class.level-bronze]="userMembershipLevel() === 'bronze'"
               [class.level-silver]="userMembershipLevel() === 'silver'"
               [class.level-gold]="userMembershipLevel() === 'gold'"
               [class.level-diamond]="userMembershipLevel() === 'diamond'"
               [class.level-star]="userMembershipLevel() === 'star'"
               [class.level-king]="userMembershipLevel() === 'king'"
               (click)="changeView('profile')">
            <div class="flex items-center gap-3">
              <!-- é ­åƒæ¡†ï¼ˆå¸¶ç­‰ç´šé‚Šæ¡†ï¼‰ -->
              <div class="avatar-wrapper relative">
                <!-- å‹•æ…‹å…‰ç’° -->
                <div class="avatar-glow absolute inset-0 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                     [class.glow-bronze]="userMembershipLevel() === 'bronze'"
                     [class.glow-silver]="userMembershipLevel() === 'silver'"
                     [class.glow-gold]="userMembershipLevel() === 'gold'"
                     [class.glow-diamond]="userMembershipLevel() === 'diamond'"
                     [class.glow-star]="userMembershipLevel() === 'star'"
                     [class.glow-king]="userMembershipLevel() === 'king'">
                </div>
                <!-- é ­åƒé‚Šæ¡† -->
                <div class="avatar-border w-12 h-12 rounded-full p-[2px]"
                     [class.border-bronze]="userMembershipLevel() === 'bronze'"
                     [class.border-silver]="userMembershipLevel() === 'silver'"
                     [class.border-gold]="userMembershipLevel() === 'gold'"
                     [class.border-diamond]="userMembershipLevel() === 'diamond'"
                     [class.border-star]="userMembershipLevel() === 'star'"
                     [class.border-king]="userMembershipLevel() === 'king'">
                  <!-- é ­åƒå…§å®¹ -->
                  <div class="w-full h-full rounded-full flex items-center justify-center text-white font-bold text-lg avatar-inner"
                       [class.avatar-bronze]="userMembershipLevel() === 'bronze'"
                       [class.avatar-silver]="userMembershipLevel() === 'silver'"
                       [class.avatar-gold]="userMembershipLevel() === 'gold'"
                       [class.avatar-diamond]="userMembershipLevel() === 'diamond'"
                       [class.avatar-star]="userMembershipLevel() === 'star'"
                       [class.avatar-king]="userMembershipLevel() === 'king'">
                    {{ (currentUser()?.displayName || currentUser()?.display_name || currentUser()?.username)?.charAt(0).toUpperCase() || '?' }}
                  </div>
                </div>
                <!-- æœƒå“¡å¾½ç« ï¼ˆå³ä¸‹è§’ï¼‰ -->
                @if (userMembershipLevel() !== 'bronze') {
                  <div class="vip-badge absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-lg"
                       [class.badge-silver]="userMembershipLevel() === 'silver'"
                       [class.badge-gold]="userMembershipLevel() === 'gold'"
                       [class.badge-diamond]="userMembershipLevel() === 'diamond'"
                       [class.badge-star]="userMembershipLevel() === 'star'"
                       [class.badge-king]="userMembershipLevel() === 'king'">
                    @switch (userMembershipLevel()) {
                      @case ('silver') { <span class="animate-pulse">ğŸ¥ˆ</span> }
                      @case ('gold') { <span class="animate-pulse">ğŸ¥‡</span> }
                      @case ('diamond') { <span class="animate-pulse">ğŸ’</span> }
                      @case ('star') { <span class="animate-pulse">ğŸŒŸ</span> }
                      @case ('king') { <span class="animate-bounce">ğŸ‘‘</span> }
                    }
                  </div>
                }
              </div>
              
              <!-- ç”¨æˆ¶ä¿¡æ¯ -->
              <div class="flex-1 min-w-0">
                <div class="text-sm font-semibold truncate" style="color: var(--text-primary);">
                  {{ currentUser()?.displayName || currentUser()?.display_name || currentUser()?.username || 'ç”¨æˆ¶' }}
                </div>
                <div class="flex items-center gap-1.5 mt-0.5">
                  <!-- ğŸ”§ P1-2: ä½¿ç”¨çµ±ä¸€çš„æœƒå“¡ç­‰ç´šå¾½ç« çµ„ä»¶ -->
                  <user-level-badge [level]="userMembershipLevel()" size="sm" />
                </div>
              </div>
              
              <!-- ç®­é ­ -->
              <div class="arrow-icon transition-transform duration-300 group-hover:translate-x-1">
                <svg class="w-4 h-4" style="color: var(--text-muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </div>
            </div>
          </div>
        }
      </div>
      
      <!-- å¯æ»¾å‹•çš„å°èˆªå€åŸŸ -->
      <nav class="flex-1 overflow-y-auto overflow-x-hidden sidebar-nav mt-2 px-2 pb-2">
        @let view = currentView();
        
        <!-- æœƒå“¡ä¸­å¿ƒï¼ˆç§»åˆ°ç¬¬ä¸€å€‹ï¼‰ -->
        <a (click)="changeView('membership-center')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'membership-center'"
           [style.background-color]="view === 'membership-center' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'membership-center' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
           <span>{{ t('menu.membershipCenter') }}</span>
        </a>
        
        <!-- æˆ‘çš„éŒ¢åŒ… -->
        <a (click)="changeView('wallet')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'wallet'"
           [style.background-color]="view === 'wallet' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'wallet' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
           <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
           <span>{{ t('menu.myWallet') }}</span>
        </a>
        
        <!-- é¦–é ï¼ˆæƒ…æ™¯æ„ŸçŸ¥å„€è¡¨ç›¤ï¼‰ -->
        <a (click)="changeView('home')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'home'"
           [style.background-color]="view === 'home' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'home' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
          <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          <span>é¦–é </span>
        </a>
        
        <!-- å„€è¡¨ç›¤ï¼ˆé‹æ§ä¸­å¿ƒï¼‰ -->
        <a (click)="changeView('dashboard')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
           [class.active]="view === 'dashboard'"
           [style.background-color]="view === 'dashboard' ? 'var(--sidebar-item-active)' : 'transparent'"
           [style.color]="view === 'dashboard' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
          <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
          <span>é‹æ§ä¸­å¿ƒ</span>
        </a>
        
        <!-- åˆ†çµ„ï¼šğŸ”§ æ‰‹å‹•æ“ä½œï¼ˆå¯æŠ˜ç–Šï¼‰ -->
        <div class="sidebar-group">
          <button (click)="toggleSidebarGroup('manual')" 
                  class="w-full flex items-center justify-between px-3 py-2 mt-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer group">
            <span class="sidebar-group-title text-xs uppercase tracking-wider flex items-center gap-1" style="color: var(--sidebar-group-title);">
              ğŸ”§ {{ t('menu.manualOperations') }}
            </span>
            <svg class="w-3.5 h-3.5 transition-transform duration-200" 
                 [class.rotate-180]="!isSidebarGroupExpanded('manual')"
                 style="color: var(--sidebar-group-title);" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          @if (isSidebarGroupExpanded('manual')) {
            <div class="sidebar-group-content overflow-hidden">
              <!-- å¸³è™Ÿç®¡ç† -->
              <a (click)="changeView('accounts')" 
                 data-tour="accounts"
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'accounts' || view === 'add-account' || view === 'api-credentials'"
                 [style.background-color]="(view === 'accounts' || view === 'add-account' || view === 'api-credentials') ? 'var(--sidebar-item-active)' : 'transparent'"
                 [style.color]="(view === 'accounts' || view === 'add-account' || view === 'api-credentials') ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                 <span>{{ t('accounts') }}</span>
              </a>
              
              <!-- ğŸ” æœç´¢ç™¼ç¾ï¼šç™¼ç¾ç¾¤çµ„èˆ‡é »é“ -->
              <a (click)="changeView('search-discovery')" 
                 data-tour="search-discovery"
                 [title]="t('menu.searchDiscoveryHint')"
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1 relative"
                 [class.active]="view === 'search-discovery'"
                 [style.background-color]="view === 'search-discovery' ? 'rgba(6, 182, 212, 0.2)' : 'transparent'"
                 [style.color]="view === 'search-discovery' ? '#22d3ee' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                 <span>{{ t('menu.searchDiscovery') }}</span>
                 <span class="absolute right-2 px-1.5 py-0.5 text-[10px] bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-full font-bold">NEW</span>
              </a>
              
              <!-- ğŸ“¦ è³‡æºä¸­å¿ƒï¼šæˆ‘çš„æ”¶è—èˆ‡è³‡æºç®¡ç† -->
              <a (click)="changeView('resource-center')" 
                 [title]="t('menu.resourceCenterHint')"
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1 relative"
                 [class.active]="view === 'resource-center' || view === 'resources'"
                 [style.background-color]="(view === 'resource-center' || view === 'resources') ? 'rgba(6, 182, 212, 0.2)' : 'transparent'"
                 [style.color]="(view === 'resource-center' || view === 'resources') ? '#22d3ee' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                 <span>{{ t('menu.resourceCenter') }}</span>
              </a>
              
              <!-- ğŸ“¤ ç™¼é€æ§åˆ¶å° -->
              <a (click)="changeView('leads')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'leads'"
                 [style.background-color]="view === 'leads' ? 'var(--sidebar-item-active)' : 'transparent'"
                 [style.color]="view === 'leads' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
                 <span>{{ t('menu.sendConsole') }}</span>
              </a>
            </div>
          }
        </div>
        
        <!-- åˆ†çµ„ï¼šğŸ“¡ ç›£æ§ä¸­å¿ƒï¼ˆå¯æŠ˜ç–Šï¼‰ -->
        <div class="sidebar-group">
          <button (click)="toggleSidebarGroup('monitoring')" 
                  class="w-full flex items-center justify-between px-3 py-2 mt-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer group">
            <span class="sidebar-group-title text-xs uppercase tracking-wider font-semibold flex items-center gap-1" style="color: var(--sidebar-group-title);">
              <span class="inline-block w-5 h-5 rounded bg-gradient-to-br from-cyan-500 to-blue-500 text-center leading-5 text-[10px]">ğŸ“¡</span>
              {{ t('menu.monitoringCenter') }}
            </span>
            <svg class="w-3.5 h-3.5 transition-transform duration-200" 
                 [class.rotate-180]="!isSidebarGroupExpanded('monitoring')"
                 style="color: var(--sidebar-group-title);" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          @if (isSidebarGroupExpanded('monitoring')) {
            <div class="sidebar-group-content overflow-hidden">
              <!-- âš™ï¸ è‡ªå‹•åŒ–ç¸½è¦½ -->
              <a (click)="changeView('automation')" 
                 data-tour="monitoring-center"
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 cursor-pointer mb-1 relative group"
                 [class.active]="view === 'automation'"
                 [style.background-color]="view === 'automation' ? 'rgba(6, 182, 212, 0.15)' : 'transparent'"
                 [style.color]="view === 'automation' ? '#22d3ee' : 'var(--sidebar-text)'">
                  <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-all"
                       [class.bg-gradient-to-br]="view === 'automation'"
                       [class.from-cyan-500]="view === 'automation'"
                       [class.to-blue-500]="view === 'automation'"
                       [class.bg-slate-700/50]="view !== 'automation'"
                       [class.group-hover:bg-slate-700]="view !== 'automation'">
                     <span class="text-lg">ğŸ“Š</span>
                  </div>
                  <div class="flex flex-col">
                     <span class="font-medium">{{ t('menu.automationOverview') }}</span>
                     <span class="text-[10px] opacity-60">{{ t('menu.configAndStatus') }}</span>
                  </div>
              </a>
              
              <!-- ğŸ“± ç›£æ§å¸³è™Ÿ -->
              <a (click)="changeView('monitoring-accounts')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'monitoring-accounts'"
                 [style.background-color]="view === 'monitoring-accounts' ? 'rgba(6, 182, 212, 0.1)' : 'transparent'"
                 [style.color]="view === 'monitoring-accounts' ? '#22d3ee' : 'var(--sidebar-text)'">
                 <span class="text-lg ml-1">ğŸ“±</span>
                 <span>{{ t('menu.monitorAccounts') }}</span>
              </a>
              
              <!-- ğŸ’¬ ç›£æ§ç¾¤çµ„ -->
              <a (click)="changeView('monitoring-groups')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'monitoring-groups'"
                 [style.background-color]="view === 'monitoring-groups' ? 'rgba(16, 185, 129, 0.1)' : 'transparent'"
                 [style.color]="view === 'monitoring-groups' ? '#34d399' : 'var(--sidebar-text)'">
                 <span class="text-lg ml-1">ğŸ’¬</span>
                 <span>{{ t('menu.monitorGroups') }}</span>
              </a>
              
              <!-- ğŸ”‘ é—œéµè©é›† -->
              <a (click)="changeView('keyword-sets')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'keyword-sets'"
                 [style.background-color]="view === 'keyword-sets' ? 'rgba(139, 92, 246, 0.1)' : 'transparent'"
                 [style.color]="view === 'keyword-sets' ? '#a78bfa' : 'var(--sidebar-text)'">
                 <span class="text-lg ml-1">ğŸ”‘</span>
                 <span>{{ t('menu.keywordSets') }}</span>
              </a>
              
              <!-- ğŸ“ èŠå¤©æ¨¡æ¿ -->
              <a (click)="changeView('chat-templates')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'chat-templates'"
                 [style.background-color]="view === 'chat-templates' ? 'rgba(236, 72, 153, 0.1)' : 'transparent'"
                 [style.color]="view === 'chat-templates' ? '#f472b6' : 'var(--sidebar-text)'">
                 <span class="text-lg ml-1">ğŸ“</span>
                 <span>{{ t('menu.chatTemplates') }}</span>
              </a>
              
              <!-- âš¡ è§¸ç™¼è¦å‰‡ -->
              <a (click)="changeView('trigger-rules')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'trigger-rules'"
                 [style.background-color]="view === 'trigger-rules' ? 'rgba(251, 146, 60, 0.1)' : 'transparent'"
                 [style.color]="view === 'trigger-rules' ? '#fb923c' : 'var(--sidebar-text)'">
                 <span class="text-lg ml-1">âš¡</span>
                 <span>{{ t('menu.triggerRules') }}</span>
              </a>
              
              <!-- ğŸ‘¥ æ”¶é›†ç”¨æˆ¶ï¼ˆå»£å‘Šè­˜åˆ¥ï¼‰ -->
              <a (click)="changeView('collected-users')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'collected-users'"
                 [style.background-color]="view === 'collected-users' ? 'rgba(139, 92, 246, 0.1)' : 'transparent'"
                 [style.color]="view === 'collected-users' ? '#a78bfa' : 'var(--sidebar-text)'">
                 <span class="text-lg ml-1">ğŸ‘¥</span>
                 <span>{{ t('menu.collectedUsers') }}</span>
                 <span class="ml-auto text-xs px-1.5 py-0.5 bg-violet-500/20 text-violet-400 rounded">NEW</span>
              </a>
            </div>
          }
        </div>
        
        <!-- åˆ†çµ„ï¼šAI æ™ºèƒ½ç‡ŸéŠ·ï¼ˆå¯æŠ˜ç–Šï¼‰ -->
        <div class="sidebar-group">
          <button (click)="toggleSidebarGroup('marketing')" 
                  class="w-full flex items-center justify-between px-3 py-2 mt-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer group">
            <span class="sidebar-group-title text-xs uppercase tracking-wider font-semibold flex items-center gap-1" style="color: var(--sidebar-group-title);">
              <span class="inline-block w-5 h-5 rounded bg-gradient-to-br from-violet-500 to-fuchsia-500 text-center leading-5 text-[10px]">AI</span>
              {{ t('menu.aiMarketing') }}
            </span>
            <svg class="w-3.5 h-3.5 transition-transform duration-200" 
                 [class.rotate-180]="!isSidebarGroupExpanded('marketing')"
                 style="color: var(--sidebar-group-title);" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          @if (isSidebarGroupExpanded('marketing')) {
            <div class="sidebar-group-content overflow-hidden">
              <!-- 1ï¸âƒ£ AI ç‡ŸéŠ·åŠ©æ‰‹ (ç¬¬ä¸€æ­¥ï¼šç­–åŠƒ) - é‘½çŸ³åŠŸèƒ½ -->
              <a (click)="changeView('ai-assistant')" 
           data-tour="ai-assistant"
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 cursor-pointer mb-1.5 relative group"
           [class.active]="view === 'ai-assistant'"
           [class.opacity-50]="!membershipService.hasFeature('strategyPlanning')"
           [style.background-color]="view === 'ai-assistant' ? 'rgba(249, 115, 22, 0.15)' : 'transparent'"
           [style.color]="view === 'ai-assistant' ? '#fb923c' : 'var(--sidebar-text)'"
           [title]="!membershipService.hasFeature('strategyPlanning') ? 'éœ€è¦ é‘½çŸ³ç‹ç‰Œ æˆ–ä»¥ä¸Šæœƒå“¡' : ''">
           <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-all"
                [class.bg-gradient-to-br]="view === 'ai-assistant'"
                [class.from-orange-500]="view === 'ai-assistant'"
                [class.to-amber-500]="view === 'ai-assistant'"
                [class.bg-slate-700/50]="view !== 'ai-assistant'"
                [class.group-hover:bg-slate-700]="view !== 'ai-assistant'">
             <span class="text-lg">ğŸ¯</span>
           </div>
           <div class="flex flex-col">
             <span class="font-medium">ç­–ç•¥è¦åŠƒ</span>
             <span class="text-[10px] opacity-60">AI ç‡ŸéŠ·åŠ©æ‰‹</span>
           </div>
           @if (membershipService.hasFeature('strategyPlanning')) {
             <span class="absolute right-2 px-2 py-0.5 text-[9px] bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-full font-bold shadow-lg shadow-orange-500/20">1</span>
           } @else {
             <span class="absolute right-2 text-xs">ğŸ’</span>
           }
        </a>
        
        <!-- 2ï¸âƒ£ AI åœ˜éšŠéŠ·å”® (ç¬¬äºŒæ­¥ï¼šåŸ·è¡Œ) - é‘½çŸ³åŠŸèƒ½ -->
        <a (click)="changeView('ai-team')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 cursor-pointer mb-1.5 relative group"
           [class.active]="view === 'ai-team'"
           [class.opacity-50]="!membershipService.hasFeature('autoExecution')"
           [style.background-color]="view === 'ai-team' ? 'rgba(168, 85, 247, 0.15)' : 'transparent'"
           [style.color]="view === 'ai-team' ? '#c084fc' : 'var(--sidebar-text)'"
           [title]="!membershipService.hasFeature('autoExecution') ? 'éœ€è¦ é‘½çŸ³ç‹ç‰Œ æˆ–ä»¥ä¸Šæœƒå“¡' : ''">
           <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-all"
                [class.bg-gradient-to-br]="view === 'ai-team'"
                [class.from-purple-500]="view === 'ai-team'"
                [class.to-pink-500]="view === 'ai-team'"
                [class.bg-slate-700/50]="view !== 'ai-team'"
                [class.group-hover:bg-slate-700]="view !== 'ai-team'">
             <span class="text-lg">ğŸ¤–</span>
           </div>
           <div class="flex flex-col">
             <span class="font-medium">è‡ªå‹•åŸ·è¡Œ</span>
             <span class="text-[10px] opacity-60">AI åœ˜éšŠéŠ·å”®</span>
           </div>
           @if (membershipService.hasFeature('autoExecution')) {
             <span class="absolute right-2 px-2 py-0.5 text-[9px] bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full font-bold shadow-lg shadow-purple-500/20">2</span>
           } @else {
             <span class="absolute right-2 text-xs">ğŸ’</span>
           }
        </a>
        
        <!-- 3ï¸âƒ£ æ™ºèƒ½åˆ†æ (ç¬¬ä¸‰æ­¥ï¼šåˆ†æ) - é»ƒé‡‘åŠŸèƒ½ -->
        <a (click)="changeView('analytics')" 
           class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 cursor-pointer mb-1.5 relative group"
           [class.active]="view === 'analytics'"
           [class.opacity-50]="!membershipService.hasFeature('dataInsightsBasic')"
           [style.background-color]="view === 'analytics' ? 'rgba(6, 182, 212, 0.15)' : 'transparent'"
           [style.color]="view === 'analytics' ? '#22d3ee' : 'var(--sidebar-text)'"
           [title]="!membershipService.hasFeature('dataInsightsBasic') ? 'éœ€è¦ é»ƒé‡‘å¤§å¸« æˆ–ä»¥ä¸Šæœƒå“¡' : ''">
           <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-all"
                [class.bg-gradient-to-br]="view === 'analytics'"
                [class.from-cyan-500]="view === 'analytics'"
                [class.to-blue-500]="view === 'analytics'"
                [class.bg-slate-700/50]="view !== 'analytics'"
                [class.group-hover:bg-slate-700]="view !== 'analytics'">
             <span class="text-lg">ğŸ“Š</span>
           </div>
           <div class="flex flex-col">
             <span class="font-medium">æ•¸æ“šæ´å¯Ÿ</span>
             <span class="text-[10px] opacity-60">æ™ºèƒ½åˆ†æå ±å‘Š</span>
           </div>
           @if (membershipService.hasFeature('dataInsightsBasic')) {
                 <span class="absolute right-2 px-2 py-0.5 text-[9px] bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-full font-bold shadow-lg shadow-cyan-500/20">3</span>
               } @else {
                 <span class="absolute right-2 text-xs">ğŸ¥‡</span>
               }
              </a>
            </div>
          }
        </div>
        
        <!-- åˆ†çµ„ï¼šğŸ“Š æ•¸æ“šåˆ†æï¼ˆå¯æŠ˜ç–Šï¼‰ -->
        <div class="sidebar-group">
          <button (click)="toggleSidebarGroup('analytics')" 
                  class="w-full flex items-center justify-between px-3 py-2 mt-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer group">
            <span class="sidebar-group-title text-xs uppercase tracking-wider flex items-center gap-1" style="color: var(--sidebar-group-title);">
              ğŸ“Š æ¥­å‹™å·¥å…·
            </span>
            <svg class="w-3.5 h-3.5 transition-transform duration-200" 
                 [class.rotate-180]="!isSidebarGroupExpanded('analytics')"
                 style="color: var(--sidebar-group-title);" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          @if (isSidebarGroupExpanded('analytics')) {
            <div class="sidebar-group-content overflow-hidden">
              <!-- åˆ†æä¸­å¿ƒ (è©³ç´°æ•¸æ“š) -->
              <a (click)="changeView('analytics-center')"
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'analytics-center' || view === 'nurturing-analytics'"
                 [style.background-color]="(view === 'analytics-center' || view === 'nurturing-analytics') ? 'rgba(6, 182, 212, 0.15)' : 'transparent'"
                 [style.color]="(view === 'analytics-center' || view === 'nurturing-analytics') ? '#22d3ee' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
                 <span>æ•¸æ“šå ±å‘Š</span>
              </a>
              
              <!-- ç·šç´¢ç®¡ç† (å®¢æˆ¶åŸ¹è‚²æ”¹åï¼ŒAI è·Ÿé€²åŠŸèƒ½) -->
              <a (click)="changeView('lead-nurturing')"
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'lead-nurturing'"
                 [style.background-color]="view === 'lead-nurturing' ? 'rgba(236, 72, 153, 0.15)' : 'transparent'"
                 [style.color]="view === 'lead-nurturing' ? '#f472b6' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/><line x1="20" y1="8" x2="20" y2="14"/></svg>
                 <span>ç·šç´¢ç®¡ç†</span>
                 <span class="ml-auto px-1.5 py-0.5 text-xs bg-pink-500/20 text-pink-400 rounded">AI</span>
              </a>
              
              <!-- å¤šè§’è‰²å”ä½œ (é€²éšè¨­ç½®) -->
              <a (click)="changeView('multi-role'); loadMultiRoleData()" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'multi-role'"
                 [class.opacity-50]="!membershipService.hasFeature('multiRole')"
                 [class.cursor-not-allowed]="!membershipService.hasFeature('multiRole')"
                 [style.background-color]="view === 'multi-role' ? 'rgba(99, 102, 241, 0.15)' : 'transparent'"
                 [style.color]="view === 'multi-role' ? '#a5b4fc' : (!membershipService.hasFeature('multiRole') ? 'var(--sidebar-text-muted)' : 'var(--sidebar-text)')"
                 [title]="!membershipService.hasFeature('multiRole') ? 'éœ€è¦ é‘½çŸ³ç‹ç‰Œ æˆ–ä»¥ä¸Šæœƒå“¡' : ''">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                 <span>å¤šè§’è‰²å”ä½œ</span>
                 @if (!membershipService.hasFeature('multiRole')) {
                   <span class="ml-auto text-xs opacity-60">ğŸ’</span>
                 }
              </a>
            </div>
          }
        </div>
        
        <!-- åˆ†çµ„ï¼šAI æ™ºèƒ½ï¼ˆå¯æŠ˜ç–Šï¼‰ -->
        <div class="sidebar-group">
          <button (click)="toggleSidebarGroup('ai')" 
                  class="w-full flex items-center justify-between px-3 py-2 mt-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer group">
            <span class="sidebar-group-title text-xs uppercase tracking-wider flex items-center gap-1" style="color: var(--sidebar-group-title);">
              ğŸ§  {{ t('aiIntelligence') }}
            </span>
            <svg class="w-3.5 h-3.5 transition-transform duration-200" 
                 [class.rotate-180]="!isSidebarGroupExpanded('ai')"
                 style="color: var(--sidebar-group-title);" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          @if (isSidebarGroupExpanded('ai')) {
            <div class="sidebar-group-content overflow-hidden">
              <!-- æ™ºèƒ½å¼•æ“ï¼šç»Ÿä¸€å…¥å£ï¼ŒåŒ…å«å¼•æ“æ¦‚è§ˆã€æ¨¡å‹é…ç½®ã€çŸ¥è¯†å¤§è„‘ç­‰ -->
              <a (click)="changeView('ai-engine')" 
                 data-tour="ai-engine"
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="isAiEngineView()"
                 [style.background-color]="isAiEngineView() ? 'rgba(168, 85, 247, 0.15)' : 'transparent'"
                 [style.color]="isAiEngineView() ? '#c084fc' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m9 0a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3"></path></svg>
                 <span class="flex-1">{{ t('aiEngine') }}</span>
                 @if (ragBrainService.gapsCount() > 0) {
                   <span class="text-xs font-bold rounded-full px-1.5 py-0.5" style="background-color: rgba(239, 68, 68, 0.2); color: #f87171;">{{ ragBrainService.gapsCount() }}</span>
                 }
              </a>
            </div>
          }
        </div>
        
        <!-- åˆ†çµ„ï¼šç³»çµ±ç›£æ§ï¼ˆå¯æŠ˜ç–Šï¼‰ -->
        <div class="sidebar-group">
          <button (click)="toggleSidebarGroup('system')" 
                  class="w-full flex items-center justify-between px-3 py-2 mt-2 rounded-md hover:bg-white/5 transition-colors cursor-pointer group">
            <span class="sidebar-group-title text-xs uppercase tracking-wider flex items-center gap-1" style="color: var(--sidebar-group-title);">
              âš™ï¸ {{ t('systemMonitor') }}
            </span>
            <svg class="w-3.5 h-3.5 transition-transform duration-200" 
                 [class.rotate-180]="!isSidebarGroupExpanded('system')"
                 style="color: var(--sidebar-group-title);" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          @if (isSidebarGroupExpanded('system')) {
            <div class="sidebar-group-content overflow-hidden">
              <!-- è¨­ç½® -->
              <a (click)="changeView('settings')" 
                 class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-md transition-all duration-200 cursor-pointer mb-1"
                 [class.active]="view === 'settings'"
                 [style.background-color]="view === 'settings' ? 'var(--sidebar-item-active)' : 'transparent'"
                 [style.color]="view === 'settings' ? 'var(--sidebar-text-active)' : 'var(--sidebar-text)'">
                 <svg class="h-5 w-5 sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                 <span>{{ t('settings') }}</span>
              </a>
            </div>
          }
        </div>
      </nav>

    <!-- ğŸ”§ å´æ¬„ç˜¦èº«ï¼šå¹«åŠ©ã€èªè¨€ã€å¤–è§€å·²ç§»å…¥ã€Œè¨­ç½®ã€é ï¼Œåº•éƒ¨ä¸å†å›ºå®šå€å¡Šï¼Œä¸»èœå–®å¯é¡¯ç¤ºæ›´å¤š -->
  </aside>

  <!-- ğŸ”§ Phase7-1: Main Content â€” ä½¿ç”¨ Router æ›¿ä»£ @switchï¼ˆå‡å°‘ ~170 è¡Œæ¨¡æ¿ + 30+ æ­»å°å…¥ï¼‰ -->
  <main role="main" aria-label="ä¸»è¦å…§å®¹" class="flex-1 overflow-y-auto" [class.pt-14]="isMobile()" [class.pl-0]="isMobile()" style="background-color: var(--bg-primary);">
    <router-outlet></router-outlet>
  </main>

  <!-- Phase 10: Lead Detail Dialog Component -->
  @if (generationState().lead; as lead) {
    <app-lead-detail-dialog
      [lead]="lead"
      [generationState]="generationState()"
      [leadDetailView]="leadDetailView()"
      [chatHistory]="chatHistory()"
      [editableMessage]="editableMessage()"
      [messageMode]="messageMode()"
      [senderAccounts]="senderAccounts()"
      [selectedSenderId]="selectedSenderId()"
      [selectedChatUserId]="selectedChatUserId()"
      [chatHistoryHasMore]="chatHistoryHasMore()"
      [chatHistoryLoadingMore]="chatHistoryLoadingMore()"
      [isLoadingChatHistory]="isLoadingChatHistory()"
      [isAiConfigured]="isAiConfigured()"
      [aiApiType]="aiApiType()"
      [messageTemplates]="messageTemplates()"
      [canSendMessage]="canSendMessage()"
      [ragEnabled]="ragEnabled()"
      (close)="closeLeadDetailModal()"
      (generateMsg)="generateMessage()"
      (sendMsg)="sendMessageToLead()"
      (loadHistory)="loadChatHistory($event)"
      (loadMoreHistory)="loadMoreChatHistory()"
      (historyScroll)="onChatHistoryScroll($event)"
      (selectAttach)="selectAttachment($event.type, $event.multi)"
      (addMoreAttach)="addMoreAttachments($event)"
      (clearAttach)="clearAllAttachments()"
      (removeAttach)="removeAttachmentByIndex($event)"
      (applyTmpl)="applyTemplate($event)"
      (updatePrompt)="updateCustomPrompt($event)"
      (addDnc)="addToDoNotContact($event)"
      (editableMsgChange)="editableMessage.set($event)"
      (msgModeChange)="messageMode.set($event)"
      (senderChange)="selectedSenderId.set($event)"
      (viewChange)="leadDetailView.set($event)"
      (navigateTo)="currentView.set($event)" />
  }

  <!-- Phase 10: Batch Operation History Dialog Component -->
  @if(showBatchOperationHistory()) {
    <app-batch-history-dialog
      [history]="batchOperationHistory()"
      (close)="showBatchOperationHistory.set(false)"
      (undo)="undoBatchOperation($event)" />
  }
  
  <!-- é¦–æ¬¡å•Ÿå‹•æ­¡è¿å‘å° -->
  <!-- Phase 10: Welcome Dialog Component -->
  @if (showWelcomeDialog()) {
    <app-welcome-dialog
      [step]="welcomeStep()"
      [ollamaDetected]="ollamaDetected()"
      [isDetecting]="isDetectingOllama()"
      [ollamaModels]="detectedOllamaModels()"
      [localModel]="localAiModel()"
      [autoFallback]="aiAutoFallback()"
      [backupProvider]="aiBackupProvider()"
      (skip)="skipFirstRunSetup()"
      (complete)="completeFirstRunSetup()"
      (stepChange)="welcomeStep.set($event)"
      (detectOllamaClick)="detectOllama()"
      (localModelChange)="localAiModel.set($event)"
      (autoFallbackChange)="aiAutoFallback.set($event)"
      (backupProviderChange)="aiBackupProvider.set($event)" />
  }
  
  <!-- Phase 10: Orphan Session Dialog Component -->
  @if (showOrphanSessionDialog()) {
    <app-orphan-session-dialog
      [sessions]="orphanSessions()"
      [isRecovering]="isRecoveringOrphanSessions()"
      (dismiss)="dismissOrphanSessionDialog()"
      (recover)="recoverOrphanSessions()" />
  }

  <!-- Phase 10: Backend Error Dialog Component -->
  @if (showBackendErrorDialog()) {
    <app-backend-error-dialog
      [errorDetail]="backendError()"
      (close)="showBackendErrorDialog.set(false)" />
  }
  
    <!-- å¾Œç«¯ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    @if (!backendRunning()) {
      <div class="fixed bottom-4 right-4 z-50 bg-red-500/90 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 cursor-pointer hover:bg-red-600"
           (click)="showBackendErrorDialog.set(true)">
        <span class="animate-pulse">âš ï¸</span>
        <span class="text-sm font-medium">Python å¾Œç«¯æœªé‹è¡Œ</span>
      </div>
    }
    
    <!-- Phase 10: Keyword Set Creator Dialog Component -->
    @if (showKeywordSetCreator()) {
      <app-keyword-creator-dialog
        [name]="newKeywordSet().name"
        (cancel)="cancelNewKeywordSet()"
        (submit)="submitNewKeywordSet()"
        (nameChange)="newKeywordSet.set({ name: $event })" />
    }
  </div>
} @else {
  <!-- æœªèªè­‰ç”¨æˆ¶ï¼šé¡¯ç¤ºè·¯ç”±å…§å®¹ï¼ˆç™»å…¥é é¢ç­‰ï¼‰ -->
  <div class="auth-wrapper" style="min-height: 100vh; background: linear-gradient(to bottom right, #0f172a, #1e293b, #0f172a);">
    <router-outlet></router-outlet>
  </div>
} <!-- çµæŸ @if (isAuthenticated()) -->