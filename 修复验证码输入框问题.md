# 修复验证码输入框问题

## 🔍 问题分析

**问题：** 账户没有设置 2FA，但界面没有显示验证码输入框，只显示了 2FA 输入框。

**原因：** 
- 账户有旧的 session 文件（`backend/sessions/639952947692.session`）
- Pyrogram 检测到 session 文件存在，尝试使用它
- 但 session 文件可能已过期或无效，导致直接要求 2FA（即使账户没有 2FA）

## ✅ 已修复

我已经改进了登录逻辑：

1. **改进 session 验证：**
   - 不仅检查 `is_user_authorized()`，还尝试获取用户信息验证 session 是否真正有效
   - 如果 session 无效，自动删除并重新登录

2. **自动清理无效 session：**
   - 如果检测到 session 文件存在但无效，自动删除
   - 强制重新发送验证码

3. **添加详细日志：**
   - 记录每个登录步骤
   - 方便诊断问题

## 🚀 现在请操作

### 方法 1: 删除旧 session 文件（推荐）

1. **关闭应用**（确保后端进程已停止）

2. **删除 session 文件：**
   ```powershell
   # 在项目根目录运行
   del backend\sessions\639952947692.session
   ```

3. **重新启动应用：**
   ```powershell
   npm start
   ```

4. **重新登录：**
   - 点击"登录"按钮
   - **这次应该会显示验证码输入框**
   - 输入收到的验证码
   - 登录成功

### 方法 2: 让系统自动处理

系统现在会自动检测无效的 session 文件并删除。您可以：

1. **直接点击"登录"按钮**
2. **系统会自动：**
   - 检测 session 文件是否有效
   - 如果无效，自动删除并重新发送验证码
   - 显示验证码输入框

## 📋 预期行为

### 正常登录流程（没有 2FA）：

1. **点击"登录"按钮**
2. **系统检测 session 文件**
3. **如果 session 无效：**
   - 自动删除
   - 发送验证码
   - **显示验证码输入框** ✅
4. **输入验证码**
5. **登录成功**（状态变为 "Online"）

### 如果账户有 2FA：

1. **点击"登录"按钮**
2. **显示验证码输入框**
3. **输入验证码**
4. **显示 2FA 输入框**
5. **输入 2FA 密码**
6. **登录成功**

## 🔧 诊断步骤

### 查看终端日志

在运行 `npm start` 的终端中，查找：

```
[TelegramClient] Account +639952947692 authorization check: is_authorized=True/False
[TelegramClient] Session file exists but invalid: ..., will re-login
[TelegramClient] Deleted invalid session file: ...
[TelegramClient] Sending verification code to +639952947692...
[TelegramClient] Verification code sent successfully, phone_code_hash: ...
```

### 查看前端 Console

在开发者工具 Console 中，查找：

```
[Frontend] Received login-requires-code event: {accountId: ..., phone: ..., phoneCodeHash: ...}
```

如果看到这个事件，验证码输入框应该会显示。

## ❓ 如果仍然没有显示验证码输入框

请检查：

1. **终端日志：** 是否看到 `[TelegramClient] Sending verification code`？
2. **前端 Console：** 是否收到 `login-requires-code` 事件？
3. **账户状态：** 是否变为 "Waiting Code"？

如果都没有，请告诉我终端日志的完整输出。

---

**最后更新：** 2026-01-02

