# å…¨è‡ªå‹• AI éŠ·å”®æ¼æ–—ç³»çµ±

## æ¦‚è¿°

æœ¬æ¬¡å‡ç´šç‚º TG-Matrix æ·»åŠ äº†å®Œæ•´çš„å…¨è‡ªå‹• AI éŠ·å”®æ¼æ–—ç³»çµ±ï¼ŒåŒ…æ‹¬ï¼š
- ğŸ¯ **å…¨è‡ªå‹•éŠ·å”®æ¼æ–—ç®¡ç†** - è·Ÿé€²ã€æˆäº¤ã€æµå¤±è‡ªå‹•è™•ç†
- ğŸ’¾ **æ°¸ä¹…èŠå¤©è¨˜æ†¶** - å‘é‡åŒ–è¨˜æ†¶ç³»çµ±ï¼Œæ”¯æŒèªç¾©æœç´¢
- ğŸ¤– **RAG å¢å¼·** - çŸ¥è­˜åº«èªç¾©æœç´¢æ”¯æŒ
- ğŸ“Š **ç”¨æˆ¶ CRM æ•¸æ“šåº«** - å®Œæ•´çš„å®¢æˆ¶é—œä¿‚ç®¡ç†
- â° **è‡ªå‹•åŒ–ä»»å‹™èª¿åº¦** - å®šæ™‚è·Ÿé€²ã€æ¨™ç±¤æ›´æ–°ã€è¨˜æ†¶æ¸…ç†

---

## æ–°å¢æ¨¡çµ„

### 1. å…¨è‡ªå‹•éŠ·å”®æ¼æ–—ç®¡ç†å™¨ (`auto_funnel_manager.py`)

#### æ¼æ–—éšæ®µå®šç¾©
| éšæ®µ | åç¨± | è‡ªå‹•æ“ä½œ | é¡è‰² |
|------|------|----------|------|
| new | æ–°å®¢æˆ¶ | å•å€™ | è—è‰² |
| contacted | å·²è¯ç¹« | ç­‰å¾… | é’è‰² |
| replied | å·²å›å¾© | äº’å‹• | ç¶ è‰² |
| interested | æœ‰èˆˆè¶£ | ä»‹ç´¹ | é»ƒè‰² |
| negotiating | æ´½è«‡ä¸­ | å ±åƒ¹ | æ©™è‰² |
| follow_up | éœ€è·Ÿé€² | è·Ÿé€² | ç´«è‰² |
| converted | å·²æˆäº¤ | æ„Ÿè¬ | ç¿ ç¶  |
| churned | å·²æµå¤± | å‘Šåˆ¥ | ç´…è‰² |

#### è‡ªå‹•è·Ÿé€²ç­–ç•¥
- **å·²è¯ç¹«**: 24å°æ™‚ç„¡å›å¾© â†’ è‡ªå‹•è·Ÿé€²ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- **æœ‰èˆˆè¶£**: 48å°æ™‚ç„¡äº’å‹• â†’ ç™¼é€æé†’
- **æ´½è«‡ä¸­**: 72å°æ™‚ç„¡é€²å±• â†’ å„ªæƒ æé†’
- **éœ€è·Ÿé€²**: 7å¤©ç„¡å›æ‡‰ â†’ æ¨™è¨˜æµå¤±

#### é—œéµè©æ„åœ–åˆ†æ
ç³»çµ±è‡ªå‹•åˆ†æç”¨æˆ¶æ¶ˆæ¯ï¼Œè­˜åˆ¥ï¼š
- ğŸ‘ **æ­£é¢æ„åœ–**: è©¢å•åŠŸèƒ½ã€åƒ¹æ ¼ã€è³¼è²·
- ğŸ‘ **è² é¢æ„åœ–**: æ‹’çµ•ã€ä¸æ„Ÿèˆˆè¶£ã€å‘Šåˆ¥

#### API ç«¯é»
```javascript
// ç²å–æ¼æ–—ç¸½è¦½
send("get-funnel-overview")

// åˆ†ææ¶ˆæ¯
send("analyze-user-message", { userId, message, isFromUser })

// è½‰æ›éšæ®µ
send("transition-funnel-stage", { userId, stage, reason })

// ç²å–ç”¨æˆ¶æ—…ç¨‹
send("get-user-journey", { userId })

// æ‰¹é‡æ›´æ–°
send("batch-update-stages", { userIds, stage, reason })
```

---

### 2. å‘é‡åŒ–è¨˜æ†¶ç³»çµ± (`vector_memory.py`)

#### åŠŸèƒ½ç‰¹é»
- **æ°¸ä¹…èŠå¤©è¨˜æ†¶**: æ‰€æœ‰å°è©±æ°¸ä¹…ä¿å­˜ï¼Œä¸ä¸Ÿå¤±
- **èªç¾©æœç´¢**: åŸºæ–¼å‘é‡ç›¸ä¼¼åº¦æŸ¥æ‰¾ç›¸é—œè¨˜æ†¶
- **æ™ºèƒ½æ‘˜è¦**: å®šæœŸç”Ÿæˆå°è©±æ‘˜è¦
- **è‡ªå‹•æå–**: è‡ªå‹•å¾å°è©±ä¸­æå–äº‹å¯¦å’Œåå¥½

#### è¨˜æ†¶é¡å‹
| é¡å‹ | èªªæ˜ | è‡ªå‹•æå–é—œéµè© |
|------|------|----------------|
| conversation | å°è©±è¨˜æ†¶ | - |
| fact | ç”¨æˆ¶äº‹å¯¦ | æˆ‘æ˜¯ã€æˆ‘åœ¨ã€æˆ‘åš |
| preference | ç”¨æˆ¶åå¥½ | å–œæ­¡ã€æƒ³è¦ã€éœ€è¦ |
| summary | å°è©±æ‘˜è¦ | ç³»çµ±è‡ªå‹•ç”Ÿæˆ |
| goal | ç”¨æˆ¶ç›®æ¨™ | æƒ³ã€æ‰“ç®—ã€è¨ˆåŠƒ |

#### API ç«¯é»
```javascript
// æ·»åŠ è¨˜æ†¶
send("add-vector-memory", { userId, content, type, importance })

// æœç´¢è¨˜æ†¶
send("search-vector-memories", { userId, query, limit, type })

// ç²å–ä¸Šä¸‹æ–‡
send("get-memory-context", { userId, message, maxTokens })

// ç”Ÿæˆæ‘˜è¦
send("summarize-conversation", { userId, maxMessages })

// ç²å–çµ±è¨ˆ
send("get-memory-stats", { userId })
```

---

### 3. å¢å¼· RAG æœç´¢å¼•æ“

#### æ–°åŠŸèƒ½
- **å‘é‡æœç´¢**: åŸºæ–¼èªç¾©ç›¸ä¼¼åº¦æœç´¢çŸ¥è­˜åº«
- **æ··åˆæœç´¢**: é—œéµè© + å‘é‡çš„æ··åˆæœç´¢
- **ç›¸é—œåº¦è©•åˆ†**: è¿”å›ç›¸é—œåº¦åˆ†æ•¸

#### API ç«¯é»
```javascript
// ç²å– RAG ä¸Šä¸‹æ–‡ï¼ˆæ”¯æŒå‘é‡æœç´¢ï¼‰
send("get-rag-context", { 
    query, 
    maxChunks: 3, 
    maxTokens: 2000,
    useVectorSearch: true 
})
```

---

### 4. ç”¨æˆ¶ CRM æ•¸æ“šåº«

#### æ–°å¢æ•¸æ“šè¡¨

##### `user_crm` - å®¢æˆ¶è©³ç´°è³‡æ–™
- company: å…¬å¸
- industry: è¡Œæ¥­
- job_title: è·ç¨±
- phone: é›»è©±
- email: éƒµç®±
- website: ç¶²ç«™
- location: ä½ç½®
- budget_range: é ç®—ç¯„åœ
- pain_points: ç—›é»
- goals: ç›®æ¨™

##### `user_tags` - ç”¨æˆ¶æ¨™ç±¤
- æ”¯æŒè‡ªå‹•æ¨™ç±¤ï¼ˆç³»çµ±è‡ªå‹•åˆ†é…ï¼‰
- æ”¯æŒè‡ªå®šç¾©æ¨™ç±¤

##### `user_interactions` - äº’å‹•è¨˜éŒ„
- è©³ç´°è¨˜éŒ„æ¯æ¬¡äº’å‹•
- æ”¯æŒæƒ…æ„Ÿåˆ†æ
- æ”¯æŒæ„åœ–è­˜åˆ¥

#### é è¨­æ¨™ç±¤
| æ¨™ç±¤ | é¡å‹ | é¡è‰² | è§¸ç™¼æ¢ä»¶ |
|------|------|------|----------|
| VIP | ç³»çµ± | é‡‘è‰² | é«˜åƒ¹å€¼å®¢æˆ¶ |
| é«˜èˆˆè¶£ | è‡ªå‹• | ç¶ è‰² | èˆˆè¶£åº¦ â‰¥ 4 |
| éœ€è·Ÿé€² | è‡ªå‹• | æ©™è‰² | æ¼æ–—éšæ®µ = follow_up |
| å·²æµå¤± | è‡ªå‹• | ç´…è‰² | æ¼æ–—éšæ®µ = churned |
| æ´»èº | è‡ªå‹• | ç¿ ç¶  | 7å¤©å…§æœ‰äº’å‹• |
| æ²‰é»˜ | è‡ªå‹• | ç°è‰² | 14å¤©ç„¡äº’å‹• |

#### API ç«¯é»
```javascript
// ç²å–å®Œæ•´ç”¨æˆ¶è³‡æ–™
send("get-user-profile", { userId })

// æ›´æ–° CRM è³‡æ–™
send("update-user-crm", { userId, data: { company, industry, ... } })

// æ·»åŠ æ¨™ç±¤
send("add-user-tag", { userId, tag, tagType })

// ç§»é™¤æ¨™ç±¤
send("remove-user-tag", { userId, tag })

// ç²å–æ¨™ç±¤
send("get-user-tags", { userId })
```

---

### 5. è‡ªå‹•åŒ–ä»»å‹™èª¿åº¦å™¨ (`scheduler.py`)

#### å®šæ™‚ä»»å‹™
| ä»»å‹™ | é–“éš” | åŠŸèƒ½ |
|------|------|------|
| follow_up | 30åˆ†é˜ | è™•ç†è·Ÿé€²ä»»å‹™ |
| auto_tags | 1å°æ™‚ | æ›´æ–°è‡ªå‹•æ¨™ç±¤ |
| memory_cleanup | æ¯å¤© | æ¸…ç†èˆŠè¨˜æ†¶ |
| summarize | 6å°æ™‚ | ç”Ÿæˆå°è©±æ‘˜è¦ |
| stage_check | 1å°æ™‚ | æª¢æŸ¥éšæ®µè½‰æ› |

#### API ç«¯é»
```javascript
// æ’ç¨‹è·Ÿé€²
send("schedule-follow-up", { 
    userId, 
    scheduledAt: "2026-01-15T10:00:00Z",
    messageTemplate,
    taskType 
})

// ç²å–å¾…åŸ·è¡Œä»»å‹™
send("get-pending-tasks", { limit: 50 })

// å–æ¶ˆä»»å‹™
send("cancel-scheduled-task", { taskId })

// ç²å–èª¿åº¦å™¨çµ±è¨ˆ
send("get-scheduler-stats")
```

---

## æ•¸æ“šåº«é·ç§»

æ–°å¢é·ç§»æ–‡ä»¶: `migrations/0004_add_vector_memory_and_crm.py`

### æ–°å¢è¡¨
- `vector_memories` - å‘é‡è¨˜æ†¶è¡¨
- `user_crm` - ç”¨æˆ¶ CRM è¡¨
- `user_interactions` - ç”¨æˆ¶äº’å‹•è¨˜éŒ„
- `follow_up_tasks` - è·Ÿé€²ä»»å‹™è¡¨
- `user_tags` - ç”¨æˆ¶æ¨™ç±¤è¡¨
- `tag_definitions` - æ¨™ç±¤å®šç¾©è¡¨
- `conversation_summaries` - å°è©±æ‘˜è¦è¡¨
- `document_embeddings` - æ–‡æª”åµŒå…¥è¡¨

### `user_profiles` è¡¨æ–°å¢å­—æ®µ
- auto_follow_up_enabled: æ˜¯å¦å•Ÿç”¨è‡ªå‹•è·Ÿé€²
- preferred_contact_time: é¦–é¸è¯ç¹«æ™‚é–“
- communication_style: æºé€šé¢¨æ ¼
- last_purchase_at: æœ€å¾Œè³¼è²·æ™‚é–“
- total_purchases: ç¸½è³¼è²·æ¬¡æ•¸
- engagement_score: åƒèˆ‡åº¦åˆ†æ•¸
- lead_score: ç·šç´¢è©•åˆ†
- notes: å‚™è¨»

---

## ä½¿ç”¨æµç¨‹

### 1. å•Ÿå‹•ç³»çµ±
ç³»çµ±å•Ÿå‹•æ™‚æœƒè‡ªå‹•åˆå§‹åŒ–ï¼š
- å…¨è‡ªå‹•éŠ·å”®æ¼æ–—ç®¡ç†å™¨
- å‘é‡åŒ–è¨˜æ†¶ç³»çµ±
- ä»»å‹™èª¿åº¦å™¨

### 2. ç”¨æˆ¶é€²å…¥æ¼æ–—
ç•¶ç”¨æˆ¶è¢«æ•ç²æ™‚ï¼š
1. è‡ªå‹•å‰µå»ºç”¨æˆ¶è³‡æ–™
2. è¨­ç½®ç‚º `new` éšæ®µ
3. AI åˆ†æé¦–æ¢æ¶ˆæ¯
4. è‡ªå‹•ç™¼é€å•å€™

### 3. è‡ªå‹•éšæ®µè½‰æ›
- ç”¨æˆ¶å›å¾© â†’ `replied`
- è©¢å•åŠŸèƒ½ â†’ `interested`
- è©¢å•åƒ¹æ ¼ â†’ `negotiating`
- ç¢ºèªè³¼è²· â†’ `converted`
- è¡¨ç¤ºæ‹’çµ• â†’ `churned`

### 4. è‡ªå‹•è·Ÿé€²
- ç³»çµ±æ¯30åˆ†é˜æª¢æŸ¥éœ€è¦è·Ÿé€²çš„ç”¨æˆ¶
- è‡ªå‹•ç™¼é€è·Ÿé€²æ¶ˆæ¯
- é”åˆ°æœ€å¤§æ¬¡æ•¸å¾Œè‡ªå‹•æ¨™è¨˜æµå¤±

### 5. æ°¸ä¹…è¨˜æ†¶
- æ‰€æœ‰å°è©±æ°¸ä¹…ä¿å­˜
- æ¯æ¬¡å°è©±éƒ½æœƒæª¢ç´¢ç›¸é—œè¨˜æ†¶
- å®šæœŸç”Ÿæˆå°è©±æ‘˜è¦

---

## é…ç½®é¸é …

åœ¨ AI è¨­ç½®ä¸­å¯ä»¥é…ç½®ï¼š
- `rag_enabled`: æ˜¯å¦å•Ÿç”¨ RAG
- `auto_chat_enabled`: æ˜¯å¦å•Ÿç”¨è‡ªå‹•èŠå¤©
- `auto_chat_mode`: full(å…¨è‡ªå‹•)/semi(åŠè‡ªå‹•)/assist(è¼”åŠ©)
- `max_context_messages`: æœ€å¤§ä¸Šä¸‹æ–‡æ¶ˆæ¯æ•¸
- `enable_memory`: æ˜¯å¦å•Ÿç”¨è¨˜æ†¶ç³»çµ±

---

## æŠ€è¡“å¯¦ç¾

### å‘é‡åµŒå…¥
- é»˜èªä½¿ç”¨ç°¡å–®å“ˆå¸ŒåµŒå…¥ï¼ˆç„¡éœ€é¡å¤–ä¾è³´ï¼‰
- å¯é¸å•Ÿç”¨ç¥ç¶“ç¶²çµ¡åµŒå…¥ï¼ˆéœ€å®‰è£ sentence-transformersï¼‰

### ç›¸ä¼¼åº¦è¨ˆç®—
- ä½¿ç”¨é¤˜å¼¦ç›¸ä¼¼åº¦è¨ˆç®—æ–‡æœ¬ç›¸é—œæ€§
- æ”¯æŒé…ç½®æœ€å°ç›¸ä¼¼åº¦é–¾å€¼

### è¨˜æ†¶ç®¡ç†
- è‡ªå‹•åˆä½µç›¸ä¼¼è¨˜æ†¶
- å®šæœŸæ¸…ç†èˆŠè¨˜æ†¶ï¼ˆä¿ç•™é‡è¦è¨˜æ†¶ï¼‰
- æ”¯æŒæ‰‹å‹•æ¸…ç†

---

## æ³¨æ„äº‹é …

1. **æ•¸æ“šåº«é·ç§»**: é¦–æ¬¡å•Ÿå‹•æœƒè‡ªå‹•é‹è¡Œé·ç§»
2. **æ€§èƒ½è€ƒæ…®**: å‘é‡æœç´¢åœ¨å¤§é‡æ•¸æ“šæ™‚å¯èƒ½è¼ƒæ…¢
3. **ç¥ç¶“ç¶²çµ¡åµŒå…¥**: å¦‚éœ€æ›´å¥½æ•ˆæœï¼Œå®‰è£ `sentence-transformers`
4. **å®šæ™‚ä»»å‹™**: ç¢ºä¿ç³»çµ±é•·æ™‚é–“é‹è¡Œä»¥åŸ·è¡Œå®šæ™‚ä»»å‹™

---

## ä¸‹ä¸€æ­¥é–‹ç™¼å»ºè­°

1. **å‰ç«¯ç•Œé¢**: æ·»åŠ æ¼æ–—å¯è¦–åŒ–å„€è¡¨æ¿
2. **å ±è¡¨åŠŸèƒ½**: æ·»åŠ è½‰åŒ–ç‡ã€æµå¤±ç‡å ±è¡¨
3. **A/B æ¸¬è©¦**: æ¸¬è©¦ä¸åŒè·Ÿé€²ç­–ç•¥æ•ˆæœ
4. **é æ¸¬æ¨¡å‹**: åŸºæ–¼æ­·å²æ•¸æ“šé æ¸¬è½‰åŒ–å¯èƒ½æ€§
