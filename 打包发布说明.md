# TG-Matrix 一键打包发布说明

## 🚀 快速开始

### 一键打包（推荐）

```bash
node scripts/package.js
```

这个脚本会自动：
1. ✅ 构建 Angular 应用
2. ✅ 检查图标文件
3. ✅ 可选：打包 Python 后端
4. ✅ 使用 Electron Builder 打包
5. ✅ 创建安装说明

### 单独打包特定平台

```bash
# Windows
npm run package:win

# macOS
npm run package:mac

# Linux
npm run package:linux

# 所有平台
npm run package:all
```

## 📋 打包前准备

### 1. 安装依赖

```bash
# Node.js 依赖
npm install

# Python 依赖
pip install -r backend/requirements.txt
```

### 2. 准备图标（可选）

图标文件应放在 `build/` 目录：

- **Windows**: `build/icon.ico`
- **macOS**: `build/icon.icns`
- **Linux**: `build/icon.png`

如果没有图标，打包时会使用默认图标。

检查图标状态：
```bash
npm run create-icons
```

## 📦 打包输出

打包完成后，文件会输出到 `release/` 目录：

### Windows
- `TG-Matrix-1.0.0-Setup.exe` - 安装程序（一键安装）
- `安装说明.txt` - 安装和使用说明

### macOS
- `TG-Matrix-1.0.0.dmg` - DMG 安装包

### Linux
- `TG-Matrix-1.0.0.AppImage` - AppImage 格式（无需安装）
- `TG-Matrix_1.0.0_amd64.deb` - Debian 包

## 🎯 安装程序特性

### Windows 安装程序

✅ **一键安装**
- 双击 `TG-Matrix-1.0.0-Setup.exe` 开始安装
- 可以选择安装目录
- 自动创建桌面和开始菜单快捷方式
- 自动检测 Python 是否已安装（如未安装会提示）

✅ **自动配置**
- 自动创建数据目录
- 自动配置 Python 后端路径
- 自动注册卸载程序

✅ **卸载**
- 通过"控制面板" → "程序和功能"卸载
- 或运行安装目录中的 `Uninstall.exe`

### macOS 安装程序

✅ **拖拽安装**
- 打开 DMG 文件
- 将应用拖拽到"应用程序"文件夹
- 完成安装

### Linux 安装程序

✅ **AppImage（推荐）**
- 下载 `.AppImage` 文件
- 添加执行权限：`chmod +x TG-Matrix-1.0.0.AppImage`
- 双击运行（无需安装）

✅ **Debian 包**
- 安装：`sudo dpkg -i TG-Matrix_1.0.0_amd64.deb`
- 卸载：`sudo dpkg -r tg-matrix`

## 🔧 系统要求

### 必需
- **Windows 10/11** 或 **macOS 10.15+** 或 **Linux** (Ubuntu 20.04+)
- **Python 3.8+**（如果使用源代码版本）
- **500MB** 可用磁盘空间

### 推荐
- **8GB RAM**
- **稳定的互联网连接**

## 📝 首次运行

1. **启动应用**
   - Windows: 双击桌面快捷方式或从开始菜单启动
   - macOS: 从应用程序文件夹启动
   - Linux: 双击 AppImage 或运行命令

2. **Python 检测**
   - 如果系统已安装 Python，应用会自动启动后端
   - 如果未安装 Python，会显示提示信息

3. **开始使用**
   - 按照界面提示添加账户
   - 配置监控和自动化活动
   - 查看用户手册了解详细功能

## 🐍 Python 后端处理

### 默认方式（源代码）

打包会包含 Python 源代码，用户需要安装 Python 3.8+。

**优点：**
- 打包体积小（~50MB）
- 更新依赖方便
- 调试容易

### 可选方式（PyInstaller）

将 Python 后端打包为可执行文件：

```bash
# 安装 PyInstaller
pip install pyinstaller

# 构建后端
node scripts/build-backend.js
```

**优点：**
- 用户不需要安装 Python
- 完全独立的应用

**缺点：**
- 打包体积大（~150MB+）
- 更新依赖需要重新打包

## 🔍 故障排除

### ⚠️ 重要：Windows 打包权限问题

如果遇到符号链接权限错误，有以下解决方案：

#### 🚀 方法 1: 使用安全打包脚本（推荐）

```powershell
# 以管理员身份运行 PowerShell
npm run package:win:safe
```

#### 🚀 方法 2: 启用开发者模式（永久解决）

1. 打开"设置" (Win + I)
2. 进入"更新和安全" → "开发者选项"
3. 启用"开发人员模式"
4. 重启计算机
5. 运行：`npm run package:win`

#### 🚀 方法 3: 运行修复脚本

```powershell
# 以管理员身份运行
powershell -ExecutionPolicy Bypass -File scripts/fix-symlink-permissions.ps1
```

**详细说明：** 查看 [打包问题解决.md](打包问题解决.md)

### 问题：符号链接权限错误

**错误信息：**
```
ERROR: Cannot create symbolic link: 客户端没有所需的特权。
```

**解决：**
1. **以管理员身份运行 PowerShell**（推荐）
2. 或启用 Windows 开发者模式（设置 → 更新和安全 → 开发者选项）
3. 详细解决方案见：[打包问题解决.md](打包问题解决.md)

### 问题：跨平台构建错误

**错误信息：**
```
Build for macOS is supported only on macOS
```

**解决：**
- Windows 上只能构建 Windows 版本
- 使用 `node scripts/package.js` 会自动检测平台
- 或使用 `npm run package:win` 明确指定平台

### 问题：安装程序无法启动

**解决：**
1. 检查系统是否满足要求
2. 以管理员身份运行（Windows）
3. 检查防病毒软件是否阻止

### 问题：应用启动后显示"Python 未找到"

**解决：**
1. 安装 Python 3.8 或更高版本
2. 确保 Python 已添加到系统 PATH
3. 重启应用

**验证 Python 安装：**
```bash
# Windows
python --version

# macOS/Linux
python3 --version
```

### 问题：后端无法启动

**解决：**
1. 检查 Python 依赖是否安装：
   ```bash
   pip install -r backend/requirements.txt
   ```
2. 查看日志文件：
   - Windows: `%APPDATA%\TG-Matrix\backend\logs\`
   - macOS: `~/Library/Application Support/TG-Matrix/backend/logs/`
   - Linux: `~/.config/TG-Matrix/backend/logs/`

### 问题：打包失败

**解决：**
1. **以管理员身份运行 PowerShell**
2. 确保已运行 `npm run build:prod`
3. 检查 `dist/` 目录是否存在
4. 清除缓存：`npm cache clean --force`
5. 清除 Electron Builder 缓存：
   ```powershell
   Remove-Item -Recurse -Force "$env:LOCALAPPDATA\electron-builder\Cache"
   ```
6. 重新安装依赖：`rm -rf node_modules && npm install`

**详细故障排除：** 查看 [打包问题解决.md](打包问题解决.md)

## 📚 相关文档

- [用户手册](用户手册.md) - 详细的使用说明
- [部署指南](部署指南.md) - 部署和配置说明
- [README-打包发布.md](README-打包发布.md) - 详细的打包配置

## 🎉 发布检查清单

打包前：
- [ ] 版本号已更新（`package.json`）
- [ ] 所有功能已测试
- [ ] 用户手册已更新
- [ ] 部署指南已更新

打包后：
- [ ] 安装程序可以正常安装
- [ ] 应用可以正常启动
- [ ] Python 后端可以正常启动
- [ ] 所有功能正常工作
- [ ] 卸载程序可以正常卸载
- [ ] 在不同系统上测试（如可能）

## 💡 提示

1. **首次打包**：建议先打包单个平台测试
2. **图标文件**：虽然可选，但建议添加自定义图标
3. **版本号**：每次发布前更新版本号
4. **测试**：在干净的系统中测试安装程序
5. **文档**：保持文档与功能同步更新

---

**版本：** 1.0.0  
**最后更新：** 2026-01-02

