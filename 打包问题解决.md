# 打包问题解决方案

## 问题 1: 在 Windows 上无法构建 macOS/Linux 版本

### 错误信息
```
Build for macOS is supported only on macOS
```

### 原因
Electron Builder 不支持跨平台构建。每个平台的安装包只能在对应的操作系统上构建。

### 解决方案

#### 方法 1: 使用自动检测（推荐）

运行打包脚本时，不指定平台或使用 `auto`：

```bash
node scripts/package.js
# 或
node scripts/package.js auto
```

脚本会自动检测当前平台并只构建对应平台的安装包。

#### 方法 2: 明确指定平台

```bash
# Windows
npm run package:win

# macOS（需要在 macOS 上运行）
npm run package:mac

# Linux（需要在 Linux 上运行）
npm run package:linux
```

#### 方法 3: 使用 CI/CD

如果需要构建多平台版本，可以使用 CI/CD 服务：
- GitHub Actions
- GitLab CI
- CircleCI
- Travis CI

## 问题 2: 符号链接权限错误 ⚠️ 最常见问题

### 错误信息
```
ERROR: Cannot create symbolic link: 客户端没有所需的特权。
ERROR: Cannot create symbolic link: The client does not have the required privileges.
```

### 原因
Windows 上创建符号链接需要管理员权限或开发者模式。`winCodeSign` 工具（即使不用于签名，也会用于资源编辑）在解压时需要创建符号链接。

### 🚀 快速解决方案（推荐）

#### 方法 1: 使用安全打包脚本（最简单）

```powershell
# 以管理员身份运行 PowerShell
npm run package:win:safe
```

这个脚本会：
- ✅ 自动检测管理员权限
- ✅ 清除 Electron Builder 缓存
- ✅ 使用优化的配置打包

#### 方法 2: 运行修复脚本

```powershell
# 以管理员身份运行 PowerShell
powershell -ExecutionPolicy Bypass -File scripts/fix-symlink-permissions.ps1
```

这个脚本会：
- ✅ 启用 Windows 开发者模式
- ✅ 清除 Electron Builder 缓存
- ✅ 提供详细的修复说明

#### 方法 3: 手动启用开发者模式（永久解决）

1. **打开"设置"** (Win + I)
2. **进入"更新和安全"** → **"开发者选项"**
3. **启用"开发人员模式"**
4. **重启计算机**
5. **重新运行打包命令**

**优点：** 一次设置，永久有效，不需要每次都以管理员身份运行。

### 其他解决方案

#### 方法 4: 以管理员身份运行

1. **右键点击 PowerShell**
2. **选择"以管理员身份运行"**
3. **导航到项目目录**
4. **运行打包命令**

```powershell
cd C:\tgkz2026
npm run package:win
```

#### 方法 5: 清除缓存后重试

```powershell
# 清除 Electron Builder 缓存
Remove-Item -Recurse -Force "$env:LOCALAPPDATA\electron-builder\Cache"

# 重新打包
npm run package:win
```

#### 方法 6: 使用组策略（企业环境）

如果是企业环境，可以通过组策略允许用户创建符号链接：

1. 打开"组策略编辑器" (gpedit.msc)
2. 导航到：**计算机配置** → **Windows 设置** → **安全设置** → **本地策略** → **用户权限分配**
3. 找到"创建符号链接"
4. 添加当前用户或用户组

## 问题 3: 7-Zip 解压失败

### 错误信息
```
cannot execute cause=exit status 2
```

### 原因
通常是符号链接权限问题（见问题 2）或 7-Zip 工具问题。

### 解决方案

#### 方法 1: 清除 Electron Builder 缓存

```powershell
# 删除缓存目录
Remove-Item -Recurse -Force "$env:LOCALAPPDATA\electron-builder\Cache"
```

然后重新运行打包命令。

#### 方法 2: 手动安装 7-Zip

1. 下载并安装 7-Zip：https://www.7-zip.org/
2. 确保 7-Zip 已添加到系统 PATH
3. 重新运行打包命令

#### 方法 3: 使用管理员权限

按照"问题 2"的解决方案，以管理员身份运行。

## 问题 4: 图标文件未找到

### 警告信息
```
Warning: Windows icon (icon.ico) not found. Using default icon.
```

### 解决方案

这是**警告**，不是错误。应用会使用默认图标。

如果需要自定义图标：

1. **准备图标文件**
   - Windows: 512x512 PNG → 转换为 `.ico`
   - macOS: 512x512 PNG → 转换为 `.icns`
   - Linux: 512x512 PNG

2. **放置图标文件**
   ```
   build/
   ├── icon.ico   (Windows)
   ├── icon.icns  (macOS)
   └── icon.png   (Linux)
   ```

3. **在线转换工具**
   - Windows: https://convertio.co/png-ico/
   - macOS: https://cloudconvert.com/png-to-icns

## 问题 5: Python 后端打包失败

### 警告信息
```
PyInstaller not found. Using Python source files (requires Python installation).
```

### 说明

这是**信息提示**，不是错误。系统会使用 Python 源代码，用户需要安装 Python。

如果需要打包为独立可执行文件：

1. **安装 PyInstaller**
   ```bash
   pip install pyinstaller
   ```

2. **构建后端**
   ```bash
   node scripts/build-backend.js
   ```

3. **重新打包**
   ```bash
   npm run package:win
   ```

**注意：** PyInstaller 打包会增加应用体积（~100MB+）。

## 快速检查清单

打包前检查：

- [ ] 以管理员身份运行 PowerShell（Windows）
- [ ] 已安装所有依赖：`npm install` 和 `pip install -r backend/requirements.txt`
- [ ] Angular 应用已构建：`npm run build:prod`
- [ ] 使用正确的平台命令（Windows 上使用 `package:win`）

打包后检查：

- [ ] `release/` 目录中有安装程序文件
- [ ] 安装程序可以正常安装
- [ ] 应用可以正常启动
- [ ] Python 后端可以正常启动

## 常见错误代码

| 错误代码 | 原因 | 解决方案 |
|---------|------|---------|
| `exit status 2` | 符号链接权限问题 | 以管理员身份运行 |
| `Build for macOS is supported only on macOS` | 跨平台构建 | 使用对应平台的命令 |
| `cannot find module` | 依赖未安装 | 运行 `npm install` |
| `ENOENT` | 文件或目录不存在 | 检查路径和文件是否存在 |

## 获取帮助

如果问题仍未解决：

1. **查看详细日志**
   - Electron Builder 日志：`release/builder-effective-config.yaml`
   - 应用日志：`backend/logs/`

2. **检查系统要求**
   - Node.js 18+
   - Python 3.8+
   - 足够的磁盘空间（至少 1GB）

3. **尝试清理后重新打包**
   ```bash
   # 清理缓存
   npm cache clean --force
   Remove-Item -Recurse -Force "$env:LOCALAPPDATA\electron-builder\Cache"
   
   # 重新安装依赖
   rm -rf node_modules
   npm install
   
   # 重新打包
   npm run package:win
   ```

---

**最后更新：** 2026-01-02

