# 數據庫重建指南

## ⚠️ 重要提示

**重建數據庫會刪除所有現有數據**，包括：
- 所有賬戶信息
- 所有關鍵詞集和關鍵詞
- 所有監控群組
- 所有潛在客戶（Leads）
- 所有聊天記錄
- 所有消息模板和活動
- 所有日誌記錄

**請確保您已經備份了重要數據！**

## 🔧 重建方法

### 方法 1: 使用重建腳本（推薦）

#### 步驟 1: 停止應用
1. 完全關閉應用程序
2. 確保沒有 Python 進程在運行

#### 步驟 2: 運行重建腳本
在項目根目錄打開 PowerShell 或命令提示符，運行：

```powershell
python backend/rebuild_database.py
```

腳本會自動：
1. 備份現有數據庫（如果存在）
2. 刪除舊數據庫文件（包括 WAL 和 SHM 文件）
3. 創建新的數據庫結構
4. 初始化全文搜索索引
5. 驗證數據庫完整性

#### 步驟 3: 重新啟動應用
```powershell
npm run start:dev
```

### 方法 2: 手動刪除數據庫文件

#### 步驟 1: 停止應用
完全關閉應用程序

#### 步驟 2: 備份數據庫（可選）
```powershell
# 在項目根目錄
Copy-Item backend\data\tgmatrix.db backend\data\tgmatrix_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').db
```

#### 步驟 3: 刪除數據庫文件
```powershell
# 刪除主數據庫文件
Remove-Item backend\data\tgmatrix.db -ErrorAction SilentlyContinue

# 刪除 WAL 文件（如果存在）
Remove-Item backend\data\tgmatrix.db-wal -ErrorAction SilentlyContinue

# 刪除 SHM 文件（如果存在）
Remove-Item backend\data\tgmatrix.db-shm -ErrorAction SilentlyContinue
```

#### 步驟 4: 重新啟動應用
```powershell
npm run start:dev
```

應用啟動時會自動創建新的數據庫。

## ✅ 驗證重建成功

### 檢查 1: 數據庫文件已創建
```powershell
Test-Path backend\data\tgmatrix.db
```
應該返回 `True`

### 檢查 2: 數據庫完整性
啟動應用後，查看後端控制台，應該看到：
```
[Database] Database initialized successfully
```

### 檢查 3: 應用功能正常
1. 打開應用
2. 嘗試添加一個測試賬戶
3. 嘗試添加一個關鍵詞集
4. 如果這些操作都成功，說明數據庫重建成功

## 🔍 如果重建後仍有問題

### 問題 1: 數據庫文件無法創建

**可能原因：**
- 目錄權限問題
- 磁盤空間不足

**解決方案：**
1. 檢查 `backend/data/` 目錄是否存在
2. 檢查是否有寫權限
3. 檢查磁盤空間

### 問題 2: 數據庫初始化失敗

**可能原因：**
- Python 依賴未安裝
- 數據庫文件被鎖定

**解決方案：**
1. 確保所有 Python 進程已關閉
2. 重新安裝依賴：
   ```powershell
   pip install -r backend/requirements.txt
   ```

### 問題 3: 全文搜索索引創建失敗

**症狀：** 看到 "全文搜索索引創建失敗" 警告

**解決方案：**
這不是致命錯誤，應用仍可正常運行。如果需要全文搜索功能，可以：
1. 檢查後端日誌中的詳細錯誤
2. 手動運行索引重建（如果數據庫正常）

## 📝 重建後的後續步驟

數據庫重建完成後，您需要：

1. **重新添加賬戶**
   - 進入「賬戶管理」頁面
   - 添加您的 Telegram 賬戶

2. **重新配置監控**
   - 添加監控群組
   - 添加關鍵詞集
   - 配置活動

3. **重新登錄賬戶**
   - 登錄所有需要使用的賬戶
   - 確保賬戶狀態為 "Online"

## 🛡️ 預防數據庫損壞

### 建議 1: 定期備份
建議定期備份數據庫文件：
```powershell
# 創建備份腳本 backup_db.ps1
$backupDir = "backend\data\backups"
New-Item -ItemType Directory -Force -Path $backupDir
Copy-Item backend\data\tgmatrix.db "$backupDir\tgmatrix_$(Get-Date -Format 'yyyyMMdd_HHmmss').db"
```

### 建議 2: 避免異常關閉
- 使用「停止監控」按鈕停止監控
- 使用正常方式關閉應用
- 避免強制終止 Python 進程

### 建議 3: 監控數據庫健康
應用會自動檢查數據庫完整性，如果發現問題會記錄日誌。

## ⚡ 快速重建命令

如果您確定要重建數據庫，可以運行：

```powershell
# 停止應用後，運行：
python backend/rebuild_database.py
```

腳本會自動處理所有步驟。
