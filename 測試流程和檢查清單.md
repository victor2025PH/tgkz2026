# 卡密激活系統測試流程和檢查清單

## 📋 測試範圍

本次修復涉及以下核心功能：
1. ✅ 卡密激活流程（前端 → 後端 API）
2. ✅ 激活記錄顯示（從後端獲取真實數據）
3. ✅ 使用統計顯示（從後端獲取真實數據）
4. ✅ 配額顯示（根據會員等級動態顯示）
5. ✅ 狀態同步機制（激活後自動刷新）

---

## 🧪 測試環境準備

### 1. 後端服務啟動
```bash
# 進入後端目錄
cd backend

# 啟動後端服務（根據你的啟動方式）
python main.py
# 或
python license_server.py
```

**檢查點：**
- ✅ 後端服務成功啟動
- ✅ 數據庫文件存在（`backend/data/tgai_server.db`）
- ✅ API 端口正常監聽（通常是 8080 或 5000）

### 2. 前端服務啟動
```bash
# 進入項目根目錄
cd c:\tgkz2026

# 啟動 Angular 開發服務器
npm start
# 或
ng serve
```

**檢查點：**
- ✅ 前端服務成功啟動（通常是 http://localhost:4200）
- ✅ 瀏覽器可以訪問應用

### 3. 準備測試數據
- ✅ 在後台管理面板生成一個測試卡密（建議使用「榮耀王者終身」等級）
- ✅ 記錄卡密號碼（格式：`TGAI-KL-XXXX-XXXX-XXXX`）
- ✅ 確保有一個測試用戶賬號

---

## 🔍 測試用例

### 測試用例 1：卡密激活流程

#### 步驟：
1. **登入系統**
   - 打開瀏覽器，訪問前端應用
   - 使用測試賬號登入

2. **進入個人中心**
   - 點擊左側導航「帳戶管理」或「會員中心」
   - 切換到「卡密管理」標籤

3. **輸入卡密並激活**
   - 在「激活新卡密」輸入框中輸入測試卡密
   - 點擊「激活」按鈕
   - 觀察是否有加載狀態

4. **檢查激活結果**
   - ✅ 應該顯示成功提示（如「🎉 榮耀王者 激活成功！」）
   - ✅ 輸入框應該被清空
   - ✅ 會員等級應該立即更新（如從「青銅戰士」升級到「榮耀王者」）

#### 檢查點：
- [ ] 激活按鈕可見且可點擊
- [ ] 輸入卡密後按鈕變為可用狀態
- [ ] 激活過程有明確的視覺反饋
- [ ] 激活成功後有提示消息
- [ ] 會員等級立即更新

---

### 測試用例 2：後端狀態更新驗證

#### 步驟：
1. **登入後台管理面板**
   - 打開後台管理界面（通常是 `http://localhost:8080/admin`）
   - 進入「卡密管理」頁面

2. **檢查卡密狀態**
   - 找到剛才使用的測試卡密
   - 檢查「狀態」欄位

3. **檢查使用時間**
   - 查看「使用時間」欄位
   - 檢查「使用時間」是否顯示當前時間

#### 檢查點：
- [ ] 卡密狀態從「未使用」變為「已使用」
- [ ] 「使用時間」欄位顯示激活時間
- [ ] 「可用數量」統計正確減少（如從 5 可用/5 變為 4 可用/5）
- [ ] 數據庫中 `licenses` 表的 `status` 字段為 `'used'`
- [ ] `activations` 表中有對應的激活記錄

#### 數據庫檢查（可選）：
```sql
-- 檢查卡密狀態
SELECT license_key, status, used_at, used_by 
FROM licenses 
WHERE license_key = '你的測試卡密';

-- 檢查激活記錄
SELECT * FROM activations 
WHERE license_key = '你的測試卡密'
ORDER BY activated_at DESC 
LIMIT 5;
```

---

### 測試用例 3：激活記錄顯示

#### 步驟：
1. **進入個人中心**
   - 在「帳戶管理」→「卡密管理」標籤
   - 查看「激活記錄」區塊

2. **檢查激活記錄**
   - 記錄應該顯示剛才激活的卡密
   - 檢查記錄的詳細信息

#### 檢查點：
- [ ] 「激活記錄」區塊可見
- [ ] 顯示剛才激活的卡密記錄（部分隱藏格式：`TGAI-KL-XXXX-****`）
- [ ] 顯示正確的會員等級名稱（如「👑 榮耀王者 終身」）
- [ ] 顯示正確的激活日期（格式：YYYY-MM-DD）
- [ ] 狀態顯示為「有效」
- [ ] 沒有硬編碼的舊記錄（如「VIP 月卡」）

#### 測試會員中心記錄：
1. 進入「會員中心」
2. 切換到「訂閱記錄」標籤
3. 檢查記錄是否與個人中心的記錄一致
4. 檢查記錄格式是否正確

---

### 測試用例 4：使用統計顯示

#### 步驟：
1. **進入會員中心**
   - 打開「會員中心」頁面
   - 查看「總覽」標籤

2. **檢查快速統計卡片**
   - 查看「AI 調用」統計
   - 查看「消息發送」統計
   - 查看「帳號數量」統計

3. **檢查詳細使用統計**
   - 滾動到「本月使用詳情」區塊
   - 檢查各項使用量和配額限制

#### 檢查點：
- [ ] 統計數據從後端 API 獲取（不是硬編碼）
- [ ] 「AI 調用」顯示正確的使用量和配額（如「150 / 500」）
- [ ] 「消息發送」顯示正確的使用量和配額（如「2340 / 10000」）
- [ ] 「帳號數量」顯示正確的使用量和配額（根據會員等級）
- [ ] 配額限制根據當前會員等級正確顯示（如王者等級應該顯示更大的配額）
- [ ] 進度條根據使用百分比正確顯示

#### 配額限制驗證（根據會員等級）：

| 會員等級 | AI 調用限制 | 消息發送限制 | 帳號數量限制 |
|---------|------------|------------|------------|
| 青銅戰士 | 10 | 20 | 2 |
| 白銀精英 | 50 | 100 | 5 |
| 黃金大師 | 200 | 300 | 10 |
| 鑽石王牌 | 無限 | 1000 | 20 |
| 星耀傳說 | 無限 | 無限 | 50 |
| 榮耀王者 | 無限 | 無限 | 無限 |

**檢查方法：**
- 激活不同等級的卡密
- 檢查配額限制是否正確更新
- 王者等級應該顯示「999999」或「無限」表示無限制

---

### 測試用例 5：會員等級更新

#### 步驟：
1. **激活前檢查**
   - 記錄當前會員等級（如「青銅戰士」）
   - 記錄當前配額限制

2. **激活新卡密**
   - 使用一個高級會員卡密（如「榮耀王者」）
   - 完成激活流程

3. **檢查更新結果**
   - 檢查用戶頭像旁邊的會員等級標識
   - 檢查會員中心頂部的會員狀態卡片
   - 檢查配額限制是否更新

#### 檢查點：
- [ ] 會員等級立即更新（不需要刷新頁面）
- [ ] 左側導航欄顯示新等級
- [ ] 會員中心頂部顯示新等級和圖標
- [ ] 有效期正確顯示（如「剩餘 36529 天」表示終身）
- [ ] 配額限制根據新等級正確更新
- [ ] 所有相關 UI 元素都更新（圖標、顏色、名稱）

---

### 測試用例 6：多端點激活測試

#### 步驟：
1. **個人中心激活**
   - 在「帳戶管理」→「卡密管理」標籤激活卡密

2. **會員中心激活**
   - 在「會員中心」→「升級購買」標籤激活卡密

#### 檢查點：
- [ ] 兩個位置的激活按鈕都正常工作
- [ ] 激活後兩個位置的記錄都更新
- [ ] 數據保持一致

---

### 測試用例 7：錯誤處理測試

#### 步驟：
1. **測試無效卡密**
   - 輸入格式錯誤的卡密（如「123456」）
   - 點擊激活
   - 應該顯示錯誤提示

2. **測試已使用的卡密**
   - 使用一個已經激活過的卡密
   - 點擊激活
   - 應該顯示「卡密已使用」錯誤

3. **測試網絡錯誤**
   - 關閉後端服務
   - 嘗試激活卡密
   - 應該顯示適當的錯誤提示

#### 檢查點：
- [ ] 無效卡密顯示格式錯誤提示
- [ ] 已使用卡密顯示「已使用」錯誤
- [ ] 網絡錯誤有友好的錯誤提示
- [ ] 錯誤提示不會導致頁面崩潰

---

## 📊 測試檢查清單總結

### 核心功能檢查
- [ ] 卡密激活按鈕可見且功能正常
- [ ] 激活流程成功調用後端 API
- [ ] 激活後後端數據庫狀態正確更新
- [ ] 激活記錄正確顯示（格式、等級、日期）
- [ ] 使用統計從後端正確獲取
- [ ] 配額限制根據會員等級正確顯示
- [ ] 會員等級更新後所有 UI 同步更新

### 數據同步檢查
- [ ] 前端會員等級與後端數據庫一致
- [ ] 激活記錄前端顯示與後端數據一致
- [ ] 使用統計前端顯示與後端數據一致
- [ ] 配額限制與會員等級配置一致

### 用戶體驗檢查
- [ ] 激活過程有明確的視覺反饋
- [ ] 成功/失敗提示清晰明確
- [ ] 頁面不需要手動刷新即可看到更新
- [ ] 錯誤提示友好易懂
- [ ] 加載狀態正確顯示

---

## 🔧 測試工具和技巧

### 1. 瀏覽器開發者工具
- **Network 標籤**：檢查 API 請求是否正確發送
  - 確認請求 URL：`/api/license/activate`
  - 確認請求方法：POST
  - 確認響應狀態：200 OK
  - 檢查響應數據格式

- **Console 標籤**：檢查是否有錯誤信息
  - 查看是否有 JavaScript 錯誤
  - 查看 API 調用的日誌信息

- **Application 標籤**：檢查 localStorage
  - 確認用戶數據是否正確保存
  - 確認會員等級是否更新

### 2. 後端日誌檢查
- 查看後端服務器的控制台輸出
- 檢查是否有異常或錯誤信息
- 確認 API 請求是否正確處理

### 3. 數據庫直接檢查（SQLite）
```bash
# 使用 SQLite 命令行工具
cd backend/data
sqlite3 tgai_server.db

# 檢查卡密狀態
SELECT license_key, status, used_at, level FROM licenses WHERE license_key LIKE 'TGAI-KL%';

# 檢查激活記錄
SELECT * FROM activations ORDER BY activated_at DESC LIMIT 5;

# 檢查用戶會員等級
SELECT user_id, machine_id, membership_level, expires_at FROM users;
```

### 4. 測試不同會員等級
建議準備以下測試卡密：
- 白銀精英月卡（`TGAI-S2-XXXX-XXXX-XXXX`）
- 黃金大師月卡（`TGAI-G2-XXXX-XXXX-XXXX`）
- 鑽石王牌月卡（`TGAI-D2-XXXX-XXXX-XXXX`）
- 星耀傳說月卡（`TGAI-S2-XXXX-XXXX-XXXX`，注意這裡 S 可能衝突，檢查實際格式）
- 榮耀王者終身（`TGAI-KL-XXXX-XXXX-XXXX`）

---

## 🚨 常見問題排查

### 問題 1：激活後後端狀態未更新
**檢查：**
1. 後端服務是否正常運行
2. 網絡請求是否成功（檢查 Network 標籤）
3. 後端日誌是否有錯誤信息
4. 數據庫文件權限是否正確

### 問題 2：激活記錄顯示為空
**檢查：**
1. API 請求是否成功（檢查 Network 標籤）
2. 響應數據格式是否正確
3. 前端是否有 JavaScript 錯誤（檢查 Console）
4. 後端 `get_activation_history` 方法是否正確執行

### 問題 3：配額限制顯示不正確
**檢查：**
1. 會員等級是否正確更新
2. 後端 API 返回的配額數據是否正確
3. 前端是否有緩存問題（嘗試硬刷新：Ctrl+Shift+R）

### 問題 4：會員等級更新後 UI 未更新
**檢查：**
1. 是否有 JavaScript 錯誤（檢查 Console）
2. Angular 的 computed signals 是否正確觸發
3. 嘗試手動刷新頁面
4. 檢查 localStorage 中的用戶數據

---

## ✅ 測試完成標準

所有測試用例通過的標準：
1. ✅ 卡密激活成功，後端狀態正確更新
2. ✅ 激活記錄正確顯示，格式和內容正確
3. ✅ 使用統計從後端正確獲取並顯示
4. ✅ 配額限制根據會員等級正確顯示
5. ✅ 會員等級更新後所有 UI 同步更新
6. ✅ 錯誤處理正確，提示友好
7. ✅ 沒有明顯的 JavaScript 錯誤
8. ✅ 用戶體驗流暢，不需要手動刷新

---

## 📝 測試報告模板

測試完成後，請記錄以下信息：

```
測試日期：__________
測試人員：__________
測試環境：
- 後端版本：__________
- 前端版本：__________
- 瀏覽器：__________

測試結果：
- 測試用例 1（卡密激活）：✅ 通過 / ❌ 失敗
- 測試用例 2（後端狀態）：✅ 通過 / ❌ 失敗
- 測試用例 3（激活記錄）：✅ 通過 / ❌ 失敗
- 測試用例 4（使用統計）：✅ 通過 / ❌ 失敗
- 測試用例 5（等級更新）：✅ 通過 / ❌ 失敗
- 測試用例 6（多端點）：✅ 通過 / ❌ 失敗
- 測試用例 7（錯誤處理）：✅ 通過 / ❌ 失敗

發現的問題：
1. __________
2. __________

備註：
__________
```
