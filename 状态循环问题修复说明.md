# çŠ¶æ€å¾ªç¯é—®é¢˜ä¿®å¤è¯´æ˜

## âœ… é—®é¢˜è¯Šæ–­

æ ¹æ®æ—¥å¿—åˆ†æï¼Œå‘ç°äº†**ä¸¥é‡çš„çŠ¶æ€å¾ªç¯é—®é¢˜**ï¼š

### ç—‡çŠ¶ï¼š
```
Account +639277356600 status changed: Waiting Code -> Logging in...
Account +639277356600 status changed: Logging in... -> Waiting Code
Account +639277356600 status changed: Waiting Code -> Logging in...
```

### æ ¹æœ¬åŸå› ï¼š

å½“è´¦æˆ·çŠ¶æ€æ˜¯ `Waiting Code` æ—¶ï¼š

1. **`add-account` å‘½ä»¤è¢«å¤„ç†**ï¼ˆå¯èƒ½æ˜¯é‡è¯•æˆ–ç”¨æˆ·æ“ä½œï¼‰
2. **`handle_add_account` æ£€æµ‹åˆ°è´¦æˆ·"åœ¨ç™»å½•æµç¨‹ä¸­"**
3. **ä»£ç å…è®¸ç»§ç»­ï¼Œå¹¶æ›´æ–°è´¦æˆ·æ•°æ®**
4. **å‘é€ `accounts-updated` äº‹ä»¶**
5. **å¯èƒ½è§¦å‘æŸäº›é€»è¾‘ï¼Œå¯¼è‡´çŠ¶æ€å˜å› `Logging in...`**
6. **çŠ¶æ€å¾ªç¯å¼€å§‹**

---

## ğŸ”§ å®æ–½çš„ä¿®å¤

### ä¿®å¤ç­–ç•¥ï¼šé˜²æ­¢åœ¨ `Waiting Code` çŠ¶æ€ä¸‹è§¦å‘ä»»ä½•æ›´æ–°

**å…³é”®æ”¹è¿›ï¼š**

1. **å¦‚æœçŠ¶æ€æ˜¯ `Waiting Code`ï¼Œå®Œå…¨è·³è¿‡æ›´æ–°**ï¼š
   - ä¸æ›´æ–°è´¦æˆ·æ•°æ®
   - ä¸å‘é€ `accounts-updated` äº‹ä»¶
   - ç›´æ¥è¿”å›æˆåŠŸ

2. **å¯¹äºå…¶ä»–ç™»å½•çŠ¶æ€ï¼ˆ`Logging in...` æˆ– `Waiting 2FA`ï¼‰ï¼Œå…è®¸æœ€å°æ›´æ–°**ï¼š
   - åªæ›´æ–°å…³é”®å­—æ®µï¼ˆAPI ID, API Hashï¼‰
   - æ›´æ–°åå‘é€ `accounts-updated` äº‹ä»¶

3. **é˜²æ­¢çŠ¶æ€å¾ªç¯**ï¼š
   - `Waiting Code` çŠ¶æ€ä¸‹ä¸å‘é€ `accounts-updated` äº‹ä»¶
   - è¿™é¿å…äº†å‰ç«¯æˆ–å…¶ä»–é€»è¾‘è§¦å‘æ–°çš„ç™»å½•è¯·æ±‚

**ä¿®å¤ä»£ç ï¼š**

```python
# Check if account has stuck status (Logging in... or Waiting Code)
if existing_status in ['Logging in...', 'Waiting Code', 'Waiting 2FA']:
    # CRITICAL: If account is in login process (especially Waiting Code), 
    # DO NOT update account data or send events that might trigger re-login
    # Just return success silently to prevent status loop
    print(f"[Backend] Account {phone} is in login process (status: {existing_status}), skipping update to prevent status loop", file=sys.stderr)
    
    # Only update account data if there are actual changes AND status is not Waiting Code
    # If status is Waiting Code, user is waiting for verification code - do NOT update
    if existing_status != 'Waiting Code':
        # For Logging in... or Waiting 2FA, allow minimal updates
        update_data = {}
        if payload.get('apiId'):
            update_data['apiId'] = payload.get('apiId')
        if payload.get('apiHash'):
            update_data['apiHash'] = payload.get('apiHash')
        
        if update_data and existing_id:
            await db.update_account(existing_id, update_data)
            print(f"[Backend] Updated account data for {phone}", file=sys.stderr)
            # Only send accounts-updated if we actually updated something
            accounts = await db.get_all_accounts()
            self.send_event("accounts-updated", accounts)
    
    # Return success - account exists and is in login process
    # DO NOT send accounts-updated event if status is Waiting Code to prevent loop
    return
```

---

## ğŸ“‹ ä¿®å¤åçš„æµç¨‹

### æ­£å¸¸æµç¨‹ï¼š

1. **ç”¨æˆ·æ·»åŠ è´¦æˆ·** â†’ è´¦æˆ·æ·»åŠ åˆ°æ•°æ®åº“ï¼ŒçŠ¶æ€ä¸º `Offline`
2. **ç”¨æˆ·ç‚¹å‡»ç™»å½•** â†’ çŠ¶æ€å˜ä¸º `Logging in...`
3. **éªŒè¯ç å‘é€æˆåŠŸ** â†’ çŠ¶æ€å˜ä¸º `Waiting Code`
4. **ç”¨æˆ·å†æ¬¡å°è¯•æ·»åŠ è´¦æˆ·**ï¼š
   - ç³»ç»Ÿæ£€æµ‹åˆ°è´¦æˆ·çŠ¶æ€æ˜¯ `Waiting Code`
   - **è·³è¿‡æ‰€æœ‰æ›´æ–°**ï¼Œä¸å‘é€ `accounts-updated` äº‹ä»¶
   - ç›´æ¥è¿”å›æˆåŠŸ
   - **çŠ¶æ€ä¿æŒ `Waiting Code`**ï¼Œä¸ä¼šå¾ªç¯

### é¢„æœŸæ•ˆæœï¼š

- âœ… **çŠ¶æ€å¾ªç¯åœæ­¢**ï¼š`Waiting Code` çŠ¶æ€ä¸‹ä¸ä¼šè§¦å‘ä»»ä½•æ›´æ–°
- âœ… **éªŒè¯ç ä¸ä¼šé‡å¤å‘é€**ï¼šçŠ¶æ€ä¿æŒ `Waiting Code`ï¼Œä¸ä¼šè§¦å‘æ–°çš„ç™»å½•è¯·æ±‚
- âœ… **ç”¨æˆ·ç­‰å¾…éªŒè¯ç **ï¼šç³»ç»Ÿå®‰é™åœ°ç­‰å¾…ç”¨æˆ·è¾“å…¥éªŒè¯ç 

---

## ğŸ¯ å…¶ä»–é—®é¢˜

### é—®é¢˜ 1ï¼šéªŒè¯ç æœªæ¥æ”¶

**çŠ¶æ€ï¼š** è¿™æ˜¯ç”¨æˆ·æŠ¥å‘Šçš„ä¸»è¦é—®é¢˜

**å¯èƒ½çš„åŸå› ï¼š**
1. æ²¡æœ‰å…¶ä»–è®¾å¤‡ç™»å½• Telegram
2. éªŒè¯ç å‘é€åˆ°äº†å…¶ä»–è®¾å¤‡
3. Telegram å®‰å…¨æœºåˆ¶é™åˆ¶

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥æ‰€æœ‰å·²ç™»å½• Telegram çš„è®¾å¤‡
- å¦‚æœç¡®å®æ²¡æœ‰å…¶ä»–è®¾å¤‡ï¼Œå¯èƒ½éœ€è¦é€€å‡ºå…¶ä»–è®¾å¤‡çš„ç™»å½•
- æˆ–è€…ç­‰å¾… Telegram çš„å®‰å…¨é™åˆ¶è§£é™¤

### é—®é¢˜ 2ï¼šSession æ–‡ä»¶é”å®š

**çŠ¶æ€ï¼š** éƒ¨åˆ†è§£å†³ï¼ˆæœ‰é‡è¯•æœºåˆ¶ï¼‰

**å½±å“ï¼š** å¯èƒ½å½±å“æ€§èƒ½ï¼Œä½†ä¸åº”è¯¥å¯¼è‡´åŠŸèƒ½é—®é¢˜

### é—®é¢˜ 3ï¼šè¯·æ±‚é‡è¯•è¿‡å¤š

**çŠ¶æ€ï¼š** å¯èƒ½ä¸çŠ¶æ€å¾ªç¯ç›¸å…³

**é¢„æœŸï¼š** ä¿®å¤çŠ¶æ€å¾ªç¯ååº”è¯¥ä¼šæ”¹å–„

---

## âœ… ä¿®å¤å®Œæˆ

æ‰€æœ‰ä¿®å¤å·²å®Œæˆï¼š
- âœ… ä¿®å¤çŠ¶æ€å¾ªç¯é—®é¢˜ï¼ˆé˜²æ­¢åœ¨ `Waiting Code` çŠ¶æ€ä¸‹è§¦å‘æ›´æ–°ï¼‰
- âœ… ä»£ç å·²é€šè¿‡è¯­æ³•æ£€æŸ¥
- âœ… é€»è¾‘å·²æ›´æ–°

**è¯·é‡å¯åº”ç”¨å¹¶æµ‹è¯•ï¼**

ç°åœ¨ç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿï¼š
- é˜²æ­¢çŠ¶æ€å¾ªç¯
- é˜²æ­¢é‡å¤å‘é€éªŒè¯ç 
- åœ¨ `Waiting Code` çŠ¶æ€ä¸‹å®‰é™ç­‰å¾…ç”¨æˆ·è¾“å…¥éªŒè¯ç 

