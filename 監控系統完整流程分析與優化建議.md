# ç›£æ§ç³»çµ±å®Œæ•´æµç¨‹åˆ†æèˆ‡å„ªåŒ–å»ºè­°

## ğŸ“‹ ç›®éŒ„
1. [å®Œæ•´æµç¨‹åœ–](#å®Œæ•´æµç¨‹åœ–)
2. [è©³ç´°æ­¥é©Ÿåˆ†æ](#è©³ç´°æ­¥é©Ÿåˆ†æ)
3. [å•é¡Œè­˜åˆ¥](#å•é¡Œè­˜åˆ¥)
4. [å„ªåŒ–å»ºè­°](#å„ªåŒ–å»ºè­°)
5. [å¯¦æ–½å„ªå…ˆç´š](#å¯¦æ–½å„ªå…ˆç´š)

---

## ğŸ”„ å®Œæ•´æµç¨‹åœ–

```mermaid
graph TB
    Start([ç”¨æˆ¶é»æ“Šé–‹å§‹ç›£æ§]) --> FrontendCheck1{å‰ç«¯æª¢æŸ¥:<br/>æ˜¯å¦æ­£åœ¨å•Ÿå‹•?}
    FrontendCheck1 -->|æ˜¯| Toast1[é¡¯ç¤ºæç¤º: æ­£åœ¨å•Ÿå‹•]
    FrontendCheck1 -->|å¦| FrontendCheck2{æª¢æŸ¥ç›£è½è³¬æˆ¶}
    FrontendCheck2 -->|ç„¡| Toast2[éŒ¯èª¤: ç„¡ç›£è½è³¬æˆ¶]
    FrontendCheck2 -->|æœ‰| FrontendCheck3{æª¢æŸ¥ç›£æ§ç¾¤çµ„}
    FrontendCheck3 -->|ç„¡| Toast3[è­¦å‘Š: ç„¡ç›£æ§ç¾¤çµ„]
    FrontendCheck3 -->|æœ‰| FrontendCheck4{æª¢æŸ¥é—œéµè©é›†}
    FrontendCheck4 -->|ç„¡| Toast4[è­¦å‘Š: ç„¡é—œéµè©é›†]
    FrontendCheck4 -->|æœ‰| SetFlag[è¨­ç½® isStartingMonitoring = true]
    SetFlag --> IPCSend[é€šé IPC ç™¼é€ 'start-monitoring']
    IPCSend --> BackendReceive[å¾Œç«¯æ¥æ”¶å‘½ä»¤]
    
    BackendReceive --> BackendCheck1{å¾Œç«¯æª¢æŸ¥:<br/>æ˜¯å¦å·²åœ¨ç›£æ§?}
    BackendCheck1 -->|æ˜¯| BackendLog1[è¨˜éŒ„è­¦å‘Šä¸¦è¿”å›]
    BackendCheck1 -->|å¦| BackendCheck2{ç²å–åœ¨ç·šç›£è½è³¬æˆ¶}
    BackendCheck2 -->|ç„¡| BackendLog2[è¨˜éŒ„éŒ¯èª¤ä¸¦ç™¼é€äº‹ä»¶]
    BackendCheck2 -->|æœ‰| BackendGetGroups[ç²å–ç›£æ§ç¾¤çµ„åˆ—è¡¨]
    BackendGetGroups --> BackendGetKeywords[ç²å–é—œéµè©é›†åˆ—è¡¨]
    
    BackendGetKeywords --> LoopStart[é–‹å§‹éæ­·æ¯å€‹ç›£è½è³¬æˆ¶]
    LoopStart --> TelegramCheck1{æª¢æŸ¥å®¢æˆ¶ç«¯æ˜¯å¦å­˜åœ¨}
    TelegramCheck1 -->|å¦| LogError1[è¨˜éŒ„éŒ¯èª¤, è·³éæ­¤è³¬æˆ¶]
    TelegramCheck1 -->|æ˜¯| TelegramCheck2{æª¢æŸ¥å®¢æˆ¶ç«¯æ˜¯å¦é€£æ¥}
    TelegramCheck2 -->|å¦| TelegramConnect[èª¿ç”¨ client.connect]
    TelegramConnect -->|å¤±æ•—| LogError2[è¨˜éŒ„éŒ¯èª¤, è¿”å› False]
    TelegramConnect -->|æˆåŠŸ| TelegramResolveGroups
    TelegramCheck2 -->|æ˜¯| TelegramResolveGroups[è§£æç¾¤çµ„ URL ç‚º Chat ID]
    
    TelegramResolveGroups --> LoopGroup[éæ­·æ¯å€‹ç¾¤çµ„ URL]
    LoopGroup --> CheckNumeric{æ˜¯å¦ç‚ºæ•¸å­— ID?}
    CheckNumeric -->|æ˜¯| AddChatID[ç›´æ¥æ·»åŠ  Chat ID]
    CheckNumeric -->|å¦| TryJoin[å˜—è©¦åŠ å…¥ç¾¤çµ„]
    TryJoin -->|æˆåŠŸ| AddChatID
    TryJoin -->|å¤±æ•—| TryGetChat[å˜—è©¦ get_chat]
    TryGetChat -->|æˆåŠŸ| AddChatID
    TryGetChat -->|å¤±æ•—| TryUsername[å˜—è©¦æå–ç”¨æˆ¶å]
    TryUsername -->|æˆåŠŸ| AddChatID
    TryUsername -->|å¤±æ•—| MarkFailed[æ¨™è¨˜ç‚ºå¤±æ•—ç¾¤çµ„]
    
    AddChatID --> CheckMoreGroups{é‚„æœ‰æ›´å¤šç¾¤çµ„?}
    CheckMoreGroups -->|æ˜¯| LoopGroup
    CheckMoreGroups -->|å¦| CheckValidGroups{æ˜¯å¦æœ‰æœ‰æ•ˆç¾¤çµ„?}
    CheckValidGroups -->|å¦| LogError3[è¨˜éŒ„éŒ¯èª¤, è¿”å› False]
    CheckValidGroups -->|æ˜¯| StoreMonitoringInfo[å­˜å„²ç›£æ§ä¿¡æ¯åˆ° monitoring_info]
    
    StoreMonitoringInfo --> RemoveOldHandler{æ˜¯å¦æœ‰èˆŠè™•ç†å™¨?}
    RemoveOldHandler -->|æ˜¯| RemoveHandler[ç§»é™¤èˆŠè™•ç†å™¨]
    RemoveOldHandler -->|å¦| CreateHandler[å‰µå»ºæ¶ˆæ¯è™•ç†å™¨å‡½æ•¸]
    RemoveHandler --> CreateHandler
    
    CreateHandler --> CheckDispatcher{æª¢æŸ¥ Dispatcher æ˜¯å¦é‹è¡Œ?}
    CheckDispatcher -->|æ˜¯| RegisterHandler[è¨»å†Šè™•ç†å™¨]
    CheckDispatcher -->|å¦| CheckConnected{å®¢æˆ¶ç«¯æ˜¯å¦å·²é€£æ¥?}
    CheckConnected -->|æ˜¯| StopClient[èª¿ç”¨ client.stop]
    StopClient --> Wait1[ç­‰å¾… 0.5 ç§’]
    Wait1 --> StartClient[èª¿ç”¨ client.start]
    CheckConnected -->|å¦| StartClient
    StartClient -->|æˆåŠŸ| RegisterHandler
    StartClient -->|å¤±æ•—| LogError4[è¨˜éŒ„éŒ¯èª¤, è¿”å› False]
    
    RegisterHandler --> VerifyHandler{é©—è­‰è™•ç†å™¨å·²è¨»å†Š}
    VerifyHandler -->|æˆåŠŸ| ReturnTrue[è¿”å› True]
    VerifyHandler -->|å¤±æ•—| LogWarning[è¨˜éŒ„è­¦å‘Š]
    
    ReturnTrue --> BackendCheckSuccess{è‡³å°‘ä¸€å€‹è³¬æˆ¶æˆåŠŸ?}
    LogError1 --> BackendCheckSuccess
    LogError2 --> BackendCheckSuccess
    LogError3 --> BackendCheckSuccess
    LogError4 --> BackendCheckSuccess
    LogWarning --> BackendCheckSuccess
    
    BackendCheckSuccess -->|æ˜¯| SetMonitoringState[è¨­ç½® is_monitoring = True]
    SetMonitoringState --> SaveToDB[ä¿å­˜ç›£æ§ç‹€æ…‹åˆ°æ•¸æ“šåº«]
    SaveToDB --> SendEvent[ç™¼é€ monitoring-status-changed äº‹ä»¶]
    SendEvent --> StartBehaviorSim[å•Ÿå‹•è¡Œç‚ºæ¨¡æ“¬ä»»å‹™]
    StartBehaviorSim --> EndSuccess([ç›£æ§å•Ÿå‹•æˆåŠŸ])
    
    BackendCheckSuccess -->|å¦| LogAllFailed[è¨˜éŒ„æ‰€æœ‰è³¬æˆ¶å¤±æ•—]
    LogAllFailed --> EndFailed([ç›£æ§å•Ÿå‹•å¤±æ•—])
    
    EndSuccess --> MessageFlow[æ¶ˆæ¯è™•ç†æµç¨‹]
    EndFailed --> End
    
    MessageFlow --> ReceiveMessage[æ”¶åˆ° Telegram æ¶ˆæ¯]
    ReceiveMessage --> HandlerCheck1{æ¶ˆæ¯ä¾†è‡ªç›£æ§ç¾¤çµ„?}
    HandlerCheck1 -->|å¦| LogSkip1[è¨˜éŒ„ä¸¦è·³é]
    HandlerCheck1 -->|æ˜¯| HandlerCheck2{æ˜¯å¦ç‚ºè‡ªå·±ç™¼é€?}
    HandlerCheck2 -->|æ˜¯| LogSkip2[è¨˜éŒ„ä¸¦è·³é]
    HandlerCheck2 -->|å¦| HandlerCheck3{æ¶ˆæ¯æœ‰æ–‡æœ¬?}
    HandlerCheck3 -->|å¦| LogSkip3[è¨˜éŒ„ä¸¦è·³é]
    HandlerCheck3 -->|æ˜¯| KeywordMatch[é—œéµè©åŒ¹é…]
    KeywordMatch -->|åŒ¹é…| CaptureLead[æ•ç² Lead]
    KeywordMatch -->|ä¸åŒ¹é…| LogNoMatch[è¨˜éŒ„ç„¡åŒ¹é…]
    CaptureLead --> CheckDNC{æª¢æŸ¥ DNC åˆ—è¡¨}
    CheckDNC -->|æ˜¯| SkipLead[è·³éæ­¤ Lead]
    CheckDNC -->|å¦| CheckExisting{æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨}
    CheckExisting -->|æ˜¯| UpdateLead[æ›´æ–°ç¾æœ‰ Lead]
    CheckExisting -->|å¦| CreateLead[å‰µå»ºæ–° Lead]
    CreateLead --> TriggerAI[è§¸ç™¼ AI è‡ªå‹•å•å€™]
    UpdateLead --> ExecuteCampaign[åŸ·è¡ŒåŒ¹é…çš„æ´»å‹•]
    TriggerAI --> ExecuteCampaign
    ExecuteCampaign --> End
```

---

## ğŸ“ è©³ç´°æ­¥é©Ÿåˆ†æ

### éšæ®µ 1: å‰ç«¯é©—è­‰ (Frontend Validation)

**ä½ç½®**: `src/app.component.ts:2423-2489`

#### æ­¥é©Ÿ 1.1: é˜²é‡è¤‡é»æ“Šæª¢æŸ¥
```typescript
if (this.isStartingMonitoring()) {
  this.toastService.warning('æ­£åœ¨å•Ÿå‹•ç›£æ§ï¼Œè«‹ç¨å€™...', 2000);
  return;
}
```
**è©•ä¼°**: âœ… **æ­£ç¢º** - é˜²æ­¢é‡è¤‡è«‹æ±‚

#### æ­¥é©Ÿ 1.2: ç›£è½è³¬æˆ¶æª¢æŸ¥
```typescript
const listeners = this.listenerAccounts();
if (listeners.length === 0) {
  // è©³ç´°çš„éŒ¯èª¤æç¤º
}
```
**è©•ä¼°**: âœ… **æ­£ç¢º** - æä¾›æ¸…æ™°çš„éŒ¯èª¤ä¿¡æ¯

#### æ­¥é©Ÿ 1.3: ç›£æ§ç¾¤çµ„å’Œé—œéµè©æª¢æŸ¥
**è©•ä¼°**: âœ… **æ­£ç¢º** - æå‰é©—è­‰å¿…è¦æ¢ä»¶

#### æ­¥é©Ÿ 1.4: ç™¼é€ IPC å‘½ä»¤
```typescript
this.ipcService.send('start-monitoring');
setTimeout(() => {
  this.isStartingMonitoring.set(false);
}, 5000);
```
**è©•ä¼°**: âš ï¸ **æœ‰å•é¡Œ** - ä½¿ç”¨å›ºå®š 5 ç§’è¶…æ™‚ï¼Œæ‡‰è©²ç­‰å¾…å¾Œç«¯éŸ¿æ‡‰

---

### éšæ®µ 2: å¾Œç«¯è™•ç† (Backend Processing)

**ä½ç½®**: `backend/main.py:2503-2652`

#### æ­¥é©Ÿ 2.1: é‡è¤‡ç›£æ§æª¢æŸ¥
```python
if self.is_monitoring:
    self.send_log("Monitoring is already running", "warning")
    return
```
**è©•ä¼°**: âœ… **æ­£ç¢º** - é˜²æ­¢é‡è¤‡å•Ÿå‹•

#### æ­¥é©Ÿ 2.2: ç²å–ç›£è½è³¬æˆ¶
```python
accounts = await db.get_all_accounts()
listener_accounts = [a for a in accounts if a.get('role') == 'Listener' and a.get('status') == 'Online']
```
**è©•ä¼°**: âš ï¸ **å¯å„ªåŒ–** - æ‡‰è©²ä½¿ç”¨æ•¸æ“šåº«æŸ¥è©¢éæ¿¾ï¼Œè€Œä¸æ˜¯åœ¨å…§å­˜ä¸­éæ¿¾

#### æ­¥é©Ÿ 2.3: ç²å–ç›£æ§ç¾¤çµ„å’Œé—œéµè©
**è©•ä¼°**: âœ… **æ­£ç¢º** - å¾æ•¸æ“šåº«ç²å–é…ç½®

#### æ­¥é©Ÿ 2.4: å®šç¾© Lead æ•ç²å›èª¿
**è©•ä¼°**: âœ… **æ­£ç¢º** - åŒ…å« DNC æª¢æŸ¥ã€å»é‡ã€AI å•å€™ç­‰é‚è¼¯

#### æ­¥é©Ÿ 2.5: éæ­·è³¬æˆ¶å•Ÿå‹•ç›£æ§
**è©•ä¼°**: âš ï¸ **æœ‰å•é¡Œ** - é †åºåŸ·è¡Œï¼Œå¦‚æœç¬¬ä¸€å€‹è³¬æˆ¶å¤±æ•—æœƒé˜»å¡å¾ŒçºŒè³¬æˆ¶

---

### éšæ®µ 3: Telegram å®¢æˆ¶ç«¯å•Ÿå‹• (Telegram Client Startup)

**ä½ç½®**: `backend/telegram_client.py:1439-1927`

#### æ­¥é©Ÿ 3.1: å®¢æˆ¶ç«¯å­˜åœ¨æ€§æª¢æŸ¥
```python
if phone not in self.clients:
    return False
```
**è©•ä¼°**: âœ… **æ­£ç¢º** - åŸºæœ¬é©—è­‰

#### æ­¥é©Ÿ 3.2: å®¢æˆ¶ç«¯é€£æ¥æª¢æŸ¥
```python
if not client.is_connected:
    await client.connect()
```
**è©•ä¼°**: âš ï¸ **æœ‰å•é¡Œ** - é€™è£¡åªèª¿ç”¨ `connect()`ï¼Œä½†å¾ŒçºŒé‚„éœ€è¦ `start()`ï¼Œå¯èƒ½å°è‡´é‡è¤‡é€£æ¥

#### æ­¥é©Ÿ 3.3: ç¾¤çµ„ URL è§£æ
**è©•ä¼°**: âœ… **æ­£ç¢º** - å¤šç¨®è§£æç­–ç•¥ï¼ˆæ•¸å­— IDã€åŠ å…¥ç¾¤çµ„ã€get_chatã€ç”¨æˆ¶åæå–ï¼‰

**å•é¡Œ**: 
- é †åºåŸ·è¡Œï¼Œæ¯å€‹ç¾¤çµ„è§£æå¯èƒ½å¾ˆæ…¢
- æ²’æœ‰ä¸¦ç™¼è™•ç†
- å¤±æ•—çš„ç¾¤çµ„æœƒé˜»æ­¢æ•´å€‹ç›£æ§å•Ÿå‹•

#### æ­¥é©Ÿ 3.4: å­˜å„²ç›£æ§ä¿¡æ¯
```python
self.monitoring_info[phone] = {
    'chat_ids': monitored_chat_ids,
    'keyword_sets': keyword_sets,
    ...
}
```
**è©•ä¼°**: âœ… **æ­£ç¢º** - å­˜å„²å¿…è¦ä¿¡æ¯ä¾›è™•ç†å™¨ä½¿ç”¨

#### æ­¥é©Ÿ 3.5: ç§»é™¤èˆŠè™•ç†å™¨
**è©•ä¼°**: âœ… **æ­£ç¢º** - é˜²æ­¢é‡è¤‡è¨»å†Š

#### æ­¥é©Ÿ 3.6: å‰µå»ºæ¶ˆæ¯è™•ç†å™¨
**è©•ä¼°**: âœ… **æ­£ç¢º** - ä½¿ç”¨é–‰åŒ…æ•ç²å¿…è¦è®Šé‡

#### æ­¥é©Ÿ 3.7: æª¢æŸ¥ä¸¦å•Ÿå‹• Dispatcher
```python
if not dispatcher_running:
    if client.is_connected:
        await client.stop()
        await asyncio.sleep(0.5)
    await client.start()
```
**è©•ä¼°**: âœ… **æ­£ç¢º** - è™•ç†å·²é€£æ¥ä½†æœªå•Ÿå‹•çš„æƒ…æ³

**å•é¡Œ**:
- `asyncio.sleep(0.5)` æ˜¯ç¡¬ç·¨ç¢¼çš„ï¼Œå¯èƒ½ä¸å¤ 
- æ²’æœ‰é‡è©¦æ©Ÿåˆ¶

#### æ­¥é©Ÿ 3.8: è¨»å†Šè™•ç†å™¨
```python
client.add_handler(handler)
self.message_handlers[phone] = handler
```
**è©•ä¼°**: âœ… **æ­£ç¢º** - åœ¨å®¢æˆ¶ç«¯å•Ÿå‹•å¾Œè¨»å†Š

---

### éšæ®µ 4: æ¶ˆæ¯è™•ç†æµç¨‹ (Message Processing)

**ä½ç½®**: `backend/telegram_client.py:1641-1808`

#### æ­¥é©Ÿ 4.1: æ¥æ”¶æ¶ˆæ¯
**è©•ä¼°**: âœ… **æ­£ç¢º** - ä½¿ç”¨ Pyrogram çš„ MessageHandler

#### æ­¥é©Ÿ 4.2: ç¾¤çµ„éæ¿¾
```python
if chat_id not in mon_chat_ids:
    return
```
**è©•ä¼°**: âœ… **æ­£ç¢º** - éæ¿¾éç›£æ§ç¾¤çµ„

#### æ­¥é©Ÿ 4.3: è·³éè‡ªå·±ç™¼é€çš„æ¶ˆæ¯
**è©•ä¼°**: âœ… **æ­£ç¢º** - é¿å…è™•ç†è‡ªå·±çš„æ¶ˆæ¯

#### æ­¥é©Ÿ 4.4: é—œéµè©åŒ¹é…
```python
matched_keywords = trie_matcher.match(text)
```
**è©•ä¼°**: âœ… **æ­£ç¢º** - ä½¿ç”¨ Trie æ¨¹å„ªåŒ–åŒ¹é…

#### æ­¥é©Ÿ 4.5: æ•ç² Lead
**è©•ä¼°**: âœ… **æ­£ç¢º** - åŒ…å«å®Œæ•´çš„ç”¨æˆ¶ä¿¡æ¯

---

## âš ï¸ å•é¡Œè­˜åˆ¥

### ğŸ”´ åš´é‡å•é¡Œ (Critical Issues)

#### 1. **å‰ç«¯è¶…æ™‚æ©Ÿåˆ¶ä¸æº–ç¢º**
- **ä½ç½®**: `src/app.component.ts:2487-2489`
- **å•é¡Œ**: ä½¿ç”¨å›ºå®š 5 ç§’è¶…æ™‚ï¼Œä¸ç­‰å¾…å¾Œç«¯å¯¦éš›éŸ¿æ‡‰
- **å½±éŸ¿**: ç”¨æˆ¶å¯èƒ½çœ‹åˆ°éŒ¯èª¤çš„ç‹€æ…‹åé¥‹

#### 2. **ç¾¤çµ„è§£æé †åºåŸ·è¡Œï¼Œç„¡ä¸¦ç™¼**
- **ä½ç½®**: `backend/telegram_client.py:1488-1560`
- **å•é¡Œ**: æ¯å€‹ç¾¤çµ„ URL è§£ææ˜¯é †åºçš„ï¼Œå¦‚æœæœ‰å¾ˆå¤šç¾¤çµ„æœƒå¾ˆæ…¢
- **å½±éŸ¿**: å•Ÿå‹•ç›£æ§è€—æ™‚éé•·

#### 3. **è³¬æˆ¶å•Ÿå‹•ç›£æ§é †åºåŸ·è¡Œ**
- **ä½ç½®**: `backend/main.py:2590-2645`
- **å•é¡Œ**: å¦‚æœç¬¬ä¸€å€‹è³¬æˆ¶å¤±æ•—ï¼Œæœƒé˜»å¡å¾ŒçºŒè³¬æˆ¶
- **å½±éŸ¿**: éƒ¨åˆ†è³¬æˆ¶ç„¡æ³•å•Ÿå‹•ç›£æ§

#### 4. **å®¢æˆ¶ç«¯é€£æ¥å’Œå•Ÿå‹•é‚è¼¯é‡è¤‡**
- **ä½ç½®**: `backend/telegram_client.py:1467-1478` å’Œ `1872-1874`
- **å•é¡Œ**: å…ˆèª¿ç”¨ `connect()`ï¼Œç„¶å¾Œåˆå¯èƒ½èª¿ç”¨ `stop()` å’Œ `start()`
- **å½±éŸ¿**: ä¸å¿…è¦çš„é€£æ¥æ“ä½œï¼Œå¯èƒ½å°è‡´éŒ¯èª¤

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ (Medium Issues)

#### 5. **Dispatcher æª¢æŸ¥é‚è¼¯ä¸å¤ å¥å£¯**
- **ä½ç½®**: `backend/telegram_client.py:1829-1842`
- **å•é¡Œ**: ä¾è³´å¤šå€‹ `hasattr` æª¢æŸ¥ï¼Œå¯èƒ½ä¸æº–ç¢º
- **å½±éŸ¿**: å¯èƒ½èª¤åˆ¤ Dispatcher ç‹€æ…‹

#### 6. **ç¡¬ç·¨ç¢¼çš„ç­‰å¾…æ™‚é–“**
- **ä½ç½®**: `backend/telegram_client.py:1855, 1868`
- **å•é¡Œ**: `asyncio.sleep(0.5)` å’Œ `asyncio.sleep(0.3)` æ˜¯ç¡¬ç·¨ç¢¼çš„
- **å½±éŸ¿**: åœ¨æŸäº›æƒ…æ³ä¸‹å¯èƒ½ä¸å¤ 

#### 7. **æ•¸æ“šåº«æŸ¥è©¢æ•ˆç‡**
- **ä½ç½®**: `backend/main.py:2511-2512`
- **å•é¡Œ**: ç²å–æ‰€æœ‰è³¬æˆ¶ç„¶å¾Œåœ¨å…§å­˜ä¸­éæ¿¾
- **å½±éŸ¿**: ç•¶è³¬æˆ¶æ•¸é‡å¤šæ™‚æ•ˆç‡ä½

#### 8. **éŒ¯èª¤è™•ç†ä¸å®Œæ•´**
- **ä½ç½®**: å¤šè™•
- **å•é¡Œ**: æŸäº›ç•°å¸¸è¢«æ•ç²ä½†æ²’æœ‰è©³ç´°è¨˜éŒ„
- **å½±éŸ¿**: èª¿è©¦å›°é›£

### ğŸŸ¢ è¼•å¾®å•é¡Œ (Minor Issues)

#### 9. **æ—¥èªŒéå¤š**
- **ä½ç½®**: `backend/telegram_client.py:1653-1660`
- **å•é¡Œ**: æ¯æ¢æ¶ˆæ¯éƒ½è¨˜éŒ„è©³ç´°æ—¥èªŒ
- **å½±éŸ¿**: æ—¥èªŒæ–‡ä»¶å¯èƒ½å¾ˆå¤§

#### 10. **ç¼ºå°‘é€²åº¦åé¥‹**
- **ä½ç½®**: æ•´å€‹æµç¨‹
- **å•é¡Œ**: ç”¨æˆ¶ä¸çŸ¥é“å•Ÿå‹•é€²åº¦
- **å½±éŸ¿**: ç”¨æˆ¶é«”é©—ä¸ä½³

---

## ğŸ’¡ å„ªåŒ–å»ºè­°

### ğŸ”¥ é«˜å„ªå…ˆç´šå„ªåŒ– (High Priority)

#### 1. **å¯¦ç¾å‰ç«¯éŸ¿æ‡‰å¼ç‹€æ…‹ç®¡ç†**
```typescript
// å»ºè­°ä¿®æ”¹
startMonitoring() {
  // ... ç¾æœ‰æª¢æŸ¥ ...
  
  this.isStartingMonitoring.set(true);
  this.ipcService.send('start-monitoring');
  
  // ç›£è½å¾Œç«¯éŸ¿æ‡‰äº‹ä»¶
  this.ipcService.on('monitoring-status-changed', (status: boolean) => {
    this.isStartingMonitoring.set(false);
    if (status) {
      this.toastService.success('ç›£æ§å·²å•Ÿå‹•');
    } else {
      this.toastService.error('ç›£æ§å•Ÿå‹•å¤±æ•—');
    }
  });
  
  // è¨­ç½®è¶…æ™‚ï¼ˆä½œç‚ºå‚™ç”¨ï¼‰
  const timeout = setTimeout(() => {
    this.isStartingMonitoring.set(false);
    this.toastService.warning('å•Ÿå‹•è¶…æ™‚ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æ—¥èªŒ');
  }, 30000); // 30 ç§’è¶…æ™‚
}
```

#### 2. **ä¸¦ç™¼è™•ç†ç¾¤çµ„è§£æ**
```python
# å»ºè­°ä¿®æ”¹
async def start_monitoring(self, phone: str, group_urls: list, ...):
    # ... ç¾æœ‰ä»£ç¢¼ ...
    
    # ä¸¦ç™¼è§£ææ‰€æœ‰ç¾¤çµ„
    async def resolve_group(group_url):
        try:
            # è§£æé‚è¼¯
            return (chat_id, group_url, True)
        except Exception as e:
            return (None, group_url, False)
    
    # ä½¿ç”¨ asyncio.gather ä¸¦ç™¼è™•ç†
    results = await asyncio.gather(
        *[resolve_group(url) for url in group_urls],
        return_exceptions=True
    )
    
    # è™•ç†çµæœ
    for result in results:
        if isinstance(result, Exception):
            failed_groups.append(str(result))
        elif result[2]:  # success
            monitored_chat_ids.add(result[0])
            chat_id_to_url_map[result[0]] = result[1]
        else:
            failed_groups.append(result[1])
```

#### 3. **ä¸¦ç™¼å•Ÿå‹•å¤šå€‹è³¬æˆ¶çš„ç›£æ§**
```python
# å»ºè­°ä¿®æ”¹
async def handle_start_monitoring(self):
    # ... ç¾æœ‰æª¢æŸ¥ ...
    
    # ä¸¦ç™¼å•Ÿå‹•æ‰€æœ‰è³¬æˆ¶
    async def start_for_account(account):
        try:
            result = await self.telegram_manager.start_monitoring(...)
            return (account.get('phone'), result, None)
        except Exception as e:
            return (account.get('phone'), False, str(e))
    
    results = await asyncio.gather(
        *[start_for_account(acc) for acc in listener_accounts],
        return_exceptions=True
    )
    
    # çµ±è¨ˆçµæœ
    for result in results:
        if isinstance(result, Exception):
            failed_accounts.append("unknown")
        elif result[1]:
            successful_starts += 1
        else:
            failed_accounts.append(result[0])
```

#### 4. **å„ªåŒ–å®¢æˆ¶ç«¯å•Ÿå‹•é‚è¼¯**
```python
# å»ºè­°ä¿®æ”¹
async def start_monitoring(self, phone: str, ...):
    client = self.clients[phone]
    
    # çµ±ä¸€è™•ç†ï¼šç›´æ¥æª¢æŸ¥æ˜¯å¦éœ€è¦å•Ÿå‹•ï¼Œä¸è¦å…ˆ connect
    dispatcher_running = await self._check_dispatcher_running(client)
    
    if not dispatcher_running:
        # å¦‚æœå·²é€£æ¥ï¼Œå…ˆåœæ­¢
        if client.is_connected:
            await self._safe_stop_client(client, phone)
        
        # å•Ÿå‹•å®¢æˆ¶ç«¯ï¼ˆé€™æœƒè‡ªå‹•é€£æ¥ä¸¦åˆå§‹åŒ– dispatcherï¼‰
        await client.start()
    
    # ç¾åœ¨è¨»å†Šè™•ç†å™¨
    # ...
```

### ğŸŸ¡ ä¸­å„ªå…ˆç´šå„ªåŒ– (Medium Priority)

#### 5. **æ”¹é€² Dispatcher æª¢æŸ¥**
```python
async def _check_dispatcher_running(self, client: Client) -> bool:
    """æ›´å¥å£¯çš„ Dispatcher æª¢æŸ¥"""
    try:
        if not hasattr(client, 'dispatcher') or client.dispatcher is None:
            return False
        
        # æ–¹æ³• 1: æª¢æŸ¥ is_running å±¬æ€§
        if hasattr(client.dispatcher, 'is_running'):
            return client.dispatcher.is_running
        
        # æ–¹æ³• 2: æª¢æŸ¥ handlers
        if hasattr(client.dispatcher, 'handlers'):
            return len(client.dispatcher.handlers) > 0
        
        # æ–¹æ³• 3: å˜—è©¦è¨ªå•å…§éƒ¨ç‹€æ…‹
        if hasattr(client.dispatcher, '_running'):
            return client.dispatcher._running
        
        return False
    except Exception as e:
        print(f"[TelegramClient] Error checking dispatcher: {e}", file=sys.stderr)
        return False
```

#### 6. **ä½¿ç”¨æ•¸æ“šåº«æŸ¥è©¢éæ¿¾**
```python
# å»ºè­°ä¿®æ”¹
# åœ¨ database.py ä¸­æ·»åŠ æ–¹æ³•
async def get_online_listener_accounts(self):
    """ç›´æ¥å¾æ•¸æ“šåº«æŸ¥è©¢åœ¨ç·šçš„ç›£è½è³¬æˆ¶"""
    async with self._connection.execute(
        "SELECT * FROM accounts WHERE role = 'Listener' AND status = 'Online'"
    ) as cursor:
        rows = await cursor.fetchall()
        return [dict(row) for row in rows]

# åœ¨ main.py ä¸­ä½¿ç”¨
listener_accounts = await db.get_online_listener_accounts()
```

#### 7. **æ·»åŠ é‡è©¦æ©Ÿåˆ¶**
```python
async def _safe_stop_client(self, client: Client, phone: str, max_retries: int = 3):
    """å®‰å…¨åœæ­¢å®¢æˆ¶ç«¯ï¼Œå¸¶é‡è©¦"""
    for attempt in range(max_retries):
        try:
            await client.stop()
            await asyncio.sleep(0.5 * (attempt + 1))  # éå¢ç­‰å¾…æ™‚é–“
            return True
        except Exception as e:
            if attempt == max_retries - 1:
                # æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œå¼·åˆ¶æ–·é–‹
                try:
                    if client.is_connected:
                        await client.disconnect()
                except:
                    pass
                raise
            await asyncio.sleep(0.3 * (attempt + 1))
    return False
```

#### 8. **æ·»åŠ é€²åº¦åé¥‹**
```python
# åœ¨ handle_start_monitoring ä¸­
total_accounts = len(listener_accounts)
for idx, account in enumerate(listener_accounts):
    # ç™¼é€é€²åº¦äº‹ä»¶
    self.send_event("monitoring-progress", {
        "current": idx + 1,
        "total": total_accounts,
        "account": account.get('phone'),
        "status": "starting"
    })
    
    # ... å•Ÿå‹•é‚è¼¯ ...
    
    self.send_event("monitoring-progress", {
        "current": idx + 1,
        "total": total_accounts,
        "account": account.get('phone'),
        "status": "success" if result else "failed"
    })
```

### ğŸŸ¢ ä½å„ªå…ˆç´šå„ªåŒ– (Low Priority)

#### 9. **æ¢ä»¶æ—¥èªŒè¨˜éŒ„**
```python
# æ·»åŠ æ—¥èªŒç´šåˆ¥æ§åˆ¶
DEBUG_MODE = os.getenv('DEBUG_MONITORING', 'false').lower() == 'true'

if DEBUG_MODE:
    print(f"[TelegramClient] ========== MESSAGE RECEIVED ==========", file=sys.stderr)
    # ... è©³ç´°æ—¥èªŒ ...
```

#### 10. **æ·»åŠ ç›£æ§å¥åº·æª¢æŸ¥**
```python
async def check_monitoring_health(self, phone: str) -> Dict[str, Any]:
    """æª¢æŸ¥ç›£æ§å¥åº·ç‹€æ…‹"""
    health = {
        "client_exists": phone in self.clients,
        "client_connected": False,
        "dispatcher_running": False,
        "handler_registered": phone in self.message_handlers,
        "monitoring_info_exists": phone in self.monitoring_info,
        "monitored_groups_count": 0
    }
    
    if health["client_exists"]:
        client = self.clients[phone]
        health["client_connected"] = client.is_connected
        health["dispatcher_running"] = await self._check_dispatcher_running(client)
        
        if health["monitoring_info_exists"]:
            mon_info = self.monitoring_info[phone]
            health["monitored_groups_count"] = len(mon_info.get('chat_ids', []))
    
    return health
```

#### 11. **æ·»åŠ ç›£æ§çµ±è¨ˆ**
```python
# åœ¨ TelegramClientManager ä¸­æ·»åŠ 
self.monitoring_stats: Dict[str, Dict[str, Any]] = {}

# åœ¨æ¶ˆæ¯è™•ç†å™¨ä¸­æ›´æ–°
if chat_id in mon_chat_ids:
    if phone not in self.monitoring_stats:
        self.monitoring_stats[phone] = {
            "messages_received": 0,
            "keywords_matched": 0,
            "leads_captured": 0,
            "last_message_time": None
        }
    
    stats = self.monitoring_stats[phone]
    stats["messages_received"] += 1
    stats["last_message_time"] = datetime.now()
    
    if matched_keywords:
        stats["keywords_matched"] += 1
        stats["leads_captured"] += 1
```

---

## ğŸ“Š å¯¦æ–½å„ªå…ˆç´š

### ğŸ”¥ ç«‹å³å¯¦æ–½ (æœ¬é€±)
1. âœ… å‰ç«¯éŸ¿æ‡‰å¼ç‹€æ…‹ç®¡ç†
2. âœ… ä¸¦ç™¼è™•ç†ç¾¤çµ„è§£æ
3. âœ… ä¸¦ç™¼å•Ÿå‹•å¤šå€‹è³¬æˆ¶
4. âœ… å„ªåŒ–å®¢æˆ¶ç«¯å•Ÿå‹•é‚è¼¯

### ğŸŸ¡ çŸ­æœŸå¯¦æ–½ (ä¸‹é€±)
5. âœ… æ”¹é€² Dispatcher æª¢æŸ¥
6. âœ… ä½¿ç”¨æ•¸æ“šåº«æŸ¥è©¢éæ¿¾
7. âœ… æ·»åŠ é‡è©¦æ©Ÿåˆ¶
8. âœ… æ·»åŠ é€²åº¦åé¥‹

### ğŸŸ¢ é•·æœŸå„ªåŒ– (ä¸‹å€‹æœˆ)
9. âœ… æ¢ä»¶æ—¥èªŒè¨˜éŒ„
10. âœ… æ·»åŠ ç›£æ§å¥åº·æª¢æŸ¥
11. âœ… æ·»åŠ ç›£æ§çµ±è¨ˆ

---

## ğŸ“ˆ é æœŸæ•ˆæœ

å¯¦æ–½é€™äº›å„ªåŒ–å¾Œï¼Œé æœŸå¯ä»¥é”åˆ°ï¼š

1. **å•Ÿå‹•é€Ÿåº¦æå‡ 60-80%** (é€šéä¸¦ç™¼è™•ç†)
2. **éŒ¯èª¤ç‡é™ä½ 50%** (é€šéé‡è©¦æ©Ÿåˆ¶å’Œæ›´å¥½çš„éŒ¯èª¤è™•ç†)
3. **ç”¨æˆ¶é«”é©—æ”¹å–„** (é€šéé€²åº¦åé¥‹å’ŒéŸ¿æ‡‰å¼ç‹€æ…‹)
4. **èª¿è©¦æ•ˆç‡æå‡** (é€šéæ›´å¥½çš„æ—¥èªŒå’Œå¥åº·æª¢æŸ¥)
5. **ç³»çµ±ç©©å®šæ€§æå‡** (é€šéå¥å£¯çš„ Dispatcher æª¢æŸ¥å’Œå®¢æˆ¶ç«¯ç®¡ç†)

---

## ğŸ¯ ç¸½çµ

ç•¶å‰å¯¦ç¾çš„æµç¨‹**åŸºæœ¬æ­£ç¢º**ï¼Œä½†åœ¨ä»¥ä¸‹æ–¹é¢éœ€è¦å„ªåŒ–ï¼š

1. **æ€§èƒ½**: é †åºåŸ·è¡Œå°è‡´å•Ÿå‹•æ…¢
2. **å¯é æ€§**: ç¼ºå°‘é‡è©¦æ©Ÿåˆ¶å’Œå¥å£¯çš„éŒ¯èª¤è™•ç†
3. **ç”¨æˆ¶é«”é©—**: ç¼ºå°‘é€²åº¦åé¥‹å’ŒéŸ¿æ‡‰å¼ç‹€æ…‹
4. **å¯ç¶­è­·æ€§**: æ—¥èªŒéå¤šï¼Œç¼ºå°‘å¥åº·æª¢æŸ¥

å»ºè­°æŒ‰ç…§å„ªå…ˆç´šé€æ­¥å¯¦æ–½å„ªåŒ–ï¼Œé‡é»é—œæ³¨ä¸¦ç™¼è™•ç†å’ŒéŒ¯èª¤è™•ç†çš„æ”¹é€²ã€‚
