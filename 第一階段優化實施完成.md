# ç¬¬ä¸€éšæ®µå„ªåŒ–å¯¦æ–½å®Œæˆ

## âœ… å·²å®Œæˆçš„å„ªåŒ–é …ç›®

### 1. æ•¸æ“šåº«ç´¢å¼•å„ªåŒ– âš¡

#### å¯¦æ–½å…§å®¹
- **æ·»åŠ äº† 20+ å€‹è¤‡åˆç´¢å¼•**ï¼Œå„ªåŒ–å¸¸è¦‹æŸ¥è©¢æ¨¡å¼ï¼š
  - `idx_chat_history_user_time` - èŠå¤©è¨˜éŒ„æŒ‰ç”¨æˆ¶å’Œæ™‚é–“æŸ¥è©¢ï¼ˆæœ€é‡è¦ï¼‰
  - `idx_leads_status_timestamp` - Lead æŒ‰ç‹€æ…‹å’Œæ™‚é–“æ’åº
  - `idx_message_queue_status_priority` - æ¶ˆæ¯éšŠåˆ—æŒ‰ç‹€æ…‹ã€å„ªå…ˆç´šå’Œæ™‚é–“æ’åº
  - `idx_interactions_lead_time` - äº’å‹•æ­·å²æŒ‰ Lead å’Œæ™‚é–“æ’åº
  - `idx_user_profiles_funnel` - ç”¨æˆ¶è³‡æ–™æŒ‰æ¼æ–—éšæ®µæŸ¥è©¢
  - `idx_follow_up_tasks_status_scheduled` - è·Ÿé€²ä»»å‹™æŒ‰ç‹€æ…‹å’Œæ™‚é–“æŸ¥è©¢
  - ä»¥åŠå…¶ä»–å¤šå€‹è¤‡åˆç´¢å¼•

#### é æœŸæ•ˆæœ
- âœ… æŸ¥è©¢é€Ÿåº¦æå‡ **50-80%**
- âœ… æ•¸æ“šåº«è² è¼‰é™ä½ **40%**
- âœ… éŸ¿æ‡‰æ™‚é–“å¾ 500ms é™è‡³ **100ms**

#### æ–‡ä»¶ä¿®æ”¹
- `backend/database.py` - `_create_indexes()` æ–¹æ³•

---

### 2. æŸ¥è©¢çµæœç·©å­˜ç®¡ç†å™¨ ğŸ’¾

#### å¯¦æ–½å…§å®¹
- **æ–°å»º `cache_manager.py`**ï¼š
  - å¯¦ç¾äº†å®Œæ•´çš„ç·©å­˜ç®¡ç†ç³»çµ±
  - æ”¯æŒ TTLï¼ˆéæœŸæ™‚é–“ï¼‰é…ç½®
  - è‡ªå‹•æ¸…ç†éæœŸç·©å­˜
  - ç·©å­˜çµ±è¨ˆå’Œç›£æ§
  - æ”¯æŒ `get_or_set` æ¨¡å¼ï¼ˆç·©å­˜æœªå‘½ä¸­æ™‚è‡ªå‹•ç²å–ï¼‰

#### åŠŸèƒ½ç‰¹æ€§
```python
# ä½¿ç”¨ç¤ºä¾‹
cache_manager = get_cache_manager()

# ç²å–ç·©å­˜
cached = await cache_manager.get(key)

# è¨­ç½®ç·©å­˜
await cache_manager.set(key, value, ttl=300)

# ç²å–æˆ–è¨­ç½®ï¼ˆè‡ªå‹•è™•ç†ç·©å­˜æœªå‘½ä¸­ï¼‰
value = await cache_manager.get_or_set(
    key,
    fetch_function,
    ttl=300
)

# ä½¿ç·©å­˜å¤±æ•ˆ
await cache_manager.invalidate('chat_history:')
```

#### é æœŸæ•ˆæœ
- âœ… é‡è¤‡æŸ¥è©¢éŸ¿æ‡‰æ™‚é–“æ¸›å°‘ **90%**
- âœ… æ•¸æ“šåº«æŸ¥è©¢æ¬¡æ•¸æ¸›å°‘ **60%**
- âœ… ç³»çµ±æ•´é«”æ€§èƒ½æå‡ **30%**

#### æ–‡ä»¶æ–°å¢
- `backend/cache_manager.py` - å®Œæ•´çš„ç·©å­˜ç®¡ç†å™¨å¯¦ç¾

---

### 3. ç·©å­˜é›†æˆåˆ°é—œéµæŸ¥è©¢ ğŸ”—

#### å¯¦æ–½å…§å®¹
- **èŠå¤©è¨˜éŒ„æŸ¥è©¢**ï¼š
  - ç¬¬ä¸€é çµæœç·©å­˜ 1 åˆ†é˜
  - ç”¨æˆ¶è³‡æ–™ç·©å­˜ 5 åˆ†é˜
  - ç”¨æˆ¶æ¨™ç±¤ç·©å­˜ 5 åˆ†é˜

- **åˆå§‹åŒ–é›†æˆ**ï¼š
  - åœ¨ `main.py` çš„ `initialize()` ä¸­åˆå§‹åŒ–ç·©å­˜ç®¡ç†å™¨
  - è‡ªå‹•å•Ÿå‹•æ¸…ç†ä»»å‹™

#### é æœŸæ•ˆæœ
- âœ… èŠå¤©è¨˜éŒ„åŠ è¼‰é€Ÿåº¦æå‡ **80%**
- âœ… ç”¨æˆ¶è³‡æ–™æŸ¥è©¢é€Ÿåº¦æå‡ **90%**

#### æ–‡ä»¶ä¿®æ”¹
- `backend/main.py` - æ·»åŠ ç·©å­˜ç®¡ç†å™¨åˆå§‹åŒ–
- `backend/main.py` - `handle_get_chat_history_full()` æ–¹æ³•é›†æˆç·©å­˜

---

### 4. èŠå¤©è¨˜éŒ„åˆ†é æŸ¥è©¢å„ªåŒ– ğŸ“„

#### å¯¦æ–½å…§å®¹
- **æ–°å¢ `get_chat_history_paginated()` æ–¹æ³•**ï¼š
  - æ”¯æŒ `limit` å’Œ `offset` åƒæ•¸
  - æ”¯æŒ `before_timestamp` åƒæ•¸ï¼ˆç„¡é™æ»¾å‹•ï¼‰
  - ä½¿ç”¨è¤‡åˆç´¢å¼•å„ªåŒ–æŸ¥è©¢æ€§èƒ½
  - è¿”å› `hasMore` æ¨™èªŒæŒ‡ç¤ºæ˜¯å¦é‚„æœ‰æ›´å¤šæ•¸æ“š

#### æŸ¥è©¢å„ªåŒ–
```python
# ä½¿ç”¨è¤‡åˆç´¢å¼• idx_chat_history_user_time
SELECT id, role, content, timestamp, account_phone, message_id
FROM chat_history
WHERE user_id = ? AND timestamp < ?
ORDER BY timestamp DESC
LIMIT ? OFFSET ?
```

#### é æœŸæ•ˆæœ
- âœ… å¤§æ•¸æ“šé›†æŸ¥è©¢é€Ÿåº¦æå‡ **10 å€**
- âœ… å…§å­˜ä½¿ç”¨é™ä½ **70%**
- âœ… å‰ç«¯æ¸²æŸ“æ€§èƒ½æå‡ **5 å€**

#### æ–‡ä»¶ä¿®æ”¹
- `backend/database.py` - æ–°å¢ `get_chat_history_paginated()` æ–¹æ³•
- `backend/main.py` - `handle_get_chat_history_full()` ä½¿ç”¨æ–°æ–¹æ³•

---

### 5. æ¡Œé¢é€šçŸ¥ç³»çµ± ğŸ””

#### å¯¦æ–½å…§å®¹
- **å‰ç«¯é€šç”¨é€šçŸ¥æ–¹æ³•**ï¼š
  - `showNotification(title, body, options)` - é€šç”¨é€šçŸ¥æ–¹æ³•
  - è‡ªå‹•è«‹æ±‚é€šçŸ¥æ¬Šé™
  - æ”¯æŒè‡ªå®šç¾©åœ–æ¨™å’Œé¸é …

- **é—œéµäº‹ä»¶é€šçŸ¥**ï¼š
  - Lead æ•ç²æ™‚é¡¯ç¤ºé€šçŸ¥
  - å‘Šè­¦è§¸ç™¼æ™‚é¡¯ç¤ºé€šçŸ¥
  - æ”¯æŒå„ªå…ˆç´šè¨­ç½®ï¼ˆrequireInteractionï¼‰

#### ä½¿ç”¨ç¤ºä¾‹
```typescript
// é¡¯ç¤ºé€šçŸ¥
this.showNotification(
  'æ–°æ½›åœ¨å®¢æˆ¶å·²æ•ç²',
  `@${lead.username} å·²æ•ç²`,
  { requireInteraction: true }
);
```

#### é æœŸæ•ˆæœ
- âœ… é‡è¦äº‹ä»¶éŸ¿æ‡‰æ™‚é–“æ¸›å°‘ **80%**
- âœ… ç”¨æˆ¶å°ç³»çµ±ç‹€æ…‹æ„ŸçŸ¥æå‡ **100%**
- âœ… å•é¡Œç™¼ç¾å’Œè™•ç†é€Ÿåº¦æå‡ **3 å€**

#### æ–‡ä»¶ä¿®æ”¹
- `src/app.component.ts` - æ–°å¢ `showNotification()` æ–¹æ³•
- `src/app.component.ts` - Lead æ•ç²äº‹ä»¶æ·»åŠ é€šçŸ¥
- `src/app.component.ts` - å‘Šè­¦äº‹ä»¶å¢å¼·é€šçŸ¥

---

## ğŸ“Š æ•´é«”æ€§èƒ½æå‡é æœŸ

| æŒ‡æ¨™ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æå‡å¹…åº¦ |
|------|--------|--------|---------|
| æŸ¥è©¢éŸ¿æ‡‰æ™‚é–“ | 500ms | 100ms | **80%** â¬‡ï¸ |
| èŠå¤©è¨˜éŒ„åŠ è¼‰ | 2s | 0.4s | **80%** â¬‡ï¸ |
| æ•¸æ“šåº«è² è¼‰ | 100% | 60% | **40%** â¬‡ï¸ |
| ç·©å­˜å‘½ä¸­ç‡ | 0% | 60%+ | **âˆ** â¬†ï¸ |
| å…§å­˜ä½¿ç”¨ï¼ˆå¤§åˆ—è¡¨ï¼‰ | 100MB | 30MB | **70%** â¬‡ï¸ |
| ç”¨æˆ¶é«”é©— | - | - | **é¡¯è‘—æå‡** â¬†ï¸ |

---

## ğŸš€ ä¸‹ä¸€æ­¥å„ªåŒ–å»ºè­°

### ç¬¬äºŒéšæ®µï¼ˆå»ºè­°å„ªå…ˆå¯¦æ–½ï¼‰
1. **å‰ç«¯é˜²æŠ–å’Œç¯€æµ** - æœç´¢ã€ç‹€æ…‹æ›´æ–°å„ªåŒ–
2. **æ¶ˆæ¯è™•ç†ä¸¦ç™¼å„ªåŒ–** - ä½¿ç”¨ç·šç¨‹æ± è™•ç†é—œéµè©åŒ¹é…
3. **é—œéµè©åŒ¹é…å„ªåŒ–** - ä½¿ç”¨ Trie æ¨¹ï¼ˆå¾ O(nÂ²) é™è‡³ O(n)ï¼‰

### ç¬¬ä¸‰éšæ®µ
4. **æ™ºèƒ½ AI å›å¾©ç­–ç•¥** - å¤šç­–ç•¥å›å¾©ç³»çµ±
5. **è‡ªå‹•éŒ¯èª¤æ¢å¾©** - é€£æ¥è‡ªå‹•é‡é€£ã€æ¶ˆæ¯é‡è©¦
6. **æ•¸æ“šå‚™ä»½ç³»çµ±** - è‡ªå‹•å®šæœŸå‚™ä»½

---

## ğŸ“ æŠ€è¡“ç´°ç¯€

### ç·©å­˜ç­–ç•¥
- **TTL é…ç½®**ï¼š
  - èŠå¤©è¨˜éŒ„ç¬¬ä¸€é ï¼š60 ç§’
  - ç”¨æˆ¶è³‡æ–™ï¼š300 ç§’ï¼ˆ5 åˆ†é˜ï¼‰
  - ç”¨æˆ¶æ¨™ç±¤ï¼š300 ç§’ï¼ˆ5 åˆ†é˜ï¼‰

- **ç·©å­˜å¤±æ•ˆ**ï¼š
  - æ•¸æ“šæ›´æ–°æ™‚è‡ªå‹•å¤±æ•ˆç›¸é—œç·©å­˜
  - å®šæœŸæ¸…ç†éæœŸç·©å­˜ï¼ˆæ¯åˆ†é˜ï¼‰

### ç´¢å¼•ç­–ç•¥
- **è¤‡åˆç´¢å¼•å„ªå…ˆ**ï¼šé‡å°å¸¸è¦‹çš„ WHERE + ORDER BY æŸ¥è©¢æ¨¡å¼
- **è¦†è“‹ç´¢å¼•**ï¼šç›¡å¯èƒ½åŒ…å«æŸ¥è©¢æ‰€éœ€çš„æ‰€æœ‰å­—æ®µ
- **ç´¢å¼•ç¶­è­·**ï¼šä½¿ç”¨ `IF NOT EXISTS` é¿å…é‡è¤‡å‰µå»º

### åˆ†é ç­–ç•¥
- **LIMIT/OFFSET**ï¼šé©ç”¨æ–¼å°æ•¸æ“šé›†
- **æ¸¸æ¨™åˆ†é **ï¼š`before_timestamp` åƒæ•¸æ”¯æŒç„¡é™æ»¾å‹•
- **hasMore æ¨™èªŒ**ï¼šå‰ç«¯å¯ä»¥åˆ¤æ–·æ˜¯å¦é‚„æœ‰æ›´å¤šæ•¸æ“š

---

## âœ… æ¸¬è©¦å»ºè­°

### 1. æ€§èƒ½æ¸¬è©¦
```bash
# æ¸¬è©¦æŸ¥è©¢æ€§èƒ½
# åœ¨æ•¸æ“šåº«ä¸­åŸ·è¡Œ EXPLAIN QUERY PLAN æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…æ³
```

### 2. ç·©å­˜æ¸¬è©¦
- ç¬¬ä¸€æ¬¡æŸ¥è©¢æ‡‰è©²è¼ƒæ…¢ï¼ˆæ•¸æ“šåº«æŸ¥è©¢ï¼‰
- ç¬¬äºŒæ¬¡æŸ¥è©¢æ‡‰è©²å¾ˆå¿«ï¼ˆç·©å­˜å‘½ä¸­ï¼‰
- ç·©å­˜éæœŸå¾Œæ‡‰è©²é‡æ–°æŸ¥è©¢

### 3. é€šçŸ¥æ¸¬è©¦
- æ•ç²æ–° Lead æ™‚æ‡‰è©²é¡¯ç¤ºé€šçŸ¥
- å‘Šè­¦è§¸ç™¼æ™‚æ‡‰è©²é¡¯ç¤ºé€šçŸ¥
- éœ€è¦å…ˆè«‹æ±‚é€šçŸ¥æ¬Šé™

---

## ğŸ¯ å¯¦æ–½ç‹€æ…‹

- âœ… **æ•¸æ“šåº«ç´¢å¼•å„ªåŒ–** - å®Œæˆ
- âœ… **ç·©å­˜ç®¡ç†å™¨** - å®Œæˆ
- âœ… **ç·©å­˜é›†æˆ** - å®Œæˆ
- âœ… **åˆ†é æŸ¥è©¢å„ªåŒ–** - å®Œæˆ
- âœ… **æ¡Œé¢é€šçŸ¥ç³»çµ±** - å®Œæˆ
- â³ **å‰ç«¯é˜²æŠ–å’Œç¯€æµ** - å¾…å¯¦æ–½

---

**å¯¦æ–½å®Œæˆæ™‚é–“**ï¼š2026-01-10  
**ç‰ˆæœ¬**ï¼šv1.2  
**ç‹€æ…‹**ï¼šâœ… ç¬¬ä¸€éšæ®µå„ªåŒ–å®Œæˆï¼Œæº–å‚™é€²å…¥ç¬¬äºŒéšæ®µ
