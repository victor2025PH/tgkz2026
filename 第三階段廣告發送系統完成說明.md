# Phase 3ï¼šå»£å‘Šç™¼é€ç³»çµ±å®Œæˆèªªæ˜

## å®Œæˆæ™‚é–“
2026-01-11

## ç³»çµ±æ¦‚è¿°

å»£å‘Šç™¼é€ç³»çµ±æ˜¯ TG-Matrix è‡ªå‹•åŒ–ç‡ŸéŠ·å¹³å°çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œæä¾›å®Œæ•´çš„å»£å‘Šæ¨¡æ¿ç®¡ç†ã€è¨ˆåŠƒèª¿åº¦ã€ç™¼é€åŸ·è¡Œå’Œæ•ˆæœåˆ†æèƒ½åŠ›ã€‚

## æ ¸å¿ƒåŠŸèƒ½

### 1. å»£å‘Šæ¨¡æ¿ç³»çµ± (ad_template.py)

**Spintax è®Šé«”ç”Ÿæˆå™¨**
- æ”¯æŒ `{é¸é …1|é¸é …2|é¸é …3}` èªæ³•
- æ”¯æŒåµŒå¥—è®Šé«”ï¼š`{Hello|Hi {there|friend}|Hey}`
- è‡ªå‹•ç”Ÿæˆå¤šç¨®å…§å®¹è®Šé«”ï¼Œé¿å…é‡è¤‡

**æ¨¡æ¿ç®¡ç†**
- å‰µå»ºã€æ›´æ–°ã€åˆªé™¤æ¨¡æ¿
- æ¨¡æ¿ç‹€æ…‹åˆ‡æ›ï¼ˆå•Ÿç”¨/åœç”¨ï¼‰
- ä½¿ç”¨çµ±è¨ˆè¿½è¹¤
- æ”¯æŒå¤šç¨®åª’é«”é¡å‹ï¼šæ–‡å­—ã€åœ–ç‰‡ã€å½±ç‰‡ã€æ–‡ä»¶ã€GIF

### 2. å»£å‘Šç®¡ç†å™¨ (ad_manager.py)

**ç™¼é€è¨ˆåŠƒç®¡ç†**
- ä¸€æ¬¡æ€§ç™¼é€
- æ¯æ—¥å®šæ™‚ç™¼é€
- é–“éš”å¾ªç’°ç™¼é€
- é—œéµè©è§¸ç™¼ç™¼é€

**å¸³è™Ÿç­–ç•¥**
- å–®ä¸€å¸³è™Ÿç™¼é€
- è¼ªæ›å¸³è™Ÿç™¼é€
- éš¨æ©Ÿå¸³è™Ÿé¸æ“‡
- æ¥åŠ›ç™¼é€æ¨¡å¼

**é€Ÿç‡é™åˆ¶**
- ç¾¤çµ„ç™¼é€é–“éš”æ§åˆ¶ï¼ˆé»˜èª 30 ç§’ï¼‰
- å¸³è™Ÿæ¯å°æ™‚ç™¼é€é™åˆ¶ï¼ˆé»˜èª 20 æ¬¡ï¼‰
- å¸³è™Ÿæ¯æ—¥ç™¼é€é™åˆ¶ï¼ˆé»˜èª 100 æ¬¡ï¼‰

### 3. å»£å‘Šç™¼é€å¼•æ“ (ad_broadcaster.py)

**æ ¸å¿ƒç™¼é€åŠŸèƒ½**
- å–®æ¢å»£å‘Šç™¼é€
- æ‰¹é‡ç¾¤çµ„ç™¼é€
- ç«‹å³ç™¼é€æ¨¡å¼
- è‡ªå‹•é‡è©¦æ©Ÿåˆ¶

**é€²åº¦å›å ±**
- å¯¦æ™‚ç™¼é€é€²åº¦
- æˆåŠŸ/å¤±æ•—çµ±è¨ˆ
- è©³ç´°éŒ¯èª¤ä¿¡æ¯

**é˜²å°æªæ–½**
- éš¨æ©Ÿå»¶é²ï¼ˆ30-120 ç§’ï¼‰
- å¸³è™Ÿè¼ªæ›
- é€Ÿç‡é™åˆ¶

### 4. å®šæ™‚èª¿åº¦å™¨ (ad_scheduler.py)

**èª¿åº¦åŠŸèƒ½**
- èƒŒæ™¯ä»»å‹™ç®¡ç†
- å®šæ™‚æª¢æŸ¥åŸ·è¡Œ
- é—œéµè©è§¸ç™¼ç›£è½
- æ‰‹å‹•ç«‹å³åŸ·è¡Œ

**ç‹€æ…‹ç›£æ§**
- ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“è¨ˆç®—
- åŸ·è¡Œæ­·å²è¨˜éŒ„
- è¨ˆåŠƒç‹€æ…‹ç®¡ç†

### 5. æ•ˆæœåˆ†æ (ad_analytics.py)

**çµ±è¨ˆå ±è¡¨**
- ç¸½è¦½çµ±è¨ˆï¼ˆ7å¤©/30å¤©ï¼‰
- æ¨¡æ¿æ•ˆæœçµ±è¨ˆ
- è¨ˆåŠƒåŸ·è¡Œçµ±è¨ˆ
- å¸³è™Ÿç™¼é€çµ±è¨ˆ
- ç¾¤çµ„è§¸é”çµ±è¨ˆ
- æ¯æ—¥è¶¨å‹¢æ•¸æ“š
- å°æ™‚åˆ†ä½ˆåˆ†æ

## æ•¸æ“šåº«è¡¨çµæ§‹

### ad_templates è¡¨
```sql
CREATE TABLE ad_templates (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    content TEXT NOT NULL,
    media_type TEXT DEFAULT 'text',
    media_file_id TEXT,
    media_path TEXT,
    is_active INTEGER DEFAULT 1,
    use_count INTEGER DEFAULT 0,
    success_count INTEGER DEFAULT 0,
    fail_count INTEGER DEFAULT 0,
    created_at TEXT,
    updated_at TEXT
)
```

### ad_schedules è¡¨
```sql
CREATE TABLE ad_schedules (
    id INTEGER PRIMARY KEY,
    template_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    target_groups TEXT NOT NULL,
    send_mode TEXT NOT NULL,
    schedule_type TEXT NOT NULL,
    schedule_time TEXT,
    interval_minutes INTEGER DEFAULT 60,
    trigger_keywords TEXT,
    account_strategy TEXT DEFAULT 'single',
    assigned_accounts TEXT NOT NULL,
    is_active INTEGER DEFAULT 1,
    last_run_at TEXT,
    next_run_at TEXT,
    run_count INTEGER DEFAULT 0,
    success_count INTEGER DEFAULT 0,
    fail_count INTEGER DEFAULT 0,
    created_at TEXT,
    updated_at TEXT
)
```

### ad_send_logs è¡¨
```sql
CREATE TABLE ad_send_logs (
    id INTEGER PRIMARY KEY,
    template_id INTEGER NOT NULL,
    schedule_id INTEGER,
    account_phone TEXT NOT NULL,
    target_group_id TEXT NOT NULL,
    target_group_title TEXT,
    message_id INTEGER,
    variant_content TEXT,
    status TEXT DEFAULT 'sent',
    error_message TEXT,
    sent_at TEXT NOT NULL
)
```

## API å‘½ä»¤

### æ¨¡æ¿ç®¡ç†
| å‘½ä»¤ | èªªæ˜ | äº‹ä»¶ |
|------|------|------|
| `create-ad-template` | å‰µå»ºæ¨¡æ¿ | `ad-template-created` |
| `update-ad-template` | æ›´æ–°æ¨¡æ¿ | `ad-template-updated` |
| `delete-ad-template` | åˆªé™¤æ¨¡æ¿ | `ad-template-deleted` |
| `get-ad-templates` | ç²å–åˆ—è¡¨ | `ad-templates` |
| `toggle-ad-template-status` | åˆ‡æ›ç‹€æ…‹ | `ad-template-toggled` |
| `preview-ad-template` | é è¦½è®Šé«” | `ad-template-preview` |
| `validate-spintax` | é©—è­‰èªæ³• | `spintax-validated` |

### è¨ˆåŠƒç®¡ç†
| å‘½ä»¤ | èªªæ˜ | äº‹ä»¶ |
|------|------|------|
| `create-ad-schedule` | å‰µå»ºè¨ˆåŠƒ | `ad-schedule-created` |
| `update-ad-schedule` | æ›´æ–°è¨ˆåŠƒ | `ad-schedule-updated` |
| `delete-ad-schedule` | åˆªé™¤è¨ˆåŠƒ | `ad-schedule-deleted` |
| `get-ad-schedules` | ç²å–åˆ—è¡¨ | `ad-schedules` |
| `toggle-ad-schedule-status` | åˆ‡æ›ç‹€æ…‹ | `ad-schedule-toggled` |
| `run-ad-schedule-now` | ç«‹å³åŸ·è¡Œ | `ad-schedule-run-result` |

### ç™¼é€æ“ä½œ
| å‘½ä»¤ | èªªæ˜ | äº‹ä»¶ |
|------|------|------|
| `send-ad-now` | ç«‹å³ç™¼é€ | `ad-send-result` |
| `get-ad-send-logs` | ç²å–è¨˜éŒ„ | `ad-send-logs` |

### æ•ˆæœåˆ†æ
| å‘½ä»¤ | èªªæ˜ | äº‹ä»¶ |
|------|------|------|
| `get-ad-overview-stats` | ç¸½è¦½çµ±è¨ˆ | `ad-overview-stats` |
| `get-ad-template-stats` | æ¨¡æ¿çµ±è¨ˆ | `ad-template-stats` |
| `get-ad-schedule-stats` | è¨ˆåŠƒçµ±è¨ˆ | `ad-schedule-stats` |
| `get-ad-account-stats` | å¸³è™Ÿçµ±è¨ˆ | `ad-account-stats` |
| `get-ad-group-stats` | ç¾¤çµ„çµ±è¨ˆ | `ad-group-stats` |
| `get-ad-daily-stats` | æ¯æ—¥çµ±è¨ˆ | `ad-daily-stats` |

## å¯¦æ™‚äº‹ä»¶

| äº‹ä»¶ | èªªæ˜ |
|------|------|
| `ad-sent` | å»£å‘Šç™¼é€æˆåŠŸ |
| `ad-send-failed` | å»£å‘Šç™¼é€å¤±æ•— |
| `broadcast-started` | æ‰¹é‡ç™¼é€é–‹å§‹ |
| `broadcast-progress` | æ‰¹é‡ç™¼é€é€²åº¦ |
| `broadcast-completed` | æ‰¹é‡ç™¼é€å®Œæˆ |
| `ad-scheduler-started` | èª¿åº¦å™¨å·²å•Ÿå‹• |
| `ad-scheduler-stopped` | èª¿åº¦å™¨å·²åœæ­¢ |

## å‰ç«¯ç•Œé¢

### å»£å‘Šç™¼é€é é¢
- **æ¨¡æ¿ç®¡ç†** Tab
  - æ¨¡æ¿åˆ—è¡¨é¡¯ç¤º
  - å‰µå»ºæ–°æ¨¡æ¿è¡¨å–®
  - Spintax é è¦½åŠŸèƒ½
  - æ¨¡æ¿ç‹€æ…‹åˆ‡æ›
  - ä½¿ç”¨çµ±è¨ˆå±•ç¤º

- **ç™¼é€è¨ˆåŠƒ** Tab
  - è¨ˆåŠƒåˆ—è¡¨é¡¯ç¤º
  - å‰µå»ºè¨ˆåŠƒè¡¨å–®
  - å¸³è™Ÿé¸æ“‡ï¼ˆå¤šé¸ï¼‰
  - ç›®æ¨™ç¾¤çµ„è¼¸å…¥
  - ç«‹å³åŸ·è¡ŒæŒ‰éˆ•
  - è¨ˆåŠƒç‹€æ…‹ç®¡ç†

- **ç™¼é€è¨˜éŒ„** Tab
  - ç™¼é€æ­·å²è¡¨æ ¼
  - ç‹€æ…‹æ¨™ç±¤é¡¯ç¤º
  - å…§å®¹é è¦½

- **æ•ˆæœåˆ†æ** Tab
  - ç¸½è¦½çµ±è¨ˆå¡ç‰‡
  - ç™¼é€çµ±è¨ˆè©³æƒ…
  - ç³»çµ±ç‹€æ…‹ä¿¡æ¯

## Spintax èªæ³•ç¤ºä¾‹

```
åŸºç¤ç”¨æ³•ï¼š
{ä½ å¥½|å—¨|Hello}ï¼æ­¡è¿ä¾†åˆ°æˆ‘å€‘çš„{ç¤¾å€|ç¾¤çµ„}ï¼

åµŒå¥—ç”¨æ³•ï¼š
{æ—©ä¸Šå¥½|æ™šä¸Šå¥½{ï¼Œæœ‹å‹|ï¼}}ï¼Œ{ä»Šå¤©|é€™é€±}æœ‰æ–°çš„{å„ªæƒ |æ´»å‹•}ï¼

è¤‡é›œè®Šé«”ï¼š
{ã€é‡è¦ã€‘|ğŸ“¢|â­} {é™æ™‚|ç¨å®¶}å„ªæƒ ï¼
æˆ‘å€‘æä¾›{å°ˆæ¥­|å„ªè³ª|ä¸€æµ}çš„{æœå‹™|ç”¢å“}ï¼Œ
{ç«‹å³|ç¾åœ¨}è¯ç¹«æˆ‘å€‘ç²å–{æ›´å¤šä¿¡æ¯|å ±åƒ¹}ï¼
```

## æ–°å¢æ–‡ä»¶åˆ—è¡¨

### Backend
- `backend/ad_template.py` - å»£å‘Šæ¨¡æ¿ç³»çµ±
- `backend/ad_manager.py` - å»£å‘Šç®¡ç†å™¨
- `backend/ad_broadcaster.py` - ç™¼é€å¼•æ“
- `backend/ad_scheduler.py` - å®šæ™‚èª¿åº¦å™¨
- `backend/ad_analytics.py` - æ•ˆæœåˆ†æ

### Frontend
- `src/models.ts` - æ–°å¢æ¥å£å®šç¾©
- `src/app.component.ts` - æ–°å¢ç‹€æ…‹å’Œæ–¹æ³•
- `src/app.component.html` - æ–°å¢å»£å‘Šç®¡ç†é é¢

## ä½¿ç”¨èªªæ˜

### 1. å‰µå»ºå»£å‘Šæ¨¡æ¿
1. é€²å…¥ã€Œå»£å‘Šç™¼é€ã€é é¢
2. é»æ“Šã€Œæ¨¡æ¿ç®¡ç†ã€Tab
3. é»æ“Šã€Œæ–°å»ºæ¨¡æ¿ã€
4. è¼¸å…¥æ¨¡æ¿åç¨±å’Œå…§å®¹ï¼ˆæ”¯æŒ Spintaxï¼‰
5. é»æ“Šã€Œé è¦½è®Šé«”ã€æŸ¥çœ‹ç”Ÿæˆæ•ˆæœ
6. é»æ“Šã€Œå‰µå»ºæ¨¡æ¿ã€

### 2. å‰µå»ºç™¼é€è¨ˆåŠƒ
1. é»æ“Šã€Œç™¼é€è¨ˆåŠƒã€Tab
2. é»æ“Šã€Œæ–°å»ºè¨ˆåŠƒã€
3. é¸æ“‡æ¨¡æ¿ã€ç™¼é€æ¨¡å¼ã€è¨ˆåŠƒé¡å‹
4. å‹¾é¸ç™¼é€å¸³è™Ÿ
5. è¼¸å…¥ç›®æ¨™ç¾¤çµ„ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰
6. é»æ“Šã€Œå‰µå»ºè¨ˆåŠƒã€

### 3. åŸ·è¡Œç™¼é€
- **è‡ªå‹•åŸ·è¡Œ**ï¼šå•Ÿç”¨è¨ˆåŠƒå¾ŒæœƒæŒ‰è¨­å®šæ™‚é–“è‡ªå‹•åŸ·è¡Œ
- **æ‰‹å‹•åŸ·è¡Œ**ï¼šé»æ“Šè¨ˆåŠƒçš„ã€ŒåŸ·è¡Œã€æŒ‰éˆ•ç«‹å³ç™¼é€

### 4. æŸ¥çœ‹æ•ˆæœ
1. é»æ“Šã€Œç™¼é€è¨˜éŒ„ã€æŸ¥çœ‹æ­·å²ç™¼é€
2. é»æ“Šã€Œæ•ˆæœåˆ†æã€æŸ¥çœ‹çµ±è¨ˆå ±è¡¨

## å¾ŒçºŒå»ºè­°

1. **é—œéµè©è§¸ç™¼æ•´åˆ**ï¼šèˆ‡ç¾¤çµ„ç›£æ§ç³»çµ±è¯å‹•ï¼Œå¯¦ç¾è‡ªå‹•è§¸ç™¼ç™¼é€
2. **A/B æ¸¬è©¦**ï¼šæ”¯æŒåŒä¸€è¨ˆåŠƒä½¿ç”¨å¤šå€‹æ¨¡æ¿é€²è¡Œæ•ˆæœå°æ¯”
3. **æ™ºèƒ½ç™¼é€æ™‚é–“**ï¼šæ ¹æ“šæ­·å²æ•¸æ“šåˆ†ææœ€ä½³ç™¼é€æ™‚é–“
4. **é»‘åå–®ç®¡ç†**ï¼šè‡ªå‹•è­˜åˆ¥å’Œè·³éå·²è¢«å°ç¦çš„ç¾¤çµ„
5. **åœ–è¡¨å¯è¦–åŒ–**ï¼šæ·»åŠ è¶¨å‹¢åœ–è¡¨å’Œæ•¸æ“šå¯è¦–åŒ–

## æŠ€è¡“äº®é»

1. **Spintax å¼•æ“**ï¼šæ”¯æŒåµŒå¥—èªæ³•çš„è®Šé«”ç”Ÿæˆå™¨
2. **é€Ÿç‡é™åˆ¶**ï¼šå¤šå±¤æ¬¡é˜²å°æ©Ÿåˆ¶
3. **å¸³è™Ÿè¼ªæ›**ï¼šæ™ºèƒ½å¸³è™Ÿé¸æ“‡ç­–ç•¥
4. **å¯¦æ™‚é€²åº¦**ï¼šWebSocket äº‹ä»¶é©…å‹•çš„é€²åº¦å›å ±
5. **çµ±è¨ˆåˆ†æ**ï¼šå¤šç¶­åº¦æ•ˆæœåˆ†æå ±è¡¨
