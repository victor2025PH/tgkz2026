# Phase 6：多帳號多角色協作系統完成說明

## 完成時間
2026-01-11

## 系統概述

多帳號多角色協作系統是 TG-Matrix 的高級功能，實現多個帳號扮演不同角色互相配合，通過劇本驅動的對話自動化營銷場景。

## 核心功能

### 1. 角色管理器 (multi_role_manager.py)

**8 種預設角色類型**

| 角色 | 代碼 | 說明 | 功能 |
|------|------|------|------|
| 🧑‍💼 銷售顧問 | `seller` | 主要銷售人員 | 主動觸達、需求挖掘、引導對話 |
| 👨‍🔬 專業顧問 | `expert` | 專業技術人員 | 專業解答、技術背書、增加信任 |
| 😊 滿意客戶 | `satisfied` | 老客戶角色 | 分享好評、推薦產品、帶動氣氛 |
| 🤔 猶豫客戶 | `hesitant` | 新客戶角色 | 提出疑問、被說服、示範轉化 |
| 🎉 成交客戶 | `converted` | 剛成交客戶 | 曬單反饋、增加緊迫感 |
| ❓ 好奇者 | `curious` | 圍觀者 | 問問題、帶節奏、活躍氣氛 |
| 👔 經理主管 | `manager` | 管理角色 | 特批優惠、增加緊迫感 |
| 🛠️ 售後客服 | `support` | 售後服務 | 處理問題、增加信任 |

**角色配置項**
- 性格特徵 (personality)
- 說話風格 (speaking_style)
- 表情符號使用頻率 (emoji_frequency)
- 回覆速度 (response_speed)
- 自定義 AI 提示詞 (custom_prompt)
- 個人簡介 (bio)

**AI 提示詞生成**
- 根據角色類型自動生成專屬 AI 提示詞
- 支持自定義提示詞覆蓋
- 上下文感知的動態提示詞

### 2. 劇本引擎 (script_engine.py)

**劇本場景類型**
- `group_conversion` - 群聊轉化
- `private_followup` - 私聊跟進
- `objection_handling` - 異議處理
- `product_intro` - 產品介紹
- `trust_building` - 建立信任
- `urgency_creation` - 製造緊迫感
- `custom` - 自定義

**內建劇本模板**

1. **群聊轉化基礎版**
   - 3 個階段：產品介紹 → 社會證明 → 促成成交
   - 需要 4-6 個角色配合
   - 預計時長 15 分鐘

2. **私聊跟進標準版**
   - 3 個階段：問候開場 → 需求了解 → 方案推薦
   - 需要 1-2 個角色
   - 預計時長 10 分鐘

3. **異議處理專家版**
   - 3 個階段：認同異議 → 重新定義 → 特別優惠
   - 需要 3-4 個角色
   - 預計時長 8 分鐘

**階段觸發類型**
- `auto` - 自動流轉（延遲觸發）
- `keyword` - 關鍵詞觸發
- `time` - 時間觸發
- `message_count` - 消息數量觸發
- `user_action` - 用戶行為觸發
- `manual` - 手動觸發

### 3. 協作協調器 (collaboration_coordinator.py)

**協作群組管理**
- 創建協作群組
- 添加/移除成員
- 分配角色
- 狀態追蹤

**協作群組狀態**
- `warming` - 預熱中
- `active` - 活躍中
- `completed` - 已完成
- `archived` - 已歸檔

**消息協調**
- 打字模擬
- 隨機延遲
- 消息記錄
- 目標用戶回覆追蹤

**自動角色分配**
- 根據需求自動選擇帳號
- 避免重複分配
- 角色可用性檢查

## 數據庫表結構

### account_roles 表
```sql
CREATE TABLE account_roles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    account_phone TEXT NOT NULL,
    role_type TEXT NOT NULL,
    role_name TEXT NOT NULL,
    personality TEXT,              -- JSON 性格配置
    speaking_style TEXT DEFAULT 'professional',
    emoji_frequency TEXT DEFAULT 'medium',
    response_speed TEXT DEFAULT 'medium',
    custom_prompt TEXT,
    avatar_url TEXT,
    bio TEXT,
    is_active INTEGER DEFAULT 1,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    UNIQUE(account_phone, role_type)
)
```

### script_templates 表
```sql
CREATE TABLE script_templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    scenario TEXT NOT NULL,
    stages TEXT NOT NULL,          -- JSON 階段配置
    required_roles TEXT NOT NULL,  -- JSON 所需角色
    min_roles INTEGER DEFAULT 2,
    duration_minutes INTEGER DEFAULT 10,
    success_rate REAL DEFAULT 0,
    use_count INTEGER DEFAULT 0,
    is_active INTEGER DEFAULT 1,
    is_builtin INTEGER DEFAULT 0,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
)
```

### script_executions 表
```sql
CREATE TABLE script_executions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    execution_id TEXT NOT NULL UNIQUE,
    template_id INTEGER NOT NULL,
    group_id TEXT,
    target_user_id TEXT,
    target_username TEXT,
    assigned_roles TEXT NOT NULL,   -- JSON 角色分配
    current_stage TEXT,
    status TEXT DEFAULT 'pending',
    started_at TEXT,
    completed_at TEXT,
    outcome TEXT,
    messages_sent INTEGER DEFAULT 0,
    target_responded INTEGER DEFAULT 0,
    execution_log TEXT,
    created_at TEXT NOT NULL
)
```

### collab_groups 表
```sql
CREATE TABLE collab_groups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_id TEXT NOT NULL,
    group_title TEXT NOT NULL,
    created_by_phone TEXT NOT NULL,
    purpose TEXT DEFAULT 'conversion',
    status TEXT DEFAULT 'warming',
    target_user_id TEXT,
    target_username TEXT,
    member_count INTEGER DEFAULT 0,
    created_at TEXT NOT NULL,
    completed_at TEXT,
    outcome TEXT,
    metadata TEXT
)
```

### collab_group_members 表
```sql
CREATE TABLE collab_group_members (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    collab_group_id INTEGER NOT NULL,
    group_id TEXT NOT NULL,
    account_phone TEXT NOT NULL,
    role_type TEXT NOT NULL,
    joined_at TEXT NOT NULL,
    left_at TEXT,
    is_active INTEGER DEFAULT 1
)
```

### collab_messages 表
```sql
CREATE TABLE collab_messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    collab_group_id INTEGER NOT NULL,
    group_id TEXT NOT NULL,
    account_phone TEXT NOT NULL,
    role_type TEXT NOT NULL,
    message_id INTEGER,
    content TEXT NOT NULL,
    is_target_response INTEGER DEFAULT 0,
    sent_at TEXT NOT NULL
)
```

## API 命令

### 角色管理
| 命令 | 說明 | 事件 |
|------|------|------|
| `get-role-templates` | 獲取角色模板 | `role-templates` |
| `assign-role` | 分配角色 | `role-assigned` |
| `update-role` | 更新角色 | `role-updated` |
| `remove-role` | 移除角色 | `role-removed` |
| `get-account-roles` | 獲取帳號角色 | `account-roles` |
| `get-all-roles` | 獲取所有角色 | `all-roles` |
| `get-role-stats` | 獲取角色統計 | `role-stats` |

### 劇本管理
| 命令 | 說明 | 事件 |
|------|------|------|
| `get-script-templates` | 獲取劇本模板 | `script-templates` |
| `create-script-template` | 創建劇本 | `script-template-created` |
| `delete-script-template` | 刪除劇本 | `script-template-deleted` |
| `start-script-execution` | 啟動執行 | `script-execution-created` |
| `run-script-execution` | 運行執行 | `script-execution-started` |
| `stop-script-execution` | 停止執行 | `script-execution-stopped` |
| `get-active-executions` | 獲取活躍執行 | `active-executions` |
| `get-execution-stats` | 獲取執行統計 | `execution-stats` |

### 協作管理
| 命令 | 說明 | 事件 |
|------|------|------|
| `create-collab-group` | 創建協作群組 | `collab-group-created` |
| `add-collab-member` | 添加成員 | `collab-member-added` |
| `get-collab-groups` | 獲取協作群組 | `collab-groups` |
| `update-collab-status` | 更新狀態 | `collab-group-updated` |
| `get-collab-stats` | 獲取統計 | `collab-stats` |

## 前端界面

### 多角色協作頁面

**角色配置 Tab**
- 角色分配表單
- 8 種角色類型卡片
- 每個角色下的帳號列表
- 快速分配/移除角色

**劇本模板 Tab**
- 內建和自定義劇本列表
- 劇本詳情（階段、角色、時長）
- 使用次數統計

**協作群組 Tab**
- 協作群組列表
- 群組狀態標籤
- 目標用戶信息
- 成交結果顯示

**統計分析 Tab**
- 角色分佈統計
- 協作群組統計
- 轉化率統計
- 消息和回覆統計

## 新增文件列表

### Backend
- `backend/multi_role_manager.py` - 多角色管理器
- `backend/script_engine.py` - 劇本引擎
- `backend/collaboration_coordinator.py` - 協作協調器

### Frontend
- `src/models.ts` - 新增接口定義
- `src/app.component.ts` - 新增狀態和方法
- `src/app.component.html` - 新增多角色協作頁面

## 協作流程

```
1. 配置角色
   └── 給帳號分配不同角色類型

2. 選擇劇本
   └── 使用內建或自定義劇本模板

3. 創建協作群組
   └── 設定目標用戶和群組標題

4. 分配角色帳號
   └── 將配置好角色的帳號加入群組

5. 執行劇本
   ├── 按階段執行消息
   ├── 模擬打字延遲
   ├── 追蹤目標回覆
   └── 記錄對話日誌

6. 記錄結果
   └── 統計轉化結果
```

## 多角色協作示例

```
┌─────────────────────────────────────────────────────┐
│                    協作群組                           │
├─────────────────────────────────────────────────────┤
│                                                      │
│  🧑‍💼 銷售(帳號A):                                      │
│  "你好！最近有活動喔，有興趣了解一下嗎？"                  │
│                                                      │
│  ❓ 好奇者(帳號B):                                     │
│  "什麼活動？詳細說說？"                                 │
│                                                      │
│  🧑‍💼 銷售(帳號A):                                      │
│  "這是我們的新產品，特點是..."                           │
│                                                      │
│  😊 滿意客戶(帳號C):                                    │
│  "我用了三個月了，效果很不錯！推薦！"                     │
│                                                      │
│  🤔 猶豫客戶(帳號D):                                    │
│  "真的嗎？價格怎麼樣？"                                 │
│                                                      │
│  👔 經理(帳號E):                                       │
│  "今天有特別優惠，最後 5 個名額..."                      │
│                                                      │
│  🎯 目標用戶:                                          │
│  "好的，我考慮一下"                                    │
│                                                      │
└─────────────────────────────────────────────────────┘
```

## 技術亮點

1. **角色化 AI**：每個角色有獨特的說話風格和 AI 提示詞
2. **劇本驅動**：預設劇本模板，支持階段流轉
3. **時序模擬**：隨機延遲和打字模擬增加真實性
4. **協作追蹤**：完整記錄協作過程和結果
5. **靈活配置**：角色可重複分配，支持一個帳號多角色

## 後續建議

1. **AI 對話生成**：整合 AI API 自動生成角色對話
2. **劇本編輯器**：可視化劇本編輯界面
3. **自動建群**：整合 Telegram API 自動創建群組
4. **效果分析**：A/B 測試不同劇本效果
5. **智能調度**：根據帳號狀態自動選擇最佳角色
