# Phase 4：用戶追蹤系統完成說明

## 完成時間
2026-01-11

## 系統概述

用戶追蹤系統是 TG-Matrix 自動化營銷平台的核心功能之一，用於追蹤高價值用戶的群組成員資格，自動發現新的高價值群組資源。

## 核心功能

### 1. 用戶追蹤器 (user_tracker.py)

**用戶管理**
- 手動添加用戶到追蹤列表
- 從 Lead 自動導入用戶
- 用戶價值等級分類（VIP、高、中、低）
- 用戶備註管理

**群組發現**
- 使用 Telegram `get_common_chats` API 發現用戶所在群組
- 自動識別高價值群組（成員數 >= 500）
- 新群組自動加入資源池
- 群組價值評分算法

**批量操作**
- 批量追蹤多個用戶
- 進度回報
- 速率限制保護

### 2. 用戶分析 (user_analytics.py)

**分析報表**
- 用戶價值分佈分析
- 用戶來源分析
- 群組重疊分析（發現多用戶共有的群組）
- 追蹤趨勢分析
- 追蹤效率統計

## 數據庫表結構

### tracked_users 表
```sql
CREATE TABLE tracked_users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT UNIQUE NOT NULL,
    username TEXT,
    first_name TEXT,
    last_name TEXT,
    value_level TEXT DEFAULT 'low',      -- 'vip' | 'high' | 'medium' | 'low'
    tracking_status TEXT DEFAULT 'pending', -- 'pending' | 'tracking' | 'completed' | 'failed'
    groups_count INTEGER DEFAULT 0,
    high_value_groups INTEGER DEFAULT 0,
    last_tracked_at TEXT,
    source TEXT DEFAULT 'manual',        -- 'lead' | 'keyword_match' | 'manual' | 'ad_response'
    source_group_id TEXT,
    notes TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
)
```

### user_groups 表
```sql
CREATE TABLE user_groups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    group_id TEXT NOT NULL,
    group_title TEXT,
    group_username TEXT,
    member_count INTEGER DEFAULT 0,
    is_high_value INTEGER DEFAULT 0,
    value_score REAL DEFAULT 0,
    discovered_at TEXT NOT NULL,
    UNIQUE(user_id, group_id)
)
```

### user_tracking_logs 表
```sql
CREATE TABLE user_tracking_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    tracked_by_phone TEXT,
    groups_found INTEGER DEFAULT 0,
    new_groups INTEGER DEFAULT 0,
    high_value_groups INTEGER DEFAULT 0,
    status TEXT DEFAULT 'completed',
    error_message TEXT,
    timestamp TEXT NOT NULL
)
```

## API 命令

### 用戶管理
| 命令 | 說明 | 事件 |
|------|------|------|
| `add-user-to-track` | 添加用戶到追蹤 | `user-added-to-track` |
| `add-user-from-lead` | 從 Lead 添加 | `user-added-from-lead` |
| `remove-tracked-user` | 移除用戶 | `user-removed` |
| `get-tracked-users` | 獲取用戶列表 | `tracked-users` |
| `update-user-value-level` | 更新價值等級 | `user-value-updated` |

### 群組追蹤
| 命令 | 說明 | 事件 |
|------|------|------|
| `track-user-groups` | 追蹤用戶群組 | `user-tracking-completed` / `user-tracking-failed` |
| `batch-track-users` | 批量追蹤 | `batch-tracking-completed` |
| `get-user-groups` | 獲取用戶群組 | `user-groups` |
| `get-high-value-groups` | 獲取高價值群組 | `high-value-groups` |

### 統計分析
| 命令 | 說明 | 事件 |
|------|------|------|
| `get-tracking-stats` | 獲取追蹤統計 | `tracking-stats` |
| `get-tracking-logs` | 獲取追蹤日誌 | `tracking-logs` |
| `get-user-value-distribution` | 價值分佈 | `user-value-distribution` |
| `get-group-overlap-analysis` | 群組重疊分析 | `group-overlap-analysis` |
| `get-tracking-effectiveness` | 追蹤效率 | `tracking-effectiveness` |

## 實時事件

| 事件 | 說明 |
|------|------|
| `user-tracking-started` | 開始追蹤用戶 |
| `user-tracking-completed` | 追蹤完成 |
| `user-tracking-failed` | 追蹤失敗 |
| `batch-tracking-progress` | 批量追蹤進度 |
| `batch-tracking-completed` | 批量追蹤完成 |

## 前端界面

### 用戶追蹤頁面
- **追蹤用戶** Tab
  - 用戶列表（支持價值等級篩選）
  - 添加用戶表單
  - 追蹤操作按鈕
  - 查看群組對話框
  - 價值等級下拉選擇
  
- **高價值群組** Tab
  - 高價值群組卡片
  - 成員數、追蹤用戶數、價值分顯示
  
- **統計分析** Tab
  - 總覽統計卡片
  - 用戶價值分佈
  - 追蹤狀態分佈

## 價值評分算法

### 群組價值評分
```
成員數 >= 10000: 1.0
成員數 >= 5000:  0.9
成員數 >= 1000:  0.7
成員數 >= 500:   0.5
成員數 >= 100:   0.3
其他:           0.1
```

### 用戶價值分類
```
高價值群組 >= 5 或 總群組 >= 20: VIP
高價值群組 >= 3 或 總群組 >= 10: high
高價值群組 >= 1 或 總群組 >= 5:  medium
其他:                           low
```

## 新增文件列表

### Backend
- `backend/user_tracker.py` - 用戶追蹤核心模塊
- `backend/user_analytics.py` - 用戶分析模塊

### Frontend
- `src/models.ts` - 新增接口定義
- `src/app.component.ts` - 新增狀態和方法
- `src/app.component.html` - 新增用戶追蹤頁面

## 使用說明

### 1. 添加追蹤用戶
1. 進入「用戶追蹤」頁面
2. 點擊「添加用戶」
3. 輸入用戶 ID 和可選的用戶名
4. 點擊「添加用戶」

### 2. 從 Lead 添加
- 在 Lead 詳情頁點擊「添加到追蹤」按鈕

### 3. 追蹤用戶群組
1. 在用戶列表找到要追蹤的用戶
2. 點擊「🔍 追蹤」按鈕
3. 系統會使用在線帳號查詢該用戶所在群組
4. 追蹤完成後可查看發現的群組

### 4. 查看高價值群組
- 點擊「高價值群組」Tab
- 查看通過用戶追蹤發現的高價值群組
- 這些群組會自動加入資源池

## 與其他系統整合

### 資源發現系統
- 發現的高價值群組自動添加到 `discovered_resources` 表
- 可在資源發現頁面查看和管理

### Lead 系統
- 可將 Lead 直接添加到追蹤列表
- 追蹤來源會標記為 `lead`

### 廣告發送系統
- 發現的高價值群組可作為廣告發送目標

## 技術亮點

1. **get_common_chats API**：利用 Telegram 官方 API 發現用戶群組
2. **價值評分算法**：基於成員數的群組價值評估
3. **自動分類**：基於群組數量自動分類用戶價值等級
4. **資源池整合**：高價值群組自動加入資源庫
5. **批量操作**：支持批量追蹤多個用戶

## 後續建議

1. **群組關係圖**：可視化用戶-群組關係網絡
2. **智能推薦**：基於群組重疊推薦相似用戶
3. **自動追蹤**：新 Lead 自動加入追蹤隊列
4. **追蹤計劃**：定時重新追蹤用戶群組變化
5. **用戶行為分析**：追蹤用戶在各群組的活躍度
