# 關鍵詞集添加失敗問題診斷與修復

## 問題描述

用戶報告添加關鍵詞集失敗。根據日誌分析，雖然 IPC 命令已成功發送並收到確認，但關鍵詞集未能成功添加到數據庫中。

## 可能的原因

### 1. 數據庫損壞（最可能）
根據之前的對話歷史，系統存在持續的「`database disk image is malformed`」錯誤。這種數據庫損壞會導致所有涉及數據庫讀寫的操作失敗。

**症狀：**
- IPC 命令成功發送並收到 `ack`
- 但數據庫操作失敗（無法寫入）
- 前端看不到任何錯誤提示

**解決方案：**
使用 `rebuild_database.py` 重建數據庫（見下方步驟）

### 2. 數據庫連接問題
- 數據庫被鎖定
- 連接超時
- 表不存在（遷移未執行）

### 3. 唯一性約束違反
關鍵詞集名稱已存在，但錯誤未被正確報告。

### 4. 前端錯誤處理不完整
錯誤事件未被正確監聽或顯示。

## 已實施的修復

### 1. 改進後端錯誤處理 (`backend/main.py`)
- ✅ 添加了詳細的錯誤檢查和分類
- ✅ 檢查關鍵詞集是否已存在（避免重複）
- ✅ 區分不同類型的數據庫錯誤（損壞、鎖定、表不存在等）
- ✅ 發送明確的 `keyword-set-error` 事件給前端
- ✅ 添加了詳細的錯誤日誌和追蹤

### 2. 改進數據庫操作錯誤處理 (`backend/database.py`)
- ✅ 在 `add_keyword_set` 中添加了異常處理
- ✅ 區分不同類型的數據庫錯誤
- ✅ 提供更明確的錯誤信息

### 3. 改進前端錯誤顯示 (`src/app.component.ts`)
- ✅ 添加了 `keyword-set-error` 事件監聽器
- ✅ 成功時顯示成功消息並清空輸入框
- ✅ 失敗時顯示詳細錯誤信息
- ✅ 數據庫損壞時顯示更明顯的警告（10秒顯示）
- ✅ 修復了輸入框過早清空的問題

## 診斷步驟

### 步驟 1: 檢查後端日誌
查看後端控制台輸出，尋找以下錯誤：
```
[Backend] Database error adding keyword set: ...
[Backend] Error adding keyword set: ...
```

### 步驟 2: 檢查數據庫完整性
運行以下 Python 命令：
```python
import sqlite3
db_path = "backend/data/tgmatrix.db"
conn = sqlite3.connect(db_path)
cursor = conn.execute("PRAGMA integrity_check")
result = cursor.fetchone()
print(result[0])  # 應該是 'ok'
conn.close()
```

### 步驟 3: 檢查表是否存在
```python
import sqlite3
db_path = "backend/data/tgmatrix.db"
conn = sqlite3.connect(db_path)
cursor = conn.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='keyword_sets'")
result = cursor.fetchone()
if result:
    print("keyword_sets 表存在")
else:
    print("keyword_sets 表不存在！")
conn.close()
```

### 步驟 4: 嘗試手動添加關鍵詞集
使用 SQLite 命令行工具：
```bash
sqlite3 backend/data/tgmatrix.db
INSERT INTO keyword_sets (name) VALUES ('測試關鍵詞集');
SELECT * FROM keyword_sets;
.exit
```

## 重建數據庫步驟

如果診斷確認數據庫損壞，請按以下步驟重建：

### 步驟 1: 停止應用
完全關閉應用程序（確保沒有 Python 進程在運行）

### 步驟 2: 運行重建腳本
```powershell
python backend/rebuild_database.py
```

### 步驟 3: 重新啟動應用
```powershell
npm run start:dev
```

### 步驟 4: 驗證修復
1. 嘗試添加一個測試關鍵詞集（例如：`測試001`）
2. 查看是否有錯誤提示
3. 檢查關鍵詞集是否出現在列表中

## 預防措施

### 1. 定期備份數據庫
創建一個備份腳本 `backup_db.ps1`：
```powershell
$backupDir = "backend\data\backups"
New-Item -ItemType Directory -Force -Path $backupDir
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
Copy-Item backend\data\tgmatrix.db "$backupDir\tgmatrix_$timestamp.db"
Write-Host "數據庫已備份到: $backupDir\tgmatrix_$timestamp.db"
```

### 2. 監控數據庫健康
應用現在會自動檢查數據庫完整性。如果發現問題，會記錄日誌。

### 3. 避免異常關閉
- 使用「停止監控」按鈕停止監控
- 使用正常方式關閉應用
- 避免強制終止 Python 進程

## 測試驗證

修復後，請測試以下場景：

1. ✅ **正常添加關鍵詞集**
   - 輸入名稱：`測試關鍵詞集`
   - 應該成功添加並顯示在列表中

2. ✅ **重複名稱檢測**
   - 嘗試添加已存在的關鍵詞集名稱
   - 應該顯示錯誤：「關鍵詞集 'xxx' 已存在」

3. ✅ **空名稱檢測**
   - 嘗試添加空名稱
   - 應該顯示錯誤：「關鍵詞集名稱不能為空」

4. ✅ **數據庫損壞檢測**
   - 如果數據庫損壞，應該顯示明確的錯誤提示
   - 提示使用 `rebuild_database.py` 重建數據庫

## 如果問題仍然存在

如果重建數據庫後問題仍然存在，請：

1. 提供完整的後端日誌輸出
2. 提供前端控制台的錯誤信息
3. 運行數據庫完整性檢查（見診斷步驟）
4. 檢查是否有其他錯誤阻止遷移執行

## 相關文件

- `backend/main.py` - 後端主程序，處理 `add-keyword-set` 命令
- `backend/database.py` - 數據庫操作，包含 `add_keyword_set` 方法
- `backend/rebuild_database.py` - 數據庫重建腳本
- `src/app.component.ts` - 前端組件，處理關鍵詞集相關操作
- `數據庫重建指南.md` - 詳細的數據庫重建步驟
