# é˜¶æ®µä¸€å¼€å‘å®Œæˆ - æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆElectronç«¯ï¼‰âœ…

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°äº† Electron ç«¯çš„æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ŒåŒ…æ‹¬è¯·æ±‚ç®¡ç†ã€è¶…æ—¶æ£€æµ‹å’Œé‡ä¼ åŠŸèƒ½ã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. RequestManager ç±»

**åŠŸèƒ½ï¼š**
- è¯·æ±‚æ³¨å†Œå’Œè·Ÿè¸ª
- è¶…æ—¶æ£€æµ‹ï¼ˆé»˜è®¤ 30 ç§’ï¼‰
- è‡ªåŠ¨é‡ä¼ ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
- è¯·æ±‚å®Œæˆå¤„ç†

**ä¸»è¦æ–¹æ³•ï¼š**
- `generateRequestId()` - ç”Ÿæˆå”¯ä¸€è¯·æ±‚ID
- `registerRequest(command, payload, timeout)` - æ³¨å†Œæ–°è¯·æ±‚
- `handleAcknowledgment(requestId, status)` - å¤„ç†ç¡®è®¤äº‹ä»¶
- `handleCompletion(requestId, status, error)` - å¤„ç†å®Œæˆäº‹ä»¶
- `checkTimeouts()` - æ£€æŸ¥è¶…æ—¶è¯·æ±‚
- `retryRequest(request)` - é‡ä¼ è¯·æ±‚

### 2. sendToPython å‡½æ•°å¢å¼º

**æ”¹è¿›ï¼š**
- è‡ªåŠ¨ç”Ÿæˆ request_idï¼ˆå¦‚æœæœªæä¾›ï¼‰
- åœ¨æ¶ˆæ¯ä¸­åŒ…å« request_id
- è¿”å› request_id ä¾›è°ƒç”¨è€…ä½¿ç”¨
- å‘é€å¤±è´¥æ—¶æ¸…ç†å¾…å¤„ç†è¯·æ±‚

### 3. äº‹ä»¶å¤„ç†å¢å¼º

**æ”¹è¿›ï¼š**
- ç›‘å¬ `command-ack` äº‹ä»¶ï¼ˆæ”¶åˆ°ç¡®è®¤ï¼‰
- ç›‘å¬ `command-complete` äº‹ä»¶ï¼ˆå¤„ç†å®Œæˆï¼‰
- å†…éƒ¨å¤„ç†ç¡®è®¤äº‹ä»¶ï¼Œä¸è½¬å‘åˆ°å‰ç«¯
- å…¶ä»–äº‹ä»¶æ­£å¸¸è½¬å‘åˆ°å‰ç«¯

### 4. ç”Ÿå‘½å‘¨æœŸç®¡ç†

**æ”¹è¿›ï¼š**
- åº”ç”¨é€€å‡ºæ—¶åœæ­¢è¶…æ—¶æ£€æŸ¥å™¨
- æ¸…ç†æ‰€æœ‰å¾…å¤„ç†è¯·æ±‚

## ğŸ”„ å·¥ä½œæµç¨‹

### æ­£å¸¸æµç¨‹

```
1. å‰ç«¯/Electron è°ƒç”¨ sendToPython(command, payload)
   â†“
2. ç”Ÿæˆ request_id å¹¶æ³¨å†Œåˆ° RequestManager
   â†“
3. å‘é€å‘½ä»¤åˆ° Pythonï¼ˆåŒ…å« request_idï¼‰
   â†“
4. Python æ”¶åˆ°å‘½ä»¤ï¼Œå‘é€ command-ack äº‹ä»¶
   â†“
5. RequestManager æ”¶åˆ° ackï¼Œæ›´æ–°è¯·æ±‚çŠ¶æ€
   â†“
6. Python å¤„ç†å‘½ä»¤ï¼Œå‘é€ command-complete äº‹ä»¶
   â†“
7. RequestManager æ”¶åˆ° completionï¼Œç§»é™¤è¯·æ±‚
   â†“
8. å¯é€‰ï¼šé€šçŸ¥å‰ç«¯å‘½ä»¤å®Œæˆ
```

### è¶…æ—¶é‡ä¼ æµç¨‹

```
1. å‘é€å‘½ä»¤å¹¶æ³¨å†Œè¯·æ±‚
   â†“
2. ç­‰å¾…ç¡®è®¤/å®Œæˆï¼ˆé»˜è®¤ 30 ç§’ï¼‰
   â†“
3. è¶…æ—¶æœªæ”¶åˆ°å“åº”
   â†“
4. æ£€æŸ¥é‡è¯•æ¬¡æ•°
   â†“
5. å¦‚æœæœªè¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆ3æ¬¡ï¼‰ï¼š
   - é‡ä¼ å‘½ä»¤
   - å¢åŠ é‡è¯•è®¡æ•°
   - é‡ç½®æ—¶é—´æˆ³
   â†“
6. å¦‚æœè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š
   - ç§»é™¤è¯·æ±‚
   - é€šçŸ¥å‰ç«¯è¶…æ—¶é”™è¯¯
```

## ğŸ“ ä»£ç å®ç°

### RequestManager ç±»

```javascript
class RequestManager {
    constructor() {
        this.pendingRequests = new Map();
        this.timeoutInterval = null;
        this.defaultTimeout = 30000; // 30 seconds
        this.maxRetries = 3;
        this.startTimeoutChecker();
    }
    
    // ... å®ç°ç»†èŠ‚
}
```

### sendToPython å‡½æ•°

```javascript
function sendToPython(command, payload = {}, requestId = null) {
    // ç”Ÿæˆ request_idï¼ˆå¦‚æœæœªæä¾›ï¼‰
    if (!requestId) {
        requestId = requestManager.registerRequest(command, payload);
    }
    
    // å‘é€åŒ…å« request_id çš„å‘½ä»¤
    const message = JSON.stringify({
        command: command,
        payload: payload,
        request_id: requestId
    }) + '\n';
    
    // ... å‘é€åˆ° Python
}
```

### äº‹ä»¶å¤„ç†

```javascript
pythonProcess.stdout.on('data', (data) => {
    // è§£æäº‹ä»¶
    const event = JSON.parse(line);
    
    // å¤„ç†ç¡®è®¤äº‹ä»¶ï¼ˆå†…éƒ¨å¤„ç†ï¼Œä¸è½¬å‘ï¼‰
    if (event.event === 'command-ack') {
        requestManager.handleAcknowledgment(request_id, status);
        return;
    }
    
    // å¤„ç†å®Œæˆäº‹ä»¶ï¼ˆå†…éƒ¨å¤„ç†ï¼Œä¸è½¬å‘ï¼‰
    if (event.event === 'command-complete') {
        requestManager.handleCompletion(request_id, status, error);
        return;
    }
    
    // å…¶ä»–äº‹ä»¶æ­£å¸¸è½¬å‘åˆ°å‰ç«¯
    mainWindow.webContents.send(event.event, event.payload);
});
```

## ğŸ”§ é…ç½®é€‰é¡¹

### å¯é…ç½®å‚æ•°

- `defaultTimeout`: é»˜è®¤è¶…æ—¶æ—¶é—´ï¼ˆ30 ç§’ï¼‰
- `maxRetries`: æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆ3 æ¬¡ï¼‰
- `timeoutCheckInterval`: è¶…æ—¶æ£€æŸ¥é—´éš”ï¼ˆ1 ç§’ï¼‰

### è‡ªå®šä¹‰è¶…æ—¶

```javascript
// ä¸ºç‰¹å®šå‘½ä»¤è®¾ç½®è‡ªå®šä¹‰è¶…æ—¶
const requestId = requestManager.registerRequest('long-running-command', payload, 60000); // 60ç§’
sendToPython('long-running-command', payload, requestId);
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. UUID ä¾èµ–

- éœ€è¦å®‰è£… `uuid` åŒ…ï¼š`npm install uuid`
- ä½¿ç”¨ `uuid.v4()` ç”Ÿæˆå”¯ä¸€è¯·æ±‚ID

### 2. å‘åå…¼å®¹

- `request_id` æ˜¯å¯é€‰çš„ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- å¦‚æœæ²¡æœ‰ request_idï¼Œä»ç„¶æ­£å¸¸å·¥ä½œï¼ˆæ— ç¡®è®¤æœºåˆ¶ï¼‰
- ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯ä½¿ç”¨

### 3. æ€§èƒ½å½±å“

- æ¯ä¸ªè¯·æ±‚éœ€è¦å­˜å‚¨å°‘é‡å…ƒæ•°æ®ï¼ˆMap å­˜å‚¨ï¼‰
- è¶…æ—¶æ£€æŸ¥å™¨æ¯ç§’è¿è¡Œä¸€æ¬¡ï¼ˆæ€§èƒ½å½±å“å¯å¿½ç•¥ï¼‰
- é‡ä¼ ä¼šå¢åŠ ç½‘ç»œé€šä¿¡é‡

### 4. å†…å­˜ç®¡ç†

- å®Œæˆçš„è¯·æ±‚è‡ªåŠ¨ä» Map ä¸­ç§»é™¤
- è¶…æ—¶çš„è¯·æ±‚åœ¨è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åç§»é™¤
- åº”ç”¨é€€å‡ºæ—¶æ¸…ç†æ‰€æœ‰å¾…å¤„ç†è¯·æ±‚

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. æ­£å¸¸æµç¨‹æµ‹è¯•

1. å‘é€å‘½ä»¤
2. éªŒè¯æ”¶åˆ° command-ack
3. éªŒè¯æ”¶åˆ° command-complete
4. éªŒè¯è¯·æ±‚ä» pendingRequests ä¸­ç§»é™¤

### 2. è¶…æ—¶æµ‹è¯•

1. æ¨¡æ‹Ÿ Python ä¸å“åº”ï¼ˆåœæ­¢åç«¯ï¼‰
2. å‘é€å‘½ä»¤
3. éªŒè¯è¶…æ—¶æ£€æµ‹
4. éªŒè¯é‡ä¼ æœºåˆ¶
5. éªŒè¯è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åçš„å¤„ç†

### 3. é”™è¯¯å¤„ç†æµ‹è¯•

1. å‘é€æ— æ•ˆå‘½ä»¤
2. éªŒè¯é”™è¯¯å“åº”
3. éªŒè¯è¯·æ±‚æ¸…ç†

### 4. å¹¶å‘æµ‹è¯•

1. åŒæ—¶å‘é€å¤šä¸ªå‘½ä»¤
2. éªŒè¯æ‰€æœ‰è¯·æ±‚æ­£ç¡®è·Ÿè¸ª
3. éªŒè¯æ‰€æœ‰è¯·æ±‚æ­£ç¡®å®Œæˆ

## ğŸ“Š å®ŒæˆçŠ¶æ€

- âœ… RequestManager ç±»å®ç°
- âœ… sendToPython å‡½æ•°å¢å¼º
- âœ… äº‹ä»¶å¤„ç†å¢å¼º
- âœ… è¶…æ—¶æ£€æµ‹å’Œé‡ä¼ 
- âœ… ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… UUID ä¾èµ–å®‰è£…

**æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆElectronç«¯ï¼‰å·²å®Œæˆ 100%ï¼** âœ…

## ğŸ‰ é˜¶æ®µä¸€å®Œæˆ

**é˜¶æ®µä¸€æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆ 100%ï¼** ğŸ‰

- âœ… é˜Ÿåˆ—çŠ¶æ€æŒä¹…åŒ–
- âœ… å…¨å±€é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆåç«¯ï¼‰
- âœ… æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆElectronç«¯ï¼‰
- âœ… æ•°æ®åŠ å¯†

