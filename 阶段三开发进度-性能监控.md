# 阶段三开发进度 - 性能监控 ✅

## 📋 功能概述

实现了完整的性能监控系统，包括系统指标收集、性能历史记录、性能告警和性能统计等功能。

## ✅ 已完成功能

### 1. PerformanceMonitor 类 (`backend/performance_monitor.py`)

**功能：**
- 系统指标收集（CPU、内存、磁盘使用率）
- 应用指标收集（活跃连接数、队列长度、查询时间、发送延迟）
- 性能历史记录（保留最近 1000 条记录）
- 性能告警（超过阈值时自动告警）
- 性能统计（平均值、最大值、最小值等）

**主要方法：**
- `start()` / `stop()` - 启动/停止监控
- `collect_metrics()` - 收集当前性能指标
- `record_query_performance()` - 记录查询性能
- `record_send_performance()` - 记录发送性能
- `register_connection()` / `unregister_connection()` - 管理连接
- `update_queue_length()` - 更新队列长度
- `get_current_metrics()` - 获取当前指标
- `get_metrics_history()` - 获取历史指标
- `get_performance_summary()` - 获取性能摘要

### 2. 集成到 BackendService

**启动时初始化：**
- 应用启动时自动初始化性能监控器
- 启动后台收集任务（默认每 5 秒收集一次）
- 设置事件回调，自动发送指标到前端

**性能追踪集成：**
- 消息发送延迟追踪
- 连接状态追踪
- 队列长度追踪
- 查询性能追踪（预留接口）

**命令处理：**
- `get-performance-metrics` - 获取性能指标历史
- `get-performance-summary` - 获取性能摘要

### 3. 性能指标

**系统指标：**
- CPU 使用率（%）
- 内存使用率（%）和内存使用量（MB）
- 磁盘使用率（%）

**应用指标：**
- 活跃连接数
- 消息队列长度
- 平均查询时间（ms）
- 平均发送延迟（ms）

**性能告警阈值：**
- CPU > 80%
- 内存 > 85%
- 磁盘 > 90%
- 查询时间 > 1000ms
- 发送延迟 > 5000ms

### 4. 性能历史记录

**历史数据：**
- 保留最近 1000 条性能指标
- 支持时间范围过滤
- 支持数量限制

**性能统计：**
- 平均值、最大值、最小值
- 采样数量
- 时间范围

## 📝 使用示例

### 获取当前性能指标

```python
performance_monitor = get_performance_monitor()
current_metrics = performance_monitor.get_current_metrics()
```

### 获取性能历史

```python
from datetime import datetime, timedelta

start_time = datetime.now() - timedelta(hours=1)
metrics = performance_monitor.get_metrics_history(
    start_time=start_time,
    limit=100
)
```

### 获取性能摘要

```python
summary = performance_monitor.get_performance_summary()
# 返回：CPU、内存、查询、发送、连接、队列的统计信息
```

### 记录查询性能

```python
import time

start = time.time()
# ... 执行查询 ...
execution_time = (time.time() - start) * 1000  # 转换为毫秒
performance_monitor.record_query_performance("get_accounts", execution_time)
```

### 记录发送性能

```python
# 自动记录（在 _queue_send_callback 中）
# 手动记录：
performance_monitor.record_send_performance(phone, delay_ms)
```

## 🔄 工作流程

### 性能监控流程

```
1. 应用启动
   ↓
2. 初始化性能监控器
   ↓
3. 启动后台收集任务（每 5 秒）
   ↓
4. 收集系统指标（CPU、内存、磁盘）
   ↓
5. 收集应用指标（连接、队列、查询、发送）
   ↓
6. 检查阈值并发送告警
   ↓
7. 保存到历史记录
   ↓
8. 发送事件到前端
```

### 性能追踪流程

```
1. 操作执行（查询、发送等）
   ↓
2. 记录开始时间
   ↓
3. 执行操作
   ↓
4. 计算执行时间
   ↓
5. 记录到性能监控器
   ↓
6. 更新统计信息
```

## ⚙️ 配置选项

### 性能监控配置

- `collection_interval`: 收集间隔（默认 5 秒）
- `max_history`: 最大历史记录数（默认 1000）
- `cpu_threshold`: CPU 告警阈值（默认 80%）
- `memory_threshold`: 内存告警阈值（默认 85%）
- `disk_threshold`: 磁盘告警阈值（默认 90%）
- `query_time_threshold`: 查询时间告警阈值（默认 1000ms）
- `send_delay_threshold`: 发送延迟告警阈值（默认 5000ms）

## 📊 完成状态

- ✅ PerformanceMonitor 类实现
- ✅ 系统指标收集（CPU、内存、磁盘）
- ✅ 应用指标收集（连接、队列、查询、发送）
- ✅ 性能历史记录
- ✅ 性能告警机制
- ✅ 性能统计摘要
- ✅ 集成到 BackendService
- ✅ 命令处理（获取指标、获取摘要）
- ✅ 事件发送到前端

**性能监控已完成 100%！** ✅

## 🚀 下一步

性能监控已完成，可以继续开发阶段三的其他功能：
1. 性能监控面板（前端 UI）
2. 数据库查询优化
3. 连接池管理

