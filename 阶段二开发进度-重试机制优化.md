# é˜¶æ®µäºŒå¼€å‘è¿›åº¦ - é‡è¯•æœºåˆ¶ä¼˜åŒ– âœ…

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†ç»Ÿä¸€çš„é‡è¯•é…ç½®ç³»ç»Ÿå’Œæ™ºèƒ½é‡è¯•ç®—æ³•ï¼Œæ”¯æŒå¤šç§é‡è¯•ç­–ç•¥å’Œå¯é…ç½®çš„é‡è¯•å‚æ•°ã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. RetryConfig å’Œ RetryHandler (`backend/retry_config.py`)

**åŠŸèƒ½ï¼š**
- ç»Ÿä¸€çš„é‡è¯•é…ç½®ç³»ç»Ÿ
- å¤šç§é‡è¯•ç­–ç•¥æ”¯æŒ
- æ™ºèƒ½é‡è¯•ç®—æ³•
- å¯é…ç½®çš„é‡è¯•å‚æ•°

**é‡è¯•ç­–ç•¥ï¼š**
- `LINEAR` - çº¿æ€§å¢é•¿ï¼ˆå›ºå®šé—´éš”ï¼‰
- `EXPONENTIAL` - æŒ‡æ•°é€€é¿ï¼ˆé»˜è®¤ï¼‰
- `FIBONACCI` - æ–æ³¢é‚£å¥‘åºåˆ—
- `CUSTOM` - è‡ªå®šä¹‰å‡½æ•°

**é…ç½®é€‰é¡¹ï¼š**
- `max_attempts` - æœ€å¤§é‡è¯•æ¬¡æ•°
- `initial_delay` - åˆå§‹å»¶è¿Ÿï¼ˆç§’ï¼‰
- `max_delay` - æœ€å¤§å»¶è¿Ÿï¼ˆç§’ï¼‰
- `multiplier` - æŒ‡æ•°é€€é¿ä¹˜æ•°
- `jitter` - æ˜¯å¦æ·»åŠ éšæœºæŠ–åŠ¨

### 2. é»˜è®¤é‡è¯•é…ç½®

**é¢„è®¾é…ç½®ï¼š**
- `network` - ç½‘ç»œæ“ä½œï¼ˆ3æ¬¡ï¼Œ1-30ç§’ï¼‰
- `database` - æ•°æ®åº“æ“ä½œï¼ˆ3æ¬¡ï¼Œ0.5-10ç§’ï¼‰
- `api` - API æ“ä½œï¼ˆ5æ¬¡ï¼Œ2-60ç§’ï¼‰
- `message_send` - æ¶ˆæ¯å‘é€ï¼ˆ3æ¬¡ï¼Œ5-120ç§’ï¼‰
- `quick` - å¿«é€Ÿæ“ä½œï¼ˆ2æ¬¡ï¼Œ0.5-5ç§’ï¼‰

### 3. é›†æˆåˆ° MessageQueue

**æ”¹è¿›ï¼š**
- ä½¿ç”¨æ–°çš„ `MessageRetryHandler` ç±»
- ä¿æŒå‘åå…¼å®¹
- æ”¯æŒ FloodWait ç‰¹æ®Šå¤„ç†

### 4. RetryHandler.execute_with_retry()

**åŠŸèƒ½ï¼š**
- é€šç”¨çš„é‡è¯•æ‰§è¡Œå‡½æ•°
- æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥å‡½æ•°
- å¯è‡ªå®šä¹‰é‡è¯•æ¡ä»¶
- æ”¯æŒé‡è¯•å›è°ƒ

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ä½¿ç”¨é»˜è®¤é…ç½®

```python
from retry_config import get_retry_handler

# è·å–ç½‘ç»œæ“ä½œçš„é‡è¯•å¤„ç†å™¨
retry_handler = get_retry_handler("network")

# æ‰§è¡Œå¸¦é‡è¯•çš„å‡½æ•°
result = await retry_handler.execute_with_retry(
    my_network_function,
    arg1, arg2,
    should_retry=lambda e: isinstance(e, ConnectionError),
    on_retry=lambda attempt, error: print(f"Retrying attempt {attempt}")
)
```

### åˆ›å»ºè‡ªå®šä¹‰é…ç½®

```python
from retry_config import create_custom_retry_handler, RetryStrategy

# åˆ›å»ºè‡ªå®šä¹‰é‡è¯•å¤„ç†å™¨
custom_handler = create_custom_retry_handler(
    max_attempts=5,
    initial_delay=2.0,
    max_delay=120.0,
    multiplier=2.0,
    strategy=RetryStrategy.EXPONENTIAL,
    jitter=True
)
```

### åœ¨ MessageQueue ä¸­ä½¿ç”¨

```python
# MessageQueue å†…éƒ¨ä½¿ç”¨
should_retry, wait_seconds = self.retry_handler.should_retry(
    error, message.attempts, message.max_attempts
)
```

## ğŸ”„ é‡è¯•ç­–ç•¥è¯´æ˜

### 1. æŒ‡æ•°é€€é¿ï¼ˆEXPONENTIALï¼‰

å»¶è¿Ÿè®¡ç®—å…¬å¼ï¼š`delay = initial_delay * (multiplier ^ (attempt - 1))`

ç¤ºä¾‹ï¼ˆinitial_delay=1.0, multiplier=2.0ï¼‰ï¼š
- å°è¯• 1ï¼šå¤±è´¥åç­‰å¾… 1 ç§’
- å°è¯• 2ï¼šå¤±è´¥åç­‰å¾… 2 ç§’
- å°è¯• 3ï¼šå¤±è´¥åç­‰å¾… 4 ç§’
- å°è¯• 4ï¼šå¤±è´¥åç­‰å¾… 8 ç§’

### 2. çº¿æ€§å¢é•¿ï¼ˆLINEARï¼‰

å»¶è¿Ÿè®¡ç®—å…¬å¼ï¼š`delay = initial_delay * attempt`

ç¤ºä¾‹ï¼ˆinitial_delay=1.0ï¼‰ï¼š
- å°è¯• 1ï¼šå¤±è´¥åç­‰å¾… 1 ç§’
- å°è¯• 2ï¼šå¤±è´¥åç­‰å¾… 2 ç§’
- å°è¯• 3ï¼šå¤±è´¥åç­‰å¾… 3 ç§’

### 3. æ–æ³¢é‚£å¥‘åºåˆ—ï¼ˆFIBONACCIï¼‰

å»¶è¿Ÿè®¡ç®—å…¬å¼ï¼š`delay = initial_delay * fibonacci(attempt)`

ç¤ºä¾‹ï¼ˆinitial_delay=1.0ï¼‰ï¼š
- å°è¯• 1ï¼šå¤±è´¥åç­‰å¾… 1 ç§’
- å°è¯• 2ï¼šå¤±è´¥åç­‰å¾… 1 ç§’
- å°è¯• 3ï¼šå¤±è´¥åç­‰å¾… 2 ç§’
- å°è¯• 4ï¼šå¤±è´¥åç­‰å¾… 3 ç§’
- å°è¯• 5ï¼šå¤±è´¥åç­‰å¾… 5 ç§’

### 4. æŠ–åŠ¨ï¼ˆJitterï¼‰

æ·»åŠ éšæœºæŠ–åŠ¨ä»¥å‡å°‘"é›·ç¾¤æ•ˆåº”"ï¼ˆthundering herdï¼‰ï¼š
- æŠ–åŠ¨èŒƒå›´ï¼šå»¶è¿Ÿçš„ 10%
- å…¬å¼ï¼š`delay = delay + random.uniform(-jitter_range, jitter_range)`

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. FloodWait ç‰¹æ®Šå¤„ç†

å¯¹äº Telegram API çš„ FloodWait é”™è¯¯ï¼Œç›´æ¥ä½¿ç”¨ FloodWait çš„å€¼ä½œä¸ºå»¶è¿Ÿï¼Œå¿½ç•¥é…ç½®çš„å»¶è¿Ÿè®¡ç®—ã€‚

### 2. æœ€å¤§å»¶è¿Ÿé™åˆ¶

æ‰€æœ‰ç­–ç•¥è®¡ç®—çš„å»¶è¿Ÿéƒ½ä¼šè¢«é™åˆ¶åœ¨ `max_delay` ä»¥å†…ï¼Œé˜²æ­¢è¿‡é•¿çš„ç­‰å¾…æ—¶é—´ã€‚

### 3. é‡è¯•æ¡ä»¶

å¯ä»¥é€šè¿‡ `should_retry` å›è°ƒå‡½æ•°è‡ªå®šä¹‰é‡è¯•æ¡ä»¶ï¼Œä¾‹å¦‚åªé‡è¯•ç‰¹å®šç±»å‹çš„é”™è¯¯ã€‚

### 4. æ€§èƒ½å½±å“

- é‡è¯•ä¼šå¢åŠ æ“ä½œçš„æ€»æ—¶é—´
- å»ºè®®æ ¹æ®æ“ä½œç±»å‹é€‰æ‹©åˆé€‚çš„é‡è¯•ç­–ç•¥å’Œå‚æ•°
- å¯¹äºå…³é”®æ“ä½œï¼Œå¯ä»¥å¢åŠ é‡è¯•æ¬¡æ•°

## ğŸ“Š å®ŒæˆçŠ¶æ€

- âœ… RetryConfig å’Œ RetryHandler ç±»å®ç°
- âœ… å¤šç§é‡è¯•ç­–ç•¥æ”¯æŒ
- âœ… é»˜è®¤é‡è¯•é…ç½®
- âœ… é›†æˆåˆ° MessageQueue
- âœ… å‘åå…¼å®¹

**é‡è¯•æœºåˆ¶ä¼˜åŒ–å·²å®Œæˆ 100%ï¼** âœ…

## ğŸš€ ä¸‹ä¸€æ­¥

é‡è¯•æœºåˆ¶ä¼˜åŒ–å·²å®Œæˆï¼Œå¯ä»¥ç»§ç»­å¼€å‘é˜¶æ®µäºŒçš„å…¶ä»–åŠŸèƒ½ï¼š
1. è¿æ¥å¥åº·æ£€æŸ¥
2. é…ç½®æ–‡ä»¶ç³»ç»Ÿ

