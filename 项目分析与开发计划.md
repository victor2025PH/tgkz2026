# TG-Matrix 项目分析与开发计划

## 一、项目概述

### 1.1 项目定位
TG-Matrix 是一个基于 Electron 的桌面应用程序，用于自动化 Telegram 营销活动。主要功能包括：
- Telegram 账户管理（监听号和发送号）
- 关键词监控和潜在客户捕获
- AI 驱动的个性化消息生成（使用 Gemini API）
- 自动化营销活动管理
- 潜在客户管道管理（看板视图）
- 性能分析和报告

### 1.2 技术架构

```
┌─────────────────────────────────────────────────────────┐
│                    Angular Frontend                      │
│  (TypeScript, Angular 21, Tailwind CSS, Signals)        │
└────────────────────┬────────────────────────────────────┘
                     │ IPC (Electron IPC)
┌────────────────────▼────────────────────────────────────┐
│              Electron Main Process                      │
│              (electron.js)                              │
└────────────────────┬────────────────────────────────────┘
                     │ stdin/stdout (JSON)
┌────────────────────▼────────────────────────────────────┐
│              Python Backend                             │
│  (Pyrogram, SQLite, 消息处理, 监控逻辑)                  │
└─────────────────────────────────────────────────────────┘
```

### 1.3 技术栈

**前端：**
- Angular 21（独立组件，使用 Signals）
- TypeScript
- Tailwind CSS
- Electron IPC 通信
- Gemini AI API（用于消息生成）

**后端：**
- Python 3.x
- Pyrogram（Telegram API 客户端）
- SQLite（数据持久化）
- JSON 标准输入/输出通信

**构建工具：**
- Electron Builder
- Angular CLI

## 二、项目现状分析

### 2.1 已完成部分

#### 前端（完成度：95%）
✅ **UI 界面完整**
- 仪表盘视图（统计卡片、系统控制）
- 账户管理页面（批量操作、分组管理）
- 自动化中心（关键词集、监控群组、活动配置）
- 潜在客户管理（看板视图、列表视图）
- 分析页面（趋势图、转化漏斗、活动性能）
- 日志页面
- 设置页面（模板管理、A/B 测试）

✅ **核心功能实现**
- 多语言支持（英文/中文繁体）
- 深色/浅色主题切换
- 响应式设计
- 实时状态更新（通过 IPC 事件）
- AI 消息生成集成
- Excel 导入/导出功能（通过 IPC）

✅ **数据模型定义**
- `models.ts` 中定义了完整的数据结构：
  - TelegramAccount
  - KeywordSet / KeywordConfig
  - MonitoredGroup
  - CapturedLead
  - MessageTemplate
  - AutomationCampaign
  - LogEntry

#### Electron 主进程（完成度：60%）
✅ **基础框架**
- 窗口创建和管理
- IPC 监听器设置（所有命令通道已定义）
- 文件对话框处理（Excel 导入/导出）
- Python 进程管理框架（已预留，未实现）

⚠️ **待完成**
- Python 后端进程启动和管理
- stdin/stdout 通信实现
- 命令转发到 Python 后端
- 事件从 Python 转发到前端

#### 后端（完成度：5%）
❌ **几乎未实现**
- `config.py` - 空文件
- `database.py` - 空文件
- `main.py` - 不存在

### 2.2 关键问题识别

#### 1. 后端完全缺失
- 没有 Python 主程序入口
- 没有数据库模型和操作
- 没有 Telegram API 集成
- 没有监控逻辑
- 没有消息发送逻辑

#### 2. Electron 与 Python 通信未实现
- `electron.js` 中 Python 进程启动代码被注释
- stdin/stdout 通信机制未实现
- 命令转发逻辑缺失
- 事件监听和转发未实现

#### 3. 数据库设计缺失
- 需要设计完整的数据库 schema
- 需要实现 CRUD 操作
- 需要处理数据迁移

#### 4. 依赖管理
- 缺少 `requirements.txt`
- 缺少 Python 环境配置说明

## 三、后端对接需求分析

### 3.1 通信协议

根据 `TG-Matrix 后端集成指南.txt`，通信协议如下：

**命令格式（Electron → Python）：**
```json
{
  "command": "command-name",
  "payload": {}
}
```

**事件格式（Python → Electron）：**
```json
{
  "event": "event-name",
  "payload": {}
}
```

**关键规则：**
- 每条消息必须是一行完整的 JSON
- 以换行符（\n）结尾
- 使用 UTF-8 编码

### 3.2 需要实现的命令（共 30+ 个）

#### 账户管理
- `get-initial-state` - 获取初始状态
- `add-account` - 添加账户
- `login-account` - 登录账户
- `check-account-status` - 检查账户状态
- `update-account-data` - 更新账户数据
- `bulk-assign-role` - 批量分配角色
- `bulk-assign-group` - 批量分配分组
- `bulk-delete-accounts` - 批量删除账户
- `remove-account` - 删除账户
- `load-accounts-from-excel` - 从 Excel 加载账户
- `reload-sessions-and-accounts` - 重新加载会话

#### 监控配置
- `start-monitoring` - 启动监控
- `stop-monitoring` - 停止监控
- `add-keyword-set` - 添加关键词集
- `remove-keyword-set` - 删除关键词集
- `add-keyword` - 添加关键词
- `remove-keyword` - 删除关键词
- `add-group` - 添加监控群组
- `remove-group` - 移除监控群组

#### 模板和活动
- `add-template` - 添加消息模板
- `remove-template` - 删除模板
- `toggle-template-status` - 切换模板状态
- `add-campaign` - 添加自动化活动
- `remove-campaign` - 删除活动
- `toggle-campaign-status` - 切换活动状态

#### 潜在客户管理
- `send-message` - 发送消息
- `update-lead-status` - 更新潜在客户状态
- `add-to-dnc` - 添加到"请勿联系"列表
- `export-leads-to-excel` - 导出潜在客户到 Excel

#### 系统操作
- `clear-logs` - 清除日志
- `download-excel-template` - 下载 Excel 模板（在 Electron 中处理）

### 3.3 需要发出的事件

- `initial-state` - 初始状态（启动时）
- `log-entry` - 日志条目（实时）
- `accounts-updated` - 账户更新（实时）
- `new-lead-captured` - 新潜在客户捕获（实时）
- `monitoring-status-changed` - 监控状态变化（实时）

## 四、数据库设计

### 4.1 表结构设计

#### accounts（账户表）
```sql
CREATE TABLE accounts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    phone TEXT NOT NULL UNIQUE,
    api_id TEXT,
    api_hash TEXT,
    proxy TEXT,
    two_factor_password TEXT,
    role TEXT DEFAULT 'Unassigned',  -- 'Listener', 'Sender', 'Unassigned'
    group_name TEXT,
    status TEXT DEFAULT 'Offline',   -- 'Online', 'Offline', 'Banned', etc.
    daily_send_count INTEGER DEFAULT 0,
    daily_send_limit INTEGER DEFAULT 50,
    health_score INTEGER DEFAULT 100,
    session_file_path TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### keyword_sets（关键词集表）
```sql
CREATE TABLE keyword_sets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### keywords（关键词表）
```sql
CREATE TABLE keywords (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    keyword_set_id INTEGER NOT NULL,
    keyword TEXT NOT NULL,
    is_regex INTEGER DEFAULT 0,  -- 0 = false, 1 = true
    FOREIGN KEY (keyword_set_id) REFERENCES keyword_sets(id) ON DELETE CASCADE
);
```

#### monitored_groups（监控群组表）
```sql
CREATE TABLE monitored_groups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    url TEXT NOT NULL,
    name TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### group_keyword_sets（群组-关键词集关联表）
```sql
CREATE TABLE group_keyword_sets (
    group_id INTEGER NOT NULL,
    keyword_set_id INTEGER NOT NULL,
    PRIMARY KEY (group_id, keyword_set_id),
    FOREIGN KEY (group_id) REFERENCES monitored_groups(id) ON DELETE CASCADE,
    FOREIGN KEY (keyword_set_id) REFERENCES keyword_sets(id) ON DELETE CASCADE
);
```

#### message_templates（消息模板表）
```sql
CREATE TABLE message_templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    prompt TEXT NOT NULL,
    is_active INTEGER DEFAULT 1,  -- 0 = false, 1 = true
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### campaigns（自动化活动表）
```sql
CREATE TABLE campaigns (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    is_active INTEGER DEFAULT 0,
    trigger_source_group_ids TEXT,  -- JSON array of group IDs
    trigger_keyword_set_ids TEXT,    -- JSON array of keyword set IDs
    action_template_id INTEGER,
    action_min_delay_seconds INTEGER DEFAULT 30,
    action_max_delay_seconds INTEGER DEFAULT 120,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (action_template_id) REFERENCES message_templates(id)
);
```

#### leads（潜在客户表）
```sql
CREATE TABLE leads (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    username TEXT,
    first_name TEXT,
    last_name TEXT,
    source_group TEXT NOT NULL,
    triggered_keyword TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status TEXT DEFAULT 'New',  -- 'New', 'Contacted', 'Replied', etc.
    online_status TEXT DEFAULT 'Unknown',  -- 'Online', 'Offline', 'Recently', 'Unknown'
    assigned_template_id INTEGER,
    campaign_id INTEGER,
    do_not_contact INTEGER DEFAULT 0,
    FOREIGN KEY (assigned_template_id) REFERENCES message_templates(id),
    FOREIGN KEY (campaign_id) REFERENCES campaigns(id)
);
```

#### interactions（交互历史表）
```sql
CREATE TABLE interactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    lead_id INTEGER NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    type TEXT NOT NULL,  -- 'Captured', 'Status Change', 'Message Sent', 'Note Added'
    content TEXT NOT NULL,
    FOREIGN KEY (lead_id) REFERENCES leads(id) ON DELETE CASCADE
);
```

#### logs（日志表）
```sql
CREATE TABLE logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    message TEXT NOT NULL,
    type TEXT DEFAULT 'info'  -- 'info', 'success', 'warning', 'error'
);
```

#### do_not_contact（请勿联系列表）
```sql
CREATE TABLE do_not_contact (
    user_id TEXT PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 五、开发计划

### 阶段一：后端基础架构（优先级：高）

#### 1.1 项目结构搭建
- [ ] 创建 `backend/main.py` - 主程序入口
- [ ] 创建 `backend/requirements.txt` - Python 依赖管理
- [ ] 实现 `backend/config.py` - 配置管理
- [ ] 实现 `backend/database.py` - 数据库操作类
- [ ] 创建 `backend/models/` 目录（可选，用于数据模型）

**预计时间：** 2-3 天

#### 1.2 数据库实现
- [ ] 实现数据库初始化（创建表结构）
- [ ] 实现账户 CRUD 操作
- [ ] 实现关键词集 CRUD 操作
- [ ] 实现监控群组 CRUD 操作
- [ ] 实现模板和活动 CRUD 操作
- [ ] 实现潜在客户 CRUD 操作
- [ ] 实现日志操作
- [ ] 实现 DNC 列表操作

**预计时间：** 3-4 天

#### 1.3 通信协议实现
- [ ] 实现 stdin 监听（JSON 命令解析）
- [ ] 实现 stdout 事件发送（JSON 格式化）
- [ ] 实现命令路由系统
- [ ] 实现错误处理和异常捕获
- [ ] 实现优雅关闭机制

**预计时间：** 2 天

### 阶段二：Telegram API 集成（优先级：高）

#### 2.1 Pyrogram 集成
- [ ] 实现账户登录逻辑
- [ ] 实现会话文件管理
- [ ] 实现代理支持
- [ ] 实现账户状态检查
- [ ] 实现错误处理（代理错误、封禁检测等）

**预计时间：** 3-4 天

#### 2.2 监控功能实现
- [ ] 实现群组消息监听
- [ ] 实现关键词匹配（普通和正则）
- [ ] 实现潜在客户捕获逻辑
- [ ] 实现活动触发判断
- [ ] 实现用户在线状态检测
- [ ] 实现多账户并发监控

**预计时间：** 4-5 天

#### 2.3 消息发送功能
- [ ] 实现私信发送
- [ ] 实现附件发送（图片/文件）
- [ ] 实现发送延迟和随机化
- [ ] 实现智能发送（在线检测）
- [ ] 实现发送限制管理（每日限额）
- [ ] 实现账户轮询（Round-robin）

**预计时间：** 3-4 天

### 阶段三：Electron 通信对接（优先级：高）

#### 3.1 Python 进程管理
- [ ] 在 `electron.js` 中实现 Python 进程启动
- [ ] 实现进程生命周期管理
- [ ] 实现进程错误处理和重启机制
- [ ] 实现进程日志输出

**预计时间：** 2 天

#### 3.2 命令转发实现
- [ ] 实现所有命令到 Python 的转发
- [ ] 实现命令响应处理
- [ ] 实现超时处理
- [ ] 实现错误反馈

**预计时间：** 2-3 天

#### 3.3 事件转发实现
- [ ] 实现 Python 事件监听
- [ ] 实现事件到前端的转发
- [ ] 实现事件队列管理（防止阻塞）

**预计时间：** 2 天

### 阶段四：Excel 文件处理（优先级：中）

#### 4.1 Excel 导入
- [ ] 实现账户 Excel 模板生成
- [ ] 实现 Excel 文件解析
- [ ] 实现数据验证
- [ ] 实现批量导入逻辑

**预计时间：** 2 天

#### 4.2 Excel 导出
- [ ] 实现潜在客户导出
- [ ] 实现数据格式化
- [ ] 实现文件保存对话框集成

**预计时间：** 1 天

### 阶段五：高级功能（优先级：中）

#### 5.1 自动化活动执行
- [ ] 实现活动触发逻辑
- [ ] 实现模板分配（A/B 测试）
- [ ] 实现延迟发送
- [ ] 实现活动状态管理

**预计时间：** 3 天

#### 5.2 账户健康管理
- [ ] 实现健康分数计算
- [ ] 实现账户预热模式
- [ ] 实现冷却期管理
- [ ] 实现自动恢复机制

**预计时间：** 2-3 天

#### 5.3 智能发送优化
- [ ] 实现在线状态检测
- [ ] 实现消息队列管理
- [ ] 实现时间窗口发送
- [ ] 实现发送策略优化

**预计时间：** 2-3 天

### 阶段六：测试与优化（优先级：中）

#### 6.1 单元测试
- [ ] 数据库操作测试
- [ ] 命令处理测试
- [ ] Telegram API 集成测试（模拟）

**预计时间：** 3-4 天

#### 6.2 集成测试
- [ ] 前后端通信测试
- [ ] 端到端功能测试
- [ ] 性能测试

**预计时间：** 2-3 天

#### 6.3 错误处理优化
- [ ] 完善异常处理
- [ ] 添加重试机制
- [ ] 优化错误消息

**预计时间：** 2 天

### 阶段七：文档与部署（优先级：低）

#### 7.1 文档编写
- [ ] API 文档
- [ ] 部署指南
- [ ] 用户手册
- [ ] 开发文档

**预计时间：** 2-3 天

#### 7.2 构建与打包
- [ ] Python 依赖打包
- [ ] Electron 应用打包
- [ ] 安装程序生成
- [ ] 跨平台支持（Windows/Mac/Linux）

**预计时间：** 2-3 天

## 六、技术难点与解决方案

### 6.1 多账户并发监控

**难点：** 需要同时监控多个 Telegram 账户，处理大量消息

**解决方案：**
- 使用异步编程（asyncio）
- 为每个账户创建独立的 Pyrogram 客户端
- 使用消息队列管理事件
- 实现连接池管理

### 6.2 实时通信可靠性

**难点：** stdin/stdout 通信可能丢失消息或阻塞

**解决方案：**
- 实现消息确认机制
- 使用非阻塞 I/O
- 实现消息队列缓冲
- 添加心跳检测

### 6.3 Telegram API 限制

**难点：** Telegram 有速率限制和反垃圾机制

**解决方案：**
- 实现发送速率控制
- 实现账户轮询
- 实现智能延迟
- 监控账户健康状态

### 6.4 会话文件管理

**难点：** 需要管理多个账户的会话文件

**解决方案：**
- 使用统一的会话文件目录
- 实现会话文件备份
- 实现会话文件清理
- 支持会话文件导入/导出

## 七、依赖清单

### Python 依赖（requirements.txt）
```
pyrogram>=2.0.0
tgcrypto>=1.2.0
aiosqlite>=0.19.0
openpyxl>=3.1.0
python-dotenv>=1.0.0
```

### Node.js 依赖（已存在）
- electron
- electron-builder
- Angular 相关依赖（通过 Angular CLI 管理）

## 八、风险评估

### 高风险项
1. **Telegram API 变更** - Pyrogram 可能需要更新
2. **账户封禁风险** - 需要实现完善的保护机制
3. **性能问题** - 大量账户和消息可能导致性能瓶颈

### 中风险项
1. **跨平台兼容性** - Python 和 Electron 在不同平台的兼容性
2. **依赖管理** - Python 依赖版本冲突

### 低风险项
1. **UI 兼容性** - 前端基本完成，风险较低
2. **数据库迁移** - SQLite 迁移相对简单

## 九、下一步行动建议

### 立即开始（本周）
1. ✅ 创建后端项目结构
2. ✅ 实现数据库模型和基础 CRUD
3. ✅ 实现通信协议基础框架
4. ✅ 实现 `get-initial-state` 命令

### 短期目标（2 周内）
1. ✅ 完成所有数据库操作
2. ✅ 实现账户登录和状态管理
3. ✅ 实现 Electron-Python 通信
4. ✅ 实现基础监控功能

### 中期目标（1 个月内）
1. ✅ 完成所有核心功能
2. ✅ 实现自动化活动
3. ✅ 完成测试和优化

### 长期目标（2 个月内）
1. ✅ 完善高级功能
2. ✅ 性能优化
3. ✅ 文档和部署

## 十、总结

TG-Matrix 项目前端部分已经基本完成，UI 设计精美，功能规划完善。主要工作集中在后端开发和前后端通信对接上。

**关键成功因素：**
1. 稳定的 Telegram API 集成
2. 可靠的进程间通信
3. 完善的错误处理
4. 良好的性能优化

**预计总开发时间：** 6-8 周（1 名全栈开发人员）

**建议开发顺序：**
1. 后端基础架构 → 数据库 → 通信协议
2. Telegram API 集成 → 监控功能 → 消息发送
3. Electron 对接 → Excel 处理 → 高级功能
4. 测试优化 → 文档部署

---

*文档生成时间：2024年*
*项目版本：1.0.0*

